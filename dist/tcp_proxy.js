import{createRequire as j}from"node:module";import M from"node:path";import D from"node:url";globalThis.require=j(import.meta.url);globalThis.__filename=D.fileURLToPath(import.meta.url);globalThis.__dirname=M.dirname(__filename);import _ from"chalk";import{randomInt as Q}from"crypto";import*as H from"fs";import*as E from"net";import*as $ from"tls";import*as R from"util";import b from"chalk";import{randomInt as N}from"crypto";var h=Buffer.from("001122334455","hex");function z(n,e){let s=14+n.length,t=Buffer.alloc(s);return e.copy(t,0),h.copy(t,6),t.writeUInt16BE(2048,12),n.copy(t,14),t}function B(n){let e=n[0]>>4&15,s=(n[0]&15)*4,t=n.readUInt16BE(2),o=n[9],i=n.slice(12,16).join("."),r=n.slice(16,20).join(".");return{version:e,headerLength:s,totalLength:t,protocol:o,srcIP:i,dstIP:r,payload:n.slice(s,t)}}function y(n){let e=n.readUInt16BE(0),s=n.readUInt16BE(2),t=n.readUInt32BE(4),o=n.readUInt32BE(8),i=(n[12]>>4&15)*4,r=n[13],a=n.readUInt16BE(14);return{srcPort:e,dstPort:s,seqNumber:t,ackNumber:o,headerLength:i,flags:r,windowSize:a,payload:n.slice(i)}}function G(n){let e=0;for(let s=0;s<n.length;s+=2)e+=n.readUInt16BE(s);return e=(e>>16)+(e&65535),e+=e>>16,~e&65535}function P(n,e,s){let t=Buffer.alloc(12);n.split(".").forEach((r,a)=>{t[a]=parseInt(r)}),e.split(".").forEach((r,a)=>{t[4+a]=parseInt(r)}),t[8]=0,t[9]=6,t.writeUInt16BE(s.length,10);let o=Buffer.concat([t,s]),i=0;for(let r=0;r<o.length;r+=2)r===o.length-1?i+=o[r]<<8:i+=o.readUInt16BE(r);return i=(i>>16)+(i&65535),i+=i>>16,~i&65535}function I(n,e,s,t,o,i,r){let u=20+r.length,c=Buffer.alloc(u);return c.writeUInt16BE(e,0),c.writeUInt16BE(n,2),c.writeUInt32BE(s,4),c.writeUInt32BE(t,8),c[12]=20/4<<4,c[13]=o,c.writeUInt16BE(i,14),c.writeUInt16BE(0,16),c.writeUInt16BE(0,18),r.copy(c,20),c}function v(n,e,s,t){let i=20+t.length,r=Buffer.alloc(i);r[0]=69,r[1]=0,r.writeUInt16BE(i,2),r.writeUInt16BE(N(65536),4),r.writeUInt16BE(16384,6),r[8]=64,r[9]=s,r.writeUInt16BE(0,10),n.split(".").forEach((u,c)=>{r[12+c]=parseInt(u)}),e.split(".").forEach((u,c)=>{r[16+c]=parseInt(u)});let a=G(r.slice(0,20));return r.writeUInt16BE(a,10),t.copy(r,20),r}function S(n,e,s){k(n);let t=z(n,e);s.bus.send("net0-receive",new Uint8Array(t))}async function F(n,e,s,t,o,i){let a=N(4294967295),u=I(t,o,a,0,2,64240,Buffer.alloc(0)),c=P(n,e,u);u.writeUInt16BE(c,16);let f=v(n,e,6,u);S(f,s,i);let l=await Z(i,n,e,s,t,o,a);return[a+1,l]}function W(n){return["FIN","SYN","RST","PSH","ACK","URG","ECE","CWR"].filter((s,t)=>n>>t&1)}function Z(n,e,s,t,o,i,r){return new Promise((a,u)=>{function c(l){if(l.etherType!==2048||!l.destinationMAC.equals(h))return;let p=B(l.payload);if(p.protocol===6){let d=y(p.payload);if(d.flags===18&&d.ackNumber===r+1){let m=I(o,i,r+1,d.seqNumber+1,16,64240,Buffer.alloc(0)),x=P(e,s,m);m.writeUInt16BE(x,16);let U=v(e,s,6,m);S(U,t,n),n.remove_listener("net0-send",f),a(d.seqNumber+1)}}}let f=l=>{c(w(Buffer.from(l)))};n.add_listener("net0-send",f),setTimeout(()=>{n.remove_listener("net0-send",f),u(new Error("Timeout waiting for SYN/ACK"))},3e4)})}async function L(n,e,s,t,o,i,r,a,u){let f=I(t,o,i,r,24,64240,u),l=P(n,e,f);f.writeUInt16BE(l,16);let p=v(n,e,6,f);S(p,s,a)}var Y=16;function J(n,e,s,t,o=64240){return I(e,n,s,t,Y,o,Buffer.alloc(0))}function q(n,e,s,t,o,i,r,a){let u=J(t,o,i,r,64240),c=P(n,e,u);u.writeUInt16BE(c,16);let f=v(n,e,6,u);return S(f,s,a),r}function C(n,e){return n.padEnd(e)}function g(n,e){return n.padStart(e)}function k(n){if(!process.env.DEBUG)return;let e=B(n),{srcIP:s,dstIP:t}=e,o=s==="10.0.0.1"?b.green(s):b.red(s),i=t==="10.0.0.1"?b.green(t):b.red(t),r=y(e.payload),{srcPort:a,dstPort:u,seqNumber:c,ackNumber:f,flags:l,windowSize:p}=r,d=`${C(o,16)} -> ${C(i,16)}`,A=`TCP ${g(a.toString(),5)} -> ${g(u.toString(),5)}`,m=`[${C(W(l).join(", "),20)}]`,x=`Seq=${g(c.toString(),10)}`,U=`Ack=${g(f.toString(),10)}`,K=`Win=${g(p.toString(),5)}`;console.log(`${d} ${A} ${m} ${x} ${U} ${K}`)}function w(n){if(n.length<14)throw new Error("Buffer is too small to contain a valid Ethernet frame");let e=n.slice(0,6),s=n.slice(6,12),t=n.readUInt16BE(12),o=n.slice(14);return{destinationMAC:e,sourceMAC:s,etherType:t,payload:o}}function O(n,e,s){return new Promise(t=>{let o=Buffer.from(n.split(".").map(a=>parseInt(a))),i=Buffer.from(e.split(".").map(a=>parseInt(a))),r=Buffer.alloc(42);r.write("FFFFFFFFFFFF",0,"hex"),h.copy(r,6),r.writeUInt16BE(2054,12),r.writeUInt16BE(1,14),r.writeUInt16BE(2048,16),r.writeUInt8(6,18),r.writeUInt8(4,19),r.writeUInt16BE(1,20),h.copy(r,22),o.copy(r,28),r.fill(0,32,38),i.copy(r,38),s.add_listener("net0-send",a=>{let u=Buffer.from(a);if(u.readUInt16BE(12)===2054&&u.readUInt16BE(20)===2){let c=u.slice(6,12);t(c)}}),s.add_listener("net0-send",a=>{let u=Buffer.from(a);if(u.readUInt16BE(12)===2054&&u.readUInt16BE(20)===1){let c=u.slice(6,12),f=u.slice(28,32).join("."),l=Buffer.alloc(42);c.copy(l,0),h.copy(l,6),l.writeUInt16BE(2054,12),l.writeUInt16BE(1,14),l.writeUInt16BE(2048,16),l.writeUInt8(6,18),l.writeUInt8(4,19),l.writeUInt16BE(2,20),h.copy(l,22),o.copy(l,28),c.copy(l,32),f.split(".").forEach((p,d)=>{l[38+d]=parseInt(p)}),console.log("Responded to ARP request"),s.bus.send("net0-receive",new Uint8Array(l))}}),s.bus.send("net0-receive",new Uint8Array(r))})}var T=class{proxyPort;serviceHosts;servicePorts;serviceHostIndex;options;proxyTlsOptions;serviceTlsOptions;proxySockets;users;allowedIPs;server=null;emulator;constructor(e,s,t,o,i){this.emulator=o,this.proxyPort=e,this.serviceHosts=this.parse(s),this.servicePorts=this.parse(t).map(Number),this.serviceHostIndex=-1,this.options=this.parseOptions(i),this.proxyTlsOptions={passphrase:this.options.passphrase,secureProtocol:"TLSv1_2_method"},this.options.tls&&(this.proxyTlsOptions.pfx=H.readFileSync(this.options.pfx)),this.serviceTlsOptions={rejectUnauthorized:this.options.rejectUnauthorized,secureProtocol:"TLSv1_2_method"},this.proxySockets={},this.options.identUsers.length!==0?(this.users=this.options.identUsers,this.log(`Will only allow these users: ${this.users.join(", ")}`)):this.log("Will allow all users"),this.options.allowedIPs.length!==0&&(this.allowedIPs=this.options.allowedIPs),this.createListener()}parse(e){if(typeof e=="string")return e.split(",");if(typeof e=="number")return this.parse(e.toString());if(Array.isArray(e))return e;throw new Error("cannot parse object: "+e)}parseOptions(e){return Object.assign({quiet:!0,pfx:void 0,passphrase:"abcd",rejectUnauthorized:!0,identUsers:[],allowedIPs:[],tls:!1,hostname:void 0,customTlsOptions:void 0,localAddress:void 0,localPort:void 0,upstream:void 0,downstream:void 0,serviceHostSelected:void 0},e||{})}createListener(){this.options.tls?this.server=$.createServer(this.options.customTlsOptions||this.proxyTlsOptions,e=>{this.handleClientConnection(e)}):this.server=E.createServer(e=>{this.handleClientConnection(e)}),this.server.listen(this.proxyPort,this.options.hostname)}handleClientConnection(e){this.users?this.handleAuth(e):this.handleClient(e)}handleAuth(e){if(this.allowedIPs?.includes(e.remoteAddress)){this.handleClient(e);return}let s=R.format("%d, %d",e.remotePort,this.proxyPort),t=new E.Socket,o;t.on("error",()=>{o=void 0,t.destroy()}),t.on("data",i=>{o=i.toString().trim(),t.destroy()}),t.on("close",()=>{if(!o){this.log("No identd"),e.destroy();return}let i=o.split(":").pop();this.users?.includes(i)?this.handleClient(e):(this.log(`User "${i}" unauthorized`),e.destroy())}),t.connect(113,e.remoteAddress,()=>{t.write(s),t.end()})}async handleClient(e){let s=this.uniqueKey(e);this.proxySockets[s]=e;let t=await O("10.0.0.2","10.0.0.1",this.emulator),o={buffers:[],connected:!1,sequenceNumber:0,ackNumber:0,srcPort:Q(1024,65535),macAddress:t,proxySocket:e};this.createServiceSocket(o),[o.sequenceNumber,o.ackNumber]=await F("10.0.0.2","10.0.0.1",o.macAddress,3306,o.srcPort,this.emulator),e.on("data",async i=>{await this.handleUpstreamData(o,i)}),e.on("close",()=>{delete this.proxySockets[this.uniqueKey(e)],o.serviceSocket!==void 0&&o.serviceSocket.destroy()}),e.on("error",()=>{o.serviceSocket!==void 0&&o.serviceSocket.destroy()})}async handleUpstreamData(e,s){let o=[];if(s.length>1448)for(let i=0;i<s.length;i+=1448)o.push(s.slice(i,i+1448));else o.push(s);for(let i=0;i<o.length;i++){let r=o[i];await L("10.0.0.2","10.0.0.1",e.macAddress,3306,e.srcPort,e.sequenceNumber,e.ackNumber,this.emulator,r),r.length>0&&(e.sequenceNumber+=r.length,Number.isFinite(e.sequenceNumber)||(e.sequenceNumber=0),process.env.DEBUG&&(o.length>1?console.log(_.bold(`Sending ${r.length} bytes (chunk ${i+1}/${o.length})`)):console.log(_.bold(`Sending ${r.length} bytes`))))}}createServiceSocket(e){let s=t=>{if(t.etherType!==2048||!t.destinationMAC.equals(h))return;let o=t.payload;k(Buffer.from(o));let i=B(Buffer.from(o));if(i.protocol===6){let r=y(i.payload);if(r.dstPort!==e.srcPort)return;e.ackNumber=r.seqNumber+r.payload.length,e.proxySocket.write(r.payload),r.payload.length>0&&q("10.0.0.2","10.0.0.1",e.macAddress,e.srcPort,3306,e.sequenceNumber,e.ackNumber,this.emulator),r.flags&16&&(e.sequenceNumber=Math.max(e.sequenceNumber,r.ackNumber))}};this.emulator.add_listener("net0-send",t=>{s(w(Buffer.from(t)))})}parseServiceOptions(e){let s=this.getServiceHostIndex(e.proxySocket);return Object.assign({port:this.servicePorts[s],host:this.serviceHosts[s],localAddress:this.options.localAddress,localPort:this.options.localPort},this.serviceTlsOptions)}getServiceHostIndex(e){this.serviceHostIndex++,this.serviceHostIndex==this.serviceHosts.length&&(this.serviceHostIndex=0);let s=this.serviceHostIndex;return this.options.serviceHostSelected&&(s=this.options.serviceHostSelected(e,s)),s}end(){this.server?.close();for(let e in this.proxySockets)this.proxySockets[e].destroy();this.server?.unref()}log(e){this.options.quiet||console.log(e)}intercept(e,s,t){return e?e(s,t):t}uniqueKey(e){return`${e.remoteAddress}:${e.remotePort}`}};function ae(n,e,s,t){return new T(n,e,s,t)}export{T as TcpProxy,ae as createProxy};
