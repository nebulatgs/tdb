import{createRequire as j}from"node:module";import D from"node:path";import z from"node:url";globalThis.require=j(import.meta.url);globalThis.__filename=z.fileURLToPath(import.meta.url);globalThis.__dirname=D.dirname(__filename);import _ from"chalk";import{randomInt as X}from"crypto";import*as A from"fs";import*as k from"net";import ee from"slip";import*as H from"tls";import*as $ from"util";import m from"chalk";import{randomInt as N}from"crypto";import R from"slip";var I=192,C=219,M=220,G=221;function W(s){let e=[I];for(let r of s)r===I?e.push(C,M):r===C?e.push(C,G):e.push(r);return e.push(I),Buffer.from(e)}function g(s){let e=s[0]>>4&15,r=(s[0]&15)*4,t=s.readUInt16BE(2),i=s[9],n=s.slice(12,16).join("."),o=s.slice(16,20).join(".");return{version:e,headerLength:r,totalLength:t,protocol:i,srcIP:n,dstIP:o,payload:s.slice(r,t)}}function b(s){let e=s.readUInt16BE(0),r=s.readUInt16BE(2),t=s.readUInt32BE(4),i=s.readUInt32BE(8),n=(s[12]>>4&15)*4,o=s[13],a=s.readUInt16BE(14);return{srcPort:e,dstPort:r,seqNumber:t,ackNumber:i,headerLength:n,flags:o,windowSize:a,payload:s.slice(n)}}function Z(s){let e=0;for(let r=0;r<s.length;r+=2)e+=s.readUInt16BE(r);return e=(e>>16)+(e&65535),e+=e>>16,~e&65535}function P(s,e,r){let t=Buffer.alloc(12);s.split(".").forEach((o,a)=>{t[a]=parseInt(o)}),e.split(".").forEach((o,a)=>{t[4+a]=parseInt(o)}),t[8]=0,t[9]=6,t.writeUInt16BE(r.length,10);let i=Buffer.concat([t,r]),n=0;for(let o=0;o<i.length;o+=2)o===i.length-1?n+=i[o]<<8:n+=i.readUInt16BE(o);return n=(n>>16)+(n&65535),n+=n>>16,~n&65535}function S(s,e,r,t,i,n,o){let u=20+o.length,c=Buffer.alloc(u);return c.writeUInt16BE(e,0),c.writeUInt16BE(s,2),c.writeUInt32BE(r,4),c.writeUInt32BE(t,8),c[12]=20/4<<4,c[13]=i,c.writeUInt16BE(n,14),c.writeUInt16BE(0,16),c.writeUInt16BE(0,18),o.copy(c,20),c}function v(s,e,r,t){let n=20+t.length,o=Buffer.alloc(n);o[0]=69,o[1]=0,o.writeUInt16BE(n,2),o.writeUInt16BE(N(65536),4),o.writeUInt16BE(16384,6),o[8]=64,o[9]=r,o.writeUInt16BE(0,10),s.split(".").forEach((u,c)=>{o[12+c]=parseInt(u)}),e.split(".").forEach((u,c)=>{o[16+c]=parseInt(u)});let a=Z(o.slice(0,20));return o.writeUInt16BE(a,10),t.copy(o,20),o}function y(s,e){E(s);let r=W(s);e.serial_send_bytes(1,r)}async function L(s,e,r,t,i){let o=N(4294967295),a=S(r,t,o,0,2,64240,Buffer.alloc(0)),u=P(s,e,a);a.writeUInt16BE(u,16);let c=v(s,e,6,a);y(c,i);let l=await J(i,s,e,r,t,o);return[o+1,l]}function Y(s){return["FIN","SYN","RST","PSH","ACK","URG","ECE","CWR"].filter((r,t)=>s>>t&1)}function J(s,e,r,t,i,n){return new Promise((o,a)=>{let u=new R.Decoder({maxMessageSize:209715200,bufferSize:2048,onMessage:l=>{let f=g(Buffer.from(l));if(f.protocol===6){let d=b(f.payload);if(d.flags===18&&d.ackNumber===n+1){let h=S(t,i,n+1,d.seqNumber+1,16,64240,Buffer.alloc(0)),x=P(e,r,h);h.writeUInt16BE(x,16);let B=v(e,r,6,h);y(B,s),s.remove_listener("serial1-output-byte",c),o(d.seqNumber+1)}}}}),c=l=>{u.decode(Buffer.from([l]))};s.add_listener("serial1-output-byte",c),setTimeout(()=>{s.remove_listener("serial1-output-byte",c),a(new Error("Timeout waiting for SYN/ACK"))},3e4)})}async function q(s,e,r,t,i,n,o,a){let c=S(r,t,i,n,24,64240,a),l=P(s,e,c);c.writeUInt16BE(l,16);let f=v(s,e,6,c);y(f,o)}var Q=16;function V(s,e,r,t,i=64240){return S(e,s,r,t,Q,i,Buffer.alloc(0))}function O(s,e,r,t,i,n,o){let a=V(r,t,i,n,64240),u=P(s,e,a);a.writeUInt16BE(u,16);let c=v(s,e,6,a);return y(c,o),n}function w(s,e){return s.padEnd(e)}function p(s,e){return s.padStart(e)}function E(s){if(!process.env.DEBUG)return;let e=g(s),{srcIP:r,dstIP:t}=e,i=r==="10.0.0.1"?m.green(r):m.red(r),n=t==="10.0.0.1"?m.green(t):m.red(t),o=b(e.payload),{srcPort:a,dstPort:u,seqNumber:c,ackNumber:l,flags:f,windowSize:d}=o,U=`${w(i,16)} -> ${w(n,16)}`,h=`TCP ${p(a.toString(),5)} -> ${p(u.toString(),5)}`,x=`[${w(Y(f).join(", "),20)}]`,B=`Seq=${p(c.toString(),10)}`,F=`Ack=${p(l.toString(),10)}`,K=`Win=${p(d.toString(),5)}`;console.log(`${U} ${h} ${x} ${B} ${F} ${K}`)}var T=class{proxyPort;serviceHosts;servicePorts;serviceHostIndex;options;proxyTlsOptions;serviceTlsOptions;proxySockets;users;allowedIPs;server=null;emulator;constructor(e,r,t,i,n){this.emulator=i,this.proxyPort=e,this.serviceHosts=this.parse(r),this.servicePorts=this.parse(t).map(Number),this.serviceHostIndex=-1,this.options=this.parseOptions(n),this.proxyTlsOptions={passphrase:this.options.passphrase,secureProtocol:"TLSv1_2_method"},this.options.tls&&(this.proxyTlsOptions.pfx=A.readFileSync(this.options.pfx)),this.serviceTlsOptions={rejectUnauthorized:this.options.rejectUnauthorized,secureProtocol:"TLSv1_2_method"},this.proxySockets={},this.options.identUsers.length!==0?(this.users=this.options.identUsers,this.log(`Will only allow these users: ${this.users.join(", ")}`)):this.log("Will allow all users"),this.options.allowedIPs.length!==0&&(this.allowedIPs=this.options.allowedIPs),this.createListener()}parse(e){if(typeof e=="string")return e.split(",");if(typeof e=="number")return this.parse(e.toString());if(Array.isArray(e))return e;throw new Error("cannot parse object: "+e)}parseOptions(e){return Object.assign({quiet:!0,pfx:void 0,passphrase:"abcd",rejectUnauthorized:!0,identUsers:[],allowedIPs:[],tls:!1,hostname:void 0,customTlsOptions:void 0,localAddress:void 0,localPort:void 0,upstream:void 0,downstream:void 0,serviceHostSelected:void 0},e||{})}createListener(){this.options.tls?this.server=H.createServer(this.options.customTlsOptions||this.proxyTlsOptions,e=>{this.handleClientConnection(e)}):this.server=k.createServer(e=>{this.handleClientConnection(e)}),this.server.listen(this.proxyPort,this.options.hostname)}handleClientConnection(e){this.users?this.handleAuth(e):this.handleClient(e)}handleAuth(e){if(this.allowedIPs?.includes(e.remoteAddress)){this.handleClient(e);return}let r=$.format("%d, %d",e.remotePort,this.proxyPort),t=new k.Socket,i;t.on("error",()=>{i=void 0,t.destroy()}),t.on("data",n=>{i=n.toString().trim(),t.destroy()}),t.on("close",()=>{if(!i){this.log("No identd"),e.destroy();return}let n=i.split(":").pop();this.users?.includes(n)?this.handleClient(e):(this.log(`User "${n}" unauthorized`),e.destroy())}),t.connect(113,e.remoteAddress,()=>{t.write(r),t.end()})}async handleClient(e){let r=this.uniqueKey(e);this.proxySockets[r]=e;let t={buffers:[],connected:!1,sequenceNumber:0,ackNumber:0,srcPort:X(1024,65535),proxySocket:e};this.createServiceSocket(t),[t.sequenceNumber,t.ackNumber]=await L("10.0.0.2","10.0.0.1",3306,t.srcPort,this.emulator),e.on("data",async i=>{await this.handleUpstreamData(t,i)}),e.on("close",()=>{delete this.proxySockets[this.uniqueKey(e)],t.serviceSocket!==void 0&&t.serviceSocket.destroy()}),e.on("error",()=>{t.serviceSocket!==void 0&&t.serviceSocket.destroy()})}async handleUpstreamData(e,r){let i=[];if(r.length>768)for(let n=0;n<r.length;n+=768)i.push(r.slice(n,n+768));else i.push(r);for(let n=0;n<i.length;n++){let o=i[n];await q("10.0.0.2","10.0.0.1",3306,e.srcPort,e.sequenceNumber,e.ackNumber,this.emulator,o),o.length>0&&(e.sequenceNumber+=o.length,Number.isFinite(e.sequenceNumber)||(e.sequenceNumber=0),process.env.DEBUG&&(i.length>1?console.log(_.bold(`Sending ${o.length} bytes (chunk ${n+1}/${i.length})`)):console.log(_.bold(`Sending ${o.length} bytes`))))}}createServiceSocket(e){let r=new ee.Decoder({onError:t=>{console.error("error:",t)},onMessage:t=>{E(Buffer.from(t));let i=g(Buffer.from(t));if(i.protocol===6){let n=b(i.payload);if(n.dstPort!==e.srcPort)return;e.ackNumber=n.seqNumber+n.payload.length,e.proxySocket.write(n.payload),n.payload.length>0&&O("10.0.0.2","10.0.0.1",e.srcPort,3306,e.sequenceNumber,e.ackNumber,this.emulator),n.flags&16&&(e.sequenceNumber=Math.max(e.sequenceNumber,n.ackNumber))}}});this.emulator.add_listener("serial1-output-byte",t=>{r.decode(Buffer.from([t]))})}parseServiceOptions(e){let r=this.getServiceHostIndex(e.proxySocket);return Object.assign({port:this.servicePorts[r],host:this.serviceHosts[r],localAddress:this.options.localAddress,localPort:this.options.localPort},this.serviceTlsOptions)}getServiceHostIndex(e){this.serviceHostIndex++,this.serviceHostIndex==this.serviceHosts.length&&(this.serviceHostIndex=0);let r=this.serviceHostIndex;return this.options.serviceHostSelected&&(r=this.options.serviceHostSelected(e,r)),r}end(){this.server?.close();for(let e in this.proxySockets)this.proxySockets[e].destroy();this.server?.unref()}log(e){this.options.quiet||console.log(e)}intercept(e,r,t){return e?e(r,t):t}uniqueKey(e){return`${e.remoteAddress}:${e.remotePort}`}};function he(s,e,r,t){return new T(s,e,r,t)}export{T as TcpProxy,he as createProxy};
