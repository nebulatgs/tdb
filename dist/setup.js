import{createRequire as Q}from"node:module";import W from"node:path";import Y from"node:url";globalThis.require=Q(import.meta.url);globalThis.__filename=Y.fileURLToPath(import.meta.url);globalThis.__dirname=W.dirname(__filename);import{writeFile as me}from"fs/promises";import he from"path";import{dirname as Z,resolve as V}from"@discordx/importer";import{Clerc as xe,completionsPlugin as Ie,helpPlugin as ke,notFoundPlugin as Be}from"clerc";import{existsSync as J}from"fs";import{ensureDir as O}from"fs-extra";import{homedir as X}from"os";import g from"path";var ee=await V(`${Z(import.meta.url)}/commands/*.{ts,js}`),te=g.join(X(),".tdb"),T=g.join(te,"data"),E=g.join(T,"mysql"),se=g.join(T,"postgres");if(!J(T))throw new Error("Data directory does not exist. Please run the `postinstall` script.");await Promise.all([O(E),O(se)]);var Le=await Promise.all(ee.map(async t=>{let{command:e}=await import(t);return e}));import j from"chalk";import{randomInt as de}from"crypto";import*as M from"fs";import*as k from"net";import pe from"slip";import*as R from"tls";import*as K from"util";import b from"chalk";import{randomInt as $}from"crypto";import re from"slip";var N=192,L=219,ne=220,oe=221;function ie(t){let e=[N];for(let r of t)r===N?e.push(L,ne):r===L?e.push(L,oe):e.push(r);return e.push(N),Buffer.from(e)}function y(t){let e=t[0]>>4&15,r=(t[0]&15)*4,s=t.readUInt16BE(2),i=t[9],n=t.slice(12,16).join("."),o=t.slice(16,20).join(".");return{version:e,headerLength:r,totalLength:s,protocol:i,srcIP:n,dstIP:o,payload:t.slice(r,s)}}function S(t){let e=t.readUInt16BE(0),r=t.readUInt16BE(2),s=t.readUInt32BE(4),i=t.readUInt32BE(8),n=(t[12]>>4&15)*4,o=t[13],c=t.readUInt16BE(14);return{srcPort:e,dstPort:r,seqNumber:s,ackNumber:i,headerLength:n,flags:o,windowSize:c,payload:t.slice(n)}}function ae(t){let e=0;for(let r=0;r<t.length;r+=2)e+=t.readUInt16BE(r);return e=(e>>16)+(e&65535),e+=e>>16,~e&65535}function P(t,e,r){let s=Buffer.alloc(12);t.split(".").forEach((o,c)=>{s[c]=parseInt(o)}),e.split(".").forEach((o,c)=>{s[4+c]=parseInt(o)}),s[8]=0,s[9]=6,s.writeUInt16BE(r.length,10);let i=Buffer.concat([s,r]),n=0;for(let o=0;o<i.length;o+=2)o===i.length-1?n+=i[o]<<8:n+=i.readUInt16BE(o);return n=(n>>16)+(n&65535),n+=n>>16,~n&65535}function v(t,e,r,s,i,n,o){let l=20+o.length,a=Buffer.alloc(l);return a.writeUInt16BE(e,0),a.writeUInt16BE(t,2),a.writeUInt32BE(r,4),a.writeUInt32BE(s,8),a[12]=20/4<<4,a[13]=i,a.writeUInt16BE(n,14),a.writeUInt16BE(0,16),a.writeUInt16BE(0,18),o.copy(a,20),a}function w(t,e,r,s){let n=20+s.length,o=Buffer.alloc(n);o[0]=69,o[1]=0,o.writeUInt16BE(n,2),o.writeUInt16BE($(65536),4),o.writeUInt16BE(16384,6),o[8]=64,o[9]=r,o.writeUInt16BE(0,10),t.split(".").forEach((l,a)=>{o[12+a]=parseInt(l)}),e.split(".").forEach((l,a)=>{o[16+a]=parseInt(l)});let c=ae(o.slice(0,20));return o.writeUInt16BE(c,10),s.copy(o,20),o}function x(t,e){_(t);let r=ie(t);e.serial_send_bytes(1,r)}async function D(t,e,r,s,i){let o=$(4294967295),c=v(r,s,o,0,2,64240,Buffer.alloc(0)),l=P(t,e,c);c.writeUInt16BE(l,16);let a=w(t,e,6,c);x(a,i);let f=await le(i,t,e,r,s,o);return[o+1,f]}function ce(t){return["FIN","SYN","RST","PSH","ACK","URG","ECE","CWR"].filter((r,s)=>t>>s&1)}function le(t,e,r,s,i,n){return new Promise((o,c)=>{let l=new re.Decoder({maxMessageSize:209715200,bufferSize:2048,onMessage:f=>{let d=y(Buffer.from(f));if(d.protocol===6){let p=S(d.payload);if(p.flags===18&&p.ackNumber===n+1){let m=v(s,i,n+1,p.seqNumber+1,16,64240,Buffer.alloc(0)),B=P(e,r,m);m.writeUInt16BE(B,16);let C=w(e,r,6,m);x(C,t),t.remove_listener("serial1-output-byte",a),o(p.seqNumber+1)}}}}),a=f=>{l.decode(Buffer.from([f]))};t.add_listener("serial1-output-byte",a),setTimeout(()=>{t.remove_listener("serial1-output-byte",a),c(new Error("Timeout waiting for SYN/ACK"))},3e4)})}async function F(t,e,r,s,i,n,o,c){let a=v(r,s,i,n,24,64240,c),f=P(t,e,a);a.writeUInt16BE(f,16);let d=w(t,e,6,a);x(d,o)}var ue=16;function fe(t,e,r,s,i=64240){return v(e,t,r,s,ue,i,Buffer.alloc(0))}function H(t,e,r,s,i,n,o){let c=fe(r,s,i,n,64240),l=P(t,e,c);c.writeUInt16BE(l,16);let a=w(t,e,6,c);return x(a,o),n}function U(t,e){return t.padEnd(e)}function h(t,e){return t.padStart(e)}function _(t){if(!process.env.DEBUG)return;let e=y(t),{srcIP:r,dstIP:s}=e,i=r==="10.0.0.1"?b.green(r):b.red(r),n=s==="10.0.0.1"?b.green(s):b.red(s),o=S(e.payload),{srcPort:c,dstPort:l,seqNumber:a,ackNumber:f,flags:d,windowSize:p}=o,A=`${U(i,16)} -> ${U(n,16)}`,m=`TCP ${h(c.toString(),5)} -> ${h(l.toString(),5)}`,B=`[${U(ce(d).join(", "),20)}]`,C=`Seq=${h(a.toString(),10)}`,z=`Ack=${h(f.toString(),10)}`,G=`Win=${h(p.toString(),5)}`;console.log(`${A} ${m} ${B} ${C} ${z} ${G}`)}var I=class{proxyPort;serviceHosts;servicePorts;serviceHostIndex;options;proxyTlsOptions;serviceTlsOptions;proxySockets;users;allowedIPs;server=null;emulator;constructor(e,r,s,i,n){this.emulator=i,this.proxyPort=e,this.serviceHosts=this.parse(r),this.servicePorts=this.parse(s).map(Number),this.serviceHostIndex=-1,this.options=this.parseOptions(n),this.proxyTlsOptions={passphrase:this.options.passphrase,secureProtocol:"TLSv1_2_method"},this.options.tls&&(this.proxyTlsOptions.pfx=M.readFileSync(this.options.pfx)),this.serviceTlsOptions={rejectUnauthorized:this.options.rejectUnauthorized,secureProtocol:"TLSv1_2_method"},this.proxySockets={},this.options.identUsers.length!==0?(this.users=this.options.identUsers,this.log(`Will only allow these users: ${this.users.join(", ")}`)):this.log("Will allow all users"),this.options.allowedIPs.length!==0&&(this.allowedIPs=this.options.allowedIPs),this.createListener()}parse(e){if(typeof e=="string")return e.split(",");if(typeof e=="number")return this.parse(e.toString());if(Array.isArray(e))return e;throw new Error("cannot parse object: "+e)}parseOptions(e){return Object.assign({quiet:!0,pfx:void 0,passphrase:"abcd",rejectUnauthorized:!0,identUsers:[],allowedIPs:[],tls:!1,hostname:void 0,customTlsOptions:void 0,localAddress:void 0,localPort:void 0,upstream:void 0,downstream:void 0,serviceHostSelected:void 0},e||{})}createListener(){this.options.tls?this.server=R.createServer(this.options.customTlsOptions||this.proxyTlsOptions,e=>{this.handleClientConnection(e)}):this.server=k.createServer(e=>{this.handleClientConnection(e)}),this.server.listen(this.proxyPort,this.options.hostname)}handleClientConnection(e){this.users?this.handleAuth(e):this.handleClient(e)}handleAuth(e){if(this.allowedIPs?.includes(e.remoteAddress)){this.handleClient(e);return}let r=K.format("%d, %d",e.remotePort,this.proxyPort),s=new k.Socket,i;s.on("error",()=>{i=void 0,s.destroy()}),s.on("data",n=>{i=n.toString().trim(),s.destroy()}),s.on("close",()=>{if(!i){this.log("No identd"),e.destroy();return}let n=i.split(":").pop();this.users?.includes(n)?this.handleClient(e):(this.log(`User "${n}" unauthorized`),e.destroy())}),s.connect(113,e.remoteAddress,()=>{s.write(r),s.end()})}async handleClient(e){let r=this.uniqueKey(e);this.proxySockets[r]=e;let s={buffers:[],connected:!1,sequenceNumber:0,ackNumber:0,srcPort:de(1024,65535),proxySocket:e};this.createServiceSocket(s),[s.sequenceNumber,s.ackNumber]=await D("10.0.0.2","10.0.0.1",3306,s.srcPort,this.emulator),e.on("data",async i=>{await this.handleUpstreamData(s,i)}),e.on("close",()=>{delete this.proxySockets[this.uniqueKey(e)],s.serviceSocket!==void 0&&s.serviceSocket.destroy()}),e.on("error",()=>{s.serviceSocket!==void 0&&s.serviceSocket.destroy()})}async handleUpstreamData(e,r){let i=[];if(r.length>768)for(let n=0;n<r.length;n+=768)i.push(r.slice(n,n+768));else i.push(r);for(let n=0;n<i.length;n++){let o=i[n];await F("10.0.0.2","10.0.0.1",3306,e.srcPort,e.sequenceNumber,e.ackNumber,this.emulator,o),o.length>0&&(e.sequenceNumber+=o.length,Number.isFinite(e.sequenceNumber)||(e.sequenceNumber=0),process.env.DEBUG&&(i.length>1?console.log(j.bold(`Sending ${o.length} bytes (chunk ${n+1}/${i.length})`)):console.log(j.bold(`Sending ${o.length} bytes`))))}}createServiceSocket(e){let r=new pe.Decoder({onError:s=>{console.error("error:",s)},onMessage:s=>{_(Buffer.from(s));let i=y(Buffer.from(s));if(i.protocol===6){let n=S(i.payload);if(n.dstPort!==e.srcPort)return;e.ackNumber=n.seqNumber+n.payload.length,e.proxySocket.write(n.payload),n.payload.length>0&&H("10.0.0.2","10.0.0.1",e.srcPort,3306,e.sequenceNumber,e.ackNumber,this.emulator),n.flags&16&&(e.sequenceNumber=Math.max(e.sequenceNumber,n.ackNumber))}}});this.emulator.add_listener("serial1-output-byte",s=>{r.decode(Buffer.from([s]))})}parseServiceOptions(e){let r=this.getServiceHostIndex(e.proxySocket);return Object.assign({port:this.servicePorts[r],host:this.serviceHosts[r],localAddress:this.options.localAddress,localPort:this.options.localPort},this.serviceTlsOptions)}getServiceHostIndex(e){this.serviceHostIndex++,this.serviceHostIndex==this.serviceHosts.length&&(this.serviceHostIndex=0);let r=this.serviceHostIndex;return this.options.serviceHostSelected&&(r=this.options.serviceHostSelected(e,r)),r}end(){this.server?.close();for(let e in this.proxySockets)this.proxySockets[e].destroy();this.server?.unref()}log(e){this.options.quiet||console.log(e)}intercept(e,r,s){return e?e(r,s):s}uniqueKey(e){return`${e.remoteAddress}:${e.remotePort}`}};function q(t,e,r){return new Promise(s=>{let i="",n=o=>{let c=String.fromCharCode(o);c===`
`&&(i=""),i+=c,i.includes(e)&&(i="",t.remove_listener(`serial${r}-output-byte`,n),s())};t.add_listener(`serial${r}-output-byte`,n)})}async function u(t){await q(t,"localhost:~#",0)}async function Ye(t,e="(none)"){await q(t,`MariaDB [${e}]>`,1)}async function Ze(t){await u(t),await be(t),await ge(t);let e=await t.save_state();await me(he.join(E,"/blank.state"),Buffer.from(e))}async function ge(t){t.serial0_send(`ip link set lo up
`),await u(t)}async function Ve(t,e){e.serial0_send(`slattach -v -L -s 115200 -p slip /dev/ttyS1   &
`),await u(e),e.serial0_send(`sysctl -w net.ipv4.ip_forward=1
`),await u(e),e.serial0_send(`ip addr add 10.0.0.1 peer 10.0.0.2 dev sl0
`),await u(e),e.serial0_send(`ip link set sl0 up
`),await u(e),e.serial0_send(`ip route add default via 10.0.0.1 dev sl0
`),await u(e)}async function Je(t,e){return new I(t,"127.0.0.1",3306,e,{hostname:"127.0.0.1"})}async function be(t){t.serial0_send(`chown mysql:mysql /run/mysqld
`),await u(t),t.serial0_send(`echo '10.0.0.2 mysql' >> /etc/hosts
`),await u(t),process.env.DEBUG?t.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
`):t.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql > /dev/ttyS2
`),await u(t)}async function Xe(t){t.serial0_send(`setsid sh -c 'su mysql -c mysqld -s /bin/ash <> /dev/ttyS2 >&0 2>&1'
`),await u(t),await q(t,"Alpine Linux",2),t.serial0_send(`mysql -uroot mysql -padmin -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.0.0.%' IDENTIFIED BY 'admin' WITH GRANT OPTION"

`),await u(t)}async function et(t){t.serial0_send(`setsid sh -c 'su mysql -c mysql <> /dev/ttyS1 >&0 2>&1'
`),await u(t)}export{Ve as initializeMySQLNetworking,ge as networkUp,Ze as setupBlankState,be as setupMySQL,Xe as startMySQL,Je as startMySQLForwarding,et as startMySQLShell,Ye as waitForMySQLPrompt,u as waitForPrompt,q as waitForSerialLine};
