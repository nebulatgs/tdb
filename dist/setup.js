import{createRequire as W}from"node:module";import Y from"node:path";import Z from"node:url";globalThis.require=W(import.meta.url);globalThis.__filename=Z.fileURLToPath(import.meta.url);globalThis.__dirname=Y.dirname(__filename);import{writeFile as fe}from"fs/promises";import de from"path";import{dirname as V,resolve as J}from"@discordx/importer";import{Clerc as Be,completionsPlugin as Pe,helpPlugin as Se,notFoundPlugin as Ie}from"clerc";import{existsSync as X}from"fs";import{ensureDir as O}from"fs-extra";import{homedir as ee}from"os";import b from"path";var te=await J(`${V(import.meta.url)}/commands/*.{ts,js}`),ne=b.join(ee(),".tdb"),T=b.join(ne,"data"),A=b.join(T,"mysql"),re=b.join(T,"postgres");if(!X(T))throw new Error("Data directory does not exist. Please run the `postinstall` script.");await Promise.all([O(A),O(re)]);var Ue=await Promise.all(te.map(async t=>{let{command:e}=await import(t);return e}));import j from"chalk";import{randomInt as ue}from"crypto";import*as K from"fs";import*as k from"net";import*as G from"tls";import*as z from"util";import w from"chalk";import{randomInt as R}from"crypto";var m=Buffer.from("001122334455","hex");function se(t,e){let s=14+t.length,r=Buffer.alloc(s);return e.copy(r,0),m.copy(r,6),r.writeUInt16BE(2048,12),t.copy(r,14),r}function B(t){let e=t[0]>>4&15,s=(t[0]&15)*4,r=t.readUInt16BE(2),i=t[9],o=t.slice(12,16).join("."),n=t.slice(16,20).join(".");return{version:e,headerLength:s,totalLength:r,protocol:i,srcIP:o,dstIP:n,payload:t.slice(s,r)}}function P(t){let e=t.readUInt16BE(0),s=t.readUInt16BE(2),r=t.readUInt32BE(4),i=t.readUInt32BE(8),o=(t[12]>>4&15)*4,n=t[13],a=t.readUInt16BE(14);return{srcPort:e,dstPort:s,seqNumber:r,ackNumber:i,headerLength:o,flags:n,windowSize:a,payload:t.slice(o)}}function ie(t){let e=0;for(let s=0;s<t.length;s+=2)e+=t.readUInt16BE(s);return e=(e>>16)+(e&65535),e+=e>>16,~e&65535}function S(t,e,s){let r=Buffer.alloc(12);t.split(".").forEach((n,a)=>{r[a]=parseInt(n)}),e.split(".").forEach((n,a)=>{r[4+a]=parseInt(n)}),r[8]=0,r[9]=6,r.writeUInt16BE(s.length,10);let i=Buffer.concat([r,s]),o=0;for(let n=0;n<i.length;n+=2)n===i.length-1?o+=i[n]<<8:o+=i.readUInt16BE(n);return o=(o>>16)+(o&65535),o+=o>>16,~o&65535}function I(t,e,s,r,i,o,n){let l=20+n.length,c=Buffer.alloc(l);return c.writeUInt16BE(e,0),c.writeUInt16BE(t,2),c.writeUInt32BE(s,4),c.writeUInt32BE(r,8),c[12]=20/4<<4,c[13]=i,c.writeUInt16BE(o,14),c.writeUInt16BE(0,16),c.writeUInt16BE(0,18),n.copy(c,20),c}function v(t,e,s,r){let o=20+r.length,n=Buffer.alloc(o);n[0]=69,n[1]=0,n.writeUInt16BE(o,2),n.writeUInt16BE(R(65536),4),n.writeUInt16BE(16384,6),n[8]=64,n[9]=s,n.writeUInt16BE(0,10),t.split(".").forEach((l,c)=>{n[12+c]=parseInt(l)}),e.split(".").forEach((l,c)=>{n[16+c]=parseInt(l)});let a=ie(n.slice(0,20));return n.writeUInt16BE(a,10),r.copy(n,20),n}function x(t,e,s){_(t);let r=se(t,e);s.bus.send("net0-receive",new Uint8Array(r))}async function $(t,e,s,r,i,o){let a=R(4294967295),l=I(r,i,a,0,2,64240,Buffer.alloc(0)),c=S(t,e,l);l.writeUInt16BE(c,16);let f=v(t,e,6,l);x(f,s,o);let u=await ae(o,t,e,s,r,i,a);return[a+1,u]}function oe(t){return["FIN","SYN","RST","PSH","ACK","URG","ECE","CWR"].filter((s,r)=>t>>r&1)}function ae(t,e,s,r,i,o,n){return new Promise((a,l)=>{function c(u){if(u.etherType!==2048||!u.destinationMAC.equals(m))return;let p=B(u.payload);if(p.protocol===6){let h=P(p.payload);if(h.flags===18&&h.ackNumber===n+1){let y=I(i,o,n+1,h.seqNumber+1,16,64240,Buffer.alloc(0)),U=S(e,s,y);y.writeUInt16BE(U,16);let C=v(e,s,6,y);x(C,r,t),t.remove_listener("net0-send",f),a(h.seqNumber+1)}}}let f=u=>{c(L(Buffer.from(u)))};t.add_listener("net0-send",f),setTimeout(()=>{t.remove_listener("net0-send",f),l(new Error("Timeout waiting for SYN/ACK"))},3e4)})}async function D(t,e,s,r,i,o,n,a,l){let f=I(r,i,o,n,24,64240,l),u=S(t,e,f);f.writeUInt16BE(u,16);let p=v(t,e,6,f);x(p,s,a)}var ce=16;function le(t,e,s,r,i=64240){return I(e,t,s,r,ce,i,Buffer.alloc(0))}function H(t,e,s,r,i,o,n,a){let l=le(r,i,o,n,64240),c=S(t,e,l);l.writeUInt16BE(c,16);let f=v(t,e,6,l);return x(f,s,a),n}function N(t,e){return t.padEnd(e)}function g(t,e){return t.padStart(e)}function _(t){if(!process.env.DEBUG)return;let e=B(t),{srcIP:s,dstIP:r}=e,i=s==="10.0.0.1"?w.green(s):w.red(s),o=r==="10.0.0.1"?w.green(r):w.red(r),n=P(e.payload),{srcPort:a,dstPort:l,seqNumber:c,ackNumber:f,flags:u,windowSize:p}=n,h=`${N(i,16)} -> ${N(o,16)}`,F=`TCP ${g(a.toString(),5)} -> ${g(l.toString(),5)}`,y=`[${N(oe(u).join(", "),20)}]`,U=`Seq=${g(c.toString(),10)}`,C=`Ack=${g(f.toString(),10)}`,Q=`Win=${g(p.toString(),5)}`;console.log(`${h} ${F} ${y} ${U} ${C} ${Q}`)}function L(t){if(t.length<14)throw new Error("Buffer is too small to contain a valid Ethernet frame");let e=t.slice(0,6),s=t.slice(6,12),r=t.readUInt16BE(12),i=t.slice(14);return{destinationMAC:e,sourceMAC:s,etherType:r,payload:i}}function M(t,e,s){return new Promise(r=>{let i=Buffer.from(t.split(".").map(a=>parseInt(a))),o=Buffer.from(e.split(".").map(a=>parseInt(a))),n=Buffer.alloc(42);n.write("FFFFFFFFFFFF",0,"hex"),m.copy(n,6),n.writeUInt16BE(2054,12),n.writeUInt16BE(1,14),n.writeUInt16BE(2048,16),n.writeUInt8(6,18),n.writeUInt8(4,19),n.writeUInt16BE(1,20),m.copy(n,22),i.copy(n,28),n.fill(0,32,38),o.copy(n,38),s.add_listener("net0-send",a=>{let l=Buffer.from(a);if(l.readUInt16BE(12)===2054&&l.readUInt16BE(20)===2){let c=l.slice(6,12);r(c)}}),s.add_listener("net0-send",a=>{let l=Buffer.from(a);if(l.readUInt16BE(12)===2054&&l.readUInt16BE(20)===1){let c=l.slice(6,12),f=l.slice(28,32).join("."),u=Buffer.alloc(42);c.copy(u,0),m.copy(u,6),u.writeUInt16BE(2054,12),u.writeUInt16BE(1,14),u.writeUInt16BE(2048,16),u.writeUInt8(6,18),u.writeUInt8(4,19),u.writeUInt16BE(2,20),m.copy(u,22),i.copy(u,28),c.copy(u,32),f.split(".").forEach((p,h)=>{u[38+h]=parseInt(p)}),console.log("Responded to ARP request"),s.bus.send("net0-receive",new Uint8Array(u))}}),s.bus.send("net0-receive",new Uint8Array(n))})}var E=class{proxyPort;serviceHosts;servicePorts;serviceHostIndex;options;proxyTlsOptions;serviceTlsOptions;proxySockets;users;allowedIPs;server=null;emulator;constructor(e,s,r,i,o){this.emulator=i,this.proxyPort=e,this.serviceHosts=this.parse(s),this.servicePorts=this.parse(r).map(Number),this.serviceHostIndex=-1,this.options=this.parseOptions(o),this.proxyTlsOptions={passphrase:this.options.passphrase,secureProtocol:"TLSv1_2_method"},this.options.tls&&(this.proxyTlsOptions.pfx=K.readFileSync(this.options.pfx)),this.serviceTlsOptions={rejectUnauthorized:this.options.rejectUnauthorized,secureProtocol:"TLSv1_2_method"},this.proxySockets={},this.options.identUsers.length!==0?(this.users=this.options.identUsers,this.log(`Will only allow these users: ${this.users.join(", ")}`)):this.log("Will allow all users"),this.options.allowedIPs.length!==0&&(this.allowedIPs=this.options.allowedIPs),this.createListener()}parse(e){if(typeof e=="string")return e.split(",");if(typeof e=="number")return this.parse(e.toString());if(Array.isArray(e))return e;throw new Error("cannot parse object: "+e)}parseOptions(e){return Object.assign({quiet:!0,pfx:void 0,passphrase:"abcd",rejectUnauthorized:!0,identUsers:[],allowedIPs:[],tls:!1,hostname:void 0,customTlsOptions:void 0,localAddress:void 0,localPort:void 0,upstream:void 0,downstream:void 0,serviceHostSelected:void 0},e||{})}createListener(){this.options.tls?this.server=G.createServer(this.options.customTlsOptions||this.proxyTlsOptions,e=>{this.handleClientConnection(e)}):this.server=k.createServer(e=>{this.handleClientConnection(e)}),this.server.listen(this.proxyPort,this.options.hostname)}handleClientConnection(e){this.users?this.handleAuth(e):this.handleClient(e)}handleAuth(e){if(this.allowedIPs?.includes(e.remoteAddress)){this.handleClient(e);return}let s=z.format("%d, %d",e.remotePort,this.proxyPort),r=new k.Socket,i;r.on("error",()=>{i=void 0,r.destroy()}),r.on("data",o=>{i=o.toString().trim(),r.destroy()}),r.on("close",()=>{if(!i){this.log("No identd"),e.destroy();return}let o=i.split(":").pop();this.users?.includes(o)?this.handleClient(e):(this.log(`User "${o}" unauthorized`),e.destroy())}),r.connect(113,e.remoteAddress,()=>{r.write(s),r.end()})}async handleClient(e){let s=this.uniqueKey(e);this.proxySockets[s]=e;let r=await M("10.0.0.2","10.0.0.1",this.emulator),i={buffers:[],connected:!1,sequenceNumber:0,ackNumber:0,srcPort:ue(1024,65535),macAddress:r,proxySocket:e};this.createServiceSocket(i),[i.sequenceNumber,i.ackNumber]=await $("10.0.0.2","10.0.0.1",i.macAddress,3306,i.srcPort,this.emulator),e.on("data",async o=>{await this.handleUpstreamData(i,o)}),e.on("close",()=>{delete this.proxySockets[this.uniqueKey(e)],i.serviceSocket!==void 0&&i.serviceSocket.destroy()}),e.on("error",()=>{i.serviceSocket!==void 0&&i.serviceSocket.destroy()})}async handleUpstreamData(e,s){let i=[];if(s.length>1448)for(let o=0;o<s.length;o+=1448)i.push(s.slice(o,o+1448));else i.push(s);for(let o=0;o<i.length;o++){let n=i[o];await D("10.0.0.2","10.0.0.1",e.macAddress,3306,e.srcPort,e.sequenceNumber,e.ackNumber,this.emulator,n),n.length>0&&(e.sequenceNumber+=n.length,Number.isFinite(e.sequenceNumber)||(e.sequenceNumber=0),process.env.DEBUG&&(i.length>1?console.log(j.bold(`Sending ${n.length} bytes (chunk ${o+1}/${i.length})`)):console.log(j.bold(`Sending ${n.length} bytes`))))}}createServiceSocket(e){let s=r=>{if(r.etherType!==2048||!r.destinationMAC.equals(m))return;let i=r.payload;_(Buffer.from(i));let o=B(Buffer.from(i));if(o.protocol===6){let n=P(o.payload);if(n.dstPort!==e.srcPort)return;e.ackNumber=n.seqNumber+n.payload.length,e.proxySocket.write(n.payload),n.payload.length>0&&H("10.0.0.2","10.0.0.1",e.macAddress,e.srcPort,3306,e.sequenceNumber,e.ackNumber,this.emulator),n.flags&16&&(e.sequenceNumber=Math.max(e.sequenceNumber,n.ackNumber))}};this.emulator.add_listener("net0-send",r=>{s(L(Buffer.from(r)))})}parseServiceOptions(e){let s=this.getServiceHostIndex(e.proxySocket);return Object.assign({port:this.servicePorts[s],host:this.serviceHosts[s],localAddress:this.options.localAddress,localPort:this.options.localPort},this.serviceTlsOptions)}getServiceHostIndex(e){this.serviceHostIndex++,this.serviceHostIndex==this.serviceHosts.length&&(this.serviceHostIndex=0);let s=this.serviceHostIndex;return this.options.serviceHostSelected&&(s=this.options.serviceHostSelected(e,s)),s}end(){this.server?.close();for(let e in this.proxySockets)this.proxySockets[e].destroy();this.server?.unref()}log(e){this.options.quiet||console.log(e)}intercept(e,s,r){return e?e(s,r):r}uniqueKey(e){return`${e.remoteAddress}:${e.remotePort}`}};function q(t,e,s){return new Promise(r=>{let i="",o=n=>{let a=String.fromCharCode(n);a===`
`&&(i=""),i+=a,i.includes(e)&&(i="",t.remove_listener(`serial${s}-output-byte`,o),r())};t.add_listener(`serial${s}-output-byte`,o)})}async function d(t){await q(t,"localhost:~#",0)}async function Ke(t,e="(none)"){await q(t,`MariaDB [${e}]>`,1)}async function Ge(t){await d(t),await he(t),await pe(t);let e=await t.save_state();await fe(de.join(A,"/blank.state"),Buffer.from(e))}async function pe(t){t.serial0_send(`ip link set lo up
`),await d(t)}async function ze(t,e){e.serial0_send(`modprobe ne2k-pci
`),await d(e),await d(e),e.serial0_send(`sysctl -w net.ipv4.ip_forward=1
`),await d(e),e.serial0_send(`ip addr add 10.0.0.1 peer 10.0.0.2 dev eth0
`),await d(e),e.serial0_send(`ip link set dev eth0 mtu 1500
`),await d(e),e.serial0_send(`ip link set eth0 up
`),await d(e),e.serial0_send(`ip route add default via 10.0.0.1 dev eth0
`),await d(e)}async function Qe(t,e){return new E(t,"127.0.0.1",3306,e,{hostname:"127.0.0.1"})}async function he(t){t.serial0_send(`chown mysql:mysql /run/mysqld
`),await d(t),t.serial0_send(`echo '10.0.0.2 mysql' >> /etc/hosts
`),await d(t),process.env.DEBUG?t.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
`):t.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql > /dev/ttyS2
`),await d(t)}async function We(t){t.serial0_send(`setsid sh -c 'su mysql -c mysqld -s /bin/ash <> /dev/ttyS2 >&0 2>&1'
`),await d(t),await q(t,"Alpine Linux",2),t.serial0_send(`mysql -uroot mysql -padmin -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.0.0.%' IDENTIFIED BY 'admin' WITH GRANT OPTION"

`),await d(t)}async function Ye(t){t.serial0_send(`setsid sh -c 'su mysql -c mysql <> /dev/ttyS1 >&0 2>&1'
`),await d(t)}export{ze as initializeMySQLNetworking,pe as networkUp,Ge as setupBlankState,he as setupMySQL,We as startMySQL,Qe as startMySQLForwarding,Ye as startMySQLShell,Ke as waitForMySQLPrompt,d as waitForPrompt,q as waitForSerialLine};
