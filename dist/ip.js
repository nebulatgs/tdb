import{createRequire as $}from"node:module";import R from"node:path";import q from"node:url";globalThis.require=$(import.meta.url);globalThis.__filename=q.fileURLToPath(import.meta.url);globalThis.__dirname=R.dirname(__filename);import I from"chalk";import{randomInt as k}from"crypto";var h=Buffer.from("001122334455","hex");function v(e,t){let o=14+e.length,n=Buffer.alloc(o);return t.copy(n,0),h.copy(n,6),n.writeUInt16BE(2048,12),e.copy(n,14),n}var E=192,B=219,S=220,A=221;function Q(e){let t=[E];for(let o of e)o===E?t.push(B,S):o===B?t.push(B,A):t.push(o);return t.push(E),Buffer.from(t)}function V(e){let t=[],o=!1;for(let n of e)o?(n===S?t.push(E):n===A?t.push(B):(t.push(B),t.push(n)),o=!1):n===B?o=!0:n===E||t.push(n);return Buffer.from(t)}function L(e){let t=e[0]>>4&15,o=(e[0]&15)*4,n=e.readUInt16BE(2),s=e[9],c=e.slice(12,16).join("."),r=e.slice(16,20).join(".");return{version:t,headerLength:o,totalLength:n,protocol:s,srcIP:c,dstIP:r,payload:e.slice(o,n)}}function T(e){let t=e.readUInt16BE(0),o=e.readUInt16BE(2),n=e.readUInt32BE(4),s=e.readUInt32BE(8),c=(e[12]>>4&15)*4,r=e[13],i=e.readUInt16BE(14);return{srcPort:t,dstPort:o,seqNumber:n,ackNumber:s,headerLength:c,flags:r,windowSize:i,payload:e.slice(c)}}function _(e){let t=0;for(let o=0;o<e.length;o+=2)t+=e.readUInt16BE(o);return t=(t>>16)+(t&65535),t+=t>>16,~t&65535}function U(e,t,o){let n=Buffer.alloc(12);e.split(".").forEach((r,i)=>{n[i]=parseInt(r)}),t.split(".").forEach((r,i)=>{n[4+i]=parseInt(r)}),n[8]=0,n[9]=6,n.writeUInt16BE(o.length,10);let s=Buffer.concat([n,o]),c=0;for(let r=0;r<s.length;r+=2)r===s.length-1?c+=s[r]<<8:c+=s.readUInt16BE(r);return c=(c>>16)+(c&65535),c+=c>>16,~c&65535}function x(e,t,o,n,s,c,r){let a=20+r.length,f=Buffer.alloc(a);return f.writeUInt16BE(t,0),f.writeUInt16BE(e,2),f.writeUInt32BE(o,4),f.writeUInt32BE(n,8),f[12]=20/4<<4,f[13]=s,f.writeUInt16BE(c,14),f.writeUInt16BE(0,16),f.writeUInt16BE(0,18),r.copy(f,20),f}function w(e,t,o,n){let c=20+n.length,r=Buffer.alloc(c);r[0]=69,r[1]=0,r.writeUInt16BE(c,2),r.writeUInt16BE(k(65536),4),r.writeUInt16BE(16384,6),r[8]=64,r[9]=o,r.writeUInt16BE(0,10),e.split(".").forEach((a,f)=>{r[12+f]=parseInt(a)}),t.split(".").forEach((a,f)=>{r[16+f]=parseInt(a)});let i=_(r.slice(0,20));return r.writeUInt16BE(i,10),n.copy(r,20),r}function y(e,t,o){G(e);let n=v(e,t);o.bus.send("net0-receive",new Uint8Array(n))}async function X(e,t,o,n,s,c){let i=k(4294967295),a=x(n,s,i,0,2,64240,Buffer.alloc(0)),f=U(e,t,a);a.writeUInt16BE(f,16);let l=w(e,t,6,a);y(l,o,c);let u=await D(c,e,t,o,n,s,i);return[i+1,u]}function M(e){return["FIN","SYN","RST","PSH","ACK","URG","ECE","CWR"].filter((o,n)=>e>>n&1)}function Z(e){let o=0+e.length,n=Buffer.alloc(o);e.copy(n,0,0,0),n[0]=0;let s=_(n);return n.writeUInt16BE(s,2),e.copy(n,0),n}function D(e,t,o,n,s,c,r){return new Promise((i,a)=>{function f(u){if(u.etherType!==2048||!u.destinationMAC.equals(h))return;let m=L(u.payload);if(m.protocol===6){let d=T(m.payload);if(d.flags===18&&d.ackNumber===r+1){let p=x(s,c,r+1,d.seqNumber+1,16,64240,Buffer.alloc(0)),b=U(t,o,p);p.writeUInt16BE(b,16);let P=w(t,o,6,p);y(P,n,e),e.remove_listener("net0-send",l),i(d.seqNumber+1)}}}let l=u=>{f(Y(Buffer.from(u)))};e.add_listener("net0-send",l),setTimeout(()=>{e.remove_listener("net0-send",l),a(new Error("Timeout waiting for SYN/ACK"))},3e4)})}async function ee(e,t,o,n,s,c,r,i,a){let l=x(n,s,c,r,24,64240,a),u=U(e,t,l);l.writeUInt16BE(u,16);let m=w(e,t,6,l);y(m,o,i)}var K=16;function j(e,t,o,n,s=64240){return x(t,e,o,n,K,s,Buffer.alloc(0))}function te(e,t,o,n,s,c,r,i){let a=j(n,s,c,r,64240),f=U(e,t,a);a.writeUInt16BE(f,16);let l=w(e,t,6,a);return y(l,o,i),r}function C(e,t){return e.padEnd(t)}function g(e,t){return e.padStart(t)}function G(e){if(!process.env.DEBUG)return;let t=L(e),{srcIP:o,dstIP:n}=t,s=o==="10.0.0.1"?I.green(o):I.red(o),c=n==="10.0.0.1"?I.green(n):I.red(n),r=T(t.payload),{srcPort:i,dstPort:a,seqNumber:f,ackNumber:l,flags:u,windowSize:m}=r,d=`${C(s,16)} -> ${C(c,16)}`,F=`TCP ${g(i.toString(),5)} -> ${g(a.toString(),5)}`,p=`[${C(M(u).join(", "),20)}]`,b=`Seq=${g(f.toString(),10)}`,P=`Ack=${g(l.toString(),10)}`,N=`Win=${g(m.toString(),5)}`;console.log(`${d} ${F} ${p} ${b} ${P} ${N}`)}function Y(e){if(e.length<14)throw new Error("Buffer is too small to contain a valid Ethernet frame");let t=e.slice(0,6),o=e.slice(6,12),n=e.readUInt16BE(12),s=e.slice(14);return{destinationMAC:t,sourceMAC:o,etherType:n,payload:s}}function ne(e,t,o){return new Promise(n=>{let s=Buffer.from(e.split(".").map(i=>parseInt(i))),c=Buffer.from(t.split(".").map(i=>parseInt(i))),r=Buffer.alloc(42);r.write("FFFFFFFFFFFF",0,"hex"),h.copy(r,6),r.writeUInt16BE(2054,12),r.writeUInt16BE(1,14),r.writeUInt16BE(2048,16),r.writeUInt8(6,18),r.writeUInt8(4,19),r.writeUInt16BE(1,20),h.copy(r,22),s.copy(r,28),r.fill(0,32,38),c.copy(r,38),o.add_listener("net0-send",i=>{let a=Buffer.from(i);if(a.readUInt16BE(12)===2054&&a.readUInt16BE(20)===2){let f=a.slice(6,12);n(f)}}),o.add_listener("net0-send",i=>{let a=Buffer.from(i);if(a.readUInt16BE(12)===2054&&a.readUInt16BE(20)===1){let f=a.slice(6,12),l=a.slice(28,32).join("."),u=Buffer.alloc(42);f.copy(u,0),h.copy(u,6),u.writeUInt16BE(2054,12),u.writeUInt16BE(1,14),u.writeUInt16BE(2048,16),u.writeUInt8(6,18),u.writeUInt8(4,19),u.writeUInt16BE(2,20),h.copy(u,22),s.copy(u,28),f.copy(u,32),l.split(".").forEach((m,d)=>{u[38+d]=parseInt(m)}),console.log("Responded to ARP request"),o.bus.send("net0-receive",new Uint8Array(u))}}),o.bus.send("net0-receive",new Uint8Array(r))})}export{h as SOURCE_MAC,w as createIPPacket,x as createTCPPacket,M as decodeTCPFlags,X as establishConnection,G as logTCPIPPacket,Y as parseEthernetFrame,L as parseIPPacket,T as parseTCPPacket,Z as respondICMPPacket,te as sendACK,ne as sendARPRequest,y as sendPacketToEthernetDevice,ee as sendTCPPacket,V as slipDecode,Q as slipEncode,D as waitForSYNACK};
