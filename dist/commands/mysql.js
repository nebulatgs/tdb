var Cc=Object.create;var En=Object.defineProperty;var Tc=Object.getOwnPropertyDescriptor;var Dc=Object.getOwnPropertyNames;var Ic=Object.getPrototypeOf,Rc=Object.prototype.hasOwnProperty;var st=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(i,s)=>(typeof require<"u"?require:i)[s]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var Oc=(o,i)=>()=>(o&&(i=o(o=0)),i);var Z=(o,i)=>()=>(i||o((i={exports:{}}).exports,i),i.exports);var Pc=(o,i,s,h)=>{if(i&&typeof i=="object"||typeof i=="function")for(let c of Dc(i))!Rc.call(o,c)&&c!==s&&En(o,c,{get:()=>i[c],enumerable:!(h=Tc(i,c))||h.enumerable});return o};var di=(o,i,s)=>(s=o!=null?Cc(Ic(o)):{},Pc(i||!o||!o.__esModule?En(s,"default",{value:o,enumerable:!0}):s,o));import{createRequire as Mc}from"node:module";import qc from"node:path";import Fc from"node:url";var T=Oc(()=>{"use strict";globalThis.require=Mc(import.meta.url);globalThis.__filename=Fc.fileURLToPath(import.meta.url);globalThis.__dirname=qc.dirname(__filename)});var Cn=Z((An,Ft)=>{"use strict";T();(function(){"use strict";function o(t,e){function r(L){return L=L.toString(16),"#"+"0".repeat(6-L.length)+L}function n(L,j,wt,mt){L.style.width="",L.style.height="",mt&&(L.style.transform="");var Gt=L.getBoundingClientRect();mt?L.style.transform=(j===1?"":" scaleX("+j+")")+(wt===1?"":" scaleY("+wt+")"):(j%1===0&&wt%1===0?(a.style.imageRendering="crisp-edges",a.style.imageRendering="pixelated",a.style["-ms-interpolation-mode"]="nearest-neighbor"):(a.style.imageRendering="",a.style["-ms-interpolation-mode"]=""),mt=window.devicePixelRatio||1,mt%1!==0&&(j/=mt,wt/=mt)),j!==1&&(L.style.width=Gt.width*j+"px"),wt!==1&&(L.style.height=Gt.height*wt+"px")}console.assert(t,"1st argument must be a DOM container");var a=t.getElementsByTagName("canvas")[0],p=a.getContext("2d",{alpha:!1}),d=t.getElementsByTagName("div")[0],m=document.createElement("div"),g,y,b=1,E=1,R=1,C,U=!1,F,P,X,Rt=!1,$t=this;t=new Uint16Array([8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var Sc=new Uint16Array([32,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),Xs=[],xn,Ce=0;256>Ce;Ce++)xn=126<Ce?t[Ce-127]:32>Ce?Sc[Ce]:Ce,Xs[Ce]=String.fromCharCode(xn);p.imageSmoothingEnabled=!1,m.classList.add("cursor"),m.style.position="absolute",m.style.backgroundColor="#ccc",m.style.width="7px",m.style.display="inline-block",d.style.display="block",a.style.display="none",this.bus=e,e.register("screen-set-mode",function(L){this.set_mode(L)},this),e.register("screen-fill-buffer-end",function(L){this.update_buffer(L)},this),e.register("screen-put-char",function(L){this.put_char(L[0],L[1],L[2],L[3],L[4],L[5])},this),e.register("screen-update-cursor",function(L){this.update_cursor(L[0],L[1])},this),e.register("screen-update-cursor-scanline",function(L){this.update_cursor_scanline(L[0],L[1],L[2])},this),e.register("screen-clear",function(){this.clear_screen()},this),e.register("screen-set-size-text",function(L){this.set_size_text(L[0],L[1])},this),e.register("screen-set-size-graphical",function(L){this.set_size_graphical(L[0],L[1],L[2],L[3])},this),this.init=function(){this.set_size_text(80,25),this.timer()},this.make_screenshot=function(){let L=new Image;if(U)L.src=a.toDataURL("image/png");else{let j=[9,16],wt=document.createElement("canvas");wt.width=P*j[0],wt.height=X*j[1];let mt=wt.getContext("2d");mt.imageSmoothingEnabled=!1,mt.font=window.getComputedStyle(d).font,mt.textBaseline="top";for(let Gt=0;Gt<P;Gt++)for(let Ht=0;Ht<X;Ht++){let _e=4*(Ht*P+Gt),Xi=F[_e+0],Qi=F[_e+3];mt.fillStyle=r(F[_e+2]),mt.fillRect(Gt*j[0],Ht*j[1],j[0],j[1]),mt.fillStyle=r(Qi),mt.fillText(Xs[Xi],Gt*j[0],Ht*j[1])}m.style.display!=="none"&&g<X&&y<P&&(mt.fillStyle=m.style.backgroundColor,mt.fillRect(y*j[0],g*j[1]+parseInt(m.style.marginTop,10),parseInt(m.style.width,10),parseInt(m.style.height,10))),L.src=wt.toDataURL("image/png")}return L},this.put_char=function(L,j,wt,mt,Gt,Ht){L<X&&j<P&&(j=4*(L*P+j),F[j+0]=wt,F[j+1]=mt,F[j+2]=Gt,F[j+3]=Ht,C[L]=1)},this.timer=function(){Rt||requestAnimationFrame(U?Ac:Ec)};var Ec=function(){for(var L=0;L<X;L++)C[L]&&($t.text_update_row(L),C[L]=0);this.timer()}.bind(this),Ac=function(){this.bus.send("screen-fill-buffer"),this.timer()}.bind(this);this.destroy=function(){Rt=!0},this.set_mode=function(L){(U=L)?(d.style.display="none",a.style.display="block"):(d.style.display="block",a.style.display="none")},this.clear_screen=function(){p.fillStyle="#000",p.fillRect(0,0,a.width,a.height)},this.set_size_text=function(L,j){if(L!==P||j!==X){for(C=new Int8Array(j),F=new Int32Array(L*j*4),P=L,X=j;d.childNodes.length>j;)d.removeChild(d.firstChild);for(;d.childNodes.length<j;)d.appendChild(document.createElement("div"));for(L=0;L<j;L++)this.text_update_row(L);n(d,b,E,!0)}},this.set_size_graphical=function(L,j){a.style.display="block",a.width=L,a.height=j,R=640>=L&&2*L<window.innerWidth*window.devicePixelRatio&&2*j<window.innerHeight*window.devicePixelRatio?2:1,n(a,b*R,E*R,!1)},this.set_scale=function(L,j){b=L,E=j,n(d,b,E,!0),n(a,b*R,E*R,!1)},this.set_scale(b,E),this.update_cursor_scanline=function(L,j,wt){wt?(m.style.display="inline",m.style.height=j-L+"px",m.style.marginTop=L+"px"):m.style.display="none"},this.update_cursor=function(L,j){(L!==g||j!==y)&&(L<X&&(C[L]=1),g<X&&(C[g]=1),g=L,y=j)},this.text_update_row=function(L){for(var j=4*L*P,wt,mt=d.childNodes[L],Gt=document.createElement("div"),Ht=0;Ht<P;){var _e=document.createElement("span"),Xi=F[j+1],Qi=F[j+2],Sn=F[j+3];for(Xi&&_e.classList.add("blink"),_e.style.backgroundColor=r(Qi),_e.style.color=r(Sn),wt="";Ht<P&&F[j+1]===Xi&&F[j+2]===Qi&&F[j+3]===Sn;)if(wt+=Xs[F[j+0]],Ht++,j+=4,L===g){if(Ht===y)break;if(Ht===y+1){m.style.backgroundColor=_e.style.color,Gt.appendChild(m);break}}_e.textContent=wt,Gt.appendChild(_e)}mt.parentNode.replaceChild(Gt,mt)},this.update_buffer=function(L){L.forEach(j=>{p.putImageData(j.image_data,j.screen_x-j.buffer_x,j.screen_y-j.buffer_y,j.buffer_x,j.buffer_y,j.buffer_width,j.buffer_height)})},this.init()}let i=["shared","exclusive","unlock"];function s(t,e,r){this.fs=t,this.bus=r,this.configspace_tagname=[104,111,115,116,57,112],this.configspace_taglen=this.configspace_tagname.length,this.VERSION="9P2000.L",this.msize=this.BLOCKSIZE=8192,this.replybuffer=new Uint8Array(2*this.msize),this.replybuffersize=0,this.fids=[],this.virtio=new It(e,{name:"virtio-9p",pci_id:48,device_id:4169,subsystem_device_id:9,common:{initial_port:43008,queues:[{size_supported:32,notify_offset:0}],features:[0,32,29,28],on_driver_ok:()=>{}},notification:{initial_port:43264,single_handler:!1,handlers:[n=>{if(n===0){for(;this.virtqueue.has_request();)n=this.virtqueue.pop_request(),this.ReceiveRequest(n);this.virtqueue.notify_me_after(0)}}]},isr_status:{initial_port:42752},device_specific:{initial_port:42496,struct:[{bytes:2,name:"mount tag length",read:()=>this.configspace_taglen,write:()=>{}}].concat(f.range(254).map(n=>({bytes:1,name:"mount tag name "+n,read:()=>this.configspace_tagname[n]||0,write:()=>{}})))}}),this.virtqueue=this.virtio.queues[0]}s.prototype.get_state=function(){var t=[];return t[0]=this.configspace_tagname,t[1]=this.configspace_taglen,t[2]=this.virtio,t[3]=this.VERSION,t[4]=this.BLOCKSIZE,t[5]=this.msize,t[6]=this.replybuffer,t[7]=this.replybuffersize,t[8]=this.fids.map(function(e){return[e.inodeid,e.type,e.uid,e.dbg_name]}),t[9]=this.fs,t},s.prototype.set_state=function(t){this.configspace_tagname=t[0],this.configspace_taglen=t[1],this.virtio.set_state(t[2]),this.virtqueue=this.virtio.queues[0],this.VERSION=t[3],this.BLOCKSIZE=t[4],this.msize=t[5],this.replybuffer=t[6],this.replybuffersize=t[7],this.fids=t[8].map(function(e){return{inodeid:e[0],type:e[1],uid:e[2],dbg_name:e[3]}}),this.fs.set_state(t[9])},s.prototype.Createfid=function(t,e,r,n){return{inodeid:t,type:e,uid:r,dbg_name:n}},s.prototype.update_dbg_name=function(t,e){for(let r of this.fids)r.inodeid===t&&(r.dbg_name=e)},s.prototype.reset=function(){this.fids=[],this.virtio.reset()},s.prototype.BuildReply=function(t,e,r){H.Marshall(["w","b","h"],[r+7,t+1,e],this.replybuffer,0),r+7>=this.replybuffer.length&&Q.Debug("Error in 9p: payloadsize exceeds maximum length"),this.replybuffersize=r+7},s.prototype.SendError=function(t,e,r){e=H.Marshall(["w"],[r],this.replybuffer,7),this.BuildReply(6,t,e)},s.prototype.SendReply=function(t){t.set_next_blob(this.replybuffer.subarray(0,this.replybuffersize)),this.virtqueue.push_reply(t),this.virtqueue.flush_replies()},s.prototype.ReceiveRequest=async function(t){var e=new Uint8Array(t.length_readable);t.get_next_blob(e);var r={offset:0},n=H.Unmarshall(["w","b","h"],e,r),a=n[0],p=n[1],d=n[2];switch(p){case 8:a=this.fs.GetTotalSize(),e=this.fs.GetSpace(),n=[16914839],n[1]=this.BLOCKSIZE,n[2]=Math.floor(e/n[1]),n[3]=n[2]-Math.floor(a/n[1]),n[4]=n[2]-Math.floor(a/n[1]),n[5]=this.fs.CountUsedInodes(),n[6]=this.fs.CountFreeInodes(),n[7]=0,n[8]=256,a=H.Marshall("wwddddddw".split(""),n,this.replybuffer,7),this.BuildReply(p,d,a),this.SendReply(t);break;case 112:case 12:n=H.Unmarshall(["w","w"],e,r);var m=n[0];r=n[1],Q.Debug("[open] fid="+m+", mode="+r),e=this.fids[m].inodeid;var g=this.fs.GetInode(e);Q.Debug("file open "+this.fids[m].dbg_name),a=this.fs.OpenInode(e,r),this.fs.AddEvent(this.fids[m].inodeid,function(){Q.Debug("file opened "+this.fids[m].dbg_name+" tag:"+d);var R=[];R[0]=g.qid,R[1]=this.msize-24,H.Marshall(["Q","w"],R,this.replybuffer,7),this.BuildReply(p,d,17),this.SendReply(t)}.bind(this));break;case 70:if(n=H.Unmarshall(["w","w","s"],e,r),e=n[0],m=n[1],a=n[2],Q.Debug("[link] dfid="+e+", name="+a),a=this.fs.Link(this.fids[e].inodeid,this.fids[m].inodeid,a),0>a){this.SendError(d,a===-1?"Operation not permitted":"Unknown error: "+-a,-a),this.SendReply(t);break}this.BuildReply(p,d,0),this.SendReply(t);break;case 16:n=H.Unmarshall(["w","s","s","w"],e,r),m=n[0],a=n[1],e=n[2],n=n[3],Q.Debug("[symlink] fid="+m+", name="+a+", symgt="+e+", gid="+n),e=this.fs.CreateSymlink(a,this.fids[m].inodeid,e),g=this.fs.GetInode(e),g.uid=this.fids[m].uid,g.gid=n,H.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(p,d,13),this.SendReply(t);break;case 18:n=H.Unmarshall("wswwww".split(""),e,r),m=n[0],a=n[1],r=n[2],e=n[3];var y=n[4];n=n[5],Q.Debug("[mknod] fid="+m+", name="+a+", major="+e+", minor="+y),e=this.fs.CreateNode(a,this.fids[m].inodeid,e,y),g=this.fs.GetInode(e),g.mode=r,g.uid=this.fids[m].uid,g.gid=n,H.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(p,d,13),this.SendReply(t);break;case 22:n=H.Unmarshall(["w"],e,r),m=n[0],g=this.fs.GetInode(this.fids[m].inodeid),Q.Debug("[readlink] fid="+m+" name="+this.fids[m].dbg_name+" target="+g.symlink),a=H.Marshall(["s"],[g.symlink],this.replybuffer,7),this.BuildReply(p,d,a),this.SendReply(t);break;case 72:n=H.Unmarshall(["w","s","w","w"],e,r),m=n[0],a=n[1],r=n[2],n=n[3],Q.Debug("[mkdir] fid="+m+", name="+a+", mode="+r+", gid="+n),e=this.fs.CreateDirectory(a,this.fids[m].inodeid),g=this.fs.GetInode(e),g.mode=r|ee,g.uid=this.fids[m].uid,g.gid=n,H.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(p,d,13),this.SendReply(t);break;case 14:n=H.Unmarshall(["w","s","w","w","w"],e,r),m=n[0],a=n[1],e=n[2],r=n[3],n=n[4],this.bus.send("9p-create",[a,this.fids[m].inodeid]),Q.Debug("[create] fid="+m+", name="+a+", flags="+e+", mode="+r+", gid="+n),e=this.fs.CreateFile(a,this.fids[m].inodeid),this.fids[m].inodeid=e,this.fids[m].type=1,this.fids[m].dbg_name=a,g=this.fs.GetInode(e),g.uid=this.fids[m].uid,g.gid=n,g.mode=r|Fe,H.Marshall(["Q","w"],[g.qid,this.msize-24],this.replybuffer,7),this.BuildReply(p,d,17),this.SendReply(t);break;case 52:n=H.Unmarshall("wbwddws".split(""),e,r),m=n[0],e=n[2],a=n[4]===0?1/0:n[4],n=this.fs.DescribeLock(n[1],n[3],a,n[5],n[6]),Q.Debug("[lock] fid="+m+", type="+i[n.type]+", start="+n.start+", length="+n.length+", proc_id="+n.proc_id),a=this.fs.Lock(this.fids[m].inodeid,n,e),H.Marshall(["b"],[a],this.replybuffer,7),this.BuildReply(p,d,1),this.SendReply(t);break;case 54:n=H.Unmarshall("wbddws".split(""),e,r),m=n[0],a=n[3]===0?1/0:n[3],n=this.fs.DescribeLock(n[1],n[2],a,n[4],n[5]),Q.Debug("[getlock] fid="+m+", type="+i[n.type]+", start="+n.start+", length="+n.length+", proc_id="+n.proc_id),a=this.fs.GetLock(this.fids[m].inodeid,n),a||(a=n,a.type=2),a=H.Marshall(["b","d","d","w","s"],[a.type,a.start,a.length===1/0?0:a.length,a.proc_id,a.client_id],this.replybuffer,7),this.BuildReply(p,d,a),this.SendReply(t);break;case 24:if(n=H.Unmarshall(["w","d"],e,r),m=n[0],g=this.fs.GetInode(this.fids[m].inodeid),Q.Debug("[getattr]: fid="+m+" name="+this.fids[m].dbg_name+" request mask="+n[1]),!g||g.status===Ji){Q.Debug("getattr: unlinked"),this.SendError(d,"No such file or directory",2),this.SendReply(t);break}n[0]=n[1],n[1]=g.qid,n[2]=g.mode,n[3]=g.uid,n[4]=g.gid,n[5]=g.nlinks,n[6]=g.major<<8|g.minor,n[7]=g.size,n[8]=this.BLOCKSIZE,n[9]=Math.floor(g.size/512+1),n[10]=g.atime,n[11]=0,n[12]=g.mtime,n[13]=0,n[14]=g.ctime,n[15]=0,n[16]=0,n[17]=0,n[18]=0,n[19]=0,H.Marshall("dQwwwddddddddddddddd".split(""),n,this.replybuffer,7),this.BuildReply(p,d,153),this.SendReply(t);break;case 26:n=H.Unmarshall("wwwwwddddd".split(""),e,r),m=n[0],g=this.fs.GetInode(this.fids[m].inodeid),Q.Debug("[setattr]: fid="+m+" request mask="+n[1]+" name="+this.fids[m].dbg_name),n[1]&1&&(g.mode=n[2]),n[1]&2&&(g.uid=n[3]),n[1]&4&&(g.gid=n[4]),n[1]&16&&(g.atime=Math.floor(new Date().getTime()/1e3)),n[1]&32&&(g.mtime=Math.floor(new Date().getTime()/1e3)),n[1]&64&&(g.ctime=Math.floor(new Date().getTime()/1e3)),n[1]&128&&(g.atime=n[6]),n[1]&256&&(g.mtime=n[8]),n[1]&8&&await this.fs.ChangeSize(this.fids[m].inodeid,n[5]),this.BuildReply(p,d,0),this.SendReply(t);break;case 50:n=H.Unmarshall(["w","d"],e,r),m=n[0],this.BuildReply(p,d,0),this.SendReply(t);break;case 40:case 116:if(n=H.Unmarshall(["w","d","w"],e,r),m=n[0],a=n[1],y=n[2],g=this.fs.GetInode(this.fids[m].inodeid),p===40&&Q.Debug("[treaddir]: fid="+m+" offset="+a+" count="+y),p===116&&Q.Debug("[read]: fid="+m+" ("+this.fids[m].dbg_name+") offset="+a+" count="+y+" fidtype="+this.fids[m].type),!g||g.status===Ji){Q.Debug("read/treaddir: unlinked"),this.SendError(d,"No such file or directory",2),this.SendReply(t);break}if(this.fids[m].type===2)for(g.caps.length<a+y&&(y=g.caps.length-a),n=0;n<y;n++)this.replybuffer[11+n]=g.caps[a+n];else this.fs.OpenInode(this.fids[m].inodeid,void 0),n=this.fids[m].inodeid,y=Math.min(y,this.replybuffer.length-11),g.size<a+y?y=g.size-a:p===40&&(y=this.fs.RoundToDirentry(n,a+y)-a),a>g.size&&(y=0),this.bus.send("9p-read-start",[this.fids[m].dbg_name]),n=await this.fs.Read(n,a,y),this.bus.send("9p-read-end",[this.fids[m].dbg_name,y]),n&&this.replybuffer.set(n,11);H.Marshall(["w"],[y],this.replybuffer,7),this.BuildReply(p,d,4+y),this.SendReply(t);break;case 118:if(n=H.Unmarshall(["w","d","w"],e,r),m=n[0],a=n[1],y=n[2],n=this.fids[m].dbg_name,Q.Debug("[write]: fid="+m+" ("+n+") offset="+a+" count="+y+" fidtype="+this.fids[m].type),this.fids[m].type===2){this.SendError(d,"Setxattr not supported",95),this.SendReply(t);break}else await this.fs.Write(this.fids[m].inodeid,a,y,e.subarray(r.offset));this.bus.send("9p-write-end",[n,y]),H.Marshall(["w"],[y],this.replybuffer,7),this.BuildReply(p,d,4),this.SendReply(t);break;case 74:if(n=H.Unmarshall(["w","s","w","s"],e,r),a=n[0],e=n[1],r=n[2],n=n[3],Q.Debug("[renameat]: oldname="+e+" newname="+n),a=await this.fs.Rename(this.fids[a].inodeid,e,this.fids[r].inodeid,n),0>a){this.SendError(d,a===-2?"No such file or directory":a===-1?"Operation not permitted":a===-39?"Directory not empty":"Unknown error: "+-a,-a),this.SendReply(t);break}this.BuildReply(p,d,0),this.SendReply(t);break;case 76:if(n=H.Unmarshall(["w","s","w"],e,r),r=n[0],a=n[1],e=n[2],Q.Debug("[unlink]: dirfd="+r+" name="+a+" flags="+e),m=this.fs.Search(this.fids[r].inodeid,a),m===-1){this.SendError(d,"No such file or directory",2),this.SendReply(t);break}if(a=this.fs.Unlink(this.fids[r].inodeid,a),0>a){this.SendError(d,a===-39?"Directory not empty":a===-1?"Operation not permitted":"Unknown error: "+-a,-a),this.SendReply(t);break}this.BuildReply(p,d,0),this.SendReply(t);break;case 100:n=H.Unmarshall(["w","s"],e,r),Q.Debug("[version]: msize="+n[0]+" version="+n[1]),this.msize!==n[0]&&(this.msize=n[0],this.replybuffer=new Uint8Array(Math.min(16777216,2*this.msize))),a=H.Marshall(["w","s"],[this.msize,this.VERSION],this.replybuffer,7),this.BuildReply(p,d,a),this.SendReply(t);break;case 104:n=H.Unmarshall(["w","w","s","s","w"],e,r),m=n[0],a=n[4],Q.Debug("[attach]: fid="+m+" afid="+u(n[1])+" uname="+n[2]+" aname="+n[3]),this.fids[m]=this.Createfid(0,1,a,""),g=this.fs.GetInode(this.fids[m].inodeid),H.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(p,d,13),this.SendReply(t),this.bus.send("9p-attach");break;case 108:n=H.Unmarshall(["h"],e,r),Q.Debug("[flush] "+d),this.BuildReply(p,d,0),this.SendReply(t);break;case 110:n=H.Unmarshall(["w","w","h"],e,r),m=n[0],y=n[1];var b=n[2];if(Q.Debug("[walk]: fid="+n[0]+" nwfid="+n[1]+" nwname="+b),b===0){this.fids[y]=this.Createfid(this.fids[m].inodeid,1,this.fids[m].uid,this.fids[m].dbg_name),H.Marshall(["h"],[0],this.replybuffer,7),this.BuildReply(p,d,2),this.SendReply(t);break}for(a=[],n=0;n<b;n++)a.push("s");r=H.Unmarshall(a,e,r),e=this.fids[m].inodeid,a=9;var E=0;for(Q.Debug("walk in dir "+this.fids[m].dbg_name+" to: "+r.toString()),n=0;n<b;n++){if(e=this.fs.Search(e,r[n]),e===-1){Q.Debug("Could not find: "+r[n]);break}a+=H.Marshall(["Q"],[this.fs.GetInode(e).qid],this.replybuffer,a),E++,this.fids[y]=this.Createfid(e,1,this.fids[m].uid,r[n])}H.Marshall(["h"],[E],this.replybuffer,7),this.BuildReply(p,d,a-7),this.SendReply(t);break;case 120:n=H.Unmarshall(["w"],e,r),Q.Debug("[clunk]: fid="+n[0]),this.fids[n[0]]&&0<=this.fids[n[0]].inodeid&&(await this.fs.CloseInode(this.fids[n[0]].inodeid),this.fids[n[0]].inodeid=-1,this.fids[n[0]].type=-1),this.BuildReply(p,d,0),this.SendReply(t);break;case 32:n=H.Unmarshall(["w","s","d","w"],e,r),m=n[0],a=n[1],r=n[2],e=n[3],Q.Debug("[txattrcreate]: fid="+m+" name="+a+" attr_size="+r+" flags="+e),this.fids[m].type=2,this.BuildReply(p,d,0),this.SendReply(t);break;case 30:n=H.Unmarshall(["w","w","s"],e,r),m=n[0],a=n[2],Q.Debug("[xattrwalk]: fid="+n[0]+" newfid="+n[1]+" name="+n[2]),this.SendError(d,"Setxattr not supported",95),this.SendReply(t);break;default:Q.Debug("Error in Virtio9p: Unknown id "+p+" received"),Q.Abort()}};function h(t){this.ports=[],this.cpu=t;for(var e=0;65536>e;e++)this.ports[e]=this.create_empty_entry();var r=t.memory_size[0];for(e=0;e<<17<r;e++)t.memory_map_read8[e]=t.memory_map_write8[e]=void 0,t.memory_map_read32[e]=t.memory_map_write32[e]=void 0;this.mmap_register(r,4294967296-r,function(n){return u(n>>>0,8),255},function(n,a){u(n>>>0,8),u(a,2)},function(n){return u(n>>>0,8),-1},function(n,a){u(n>>>0,8),u(a>>>0,8)})}h.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}},h.prototype.empty_port_read8=function(){return 255},h.prototype.empty_port_read16=function(){return 65535},h.prototype.empty_port_read32=function(){return-1},h.prototype.empty_port_write=function(){},h.prototype.register_read=function(t,e,r,n,a){r&&(this.ports[t].read8=r),n&&(this.ports[t].read16=n),a&&(this.ports[t].read32=a),this.ports[t].device=e},h.prototype.register_write=function(t,e,r,n,a){r&&(this.ports[t].write8=r),n&&(this.ports[t].write16=n),a&&(this.ports[t].write32=a),this.ports[t].device=e},h.prototype.register_read_consecutive=function(t,e,r,n,a,p){function d(){return r.call(this)|n.call(this)<<8}function m(){return a.call(this)|p.call(this)<<8}function g(){return r.call(this)|n.call(this)<<8|a.call(this)<<16|p.call(this)<<24}a&&p?(this.register_read(t,e,r,d,g),this.register_read(t+1,e,n),this.register_read(t+2,e,a,m),this.register_read(t+3,e,p)):(this.register_read(t,e,r,d),this.register_read(t+1,e,n))},h.prototype.register_write_consecutive=function(t,e,r,n,a,p){function d(y){r.call(this,y&255),n.call(this,y>>8&255)}function m(y){a.call(this,y&255),p.call(this,y>>8&255)}function g(y){r.call(this,y&255),n.call(this,y>>8&255),a.call(this,y>>16&255),p.call(this,y>>>24)}a&&p?(this.register_write(t,e,r,d,g),this.register_write(t+1,e,n),this.register_write(t+2,e,a,m),this.register_write(t+3,e,p)):(this.register_write(t,e,r,d),this.register_write(t+1,e,n))},h.prototype.mmap_read32_shim=function(t){var e=this.cpu.memory_map_read8[t>>>17];return e(t)|e(t+1)<<8|e(t+2)<<16|e(t+3)<<24},h.prototype.mmap_write32_shim=function(t,e){var r=this.cpu.memory_map_write8[t>>>17];r(t,e&255),r(t+1,e>>8&255),r(t+2,e>>16&255),r(t+3,e>>>24)},h.prototype.mmap_register=function(t,e,r,n,a,p){for(u(t>>>0,8),u(e,8),a||(a=this.mmap_read32_shim.bind(this)),p||(p=this.mmap_write32_shim.bind(this)),t>>>=17;0<e;t++)this.cpu.memory_map_read8[t]=r,this.cpu.memory_map_write8[t]=n,this.cpu.memory_map_read32[t]=a,this.cpu.memory_map_write32[t]=p,e-=131072},h.prototype.port_write8=function(t,e){var r=this.ports[t];return r.write8===this.empty_port_write&&(u(t,4),u(e,2),this.get_port_description(t)),r.write8.call(r.device,e)},h.prototype.port_write16=function(t,e){var r=this.ports[t];return r.write16===this.empty_port_write&&(u(t,4),u(e,4),this.get_port_description(t)),r.write16.call(r.device,e)},h.prototype.port_write32=function(t,e){var r=this.ports[t];return r.write32===this.empty_port_write&&(u(t,4),u(e>>>0,8),this.get_port_description(t)),r.write32.call(r.device,e)},h.prototype.port_read8=function(t){var e=this.ports[t];return e.read8===this.empty_port_read8&&(u(t,4),this.get_port_description(t)),e=e.read8.call(e.device),u(t),e},h.prototype.port_read16=function(t){var e=this.ports[t];return e.read16===this.empty_port_read16&&(u(t,4),this.get_port_description(t)),e=e.read16.call(e.device),u(t),e},h.prototype.port_read32=function(t){var e=this.ports[t];return e.read32===this.empty_port_read32&&(u(t,4),this.get_port_description(t)),e.read32.call(e.device)};var c={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1e3:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};h.prototype.get_port_description=function(t){return c[t]?"  ("+c[t]+")":""};function _(t,e){this.stopping=this.running=!1,this.idle=!0,this.tick_counter=0,this.worker=null,this.cpu=new V(t,e,()=>{this.idle&&this.next_tick(0)}),this.bus=t,t.register("cpu-init",this.init,this),t.register("cpu-run",this.run,this),t.register("cpu-stop",this.stop,this),t.register("cpu-restart",this.restart,this),this.register_yield()}if(_.prototype.run=function(){this.stopping=!1,this.running||(this.running=!0,this.bus.send("emulator-started")),this.next_tick(0)},_.prototype.do_tick=function(){if(this.stopping||!this.running)this.stopping=this.running=!1,this.bus.send("emulator-stopped");else{this.idle=!1;var t=this.cpu.main_loop();this.next_tick(t)}},_.prototype.next_tick=function(t){let e=++this.tick_counter;this.idle=!0,this.yield(t,e)},_.prototype.yield_callback=function(t){t===this.tick_counter&&this.do_tick()},_.prototype.stop=function(){this.running&&(this.stopping=!0)},_.prototype.destroy=function(){this.unregister_yield()},_.prototype.restart=function(){this.cpu.reset_cpu(),this.cpu.load_bios()},_.prototype.init=function(t){this.cpu.init(t,this.bus),this.bus.send("emulator-ready")},typeof process<"u")_.prototype.yield=function(t,e){typeof Bun>"u"&&(1>t?global.setImmediate(r=>this.yield_callback(r),e):setTimeout(r=>this.yield_callback(r),t,e))},_.prototype.register_yield=function(){},_.prototype.unregister_yield=function(){};else if(typeof Worker<"u"){let t=function(){let e;globalThis.onmessage=function(r){let n=r.data.t;e=e&&clearTimeout(e),1>n?postMessage(r.data.tick):e=setTimeout(()=>postMessage(r.data.tick),n)}};_.prototype.register_yield=function(){let e=URL.createObjectURL(new Blob(["("+t.toString()+")()"],{type:"text/javascript"}));this.worker=new Worker(e),this.worker.onmessage=r=>this.yield_callback(r.data),URL.revokeObjectURL(e)},_.prototype.yield=function(e,r){this.worker.postMessage({t:e,tick:r})},_.prototype.unregister_yield=function(){this.worker&&this.worker.terminate(),this.worker=null}}else _.prototype.yield=function(t){setTimeout(()=>{this.do_tick()},t)},_.prototype.register_yield=function(){},_.prototype.unregister_yield=function(){};if(_.prototype.save_state=function(){return this.cpu.save_state()},_.prototype.restore_state=function(t){return this.cpu.restore_state(t)},typeof performance=="object"&&performance.now)_.microtick=performance.now.bind(performance);else if(typeof st=="function"){let{performance:t}=st("perf_hooks");_.microtick=t.now.bind(t)}else _.microtick=typeof process=="object"&&process.hrtime?function(){var t=process.hrtime();return 1e3*t[0]+t[1]/1e6}:Date.now;var l=l||{};l.exportSymbol=function(){},l.exportProperty=function(){};var f=f||{};f.pads=function(t,e){return(t||t===0?t+"":"").padEnd(e," ")},f.pad0=function(t,e){return(t||t===0?t+"":"").padStart(e,"0")},f.zeros=function(t){return Array(t).fill(0)},f.range=function(t){return Array.from(Array(t).keys())},f.view=function(t,e,r,n){return new Proxy({},{get:function(a,p){a=new t(e.buffer,r,n);let d=a[p];return typeof d=="function"?d.bind(a):(/^\d+$/.test(p),d)},set:function(a,p,d){return/^\d+$/.test(p),new t(e.buffer,r,n)[p]=d,!0}})};function u(t,e){return t=t?t.toString(16):"","0x"+f.pad0(t.toUpperCase(),e||1)}if(typeof crypto<"u"&&crypto.getRandomValues){let t=new Int32Array(1);f.get_rand_int=function(){return crypto.getRandomValues(t),t[0]}}else if(typeof st<"u"){let t=st("crypto");f.get_rand_int=function(){return t.randomBytes(4).readInt32LE(0)}}(function(){if(typeof Math.clz32=="function")f.int_log2_byte=function(n){return 31-Math.clz32(n)},f.int_log2=function(n){return 31-Math.clz32(n)};else{for(var t=new Int8Array(256),e=0,r=-2;256>e;e++)e&e-1||r++,t[e]=r;f.int_log2_byte=function(n){return t[n]},f.int_log2=function(n){n>>>=0;var a=n>>>16;if(a){var p=a>>>8;return p?24+t[p]:16+t[a]}return(p=n>>>8)?8+t[p]:t[n]}}})();function w(t){var e=new Uint8Array(t),r,n;this.length=0,this.push=function(a){this.length!==t&&this.length++,e[n]=a,n=n+1&t-1},this.shift=function(){if(this.length){var a=e[r];return r=r+1&t-1,this.length--,a}return-1},this.peek=function(){return this.length?e[r]:-1},this.clear=function(){this.length=n=r=0},this.clear()}function v(t){this.size=t,this.data=new Float32Array(t),this.length=this.end=this.start=0}v.prototype.push=function(t){this.length===this.size?this.start=this.start+1&this.size-1:this.length++,this.data[this.end]=t,this.end=this.end+1&this.size-1},v.prototype.shift=function(){if(this.length){var t=this.data[this.start];return this.start=this.start+1&this.size-1,this.length--,t}},v.prototype.shift_block=function(t){var e=new Float32Array(t);t>this.length&&(t=this.length);var r=this.start+t,n=this.data.subarray(this.start,r);return e.set(n),r>=this.size&&(r-=this.size,e.set(this.data.subarray(0,r),n.length)),this.start=r,this.length-=t,e},v.prototype.peek=function(){if(this.length)return this.data[this.start]},v.prototype.clear=function(){this.length=this.end=this.start=0},f.Bitmap=function(t){typeof t=="number"?this.view=new Uint8Array(t+7>>3):t instanceof ArrayBuffer&&(this.view=new Uint8Array(t))},f.Bitmap.prototype.set=function(t,e){let r=t>>3;t=1<<(t&7),this.view[r]=e?this.view[r]|t:this.view[r]&~t},f.Bitmap.prototype.get=function(t){return this.view[t>>3]>>(t&7)&1},f.Bitmap.prototype.get_buffer=function(){return this.view.buffer},f.load_file=typeof XMLHttpRequest>"u"?S:k;function k(t,e,r){function n(){let g=r||0;setTimeout(()=>{k(t,e,g+1)},1e3*([1,1,2,3,5,8,13,21][g]||34))}var a=new XMLHttpRequest;if(a.open(e.method||"get",t,!0),a.responseType=e.as_json?"json":"arraybuffer",e.headers)for(var p=Object.keys(e.headers),d=0;d<p.length;d++){var m=p[d];a.setRequestHeader(m,e.headers[m])}e.range&&(p=e.range.start,a.setRequestHeader("Range","bytes="+p+"-"+(p+e.range.length-1)),a.setRequestHeader("X-Accept-Encoding","identity"),a.onreadystatechange=function(){a.status===200&&a.abort()}),a.onload=function(){if(a.readyState===4){if(a.status!==200&&a.status!==206)console.error("Loading the image "+t+" failed (status %d)",a.status),500<=a.status&&600>a.status&&n();else if(a.response){if(e.range){let g=a.getResponseHeader("Content-Encoding");g&&g!=="identity"&&console.error("Server sent Content-Encoding in response to ranged request",{filename:t,enc:g})}e.done&&e.done(a.response,a)}}},a.onerror=function(g){console.error("Loading the image "+t+" failed",g),n()},e.progress&&(a.onprogress=function(g){e.progress(g)}),a.send(null)}function S(t,e){let r=st("fs");e.range?r.open(t,"r",(n,a)=>{if(n)throw n;n=e.range.length;var p=Buffer.allocUnsafe(n);r.read(a,p,0,n,e.range.start,d=>{if(d)throw d;e.done&&e.done(new Uint8Array(p)),r.close(a,m=>{if(m)throw m})})}):r.readFile(t,{encoding:e.as_json?"utf-8":null},function(n,a){n?console.log("Could not read file:",t,n):(n=a,n=e.as_json?JSON.parse(n):new Uint8Array(n).buffer,e.done(n))})}f.read_sized_string_from_mem=function(t,e,r){return String.fromCharCode(...new Uint8Array(t.buffer,e>>>0,r>>>0))},function(){function t(d){this.buffer=d,this.byteLength=d.byteLength,this.onprogress=this.onload=void 0}function e(d,m,g){this.filename=d,this.byteLength=m,this.block_cache=new Map,this.block_cache_is_write=new Set,this.fixed_chunk_size=g,this.cache_reads=!!g,this.onprogress=this.onload=void 0}function r(d,m,g,y,b){let E=d.match(/\.[^\.]+(\.zst)?$/);this.extension=E?E[0]:"",this.basename=d.substring(0,d.length-this.extension.length),this.is_zstd=this.extension.endsWith(".zst"),this.basename.endsWith("/")||(this.basename+="-"),this.block_cache=new Map,this.block_cache_is_write=new Set,this.byteLength=m,this.fixed_chunk_size=g,this.partfile_alt_format=!!y,this.zstd_decompress=b,this.cache_reads=!!g,this.onprogress=this.onload=void 0}function n(d){this.file=d,this.byteLength=d.size,1073741824<d.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(d.size>>20)+" MB ..."),this.buffer=new ArrayBuffer(d.size),this.onprogress=this.onload=void 0}function a(d){this.file=d,this.byteLength=d.size,this.block_cache=new Map,this.block_cache_is_write=new Set,this.onprogress=this.onload=void 0}f.SyncBuffer=t,f.AsyncXHRBuffer=e,f.AsyncXHRPartfileBuffer=r,f.AsyncFileBuffer=a,f.SyncFileBuffer=n,f.buffer_from_object=function(d,m){if(d.buffer instanceof ArrayBuffer)return new f.SyncBuffer(d.buffer);if(typeof File<"u"&&d.buffer instanceof File)return m=d.async,m===void 0&&(m=268435456<=d.buffer.size),m?new f.AsyncFileBuffer(d.buffer):new f.SyncFileBuffer(d.buffer);if(d.url)return d.use_parts?new f.AsyncXHRPartfileBuffer(d.url,d.size,d.fixed_chunk_size,!1,m):new f.AsyncXHRBuffer(d.url,d.size,d.fixed_chunk_size)},t.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})},t.prototype.get=function(d,m,g){g(new Uint8Array(this.buffer,d,m))},t.prototype.set=function(d,m,g){new Uint8Array(this.buffer,d,m.byteLength).set(m),g()},t.prototype.get_buffer=function(d){d(this.buffer)},t.prototype.get_state=function(){let d=[];return d[0]=this.byteLength,d[1]=new Uint8Array(this.buffer),d},t.prototype.set_state=function(d){this.byteLength=d[0],this.buffer=d[1].slice().buffer},e.prototype.load=function(){this.byteLength!==void 0?this.onload&&this.onload(Object.create(null)):p(this.filename,(d,m)=>{if(d)throw Error("Cannot use: "+this.filename+". "+d);this.byteLength=m,this.onload&&this.onload(Object.create(null))})},e.prototype.get_from_cache=function(d,m){var g=m/256;d/=256;for(var y=0;y<g;y++)if(!this.block_cache.get(d+y))return;if(g===1)return this.block_cache.get(d);for(m=new Uint8Array(m),y=0;y<g;y++)m.set(this.block_cache.get(d+y),256*y);return m},e.prototype.get=function(d,m,g){var y=this.get_from_cache(d,m);if(y)g(y);else{var b=d,E=m;this.fixed_chunk_size&&(b=d-d%this.fixed_chunk_size,E=Math.ceil((d-b+m)/this.fixed_chunk_size)*this.fixed_chunk_size),f.load_file(this.filename,{done:function(R){R=new Uint8Array(R),this.handle_read(b,E,R),g(b===d&&E===m?R:R.subarray(d-b,d-b+m))}.bind(this),range:{start:b,length:E}})}},e.prototype.set=function(d,m,g){d/=256;for(var y=m.length/256,b=0;b<y;b++){var E=this.block_cache.get(d+b);if(E===void 0)E=m.slice(256*b,256*(b+1)),this.block_cache.set(d+b,E);else{let R=m.subarray(256*b,256*(b+1));E.set(R)}this.block_cache_is_write.add(d+b)}g()},e.prototype.handle_read=function(d,m,g){d/=256,m/=256;for(var y=0;y<m;y++){let b=this.block_cache.get(d+y);b?g.set(b,256*y):this.cache_reads&&this.block_cache.set(d+y,g.slice(256*y,256*(y+1)))}},e.prototype.get_buffer=function(d){d()},e.prototype.get_state=function(){let d=[],m=[];for(let[g,y]of this.block_cache)isFinite(g),this.block_cache_is_write.has(g)&&m.push([g,y]);return d[0]=m,d},e.prototype.set_state=function(d){d=d[0],this.block_cache.clear(),this.block_cache_is_write.clear();for(let[m,g]of d)isFinite(m),this.block_cache.set(m,g),this.block_cache_is_write.add(m)},r.prototype.load=function(){this.onload&&this.onload(Object.create(null))},r.prototype.get=function(d,m,g){var y=this.get_from_cache(d,m);if(y)g(y);else if(this.fixed_chunk_size){let E=Math.floor(d/this.fixed_chunk_size),R=d-E*this.fixed_chunk_size,C=Math.ceil((R+m)/this.fixed_chunk_size),U=new Uint8Array(C*this.fixed_chunk_size),F=0;for(let P=0;P<C;P++){var b=(E+P)*this.fixed_chunk_size;y=this.partfile_alt_format?this.basename+(E+P+"").padStart(8,"0")+this.extension:this.basename+b+"-"+(b+this.fixed_chunk_size)+this.extension,(b=this.get_from_cache(b,this.fixed_chunk_size))?(U.set(b,P*this.fixed_chunk_size),F++,F===C&&g(U.subarray(R,R+m))):f.load_file(y,{done:async function(X){X=new Uint8Array(X),this.is_zstd&&(X=await this.zstd_decompress(this.fixed_chunk_size,X),X=new Uint8Array(X)),U.set(X,P*this.fixed_chunk_size),this.handle_read((E+P)*this.fixed_chunk_size,this.fixed_chunk_size|0,X),F++,F===C&&g(U.subarray(R,R+m))}.bind(this)})}}else f.load_file(this.basename+d+"-"+(d+m)+this.extension,{done:function(E){E=new Uint8Array(E),this.handle_read(d,m,E),g(E)}.bind(this)})},r.prototype.get_from_cache=e.prototype.get_from_cache,r.prototype.set=e.prototype.set,r.prototype.handle_read=e.prototype.handle_read,r.prototype.get_state=e.prototype.get_state,r.prototype.set_state=e.prototype.set_state,n.prototype.load=function(){this.load_next(0)},n.prototype.load_next=function(d){var m=new FileReader;if(m.onload=function(y){y=new Uint8Array(y.target.result),new Uint8Array(this.buffer,d).set(y),this.load_next(d+4194304)}.bind(this),this.onprogress&&this.onprogress({loaded:d,total:this.byteLength,lengthComputable:!0}),d<this.byteLength){var g=this.file.slice(d,Math.min(d+4194304,this.byteLength));m.readAsArrayBuffer(g)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})},n.prototype.get=t.prototype.get,n.prototype.set=t.prototype.set,n.prototype.get_buffer=t.prototype.get_buffer,n.prototype.get_state=t.prototype.get_state,n.prototype.set_state=t.prototype.set_state,a.prototype.load=function(){this.onload&&this.onload(Object.create(null))},a.prototype.get=function(d,m,g){var y=this.get_from_cache(d,m);y?g(y):(y=new FileReader,y.onload=function(b){b=new Uint8Array(b.target.result),this.handle_read(d,m,b),g(b)}.bind(this),y.readAsArrayBuffer(this.file.slice(d,d+m)))},a.prototype.get_from_cache=e.prototype.get_from_cache,a.prototype.set=e.prototype.set,a.prototype.handle_read=e.prototype.handle_read,a.prototype.get_state=e.prototype.get_state,a.prototype.set_state=e.prototype.set_state,a.prototype.get_buffer=function(d){d()},a.prototype.get_as_file=function(d){for(var m=[],g=Array.from(this.block_cache.keys()).sort(function(C,U){return C-U}),y=0,b=0;b<g.length;b++){var E=g[b],R=this.block_cache.get(E);E*=256,E!==y&&(m.push(this.file.slice(y,E)),y=E),m.push(R),y+=R.length}return y!==this.file.size&&m.push(this.file.slice(y)),new File(m,d)};var p=typeof XMLHttpRequest>"u"?function(d,m){st("fs").stat(d,(g,y)=>{g?m(g):m(null,y.size)})}:function(d,m){f.load_file(d,{done:(g,y)=>{g=y.getResponseHeader("Content-Range")||"",(y=g.match(/\/(\d+)\s*$/))?m(null,+y[1]):m("`Range: bytes=...` header not supported (Got `"+g+"`)")},headers:{Range:"bytes=0-0","X-Accept-Encoding":"identity"}})}}();function x(t,e,r,n,a,p){this.master=new A(this,t,e,n,a,0,p),this.slave=new A(this,t,r,!1,a,1,p),this.current_interface=this.master,this.cpu=t,a===0?(this.ata_port=496,this.irq=14,this.pci_id=240):a===1&&(this.ata_port=368,this.irq=15,this.pci_id=248),this.ata_port_high=this.ata_port|516,this.master_port=46080,this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,this.ata_port&255|1,this.ata_port>>8,0,0,this.ata_port_high&255|1,this.ata_port_high>>8,0,0,0,0,0,0,0,0,0,0,this.master_port&255|1,this.master_port>>8,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,this.irq,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_bars=[{size:8},{size:4},void 0,void 0,{size:16}],this.name="ide"+a,this.device_control=2,t.io.register_read(this.ata_port|7,this,function(){return this.cpu.device_lower_irq(this.irq),this.read_status()}),t.io.register_read(this.ata_port_high|2,this,this.read_status),t.io.register_write(this.ata_port_high|2,this,this.write_control),t.io.register_read(this.ata_port|0,this,function(){return this.current_interface.read_data(1)},function(){return this.current_interface.read_data(2)},function(){return this.current_interface.read_data(4)}),t.io.register_read(this.ata_port|1,this,function(){return u(this.current_interface.error&255),this.current_interface.error&255}),t.io.register_read(this.ata_port|2,this,function(){return u(this.current_interface.bytecount&255),this.current_interface.bytecount&255}),t.io.register_read(this.ata_port|3,this,function(){return u(this.current_interface.sector&255),this.current_interface.sector&255}),t.io.register_read(this.ata_port|4,this,function(){return u(this.current_interface.cylinder_low&255),this.current_interface.cylinder_low&255}),t.io.register_read(this.ata_port|5,this,function(){return u(this.current_interface.cylinder_high&255),this.current_interface.cylinder_high&255}),t.io.register_read(this.ata_port|6,this,function(){return this.current_interface.drive_head&255}),t.io.register_write(this.ata_port|0,this,function(d){this.current_interface.write_data_port8(d)},function(d){this.current_interface.write_data_port16(d)},function(d){this.current_interface.write_data_port32(d)}),t.io.register_write(this.ata_port|1,this,function(d){u(d),this.master.lba_count=(this.master.lba_count<<8|d)&65535,this.slave.lba_count=(this.slave.lba_count<<8|d)&65535}),t.io.register_write(this.ata_port|2,this,function(d){u(d),this.master.bytecount=(this.master.bytecount<<8|d)&65535,this.slave.bytecount=(this.slave.bytecount<<8|d)&65535}),t.io.register_write(this.ata_port|3,this,function(d){u(d),this.master.sector=(this.master.sector<<8|d)&65535,this.slave.sector=(this.slave.sector<<8|d)&65535}),t.io.register_write(this.ata_port|4,this,function(d){u(d),this.master.cylinder_low=(this.master.cylinder_low<<8|d)&65535,this.slave.cylinder_low=(this.slave.cylinder_low<<8|d)&65535}),t.io.register_write(this.ata_port|5,this,function(d){u(d),this.master.cylinder_high=(this.master.cylinder_high<<8|d)&65535,this.slave.cylinder_high=(this.slave.cylinder_high<<8|d)&65535}),t.io.register_write(this.ata_port|6,this,function(d){var m=d&16;u(d,2),this.current_interface=m?this.slave:this.master,this.master.drive_head=d,this.slave.drive_head=d,this.master.is_lba=this.slave.is_lba=d>>6&1,this.master.head=this.slave.head=d&15}),this.dma_command=this.dma_status=this.prdt_addr=0,t.io.register_write(this.ata_port|7,this,function(d){this.cpu.device_lower_irq(this.irq),this.current_interface.ata_command(d)}),t.io.register_read(this.master_port|4,this,void 0,void 0,this.dma_read_addr),t.io.register_write(this.master_port|4,this,void 0,void 0,this.dma_set_addr),t.io.register_read(this.master_port,this,this.dma_read_command8,void 0,this.dma_read_command),t.io.register_write(this.master_port,this,this.dma_write_command8,void 0,this.dma_write_command),t.io.register_read(this.master_port|2,this,this.dma_read_status),t.io.register_write(this.master_port|2,this,this.dma_write_status),t.io.register_read(this.master_port|8,this,function(){return 0}),t.io.register_read(this.master_port|10,this,function(){return 0}),t.devices.pci.register_device(this)}x.prototype.read_status=function(){if(this.current_interface.buffer){var t=this.current_interface.status;return u(t,2),t}return 0},x.prototype.write_control=function(t){u(t,2),t&4&&(this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset()),this.device_control=t},x.prototype.dma_read_addr=function(){return u(this.prdt_addr,8),this.prdt_addr},x.prototype.dma_set_addr=function(t){u(t,8),this.prdt_addr=t},x.prototype.dma_read_status=function(){return u(this.dma_status),this.dma_status},x.prototype.dma_write_status=function(t){u(t),this.dma_status&=~(t&6)},x.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16},x.prototype.dma_read_command8=function(){return u(this.dma_command),this.dma_command},x.prototype.dma_write_command=function(t){u(t),this.dma_write_command8(t&255),this.dma_write_status(t>>16&255)},x.prototype.dma_write_command8=function(t){u(t);let e=this.dma_command;if(this.dma_command=t&9,(e&1)!==(t&1))if(!(t&1))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 37:case 200:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:u(this.current_interface.current_command)}},x.prototype.push_irq=function(){!(this.device_control&2)&&(this.dma_status|=4,this.cpu.device_raise_irq(this.irq))},x.prototype.get_state=function(){var t=[];return t[0]=this.master,t[1]=this.slave,t[2]=this.ata_port,t[3]=this.irq,t[4]=this.pci_id,t[5]=this.ata_port_high,t[6]=this.master_port,t[7]=this.name,t[8]=this.device_control,t[9]=this.prdt_addr,t[10]=this.dma_status,t[11]=this.current_interface===this.master,t[12]=this.dma_command,t},x.prototype.set_state=function(t){this.master.set_state(t[0]),this.slave.set_state(t[1]),this.ata_port=t[2],this.irq=t[3],this.pci_id=t[4],this.ata_port_high=t[5],this.master_port=t[6],this.name=t[7],this.device_control=t[8],this.prdt_addr=t[9],this.dma_status=t[10],this.current_interface=t[11]?this.master:this.slave,this.dma_command=t[12]};function A(t,e,r,n,a,p,d){this.device=t,this.bus=d,this.nr=a,this.cpu=e,this.buffer=r,this.sector_size=n?2048:512,this.is_atapi=n,this.cylinder_count=this.sectors_per_track=this.head_count=this.sector_count=0,this.buffer&&(this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(this.sector_count|0)&&(this.sector_count=Math.ceil(this.sector_count)),n?(this.head_count=1,this.sectors_per_track=0):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(this.cylinder_count|0)&&(this.cylinder_count=Math.floor(this.cylinder_count)),t=e.devices.rtc,t.cmos_write(57,t.cmos_read(57)|1<<4*this.nr),t.cmos_write(18,t.cmos_read(18)&15|240),t.cmos_write(27,this.cylinder_count&255),t.cmos_write(28,this.cylinder_count>>8&255),t.cmos_write(29,this.head_count&255),t.cmos_write(30,255),t.cmos_write(31,255),t.cmos_write(32,200),t.cmos_write(33,this.cylinder_count&255),t.cmos_write(34,this.cylinder_count>>8&255),t.cmos_write(35,this.sectors_per_track&255)),this.stats={sectors_read:0,sectors_written:0,bytes_read:0,bytes_written:0,loading:!1},this.buffer=r,this.drive_head=this.head=this.cylinder_high=this.cylinder_low=this.lba_count=this.sector=this.bytecount=this.is_lba=0,this.status=80,this.sectors_per_drq=128,this.data_pointer=this.error=0,this.data=new Uint8Array(65536),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.data_end=this.data_length=0,this.current_atapi_command=this.current_command=-1,this.last_io_id=this.write_dest=0,this.in_progress_io_ids=new Set,this.cancelled_io_ids=new Set,Object.seal(this)}A.prototype.device_reset=function(){this.is_atapi?(this.status=0,this.sector=this.error=this.bytecount=1,this.cylinder_low=20,this.cylinder_high=235):(this.status=81,this.sector=this.error=this.bytecount=1,this.cylinder_high=this.cylinder_low=0),this.cancel_io_operations()},A.prototype.push_irq=function(){this.device.push_irq()},A.prototype.ata_command=function(t){if(u(t),this.buffer)switch(this.current_command=t,this.error=0,t){case 8:this.data_length=this.data_end=this.data_pointer=0,this.device_reset(),this.push_irq();break;case 16:this.status=80,this.cylinder_low=0,this.push_irq();break;case 248:this.status=80,t=this.sector_count-1,this.sector=t&255,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.drive_head=this.drive_head&240|t>>24&15,this.push_irq();break;case 39:this.status=80,t=this.sector_count-1,this.sector=t&255,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.sector|=t>>24<<8&65280,this.push_irq();break;case 32:case 36:case 41:case 196:this.ata_read_sectors(t);break;case 48:case 52:case 57:case 197:this.ata_write_sectors(t);break;case 144:this.push_irq(),this.error=257,this.status=80;break;case 145:this.status=80,this.push_irq();break;case 160:this.is_atapi&&(this.status=88,this.data_allocate(12),this.data_end=12,this.bytecount=1,this.push_irq());break;case 161:this.is_atapi?(this.create_identify_packet(),this.status=88,this.cylinder_low=20,this.cylinder_high=235):this.status=65,this.push_irq();break;case 198:u(this.bytecount&255),this.sectors_per_drq=this.bytecount&255,this.status=80,this.push_irq();break;case 37:case 200:this.ata_read_sectors_dma(t);break;case 53:case 202:this.ata_write_sectors_dma(t);break;case 64:this.status=80,this.push_irq();break;case 218:this.status=65,this.error=4,this.push_irq();break;case 224:this.status=80,this.push_irq();break;case 225:this.status=80,this.push_irq();break;case 231:this.status=80,this.push_irq();break;case 236:if(this.is_atapi){this.status=65,this.error=4,this.push_irq();break}this.create_identify_packet(),this.status=88,this.push_irq();break;case 234:this.status=80,this.push_irq();break;case 239:u(this.bytecount&255),this.status=80,this.push_irq();break;case 222:this.status=80,this.push_irq();break;case 245:this.status=80,this.push_irq();break;case 249:this.status=65,this.error=4;break;default:u(t),this.status=65,this.error=4}else this.error=4,this.status=65,this.push_irq()},A.prototype.atapi_handle=function(){switch(u(this.data[0]),this.data_pointer=0,this.current_atapi_command=this.data[0],this.current_atapi_command){case 0:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 3:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88,this.data[0]=240,this.data[2]=5,this.data[7]=8;break;case 18:var t=this.data[4];this.status=88,u(this.data[1],2),this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]),this.data_end=this.data_length=Math.min(36,t);break;case 26:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88;break;case 30:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 37:t=this.sector_count-1,this.data_set(new Uint8Array([t>>24&255,t>>16&255,t>>8&255,t&255,0,0,this.sector_size>>8&255,this.sector_size&255])),this.data_end=this.data_length,this.status=88;break;case 40:this.lba_count&1?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:t=this.data[8],this.data_allocate(Math.min(8,t)),this.data_end=this.data_length,this.status=88;break;case 67:t=this.data[8]|this.data[7]<<8;var e=this.data[9]>>6;this.data_allocate(t),this.data_end=this.data_length,u(e,2),u(this.data[6]),e===0?(t=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,t>>24,t>>16&255,t>>8&255,t&255]))):e===1&&this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])),this.status=88;break;case 70:t=this.data[8]|this.data[7]<<8,t=Math.min(t,32),this.data_allocate(t),this.data_end=this.data_length,this.data[0]=t-4>>24&255,this.data[1]=t-4>>16&255,this.data[2]=t-4>>8&255,this.data[3]=t-4&255,this.data[6]=8,this.data[10]=3,this.status=88;break;case 81:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 82:u(this.data[0]),this.status=81,this.data_length=0,this.error=80;break;case 90:t=this.data[8]|this.data[7]<<8,e=this.data[2],u(e),e===42&&this.data_allocate(Math.min(30,t)),this.data_end=this.data_length,this.status=88;break;case 189:this.data_allocate(this.data[9]|this.data[8]<<8),this.data_end=this.data_length,this.data[5]=1,this.status=88;break;case 74:this.status=81,this.data_length=0,this.error=80,u(this.data[0]);break;case 190:u(this.data[0]),this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;default:this.status=81,this.data_length=0,this.error=80,u(this.data[0])}this.bytecount=this.bytecount&-8|2,!(this.status&128)&&this.push_irq(),!(this.status&128)&&this.data_length===0&&(this.bytecount|=1,this.status&=-9)},A.prototype.do_write=function(){this.status=80;var t=this.data.subarray(0,this.data_length);this.ata_advance(this.current_command,this.data_length/512),this.push_irq(),this.buffer.set(this.write_dest,t,function(){}),this.report_write(this.data_length)},A.prototype.atapi_read=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],r=t[7]<<8|t[8];t=t[1];var n=r*this.sector_size,a=e*this.sector_size;""+u(e)+u(r)+u(n)+u(t),this.data_length=0;var p=this.cylinder_high<<8&65280|this.cylinder_low&255;u(this.cylinder_high,2)+""+u(this.cylinder_low,2),this.cylinder_low=this.cylinder_high=0,p===65535&&p--,p>n&&(p=n),a>=this.buffer.byteLength?(""+u(a+n)+u(this.buffer.byteLength),this.status=255,this.push_irq()):n===0?(this.status=80,this.data_pointer=0):(n=Math.min(n,this.buffer.byteLength-a),this.status=208,this.report_read_start(),this.read_buffer(a,n,d=>{this.data_set(d),this.status=88,this.bytecount=this.bytecount&-8|2,this.push_irq(),this.data_end=p&=-4,this.data_end>this.data_length&&(this.data_end=this.data_length),this.cylinder_low=this.data_end&255,this.cylinder_high=this.data_end>>8&255,this.report_read_end(n)}))},A.prototype.atapi_read_dma=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],r=t[7]<<8|t[8];t=t[1];var n=r*this.sector_size,a=e*this.sector_size;""+u(e)+u(r)+u(n)+u(t),a>=this.buffer.byteLength?(""+u(a+n)+u(this.buffer.byteLength),this.status=255,this.push_irq()):(this.status=208,this.report_read_start(),this.read_buffer(a,n,p=>{this.report_read_end(n),this.status=88,this.bytecount=this.bytecount&-8|2,this.data_set(p),this.do_atapi_dma()}))},A.prototype.do_atapi_dma=function(){if(this.device.dma_status&1&&this.status&8){var t=this.device.prdt_addr,e=0,r=this.data;do{var n=this.cpu.read32s(t),a=this.cpu.read16(t+4),p=this.cpu.read8(t+7)&128;if(a||(a=65536),u(n),u(a),u(this.data_length),this.cpu.write_blob(r.subarray(e,Math.min(e+a,this.data_length)),n),e+=a,t+=8,e>=this.data_length&&!p){u(e),u(this.data_length),u(this.current_command);break}}while(!p);this.status=80,this.device.dma_status&=-2,this.bytecount=this.bytecount&-8|3,this.push_irq()}},A.prototype.read_data=function(t){if(this.data_pointer<this.data_end){u(this.data_pointer);var e=t===1?this.data[this.data_pointer]:t===2?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];return this.data_pointer+=t,!(this.data_pointer&(this.data_end&4095?255:4095))&&(u(this.data[this.data_pointer],2),u(this.data_pointer),u(this.data_length)),this.data_pointer>=this.data_end&&this.read_end(),e}return this.data_pointer+=t,0},A.prototype.read_end=function(){if(u(this.current_command),u(this.data_pointer),u(this.data_end),u(this.data_length),this.current_command===160)if(this.data_end===this.data_length)this.status=80,this.bytecount=this.bytecount&-8|3,this.push_irq();else{this.status=88,this.bytecount=this.bytecount&-8|2,this.push_irq();var t=this.cylinder_high<<8&65280|this.cylinder_low&255;this.data_end+t>this.data_length?(this.cylinder_low=this.data_length-this.data_end&255,this.cylinder_high=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=t,u(this.data_end)}else this.error=0,this.data_pointer>=this.data_length?this.status=80:(t=this.current_command===196||this.current_command===41?Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512):1,this.ata_advance(this.current_command,t),this.data_end+=512*t,this.status=88,this.push_irq())},A.prototype.write_data_port=function(t,e){this.data_pointer>=this.data_end?(u(t),u(this.data_end),u(this.data_pointer)):((!(this.data_pointer+e&(this.data_end&4095?255:4095))||20>this.data_end)&&(u(t>>>0),u(this.data_end),u(this.data_pointer)),e===1?this.data[this.data_pointer++]=t:e===2?(this.data16[this.data_pointer>>>1]=t,this.data_pointer+=2):(this.data32[this.data_pointer>>>2]=t,this.data_pointer+=4),this.data_pointer===this.data_end&&this.write_end())},A.prototype.write_data_port8=function(t){this.write_data_port(t,1)},A.prototype.write_data_port16=function(t){this.write_data_port(t,2)},A.prototype.write_data_port32=function(t){this.write_data_port(t,4)},A.prototype.write_end=function(){this.current_command===160?this.atapi_handle():(u(this.data_pointer),u(this.data_length),this.data_pointer>=this.data_length?this.do_write():(u(this.current_command),this.status=88,this.data_end+=512,this.push_irq()))},A.prototype.ata_advance=function(t,e){this.bytecount-=e,t===36||t===41||t===52||t===57||t===37||t===53?(t=e+this.get_lba48(),this.sector=t&255|t>>16&65280,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255):this.is_lba?(t=e+this.get_lba28(),this.sector=t&255,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.head=this.head&-16|t&15):(t=e+this.get_chs(),e=t/(this.head_count*this.sectors_per_track)|0,this.cylinder_low=e&255,this.cylinder_high=e>>8&255,this.head=(t/this.sectors_per_track|0)%this.head_count&15,this.sector=t%this.sectors_per_track+1&255,this.get_chs())},A.prototype.ata_read_sectors=function(t){var e=t===36||t===41,r=this.get_count(e);e=this.get_lba(e);var n=t===32||t===36,a=r*this.sector_size,p=e*this.sector_size;""+u(t)+(this.is_lba?"lba":"chs")+u(e)+u(r)+u(a),p+a>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=192,this.report_read_start(),this.read_buffer(p,a,d=>{this.data_set(d),this.status=88,this.data_end=n?512:Math.min(a,512*this.sectors_per_drq),this.ata_advance(t,n?1:Math.min(r,this.sectors_per_track)),this.push_irq(),this.report_read_end(a)}))},A.prototype.ata_read_sectors_dma=function(t){var e=t===37;t=this.get_count(e),e=this.get_lba(e);var r=t*this.sector_size,n=e*this.sector_size;u(e),u(t),u(r),n+r>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},A.prototype.do_ata_read_sectors_dma=function(){var t=this.current_command===37,e=this.get_count(t);t=this.get_lba(t);var r=e*this.sector_size;t*=this.sector_size,this.report_read_start(),this.read_buffer(t,r,n=>{var a=this.device.prdt_addr,p=0;do{var d=this.cpu.read32s(a),m=this.cpu.read16(a+4),g=this.cpu.read8(a+7)&128;m||(m=65536),u(d),u(m),this.cpu.write_blob(n.subarray(p,p+m),d),p+=m,a+=8}while(!g);this.ata_advance(this.current_command,e),this.status=80,this.device.dma_status&=-2,this.current_command=-1,this.push_irq(),this.report_read_end(r)})},A.prototype.ata_write_sectors=function(t){var e=t===52||t===57,r=this.get_count(e);e=this.get_lba(e),t=t===48||t===52;var n=r*this.sector_size,a=e*this.sector_size;u(e),u(r),u(n),a+n>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.data_allocate_noclear(n),this.data_end=t?512:Math.min(n,512*this.sectors_per_drq),this.write_dest=a)},A.prototype.ata_write_sectors_dma=function(t){var e=t===53;t=this.get_count(e),e=this.get_lba(e);var r=t*this.sector_size,n=e*this.sector_size;u(e),u(t),u(r),n+r>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},A.prototype.do_ata_write_sectors_dma=function(){var t=this.current_command===53,e=this.get_count(t),r=this.get_lba(t);t=e*this.sector_size,r*=this.sector_size;var n=this.device.prdt_addr,a=0;""+u(n,8);let p=new Uint8Array(t);do{var d=this.cpu.read32s(n),m=this.cpu.read16(n+4),g=this.cpu.read8(n+7)&128;m||(m=65536),""+u(d)+u(m),d=this.cpu.mem8.subarray(d,d+m),p.set(d,a),a+=m,n+=8}while(!g);this.buffer.set(r,p,()=>{this.ata_advance(this.current_command,e),this.status=80,this.push_irq(),this.device.dma_status&=-2,this.current_command=-1}),this.report_write(t)},A.prototype.get_chs=function(){return((this.cylinder_low&255|this.cylinder_high<<8&65280)*this.head_count+this.head)*this.sectors_per_track+(this.sector&255)-1},A.prototype.get_lba28=function(){return this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|(this.head&15)<<24},A.prototype.get_lba48=function(){return(this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|this.sector>>8<<24&4278190080)>>>0},A.prototype.get_lba=function(t){return t?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()},A.prototype.get_count=function(t){return t?(t=this.bytecount,t===0&&(t=65536)):(t=this.bytecount&255,t===0&&(t=256)),t},A.prototype.create_identify_packet=function(){if(this.drive_head&16)this.data_allocate(0);else{for(var t=0;512>t;t++)this.data[t]=0;t=Math.min(16383,this.cylinder_count),this.data_set([64,this.is_atapi?133:0,t,t>>8,0,0,this.head_count,this.head_count>>8,this.sectors_per_track/512,this.sectors_per_track/512>>8,0,2,this.sectors_per_track,this.sectors_per_track>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,56,118,32,54,68,72,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,128,0,1,0,0,2,0,0,0,2,0,2,7,0,t,t>>8,this.head_count,this.head_count>>8,this.sectors_per_track,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.current_command===160?0:7,this.current_command===160?0:4,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,126,0,0,0,0,0,0,116,0,64,0,64,0,116,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]),this.data_end=this.data_length=512}},A.prototype.data_allocate=function(t){this.data_allocate_noclear(t);for(var e=0;e<t+3>>2;e++)this.data32[e]=0},A.prototype.data_allocate_noclear=function(t){this.data.length<t&&(this.data=new Uint8Array(t+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)),this.data_length=t,this.data_pointer=0},A.prototype.data_set=function(t){this.data_allocate_noclear(t.length),this.data.set(t)},A.prototype.report_read_start=function(){this.stats.loading=!0,this.bus.send("ide-read-start")},A.prototype.report_read_end=function(t){this.stats.loading=!1;var e=t/this.sector_size|0;this.stats.sectors_read+=e,this.stats.bytes_read+=t,this.bus.send("ide-read-end",[this.nr,t,e])},A.prototype.report_write=function(t){var e=t/this.sector_size|0;this.stats.sectors_written+=e,this.stats.bytes_written+=t,this.bus.send("ide-write-end",[this.nr,t,e])},A.prototype.read_buffer=function(t,e,r){let n=this.last_io_id++;this.in_progress_io_ids.add(n),this.buffer.get(t,e,a=>{this.cancelled_io_ids.delete(n)?this.in_progress_io_ids.has(n):(this.in_progress_io_ids.delete(n),r(a))})},A.prototype.cancel_io_operations=function(){for(let t of this.in_progress_io_ids)this.cancelled_io_ids.add(t);this.in_progress_io_ids.clear()},A.prototype.get_state=function(){var t=[];return t[0]=this.bytecount,t[1]=this.cylinder_count,t[2]=this.cylinder_high,t[3]=this.cylinder_low,t[4]=this.data_pointer,t[5]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=this.drive_head,t[10]=this.error,t[11]=this.head,t[12]=this.head_count,t[13]=this.is_atapi,t[14]=this.is_lba,t[15]=this.lba_count,t[16]=this.data,t[17]=this.data_length,t[18]=this.sector,t[19]=this.sector_count,t[20]=this.sector_size,t[21]=this.sectors_per_drq,t[22]=this.sectors_per_track,t[23]=this.status,t[24]=this.write_dest,t[25]=this.current_command,t[26]=this.data_end,t[27]=this.current_atapi_command,t[28]=this.buffer,t},A.prototype.set_state=function(t){this.bytecount=t[0],this.cylinder_count=t[1],this.cylinder_high=t[2],this.cylinder_low=t[3],this.data_pointer=t[4],this.drive_head=t[9],this.error=t[10],this.head=t[11],this.head_count=t[12],this.is_atapi=t[13],this.is_lba=t[14],this.lba_count=t[15],this.data=t[16],this.data_length=t[17],this.sector=t[18],this.sector_count=t[19],this.sector_size=t[20],this.sectors_per_drq=t[21],this.sectors_per_track=t[22],this.status=t[23],this.write_dest=t[24],this.current_command=t[25],this.data_end=t[26],this.current_atapi_command=t[27],this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.buffer&&this.buffer.set_state(t[28])};function D(t){this.pci_addr=new Uint8Array(4),this.pci_value=new Uint8Array(4),this.pci_response=new Uint8Array(4),this.pci_status=new Uint8Array(4),this.pci_addr32=new Int32Array(this.pci_addr.buffer),this.pci_value32=new Int32Array(this.pci_value.buffer),this.pci_response32=new Int32Array(this.pci_response.buffer),this.pci_status32=new Int32Array(this.pci_status.buffer),this.device_spaces=[],this.devices=[],this.cpu=t;for(var e=0;256>e;e++)this.device_spaces[e]=void 0,this.devices[e]=void 0;this.io=t.io,t.io.register_write(3324,this,function(r){this.pci_write8(this.pci_addr32[0],r)},function(r){this.pci_write16(this.pci_addr32[0],r)},function(r){this.pci_write32(this.pci_addr32[0],r)}),t.io.register_write(3325,this,function(r){this.pci_write8(this.pci_addr32[0]+1|0,r)}),t.io.register_write(3326,this,function(r){this.pci_write8(this.pci_addr32[0]+2|0,r)},function(r){this.pci_write16(this.pci_addr32[0]+2|0,r)}),t.io.register_write(3327,this,function(r){this.pci_write8(this.pci_addr32[0]+3|0,r)}),t.io.register_read_consecutive(3324,this,function(){return this.pci_response[0]},function(){return this.pci_response[1]},function(){return this.pci_response[2]},function(){return this.pci_response[3]}),t.io.register_read_consecutive(3320,this,function(){return this.pci_status[0]},function(){return this.pci_status[1]},function(){return this.pci_status[2]},function(){return this.pci_status[3]}),t.io.register_write_consecutive(3320,this,function(r){this.pci_addr[0]=r&252},function(r){(this.pci_addr[1]&6)===2&&(r&6)===6?t.reboot_internal():this.pci_addr[1]=r},function(r){this.pci_addr[2]=r},function(r){this.pci_addr[3]=r,this.pci_query()}),this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"}),this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82371SB PIIX3 ISA"},this.isa_bridge_space=this.register_device(this.isa_bridge),this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}D.prototype.get_state=function(){for(var t=[],e=0;256>e;e++)t[e]=this.device_spaces[e];return t[256]=this.pci_addr,t[257]=this.pci_value,t[258]=this.pci_response,t[259]=this.pci_status,t},D.prototype.set_state=function(t){for(var e=0;256>e;e++){var r=this.devices[e],n=t[e];if(r&&n){for(var a=0;a<r.pci_bars.length;a++){var p=n[4+a];if(p&1){var d=r.pci_bars[a];this.set_io_bars(d,d.original_bar&65534,p&65534)}}this.device_spaces[e].set(n)}else n&&u(e,2)}this.pci_addr.set(t[256]),this.pci_value.set(t[257]),this.pci_response.set(t[258]),this.pci_status.set(t[259])},D.prototype.pci_query=function(){var t=this.pci_addr[2]<<8|this.pci_addr[1],e=this.pci_addr[0]&252,r=t>>3&31,n="query enabled="+(this.pci_addr[3]>>7)+(" bdf="+u(t,4));n+=" dev="+u(r,2),n+=" addr="+u(e,2),t=this.device_spaces[t],t!==void 0?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=e<t.byteLength?t[e>>2]:0,n+=" "+u(this.pci_addr32[0]>>>0,8)+" -> "+u(this.pci_response32[0]>>>0,8)):(this.pci_response32[0]=-1,this.pci_status32[0]=0)},D.prototype.pci_write8=function(t,e){var r=t>>8&65535;t&=255;var n=new Uint8Array(this.device_spaces[r].buffer);u(t),u(r>>3,2),u(t,4),u(e,2),n[t]=e},D.prototype.pci_write16=function(t,e){var r=t>>8&65535;t&=255;var n=new Uint16Array(this.device_spaces[r].buffer);16<=t&&44>t?u(t):(u(t),u(r>>3,2),u(t,4),u(e,4),n[t>>>1]=e)},D.prototype.pci_write32=function(t,e){var r=t>>8&65535;t&=255;var n=this.device_spaces[r],a=this.devices[r];if(n)if(16<=t&&40>t){if(a=a.pci_bars[t-16>>2],u(e>>>0),u(r>>3,2),a){r=t>>2;var p=n[r]&1;if((e|3|a.size-1)===-1?(e=~(a.size-1)|p,p===0&&(n[r]=e)):p===0&&(n[r]=a.original_bar),p===1){p=n[r]&65534;var d=e&65534;u(p>>>0,8),u(d>>>0,8),this.set_io_bars(a,p,d),n[r]=e|1}}else n[t>>2]=0;u(n[t>>2]>>>0)}else t===48?(u(r>>3,2),u(e>>>0,8),n[t>>2]=a.pci_rom_size?(e|2047)===-1?-a.pci_rom_size|0:a.pci_rom_address|0:0):t===4?(u(r>>3,2),u(t,4),u(e>>>0,8)):(u(r>>3,2),u(t,4),u(e>>>0,8),n[t>>>2]=e)},D.prototype.register_device=function(t){var e=t.pci_id;u(e);var r=new Int32Array(64);r.set(new Int32Array(new Uint8Array(t.pci_space).buffer)),this.device_spaces[e]=r,this.devices[e]=t,e=r.slice(4,10);for(var n=0;n<t.pci_bars.length;n++){var a=t.pci_bars[n];if(a){var p=e[n],d=p&1;if(a.original_bar=p,a.entries=[],d!==0)for(p&=-2,d=0;d<a.size;d++)a.entries[d]=this.io.ports[p+d]}}return r},D.prototype.set_io_bars=function(t,e,r){var n=t.size;u(e),u(r);for(var a=this.io.ports,p=0;p<n;p++){var d=a[e+p];4096<=e+p&&(a[e+p]=this.io.create_empty_entry()),d.read8===this.io.empty_port_read8&&d.read16===this.io.empty_port_read16&&d.read32===this.io.empty_port_read32&&d.write8===this.io.empty_port_write&&d.write16===this.io.empty_port_write&&d.write32===this.io.empty_port_write&&u(e+p,4),d=t.entries[p];var m=a[r+p];4096<=r+p&&(a[r+p]=d),m.read8!==this.io.empty_port_read8&&m.read16!==this.io.empty_port_read16&&m.read32!==this.io.empty_port_read32&&m.write8!==this.io.empty_port_write&&m.write16!==this.io.empty_port_write&&m.write32!==this.io.empty_port_write||u(r+p,4)}},D.prototype.raise_irq=function(t){this.cpu.device_raise_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)-1+((t>>3)-1&255)&3)])},D.prototype.lower_irq=function(t){this.cpu.device_lower_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)+(t>>3&255)-2&3)])};function O(t,e){this.io=t.io,this.cpu=t,this.dma=t.devices.dma,this.bytes_expecting=0,this.receiving_command=new Uint8Array(10),this.receiving_index=0,this.next_command=null,this.response_data=new Uint8Array(10),this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=this.response_length=this.response_index=0,this.last_sector=1,this.dir=this.dor=0,this.fdb_image=this.fda_image=null,e?this.set_fda(e):(this.eject_fda(),this.cpu.devices.rtc.cmos_write(16,64)),this.io.register_read(1008,this,this.port3F0_read),this.io.register_read(1010,this,this.port3F2_read),this.io.register_read(1012,this,this.port3F4_read),this.io.register_read(1013,this,this.port3F5_read),this.io.register_read(1015,this,this.port3F7_read),this.io.register_write(1010,this,this.port3F2_write),this.io.register_write(1012,this,this.port3F4_write),this.io.register_write(1013,this,this.port3F5_write)}O.prototype.eject_fda=function(){this.fda_image=null,this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0,this.dir=128},O.prototype.set_fda=function(t){var e={163840:{type:1,tracks:40,sectors:8,heads:1},184320:{type:1,tracks:40,sectors:9,heads:1},204800:{type:1,tracks:40,sectors:10,heads:1},327680:{type:1,tracks:40,sectors:8,heads:2},368640:{type:1,tracks:40,sectors:9,heads:2},409600:{type:1,tracks:40,sectors:10,heads:2},737280:{type:3,tracks:80,sectors:9,heads:2},1228800:{type:2,tracks:80,sectors:15,heads:2},1474560:{type:4,tracks:80,sectors:18,heads:2},1763328:{type:5,tracks:82,sectors:21,heads:2},2949120:{type:5,tracks:80,sectors:36,heads:2},512:{type:1,tracks:1,sectors:1,heads:1}};let r=t.byteLength,n=e[r];n||(r=1474560<t.byteLength?2949120:1474560,n=e[r],e=new Uint8Array(r),e.set(new Uint8Array(t.buffer)),t=new f.SyncBuffer(e.buffer)),this.sectors_per_track=n.sectors,this.number_of_heads=n.heads,this.number_of_cylinders=n.tracks,this.fda_image=t,this.dir=128,this.cpu.devices.rtc.cmos_write(16,n.type<<4)},O.prototype.get_state=function(){var t=[];return t[0]=this.bytes_expecting,t[1]=this.receiving_command,t[2]=this.receiving_index,t[4]=this.response_data,t[5]=this.response_index,t[6]=this.response_length,t[8]=this.status_reg0,t[9]=this.status_reg1,t[10]=this.status_reg2,t[11]=this.drive,t[12]=this.last_cylinder,t[13]=this.last_head,t[14]=this.last_sector,t[15]=this.dor,t[16]=this.sectors_per_track,t[17]=this.number_of_heads,t[18]=this.number_of_cylinders,t},O.prototype.set_state=function(t){this.bytes_expecting=t[0],this.receiving_command=t[1],this.receiving_index=t[2],this.next_command=t[3],this.response_data=t[4],this.response_index=t[5],this.response_length=t[6],this.status_reg0=t[8],this.status_reg1=t[9],this.status_reg2=t[10],this.drive=t[11],this.last_cylinder=t[12],this.last_head=t[13],this.last_sector=t[14],this.dor=t[15],this.sectors_per_track=t[16],this.number_of_heads=t[17],this.number_of_cylinders=t[18]},O.prototype.port3F0_read=function(){return 0},O.prototype.port3F4_read=function(){var t=128;return this.response_index<this.response_length&&(t|=80),!(this.dor&8)&&(t|=32),t},O.prototype.port3F7_read=function(){return this.dir},O.prototype.port3F5_read=function(){return this.response_index<this.response_length?(this.cpu.device_lower_irq(6),this.response_data[this.response_index++]):255},O.prototype.port3F4_write=function(t){u(t),t&128&&(this.status_reg0=192,this.cpu.device_raise_irq(6))},O.prototype.port3F5_write=function(t){if(""+u(t),0<this.bytes_expecting)this.receiving_command[this.receiving_index++]=t,this.bytes_expecting--,this.bytes_expecting===0&&this.next_command.call(this,this.receiving_command);else{switch(t){case 3:this.next_command=this.fix_drive_data,this.bytes_expecting=2;break;case 19:this.next_command=this.configure,this.bytes_expecting=3;break;case 4:this.next_command=this.check_drive_status,this.bytes_expecting=1;break;case 5:case 69:case 197:this.next_command=function(e){this.do_sector(!0,e)},this.bytes_expecting=8;break;case 6:case 70:case 198:case 230:this.next_command=function(e){this.do_sector(!1,e)},this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate,this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id,this.bytes_expecting=1;break;case 15:this.bytes_expecting=2,this.next_command=this.seek;break;case 14:case 16:this.status_reg0=128,this.response_data[0]=this.status_reg0,this.response_index=0,this.response_length=1,this.bytes_expecting=0;break;default:""+u(t)}this.receiving_index=0}},O.prototype.port3F2_read=function(){return this.dor},O.prototype.port3F2_write=function(t){(t&4)===4&&!(this.dor&4)&&(this.status_reg0=192,this.cpu.device_raise_irq(6)),u(t>>4),u(t),this.dor=t},O.prototype.check_drive_status=function(){this.status_reg1=this.fda_image?0:5,this.response_index=0,this.response_length=1,this.response_data[0]=0},O.prototype.seek=function(t){if(!(t[0]&3)){var e=t[1];t=t[0]>>2&1,e!==this.last_cylinder&&(this.dir=0),this.status_reg1=this.fda_image?0:5,this.status_reg0=32,this.last_cylinder=e,this.last_head=t}this.raise_irq()},O.prototype.calibrate=function(t){this.seek([t[0],0])},O.prototype.check_interrupt_status=function(){this.response_index=0,this.response_length=2,this.response_data[0]=this.status_reg0,this.response_data[1]=this.last_cylinder},O.prototype.do_sector=function(t,e){var r=e[2],n=e[1],a=e[3],p=128<<e[4],d=e[5]-e[3]+1,m=((r+this.number_of_heads*n)*this.sectors_per_track+a-1)*p;u(m),u(d*p),this.fda_image?(this.status_reg1=0,t?this.dma.do_write(this.fda_image,m,d*p,2,this.done.bind(this,e,n,r,a)):this.dma.do_read(this.fda_image,m,d*p,2,this.done.bind(this,e,n,r,a))):this.status_reg1=5},O.prototype.done=function(t,e,r,n,a){a||(n++,n>this.sectors_per_track&&(n=1,r++,r>=this.number_of_heads&&(r=0,e++)),e!==this.last_cylinder&&(this.dir=0),this.status_reg0=32,this.last_cylinder=e,this.last_head=r,this.last_sector=n,this.response_index=0,this.response_length=7,this.response_data[0]=r<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=e,this.response_data[4]=r,this.response_data[5]=n,this.response_data[6]=t[4],this.raise_irq())},O.prototype.fix_drive_data=function(t){t.slice(0,this.bytes_expecting)},O.prototype.configure=function(t){t.slice(0,this.bytes_expecting)},O.prototype.read_sector_id=function(){this.response_index=0,this.response_length=7,this.response_data[0]=0,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=0,this.response_data[4]=0,this.response_data[5]=0,this.response_data[6]=0,this.raise_irq()},O.prototype.raise_irq=function(){this.dor&8&&this.cpu.device_raise_irq(6)},V.prototype.mmap_read8=function(t){return this.memory_map_read8[t>>>17](t)},V.prototype.mmap_write8=function(t,e){this.memory_map_write8[t>>>17](t,e)},V.prototype.mmap_read16=function(t){var e=this.memory_map_read8[t>>>17];return e(t)|e(t+1|0)<<8},V.prototype.mmap_write16=function(t,e){var r=this.memory_map_write8[t>>>17];r(t,e&255),r(t+1|0,e>>8)},V.prototype.mmap_read32=function(t){return this.memory_map_read32[t>>>17](t)},V.prototype.mmap_write32=function(t,e){this.memory_map_write32[t>>>17](t,e)},V.prototype.mmap_write64=function(t,e,r){var n=this.memory_map_write32[t>>>17];n(t,e),n(t+4,r)},V.prototype.mmap_write128=function(t,e,r,n,a){var p=this.memory_map_write32[t>>>17];p(t,e),p(t+4,r),p(t+8,n),p(t+12,a)},V.prototype.write_blob=function(t,e){t.length&&(this.in_mapped_range(e),this.in_mapped_range(e+t.length-1),this.jit_dirty_cache(e,e+t.length),this.mem8.set(t,e))},V.prototype.read_blob=function(t,e){return e&&(this.in_mapped_range(t),this.in_mapped_range(t+e-1)),this.mem8.subarray(t,t+e)};function I(t){this.cpu=t,this.channel_page=new Uint8Array(8),this.channel_pagehi=new Uint8Array(8),this.channel_addr=new Uint16Array(8),this.channel_addr_init=new Uint16Array(8),this.channel_count=new Uint16Array(8),this.channel_count_init=new Uint16Array(8),this.channel_mask=new Uint8Array(8),this.channel_mode=new Uint8Array(8),this.unmask_listeners=[],this.lsb_msb_flipflop=0,t=t.io,t.register_write(0,this,this.port_addr_write.bind(this,0)),t.register_write(2,this,this.port_addr_write.bind(this,1)),t.register_write(4,this,this.port_addr_write.bind(this,2)),t.register_write(6,this,this.port_addr_write.bind(this,3)),t.register_write(1,this,this.port_count_write.bind(this,0)),t.register_write(3,this,this.port_count_write.bind(this,1)),t.register_write(5,this,this.port_count_write.bind(this,2)),t.register_write(7,this,this.port_count_write.bind(this,3)),t.register_read(0,this,this.port_addr_read.bind(this,0)),t.register_read(2,this,this.port_addr_read.bind(this,1)),t.register_read(4,this,this.port_addr_read.bind(this,2)),t.register_read(6,this,this.port_addr_read.bind(this,3)),t.register_read(1,this,this.port_count_read.bind(this,0)),t.register_read(3,this,this.port_count_read.bind(this,1)),t.register_read(5,this,this.port_count_read.bind(this,2)),t.register_read(7,this,this.port_count_read.bind(this,3)),t.register_write(192,this,this.port_addr_write.bind(this,4)),t.register_write(196,this,this.port_addr_write.bind(this,5)),t.register_write(200,this,this.port_addr_write.bind(this,6)),t.register_write(204,this,this.port_addr_write.bind(this,7)),t.register_write(194,this,this.port_count_write.bind(this,4)),t.register_write(198,this,this.port_count_write.bind(this,5)),t.register_write(202,this,this.port_count_write.bind(this,6)),t.register_write(206,this,this.port_count_write.bind(this,7)),t.register_read(192,this,this.port_addr_read.bind(this,4)),t.register_read(196,this,this.port_addr_read.bind(this,5)),t.register_read(200,this,this.port_addr_read.bind(this,6)),t.register_read(204,this,this.port_addr_read.bind(this,7)),t.register_read(194,this,this.port_count_read.bind(this,4)),t.register_read(198,this,this.port_count_read.bind(this,5)),t.register_read(202,this,this.port_count_read.bind(this,6)),t.register_read(206,this,this.port_count_read.bind(this,7)),t.register_write(135,this,this.port_page_write.bind(this,0)),t.register_write(131,this,this.port_page_write.bind(this,1)),t.register_write(129,this,this.port_page_write.bind(this,2)),t.register_write(130,this,this.port_page_write.bind(this,3)),t.register_write(143,this,this.port_page_write.bind(this,4)),t.register_write(139,this,this.port_page_write.bind(this,5)),t.register_write(137,this,this.port_page_write.bind(this,6)),t.register_write(138,this,this.port_page_write.bind(this,7)),t.register_read(135,this,this.port_page_read.bind(this,0)),t.register_read(131,this,this.port_page_read.bind(this,1)),t.register_read(129,this,this.port_page_read.bind(this,2)),t.register_read(130,this,this.port_page_read.bind(this,3)),t.register_read(143,this,this.port_page_read.bind(this,4)),t.register_read(139,this,this.port_page_read.bind(this,5)),t.register_read(137,this,this.port_page_read.bind(this,6)),t.register_read(138,this,this.port_page_read.bind(this,7)),t.register_write(1159,this,this.port_pagehi_write.bind(this,0)),t.register_write(1155,this,this.port_pagehi_write.bind(this,1)),t.register_write(1153,this,this.port_pagehi_write.bind(this,2)),t.register_write(1154,this,this.port_pagehi_write.bind(this,3)),t.register_write(1163,this,this.port_pagehi_write.bind(this,5)),t.register_write(1161,this,this.port_pagehi_write.bind(this,6)),t.register_write(1162,this,this.port_pagehi_write.bind(this,7)),t.register_read(1159,this,this.port_pagehi_read.bind(this,0)),t.register_read(1155,this,this.port_pagehi_read.bind(this,1)),t.register_read(1153,this,this.port_pagehi_read.bind(this,2)),t.register_read(1154,this,this.port_pagehi_read.bind(this,3)),t.register_read(1163,this,this.port_pagehi_read.bind(this,5)),t.register_read(1161,this,this.port_pagehi_read.bind(this,6)),t.register_read(1162,this,this.port_pagehi_read.bind(this,7)),t.register_write(10,this,this.port_singlemask_write.bind(this,0)),t.register_write(212,this,this.port_singlemask_write.bind(this,4)),t.register_write(15,this,this.port_multimask_write.bind(this,0)),t.register_write(222,this,this.port_multimask_write.bind(this,4)),t.register_read(15,this,this.port_multimask_read.bind(this,0)),t.register_read(222,this,this.port_multimask_read.bind(this,4)),t.register_write(11,this,this.port_mode_write.bind(this,0)),t.register_write(214,this,this.port_mode_write.bind(this,4)),t.register_write(12,this,this.portC_write),t.register_write(216,this,this.portC_write)}I.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]},I.prototype.set_state=function(t){this.channel_page=t[0],this.channel_pagehi=t[1],this.channel_addr=t[2],this.channel_addr_init=t[3],this.channel_count=t[4],this.channel_count_init=t[5],this.channel_mask=t[6],this.channel_mode=t[7],this.lsb_msb_flipflop=t[8]},I.prototype.port_count_write=function(t,e){u(e),this.channel_count[t]=this.flipflop_get(this.channel_count[t],e,!1),this.channel_count_init[t]=this.flipflop_get(this.channel_count_init[t],e,!0)},I.prototype.port_count_read=function(t){return u(this.channel_count[t]),this.flipflop_read(this.channel_count[t])},I.prototype.port_addr_write=function(t,e){u(e),this.channel_addr[t]=this.flipflop_get(this.channel_addr[t],e,!1),this.channel_addr_init[t]=this.flipflop_get(this.channel_addr_init[t],e,!0)},I.prototype.port_addr_read=function(t){return u(this.channel_addr[t]),this.flipflop_read(this.channel_addr[t])},I.prototype.port_pagehi_write=function(t,e){u(e),this.channel_pagehi[t]=e},I.prototype.port_pagehi_read=function(t){return this.channel_pagehi[t]},I.prototype.port_page_write=function(t,e){u(e),this.channel_page[t]=e},I.prototype.port_page_read=function(t){return this.channel_page[t]},I.prototype.port_singlemask_write=function(t,e){this.update_mask((e&3)+t,e&4?1:0)},I.prototype.port_multimask_write=function(t,e){u(e);for(var r=0;4>r;r++)this.update_mask(t+r,e&1<<r)},I.prototype.port_multimask_read=function(t){var e=0|this.channel_mask[t+0];return e|=this.channel_mask[t+1]<<1,e|=this.channel_mask[t+2]<<2,e|=this.channel_mask[t+3]<<3,u(e),e},I.prototype.port_mode_write=function(t,e){t=(e&3)+t,u(e),this.channel_mode[t]=e},I.prototype.portC_write=function(){this.lsb_msb_flipflop=0},I.prototype.on_unmask=function(t,e){this.unmask_listeners.push({fn:t,this_value:e})},I.prototype.update_mask=function(t,e){if(this.channel_mask[t]!==e&&(this.channel_mask[t]=e,!e))for(e=0;e<this.unmask_listeners.length;e++)this.unmask_listeners[e].fn.call(this.unmask_listeners[e].this_value,t)},I.prototype.do_read=function(t,e,r,n,a){var p=this.count_get_8bit(n),d=this.address_get_8bit(n);if(""+u(d)+u(p),r<p&&(""+u(r)+u(p),void 0),e+p>t.byteLength)a(!0);else{var m=this.cpu;this.channel_addr[n]+=p,t.get(e,p,function(g){m.write_blob(g,d),a(!1)})}},I.prototype.do_write=function(t,e,r,n,a){var p=this.channel_count[n]+1&65535,d=5<=n?2:1,m=p*d,g=this.address_get_8bit(n),y=!1,b=!1,E=this.channel_mode[n]&16;""+u(g)+u(m),r<m?(p=Math.floor(r/d),m=p*d,y=!0):r>m&&(b=!0),e+m>t.byteLength?a(!0):(this.channel_addr[n]+=p,this.channel_count[n]-=p,!y&&E&&(this.channel_addr[n]=this.channel_addr_init[n],this.channel_count[n]=this.channel_count_init[n]),t.set(e,this.cpu.mem8.subarray(g,g+m),()=>{b&&E?this.do_write(t,e+m,r-m,n,a):a(!1)}))},I.prototype.address_get_8bit=function(t){var e=this.channel_addr[t];return 5<=t&&(e<<=1),e=e&65535|this.channel_page[t]<<16,e|=this.channel_pagehi[t]<<24},I.prototype.count_get_8bit=function(t){var e=this.channel_count[t]+1;return 5<=t&&(e*=2),e},I.prototype.flipflop_get=function(t,e,r){return r||(this.lsb_msb_flipflop^=1),this.lsb_msb_flipflop?t&-256|e:t&-65281|e<<8},I.prototype.flipflop_read=function(t){return(this.lsb_msb_flipflop^=1)?t&255:t>>8&255};function B(t,e){this.cpu=t,this.bus=e,this.counter_start_time=new Float64Array(3),this.counter_start_value=new Uint16Array(3),this.counter_next_low=new Uint8Array(4),this.counter_enabled=new Uint8Array(4),this.counter_mode=new Uint8Array(4),this.counter_read_mode=new Uint8Array(4),this.counter_latch=new Uint8Array(4),this.counter_latch_value=new Uint16Array(3),this.counter_reload=new Uint16Array(3),t.io.register_read(97,this,function(){var r=_.microtick(),n=66.66666666666667*r&1;return r=this.did_rollover(2,r),n<<4|r<<5}),t.io.register_write(97,this,function(r){r&1?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")}),t.io.register_read(64,this,function(){return this.counter_read(0)}),t.io.register_read(65,this,function(){return this.counter_read(1)}),t.io.register_read(66,this,function(){return this.counter_read(2)}),t.io.register_write(64,this,function(r){this.counter_write(0,r)}),t.io.register_write(65,this,function(r){this.counter_write(1,r)}),t.io.register_write(66,this,function(r){this.counter_write(2,r),this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])}),t.io.register_write(67,this,this.port43_write)}B.prototype.get_state=function(){var t=[];return t[0]=this.counter_next_low,t[1]=this.counter_enabled,t[2]=this.counter_mode,t[3]=this.counter_read_mode,t[4]=this.counter_latch,t[5]=this.counter_latch_value,t[6]=this.counter_reload,t[7]=this.counter_start_time,t[8]=this.counter_start_value,t},B.prototype.set_state=function(t){this.counter_next_low=t[0],this.counter_enabled=t[1],this.counter_mode=t[2],this.counter_read_mode=t[3],this.counter_latch=t[4],this.counter_latch_value=t[5],this.counter_reload=t[6],this.counter_start_time=t[7],this.counter_start_value=t[8]},B.prototype.timer=function(t,e){var r=100;return e||(this.counter_enabled[0]&&this.did_rollover(0,t)?(this.counter_start_value[0]=this.get_counter_value(0,t),this.counter_start_time[0]=t,this.cpu.device_lower_irq(0),this.cpu.device_raise_irq(0),this.counter_mode[0]===0&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0),this.counter_enabled[0]&&(r=(this.counter_start_value[0]-Math.floor(1193.1816666*(t-this.counter_start_time[0])))/1193.1816666)),r},B.prototype.get_counter_value=function(t,e){return this.counter_enabled[t]?(e=this.counter_start_value[t]-Math.floor(1193.1816666*(e-this.counter_start_time[t])),t=this.counter_reload[t],e>=t?e%=t:0>e&&(e=e%t+t),e):0},B.prototype.did_rollover=function(t,e){return e-=this.counter_start_time[t],0>e?!0:this.counter_start_value[t]<Math.floor(1193.1816666*e)},B.prototype.counter_read=function(t){var e=this.counter_latch[t];return e?(this.counter_latch[t]--,e===2?this.counter_latch_value[t]&255:this.counter_latch_value[t]>>8):(e=this.counter_next_low[t],this.counter_mode[t]===3&&(this.counter_next_low[t]^=1),t=this.get_counter_value(t,_.microtick()),e?t&255:t>>8)},B.prototype.counter_write=function(t,e){this.counter_reload[t]=this.counter_next_low[t]?this.counter_reload[t]&-256|e:this.counter_reload[t]&255|e<<8,this.counter_read_mode[t]===3&&this.counter_next_low[t]||(this.counter_reload[t]||(this.counter_reload[t]=65535),this.counter_start_value[t]=this.counter_reload[t],this.counter_enabled[t]=!0,this.counter_start_time[t]=_.microtick(),u(this.counter_reload[t])),this.counter_read_mode[t]===3&&(this.counter_next_low[t]^=1)},B.prototype.port43_write=function(t){var e=t>>1&7,r=t>>6&3;t=t>>4&3,r!==3&&(t===0?(this.counter_latch[r]=2,e=this.get_counter_value(r,_.microtick()),this.counter_latch_value[r]=e?e-1:0):(6<=e&&(e&=-5),this.counter_next_low[r]=t===1?0:1,r===0&&this.cpu.device_lower_irq(0),e!==0&&e!==3&&e!==2&&u(e),this.counter_mode[r]=e,this.counter_read_mode[r]=t,r===2&&this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])))},B.prototype.dump=function(){};var G=Uint32Array.from([655360,655360,720896,753664]),Y=Uint32Array.from([131072,65536,32768,32768]);function q(t,e,r){this.cpu=t,this.bus=e,this.vga_memory_size=r,this.cursor_address=0,this.cursor_scanline_start=14,this.cursor_scanline_end=15,this.max_cols=80,this.max_rows=25,this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0,this.layers=[],this.start_address_latched=this.start_address=0,this.crtc=new Uint8Array(25),this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0,this.graphical_mode_is_linear=!0,this.graphical_mode=!1,setTimeout(()=>{e.send("screen-set-mode",this.graphical_mode)},0),this.vga256_palette=new Int32Array(256),this.latch_dword=0,this.svga_version=45253,this.svga_height=this.svga_width=0,this.svga_enabled=!1,this.svga_bpp=32,this.svga_offset_y=this.svga_offset=this.svga_bank_offset=0,this.pci_space=[52,18,17,17,3,1,0,0,0,0,0,3,0,0,0,0,8,14680064,57344,224,0,0,0,0,0,0,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,190,254,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_id=144,this.pci_bars=[{size:r}],this.pci_rom_size=65536,this.pci_rom_address=4272947200,this.name="vga",this.stats={is_graphical:!1,res_x:0,res_y:0,bpp:0},this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0,this.dac_mask=255,this.dac_map=new Uint8Array(16),this.attribute_controller_index=-1,this.palette_source=32,this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=0,this.sequencer_index=-1,this.plane_write_bm=15,this.clocking_mode=this.sequencer_memory_mode=0,this.graphics_index=-1,this.planar_rotate_reg=this.planar_mode=this.plane_read=0,this.planar_bitmap=255,this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0,this.port_3DA_value=this.miscellaneous_output_register=255,r=t.io,r.register_write(960,this,this.port3C0_write),r.register_read(960,this,this.port3C0_read,this.port3C0_read16),r.register_read(961,this,this.port3C1_read),r.register_write(962,this,this.port3C2_write),r.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write),r.register_read(964,this,this.port3C4_read),r.register_read(965,this,this.port3C5_read),r.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write),r.register_read(974,this,this.port3CE_read),r.register_read(975,this,this.port3CF_read),r.register_read(966,this,this.port3C6_read),r.register_write(966,this,this.port3C6_write),r.register_write(967,this,this.port3C7_write),r.register_read(967,this,this.port3C7_read),r.register_write(968,this,this.port3C8_write),r.register_read(968,this,this.port3C8_read),r.register_write(969,this,this.port3C9_write),r.register_read(969,this,this.port3C9_read),r.register_read(972,this,this.port3CC_read),r.register_write(980,this,this.port3D4_write,p=>{this.port3D4_write(p&255),this.port3D5_write(p>>8&255)}),r.register_write(981,this,this.port3D5_write,p=>{u(p,4),this.port3D5_write(p&255)}),r.register_read(980,this,this.port3D4_read),r.register_read(981,this,this.port3D5_read,()=>this.port3D5_read()),r.register_read(970,this,function(){return 0}),r.register_read(986,this,this.port3DA_read),r.register_read(954,this,this.port3DA_read),this.dispi_index=-1,this.dispi_enable_value=0,r.register_write(462,this,void 0,this.port1CE_write),r.register_write(463,this,void 0,this.port1CF_write),r.register_read(463,this,void 0,this.port1CF_read),this.vga_memory_size===void 0||262144>this.vga_memory_size?this.vga_memory_size=262144:268435456<this.vga_memory_size?this.vga_memory_size=268435456:this.vga_memory_size&65535&&(this.vga_memory_size|=65535,this.vga_memory_size++);let n=t.svga_allocate_memory(this.vga_memory_size)>>>0;this.svga_memory=f.view(Uint8Array,t.wasm_memory,n,this.vga_memory_size),this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0,this.image_data=null,e.register("screen-fill-buffer",function(){this.screen_fill_buffer()},this),this.vga_memory=new Uint8Array(262144),this.plane0=new Uint8Array(this.vga_memory.buffer,0,65536),this.plane1=new Uint8Array(this.vga_memory.buffer,65536,65536),this.plane2=new Uint8Array(this.vga_memory.buffer,131072,65536),this.plane3=new Uint8Array(this.vga_memory.buffer,196608,65536),this.pixel_buffer=new Uint8Array(524288);var a=this;r.mmap_register(655360,131072,function(p){return a.vga_memory_read(p)},function(p,d){a.vga_memory_write(p,d)}),t.devices.pci.register_device(this)}q.prototype.get_state=function(){var t=[];return t[0]=this.vga_memory_size,t[1]=this.cursor_address,t[2]=this.cursor_scanline_start,t[3]=this.cursor_scanline_end,t[4]=this.max_cols,t[5]=this.max_rows,t[6]=this.vga_memory,t[7]=this.dac_state,t[8]=this.start_address,t[9]=this.graphical_mode,t[10]=this.vga256_palette,t[11]=this.latch_dword,t[12]=this.color_compare,t[13]=this.color_dont_care,t[14]=this.miscellaneous_graphics_register,t[15]=this.svga_width,t[16]=this.svga_height,t[17]=this.crtc_mode,t[18]=this.svga_enabled,t[19]=this.svga_bpp,t[20]=this.svga_bank_offset,t[21]=this.svga_offset,t[22]=this.index_crtc,t[23]=this.dac_color_index_write,t[24]=this.dac_color_index_read,t[25]=this.dac_map,t[26]=this.sequencer_index,t[27]=this.plane_write_bm,t[28]=this.sequencer_memory_mode,t[29]=this.graphics_index,t[30]=this.plane_read,t[31]=this.planar_mode,t[32]=this.planar_rotate_reg,t[33]=this.planar_bitmap,t[34]=this.max_scan_line,t[35]=this.miscellaneous_output_register,t[36]=this.port_3DA_value,t[37]=this.dispi_index,t[38]=this.dispi_enable_value,t[39]=this.svga_memory,t[40]=this.graphical_mode_is_linear,t[41]=this.attribute_controller_index,t[42]=this.offset_register,t[43]=this.planar_setreset,t[44]=this.planar_setreset_enable,t[45]=this.start_address_latched,t[46]=this.crtc,t[47]=this.horizontal_display_enable_end,t[48]=this.horizontal_blank_start,t[49]=this.vertical_display_enable_end,t[50]=this.vertical_blank_start,t[51]=this.underline_location_register,t[52]=this.preset_row_scan,t[53]=this.offset_register,t[54]=this.palette_source,t[55]=this.attribute_mode,t[56]=this.color_plane_enable,t[57]=this.horizontal_panning,t[58]=this.color_select,t[59]=this.clocking_mode,t[60]=this.line_compare,t[61]=this.pixel_buffer,t[62]=this.dac_mask,t},q.prototype.set_state=function(t){this.vga_memory_size=t[0],this.cursor_address=t[1],this.cursor_scanline_start=t[2],this.cursor_scanline_end=t[3],this.max_cols=t[4],this.max_rows=t[5],t[6]&&this.vga_memory.set(t[6]),this.dac_state=t[7],this.start_address=t[8],this.graphical_mode=t[9],this.vga256_palette=t[10],this.latch_dword=t[11],this.color_compare=t[12],this.color_dont_care=t[13],this.miscellaneous_graphics_register=t[14],this.svga_width=t[15],this.svga_height=t[16],this.crtc_mode=t[17],this.svga_enabled=t[18],this.svga_bpp=t[19],this.svga_bank_offset=t[20],this.svga_offset=t[21],this.index_crtc=t[22],this.dac_color_index_write=t[23],this.dac_color_index_read=t[24],this.dac_map=t[25],this.sequencer_index=t[26],this.plane_write_bm=t[27],this.sequencer_memory_mode=t[28],this.graphics_index=t[29],this.plane_read=t[30],this.planar_mode=t[31],this.planar_rotate_reg=t[32],this.planar_bitmap=t[33],this.max_scan_line=t[34],this.miscellaneous_output_register=t[35],this.port_3DA_value=t[36],this.dispi_index=t[37],this.dispi_enable_value=t[38],this.svga_memory.set(t[39]),this.graphical_mode_is_linear=t[40],this.attribute_controller_index=t[41],this.offset_register=t[42],this.planar_setreset=t[43],this.planar_setreset_enable=t[44],this.start_address_latched=t[45],this.crtc.set(t[46]),this.horizontal_display_enable_end=t[47],this.horizontal_blank_start=t[48],this.vertical_display_enable_end=t[49],this.vertical_blank_start=t[50],this.underline_location_register=t[51],this.preset_row_scan=t[52],this.offset_register=t[53],this.palette_source=t[54],this.attribute_mode=t[55],this.color_plane_enable=t[56],this.horizontal_panning=t[57],this.color_select=t[58],this.clocking_mode=t[59],this.line_compare=t[60],t[61]&&this.pixel_buffer.set(t[61]),this.dac_mask=t[62]===void 0?255:t[62],this.bus.send("screen-set-mode",this.graphical_mode),this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.update_layers()):(this.update_vga_size(),this.update_layers(),this.complete_replot())):(this.set_size_text(this.max_cols,this.max_rows),this.update_cursor_scanline(),this.update_cursor()),this.complete_redraw()},q.prototype.vga_memory_read=function(t){if(this.svga_enabled&&this.graphical_mode_is_linear)return this.cpu.read8((t-655360|this.svga_bank_offset)+3758096384|0);var e=this.miscellaneous_graphics_register>>2&3;return t-=G[e],0>t||t>=Y[e]?(u(t),0):(this.latch_dword=this.plane0[t],this.latch_dword|=this.plane1[t]<<8,this.latch_dword|=this.plane2[t]<<16,this.latch_dword|=this.plane3[t]<<24,this.planar_mode&8?(e=255,this.color_dont_care&1&&(e&=this.plane0[t]^~(this.color_compare&1?255:0)),this.color_dont_care&2&&(e&=this.plane1[t]^~(this.color_compare&2?255:0)),this.color_dont_care&4&&(e&=this.plane2[t]^~(this.color_compare&4?255:0)),this.color_dont_care&8&&(e&=this.plane3[t]^~(this.color_compare&8?255:0)),e):(e=this.plane_read,this.graphical_mode?this.sequencer_memory_mode&8?(e=t&3,t&=-4):this.planar_mode&16&&(e=t&1,t&=-2):e=0,this.vga_memory[e<<16|t]))},q.prototype.vga_memory_write=function(t,e){if(this.svga_enabled&&this.graphical_mode&&this.graphical_mode_is_linear)this.cpu.write8((t-655360|this.svga_bank_offset)+3758096384|0,e);else{var r=this.miscellaneous_graphics_register>>2&3;t-=G[r],0>t||t>=Y[r]?(u(t),u(e)):this.graphical_mode?this.vga_memory_write_graphical(t,e):this.plane_write_bm&3&&this.vga_memory_write_text_mode(t,e)}},q.prototype.vga_memory_write_graphical=function(t,e){var r=this.planar_mode&3,n=this.apply_feed(this.planar_bitmap),a=this.apply_expand(this.planar_setreset),p=this.apply_expand(this.planar_setreset_enable);switch(r){case 0:e=this.apply_rotate(e);var d=this.apply_feed(e);d=this.apply_setreset(d,p),d=this.apply_logical(d,this.latch_dword),d=this.apply_bitmask(d,n);break;case 1:d=this.latch_dword;break;case 2:d=this.apply_expand(e),d=this.apply_logical(d,this.latch_dword),d=this.apply_bitmask(d,n);break;case 3:e=this.apply_rotate(e),n&=this.apply_feed(e),d=this.apply_bitmask(a,n)}switch(e=15,this.sequencer_memory_mode&12){case 0:e=5<<(t&1),t&=-2;break;case 8:case 12:e=1<<(t&3),t&=-4}e&=this.plane_write_bm,e&1&&(this.plane0[t]=d>>0&255),e&2&&(this.plane1[t]=d>>8&255),e&4&&(this.plane2[t]=d>>16&255),e&8&&(this.plane3[t]=d>>24&255),t=this.vga_addr_to_pixel(t),this.partial_replot(t,t+7)},q.prototype.apply_feed=function(t){return t|t<<8|t<<16|t<<24},q.prototype.apply_expand=function(t){return(t&1?255:0)|(t&2?255:0)<<8|(t&4?255:0)<<16|(t&8?255:0)<<24},q.prototype.apply_rotate=function(t){return(t|t<<8)>>>(this.planar_rotate_reg&7)&255},q.prototype.apply_setreset=function(t,e){var r=this.apply_expand(this.planar_setreset);return(t|e&r)&(~e|r)},q.prototype.apply_logical=function(t,e){switch(this.planar_rotate_reg&24){case 8:return t&e;case 16:return t|e;case 24:return t^e}return t},q.prototype.apply_bitmask=function(t,e){return e&t|~e&this.latch_dword},q.prototype.text_mode_redraw=function(){var t=this.start_address<<1;let e=this.scan_line_to_screen_row(this.line_compare),r=Math.max(0,2*(2*this.offset_register-this.max_cols)),n=this.attribute_mode&8,a=n?7:15;for(var p=0;p<this.max_rows;p++){p===e&&(t=0);for(var d=0;d<this.max_cols;d++){var m=this.vga_memory[t],g=this.vga_memory[t|1],y=n&&g&128;this.bus.send("screen-put-char",[p,d,m,y,this.vga256_palette[this.dac_mask&this.dac_map[g>>4&a]],this.vga256_palette[this.dac_mask&this.dac_map[g&15]]]),t+=2}t+=r}},q.prototype.vga_memory_write_text_mode=function(t,e){this.vga_memory[t]=e;var r=Math.max(this.max_cols,2*this.offset_register);let n;if(t>>1>=this.start_address){var a=(t>>1)-this.start_address;n=a/r|0,r=a%r}else a=t>>1,n=(a/r|0)+this.scan_line_to_screen_row(this.line_compare),r=a%r;r>=this.max_cols||n>=this.max_rows||(t&1?(a=e,e=this.vga_memory[t&-2]):a=this.vga_memory[t|1],t=this.attribute_mode&8,this.bus.send("screen-put-char",[n,r,e,t&&a&128,this.vga256_palette[this.dac_mask&this.dac_map[a>>4&(t?7:15)]],this.vga256_palette[this.dac_mask&this.dac_map[a&15]]]))},q.prototype.update_cursor=function(){var t=Math.max(this.max_cols,2*this.offset_register);let e;this.cursor_address>=this.start_address?(e=(this.cursor_address-this.start_address)/t|0,t=(this.cursor_address-this.start_address)%t):(e=(this.cursor_address/t|0)+this.scan_line_to_screen_row(this.line_compare),t=this.cursor_address%t),this.bus.send("screen-update-cursor",[e,t])},q.prototype.complete_redraw=function(){this.graphical_mode?this.svga_enabled?this.cpu.svga_mark_dirty():(this.diff_addr_min=0,this.diff_addr_max=524288):this.text_mode_redraw()},q.prototype.complete_replot=function(){this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=524288,this.complete_redraw())},q.prototype.partial_redraw=function(t,e){t<this.diff_addr_min&&(this.diff_addr_min=t),e>this.diff_addr_max&&(this.diff_addr_max=e)},q.prototype.partial_replot=function(t,e){t<this.diff_plot_min&&(this.diff_plot_min=t),e>this.diff_plot_max&&(this.diff_plot_max=e),this.partial_redraw(t,e)},q.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0},q.prototype.destroy=function(){},q.prototype.vga_bytes_per_line=function(){var t=this.offset_register<<2;return this.underline_location_register&64?t<<=1:this.crtc_mode&64&&(t>>>=1),t},q.prototype.vga_addr_shift_count=function(){var t=128+(~this.underline_location_register&this.crtc_mode&64);return t-=this.underline_location_register&64,t-=this.attribute_mode&64,t>>>6},q.prototype.vga_addr_to_pixel=function(t){var e=this.vga_addr_shift_count();if(~this.crtc_mode&3){var r=t-this.start_address;r&=this.crtc_mode<<13|-24577,r<<=e;var n=r/this.virtual_width|0;switch(r%=this.virtual_width,this.crtc_mode&3){case 2:n=n<<1|t>>13&1;break;case 1:n=n<<1|t>>14&1;break;case 0:n=n<<2|t>>13&3}return n*this.virtual_width+r+(this.start_address<<e)}return t<<e},q.prototype.scan_line_to_screen_row=function(t){return this.max_scan_line&128&&(t>>>=1),t=Math.ceil(t/(1+(this.max_scan_line&31))),this.crtc_mode&1||(t<<=1),this.crtc_mode&2||(t<<=1),t},q.prototype.set_size_text=function(t,e){this.max_cols=t,this.max_rows=e,this.bus.send("screen-set-size-text",[t,e])},q.prototype.set_size_graphical=function(t,e,r,n,a){if(n=Math.max(n,1),a=Math.max(a,1),!this.stats.is_graphical||this.stats.bpp!==r||this.screen_width!==t||this.screen_height!==e||this.virtual_width!==n||this.virtual_height!==a){if(this.screen_width=t,this.screen_height=e,this.virtual_width=n,this.virtual_height=a,this.stats.bpp=r,this.stats.is_graphical=!0,this.stats.res_x=t,this.stats.res_y=e,typeof ImageData<"u"){let p=n*a,d=this.cpu.svga_allocate_dest_buffer(p)>>>0;this.dest_buffet_offset=d,this.image_data=new ImageData(new Uint8ClampedArray(this.cpu.wasm_memory.buffer,d,4*p),n,a),this.cpu.svga_mark_dirty()}this.bus.send("screen-set-size-graphical",[t,e,n,a,r])}},q.prototype.update_vga_size=function(){if(!this.svga_enabled){var t=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),e=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(t&&e)if(this.graphical_mode){t<<=3;var r=this.offset_register<<4;this.attribute_mode&64&&(t>>>=1,r>>>=1),e=this.scan_line_to_screen_row(e);var n=Y[0];let a=this.vga_bytes_per_line();this.set_size_graphical(t,e,8,r,a?Math.ceil(n/a):e),this.update_vertical_retrace(),this.update_layers()}else this.max_scan_line&128&&(e>>>=1),r=e/(1+(this.max_scan_line&31))|0,t&&r&&this.set_size_text(t,r)}},q.prototype.update_layers=function(){if(this.graphical_mode||this.text_mode_redraw(),this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width)if(!this.palette_source||this.clocking_mode&32)this.layers=[],this.bus.send("screen-clear");else{var t=this.start_address_latched,e=this.horizontal_panning;this.attribute_mode&64&&(e>>>=1);var r=this.preset_row_scan>>5&3,n=this.vga_addr_to_pixel(t+r);t=n/this.virtual_width|0;var a=n%this.virtual_width+e;n=this.scan_line_to_screen_row(1+this.line_compare),n=Math.min(n,this.screen_height);var p=this.screen_height-n;this.layers=[],a=-a;for(var d=0;a<this.screen_width;a+=this.virtual_width,d++)this.layers.push({image_data:this.image_data,screen_x:a,screen_y:0,buffer_x:0,buffer_y:t+d,buffer_width:this.virtual_width,buffer_height:n});for(t=0,this.attribute_mode&32||(t=this.vga_addr_to_pixel(r)+e),a=-t,d=0;a<this.screen_width;a+=this.virtual_width,d++)this.layers.push({image_data:this.image_data,screen_x:a,screen_y:n,buffer_x:0,buffer_y:d,buffer_width:this.virtual_width,buffer_height:p})}},q.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8,this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())},q.prototype.update_cursor_scanline=function(){var t=this.max_scan_line&31;let e=Math.min(t,this.cursor_scanline_start&31);t=Math.min(t,this.cursor_scanline_end&31),this.bus.send("screen-update-cursor-scanline",[e,t,!(this.cursor_scanline_start&32)&&e<t])},q.prototype.port3C0_write=function(t){if(this.attribute_controller_index===-1)u(t),this.attribute_controller_index=t&31,u(this.attribute_controller_index),this.palette_source!==(t&32)&&(this.palette_source=t&32,this.update_layers());else{if(16>this.attribute_controller_index)u(this.attribute_controller_index),u(t),this.dac_map[this.attribute_controller_index]=t,this.attribute_mode&64||this.complete_redraw();else switch(this.attribute_controller_index){case 16:if(u(t),this.attribute_mode!==t){var e=this.attribute_mode;this.attribute_mode=t;var r=0<(t&1);this.svga_enabled||this.graphical_mode===r||(this.graphical_mode=r,this.bus.send("screen-set-mode",this.graphical_mode)),(e^t)&64&&this.complete_replot(),this.update_vga_size(),this.complete_redraw()}break;case 18:u(t),this.color_plane_enable!==t&&(this.color_plane_enable=t,this.complete_redraw());break;case 19:u(t),this.horizontal_panning!==t&&(this.horizontal_panning=t&15,this.update_layers());break;case 20:u(t),this.color_select!==t&&(this.color_select=t,this.complete_redraw());break;default:u(this.attribute_controller_index),u(t)}this.attribute_controller_index=-1}},q.prototype.port3C0_read=function(){return(this.attribute_controller_index|this.palette_source)&255},q.prototype.port3C0_read16=function(){return this.port3C0_read()|this.port3C1_read()<<8&65280},q.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return u(this.attribute_controller_index),u(this.dac_map[this.attribute_controller_index]),this.dac_map[this.attribute_controller_index]&255;switch(this.attribute_controller_index){case 16:return u(this.attribute_mode),this.attribute_mode;case 18:return u(this.color_plane_enable),this.color_plane_enable;case 19:return u(this.horizontal_panning),this.horizontal_panning;case 20:return u(this.color_select),this.color_select;default:u(this.attribute_controller_index)}return 255},q.prototype.port3C2_write=function(t){u(t),this.miscellaneous_output_register=t},q.prototype.port3C4_write=function(t){this.sequencer_index=t},q.prototype.port3C4_read=function(){return this.sequencer_index},q.prototype.port3C5_write=function(t){switch(this.sequencer_index){case 1:u(t);var e=this.clocking_mode;this.clocking_mode=t,(e^t)&32&&this.update_layers();break;case 2:u(t),this.plane_write_bm=t;break;case 4:u(t),this.sequencer_memory_mode=t;break;default:u(this.sequencer_index),u(t)}},q.prototype.port3C5_read=function(){switch(u(this.sequencer_index),this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0},q.prototype.port3C6_write=function(t){this.dac_mask=t},q.prototype.port3C6_read=function(){return this.dac_mask},q.prototype.port3C7_write=function(t){u(t),this.dac_color_index_read=3*t,this.dac_state&=0},q.prototype.port3C7_read=function(){return this.dac_state},q.prototype.port3C8_write=function(t){this.dac_color_index_write=3*t,this.dac_state|=3},q.prototype.port3C8_read=function(){return this.dac_color_index_write/3&255},q.prototype.port3C9_write=function(t){var e=this.dac_color_index_write/3|0,r=this.dac_color_index_write%3,n=this.vga256_palette[e];if(!(this.dispi_enable_value&32)){t&=63;let a=t&1;t=t<<2|a<<1|a}r===0?n=n&-16711681|t<<16:r===1?n=n&-65281|t<<8:(n=n&-256|t,u(e),u(n)),this.vga256_palette[e]!==n&&(this.vga256_palette[e]=n,this.complete_redraw()),this.dac_color_index_write++},q.prototype.port3C9_read=function(){var t=this.vga256_palette[this.dac_color_index_read/3|0]>>8*(2-this.dac_color_index_read%3)&255;return this.dac_color_index_read++,this.dispi_enable_value&32?t:t>>2},q.prototype.port3CC_read=function(){return this.miscellaneous_output_register},q.prototype.port3CE_write=function(t){this.graphics_index=t},q.prototype.port3CE_read=function(){return this.graphics_index},q.prototype.port3CF_write=function(t){switch(this.graphics_index){case 0:this.planar_setreset=t,u(t);break;case 1:this.planar_setreset_enable=t,u(t);break;case 2:this.color_compare=t,u(t);break;case 3:this.planar_rotate_reg=t,u(t);break;case 4:this.plane_read=t,u(t);break;case 5:var e=this.planar_mode;this.planar_mode=t,u(t),(e^t)&96&&this.complete_replot();break;case 6:u(t),this.miscellaneous_graphics_register!==t&&(this.miscellaneous_graphics_register=t,this.update_vga_size());break;case 7:this.color_dont_care=t,u(t);break;case 8:this.planar_bitmap=t,u(t);break;default:u(this.graphics_index),u(t)}},q.prototype.port3CF_read=function(){switch(u(this.graphics_index),this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0},q.prototype.port3D4_write=function(t){this.index_crtc=t},q.prototype.port3D4_read=function(){return this.index_crtc},q.prototype.port3D5_write=function(t){switch(this.index_crtc){case 1:u(t),this.horizontal_display_enable_end!==t&&(this.horizontal_display_enable_end=t,this.update_vga_size());break;case 2:this.horizontal_blank_start!==t&&(this.horizontal_blank_start=t,this.update_vga_size());break;case 7:u(t);var e=this.vertical_display_enable_end;this.vertical_display_enable_end&=255,this.vertical_display_enable_end=this.vertical_display_enable_end|t<<3&512|t<<7&256,e!==this.vertical_display_enable_end&&this.update_vga_size(),this.line_compare=this.line_compare&767|t<<4&256,e=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&767|t<<5&256,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 8:u(t),this.preset_row_scan=t,this.update_layers();break;case 9:u(t),this.max_scan_line=t,this.line_compare=this.line_compare&511|t<<3&512,e=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&511|t<<4&512,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_cursor_scanline(),this.update_layers();break;case 10:u(t),this.cursor_scanline_start=t,this.update_cursor_scanline();break;case 11:u(t),this.cursor_scanline_end=t,this.update_cursor_scanline();break;case 12:(this.start_address>>8&255)!==t&&(this.start_address=this.start_address&255|t<<8,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),u(t),u(this.start_address,4);break;case 13:(this.start_address&255)!==t&&(this.start_address=this.start_address&65280|t,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),u(t),u(this.start_address,4);break;case 14:u(t),this.cursor_address=this.cursor_address&255|t<<8,this.update_cursor();break;case 15:u(t),this.cursor_address=this.cursor_address&65280|t,this.update_cursor();break;case 18:u(t),(this.vertical_display_enable_end&255)!==t&&(this.vertical_display_enable_end=this.vertical_display_enable_end&768|t,this.update_vga_size());break;case 19:u(t),this.offset_register!==t&&(this.offset_register=t,this.update_vga_size(),~this.crtc_mode&3&&this.complete_replot());break;case 20:u(t),this.underline_location_register!==t&&(e=this.underline_location_register,this.underline_location_register=t,this.update_vga_size(),(e^t)&64&&this.complete_replot());break;case 21:u(t),(this.vertical_blank_start&255)!==t&&(this.vertical_blank_start=this.vertical_blank_start&768|t,this.update_vga_size());break;case 23:u(t),this.crtc_mode!==t&&(e=this.crtc_mode,this.crtc_mode=t,this.update_vga_size(),(e^t)&67&&this.complete_replot());break;case 24:u(t),this.line_compare=this.line_compare&768|t,this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=t),u(this.index_crtc),u(t)}},q.prototype.port3D5_read=function(){switch(u(this.index_crtc),this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;case 12:return this.start_address&255;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return this.cursor_address&255;case 18:return this.vertical_display_enable_end&255;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return this.vertical_blank_start&255;case 23:return this.crtc_mode;case 24:return this.line_compare&255}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0},q.prototype.port3DA_read=function(){var t=this.port_3DA_value;return this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(this.port_3DA_value&1&&(this.port_3DA_value^=8),this.port_3DA_value^=1),this.attribute_controller_index=-1,t},q.prototype.port1CE_write=function(t){this.dispi_index=t},q.prototype.port1CF_write=function(t){switch(u(this.dispi_index),u(t),this.dispi_index){case 0:45248<=t&&45253>=t?this.svga_version=t:u(t);break;case 1:this.svga_width=t,2560<this.svga_width&&(this.svga_width=2560);break;case 2:this.svga_height=t,1600<this.svga_height&&(this.svga_height=1600);break;case 3:this.svga_bpp=t;break;case 4:this.svga_enabled=(t&1)===1,this.dispi_enable_value=t;break;case 5:u(t<<16),this.svga_bank_offset=t<<16;break;case 9:let e=t*this.svga_width;u(e),u(t),this.svga_offset_y!==t&&(this.svga_offset_y=t,this.svga_offset=e,this.complete_redraw());break;default:u(this.dispi_index)}!this.svga_enabled||this.svga_width&&this.svga_height||(this.svga_enabled=!1),this.svga_enabled&&this.dispi_index===4&&(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.bus.send("screen-set-mode",!0),this.graphical_mode_is_linear=this.graphical_mode=!0),this.svga_enabled||(this.svga_bank_offset=0),this.update_layers()},q.prototype.port1CF_read=function(){return u(this.dispi_index),this.svga_register_read(this.dispi_index)},q.prototype.svga_register_read=function(t){switch(t){case 0:return this.svga_version;case 1:return this.dispi_enable_value&2?2560:this.svga_width;case 2:return this.dispi_enable_value&2?1600:this.svga_height;case 3:return this.dispi_enable_value&2?32:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return 0;case 9:return this.svga_offset_y;case 10:return this.vga_memory_size/65536|0;default:u(this.dispi_index)}return 255},q.prototype.vga_replot=function(){for(var t=this.diff_plot_min&-16,e=Math.min(this.diff_plot_max|15,524287),r=this.vga_addr_shift_count(),n=~this.crtc_mode&3,a=this.planar_mode&96,p=this.attribute_mode&64;t<=e;){var d=t>>>r;if(n){var m=t/this.virtual_width|0,g=t-this.virtual_width*m;switch(n){case 1:d=(m&1)<<13,m>>>=1;break;case 2:d=(m&1)<<14,m>>>=1;break;case 3:d=(m&3)<<13,m>>>=2}d|=(m*this.virtual_width+g>>>r)+this.start_address}m=this.plane0[d],g=this.plane1[d];var y=this.plane2[d],b=this.plane3[d];switch(d=new Uint8Array(8),a){case 0:m<<=0,g<<=1,y<<=2,b<<=3;for(var E=7;0<=E;E--)d[7-E]=m>>E&1|g>>E&2|y>>E&4|b>>E&8;break;case 32:d[0]=m>>6&3|y>>4&12,d[1]=m>>4&3|y>>2&12,d[2]=m>>2&3|y>>0&12,d[3]=m>>0&3|y<<2&12,d[4]=g>>6&3|b>>4&12,d[5]=g>>4&3|b>>2&12,d[6]=g>>2&3|b>>0&12,d[7]=g>>0&3|b<<2&12;break;case 64:case 96:d[0]=m>>4&15,d[1]=m>>0&15,d[2]=g>>4&15,d[3]=g>>0&15,d[4]=y>>4&15,d[5]=y>>0&15,d[6]=b>>4&15,d[7]=b>>0&15}if(p)for(m=E=0;4>E;E++,t++,m+=2)this.pixel_buffer[t]=d[m]<<4|d[m+1];else for(E=0;8>E;E++,t++)this.pixel_buffer[t]=d[E]}},q.prototype.vga_redraw=function(){var t=this.diff_addr_min,e=Math.min(this.diff_addr_max,524287);let r=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.virtual_width*this.virtual_height);var n=255,a=0;if(this.attribute_mode&128&&(n&=207,a|=this.color_select<<4&48),this.attribute_mode&64)for(;t<=e;t++){var p=this.pixel_buffer[t]&n|a;p=this.vga256_palette[p],r[t]=p&65280|p<<16|p>>16|4278190080}else for(n&=63,a|=this.color_select<<4&192;t<=e;t++)p=this.dac_map[this.pixel_buffer[t]&this.color_plane_enable]&n|a,p=this.vga256_palette[p],r[t]=p&65280|p<<16|p>>16|4278190080},q.prototype.screen_fill_buffer=function(){if(this.graphical_mode){if(this.image_data.data.byteLength===0){var t=new Uint8ClampedArray(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,4*this.virtual_width*this.virtual_height);this.image_data=new ImageData(t,this.virtual_width,this.virtual_height),this.update_layers()}if(this.svga_enabled){t=0;let n=this.svga_height;if(this.svga_bpp===8){let a=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.screen_width*this.screen_height),p=new Uint8Array(this.cpu.wasm_memory.buffer,this.svga_memory.byteOffset,this.vga_memory_size);for(var e=0;e<a.length;e++){var r=this.vga256_palette[p[e]];a[e]=r&65280|r<<16|r>>16|4278190080}}else this.cpu.svga_fill_pixel_buffer(this.svga_bpp,this.svga_offset),e=this.svga_bpp===15?2:this.svga_bpp/8,t=((this.cpu.svga_dirty_bitmap_min_offset[0]/e|0)-this.svga_offset)/this.svga_width|0,n=(((this.cpu.svga_dirty_bitmap_max_offset[0]/e|0)-this.svga_offset)/this.svga_width|0)+1;t<n&&(t=Math.max(t,0),n=Math.min(n,this.svga_height),this.bus.send("screen-fill-buffer-end",[{image_data:this.image_data,screen_x:0,screen_y:t,buffer_x:0,buffer_y:t,buffer_width:this.svga_width,buffer_height:n-t}]))}else this.vga_replot(),this.vga_redraw(),this.bus.send("screen-fill-buffer-end",this.layers);this.reset_diffs()}this.update_vertical_retrace()};function tt(t,e){this.cpu=t,this.bus=e,this.use_mouse=this.enable_mouse_stream=!1,this.have_mouse=!0,this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0,this.have_keyboard=!0,this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1,this.kbd_buffer=new w(1024),this.last_port60_byte=0,this.sample_rate=100,this.mouse_id=this.mouse_detect_state=0,this.mouse_reset_workaround=!1,this.wheel_movement=0,this.resolution=4,this.scaling2=!1,this.last_mouse_packet=-1,this.mouse_buffer=new w(1024),this.next_byte_is_aux=this.next_byte_is_ready=!1,this.bus.register("keyboard-code",function(r){this.kbd_send_code(r)},this),this.bus.register("mouse-click",function(r){this.mouse_send_click(r[0],r[1],r[2])},this),this.bus.register("mouse-delta",function(r){this.mouse_send_delta(r[0],r[1])},this),this.bus.register("mouse-wheel",function(r){this.wheel_movement-=r[0],this.wheel_movement-=2*r[1],this.wheel_movement=Math.min(7,Math.max(-8,this.wheel_movement)),this.send_mouse_packet(0,0)},this),this.command_register=5,this.controller_output_port=0,this.read_controller_output_port=this.read_command_register=this.read_output_register=!1,t.io.register_read(96,this,this.port60_read),t.io.register_read(100,this,this.port64_read),t.io.register_write(96,this,this.port60_write),t.io.register_write(100,this,this.port64_write)}tt.prototype.get_state=function(){var t=[];return t[0]=this.enable_mouse_stream,t[1]=this.use_mouse,t[2]=this.have_mouse,t[3]=this.mouse_delta_x,t[4]=this.mouse_delta_y,t[5]=this.mouse_clicks,t[6]=this.have_keyboard,t[7]=this.enable_keyboard_stream,t[8]=this.next_is_mouse_command,t[9]=this.next_read_sample,t[10]=this.next_read_led,t[11]=this.next_handle_scan_code_set,t[12]=this.next_read_rate,t[13]=this.next_read_resolution,t[15]=this.last_port60_byte,t[16]=this.sample_rate,t[17]=this.resolution,t[18]=this.scaling2,t[20]=this.command_register,t[21]=this.read_output_register,t[22]=this.read_command_register,t[23]=this.controller_output_port,t[24]=this.read_controller_output_port,t[25]=this.mouse_id,t[26]=this.mouse_detect_state,t[27]=this.mouse_reset_workaround,t},tt.prototype.set_state=function(t){this.enable_mouse_stream=t[0],this.use_mouse=t[1],this.have_mouse=t[2],this.mouse_delta_x=t[3],this.mouse_delta_y=t[4],this.mouse_clicks=t[5],this.have_keyboard=t[6],this.enable_keyboard_stream=t[7],this.next_is_mouse_command=t[8],this.next_read_sample=t[9],this.next_read_led=t[10],this.next_handle_scan_code_set=t[11],this.next_read_rate=t[12],this.next_read_resolution=t[13],this.last_port60_byte=t[15],this.sample_rate=t[16],this.resolution=t[17],this.scaling2=t[18],this.command_register=t[20],this.read_output_register=t[21],this.read_command_register=t[22],this.controller_output_port=t[23],this.read_controller_output_port=t[24],this.mouse_id=t[25]||0,this.mouse_detect_state=t[26]||0,this.mouse_reset_workaround=t[27]||!1,this.next_byte_is_aux=this.next_byte_is_ready=!1,this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.bus.send("mouse-enable",this.use_mouse)},tt.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())},tt.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0,this.command_register&2&&(this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))},tt.prototype.kbd_irq=function(){this.next_byte_is_ready=!0,this.next_byte_is_aux=!1,this.command_register&1&&(this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))},tt.prototype.kbd_send_code=function(t){this.enable_keyboard_stream&&(u(t),this.kbd_buffer.push(t),this.raise_irq())},tt.prototype.mouse_send_delta=function(t,e){if(this.have_mouse&&this.use_mouse){var r=this.resolution*this.sample_rate/80;this.mouse_delta_x+=t*r,this.mouse_delta_y+=e*r,this.enable_mouse_stream&&(t=this.mouse_delta_x|0,e=this.mouse_delta_y|0,t||e)&&(Date.now(),this.mouse_delta_x-=t,this.mouse_delta_y-=e,this.send_mouse_packet(t,e))}},tt.prototype.mouse_send_click=function(t,e,r){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=t|r<<1|e<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))},tt.prototype.send_mouse_packet=function(t,e){var r=(0>e)<<5|(0>t)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now(),this.mouse_buffer.push(r),this.mouse_buffer.push(t),this.mouse_buffer.push(e),this.mouse_id===4?(this.mouse_buffer.push(0|this.wheel_movement&15),this.wheel_movement=0):this.mouse_id===3&&(this.mouse_buffer.push(this.wheel_movement&255),this.wheel_movement=0),this.raise_irq()},tt.prototype.apply_scaling2=function(t){var e=t>>31;switch(Math.abs(t)){case 0:case 1:case 3:return t;case 2:return e;case 4:return 6*e;case 5:return 9*e;default:return t<<1}},tt.prototype.port60_read=function(){return this.next_byte_is_ready=!1,!this.kbd_buffer.length&&!this.mouse_buffer.length?this.last_port60_byte:(this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift()):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift()),u(this.last_port60_byte),(this.kbd_buffer.length||this.mouse_buffer.length)&&this.raise_irq(),this.last_port60_byte)},tt.prototype.port64_read=function(){var t=16;return this.next_byte_is_ready&&(t|=1),this.next_byte_is_aux&&(t|=32),u(t),t},tt.prototype.port60_write=function(t){if(u(t),this.read_command_register)this.command_register=t,this.read_command_register=!1,u(this.command_register);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(t),this.mouse_irq();else if(this.next_read_sample){switch(this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=t,this.mouse_detect_state){case-1:t===60?(this.mouse_reset_workaround=!0,this.mouse_detect_state=0):(this.mouse_reset_workaround=!1,this.mouse_detect_state=t===200?1:0);break;case 0:t===200&&(this.mouse_detect_state=1);break;case 1:this.mouse_detect_state=t===100?2:t===200?3:0;break;case 2:t===80&&(this.mouse_id=3),this.mouse_detect_state=-1;break;case 3:t===80&&(this.mouse_id=4),this.mouse_detect_state=-1}u(t),u(this.mouse_id),this.sample_rate||(this.sample_rate=100),this.mouse_irq()}else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.resolution=3<t?4:1<<t,this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=!1,this.kbd_buffer.push(250),this.kbd_irq(),t||this.kbd_buffer.push(1);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,u(t),this.have_mouse){switch(this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.mouse_buffer.push(250),t){case 230:this.scaling2=!1;break;case 231:this.scaling2=!0;break;case 232:this.next_read_resolution=!0;break;case 233:this.send_mouse_packet(0,0);break;case 235:this.send_mouse_packet(0,0);break;case 242:u(this.mouse_id),this.mouse_buffer.push(this.mouse_id),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0,this.raise_irq();break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0,this.bus.send("mouse-enable",!0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4;break;case 255:this.mouse_buffer.push(170),this.mouse_buffer.push(0),this.use_mouse=!0,this.bus.send("mouse-enable",!0),this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4,this.mouse_reset_workaround||(this.mouse_id=0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:u(t)}this.mouse_irq()}}else if(this.read_controller_output_port)this.read_controller_output_port=!1,this.controller_output_port=t;else{switch(u(t),this.mouse_buffer.clear(),this.kbd_buffer.clear(),this.kbd_buffer.push(250),t){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171),this.kbd_buffer.push(131);break;case 243:this.next_read_rate=!0;break;case 244:this.enable_keyboard_stream=!0;break;case 245:this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear(),this.kbd_buffer.push(250),this.kbd_buffer.push(170),this.kbd_buffer.push(0);break;default:u(t)}this.kbd_irq()}},tt.prototype.port64_write=function(t){switch(u(t),t){case 32:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(this.command_register),this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 209:this.read_controller_output_port=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:this.command_register|=32;break;case 168:this.command_register&=-33;break;case 169:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 170:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(85),this.kbd_irq();break;case 171:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 173:this.command_register|=16;break;case 174:this.command_register&=-17;break;case 254:this.cpu.reboot_internal();break;default:u(t)}};function ot(t){this.cpu=t,this.cmos_index=0,this.cmos_data=new Uint8Array(128),this.last_update=this.rtc_time=Date.now(),this.next_interrupt_alarm=this.next_interrupt=0,this.periodic_interrupt=!1,this.periodic_interrupt_time=.9765625,this.cmos_a=38,this.cmos_b=2,this.nmi_disabled=this.cmos_c=0,t.io.register_write(112,this,function(e){this.cmos_index=e&127,this.nmi_disabled=e>>7}),t.io.register_write(113,this,this.cmos_port_write),t.io.register_read(113,this,this.cmos_port_read)}ot.prototype.get_state=function(){var t=[];return t[0]=this.cmos_index,t[1]=this.cmos_data,t[2]=this.rtc_time,t[3]=this.last_update,t[4]=this.next_interrupt,t[5]=this.next_interrupt_alarm,t[6]=this.periodic_interrupt,t[7]=this.periodic_interrupt_time,t[8]=this.cmos_a,t[9]=this.cmos_b,t[10]=this.cmos_c,t[11]=this.nmi_disabled,t},ot.prototype.set_state=function(t){this.cmos_index=t[0],this.cmos_data=t[1],this.rtc_time=t[2],this.last_update=t[3],this.next_interrupt=t[4],this.next_interrupt_alarm=t[5],this.periodic_interrupt=t[6],this.periodic_interrupt_time=t[7],this.cmos_a=t[8],this.cmos_b=t[9],this.cmos_c=t[10],this.nmi_disabled=t[11]},ot.prototype.timer=function(t){t=Date.now(),this.rtc_time+=t-this.last_update,this.last_update=t,this.periodic_interrupt&&this.next_interrupt<t?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((t-this.next_interrupt)/this.periodic_interrupt_time)):this.next_interrupt_alarm&&this.next_interrupt_alarm<t&&(this.cpu.device_raise_irq(8),this.cmos_c|=160,this.next_interrupt_alarm=0);let e=100;return this.periodic_interrupt&&this.next_interrupt&&(e=Math.min(e,Math.max(0,this.next_interrupt-t))),this.next_interrupt_alarm&&(e=Math.min(e,Math.max(0,this.next_interrupt_alarm-t))),e},ot.prototype.bcd_pack=function(t){for(var e=0,r=0,n;t;)n=t%10,r|=n<<4*e,e++,t=(t-n)/10;return r},ot.prototype.bcd_unpack=function(t){return(t&15)+10*(t>>4&15)},ot.prototype.encode_time=function(t){return this.cmos_b&4?t:this.bcd_pack(t)},ot.prototype.decode_time=function(t){return this.cmos_b&4?t:this.bcd_unpack(t)},ot.prototype.cmos_port_read=function(){var t=this.cmos_index;switch(t){case 0:return u(this.encode_time(new Date(this.rtc_time).getUTCSeconds())),this.encode_time(new Date(this.rtc_time).getUTCSeconds());case 2:return u(this.encode_time(new Date(this.rtc_time).getUTCMinutes())),this.encode_time(new Date(this.rtc_time).getUTCMinutes());case 4:return u(this.encode_time(new Date(this.rtc_time).getUTCHours())),this.encode_time(new Date(this.rtc_time).getUTCHours());case 6:return u(this.encode_time(new Date(this.rtc_time).getUTCDay()+1)),this.encode_time(new Date(this.rtc_time).getUTCDay()+1);case 7:return u(this.encode_time(new Date(this.rtc_time).getUTCDate())),this.encode_time(new Date(this.rtc_time).getUTCDate());case 8:return u(this.encode_time(new Date(this.rtc_time).getUTCMonth()+1)),this.encode_time(new Date(this.rtc_time).getUTCMonth()+1);case 9:return u(this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100)),this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100);case 10:return 999<=_.microtick()%1e3?this.cmos_a|128:this.cmos_a;case 11:return this.cmos_b;case 12:return this.cpu.device_lower_irq(8),t=this.cmos_c,this.cmos_c&=-241,t;case 13:return 0;case 50:case 55:return u(this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0)),this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0);default:return u(t),this.cmos_data[this.cmos_index]}},ot.prototype.cmos_port_write=function(t){switch(this.cmos_index){case 10:this.cmos_a=t&127,this.periodic_interrupt_time=1e3/(32768>>(this.cmos_a&15)-1),u(this.cmos_a,2);break;case 11:if(this.cmos_b=t,this.cmos_b&64&&(this.next_interrupt=Date.now()),this.cmos_b&32){t=new Date;let e=this.decode_time(this.cmos_data[1]),r=this.decode_time(this.cmos_data[3]),n=this.decode_time(this.cmos_data[5]);this.next_interrupt_alarm=+new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),n,r,e))}u(this.cmos_b,2);break;case 1:case 3:case 5:this.cmos_write(this.cmos_index,t);break;default:u(this.cmos_index),u(t)}this.periodic_interrupt=(this.cmos_b&64)===64&&0<(this.cmos_a&15)},ot.prototype.cmos_read=function(t){return this.cmos_data[t]},ot.prototype.cmos_write=function(t,e){u(t),u(e),this.cmos_data[t]=e};function at(t,e,r){switch(this.bus=r,this.cpu=t,this.ints=4,this.line_control=this.baud_rate=0,this.lsr=96,this.ier=this.fifo_control=0,this.iir=1,this.irq=this.scratch_register=this.modem_status=this.modem_control=0,this.input=[],this.current_line="",e){case 1016:this.com=0,this.irq=4;break;case 760:this.com=1,this.irq=3;break;case 1e3:this.com=2,this.irq=4;break;case 744:this.irq=this.com=3;break;default:""+u(e),this.com=0,this.irq=4}this.bus.register("serial"+this.com+"-input",function(n){this.data_received(n)},this),this.bus.register("serial"+this.com+"-modem-status-input",function(n){this.set_modem_status(n)},this),this.bus.register("serial"+this.com+"-carrier-detect-input",function(n){this.set_modem_status(n?this.modem_status|136:this.modem_status&-137)},this),this.bus.register("serial"+this.com+"-ring-indicator-input",function(n){this.set_modem_status(n?this.modem_status|68:this.modem_status&-69)},this),this.bus.register("serial"+this.com+"-data-set-ready-input",function(n){this.set_modem_status(n?this.modem_status|34:this.modem_status&-35)},this),this.bus.register("serial"+this.com+"-clear-to-send-input",function(n){this.set_modem_status(n?this.modem_status|17:this.modem_status&-18)},this),t=t.io,t.register_write(e,this,function(n){this.write_data(n)},function(n){this.write_data(n&255),this.write_data(n>>8)}),t.register_write(e|1,this,function(n){this.line_control&128?(this.baud_rate=this.baud_rate&255|n<<8,u(this.baud_rate)):(!(this.ier&2)&&n&2&&this.ThrowInterrupt(2),this.ier=n&15,u(n),this.CheckInterrupt())}),t.register_read(e,this,function(){if(this.line_control&128)return this.baud_rate&255;let n=0;return this.input.length!==0&&(n=this.input.shift(),u(n)),this.input.length===0&&(this.lsr&=-2,this.ClearInterrupt(12),this.ClearInterrupt(4)),n}),t.register_read(e|1,this,function(){return this.line_control&128?this.baud_rate>>8:this.ier&15}),t.register_read(e|2,this,function(){var n=this.iir&15;return u(this.iir),this.iir===2&&this.ClearInterrupt(2),this.fifo_control&1&&(n|=192),n}),t.register_write(e|2,this,function(n){u(n),this.fifo_control=n}),t.register_read(e|3,this,function(){return u(this.line_control),this.line_control}),t.register_write(e|3,this,function(n){u(n),this.line_control=n}),t.register_read(e|4,this,function(){return this.modem_control}),t.register_write(e|4,this,function(n){u(n),this.modem_control=n}),t.register_read(e|5,this,function(){return u(this.lsr),this.lsr}),t.register_write(e|5,this,function(){}),t.register_read(e|6,this,function(){return u(this.modem_status),this.modem_status&=240}),t.register_write(e|6,this,function(n){u(n),this.set_modem_status(n)}),t.register_read(e|7,this,function(){return this.scratch_register}),t.register_write(e|7,this,function(n){this.scratch_register=n})}at.prototype.get_state=function(){var t=[];return t[0]=this.ints,t[1]=this.baud_rate,t[2]=this.line_control,t[3]=this.lsr,t[4]=this.fifo_control,t[5]=this.ier,t[6]=this.iir,t[7]=this.modem_control,t[8]=this.modem_status,t[9]=this.scratch_register,t[10]=this.irq,t},at.prototype.set_state=function(t){this.ints=t[0],this.baud_rate=t[1],this.line_control=t[2],this.lsr=t[3],this.fifo_control=t[4],this.ier=t[5],this.iir=t[6],this.modem_control=t[7],this.modem_status=t[8],this.scratch_register=t[9],this.irq=t[10]},at.prototype.CheckInterrupt=function(){this.ints&4096&&this.ier&1?(this.iir=12,this.cpu.device_raise_irq(this.irq)):this.ints&16&&this.ier&1?(this.iir=4,this.cpu.device_raise_irq(this.irq)):this.ints&4&&this.ier&2?(this.iir=2,this.cpu.device_raise_irq(this.irq)):this.ints&1&&this.ier&8?(this.iir=0,this.cpu.device_raise_irq(this.irq)):(this.iir=1,this.cpu.device_lower_irq(this.irq))},at.prototype.ThrowInterrupt=function(t){this.ints|=1<<t,this.CheckInterrupt()},at.prototype.ClearInterrupt=function(t){this.ints&=~(1<<t),this.CheckInterrupt()},at.prototype.data_received=function(t){u(t),this.input.push(t),this.lsr|=1,this.fifo_control&1?this.ThrowInterrupt(12):this.ThrowInterrupt(4)},at.prototype.write_data=function(t){this.line_control&128?this.baud_rate=this.baud_rate&-256|t:(u(t),this.ThrowInterrupt(2),this.bus.send("serial"+this.com+"-output-byte",t))},at.prototype.set_modem_status=function(t){u(t);let e=this.modem_status&15,r=(this.modem_status^t)>>4;this.modem_status=t,this.modem_status=this.modem_status|r|e};function W(t){this.cpu=t;var e=t.io;t.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"}),this.timer_imprecision_offset=this.timer_last_value=0,this.status=1,this.pm1_enable=this.pm1_status=0,this.last_timer=this.get_timer(_.microtick()),this.gpe=new Uint8Array(4),e.register_read(45056,this,void 0,function(){return this.pm1_status}),e.register_write(45056,this,void 0,function(r){u(r,4),this.pm1_status&=~r}),e.register_read(45058,this,void 0,function(){return this.pm1_enable}),e.register_write(45058,this,void 0,function(r){u(r),this.pm1_enable=r}),e.register_read(45060,this,void 0,function(){return this.status}),e.register_write(45060,this,void 0,function(r){u(r),this.status=r}),e.register_read(45064,this,void 0,void 0,function(){return this.get_timer(_.microtick())&16777215}),e.register_read(45024,this,function(){return this.gpe[0]}),e.register_read(45025,this,function(){return this.gpe[1]}),e.register_read(45026,this,function(){return this.gpe[2]}),e.register_read(45027,this,function(){return this.gpe[3]}),e.register_write(45024,this,function(r){u(r),this.gpe[0]=r}),e.register_write(45025,this,function(r){u(r),this.gpe[1]=r}),e.register_write(45026,this,function(r){u(r),this.gpe[2]=r}),e.register_write(45027,this,function(r){u(r),this.gpe[3]=r})}W.prototype.timer=function(t){t=this.get_timer(t);var e=((t^this.last_timer)&8388608)!==0;return this.pm1_enable&1&&e?(this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9),this.last_timer=t,100},W.prototype.get_timer=function(t){return t=Math.round(3579.545*t),t===this.timer_last_value?3579.545>this.timer_imprecision_offset&&this.timer_imprecision_offset++:this.timer_last_value+this.timer_imprecision_offset<=t&&(this.timer_imprecision_offset=0,this.timer_last_value=t),this.timer_last_value+this.timer_imprecision_offset},W.prototype.get_state=function(){var t=[];return t[0]=this.status,t[1]=this.pm1_status,t[2]=this.pm1_enable,t[3]=this.gpe,t},W.prototype.set_state=function(t){this.status=t[0],this.pm1_status=t[1],this.pm1_enable=t[2],this.gpe=t[3]};function K(t){this.cpu=t,this.timer_divider=this.apic_id=0,this.timer_divider_shift=1,this.timer_current_count=this.timer_initial_count=0,this.next_tick=_.microtick(),this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_timer=65536,this.icr1=this.icr0=this.tpr=0,this.irr=new Int32Array(8),this.isr=new Int32Array(8),this.tmr=new Int32Array(8),this.spurious_vector=254,this.destination_format=-1,this.read_error=this.error=this.local_destination=0,t.io.mmap_register(4276092928,1048576,e=>{u(e>>>0);var r=e&3;return this.read32(e&-4)>>8*r&255},(e,r)=>{u(e),u(r)},e=>this.read32(e),(e,r)=>this.write32(e,r))}K.prototype.read32=function(t){switch(t=t-4276092928|0,t){case 32:return this.apic_id;case 48:return 327700;case 128:return this.tpr;case 208:return this.local_destination;case 224:return this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return t=t-256>>4,u(this.isr[t]>>>0,8),this.isr[t];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return t=t-384>>4,u(this.tmr[t]>>>0,8),this.tmr[t];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return t=t-512>>4,u(this.irr[t]>>>0,8),this.irr[t];case 640:return u(this.read_error>>>0,8),this.read_error;case 768:return this.icr0;case 784:return this.icr1;case 800:return this.lvt_timer;case 832:return this.lvt_perf_counter;case 848:return this.lvt_int0;case 864:return this.lvt_int1;case 880:return this.lvt_error;case 992:return this.timer_divider;case 896:return this.timer_initial_count;case 912:return u(this.timer_current_count>>>0,8),this.timer_current_count;default:return u(t),0}},K.prototype.write32=function(t,e){switch(t=t-4276092928|0,t){case 32:u(e>>>8,8),this.apic_id=e;break;case 48:u(e>>>0,8);break;case 128:this.tpr=e&255,this.check_vector();break;case 176:e=this.highest_isr(),e!==-1&&(this.register_clear_bit(this.isr,e),this.register_get_bit(this.tmr,e)&&this.cpu.devices.ioapic.remote_eoi(e),this.check_vector());break;case 208:u(e>>>0,8),this.local_destination=e&4278190080;break;case 224:u(e>>>0,8),this.destination_format=e|16777215;break;case 240:u(e>>>0,8),this.spurious_vector=e;break;case 640:u(e>>>0,8),this.read_error=this.error,this.error=0;break;case 768:t=e&255;var r=e>>8&7,n=e>>11&1,a=e>>15&1,p=e>>18&3,d=this.icr1>>>24;u(e,8),u(t,2),this.icr0=e&-4097,p===0?this.route(t,r,a,d,n):p===1?this.deliver(t,0,a):p===2&&this.deliver(t,r,a);break;case 784:u(e>>>0,8),this.icr1=e;break;case 800:u(e>>>0,8),this.lvt_timer=e;break;case 832:u(e>>>0,8),this.lvt_perf_counter=e;break;case 848:u(e>>>0,8),this.lvt_int0=e;break;case 864:u(e>>>0,8),this.lvt_int1=e;break;case 880:u(e>>>0,8),this.lvt_error=e;break;case 992:u(e>>>0,8),this.timer_divider=e,e=e&3|(e&8)>>1,this.timer_divider_shift=e===7?0:e+1;break;case 896:u(e>>>0,8),this.timer_initial_count=e>>>0,this.timer_current_count=e>>>0,this.next_tick=_.microtick(),this.timer_active=!0;break;case 912:u(e>>>0,8);break;default:u(t),u(e>>>0,8)}},K.prototype.timer=function(t){if(this.timer_current_count===0)return 100;let e=1e6/(1<<this.timer_divider_shift);return t=(t-this.next_tick)*e>>>0,this.next_tick+=t/e,this.timer_current_count-=t,0>=this.timer_current_count&&(t=this.lvt_timer&393216,t===131072?(this.timer_current_count%=this.timer_initial_count,0>=this.timer_current_count&&(this.timer_current_count+=this.timer_initial_count),!(this.lvt_timer&65536)&&this.deliver(this.lvt_timer&255,0,!1)):t===0&&(this.timer_current_count=0,!(this.lvt_timer&65536)&&this.deliver(this.lvt_timer&255,0,!1))),Math.max(0,this.timer_current_count/e)},K.prototype.route=function(t,e,r){this.deliver(t,e,r)},K.prototype.deliver=function(t,e,r){e!==5&&e!==4&&(this.register_get_bit(this.irr,t)?u(t,2):(this.register_set_bit(this.irr,t),r?this.register_set_bit(this.tmr,t):this.register_clear_bit(this.tmr,t),this.check_vector()))},K.prototype.highest_irr=function(){return this.register_get_highest_bit(this.irr)},K.prototype.highest_isr=function(){return this.register_get_highest_bit(this.isr)},K.prototype.check_vector=function(){var t=this.highest_irr();t!==-1&&(this.highest_isr()>=t||(t&240)<=(this.tpr&240)||this.cpu.handle_irqs())},K.prototype.acknowledge_irq=function(){var t=this.highest_irr();return t===-1||this.highest_isr()>=t||(t&240)<=(this.tpr&240)?-1:(this.register_clear_bit(this.irr,t),this.register_set_bit(this.isr,t),this.check_vector(),t)},K.prototype.get_state=function(){var t=[];return t[0]=this.apic_id,t[1]=this.timer_divider,t[2]=this.timer_divider_shift,t[3]=this.timer_initial_count,t[4]=this.timer_current_count,t[5]=this.next_tick,t[6]=this.lvt_timer,t[7]=this.lvt_perf_counter,t[8]=this.lvt_int0,t[9]=this.lvt_int1,t[10]=this.lvt_error,t[11]=this.tpr,t[12]=this.icr0,t[13]=this.icr1,t[14]=this.irr,t[15]=this.isr,t[16]=this.tmr,t[17]=this.spurious_vector,t[18]=this.destination_format,t[19]=this.local_destination,t[20]=this.error,t[21]=this.read_error,t},K.prototype.set_state=function(t){this.apic_id=t[0],this.timer_divider=t[1],this.timer_divider_shift=t[2],this.timer_initial_count=t[3],this.timer_current_count=t[4],this.next_tick=t[5],this.lvt_timer=t[6],this.lvt_perf_counter=t[7],this.lvt_int0=t[8],this.lvt_int1=t[9],this.lvt_error=t[10],this.tpr=t[11],this.icr0=t[12],this.icr1=t[13],this.irr=t[14],this.isr=t[15],this.tmr=t[16],this.spurious_vector=t[17],this.destination_format=t[18],this.local_destination=t[19],this.error=t[20],this.read_error=t[21]},K.prototype.register_get_bit=function(t,e){return t[e>>5]>>(e&31)&1},K.prototype.register_set_bit=function(t,e){t[e>>5]|=1<<(e&31)},K.prototype.register_clear_bit=function(t,e){t[e>>5]&=~(1<<(e&31))},K.prototype.register_get_highest_bit=function(t){for(var e=7;0<=e;e--){var r=t[e];if(r)return f.int_log2(r>>>0)|e<<5}return-1};function J(t){this.cpu=t,this.ioredtbl_config=new Int32Array(24),this.ioredtbl_destination=new Int32Array(24);for(var e=0;e<this.ioredtbl_config.length;e++)this.ioredtbl_config[e]=65536;this.irq_value=this.irr=this.ioapic_id=this.ioregsel=0,t.io.mmap_register(4273995776,131072,r=>(r=r-4273995776|0,16<=r&&20>r?(r-=16,u(this.ioregsel),this.read(this.ioregsel)>>8*r&255):(u(r>>>0),0)),r=>{u(r>>>0)},r=>(r=r-4273995776|0,r===0?this.ioregsel:r===16?this.read(this.ioregsel):(u(r>>>0),0)),(r,n)=>{r=r-4273995776|0,r===0?this.ioregsel=n:r===16?this.write(this.ioregsel,n):(u(r>>>0),u(n>>>0,8))})}J.prototype.remote_eoi=function(t){for(var e=0;24>e;e++){var r=this.ioredtbl_config[e];(r&255)===t&&r&16384&&(u(e),this.ioredtbl_config[e]&=-16385,this.check_irq(e))}},J.prototype.check_irq=function(t){var e=1<<t;if(this.irr&e){var r=this.ioredtbl_config[t];if(!(r&65536)){var n=r>>8&7,a=this.ioredtbl_destination[t]>>>24;if(!(r&32768))this.irr&=~e;else if(this.ioredtbl_config[t]|=16384,r&16384)return;n!==0&&n!==1||this.cpu.devices.apic.route(r&255,n,(r&32768)===32768,a,r>>11&1),this.ioredtbl_config[t]&=-4097}}},J.prototype.set_irq=function(t){if(!(24<=t)){var e=1<<t;!(this.irq_value&e)&&(this.irq_value|=e,(this.ioredtbl_config[t]&98304)!==65536&&(this.irr|=e,this.check_irq(t)))}},J.prototype.clear_irq=function(t){if(!(24<=t)){var e=1<<t;(this.irq_value&e)===e&&(this.irq_value&=~e,this.ioredtbl_config[t]&32768&&(this.irr&=~e))}},J.prototype.read=function(t){if(t===0)return this.ioapic_id<<24;if(t===1)return 1507345;if(t===2)return this.ioapic_id<<24;if(16<=t&&64>t){var e=t-16>>1;return t=t&1?this.ioredtbl_destination[e]:this.ioredtbl_config[e],u(e),u(t,8),t}return u(t),0},J.prototype.write=function(t,e){if(t===0)this.ioapic_id=e>>>24&15;else if(t!==1&&t!==2)if(16<=t&&64>t){var r=t-16>>1;t&1?(this.ioredtbl_destination[r]=e&4278190080,u(e>>>0,8),u(r),u(e>>>24,2)):(this.ioredtbl_config[r]=e&110591|this.ioredtbl_config[r]&-110592,t=e&255,u(e>>>0,8),u(r),u(t,2),this.check_irq(r))}else u(t),u(e>>>0,8)},J.prototype.get_state=function(){var t=[];return t[0]=this.ioredtbl_config,t[1]=this.ioredtbl_destination,t[2]=this.ioregsel,t[3]=this.ioapic_id,t[4]=this.irr,t[5]=this.irq_value,t},J.prototype.set_state=function(t){this.ioredtbl_config=t[0],this.ioredtbl_destination=t[1],this.ioregsel=t[2],this.ioapic_id=t[3],this.irr=t[4],this.irq_value=t[5]};function ct(t){this.message=t}ct.prototype=Error();let yt={Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array};function ft(t,e){if(typeof t!="object"||t===null)return t;if(t instanceof Array)return t.map(a=>ft(a,e));if(t.constructor===Object&&console.log(t),t.BYTES_PER_ELEMENT){var r=new Uint8Array(t.buffer,t.byteOffset,t.length*t.BYTES_PER_ELEMENT);return{__state_type__:t.constructor.name.replace("bound ",""),buffer_id:e.push(r)-1}}t=t.get_state(),r=[];for(var n=0;n<t.length;n++)r[n]=ft(t[n],e);return r}function rt(t,e){if(typeof t!="object"||t===null)return t;if(t instanceof Array){for(let r=0;r<t.length;r++)t[r]=rt(t[r],e);return t}return new yt[t.__state_type__](e[t.buffer_id])}V.prototype.save_state=function(){for(var t=[],e=ft(this,t),r=[],n=0,a=0;a<t.length;a++){var p=t[a].byteLength;r[a]={offset:n,length:p},n+=p,n=n+3&-4}a=JSON.stringify({buffer_infos:r,state:e}),a=new TextEncoder().encode(a),e=16+a.length,e=e+3&-4,p=e+n,n=new ArrayBuffer(p);var d=new Int32Array(n,0,4);for(new Uint8Array(n,16,a.length).set(a),e=new Uint8Array(n,e),d[0]=-2039052682,d[1]=6,d[2]=p,d[3]=a.length,a=0;a<t.length;a++)e.set(t[a],r[a].offset);return n},V.prototype.restore_state=function(t){function e(E,R){let C=E.length;if(16>C)throw new ct("Invalid length: "+C);if(E=new Int32Array(E.buffer,E.byteOffset,4),E[0]!==-2039052682)throw new ct("Invalid header: "+u(E[0]>>>0));if(E[1]!==6)throw new ct("Version mismatch: dump="+E[1]+" we=6");if(R&&E[2]!==C)throw new ct("Length doesn't match header: real="+C+" header="+E[2]);return E[3]}function r(E){return E=new TextDecoder().decode(E),JSON.parse(E)}if(t=new Uint8Array(t),new Uint32Array(t.buffer,0,1)[0]===4247762216){var n=this.zstd_create_ctx(t.length);new Uint8Array(this.wasm_memory.buffer,this.zstd_get_src_ptr(n),t.length).set(t);var a=this.zstd_read(n,16),p=new Uint8Array(this.wasm_memory.buffer,a,16),d=e(p,!1);this.zstd_read_free(a,16),a=this.zstd_read(n,d),p=new Uint8Array(this.wasm_memory.buffer,a,d),p=r(p),this.zstd_read_free(a,d),a=p.state;var m=p.buffer_infos;p=[],d=16+d;for(var g of m){if(m=(d+3&-4)-d,1048576<g.length){var y=this.zstd_read(n,m);this.zstd_read_free(y,m),y=new Uint8Array(g.length),p.push(y.buffer);for(var b=0;b<g.length;){let E=Math.min(g.length-b,1048576),R=this.zstd_read(n,E);y.set(new Uint8Array(this.wasm_memory.buffer,R,E),b),this.zstd_read_free(R,E),b+=E}}else y=this.zstd_read(n,m+g.length),b=y+m,p.push(this.wasm_memory.buffer.slice(b,b+g.length)),this.zstd_read_free(y,m+g.length);d+=m+g.length}a=rt(a,p),this.set_state(a),this.zstd_free_ctx(n)}else{if(n=e(t,!0),0>n||n+12>=t.length)throw new ct("Invalid info block length: "+n);g=t.subarray(16,16+n),a=r(g),g=a.state,a=a.buffer_infos;let E=16+n;E=E+3&-4,n=a.map(R=>{let C=E+R.offset;return t.buffer.slice(C,C+R.length)}),g=rt(g,n),this.set_state(g)}};function ht(t,e,r){t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&(t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5]),t[6]===e[0]&&t[7]===e[1]&&t[8]===e[2]&&t[9]===e[3]&&t[10]===e[4]&&t[11]===e[5]&&(t[6]=r[0],t[7]=r[1],t[8]=r[2],t[9]=r[3],t[10]=r[4],t[11]=r[5]);var n=t[12]<<8|t[13];if(n===2048){if(t=t.subarray(14),t[0]>>4===4&&t[9]===17){t=t.subarray(20),n=t[0]<<8|t[1];var a=t[2]<<8|t[3];if(u(t[6]<<8|t[7],4),n===67||a===67)if(n=t.subarray(8),a=n[236]<<24|n[237]<<16|n[238]<<8|n[239],a!==1669485411)u(a,8);else for(n[28]===e[0]&&n[29]===e[1]&&n[30]===e[2]&&n[31]===e[3]&&n[32]===e[4]&&n[33]===e[5]&&(n[28]=r[0],n[29]=r[1],n[30]=r[2],n[31]=r[3],n[32]=r[4],n[33]=r[5],t[6]=t[7]=0),a=240;a<n.length;){let p=n[a++];if(p===255)break;let d=n[a++];p===61&&n[a+0]===1&&n[a+1]===e[0]&&n[a+2]===e[1]&&n[a+3]===e[2]&&n[a+4]===e[3]&&n[a+5]===e[4]&&n[a+6]===e[5]&&(n[a+1]=r[0],n[a+2]=r[1],n[a+3]=r[2],n[a+4]=r[3],n[a+5]=r[4],n[a+6]=r[5],t[6]=t[7]=0),a+=d}}}else n===2054&&(t=t.subarray(14),et(t.subarray(8,14)),et(t.subarray(18,24)),t[8]===e[0]&&t[9]===e[1]&&t[10]===e[2]&&t[11]===e[3]&&t[12]===e[4]&&t[13]===e[5]&&(t[8]=r[0],t[9]=r[1],t[10]=r[2],t[11]=r[3],t[12]=r[4],t[13]=r[5]))}function et(t){return[t[0].toString(16).padStart(2,"0"),t[1].toString(16).padStart(2,"0"),t[2].toString(16).padStart(2,"0"),t[3].toString(16).padStart(2,"0"),t[4].toString(16).padStart(2,"0"),t[5].toString(16).padStart(2,"0")].join(":")}function it(t,e,r,n){for(this.cpu=t,this.pci=t.devices.pci,this.preserve_mac_from_state_image=r,this.mac_address_translation=n,this.bus=e,this.bus.register("net0-receive",function(a){this.receive(a)},this),this.port=768,this.name="ne2k",this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,this.port&255|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=40,this.pci_bars=[{size:32}],this.imr=this.isr=0,this.cr=1,this.tpsr=this.tcnt=this.rcnt=this.dcfg=0,this.memory=new Uint8Array(32768),this.txcr=this.rxcr=0,this.tsr=1,this.mac=new Uint8Array([0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0]),this.mar=Uint8Array.of(255,255,255,255,255,255,255,255),this.mac_address_in_state=null,e=0;6>e;e++)this.memory[e<<1]=this.memory[e<<1|1]=this.mac[e];this.memory[28]=this.memory[29]=87,this.memory[30]=this.memory[31]=87,""+et(this.mac),this.rsar=0,this.pstart=64,this.pstop=128,this.boundary=this.curpg=76,e=t.io,e.register_read(this.port|0,this,function(){return this.cr}),e.register_write(this.port|0,this,function(a){this.cr=a,u(a,2),u(this.txcr,2),this.cr&1||(a&24&&this.rcnt===0&&this.do_interrupt(64),a&4&&(a=this.tpsr<<8,a=this.memory.subarray(a,a+this.tcnt),this.mac_address_in_state&&(a=new Uint8Array(a),ht(a,this.mac_address_in_state,this.mac)),this.bus.send("net0-send",a),this.bus.send("eth-transmit-end",[a.length]),this.cr&=-5,this.do_interrupt(2),u(a.byteLength)))}),e.register_read(this.port|13,this,function(){return this.get_page()===1?this.mar[5]:0}),e.register_read(this.port|14,this,function(){return this.get_page()===1?this.mar[6]:0},function(){return this.get_page(),0}),e.register_read(this.port|15,this,function(){return this.get_page()===1?this.mar[7]:0}),e.register_read(this.port|31,this,function(){return this.get_page(),this.do_interrupt(128),0}),e.register_write(this.port|31,this,function(a){this.get_page(),u(a,2)}),e.register_read(this.port|1,this,function(){var a=this.get_page();return a===0?this.pstart:a===1?this.mac[0]:a===2?this.pstart:0}),e.register_write(this.port|1,this,function(a){var p=this.get_page();p===0?(u(a,2),this.pstart=a):p===1?(u(a),this.mac[0]=a):u(a)}),e.register_read(this.port|2,this,function(){var a=this.get_page();return a===0?this.pstop:a===1?this.mac[1]:a===2?this.pstop:0}),e.register_write(this.port|2,this,function(a){var p=this.get_page();p===0?(u(a,2),a>this.memory.length>>8&&(a=this.memory.length>>8,u(a)),this.pstop=a):p===1?(u(a),this.mac[1]=a):u(a)}),e.register_read(this.port|7,this,function(){var a=this.get_page();return a===0?(u(this.isr,2),this.isr):a===1?(u(this.curpg,2),this.curpg):0}),e.register_write(this.port|7,this,function(a){var p=this.get_page();p===0?(u(a,2),this.isr&=~a,this.update_irq()):p===1&&(u(a,2),this.curpg=a)}),e.register_write(this.port|13,this,function(a){this.get_page()===0&&(this.txcr=a),u(a,2)}),e.register_write(this.port|14,this,function(a){this.get_page()===0?(u(a,2),this.dcfg=a):u(a,2)}),e.register_read(this.port|10,this,function(){var a=this.get_page();return a===0?80:a===1?this.mar[2]:0}),e.register_write(this.port|10,this,function(a){this.get_page()===0?(u(a,2),this.rcnt=this.rcnt&65280|a&255):u(a,2)}),e.register_read(this.port|11,this,function(){var a=this.get_page();return a===0?67:a===1?this.mar[3]:0}),e.register_write(this.port|11,this,function(a){this.get_page()===0?(u(a,2),this.rcnt=this.rcnt&255|a<<8&65280):u(a,2)}),e.register_read(this.port|8,this,function(){var a=this.get_page();return a===0?this.rsar&255:a===1?this.mar[0]:0}),e.register_write(this.port|8,this,function(a){this.get_page()===0?(u(a,2),this.rsar=this.rsar&65280|a&255):u(a,2)}),e.register_read(this.port|9,this,function(){var a=this.get_page();return a===0?this.rsar>>8&255:a===1?this.mar[1]:0}),e.register_write(this.port|9,this,function(a){this.get_page()===0?(u(a,2),this.rsar=this.rsar&255|a<<8&65280):u(a,2)}),e.register_write(this.port|15,this,function(a){this.get_page()===0?(u(a,2),u(this.isr,2),this.imr=a,this.update_irq()):u(a,2)}),e.register_read(this.port|3,this,function(){var a=this.get_page();return a===0?(u(this.boundary,2),this.boundary):a===1?this.mac[2]:0}),e.register_write(this.port|3,this,function(a){var p=this.get_page();p===0?(u(a,2),this.boundary=a):p===1?(u(a),this.mac[2]=a):u(a)}),e.register_read(this.port|4,this,function(){var a=this.get_page();return a===0?this.tsr:a===1?this.mac[3]:0}),e.register_write(this.port|4,this,function(a){var p=this.get_page();p===0?(u(a,2),this.tpsr=a):p===1?(u(a),this.mac[3]=a):u(a)}),e.register_read(this.port|5,this,function(){var a=this.get_page();return a===0?0:a===1?this.mac[4]:0}),e.register_write(this.port|5,this,function(a){var p=this.get_page();p===0?(u(a,2),this.tcnt=this.tcnt&-256|a):p===1?(u(a),this.mac[4]=a):u(a)}),e.register_read(this.port|6,this,function(){var a=this.get_page();return a===0?0:a===1?this.mac[5]:0}),e.register_write(this.port|6,this,function(a){var p=this.get_page();p===0?(u(a,2),this.tcnt=this.tcnt&255|a<<8):p===1?(u(a),this.mac[5]=a):u(a)}),e.register_read(this.port|12,this,function(){var a=this.get_page();return a===0?9:a===1?this.mar[4]:0}),e.register_write(this.port|12,this,function(a){this.get_page()===0?(u(a,2),this.rxcr=a):u(a)}),e.register_read(this.port|16,this,this.data_port_read8,this.data_port_read16,this.data_port_read32),e.register_write(this.port|16,this,this.data_port_write16,this.data_port_write16,this.data_port_write32),t.devices.pci.register_device(this)}it.prototype.get_state=function(){var t=[];return t[0]=this.isr,t[1]=this.imr,t[2]=this.cr,t[3]=this.dcfg,t[4]=this.rcnt,t[5]=this.tcnt,t[6]=this.tpsr,t[7]=this.rsar,t[8]=this.pstart,t[9]=this.curpg,t[10]=this.boundary,t[11]=this.pstop,t[12]=this.rxcr,t[13]=this.txcr,t[14]=this.tsr,t[15]=this.mac,t[16]=this.memory,t},it.prototype.set_state=function(t){this.isr=t[0],this.imr=t[1],this.cr=t[2],this.dcfg=t[3],this.rcnt=t[4],this.tcnt=t[5],this.tpsr=t[6],this.rsar=t[7],this.pstart=t[8],this.curpg=t[9],this.boundary=t[10],this.pstop=t[11],this.rxcr=t[12],this.txcr=t[13],this.tsr=t[14],this.preserve_mac_from_state_image?(this.mac=t[15],this.memory=t[16]):this.mac_address_translation&&(this.mac_address_in_state=t[15],this.memory=t[16],et(this.mac_address_in_state),et(this.mac))},it.prototype.do_interrupt=function(t){u(t,2),this.isr|=t,this.update_irq()},it.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)},it.prototype.data_port_write=function(t){(16>=this.rsar||16384<=this.rsar&&32768>this.rsar)&&(this.memory[this.rsar]=t),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(64)},it.prototype.data_port_write16=function(t){this.data_port_write(t),this.dcfg&1&&this.data_port_write(t>>8)},it.prototype.data_port_write32=function(t){this.data_port_write(t),this.data_port_write(t>>8),this.data_port_write(t>>16),this.data_port_write(t>>24)},it.prototype.data_port_read=function(){let t=0;return 32768>this.rsar&&(t=this.memory[this.rsar]),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(64),t},it.prototype.data_port_read8=function(){return this.data_port_read16()&255},it.prototype.data_port_read16=function(){return this.dcfg&1?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()},it.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24},it.prototype.receive=function(t){if(!(this.cr&1)&&(this.bus.send("eth-receive-end",[t.length]),this.rxcr&16||this.rxcr&4&&t[0]===255&&t[1]===255&&t[2]===255&&t[3]===255&&t[4]===255&&t[5]===255||!(this.rxcr&8&&(t[0]&1)===1||t[0]!==this.mac[0]||t[1]!==this.mac[1]||t[2]!==this.mac[2]||t[3]!==this.mac[3]||t[4]!==this.mac[4]||t[5]!==this.mac[5]))){this.mac_address_in_state&&(t=new Uint8Array(t),ht(t,this.mac,this.mac_address_in_state));var e=this.curpg<<8,r=Math.max(60,t.length)+4,n=e+4,a=this.curpg+1+(r>>8),p=e+r,d=1+(r>>8),m=this.boundary>this.curpg?this.boundary-this.curpg:this.pstop-this.curpg+this.boundary-this.pstart;m<d&&this.boundary!==0?(u(this.pstart),u(this.pstop),u(this.curpg),u(d),u(this.boundary),u(m)):(p>this.pstop<<8?(p=(this.pstop<<8)-n,this.memory.set(t.subarray(0,p),n),this.memory.set(t.subarray(p),this.pstart<<8),u(p)):(this.memory.set(t,n),60>t.length&&this.memory.fill(0,n+t.length,n+60)),a>=this.pstop&&(a+=this.pstart-this.pstop),this.memory[e]=1,this.memory[e+1]=a,this.memory[e+2]=r,this.memory[e+3]=r>>8,this.curpg=a,u(e),u(r),u(a),this.do_interrupt(1))}},it.prototype.get_page=function(){return this.cr>>6&3};var nt=new Uint8Array(256),js=[],Gi=[],$i=[],un=new Uint8Array(256),Ws=[];function z(t,e){this.cpu=t,this.bus=e,this.write_buffer=new w(64),this.read_buffer=new w(64),this.mixer_current_address=this.command_size=this.command=this.read_buffer_lastvalue=0,this.mixer_registers=new Uint8Array(256),this.mixer_reset(),this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers=[new v(65536),new v(65536)],this.dma=t.devices.dma,this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_channel_8bit=1,this.dma_channel_16bit=5,this.dma_autoinit=!1,this.dma_buffer=new ArrayBuffer(65536),this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_uint8=new Uint8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new f.SyncBuffer(this.dma_buffer),this.dma_paused=this.dma_waiting_transfer=!1,this.sampling_rate=22050,e.send("dac-tell-sampling-rate",this.sampling_rate),this.bytes_per_sample=1,this.e2_value=170,this.e2_count=0,this.asp_registers=new Uint8Array(256),this.mpu_read_buffer=new w(64),this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0,this.fm_waveform_select_enable=!1,this.irq=5,this.irq_triggered=new Uint8Array(16),t.io.register_read_consecutive(544,this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read),t.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read),t.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read),t.io.register_read(550,this,this.port2x6_read),t.io.register_read(551,this,this.port2x7_read),t.io.register_read(552,this,this.port2x8_read),t.io.register_read(553,this,this.port2x9_read),t.io.register_read(554,this,this.port2xA_read),t.io.register_read(555,this,this.port2xB_read),t.io.register_read(556,this,this.port2xC_read),t.io.register_read(557,this,this.port2xD_read),t.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read),t.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write),t.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write),t.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write),t.io.register_write(550,this,this.port2x6_write),t.io.register_write(551,this,this.port2x7_write),t.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write),t.io.register_write(554,this,this.port2xA_write),t.io.register_write(555,this,this.port2xB_write),t.io.register_write(556,this,this.port2xC_write),t.io.register_write(557,this,this.port2xD_write),t.io.register_write(558,this,this.port2xE_write),t.io.register_write(559,this,this.port2xF_write),t.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read),t.io.register_write_consecutive(816,this,this.port3x0_write,this.port3x1_write),this.dma.on_unmask(this.dma_on_unmask,this),e.register("dac-request-data",function(){this.dac_handle_request()},this),e.register("speaker-has-initialized",function(){this.mixer_reset()},this),e.send("speaker-confirm-initialized"),this.dsp_reset()}z.prototype.dsp_reset=function(){this.write_buffer.clear(),this.read_buffer.clear(),this.command_size=this.command=0,this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers[0].clear(),this.dac_buffers[1].clear(),this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_autoinit=!1,this.dma_buffer_uint8.fill(0),this.dma_paused=this.dma_waiting_transfer=!1,this.e2_value=170,this.e2_count=0,this.sampling_rate=22050,this.bytes_per_sample=1,this.lower_irq(1),this.irq_triggered.fill(0),this.asp_registers.fill(0),this.asp_registers[5]=1,this.asp_registers[9]=248},z.prototype.get_state=function(){var t=[];return t[2]=this.read_buffer_lastvalue,t[3]=this.command,t[4]=this.command_size,t[5]=this.mixer_current_address,t[6]=this.mixer_registers,t[7]=this.dummy_speaker_enabled,t[8]=this.test_register,t[9]=this.dsp_highspeed,t[10]=this.dsp_stereo,t[11]=this.dsp_16bit,t[12]=this.dsp_signed,t[15]=this.dma_sample_count,t[16]=this.dma_bytes_count,t[17]=this.dma_bytes_left,t[18]=this.dma_bytes_block,t[19]=this.dma_irq,t[20]=this.dma_channel,t[21]=this.dma_channel_8bit,t[22]=this.dma_channel_16bit,t[23]=this.dma_autoinit,t[24]=this.dma_buffer_uint8,t[25]=this.dma_waiting_transfer,t[26]=this.dma_paused,t[27]=this.sampling_rate,t[28]=this.bytes_per_sample,t[29]=this.e2_value,t[30]=this.e2_count,t[31]=this.asp_registers,t[33]=this.mpu_read_buffer_last_value,t[34]=this.irq,t[35]=this.irq_triggered,t},z.prototype.set_state=function(t){this.read_buffer_lastvalue=t[2],this.command=t[3],this.command_size=t[4],this.mixer_current_address=t[5],this.mixer_registers=t[6],this.mixer_full_update(),this.dummy_speaker_enabled=t[7],this.test_register=t[8],this.dsp_highspeed=t[9],this.dsp_stereo=t[10],this.dsp_16bit=t[11],this.dsp_signed=t[12],this.dma_sample_count=t[15],this.dma_bytes_count=t[16],this.dma_bytes_left=t[17],this.dma_bytes_block=t[18],this.dma_irq=t[19],this.dma_channel=t[20],this.dma_channel_8bit=t[21],this.dma_channel_16bit=t[22],this.dma_autoinit=t[23],this.dma_buffer_uint8=t[24],this.dma_waiting_transfer=t[25],this.dma_paused=t[26],this.sampling_rate=t[27],this.bytes_per_sample=t[28],this.e2_value=t[29],this.e2_count=t[30],this.asp_registers=t[31],this.mpu_read_buffer_last_value=t[33],this.irq=t[34],this.irq_triggered=t[35],this.dma_buffer=this.dma_buffer_uint8.buffer,this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new f.SyncBuffer(this.dma_buffer),this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")},z.prototype.port2x0_read=function(){return 255},z.prototype.port2x1_read=function(){return 255},z.prototype.port2x2_read=function(){return 255},z.prototype.port2x3_read=function(){return 255},z.prototype.port2x4_read=function(){return this.mixer_current_address},z.prototype.port2x5_read=function(){return this.mixer_read(this.mixer_current_address)},z.prototype.port2x6_read=function(){return 255},z.prototype.port2x7_read=function(){return 255},z.prototype.port2x8_read=function(){return 255},z.prototype.port2x9_read=function(){return 255},z.prototype.port2xA_read=function(){return this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift()),u(this.read_buffer_lastvalue),String.fromCharCode(this.read_buffer_lastvalue),this.read_buffer_lastvalue},z.prototype.port2xB_read=function(){return 255},z.prototype.port2xC_read=function(){return 127},z.prototype.port2xD_read=function(){return 255},z.prototype.port2xE_read=function(){return this.irq_triggered[1]&&this.lower_irq(1),(this.read_buffer.length&&!this.dsp_highspeed)<<7|127},z.prototype.port2xF_read=function(){return this.lower_irq(2),0},z.prototype.port2x0_write=function(t){u(t),this.fm_current_address0=0},z.prototype.port2x1_write=function(t){u(t);var e=Ws[this.fm_current_address0];e||(e=this.fm_default_write),e.call(this,t,0,this.fm_current_address0)},z.prototype.port2x2_write=function(t){u(t),this.fm_current_address1=0},z.prototype.port2x3_write=function(t){u(t);var e=Ws[this.fm_current_address1];e||(e=this.fm_default_write),e.call(this,t,1,this.fm_current_address1)},z.prototype.port2x4_write=function(t){u(t),this.mixer_current_address=t},z.prototype.port2x5_write=function(t){u(t),this.mixer_write(this.mixer_current_address,t)},z.prototype.port2x6_write=function(t){u(t),this.dsp_highspeed?this.dsp_highspeed=!1:t&&this.dsp_reset(),this.read_buffer.clear(),this.read_buffer.push(170)},z.prototype.port2x7_write=function(){},z.prototype.port2x8_write=function(){},z.prototype.port2x9_write=function(){},z.prototype.port2xA_write=function(){},z.prototype.port2xB_write=function(){},z.prototype.port2xC_write=function(t){this.command===0?(u(t),this.command=t,this.write_buffer.clear(),this.command_size=nt[t]):(u(t),this.write_buffer.push(t)),this.write_buffer.length>=this.command_size&&this.command_do()},z.prototype.port2xD_write=function(){},z.prototype.port2xE_write=function(){},z.prototype.port2xF_write=function(){},z.prototype.port3x0_read=function(){return this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift()),u(this.mpu_read_buffer_lastvalue),this.mpu_read_buffer_lastvalue},z.prototype.port3x0_write=function(t){u(t)},z.prototype.port3x1_read=function(){return 0|128*!this.mpu_read_buffer.length},z.prototype.port3x1_write=function(t){u(t),t===255&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))},z.prototype.command_do=function(){var t=js[this.command];t||(t=this.dsp_default_handler),t.call(this),this.command_size=this.command=0,this.write_buffer.clear()},z.prototype.dsp_default_handler=function(){u(this.command)};function $(t,e,r){r||(r=z.prototype.dsp_default_handler);for(var n=0;n<t.length;n++)nt[t[n]]=e,js[t[n]]=r}function dn(t){for(var e=[],r=0;16>r;r++)e.push(t+r);return e}$([14],2,function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()}),$([15],1,function(){this.read_buffer.clear(),this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])}),$([16],1,function(){var t=this.write_buffer.shift();t=ln(t/127.5+-1,-1,1),this.dac_buffers[0].push(t),this.dac_buffers[1].push(t),this.bus.send("dac-enable")}),$([20,21],2,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}),$([22],2),$([23],2),$([28],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1,this.dma_transfer_start()}),$([31],0),$([32],0,function(){this.read_buffer.clear(),this.read_buffer.push(127)}),$([36],2),$([44],0),$([48],0),$([49],0),$([52],0),$([53],0),$([54],0),$([55],0),$([56],0),$([64],1,function(){this.sampling_rate_change(1e6/(256-this.write_buffer.shift())/this.get_channel_count())}),$([65,66],2,function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())}),$([72],2,function(){this.dma_transfer_size_set()}),$([116],2),$([117],2),$([118],2),$([119],2),$([125],0),$([127],0),$([128],2),$([144],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_signed=!1,this.dsp_highspeed=!0,this.dsp_16bit=!1,this.dma_transfer_start()}),$([145],0),$([152],0),$([153],0),$([160],0),$([168],0),$(dn(176),3,function(){if(this.command&8)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=2,this.dma_channel=this.dma_channel_16bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(t&16),this.dsp_stereo=!!(t&32),this.dsp_16bit=!0,this.dma_transfer_size_set(),this.dma_transfer_start()}}),$(dn(192),3,function(){if(this.command&8)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(t&16),this.dsp_stereo=!!(t&32),this.dsp_16bit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}}),$([208],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),$([209],0,function(){this.dummy_speaker_enabled=!0}),$([211],0,function(){this.dummy_speaker_enabled=!1}),$([212],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),$([213],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),$([214],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),$([216],0,function(){this.read_buffer.clear(),this.read_buffer.push(255*this.dummy_speaker_enabled)}),$([217,218],0,function(){this.dma_autoinit=!1}),$([224],1,function(){this.read_buffer.clear(),this.read_buffer.push(~this.write_buffer.shift())}),$([225],0,function(){this.read_buffer.clear(),this.read_buffer.push(4),this.read_buffer.push(5)}),$([226],1),$([227],0,function(){this.read_buffer.clear();for(var t=0;44>t;t++)this.read_buffer.push("COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.".charCodeAt(t));this.read_buffer.push(0)}),$([228],1,function(){this.test_register=this.write_buffer.shift()}),$([232],0,function(){this.read_buffer.clear(),this.read_buffer.push(this.test_register)}),$([242,243],0,function(){this.raise_irq()});var Hi=new Uint8Array(256);Hi[14]=255,Hi[15]=7,Hi[55]=56,$([249],1,function(){var t=this.write_buffer.shift();this.read_buffer.clear(),this.read_buffer.push(Hi[t])}),z.prototype.mixer_read=function(t){var e=Gi[t];return e?e=e.call(this):(e=this.mixer_registers[t],u(t),u(e)),e},z.prototype.mixer_write=function(t,e){var r=$i[t];r?r.call(this,e):(u(t),u(e))},z.prototype.mixer_default_read=function(){return u(this.mixer_current_address),this.mixer_registers[this.mixer_current_address]},z.prototype.mixer_default_write=function(t){u(this.mixer_current_address),u(t),this.mixer_registers[this.mixer_current_address]=t},z.prototype.mixer_reset=function(){this.mixer_registers[4]=204,this.mixer_registers[34]=204,this.mixer_registers[38]=204,this.mixer_registers[40]=0,this.mixer_registers[46]=0,this.mixer_registers[10]=0,this.mixer_registers[48]=192,this.mixer_registers[49]=192,this.mixer_registers[50]=192,this.mixer_registers[51]=192,this.mixer_registers[52]=192,this.mixer_registers[53]=192,this.mixer_registers[54]=0,this.mixer_registers[55]=0,this.mixer_registers[56]=0,this.mixer_registers[57]=0,this.mixer_registers[59]=0,this.mixer_registers[60]=31,this.mixer_registers[61]=21,this.mixer_registers[62]=11,this.mixer_registers[63]=0,this.mixer_registers[64]=0,this.mixer_registers[65]=0,this.mixer_registers[66]=0,this.mixer_registers[67]=0,this.mixer_registers[68]=128,this.mixer_registers[69]=128,this.mixer_registers[70]=128,this.mixer_registers[71]=128,this.mixer_full_update()},z.prototype.mixer_full_update=function(){for(var t=1;t<this.mixer_registers.length;t++)un[t]||this.mixer_write(t,this.mixer_registers[t])};function te(t,e){e||(e=z.prototype.mixer_default_read),Gi[t]=e}function ce(t,e){e||(e=z.prototype.mixer_default_write),$i[t]=e}function ci(t,e,r){un[t]=1,Gi[t]=function(){return this.mixer_registers[e]&240|this.mixer_registers[r]>>>4},$i[t]=function(n){this.mixer_registers[t]=n;var a=n<<4&240|this.mixer_registers[r]&15;this.mixer_write(e,n&240|this.mixer_registers[e]&15),this.mixer_write(r,a)}}function Ki(t,e,r){Gi[t]=z.prototype.mixer_default_read,$i[t]=function(n){this.mixer_registers[t]=n,this.bus.send("mixer-volume",[e,r,(n>>>2)-62])}}te(0,function(){return this.mixer_reset(),0}),ce(0),ci(4,50,51),ci(34,48,49),ci(38,52,53),ci(40,54,55),ci(46,56,57),Ki(48,0,0),Ki(49,0,1),Ki(50,2,0),Ki(51,2,1),te(59),ce(59,function(t){this.mixer_registers[59]=t,this.bus.send("mixer-volume",[1,2,6*(t>>>6)-18])}),te(65),ce(65,function(t){this.mixer_registers[65]=t,this.bus.send("mixer-gain-left",6*(t>>>6))}),te(66),ce(66,function(t){this.mixer_registers[66]=t,this.bus.send("mixer-gain-right",6*(t>>>6))}),te(68),ce(68,function(t){this.mixer_registers[68]=t,t>>>=3,this.bus.send("mixer-treble-left",t-(16>t?14:16))}),te(69),ce(69,function(t){this.mixer_registers[69]=t,t>>>=3,this.bus.send("mixer-treble-right",t-(16>t?14:16))}),te(70),ce(70,function(t){this.mixer_registers[70]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))}),te(71),ce(71,function(t){this.mixer_registers[71]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))}),te(128,function(){switch(this.irq){case 2:return 1;case 5:return 2;case 7:return 4;case 10:return 8;default:return 0}}),ce(128,function(t){t&1&&(this.irq=2),t&2&&(this.irq=5),t&4&&(this.irq=7),t&8&&(this.irq=10)}),te(129,function(){var t=0;switch(this.dma_channel_8bit){case 0:t|=1;break;case 1:t|=2;break;case 3:t|=8}switch(this.dma_channel_16bit){case 5:t|=32;break;case 6:t|=64;break;case 7:t|=128}return t}),ce(129,function(t){t&1&&(this.dma_channel_8bit=0),t&2&&(this.dma_channel_8bit=1),t&8&&(this.dma_channel_8bit=3),t&32&&(this.dma_channel_16bit=5),t&64&&(this.dma_channel_16bit=6),t&128&&(this.dma_channel_16bit=7)}),te(130,function(){for(var t=32,e=0;16>e;e++)t|=e*this.irq_triggered[e];return t}),z.prototype.fm_default_write=function(t,e,r){u(r),u(t)};function qt(t,e){e||(e=z.prototype.fm_default_write);for(var r=0;r<t.length;r++)Ws[t[r]]=e}function xe(t,e){for(var r=[];t<=e;t++)r.push(t);return r}var vt=new Uint8Array(32);vt[0]=0,vt[1]=1,vt[2]=2,vt[3]=3,vt[4]=4,vt[5]=5,vt[8]=6,vt[9]=7,vt[10]=8,vt[11]=9,vt[12]=10,vt[13]=11,vt[16]=12,vt[17]=13,vt[18]=14,vt[19]=15,vt[20]=16,vt[21]=17,qt([1],function(t,e){this.fm_waveform_select_enable[e]=t&1,this.fm_update_waveforms()}),qt([2]),qt([3]),qt([4],function(){}),qt([5],function(t,e,r){e===0&&this.fm_default_write(t,e,r)}),qt([8],function(){}),qt(xe(32,53),function(){}),qt(xe(64,85),function(){}),qt(xe(96,117),function(){}),qt(xe(128,149),function(){}),qt(xe(160,168),function(){}),qt(xe(176,184),function(){}),qt([189],function(){}),qt(xe(192,200),function(){}),qt(xe(224,245),function(){}),z.prototype.fm_update_waveforms=function(){},z.prototype.sampling_rate_change=function(t){this.sampling_rate=t,this.bus.send("dac-tell-sampling-rate",t)},z.prototype.get_channel_count=function(){return this.dsp_stereo?2:1},z.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)},z.prototype.dma_transfer_start=function(){this.bytes_per_sample=1,this.dsp_16bit&&(this.bytes_per_sample*=2),this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample,this.dma_bytes_block=1024*this.bytes_per_sample,this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block),this.dma_waiting_transfer=!0,this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)},z.prototype.dma_on_unmask=function(t){t===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))},z.prototype.dma_transfer_next=function(){var t=Math.min(this.dma_bytes_left,this.dma_bytes_block),e=Math.floor(t/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,t,this.dma_channel,r=>{r||(this.dma_to_dac(e),this.dma_bytes_left-=t,this.dma_bytes_left||(this.raise_irq(this.dma_irq),this.dma_autoinit&&(this.dma_bytes_left=this.dma_bytes_count)))})},z.prototype.dma_to_dac=function(t){for(var e=this.dsp_16bit?32767.5:127.5,r=this.dsp_signed?0:-1,n=this.dsp_stereo?1:2,a=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8,p=0,d=0;d<t;d++)for(var m=ln(a[d]/e+r,-1,1),g=0;g<n;g++)this.dac_buffers[p].push(m),p^=1;this.dac_send()},z.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()},z.prototype.dac_send=function(){if(this.dac_buffers[0].length){var t=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),e=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[t,e],[t.buffer,e.buffer])}},z.prototype.raise_irq=function(t){this.irq_triggered[t]=1,this.cpu.device_raise_irq(this.irq)},z.prototype.lower_irq=function(t){this.irq_triggered[t]=0,this.cpu.device_lower_irq(this.irq)};function ln(t,e,r){return(t<e)*e+(t>r)*r+(e<=t&&t<=r)*t}function It(t,e){this.cpu=t,this.pci=t.devices.pci,this.device_id=e.device_id,this.pci_space=[244,26,e.device_id&255,e.device_id>>8,7,5,16,0,1,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,e.subsystem_device_id&255,e.subsystem_device_id>>8,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0],this.pci_space=this.pci_space.concat(f.zeros(256-this.pci_space.length)),this.pci_id=e.pci_id,this.pci_bars=[],this.name=e.name,this.driver_feature_select=this.device_feature_select=0,this.device_feature=new Uint32Array(4),this.driver_feature=new Uint32Array(4);for(var r of e.common.features)this.device_feature[r>>>5]|=1<<(r&31),this.driver_feature[r>>>5]|=1<<(r&31);e.common.features.includes(32),this.features_ok=!0,this.device_status=0,this.config_has_changed=!1,this.config_generation=0,this.queues=[];for(let n of e.common.queues)this.queues.push(new _t(t,this,n));this.queue_select=0,this.queue_selected=this.queues[0],this.isr_status=0,r=[],r.push(this.create_common_capability(e.common)),r.push(this.create_notification_capability(e.notification)),r.push(this.create_isr_capability(e.isr_status)),e.device_specific&&r.push(this.create_device_specific_capability(e.device_specific)),this.init_capabilities(r),t.devices.pci.register_device(this),this.reset()}It.prototype.create_common_capability=function(t){return{type:1,bar:0,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:4,name:"device_feature_select",read:()=>this.device_feature_select,write:e=>{this.device_feature_select=e}},{bytes:4,name:"device_feature",read:()=>this.device_feature[this.device_feature_select]||0,write:()=>{}},{bytes:4,name:"driver_feature_select",read:()=>this.driver_feature_select,write:e=>{this.driver_feature_select=e}},{bytes:4,name:"driver_feature",read:()=>this.driver_feature[this.driver_feature_select]||0,write:e=>{let r=this.device_feature[this.driver_feature_select];this.driver_feature_select<this.driver_feature.length&&(this.driver_feature[this.driver_feature_select]=e&r),this.features_ok=this.features_ok&&!(e&~r)}},{bytes:2,name:"msix_config",read:()=>65535,write:()=>{}},{bytes:2,name:"num_queues",read:()=>this.queues.length,write:()=>{}},{bytes:1,name:"device_status",read:()=>this.device_status,write:e=>{e===0&&this.reset(),e&~this.device_status&4&&this.device_status&64&&this.notify_config_changes(),this.features_ok||(e&=-9),this.device_status=e,e&~this.device_status&4&&t.on_driver_ok()}},{bytes:1,name:"config_generation",read:()=>this.config_generation,write:()=>{}},{bytes:2,name:"queue_select",read:()=>this.queue_select,write:e=>{this.queue_select=e,this.queue_selected=this.queue_select<this.queues.length?this.queues[this.queue_select]:null}},{bytes:2,name:"queue_size",read:()=>this.queue_selected?this.queue_selected.size:0,write:e=>{this.queue_selected&&(e&e-1&&(e=1<<f.int_log2(e-1)+1),e>this.queue_selected.size_supported&&(e=this.queue_selected.size_supported),this.queue_selected.set_size(e))}},{bytes:2,name:"queue_msix_vector",read:()=>65535,write:()=>{}},{bytes:2,name:"queue_enable",read:()=>this.queue_selected?this.queue_selected.enabled|0:0,write:e=>{this.queue_selected&&e===1&&this.queue_selected.is_configured()&&this.queue_selected.enable()}},{bytes:2,name:"queue_notify_off",read:()=>this.queue_selected?this.queue_selected.notify_offset:0,write:()=>{}},{bytes:4,name:"queue_desc (low dword)",read:()=>this.queue_selected?this.queue_selected.desc_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.desc_addr=e)}},{bytes:4,name:"queue_desc (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_avail (low dword)",read:()=>this.queue_selected?this.queue_selected.avail_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.avail_addr=e)}},{bytes:4,name:"queue_avail (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_used (low dword)",read:()=>this.queue_selected?this.queue_selected.used_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.used_addr=e)}},{bytes:4,name:"queue_used (high dword)",read:()=>0,write:()=>{}}]}},It.prototype.create_notification_capability=function(t){let e=[],r;r=t.single_handler?0:2;for(let[n,a]of t.handlers.entries())e.push({bytes:2,name:"notify"+n,read:()=>65535,write:a||(()=>{})});return{type:2,bar:1,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array([r&255,r>>8&255,r>>16&255,r>>24]),struct:e}},It.prototype.create_isr_capability=function(t){return{type:3,bar:2,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:1,name:"isr_status",read:()=>{let e=this.isr_status;return this.lower_irq(),e},write:()=>{}}]}},It.prototype.create_device_specific_capability=function(t){return{type:4,bar:3,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:t.struct}},It.prototype.init_capabilities=function(t){let e=this.pci_space[52]=64;var r=e;for(let a of t){t=16+a.extra.length,r=e,e=r+t;var n=a.struct.reduce((p,d)=>p+d.bytes,0);n+=a.offset,n=16>n?16:1<<f.int_log2(n-1)+1,this.pci_bars[a.bar]={size:n},this.pci_space[r]=9,this.pci_space[r+1]=e,this.pci_space[r+2]=t,this.pci_space[r+3]=a.type,this.pci_space[r+4]=a.bar,this.pci_space[r+5]=0,this.pci_space[r+6]=0,this.pci_space[r+7]=0,this.pci_space[r+8]=a.offset&255,this.pci_space[r+9]=a.offset>>>8&255,this.pci_space[r+10]=a.offset>>>16&255,this.pci_space[r+11]=a.offset>>>24,this.pci_space[r+12]=n&255,this.pci_space[r+13]=n>>>8&255,this.pci_space[r+14]=n>>>16&255,this.pci_space[r+15]=n>>>24;for(let[p,d]of a.extra.entries())this.pci_space[r+16+p]=d;r=16+4*a.bar,this.pci_space[r]=a.port&254|!a.use_mmio,this.pci_space[r+1]=a.port>>>8&255,this.pci_space[r+2]=a.port>>>16&255,this.pci_space[r+3]=a.port>>>24&255,r=a.port+a.offset;for(let p of a.struct){let d=p.read;if(t=p.write,!a.use_mmio){n=function(g){return d(g&-2)>>((g&1)<<3)&255};let m=function(g){return d(g&-4)>>((g&3)<<3)&255};switch(p.bytes){case 4:this.cpu.io.register_read(r,this,m,void 0,d),this.cpu.io.register_write(r,this,void 0,void 0,t);break;case 2:this.cpu.io.register_read(r,this,n,d),this.cpu.io.register_write(r,this,void 0,t);break;case 1:this.cpu.io.register_read(r,this,d),this.cpu.io.register_write(r,this,t)}}r+=p.bytes}}this.pci_space[e]=9,this.pci_space[e+1]=0,this.pci_space[e+2]=20,this.pci_space[e+3]=5,this.pci_space[e+4]=0,this.pci_space[e+5]=0,this.pci_space[e+6]=0,this.pci_space[e+7]=0,this.pci_space[e+8]=0,this.pci_space[e+9]=0,this.pci_space[e+10]=0,this.pci_space[e+11]=0,this.pci_space[e+12]=0,this.pci_space[e+13]=0,this.pci_space[e+14]=0,this.pci_space[e+15]=0,this.pci_space[e+16]=0,this.pci_space[e+17]=0,this.pci_space[e+18]=0,this.pci_space[e+19]=0},It.prototype.get_state=function(){let t=[];return t[0]=this.device_feature_select,t[1]=this.driver_feature_select,t[2]=this.device_feature,t[3]=this.driver_feature,t[4]=this.features_ok,t[5]=this.device_status,t[6]=this.config_has_changed,t[7]=this.config_generation,t[8]=this.isr_status,t[9]=this.queue_select,t=t.concat(this.queues)},It.prototype.set_state=function(t){this.device_feature_select=t[0],this.driver_feature_select=t[1],this.device_feature=t[2],this.driver_feature=t[3],this.features_ok=t[4],this.device_status=t[5],this.config_has_changed=t[6],this.config_generation=t[7],this.isr_status=t[8],this.queue_select=t[9];let e=0;for(let r of t.slice(10))this.queues[e].set_state(r),e++;this.queue_selected=this.queues[this.queue_select]||null},It.prototype.reset=function(){this.driver_feature_select=this.device_feature_select=0,this.driver_feature.set(this.device_feature),this.features_ok=!0,this.queue_select=this.device_status=0,this.queue_selected=this.queues[0];for(let t of this.queues)t.reset();this.config_has_changed=!1,this.config_generation=0,this.lower_irq()},It.prototype.notify_config_changes=function(){this.config_has_changed=!0,this.device_status&4&&this.raise_irq(2)},It.prototype.update_config_generation=function(){this.config_has_changed&&(this.config_generation++,this.config_generation&=255,this.config_has_changed=!1)},It.prototype.is_feature_negotiated=function(t){return 0<(this.driver_feature[t>>>5]&1<<(t&31))},It.prototype.needs_reset=function(){this.device_status|=64,this.device_status&4&&this.notify_config_changes()},It.prototype.raise_irq=function(t){u(t),this.isr_status|=t,this.pci.raise_irq(this.pci_id)},It.prototype.lower_irq=function(){this.isr_status=0,this.pci.lower_irq(this.pci_id)};function _t(t,e,r){this.cpu=t,this.virtio=e,this.size_supported=this.size=r.size_supported,this.mask=this.size-1,this.enabled=!1,this.notify_offset=r.notify_offset,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.reset()}_t.prototype.get_state=function(){let t=[];return t[0]=this.size,t[1]=this.size_supported,t[2]=this.enabled,t[3]=this.notify_offset,t[4]=this.desc_addr,t[5]=this.avail_addr,t[6]=this.avail_last_idx,t[7]=this.used_addr,t[8]=this.num_staged_replies,t},_t.prototype.set_state=function(t){this.size=t[0],this.size_supported=t[1],this.enabled=t[2],this.notify_offset=t[3],this.desc_addr=t[4],this.avail_addr=t[5],this.avail_last_idx=t[6],this.used_addr=t[7],this.num_staged_replies=t[8],this.mask=this.size-1},_t.prototype.reset=function(){this.enabled=!1,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.set_size(this.size_supported)},_t.prototype.is_configured=function(){return this.desc_addr&&this.avail_addr&&this.used_addr},_t.prototype.enable=function(){this.is_configured(),this.enabled=!0},_t.prototype.set_size=function(t){this.size=t,this.mask=t-1},_t.prototype.count_requests=function(){return this.avail_get_idx()-this.avail_last_idx&this.mask},_t.prototype.has_request=function(){return(this.avail_get_idx()&this.mask)!==this.avail_last_idx},_t.prototype.pop_request=function(){this.has_request();var t=this.avail_get_entry(this.avail_last_idx);return t=new Gs(this,t),this.avail_last_idx=this.avail_last_idx+1&this.mask,t},_t.prototype.push_reply=function(t){let e=this.used_get_idx()+this.num_staged_replies&this.mask;this.used_set_entry(e,t.head_idx,t.length_written),this.num_staged_replies++},_t.prototype.flush_replies=function(){if(this.num_staged_replies!==0){var t=this.used_get_idx()+this.num_staged_replies&65535;this.used_set_idx(t),this.num_staged_replies=0,this.virtio.is_feature_negotiated(29)?(this.avail_get_used_event(),this.virtio.raise_irq(1)):~this.avail_get_flags()&1&&this.virtio.raise_irq(1)}},_t.prototype.notify_me_after=function(t){t=this.avail_get_idx()+t&65535,this.used_set_avail_event(t)},_t.prototype.get_descriptor=function(t,e){return{addr_low:this.cpu.read32s(t+16*e),addr_high:this.cpu.read32s(t+16*e+4),len:this.cpu.read32s(t+16*e+8),flags:this.cpu.read16(t+16*e+12),next:this.cpu.read16(t+16*e+14)}},_t.prototype.avail_get_flags=function(){return this.cpu.read16(this.avail_addr)},_t.prototype.avail_get_idx=function(){return this.cpu.read16(this.avail_addr+2)},_t.prototype.avail_get_entry=function(t){return this.cpu.read16(this.avail_addr+4+2*t)},_t.prototype.avail_get_used_event=function(){return this.cpu.read16(this.avail_addr+4+2*this.size)},_t.prototype.used_get_flags=function(){return this.cpu.read16(this.used_addr)},_t.prototype.used_set_flags=function(t){this.cpu.write16(this.used_addr,t)},_t.prototype.used_get_idx=function(){return this.cpu.read16(this.used_addr+2)},_t.prototype.used_set_idx=function(t){this.cpu.write16(this.used_addr+2,t)},_t.prototype.used_set_entry=function(t,e,r){this.cpu.write32(this.used_addr+4+8*t,e),this.cpu.write32(this.used_addr+8+8*t,r)},_t.prototype.used_set_avail_event=function(t){this.cpu.write16(this.used_addr+4+8*this.size,t)};function Gs(t,e){this.cpu=t.cpu,this.virtio=t.virtio,this.head_idx=e,this.read_buffers=[],this.length_readable=this.read_buffer_offset=this.read_buffer_idx=0,this.write_buffers=[],this.length_writable=this.length_written=this.write_buffer_offset=this.write_buffer_idx=0;let r=t.desc_addr,n=0,a=t.size,p=!1,d=this.virtio.is_feature_negotiated(28);do{let m=t.get_descriptor(r,e);if(u(m.addr_high,8),u(m.addr_low,8),u(m.len,8),u(m.flags,4),u(m.next,4),d&&m.flags&4)r=m.addr_low,n=e=0,a=m.len/16;else{if(m.flags&2)p=!0,this.write_buffers.push(m),this.length_writable+=m.len;else{if(p)break;this.read_buffers.push(m),this.length_readable+=m.len}if(n++,n>a)break;if(m.flags&1)e=m.next;else break}}while(!0)}Gs.prototype.get_next_blob=function(t){let e=0,r=t.length;for(;r&&this.read_buffer_idx!==this.read_buffers.length;){var n=this.read_buffers[this.read_buffer_idx];let a=n.addr_low+this.read_buffer_offset;n=n.len-this.read_buffer_offset,n>r?(n=r,this.read_buffer_offset+=r):(this.read_buffer_idx++,this.read_buffer_offset=0),t.set(this.cpu.read_blob(a,n),e),e+=n,r-=n}return e},Gs.prototype.set_next_blob=function(t){let e=0,r=t.length;for(;r&&this.write_buffer_idx!==this.write_buffers.length;){var n=this.write_buffers[this.write_buffer_idx];let a=n.addr_low+this.write_buffer_offset;n=n.len-this.write_buffer_offset,n>r?(n=r,this.write_buffer_offset+=r):(this.write_buffer_idx++,this.write_buffer_offset=0),this.cpu.write_blob(t.subarray(e,e+n),a),e+=n,r-=n}return this.length_written+=e,e};function fe(t,e){this.bus=e,this.rows=25,this.cols=80,this.ports=4,e=[{size_supported:16,notify_offset:0},{size_supported:16,notify_offset:1},{size_supported:16,notify_offset:2},{size_supported:16,notify_offset:3}];for(let r=1;r<this.ports;++r)e.push({size_supported:16,notify_offset:0}),e.push({size_supported:8,notify_offset:1});this.virtio=new It(t,{name:"virtio-console",pci_id:56,device_id:4163,subsystem_device_id:3,common:{initial_port:47104,queues:e,features:[0,1,32],on_driver_ok:()=>{}},notification:{initial_port:47360,single_handler:!1,handlers:[r=>{for(r=this.virtio.queues[r];r.count_requests()>r.size-2;)r.pop_request()},r=>{let n=this.virtio.queues[r],a=3<r?r-3>>1:0;for(;n.has_request();){let p=n.pop_request(),d=new Uint8Array(p.length_readable);p.get_next_blob(d),this.bus.send("virtio-console"+a+"-output-bytes",d),this.Ack(r,p)}},r=>{if(r===2)for(r=this.virtio.queues[r];r.count_requests()>r.size-2;)r.pop_request()},r=>{if(r===3)for(var n=this.virtio.queues[r];n.has_request();){var a=n.pop_request(),p=new Uint8Array(a.length_readable);a.get_next_blob(p);var d=H.Unmarshall(["w","h","h"],p,{offset:0});switch(p=d[0],d=d[1],this.Ack(r,a),d){case 0:for(a=0;a<this.ports;++a)this.SendEvent(a,1,0);break;case 3:this.Ack(r,a),this.SendEvent(p,4,1),this.SendName(p,"virtio-"+p),this.SendEvent(p,6,1);break;case 6:this.Ack(r,a),p===0&&this.SendWindowSize(p);break;default:return}}}]},isr_status:{initial_port:46848},device_specific:{initial_port:46592,struct:[{bytes:2,name:"cols",read:()=>this.cols,write:()=>{}},{bytes:2,name:"rows",read:()=>this.rows,write:()=>{}},{bytes:4,name:"max_nr_ports",read:()=>this.ports,write:()=>{}},{bytes:4,name:"emerg_wr",read:()=>0,write:()=>{}}]}});for(let r=0;r<this.ports;++r){let n=r===0?0:2*r+2;this.bus.register("virtio-console"+r+"-input-bytes",function(a){var p=this.virtio.queues[n];p.has_request()&&(p=p.pop_request(),this.Send(n,p,new Uint8Array(a)))},this),this.bus.register("virtio-console"+r+"-resize",function(a){this.cols=a[0],this.rows=a[1],this.virtio.queues[2].is_configured()&&this.virtio.queues[2].has_request()&&this.SendWindowSize(r)},this)}}fe.prototype.SendWindowSize=function(t){let e=this.virtio.queues[2].pop_request(),r=new Uint8Array(12);H.Marshall(["w","h","h","h","h"],[t,5,0,this.rows,this.cols],r,0),this.Send(2,e,r)},fe.prototype.SendName=function(t,e){let r=this.virtio.queues[2].pop_request();e=new TextEncoder().encode(e);let n=new Uint8Array(8+e.length+1);for(H.Marshall(["w","h","h"],[t,7,1],n,0),t=0;t<e.length;++t)n[t+8]=e[t];n[8+e.length]=0,this.Send(2,r,n)},fe.prototype.get_state=function(){let t=[];return t[0]=this.virtio,t[1]=this.rows,t[2]=this.cols,t[3]=this.ports,t},fe.prototype.set_state=function(t){this.virtio.set_state(t[0]),this.rows=t[1],this.cols=t[2],this.ports=t[3]},fe.prototype.reset=function(){this.virtio.reset()},fe.prototype.SendEvent=function(t,e,r){let n=this.virtio.queues[2].pop_request(),a=new Uint8Array(8);H.Marshall(["w","h","h"],[t,e,r],a,0),this.Send(2,n,a)},fe.prototype.Send=function(t,e,r){e.set_next_blob(r),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()},fe.prototype.Ack=function(t,e){e.set_next_blob(new Uint8Array(0)),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()};var pn={};function Be(){this.listeners={},this.pair=void 0}Be.prototype.register=function(t,e,r){var n=this.listeners[t];n===void 0&&(n=this.listeners[t]=[]),n.push({fn:e,this_value:r})},Be.prototype.unregister=function(t,e){var r=this.listeners[t];r!==void 0&&(this.listeners[t]=r.filter(function(n){return n.fn!==e}))},Be.prototype.send=function(t,e){if(this.pair&&(t=this.pair.listeners[t],t!==void 0))for(var r=0;r<t.length;r++){var n=t[r];n.fn.call(n.this_value,e)}},Be.prototype.send_async=function(t,e){setTimeout(this.send.bind(this,t,e),0)},pn.create=function(){var t=new Be,e=new Be;return t.pair=e,e.pair=t,[t,e]};function Np(){}function zp(){}function V(t,e,r){this.stop_idling=r,this.wm=e,this.wasm_patch(),this.create_jit_imports(),this.wasm_memory=e=this.wm.exports.memory,this.memory_size=f.view(Uint32Array,e,812,1),this.mem8=new Uint8Array(0),this.mem32s=new Int32Array(this.mem8.buffer),this.segment_is_null=f.view(Uint8Array,e,724,8),this.segment_offsets=f.view(Int32Array,e,736,8),this.segment_limits=f.view(Uint32Array,e,768,8),this.segment_access_bytes=f.view(Uint8Array,e,512,8),this.protected_mode=f.view(Int32Array,e,800,1),this.idtr_size=f.view(Int32Array,e,564,1),this.idtr_offset=f.view(Int32Array,e,568,1),this.gdtr_size=f.view(Int32Array,e,572,1),this.gdtr_offset=f.view(Int32Array,e,576,1),this.tss_size_32=f.view(Int32Array,e,1128,1),this.page_fault=f.view(Uint32Array,e,540,8),this.cr=f.view(Int32Array,e,580,8),this.cpl=f.view(Uint8Array,e,612,1),this.is_32=f.view(Int32Array,e,804,1),this.stack_size_32=f.view(Int32Array,e,808,1),this.in_hlt=f.view(Uint8Array,e,616,1),this.last_virt_eip=f.view(Int32Array,e,620,1),this.eip_phys=f.view(Int32Array,e,624,1),this.sysenter_cs=f.view(Int32Array,e,636,1),this.sysenter_esp=f.view(Int32Array,e,640,1),this.sysenter_eip=f.view(Int32Array,e,644,1),this.prefixes=f.view(Int32Array,e,648,1),this.flags=f.view(Int32Array,e,120,1),this.flags_changed=f.view(Int32Array,e,100,1),this.last_op_size=f.view(Int32Array,e,96,1),this.last_op1=f.view(Int32Array,e,104,1),this.last_result=f.view(Int32Array,e,112,1),this.current_tsc=f.view(Uint32Array,e,960,2),this.devices={},this.instruction_pointer=f.view(Int32Array,e,556,1),this.previous_ip=f.view(Int32Array,e,560,1),this.apic_enabled=f.view(Uint8Array,e,548,1),this.acpi_enabled=f.view(Uint8Array,e,552,1),this.memory_map_read8=[],this.memory_map_write8=[],this.memory_map_read32=[],this.memory_map_write32=[],this.bios={main:null,vga:null},this.instruction_counter=f.view(Uint32Array,e,664,1),this.reg32=f.view(Int32Array,e,64,8),this.fpu_st=f.view(Int32Array,e,1152,32),this.fpu_stack_empty=f.view(Uint8Array,e,816,1),this.fpu_stack_empty[0]=255,this.fpu_stack_ptr=f.view(Uint8Array,e,1032,1),this.fpu_stack_ptr[0]=0,this.fpu_control_word=f.view(Uint16Array,e,1036,1),this.fpu_control_word[0]=895,this.fpu_status_word=f.view(Uint16Array,e,1040,1),this.fpu_status_word[0]=0,this.fpu_ip=f.view(Int32Array,e,1048,1),this.fpu_ip[0]=0,this.fpu_ip_selector=f.view(Int32Array,e,1052,1),this.fpu_ip_selector[0]=0,this.fpu_opcode=f.view(Int32Array,e,1044,1),this.fpu_opcode[0]=0,this.fpu_dp=f.view(Int32Array,e,1056,1),this.fpu_dp[0]=0,this.fpu_dp_selector=f.view(Int32Array,e,1060,1),this.fpu_dp_selector[0]=0,this.reg_xmm32s=f.view(Int32Array,e,832,32),this.mxcsr=f.view(Int32Array,e,824,1),this.sreg=f.view(Uint16Array,e,668,8),this.dreg=f.view(Int32Array,e,684,8),this.reg_pdpte=f.view(Int32Array,e,968,8),this.svga_dirty_bitmap_min_offset=f.view(Uint32Array,e,716,1),this.svga_dirty_bitmap_max_offset=f.view(Uint32Array,e,720,1),this.fw_value=[],this.fw_pointer=0,this.option_roms=[],this.io=void 0,this.bus=t,this.set_tsc(0,0),this.debug_init()}V.prototype.clear_opstats=function(){new Uint8Array(this.wasm_memory.buffer,32768,131072).fill(0),this.wm.exports.profiler_init()},V.prototype.create_jit_imports=function(){let t=Object.create(null);t.m=this.wm.exports.memory;for(let e of Object.keys(this.wm.exports))e.startsWith("_")||e.startsWith("zstd")||e.endsWith("_js")||(t[e]=this.wm.exports[e]);this.jit_imports=t},V.prototype.wasm_patch=function(){let t=r=>this.wm.exports[r],e=r=>{let n=t(r);return console.assert(n,"Missing import: "+r),n};this.reset_cpu=e("reset_cpu"),this.getiopl=e("getiopl"),this.get_eflags=e("get_eflags"),this.handle_irqs=e("handle_irqs"),this.main_loop=e("main_loop"),this.set_jit_config=e("set_jit_config"),this.read8=e("read8"),this.read16=e("read16"),this.read32s=e("read32s"),this.write8=e("write8"),this.write16=e("write16"),this.write32=e("write32"),this.in_mapped_range=e("in_mapped_range"),this.fpu_load_tag_word=e("fpu_load_tag_word"),this.fpu_load_status_word=e("fpu_load_status_word"),this.fpu_get_sti_f64=e("fpu_get_sti_f64"),this.translate_address_system_read=e("translate_address_system_read_js"),this.get_seg_cs=e("get_seg_cs"),this.get_real_eip=e("get_real_eip"),this.clear_tlb=e("clear_tlb"),this.full_clear_tlb=e("full_clear_tlb"),this.update_state_flags=e("update_state_flags"),this.set_tsc=e("set_tsc"),this.store_current_tsc=e("store_current_tsc"),this.set_cpuid_level=e("set_cpuid_level"),this.pic_set_irq=e("pic_set_irq"),this.pic_clear_irq=e("pic_clear_irq"),this.jit_clear_cache=e("jit_clear_cache_js"),this.jit_dirty_cache=e("jit_dirty_cache"),this.codegen_finalize_finished=e("codegen_finalize_finished"),this.allocate_memory=e("allocate_memory"),this.zero_memory=e("zero_memory"),this.svga_allocate_memory=e("svga_allocate_memory"),this.svga_allocate_dest_buffer=e("svga_allocate_dest_buffer"),this.svga_fill_pixel_buffer=e("svga_fill_pixel_buffer"),this.svga_mark_dirty=e("svga_mark_dirty"),this.get_pic_addr_master=e("get_pic_addr_master"),this.get_pic_addr_slave=e("get_pic_addr_slave"),this.zstd_create_ctx=e("zstd_create_ctx"),this.zstd_get_src_ptr=e("zstd_get_src_ptr"),this.zstd_free_ctx=e("zstd_free_ctx"),this.zstd_read=e("zstd_read"),this.zstd_read_free=e("zstd_read_free"),this.port20_read=e("port20_read"),this.port21_read=e("port21_read"),this.portA0_read=e("portA0_read"),this.portA1_read=e("portA1_read"),this.port20_write=e("port20_write"),this.port21_write=e("port21_write"),this.portA0_write=e("portA0_write"),this.portA1_write=e("portA1_write"),this.port4D0_read=e("port4D0_read"),this.port4D1_read=e("port4D1_read"),this.port4D0_write=e("port4D0_write"),this.port4D1_write=e("port4D1_write")},V.prototype.jit_force_generate=function(t){this.jit_force_generate_unsafe&&this.jit_force_generate_unsafe(t)},V.prototype.jit_clear_func=function(t){this.wm.wasm_table.set(t+1024,null)},V.prototype.jit_clear_all_funcs=function(){let t=this.wm.wasm_table;for(let e=0;900>e;e++)t.set(1024+e,null)},V.prototype.get_state=function(){var t=[];t[0]=this.memory_size[0],t[1]=new Uint8Array([...this.segment_is_null,...this.segment_access_bytes]),t[2]=this.segment_offsets,t[3]=this.segment_limits,t[4]=this.protected_mode[0],t[5]=this.idtr_offset[0],t[6]=this.idtr_size[0],t[7]=this.gdtr_offset[0],t[8]=this.gdtr_size[0],t[9]=this.page_fault[0],t[10]=this.cr,t[11]=this.cpl[0],t[13]=this.is_32[0],t[16]=this.stack_size_32[0],t[17]=this.in_hlt[0],t[18]=this.last_virt_eip[0],t[19]=this.eip_phys[0],t[22]=this.sysenter_cs[0],t[23]=this.sysenter_eip[0],t[24]=this.sysenter_esp[0],t[25]=this.prefixes[0],t[26]=this.flags[0],t[27]=this.flags_changed[0],t[28]=this.last_op1[0],t[30]=this.last_op_size[0],t[37]=this.instruction_pointer[0],t[38]=this.previous_ip[0],t[39]=this.reg32,t[40]=this.sreg,t[41]=this.dreg,t[42]=this.reg_pdpte,this.store_current_tsc(),t[43]=this.current_tsc,t[45]=this.devices.virtio_9p,t[46]=this.devices.apic,t[47]=this.devices.rtc,t[48]=this.devices.pci,t[49]=this.devices.dma,t[50]=this.devices.acpi,t[52]=this.devices.vga,t[53]=this.devices.ps2,t[54]=this.devices.uart0,t[55]=this.devices.fdc,t[56]=this.devices.cdrom,t[57]=this.devices.hda,t[58]=this.devices.pit,t[59]=this.devices.net,t[60]=this.get_state_pic(),t[61]=this.devices.sb16,t[62]=this.fw_value,t[63]=this.devices.ioapic,t[64]=this.tss_size_32[0],t[66]=this.reg_xmm32s,t[67]=this.fpu_st,t[68]=this.fpu_stack_empty[0],t[69]=this.fpu_stack_ptr[0],t[70]=this.fpu_control_word[0],t[71]=this.fpu_ip[0],t[72]=this.fpu_ip_selector[0],t[73]=this.fpu_dp[0],t[74]=this.fpu_dp_selector[0],t[75]=this.fpu_opcode[0];let{packed_memory:e,bitmap:r}=this.pack_memory();return t[77]=e,t[78]=new Uint8Array(r.get_buffer()),t[79]=this.devices.uart1,t[80]=this.devices.uart2,t[81]=this.devices.uart3,t[82]=this.devices.virtio_console,t},V.prototype.get_state_pic=function(){let t=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13),r=[],n=[];return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=n,r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=null,n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],r},V.prototype.set_state=function(t){this.memory_size[0]=t[0],this.mem8.length!==this.memory_size[0]&&console.warn("Note: Memory size mismatch. we="+this.mem8.length+" state="+this.memory_size[0]),t[1].length===8?(this.segment_is_null.set(t[1]),this.segment_access_bytes.fill(242),this.segment_access_bytes[1]=250):t[1].length===16&&(this.segment_is_null.set(t[1].subarray(0,8)),this.segment_access_bytes.set(t[1].subarray(8,16))),this.segment_offsets.set(t[2]),this.segment_limits.set(t[3]),this.protected_mode[0]=t[4],this.idtr_offset[0]=t[5],this.idtr_size[0]=t[6],this.gdtr_offset[0]=t[7],this.gdtr_size[0]=t[8],this.page_fault[0]=t[9],this.cr.set(t[10]),this.cpl[0]=t[11],this.is_32[0]=t[13],this.stack_size_32[0]=t[16],this.in_hlt[0]=t[17],this.last_virt_eip[0]=t[18],this.eip_phys[0]=t[19],this.sysenter_cs[0]=t[22],this.sysenter_eip[0]=t[23],this.sysenter_esp[0]=t[24],this.prefixes[0]=t[25],this.flags[0]=t[26],this.flags_changed[0]=t[27],this.last_op1[0]=t[28],this.last_op_size[0]=t[30],this.instruction_pointer[0]=t[37],this.previous_ip[0]=t[38],this.reg32.set(t[39]),this.sreg.set(t[40]),this.dreg.set(t[41]),t[42]&&this.reg_pdpte.set(t[42]),this.set_tsc(t[43][0],t[43][1]),this.devices.virtio_9p&&this.devices.virtio_9p.set_state(t[45]),this.devices.apic&&this.devices.apic.set_state(t[46]),this.devices.rtc&&this.devices.rtc.set_state(t[47]),this.devices.pci&&this.devices.pci.set_state(t[48]),this.devices.dma&&this.devices.dma.set_state(t[49]),this.devices.acpi&&this.devices.acpi.set_state(t[50]),this.devices.vga&&this.devices.vga.set_state(t[52]),this.devices.ps2&&this.devices.ps2.set_state(t[53]),this.devices.uart0&&this.devices.uart0.set_state(t[54]),this.devices.fdc&&this.devices.fdc.set_state(t[55]),this.devices.cdrom&&this.devices.cdrom.set_state(t[56]),this.devices.hda&&this.devices.hda.set_state(t[57]),this.devices.pit&&this.devices.pit.set_state(t[58]),this.devices.net&&this.devices.net.set_state(t[59]),this.set_state_pic(t[60]),this.devices.sb16&&this.devices.sb16.set_state(t[61]),this.devices.uart1&&this.devices.uart1.set_state(t[79]),this.devices.uart2&&this.devices.uart2.set_state(t[80]),this.devices.uart3&&this.devices.uart3.set_state(t[81]),this.devices.virtio_console&&this.devices.virtio_console.set_state(t[82]),this.fw_value=t[62],this.devices.ioapic&&this.devices.ioapic.set_state(t[63]),this.tss_size_32[0]=t[64],this.reg_xmm32s.set(t[66]),this.fpu_st.set(t[67]),this.fpu_stack_empty[0]=t[68],this.fpu_stack_ptr[0]=t[69],this.fpu_control_word[0]=t[70],this.fpu_ip[0]=t[71],this.fpu_ip_selector[0]=t[72],this.fpu_dp[0]=t[73],this.fpu_dp_selector[0]=t[74],this.fpu_opcode[0]=t[75];let e=new f.Bitmap(t[78].buffer);this.unpack_memory(e,t[77]),this.update_state_flags(),this.full_clear_tlb(),this.jit_clear_cache()},V.prototype.set_state_pic=function(t){let e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),r=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13);e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4];let n=t[5];e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12]},V.prototype.pack_memory=function(){for(var t=this.mem8.length>>12,e=[],r=0;r<t;r++){var n=r<<12;n=this.mem32s.subarray(n>>2,n+4096>>2);let a=!0;for(let p=0;p<n.length;p++)if(n[p]!==0){a=!1;break}a||e.push(r)}t=new f.Bitmap(t),r=new Uint8Array(e.length<<12);for(let[a,p]of e.entries())t.set(p,1),e=p<<12,e=this.mem8.subarray(e,e+4096),r.set(e,a<<12);return{bitmap:t,packed_memory:r}},V.prototype.unpack_memory=function(t,e){this.zero_memory(this.memory_size[0]);let r=this.memory_size[0]>>12,n=0;for(let p=0;p<r;p++)if(t.get(p)){var a=n<<12;a=e.subarray(a,a+4096),this.mem8.set(a,p<<12),n++}},V.prototype.reboot_internal=function(){this.reset_cpu(),this.fw_value=[],this.devices.virtio_9p&&this.devices.virtio_9p.reset(),this.devices.virtio_console&&this.devices.virtio_console.reset(),this.load_bios()},V.prototype.reset_memory=function(){this.mem8.fill(0)},V.prototype.create_memory=function(t){1048576>t?t=1048576:0>(t|0)&&(t=Math.pow(2,31)-131072),t=(t-1|131071)+1|0,console.assert(this.memory_size[0]===0,"Expected uninitialised memory"),this.memory_size[0]=t;let e=this.allocate_memory(t);this.mem8=f.view(Uint8Array,this.wasm_memory,e,t),this.mem32s=f.view(Uint32Array,this.wasm_memory,e,t>>2)},l.exportProperty(V.prototype,"create_memory",V.prototype.create_memory),V.prototype.init=function(t,e){this.create_memory(typeof t.memory_size=="number"?t.memory_size:67108864),t.disable_jit&&this.set_jit_config(0,1),t.cpuid_level&&this.set_cpuid_level(t.cpuid_level),this.acpi_enabled[0]=+t.acpi,this.reset_cpu();var r=new h(this);if(this.io=r,this.bios.main=t.bios,this.bios.vga=t.vga_bios,this.load_bios(),t.bzimage){let a=gc(this.mem8,t.bzimage,t.initrd,t.cmdline||"");a&&this.option_roms.push(a)}r.register_read(179,this,function(){return 0});var n=0;r.register_read(146,this,function(){return n}),r.register_write(146,this,function(a){n=a}),r.register_read(1297,this,function(){return this.fw_pointer<this.fw_value.length?this.fw_value[this.fw_pointer++]:0}),r.register_write(1296,this,void 0,function(a){function p(g){return new Uint8Array(Int32Array.of(g).buffer)}function d(g){return g>>8|g<<8&65280}function m(g){return g<<24|g<<8&16711680|g>>8&65280|g>>>24}if(""+u(a),this.fw_pointer=0,a===0)this.fw_value=p(1431127377);else if(a===1)this.fw_value=p(0);else if(a===3)this.fw_value=p(this.memory_size[0]);else if(a===5)this.fw_value=p(1);else if(a===15)this.fw_value=p(1);else if(a===13)this.fw_value=new Uint8Array(16);else if(a===25){a=new Int32Array(4+64*this.option_roms.length);let g=new Uint8Array(a.buffer);a[0]=m(this.option_roms.length);for(let y=0;y<this.option_roms.length;y++){let{name:b,data:E}=this.option_roms[y],R=4+64*y;a[R+0>>2]=m(E.length),a[R+4>>2]=d(49152+y);for(let C=0;C<b.length;C++)g[R+8+C]=b.charCodeAt(C)}this.fw_value=g}else 32768<=a&&49152>a?this.fw_value=p(0):49152<=a&&a-49152<this.option_roms.length?this.fw_value=this.option_roms[a-49152].data:(""+u(a),this.fw_value=p(0))}),r.register_read(32,this,this.port20_read),r.register_read(33,this,this.port21_read),r.register_read(160,this,this.portA0_read),r.register_read(161,this,this.portA1_read),r.register_write(32,this,this.port20_write),r.register_write(33,this,this.port21_write),r.register_write(160,this,this.portA0_write),r.register_write(161,this,this.portA1_write),r.register_read(1232,this,this.port4D0_read),r.register_read(1233,this,this.port4D1_read),r.register_write(1232,this,this.port4D0_write),r.register_write(1233,this,this.port4D1_write),this.devices={},t.load_devices&&(this.devices.pci=new D(this),this.acpi_enabled[0]&&(this.devices.ioapic=new J(this),this.devices.apic=new K(this),this.devices.acpi=new W(this)),this.devices.rtc=new ot(this),this.fill_cmos(this.devices.rtc,t),this.devices.dma=new I(this),this.devices.vga=new q(this,e,t.vga_memory_size||8388608),this.devices.ps2=new tt(this,e),this.devices.uart0=new at(this,1016,e),t.uart1&&(this.devices.uart1=new at(this,760,e)),t.uart2&&(this.devices.uart2=new at(this,1e3,e)),t.uart3&&(this.devices.uart3=new at(this,744,e)),this.devices.fdc=new O(this,t.fda,t.fdb),r=0,t.hda&&(this.devices.hda=new x(this,t.hda,t.hdb,!1,r++,e)),t.cdrom&&(this.devices.cdrom=new x(this,t.cdrom,void 0,!0,r++,e)),this.devices.pit=new B(this,e),t.enable_ne2k&&(this.devices.net=new it(this,e,t.preserve_mac_from_state_image,t.mac_address_translation)),t.fs9p&&(this.devices.virtio_9p=new s(t.fs9p,this,e)),t.virtio_console&&(this.devices.virtio_console=new fe(this,e)),this.devices.sb16=new z(this,e)),t.multiboot&&(t=this.load_multiboot_option_rom(t.multiboot,t.initrd,t.cmdline))&&(this.bios.main?this.option_roms.push(t):this.reg32[0]=this.io.port_read32(244))},V.prototype.load_multiboot=function(t){this.load_multiboot_option_rom(t,void 0,"")&&(this.reg32[0]=this.io.port_read32(244))},V.prototype.load_multiboot_option_rom=function(t,e,r){if(8192>t.byteLength){var n=new Int32Array(2048);new Uint8Array(n.buffer).set(new Uint8Array(t))}else n=new Int32Array(t,0,2048);for(var a=0;8192>a;a+=4){if(n[a>>2]===464367618){var p=n[a+4>>2];if(464367618+p+n[a+8>>2]|0)continue}else continue;""+u(p>>>0,8);var d=this;this.io.register_read(244,this,function(){return 0},function(){return 0},function(){var b=31860,E=0;if(r){E|=4,d.write32(31760,b),r+="\0";var R=new TextEncoder().encode(r);d.write_blob(R,b),b+=R.length}if(p&2){E|=64,R=0,d.write32(31788,0),d.write32(31792,b);var C=0,U=!1;for(let P=0;4294967296>P;P+=131072)U&&d.memory_map_read8[P>>>17]!==void 0?(d.write32(b,20),d.write32(b+4,C),d.write32(b+8,0),d.write32(b+12,P-C),d.write32(b+16,0),d.write32(b+20,1),b+=24,R+=24,U=!1):U||d.memory_map_read8[P>>>17]!==void 0||(C=P,U=!0);d.write32(31788,R)}if(d.write32(31744,E),R=E=0,p&65536){U=n[a+12>>2],E=n[a+16>>2];var F=n[a+20>>2];R=n[a+24>>2],C=n[a+28>>2],u(U,8),u(E,8),u(F,8),u(R,8),u(C,8),U=new Uint8Array(t,a-(U-E),F===0?void 0:F-E),d.write_blob(U,E),E=C|0,R=Math.max(F,R)}else if(n[0]===1179403647){C=new DataView(t);let[P,X]=yn(C,fn);console.assert(X===52),console.assert(P.magic===1179403647,"Bad magic"),console.assert(P.class===1,"Unimplemented: 64 bit elf"),console.assert(P.data===1,"Unimplemented: big endian"),console.assert(P.version0===1,"Bad version0"),console.assert(P.type===2,"Unimplemented type"),console.assert(P.version1===1,"Bad version1"),console.assert(P.ehsize===52,"Bad header size"),console.assert(P.phentsize===32,"Bad program header size"),console.assert(P.shentsize===40,"Bad section header size"),[E]=wn(new DataView(C.buffer,C.byteOffset+P.phoff,P.phentsize*P.phnum),mn,P.phnum),wn(new DataView(C.buffer,C.byteOffset+P.shoff,P.shentsize*P.shnum),gn,P.shnum),C=P,U=E,E=C.entry;for(F of U)F.type!==0&&(F.type===1?F.paddr+F.memsz<d.memory_size[0]?(F.filesz&&(U=new Uint8Array(t,F.offset,F.filesz),d.write_blob(U,F.paddr)),R=Math.max(R,F.paddr+F.memsz),E===C.entry&&F.vaddr<=E&&F.vaddr+F.memsz>E&&(E=E-F.vaddr+F.paddr)):u(F.paddr):F.type===2||F.type===3||F.type===4||F.type===6||F.type===7||F.type===1685382480||F.type===1685382481||F.type===1685382482||F.type===1685382483||u(F.type))}for(e&&(d.write32(31764,1),d.write32(31768,b),F=R,F&4095&&(F=(F&-4096)+4096),R=F+e.byteLength,d.write32(b,F),d.write32(b+4,R),d.write32(b+8,0),d.write32(b+12,0),d.write_blob(new Uint8Array(e),F)),d.reg32[3]=31744,d.cr[0]=1,d.protected_mode[0]=1,d.flags[0]=2,d.is_32[0]=1,d.stack_size_32[0]=1,b=0;6>b;b++)d.segment_is_null[b]=0,d.segment_offsets[b]=0,d.segment_limits[b]=4294967295,d.sreg[b]=45058;return d.instruction_pointer[0]=d.get_seg_cs()+E|0,d.update_state_flags(),d.debug.dump_state(),d.debug.dump_regs(),732803074}),this.io.register_write_consecutive(244,this,function(b){throw console.log("Test exited with code "+u(b,2)),"HALT"},function(){},function(){},function(){});for(let b=0;15>=b;b++){let E=function(R){u(b),u(R,2),R?this.device_raise_irq(b):this.device_lower_irq(b)};this.io.register_write(8192+b,this,E,E,E)}let g=new Uint8Array(512);new Uint16Array(g.buffer)[0]=43605,g[2]=1;var m=3;g[m++]=102,g[m++]=229,g[m++]=244;let y=g[m]=0;for(let b=0;b<g.length;b++)y+=g[b];return g[m]=-y,{name:"genroms/multiboot.bin",data:g}}},V.prototype.fill_cmos=function(t,e){var r=e.boot_order||291;t.cmos_write(56,1|r>>4&240),t.cmos_write(61,r&255),t.cmos_write(21,128),t.cmos_write(22,2),r=0,1048576<=this.memory_size[0]&&(r=this.memory_size[0]-1048576>>10,r=Math.min(r,65535)),t.cmos_write(23,r&255),t.cmos_write(24,r>>8&255),t.cmos_write(48,r&255),t.cmos_write(49,r>>8&255),r=0,16777216<=this.memory_size[0]&&(r=this.memory_size[0]-16777216>>16,r=Math.min(r,65535)),t.cmos_write(52,r&255),t.cmos_write(53,r>>8&255),t.cmos_write(91,0),t.cmos_write(92,0),t.cmos_write(93,0),t.cmos_write(20,47),t.cmos_write(95,0),e.fastboot&&t.cmos_write(63,1)},V.prototype.load_bios=function(){var t=this.bios.main,e=this.bios.vga;if(t){var r=new Uint8Array(t);if(this.write_blob(r,1048576-t.byteLength),e){var n=new Uint8Array(e);this.write_blob(n,786432),this.io.mmap_register(4272947200,1048576,function(a){return a=a-4272947200|0,a<n.length?n[a]:0},function(){})}this.io.mmap_register(4293918720,1048576,function(a){return this.mem8[a&1048575]}.bind(this),function(a,p){this.mem8[a&1048575]=p}.bind(this))}},V.prototype.codegen_finalize=function(t,e,r,n,a){let p=new Uint8Array(this.wasm_memory.buffer,n>>>0,a>>>0);WebAssembly.instantiate(p,{e:this.jit_imports}).then(d=>{this.wm.wasm_table.set(t+1024,d.instance.exports.f),this.codegen_finalize_finished(t,e,r),this.test_hook_did_finalize_wasm&&this.test_hook_did_finalize_wasm(p)})},V.prototype.log_uncompiled_code=function(){},V.prototype.dump_function_code=function(){},V.prototype.run_hardware_timers=function(t,e){let r=this.devices.pit.timer(e,!1),n=this.devices.rtc.timer(e,!1),a=100,p=100;return t&&(a=this.devices.acpi.timer(e),p=this.devices.apic.timer(e)),Math.min(r,n,a,p)},V.prototype.device_raise_irq=function(t){this.pic_set_irq(t),this.devices.ioapic&&this.devices.ioapic.set_irq(t)},V.prototype.device_lower_irq=function(t){this.pic_clear_irq(t),this.devices.ioapic&&this.devices.ioapic.clear_irq(t)},typeof window<"u"?window.CPU=V:typeof Ft<"u"&&typeof Ft.exports<"u"?Ft.exports.CPU=V:typeof importScripts=="function"&&(self.CPU=V),V.prototype.debug_init=function(){var t=this,e={};this.debug=e,e.init=function(){},e.get_regs_short=function(){},e.dump_regs=function(){},e.get_state=function(){},e.dump_state=function(){},e.dump_stack=function(){},e.dump_page_structures=function(){if(t.cr[4]&32)for(var p=0;4>p;p++)t.read32s(t.cr[3]+8*p)},e.dump_gdt_ldt=function(){},e.dump_idt=function(){},e.get_memory_dump=function(){},e.memory_hex_dump=function(){},e.used_memory_dump=function(){},e.debug_interrupt=function(){};let r,n;e.dump_code=function(p,d,m){if(!n){if(r===void 0&&(r=typeof st=="function"?st("./capstone-x86.min.js"):window.cs,r===void 0))return;n=[new r.Capstone(r.ARCH_X86,r.MODE_16),new r.Capstone(r.ARCH_X86,r.MODE_32)]}try{n[p].disasm(d,m).forEach(function(g){u(g.address>>>0)+""+f.pads(g.bytes.map(y=>u(y,2).slice(-2)).join(" "),20)+g.mnemonic+g.op_str})}catch{""+Array.from(d).map(y=>u(y,2)).join(" ")}};let a;e.dump_wasm=function(p){if(!(a===void 0&&(a=typeof st=="function"?st("./libwabt.js"):new window.WabtModule,a===void 0))){p=p.slice();try{var d=a.readWasm(p,{readDebugNames:!1});d.generateNames(),d.applyNames(),d.toText({foldExprs:!0,inlineExport:!0})}catch(y){var m=new Blob([p]),g=document.createElement("a");g.download="failed.wasm",g.href=window.URL.createObjectURL(m),g.dataset.downloadurl=["application/octet-stream",g.download,g.href].join(":"),g.click(),window.URL.revokeObjectURL(g.src),console.log(y.toString())}finally{d&&d.destroy()}}}};let je=DataView.prototype,_i={size:1,get:je.getUint8,set:je.setUint8},Se={size:2,get:je.getUint16,set:je.setUint16},ut={size:4,get:je.getUint32,set:je.setUint32},fn=$s([{magic:ut},{class:_i},{data:_i},{version0:_i},{osabi:_i},{abiversion:_i},{pad0:function(t){return{size:t,get:()=>-1}}(7)},{type:Se},{machine:Se},{version1:ut},{entry:ut},{phoff:ut},{shoff:ut},{flags:ut},{ehsize:Se},{phentsize:Se},{phnum:Se},{shentsize:Se},{shnum:Se},{shstrndx:Se}]);console.assert(fn.reduce((t,e)=>t+e.size,0)===52);let mn=$s([{type:ut},{offset:ut},{vaddr:ut},{paddr:ut},{filesz:ut},{memsz:ut},{flags:ut},{align:ut}]);console.assert(mn.reduce((t,e)=>t+e.size,0)===32);let gn=$s([{name:ut},{type:ut},{flags:ut},{addr:ut},{offset:ut},{size:ut},{link:ut},{info:ut},{addralign:ut},{entsize:ut}]);console.assert(gn.reduce((t,e)=>t+e.size,0)===40);function $s(t){return t.map(function(e){var r=Object.keys(e);return console.assert(r.length===1),r=r[0],e=e[r],console.assert(0<e.size),{name:r,type:e,size:e.size,get:e.get,set:e.set}})}function yn(t,e){let r={},n=0;for(let a of e)e=a.get.call(t,n,!0),console.assert(r[a.name]===void 0),r[a.name]=e,n+=a.size;return[r,n]}function wn(t,e,r){let n=[],a=0;for(var p=0;p<r;p++){let[d,m]=yn(new DataView(t.buffer,t.byteOffset+a,void 0),e);n.push(d),a+=m}return[n,a]}function gc(t,e,r,n){var a=new Uint8Array(e);let p=new Uint16Array(e);var d=new Uint32Array(e),m=a[497]||4,g=p[255];if(g!==43605)u(g);else if(g=p[257]|p[258]<<16,g!==1400005704)u(g);else{g=p[259];var y=a[529],b=p[283],E=d[139],R=d[140],C=a[565],U=518<=g?d[142]:255,F=d[146],P=d[147],X=d[150],Rt=d[151],$t=d[152];for(u(g),u(y),u(b),u(d[133]),u(E),u(R),u(C),u(U),u(F),u(P),u(Rt),u(X),u($t),a[528]=255,a[529]=y&-97|128,p[274]=56832,p[253]=65535,u(56832),n+="\0",u(581632),d[138]=581632,a=0;a<n.length;a++)t[581632+a]=n.charCodeAt(a);for(m=512*(m+1),u(m),n=new Uint8Array(e,0,m),e=new Uint8Array(e,m),a=m=0,r&&(m=67108864,a=r.byteLength,t.set(new Uint8Array(r),m)),d[134]=m,d[135]=a,t.set(n,524288),t.set(e,1048576),t=new Uint8Array(512),new Uint16Array(t.buffer)[0]=43605,t[2]=1,r=3,t[r++]=250,t[r++]=184,t[r++]=32768,t[r++]=128,t[r++]=142,t[r++]=192,t[r++]=142,t[r++]=216,t[r++]=142,t[r++]=224,t[r++]=142,t[r++]=232,t[r++]=142,t[r++]=208,t[r++]=188,t[r++]=57344,t[r++]=224,t[r++]=234,t[r++]=0,t[r++]=0,t[r++]=32800,t[r++]=128,d=t[r]=0,e=0;e<t.length;e++)d+=t[e];return t[r]=-d,{name:"genroms/kernel.bin",data:t}}}function yc(t){function e(C){return!C.altKey&&m[56]&&p(56,!1),a(C,!1)}function r(C){return!C.altKey&&m[56]&&p(56,!1),a(C,!0)}function n(){for(var C=Object.keys(m),U,F=0;F<C.length;F++)U=+C[F],m[U]&&p(U,!1);m={}}function a(C,U){var F;if((F=g.bus)&&(F=C.shiftKey&&C.ctrlKey&&(C.keyCode===73||C.keyCode===74||C.keyCode===75)||!g.emu_enabled?!1:C.target?C.target.classList.contains("phone_keyboard")||C.target.nodeName!=="INPUT"&&C.target.nodeName!=="TEXTAREA":!0),F){t:{if(C.code!==void 0&&(F=R[C.code],F!==void 0))break t;F=y[C.keyCode]}if(F)return p(F,U,C.repeat),C.preventDefault&&C.preventDefault(),!1;console.log("Missing char in map: keyCode="+(C.keyCode||-1).toString(16)+" code="+C.code)}}function p(C,U,F){if(U)m[C]&&!F&&p(C,!1);else if(!m[C])return;(m[C]=U)||(C|=128),255<C?(d(C>>8),d(C&255)):d(C)}function d(C){g.bus.send("keyboard-code",C)}var m={},g=this;this.emu_enabled=!0;var y=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),b={8:8,10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},E={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192},R={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,IntlRo:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57415,ArrowUp:57416,PageUp:57417,ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=t,this.destroy=function(){typeof window<"u"&&(window.removeEventListener("keyup",e,!1),window.removeEventListener("keydown",r,!1),window.removeEventListener("blur",n,!1))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("keyup",e,!1),window.addEventListener("keydown",r,!1),window.addEventListener("blur",n,!1))},this.init(),this.simulate_press=function(C){C={keyCode:C},a(C,!0),a(C,!1)},this.simulate_char=function(C){var U=C.charCodeAt(0);U in b?this.simulate_press(b[U]):U in E?(d(42),this.simulate_press(E[U]),d(170)):console.log("ascii -> keyCode not found: ",U,C)}}function wc(t,e){function r(P){if(!F.enabled||!F.emu_enabled)return!1;var X=e||document.body,Rt;if(!(Rt=document.pointerLockElement))t:{for(P=P.target;P.parentNode;){if(P===X){Rt=!0;break t}P=P.parentNode}Rt=!1}return Rt}function n(P){r(P)&&(P=P.changedTouches)&&P.length&&(P=P[P.length-1],C=P.clientX,U=P.clientY)}function a(){(b||R||E)&&(F.bus.send("mouse-click",[!1,!1,!1]),b=R=E=!1)}function p(P){if(F.bus&&r(P)&&F.is_running){var X=0,Rt=0,$t=P.changedTouches;$t?$t.length&&($t=$t[$t.length-1],X=$t.clientX-C,Rt=$t.clientY-U,C=$t.clientX,U=$t.clientY,P.preventDefault()):typeof P.movementX=="number"?(X=P.movementX,Rt=P.movementY):typeof P.webkitMovementX=="number"?(X=P.webkitMovementX,Rt=P.webkitMovementY):typeof P.mozMovementX=="number"?(X=P.mozMovementX,Rt=P.mozMovementY):(X=P.clientX-C,Rt=P.clientY-U,C=P.clientX,U=P.clientY),F.bus.send("mouse-delta",[.15*X,-(.15*Rt)]),e&&F.bus.send("mouse-absolute",[P.pageX-e.offsetLeft,P.pageY-e.offsetTop,e.offsetWidth,e.offsetHeight])}}function d(P){r(P)&&g(P,!0)}function m(P){r(P)&&g(P,!1)}function g(P,X){F.bus&&(P.which===1?b=X:P.which===2?R=X:P.which===3&&(E=X),F.bus.send("mouse-click",[b,R,E]),P.preventDefault())}function y(P){if(r(P)){var X=P.wheelDelta||-P.detail;0>X?X=-1:0<X&&(X=1),F.bus.send("mouse-wheel",[X,0]),P.preventDefault()}}var b=!1,E=!1,R=!1,C=0,U=0,F=this;this.enabled=!1,this.emu_enabled=!0,this.bus=t,this.bus.register("mouse-enable",function(P){this.enabled=P},this),this.is_running=!1,this.bus.register("emulator-stopped",function(){this.is_running=!1},this),this.bus.register("emulator-started",function(){this.is_running=!0},this),this.destroy=function(){typeof window<"u"&&(window.removeEventListener("touchstart",n,!1),window.removeEventListener("touchend",a,!1),window.removeEventListener("touchmove",p,!1),window.removeEventListener("mousemove",p,!1),window.removeEventListener("mousedown",d,!1),window.removeEventListener("mouseup",m,!1),window.removeEventListener("wheel",y,{passive:!1}))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("touchstart",n,!1),window.addEventListener("touchend",a,!1),window.addEventListener("touchmove",p,!1),window.addEventListener("mousemove",p,!1),window.addEventListener("mousedown",d,!1),window.addEventListener("mouseup",m,!1),window.addEventListener("wheel",y,{passive:!1}))},this.init()}function vn(t){if(typeof window<"u")if(window.AudioContext||window.webkitAudioContext){var e=window.AudioWorklet?Hs:Ks;this.bus=t,this.audio_context=window.AudioContext?new AudioContext:new webkitAudioContext,this.mixer=new We(t,this.audio_context),this.pcspeaker=new bn(t,this.audio_context,this.mixer),this.dac=new e(t,this.audio_context,this.mixer),this.pcspeaker.start(),t.register("emulator-stopped",function(){this.audio_context.suspend()},this),t.register("emulator-started",function(){this.audio_context.resume()},this),t.register("speaker-confirm-initialized",function(){t.send("speaker-has-initialized")},this),t.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}vn.prototype.destroy=function(){this.audio_context&&this.audio_context.close(),this.audio_context=null,this.dac&&this.dac.node_processor&&this.dac.node_processor.port.close(),this.dac=null};function We(t,e){function r(n){return function(a){n.gain.setValueAtTime(a,this.audio_context.currentTime)}}this.audio_context=e,this.sources=new Map,this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1,this.node_treble_left=this.audio_context.createBiquadFilter(),this.node_treble_right=this.audio_context.createBiquadFilter(),this.node_treble_left.type="highshelf",this.node_treble_right.type="highshelf",this.node_treble_left.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_treble_right.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_bass_left=this.audio_context.createBiquadFilter(),this.node_bass_right=this.audio_context.createBiquadFilter(),this.node_bass_left.type="lowshelf",this.node_bass_right.type="lowshelf",this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_gain_left=this.audio_context.createGain(),this.node_gain_right=this.audio_context.createGain(),this.node_merger=this.audio_context.createChannelMerger(2),this.input_left=this.node_treble_left,this.input_right=this.node_treble_right,this.node_treble_left.connect(this.node_bass_left),this.node_bass_left.connect(this.node_gain_left),this.node_gain_left.connect(this.node_merger,0,0),this.node_treble_right.connect(this.node_bass_right),this.node_bass_right.connect(this.node_gain_right),this.node_gain_right.connect(this.node_merger,0,1),this.node_merger.connect(this.audio_context.destination),t.register("mixer-connect",function(n){this.connect_source(n[0],n[1])},this),t.register("mixer-disconnect",function(n){this.disconnect_source(n[0],n[1])},this),t.register("mixer-volume",function(n){var a=n[0],p=n[1];n=Math.pow(10,n[2]/20),a=a===0?this:this.sources.get(a),a===void 0||a.set_volume(n,p)},this),t.register("mixer-gain-left",function(n){this.gain_left=Math.pow(10,n/20),this.update()},this),t.register("mixer-gain-right",function(n){this.gain_right=Math.pow(10,n/20),this.update()},this),t.register("mixer-treble-left",r(this.node_treble_left),this),t.register("mixer-treble-right",r(this.node_treble_right),this),t.register("mixer-bass-left",r(this.node_bass_left),this),t.register("mixer-bass-right",r(this.node_bass_right),this)}We.prototype.add_source=function(t,e){return t=new Ge(this.audio_context,t,this.input_left,this.input_right),this.sources.has(e),this.sources.set(e,t),t},We.prototype.connect_source=function(t,e){t=this.sources.get(t),t===void 0||t.connect(e)},We.prototype.disconnect_source=function(t,e){t=this.sources.get(t),t===void 0||t.disconnect(e)},We.prototype.set_volume=function(t,e){switch(e===void 0&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()},We.prototype.update=function(){var t=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)};function Ge(t,e,r,n){this.audio_context=t,this.connected_right=this.connected_left=!0,this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1,this.node_splitter=t.createChannelSplitter(2),this.node_gain_left=t.createGain(),this.node_gain_right=t.createGain(),e.connect(this.node_splitter),this.node_splitter.connect(this.node_gain_left,0),this.node_gain_left.connect(r),this.node_splitter.connect(this.node_gain_right,1),this.node_gain_right.connect(n)}Ge.prototype.update=function(){var t=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)},Ge.prototype.connect=function(t){var e=!t||t===2;(e||t===0)&&(this.connected_left=!0),(e||t===1)&&(this.connected_right=!0),this.update()},Ge.prototype.disconnect=function(t){var e=!t||t===2;(e||t===0)&&(this.connected_left=!1),(e||t===1)&&(this.connected_right=!1),this.update()},Ge.prototype.set_volume=function(t,e){switch(e===void 0&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()},Ge.prototype.set_gain_hidden=function(t){this.gain_hidden=t};function bn(t,e,r){this.node_oscillator=e.createOscillator(),this.node_oscillator.type="square",this.node_oscillator.frequency.setValueAtTime(440,e.currentTime),this.mixer_connection=r.add_source(this.node_oscillator,1),this.mixer_connection.disconnect(),t.register("pcspeaker-enable",function(){r.connect_source(1)},this),t.register("pcspeaker-disable",function(){r.disconnect_source(1)},this),t.register("pcspeaker-update",function(n){var a=n[1],p=0;n[0]===3&&(p=Math.min(1.1931816665999999e6/a,this.node_oscillator.frequency.maxValue),p=Math.max(p,0)),this.node_oscillator.frequency.setValueAtTime(p,e.currentTime)},this)}bn.prototype.start=function(){this.node_oscillator.start()};function Hs(t,e,r){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=48e3,e=function(){function d(y){return y===0?1:(y*=Math.PI,Math.sin(y)/y)}function m(){var y=Reflect.construct(AudioWorkletProcessor,[],m);return y.kernel_size=3,y.queue_data=Array(1024),y.queue_start=0,y.queue_end=0,y.queue_length=0,y.queue_size=y.queue_data.length,y.queued_samples=0,y.source_buffer_previous=g,y.source_buffer_current=g,y.source_samples_per_destination=1,y.source_block_start=0,y.source_time=0,y.source_offset=0,y.port.onmessage=b=>{switch(b.data.type){case"queue":y.queue_push(b.data.value);break;case"sampling-rate":y.source_samples_per_destination=b.data.value/sampleRate}},y}var g=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(m.prototype,AudioWorkletProcessor.prototype),Reflect.setPrototypeOf(m,AudioWorkletProcessor),m.prototype.process=m.prototype.process=function(y,b){for(y=0;y<b[0][0].length;y++){for(var E=0,R=0,C=this.source_offset+this.kernel_size,U=this.source_offset-this.kernel_size+1;U<=C;U++){var F=this.source_block_start+U;E+=this.get_sample(F,0)*this.kernel(this.source_time-U),R+=this.get_sample(F,1)*this.kernel(this.source_time-U)}(isNaN(E)||isNaN(R))&&(E=R=0,this.dbg_log("ERROR: NaN values! Ignoring for now.")),b[0][0][y]=E,b[0][1][y]=R,this.source_time+=this.source_samples_per_destination,this.source_offset=Math.floor(this.source_time)}return b=this.source_offset,b+=this.kernel_size+2,this.source_time-=this.source_offset,this.source_block_start+=this.source_offset,this.source_offset=0,this.ensure_enough_data(b),!0},m.prototype.kernel=function(y){return d(y)*d(y/this.kernel_size)},m.prototype.get_sample=function(y,b){return 0>y?(y+=this.source_buffer_previous[0].length,this.source_buffer_previous[b][y]):this.source_buffer_current[b][y]},m.prototype.ensure_enough_data=function(y){var b=this.source_buffer_current[0].length;b-this.source_block_start<y&&(this.prepare_next_buffer(),this.source_block_start-=b)},m.prototype.prepare_next_buffer=function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback"),this.source_buffer_previous=this.source_buffer_current,this.source_buffer_current=this.queue_shift();var y=this.source_buffer_current[0].length;if(256>y){for(var b=this.queue_start,E=0;256>y&&E<this.queue_length;)y+=this.queue_data[b][0].length,b=b+1&this.queue_size-1,E++;y=Math.max(y,256),y=[new Float32Array(y),new Float32Array(y)],y[0].set(this.source_buffer_current[0]),y[1].set(this.source_buffer_current[1]),b=this.source_buffer_current[0].length;for(var R=0;R<E;R++){var C=this.queue_shift();y[0].set(C[0],b),y[1].set(C[1],b),b+=C[0].length}this.source_buffer_current=y}this.pump()},m.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})},m.prototype.queue_push=function(y){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=y,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,this.queued_samples+=y[0].length,this.pump())},m.prototype.queue_shift=function(){if(!this.queue_length)return g;var y=this.queue_data[this.queue_start];return this.queue_data[this.queue_start]=null,this.queue_start=this.queue_start+1&this.queue_size-1,this.queue_length--,this.queued_samples-=y[0].length,y},m.prototype.dbg_log=function(){},registerProcessor("dac-processor",m)}.toString();var n=e.indexOf("{")+1,a=e.lastIndexOf("}");e=e.substring(n,a),e=new Blob([e],{type:"application/javascript"});var p=URL.createObjectURL(e);this.node_processor=null,this.node_output=this.audio_context.createGain(),this.audio_context.audioWorklet.addModule(p).then(()=>{URL.revokeObjectURL(p),this.node_processor=new AudioWorkletNode(this.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2],parameterData:{},processorOptions:{}}),this.node_processor.port.postMessage({type:"sampling-rate",value:this.sampling_rate}),this.node_processor.port.onmessage=d=>{switch(d.data.type){case"pump":this.pump()}},this.node_processor.connect(this.node_output)}),this.mixer_connection=r.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(d){this.queue(d)},this),t.register("dac-enable",function(){this.enabled=!0},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(d){this.sampling_rate=d,this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:d})},this)}Hs.prototype.queue=function(t){this.node_processor&&this.node_processor.port.postMessage({type:"queue",value:t},[t[0].buffer,t[1].buffer])},Hs.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")};function Ks(t,e,r){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=22050,this.buffered_time=0,this.rate_ratio=1,this.node_lowpass=this.audio_context.createBiquadFilter(),this.node_lowpass.type="lowpass",this.node_output=this.node_lowpass,this.mixer_connection=r.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(n){this.queue(n)},this),t.register("dac-enable",function(){this.enabled=!0,this.pump()},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(n){this.sampling_rate=n,this.rate_ratio=Math.ceil(8e3/n),this.node_lowpass.frequency.setValueAtTime(n/2,this.audio_context.currentTime)},this)}Ks.prototype.queue=function(t){var e=t[0].length,r=e/this.sampling_rate;if(1<this.rate_ratio)for(var n=this.audio_context.createBuffer(2,e*this.rate_ratio,this.sampling_rate*this.rate_ratio),a=n.getChannelData(0),p=n.getChannelData(1),d=0,m=0;m<e;m++)for(var g=0;g<this.rate_ratio;g++,d++)a[d]=t[0][m],p[d]=t[1][m];else n=this.audio_context.createBuffer(2,e,this.sampling_rate),n.copyToChannel?(n.copyToChannel(t[0],0),n.copyToChannel(t[1],1)):(n.getChannelData(0).set(t[0]),n.getChannelData(1).set(t[1]));if(t=this.audio_context.createBufferSource(),t.buffer=n,t.connect(this.node_lowpass),t.addEventListener("ended",this.pump.bind(this)),n=this.audio_context.currentTime,this.buffered_time<n)for(this.buffered_time=n,n=.2-r,e=0;e<=n;)e+=r,this.buffered_time+=r,setTimeout(()=>this.pump(),1e3*e);t.start(this.buffered_time),this.buffered_time+=r,setTimeout(()=>this.pump(),0)},Ks.prototype.pump=function(){this.enabled&&(.2<this.buffered_time-this.audio_context.currentTime||this.bus.send("dac-request-data"))};function vc(t,e){function r(m){d.bus&&d.enabled&&(d.send_char(m.which),m.preventDefault())}function n(m){var g=m.which;g===8?(d.send_char(127),m.preventDefault()):g===9&&(d.send_char(9),m.preventDefault())}function a(m){if(d.enabled){for(var g=m.clipboardData.getData("text/plain"),y=0;y<g.length;y++)d.send_char(g.charCodeAt(y));m.preventDefault()}}function p(m){m.target!==t&&t.blur()}var d=this;this.enabled=!0,this.bus=e,this.text="",this.text_new_line=!1,this.last_update=0,this.bus.register("serial0-output-byte",function(m){m=String.fromCharCode(m),this.show_char(m)},this),this.destroy=function(){t.removeEventListener("keypress",r,!1),t.removeEventListener("keydown",n,!1),t.removeEventListener("paste",a,!1),window.removeEventListener("mousedown",p,!1)},this.init=function(){this.destroy(),t.style.display="block",t.addEventListener("keypress",r,!1),t.addEventListener("keydown",n,!1),t.addEventListener("paste",a,!1),window.addEventListener("mousedown",p,!1)},this.init(),this.show_char=function(m){m==="\b"?(this.text=this.text.slice(0,-1),this.update()):m!=="\r"&&(this.text+=m,m===`
`&&(this.text_new_line=!0),this.update())},this.update=function(){var m=Date.now(),g=m-this.last_update;16>g?this.update_timer===void 0&&(this.update_timer=setTimeout(()=>{this.update_timer=void 0,this.last_update=Date.now(),this.render()},16-g)):(this.update_timer!==void 0&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=m,this.render())},this.render=function(){t.value=this.text,this.text_new_line&&(this.text_new_line=!1,t.scrollTop=1e9)},this.send_char=function(m){d.bus&&d.bus.send("serial0-input",m)}}function Ys(t,e){if(this.element=t,window.Terminal){var r=this.term=new window.Terminal({logLevel:"off"});r.write("This is the serial console. Whatever you type or paste here will be sent to COM1");var n=r.onData(function(a){for(let p=0;p<a.length;p++)e.send("serial0-input",a.charCodeAt(p))});e.register("serial0-output-byte",function(a){r.write(Uint8Array.of(a))},this),this.destroy=function(){n.dispose(),r.dispose()}}}Ys.prototype.show=function(){this.term&&this.term.open(this.element)};function me(t,e){this.bus=e,this.socket=void 0,this.send_queue=[],this.url=t,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.bus.register("net0-send",function(r){this.send(r)},this)}me.prototype.handle_message=function(t){this.bus&&this.bus.send("net0-receive",new Uint8Array(t.data))},me.prototype.handle_close=function(){this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval)},me.prototype.handle_open=function(){for(var t=0;t<this.send_queue.length;t++)this.send(this.send_queue[t]);this.send_queue=[]},me.prototype.handle_error=function(){},me.prototype.destroy=function(){this.socket&&this.socket.close()},me.prototype.connect=function(){if(typeof WebSocket<"u"){if(this.socket){var t=this.socket.readyState;if(t===0||t===1)return}if(t=Date.now(),!(this.last_connect_attempt+this.reconnect_interval>t)){this.last_connect_attempt=Date.now();try{this.socket=new WebSocket(this.url)}catch(e){console.error(e);return}this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this)}}},me.prototype.send=function(t){this.socket&&this.socket.readyState===1?this.socket.send(t):(this.send_queue.push(t),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())},me.prototype.change_proxy=function(t){this.url=t,this.socket&&(this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.close(),this.socket=void 0)};function M(t){this.cpu_is_running=!1,this.cpu_exception_hook=function(){};var e=pn.create();this.bus=e[0],this.emulator_bus=e[1];var r,n;let a=new WebAssembly.Table({element:"anyfunc",initial:1924});e={cpu_exception_hook:d=>this.cpu_exception_hook(d),run_hardware_timers:function(d,m){return r.run_hardware_timers(d,m)},cpu_event_halt:()=>{this.emulator_bus.send("cpu-event-halt")},abort:function(){},microtick:_.microtick,get_rand_int:function(){return f.get_rand_int()},apic_acknowledge_irq:function(){return r.devices.apic.acknowledge_irq()},stop_idling:function(){return r.stop_idling()},io_port_read8:function(d){return r.io.port_read8(d)},io_port_read16:function(d){return r.io.port_read16(d)},io_port_read32:function(d){return r.io.port_read32(d)},io_port_write8:function(d,m){r.io.port_write8(d,m)},io_port_write16:function(d,m){r.io.port_write16(d,m)},io_port_write32:function(d,m){r.io.port_write32(d,m)},mmap_read8:function(d){return r.mmap_read8(d)},mmap_read16:function(d){return r.mmap_read16(d)},mmap_read32:function(d){return r.mmap_read32(d)},mmap_write8:function(d,m){r.mmap_write8(d,m)},mmap_write16:function(d,m){r.mmap_write16(d,m)},mmap_write32:function(d,m){r.mmap_write32(d,m)},mmap_write64:function(d,m,g){r.mmap_write64(d,m,g)},mmap_write128:function(d,m,g,y,b){r.mmap_write128(d,m,g,y,b)},log_from_wasm:function(d,m){f.read_sized_string_from_mem(n,d,m)},console_log_from_wasm:function(d,m){d=f.read_sized_string_from_mem(n,d,m),console.error(d)},dbg_trace_from_wasm:function(){},codegen_finalize:(d,m,g,y,b)=>{r.codegen_finalize(d,m,g,y,b)},jit_clear_func:d=>r.jit_clear_func(d),jit_clear_all_funcs:()=>r.jit_clear_all_funcs(),__indirect_function_table:a};let p=t.wasm_fn;p||(p=d=>new Promise(m=>{let g="v86.wasm",y="v86-fallback.wasm";if(t.wasm_path){g=t.wasm_path;let b=g.lastIndexOf("/");y=(b===-1?"":g.substr(0,b))+"/"+y}else typeof window>"u"&&typeof __dirname=="string"?(g=__dirname+"/"+g,y=__dirname+"/"+y):(g="build/"+g,y="build/"+y);f.load_file(g,{done:async b=>{try{let{instance:E}=await WebAssembly.instantiate(b,d);this.wasm_source=b,m(E.exports)}catch{f.load_file(y,{done:async R=>{let{instance:C}=await WebAssembly.instantiate(R,d);this.wasm_source=R,m(C.exports)}})}},progress:b=>{this.emulator_bus.send("download-progress",{file_index:0,file_count:1,file_name:g,lengthComputable:b.lengthComputable,total:b.total,loaded:b.loaded})}})})),p({env:e}).then(d=>{n=d.memory,d.rust_init(),d=this.v86=new _(this.emulator_bus,{exports:d,wasm_table:a}),r=d.cpu,this.continue_init(d,t)}),this.zstd_worker=null,this.zstd_worker_request_id=0}M.prototype.continue_init=async function(t,e){function r(R,C){switch(R){case"hda":a.hda=this.disk_images.hda=C;break;case"hdb":a.hdb=this.disk_images.hdb=C;break;case"cdrom":a.cdrom=this.disk_images.cdrom=C;break;case"fda":a.fda=this.disk_images.fda=C;break;case"fdb":a.fdb=this.disk_images.fdb=C;break;case"multiboot":a.multiboot=this.disk_images.multiboot=C.buffer;break;case"bzimage":a.bzimage=this.disk_images.bzimage=C.buffer;break;case"initrd":a.initrd=this.disk_images.initrd=C.buffer;break;case"bios":a.bios=C.buffer;break;case"vga_bios":a.vga_bios=C.buffer;break;case"initial_state":a.initial_state=C.buffer;break;case"fs9p_json":a.fs9p_json=C}}async function n(){if(a.fs9p&&a.fs9p_json&&!a.initial_state&&(a.fs9p.load_from_json(a.fs9p_json),e.bzimage_initrd_from_filesystem)){let{bzimage_path:R,initrd_path:C}=this.get_bzimage_initrd_from_filesystem(a.fs9p),[U,F]=await Promise.all([a.fs9p.read_file(C),a.fs9p.read_file(R)]);r.call(this,"initrd",new f.SyncBuffer(U.buffer)),r.call(this,"bzimage",new f.SyncBuffer(F.buffer))}this.serial_adapter&&this.serial_adapter.show&&this.serial_adapter.show(),this.bus.send("cpu-init",a),a.initial_state&&(t.restore_state(a.initial_state),a.initial_state=void 0),e.autostart&&this.bus.send("cpu-run"),this.emulator_bus.send("emulator-loaded")}this.bus.register("emulator-stopped",function(){this.cpu_is_running=!1},this),this.bus.register("emulator-started",function(){this.cpu_is_running=!0},this);var a={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0};var p=e.boot_order?e.boot_order:e.fda?801:e.hda?786:291;a.acpi=e.acpi,a.disable_jit=e.disable_jit,a.load_devices=!0,a.memory_size=e.memory_size||67108864,a.vga_memory_size=e.vga_memory_size||8388608,a.boot_order=p,a.fastboot=e.fastboot||!1,a.fda=void 0,a.fdb=void 0,a.uart1=e.uart1,a.uart2=e.uart2,a.uart3=e.uart3,a.cmdline=e.cmdline,a.preserve_mac_from_state_image=e.preserve_mac_from_state_image,a.mac_address_translation=e.mac_address_translation,a.cpuid_level=e.cpuid_level,a.virtio_console=e.virtio_console,e.network_adapter?this.network_adapter=e.network_adapter(this.bus):e.network_relay_url&&(this.network_adapter=new me(e.network_relay_url,this.bus)),a.enable_ne2k=!0,e.disable_keyboard||(this.keyboard_adapter=new yc(this.bus)),e.disable_mouse||(this.mouse_adapter=new wc(this.bus,e.screen_container)),e.screen_container?this.screen_adapter=new o(e.screen_container,this.bus):e.screen_dummy&&(this.screen_adapter=new bc(this.bus)),e.serial_container&&(this.serial_adapter=new vc(e.serial_container,this.bus)),e.serial_container_xtermjs&&(this.serial_adapter=new Ys(e.serial_container_xtermjs,this.bus)),e.disable_speaker||(this.speaker_adapter=new vn(this.bus));var d=[];if(p=(R,C)=>{C&&(C.get&&C.set&&C.load?d.push({name:R,loadable:C}):((R==="bios"||R==="vga_bios"||R==="initial_state"||R==="multiboot"||R==="bzimage"||R==="initrd")&&(C.async=!1),C.url&&!C.async?d.push({name:R,url:C.url,size:C.size}):d.push({name:R,loadable:f.buffer_from_object(C,this.zstd_decompress_worker.bind(this))})))},e.state&&console.warn("Warning: Unknown option 'state'. Did you mean 'initial_state'?"),p("bios",e.bios),p("vga_bios",e.vga_bios),p("cdrom",e.cdrom),p("hda",e.hda),p("hdb",e.hdb),p("fda",e.fda),p("fdb",e.fdb),p("initial_state",e.initial_state),p("multiboot",e.multiboot),p("bzimage",e.bzimage),p("initrd",e.initrd),e.filesystem){p=e.filesystem.basefs;var m=e.filesystem.baseurl;let R=new Ae;if(m&&(R=new ge(R,m)),a.fs9p=this.fs9p=new N(R),p){if(typeof p=="object"){var g=p.size;p=p.url}d.push({name:"fs9p_json",url:p,size:g,as_json:!0})}}var y=this,b=d.length,E=function(R){if(R===b)setTimeout(n.bind(this),0);else{var C=d[R];C.loadable?(C.loadable.onload=function(){r.call(this,C.name,C.loadable),E(R+1)}.bind(this),C.loadable.load()):f.load_file(C.url,{done:function(U){C.url.endsWith(".zst")&&C.name!=="initial_state"&&(U=this.zstd_decompress(C.size,new Uint8Array(U))),r.call(this,C.name,C.as_json?U:new f.SyncBuffer(U)),E(R+1)}.bind(this),progress:function(U){U.target.status===200?y.emulator_bus.send("download-progress",{file_index:R,file_count:b,file_name:C.url,lengthComputable:U.lengthComputable,total:U.total||C.size,loaded:U.loaded}):y.emulator_bus.send("download-error",{file_index:R,file_count:b,file_name:C.url,request:U.target})},as_json:C.as_json})}}.bind(this);E(0)},M.prototype.zstd_decompress=function(t,e){let r=this.v86.cpu;this.zstd_context=r.zstd_create_ctx(e.length),new Uint8Array(r.wasm_memory.buffer).set(e,r.zstd_get_src_ptr(this.zstd_context)),e=r.zstd_read(this.zstd_context,t);let n=r.wasm_memory.buffer.slice(e,e+t);return r.zstd_read_free(e,t),r.zstd_free_ctx(this.zstd_context),this.zstd_context=null,n},M.prototype.zstd_decompress_worker=async function(t,e){if(!this.zstd_worker){let r=URL.createObjectURL(new Blob(["("+function(){let n;globalThis.onmessage=function(a){if(n){var{src:p,decompressed_size:d,id:m}=a.data;a=n.exports;var g=a.zstd_create_ctx(p.length);new Uint8Array(a.memory.buffer).set(p,a.zstd_get_src_ptr(g));var y=a.zstd_read(g,d),b=a.memory.buffer.slice(y,y+d);a.zstd_read_free(y,d),a.zstd_free_ctx(g),postMessage({result:b,id:m},[b])}else g=Object.fromEntries("cpu_exception_hook run_hardware_timers cpu_event_halt microtick get_rand_int apic_acknowledge_irq stop_idling io_port_read8 io_port_read16 io_port_read32 io_port_write8 io_port_write16 io_port_write32 mmap_read8 mmap_read16 mmap_read32 mmap_write8 mmap_write16 mmap_write32 mmap_write64 mmap_write128 codegen_finalize jit_clear_func jit_clear_all_funcs".split(" ").map(E=>[E,()=>console.error("zstd worker unexpectedly called "+E)])),g.__indirect_function_table=new WebAssembly.Table({element:"anyfunc",initial:1024}),g.abort=()=>{throw Error("zstd worker aborted")},g.log_from_wasm=g.console_log_from_wasm=(E,R)=>{console.log(String.fromCharCode(...new Uint8Array(n.exports.memory.buffer,E,R)))},g.dbg_trace_from_wasm=()=>console.trace(),n=new WebAssembly.Instance(new WebAssembly.Module(a.data),{env:g})}}.toString()+")()"],{type:"text/javascript"}));this.zstd_worker=new Worker(r),URL.revokeObjectURL(r),this.zstd_worker.postMessage(this.wasm_source,[this.wasm_source])}return new Promise(r=>{let n=this.zstd_worker_request_id++,a=async p=>{p.data.id===n&&(this.zstd_worker.removeEventListener("message",a),r(p.data.result))};this.zstd_worker.addEventListener("message",a),this.zstd_worker.postMessage({src:e,decompressed_size:t,id:n},[e.buffer])})},M.prototype.get_bzimage_initrd_from_filesystem=function(t){let e=(t.read_dir("/")||[]).map(a=>"/"+a);t=(t.read_dir("/boot/")||[]).map(a=>"/boot/"+a);let r,n;for(let a of[].concat(e,t)){let p=/old/i.test(a)||/fallback/i.test(a),d=/vmlinuz/i.test(a)||/bzimage/i.test(a),m=/initrd/i.test(a)||/initramfs/i.test(a);!d||n&&p||(n=a),!m||r&&p||(r=a)}return r&&n||(console.log("Failed to find bzimage or initrd in filesystem. Files:"),console.log(e.join(" ")),console.log(t.join(" "))),{initrd_path:r,bzimage_path:n}},M.prototype.run=async function(){this.bus.send("cpu-run")},l.exportProperty(M.prototype,"run",M.prototype.run),M.prototype.stop=async function(){this.cpu_is_running&&await new Promise(t=>{let e=()=>{this.remove_listener("emulator-stopped",e),t()};this.add_listener("emulator-stopped",e),this.bus.send("cpu-stop")})},l.exportProperty(M.prototype,"stop",M.prototype.stop),M.prototype.destroy=async function(){await this.stop(),this.v86.destroy(),this.keyboard_adapter&&this.keyboard_adapter.destroy(),this.network_adapter&&this.network_adapter.destroy(),this.mouse_adapter&&this.mouse_adapter.destroy(),this.screen_adapter&&this.screen_adapter.destroy(),this.serial_adapter&&this.serial_adapter.destroy(),this.speaker_adapter&&this.speaker_adapter.destroy()},l.exportProperty(M.prototype,"destroy",M.prototype.destroy),M.prototype.restart=function(){this.bus.send("cpu-restart")},l.exportProperty(M.prototype,"restart",M.prototype.restart),M.prototype.add_listener=function(t,e){this.bus.register(t,e,this)},l.exportProperty(M.prototype,"add_listener",M.prototype.add_listener),M.prototype.remove_listener=function(t,e){this.bus.unregister(t,e)},l.exportProperty(M.prototype,"remove_listener",M.prototype.remove_listener),M.prototype.restore_state=async function(t){this.v86.restore_state(t)},l.exportProperty(M.prototype,"restore_state",M.prototype.restore_state),M.prototype.save_state=async function(){return this.v86.save_state()},l.exportProperty(M.prototype,"save_state",M.prototype.save_state),M.prototype.get_instruction_counter=function(){return this.v86?this.v86.cpu.instruction_counter[0]>>>0:0},l.exportProperty(M.prototype,"get_instruction_counter",M.prototype.get_instruction_counter),M.prototype.is_running=function(){return this.cpu_is_running},l.exportProperty(M.prototype,"is_running",M.prototype.is_running),M.prototype.set_fda=async function(t){if(t.url&&!t.async)f.load_file(t.url,{done:e=>{this.v86.cpu.devices.fdc.set_fda(new f.SyncBuffer(e))}});else{let e=f.buffer_from_object(t,this.zstd_decompress_worker.bind(this));e.onload=()=>{this.v86.cpu.devices.fdc.set_fda(e)},await e.load()}},l.exportProperty(M.prototype,"set_fda",M.prototype.set_fda),M.prototype.eject_fda=function(){this.v86.cpu.devices.fdc.eject_fda()},l.exportProperty(M.prototype,"eject_fda",M.prototype.eject_fda),M.prototype.keyboard_send_scancodes=function(t){for(var e=0;e<t.length;e++)this.bus.send("keyboard-code",t[e])},l.exportProperty(M.prototype,"keyboard_send_scancodes",M.prototype.keyboard_send_scancodes),M.prototype.keyboard_send_keys=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_press(t[e])},l.exportProperty(M.prototype,"keyboard_send_keys",M.prototype.keyboard_send_keys),M.prototype.keyboard_send_text=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_char(t[e])},l.exportProperty(M.prototype,"keyboard_send_text",M.prototype.keyboard_send_text),M.prototype.screen_make_screenshot=function(){return this.screen_adapter?this.screen_adapter.make_screenshot():null},l.exportProperty(M.prototype,"screen_make_screenshot",M.prototype.screen_make_screenshot),M.prototype.screen_set_scale=function(t,e){this.screen_adapter&&this.screen_adapter.set_scale(t,e)},l.exportProperty(M.prototype,"screen_set_scale",M.prototype.screen_set_scale),M.prototype.screen_go_fullscreen=function(){if(this.screen_adapter){var t=document.getElementById("screen_container");if(t){var e=t.requestFullScreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullScreen;e&&(e.call(t),(t=document.getElementsByClassName("phone_keyboard")[0])&&t.focus());try{navigator.keyboard.lock()}catch{}this.lock_mouse()}}},l.exportProperty(M.prototype,"screen_go_fullscreen",M.prototype.screen_go_fullscreen),M.prototype.lock_mouse=function(){var t=document.body,e=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;e&&e.call(t)},l.exportProperty(M.prototype,"lock_mouse",M.prototype.lock_mouse),M.prototype.mouse_set_status=function(t){this.mouse_adapter&&(this.mouse_adapter.emu_enabled=t)},M.prototype.keyboard_set_status=function(t){this.keyboard_adapter&&(this.keyboard_adapter.emu_enabled=t)},l.exportProperty(M.prototype,"keyboard_set_status",M.prototype.keyboard_set_status),M.prototype.serial0_send=function(t){for(var e=0;e<t.length;e++)this.bus.send("serial0-input",t.charCodeAt(e))},l.exportProperty(M.prototype,"serial0_send",M.prototype.serial0_send),M.prototype.serial_send_bytes=function(t,e){for(var r=0;r<e.length;r++)this.bus.send("serial"+t+"-input",e[r])},l.exportProperty(M.prototype,"serial_send_bytes",M.prototype.serial_send_bytes),M.prototype.serial_set_modem_status=function(t,e){this.bus.send("serial"+t+"-modem-status-input",e)},M.prototype.serial_set_carrier_detect=function(t,e){this.bus.send("serial"+t+"-carrier-detect-input",e)},M.prototype.serial_set_ring_indicator=function(t,e){this.bus.send("serial"+t+"-ring-indicator-input",e)},M.prototype.serial_set_data_set_ready=function(t,e){this.bus.send("serial"+t+"-data-set-ready-input",e)},M.prototype.serial_set_clear_to_send=function(t,e){this.bus.send("serial"+t+"-clear-to-send-input",e)},M.prototype.mount_fs=async function(t,e,r,n){let a=new Ae;e&&(a=new ge(a,e));let p=new N(a,this.fs9p.qidcounter),d=()=>{let m=this.fs9p.Mount(t,p);n&&(m===-2?n(new Yi):m===-17?n(new kn):0>m?n(Error("Failed to mount. Error number: "+-m)):n(null))};e?p.load_from_json(r,()=>d()):d()},l.exportProperty(M.prototype,"mount_fs",M.prototype.mount_fs),M.prototype.create_file=async function(t,e){var r=this.fs9p;if(r){var n=t.split("/");if(n=n[n.length-1],t=r.SearchPath(t).parentid,n!==""&&t!==-1)await r.CreateBinaryFile(n,t,e);else return Promise.reject(new Yi)}},l.exportProperty(M.prototype,"create_file",M.prototype.create_file),M.prototype.read_file=async function(t){var e=this.fs9p;if(e)return(t=await e.read_file(t))?t:Promise.reject(new Yi)},l.exportProperty(M.prototype,"read_file",M.prototype.read_file),M.prototype.automatically=function(t){let e=r=>{let n=r[0];if(n){var a=r.slice(1);if(n.sleep)setTimeout(()=>e(a),1e3*n.sleep);else if(n.vga_text){let p=this.screen_adapter.get_text_screen();for(let d of p)if(d.includes(n.vga_text)){e(a);return}setTimeout(()=>e(r),1e3)}else n.keyboard_send?(n.keyboard_send instanceof Array?this.keyboard_send_scancodes(n.keyboard_send):this.keyboard_send_text(n.keyboard_send),e(a)):n.call&&(n.call(),e(a))}};e(t)},M.prototype.read_memory=function(t,e){return this.v86.cpu.read_blob(t,e)},M.prototype.write_memory=function(t,e){this.v86.cpu.write_blob(t,e)},M.prototype.set_serial_container_xtermjs=function(t){this.serial_adapter&&this.serial_adapter.destroy&&this.serial_adapter.destroy(),this.serial_adapter=new Ys(t,this.bus),this.serial_adapter.show()};function kn(t){this.message=t||"File already exists"}kn.prototype=Error.prototype;function Yi(t){this.message=t||"File not found"}Yi.prototype=Error.prototype,typeof window<"u"?(window.V86Starter=M,window.V86=M):typeof Ft<"u"&&typeof Ft.exports<"u"?(Ft.exports.V86Starter=M,Ft.exports.V86=M):typeof importScripts=="function"&&(self.V86Starter=M,self.V86=M);var Vi={Connector:function(t){this.listeners={},this.pair=t,t.addEventListener("message",function(e){e=e.data;for(var r=this.listeners[e[0]],n=0;n<r.length;n++){var a=r[n];a.fn.call(a.this_value,e[1])}}.bind(this),!1)}};Vi.Connector.prototype.register=function(t,e,r){var n=this.listeners[t];n===void 0&&(n=this.listeners[t]=[]),n.push({fn:e,this_value:r})},Vi.Connector.prototype.send=function(t,e,r){this.pair&&this.pair.postMessage([t,e],r)},Vi.init=function(t){return new Vi.Connector(t)};function bc(t){var e,r,n,a,p;this.bus=t,t.register("screen-set-mode",function(d){this.set_mode(d)},this),t.register("screen-fill-buffer-end",function(d){this.update_buffer(d[0],d[1])},this),t.register("screen-put-char",function(d){this.put_char(d[0],d[1],d[2],d[3],d[4],d[5])},this),t.register("screen-text-scroll",function(d){console.log("scroll",d)},this),t.register("screen-update-cursor",function(d){this.update_cursor(d[0],d[1])},this),t.register("screen-update-cursor-scanline",function(d){this.update_cursor_scanline(d[0],d[1],d[2])},this),t.register("screen-set-size-text",function(d){this.set_size_text(d[0],d[1])},this),t.register("screen-set-size-graphical",function(d){this.set_size_graphical(d[0],d[1])},this),this.put_char=function(d,m,g,y,b,E){d<p&&m<a&&(d=4*(d*a+m),n[d+0]=g,n[d+1]=y,n[d+2]=b,n[d+3]=E)},this.destroy=function(){},this.set_mode=function(){},this.clear_screen=function(){},this.set_size_text=function(d,m){(d!==a||m!==p)&&(n=new Int32Array(d*m*4),a=d,p=m)},this.set_size_graphical=function(){},this.set_scale=function(){},this.update_cursor_scanline=function(){},this.update_cursor=function(d,m){(d!==e||m!==r)&&(e=d,r=m)},this.update_buffer=function(){},this.get_text_screen=function(){for(var d=[],m=0;m<p;m++)d.push(this.get_text_row(m));return d},this.get_text_row=function(d){var m="";d=4*d*a;for(var g=0;g<a;g++)m+=String.fromCharCode(n[d+0+4*g]);return m}}let Ee={stats_to_string:function(t){return Ee.print_misc_stats(t)+Ee.print_instruction_counts(t)},print_misc_stats:function(t){let e="";var r="COMPILE COMPILE_SKIPPED_NO_NEW_ENTRY_POINTS COMPILE_WRONG_ADDRESS_SPACE COMPILE_CUT_OFF_AT_END_OF_PAGE COMPILE_WITH_LOOP_SAFETY COMPILE_PAGE COMPILE_PAGE/COMPILE COMPILE_BASIC_BLOCK COMPILE_DUPLICATED_BASIC_BLOCK COMPILE_WASM_BLOCK COMPILE_WASM_LOOP COMPILE_DISPATCHER COMPILE_ENTRY_POINT COMPILE_WASM_TOTAL_BYTES COMPILE_WASM_TOTAL_BYTES/COMPILE_PAGE RUN_INTERPRETED RUN_INTERPRETED_NEW_PAGE RUN_INTERPRETED_PAGE_HAS_CODE RUN_INTERPRETED_PAGE_HAS_ENTRY_AFTER_PAGE_WALK RUN_INTERPRETED_NEAR_END_OF_PAGE RUN_INTERPRETED_DIFFERENT_STATE RUN_INTERPRETED_DIFFERENT_STATE_CPL3 RUN_INTERPRETED_DIFFERENT_STATE_FLAT RUN_INTERPRETED_DIFFERENT_STATE_IS32 RUN_INTERPRETED_DIFFERENT_STATE_SS32 RUN_INTERPRETED_MISSED_COMPILED_ENTRY_RUN_INTERPRETED RUN_INTERPRETED_STEPS RUN_FROM_CACHE RUN_FROM_CACHE_STEPS RUN_FROM_CACHE_STEPS/RUN_FROM_CACHE RUN_FROM_CACHE_STEPS/RUN_INTERPRETED_STEPS DIRECT_EXIT INDIRECT_JUMP INDIRECT_JUMP_NO_ENTRY NORMAL_PAGE_CHANGE NORMAL_FALLTHRU NORMAL_FALLTHRU_WITH_TARGET_BLOCK NORMAL_BRANCH NORMAL_BRANCH_WITH_TARGET_BLOCK CONDITIONAL_JUMP CONDITIONAL_JUMP_PAGE_CHANGE CONDITIONAL_JUMP_EXIT CONDITIONAL_JUMP_FALLTHRU CONDITIONAL_JUMP_FALLTHRU_WITH_TARGET_BLOCK CONDITIONAL_JUMP_BRANCH CONDITIONAL_JUMP_BRANCH_WITH_TARGET_BLOCK DISPATCHER_SMALL DISPATCHER_LARGE LOOP LOOP_SAFETY CONDITION_OPTIMISED CONDITION_UNOPTIMISED CONDITION_UNOPTIMISED_PF CONDITION_UNOPTIMISED_UNHANDLED_L CONDITION_UNOPTIMISED_UNHANDLED_LE FAILED_PAGE_CHANGE SAFE_READ_FAST SAFE_READ_SLOW_PAGE_CROSSED SAFE_READ_SLOW_NOT_VALID SAFE_READ_SLOW_NOT_USER SAFE_READ_SLOW_IN_MAPPED_RANGE SAFE_WRITE_FAST SAFE_WRITE_SLOW_PAGE_CROSSED SAFE_WRITE_SLOW_NOT_VALID SAFE_WRITE_SLOW_NOT_USER SAFE_WRITE_SLOW_IN_MAPPED_RANGE SAFE_WRITE_SLOW_READ_ONLY SAFE_WRITE_SLOW_HAS_CODE SAFE_READ_WRITE_FAST SAFE_READ_WRITE_SLOW_PAGE_CROSSED SAFE_READ_WRITE_SLOW_NOT_VALID SAFE_READ_WRITE_SLOW_NOT_USER SAFE_READ_WRITE_SLOW_IN_MAPPED_RANGE SAFE_READ_WRITE_SLOW_READ_ONLY SAFE_READ_WRITE_SLOW_HAS_CODE PAGE_FAULT TLB_MISS MAIN_LOOP MAIN_LOOP_IDLE DO_MANY_CYCLES CYCLE_INTERNAL INVALIDATE_ALL_MODULES_NO_FREE_WASM_INDICES INVALIDATE_MODULE_WRITTEN_WHILE_COMPILED INVALIDATE_MODULE_UNUSED_AFTER_OVERWRITE INVALIDATE_MODULE_DIRTY_PAGE INVALIDATE_PAGE_HAD_CODE INVALIDATE_PAGE_HAD_ENTRY_POINTS DIRTY_PAGE_DID_NOT_HAVE_CODE RUN_FROM_CACHE_EXIT_SAME_PAGE RUN_FROM_CACHE_EXIT_NEAR_END_OF_PAGE RUN_FROM_CACHE_EXIT_DIFFERENT_PAGE CLEAR_TLB FULL_CLEAR_TLB TLB_FULL TLB_GLOBAL_FULL MODRM_SIMPLE_REG MODRM_SIMPLE_REG_WITH_OFFSET MODRM_SIMPLE_CONST_OFFSET MODRM_COMPLEX SEG_OFFSET_OPTIMISED SEG_OFFSET_NOT_OPTIMISED SEG_OFFSET_NOT_OPTIMISED_ES SEG_OFFSET_NOT_OPTIMISED_FS SEG_OFFSET_NOT_OPTIMISED_GS SEG_OFFSET_NOT_OPTIMISED_NOT_FLAT".split(" "),n=0;let a={};for(let d=0;d<r.length;d++){let m=r[d];var p=void 0;if(m.includes("/")){n++;let[g,y]=m.split("/");p=a[g]/a[y]}else p=a[m]=t.wm.exports.profiler_stat_get(d-n),p=1e8<=p?Math.round(p/1e6)+"m":1e5<=p?Math.round(p/1e3)+"k":p;e+=m+"="+p+`
`}return e+=`
`,r=t.wm.exports.get_valid_tlb_entries_count(),n=t.wm.exports.get_valid_global_tlb_entries_count(),e=e+("TLB_ENTRIES="+r+" ("+n+" global, "+(r-n)+` non-global)
WASM_TABLE_FREE=`)+(t.wm.exports.jit_get_wasm_table_index_free_list_count()+`
`),e+="JIT_CACHE_SIZE="+t.wm.exports.jit_get_cache_size()+`
`,e+="FLAT_SEGMENTS="+t.wm.exports.has_flat_segmentation()+`
`,e+="wasm memory size: "+(t.wasm_memory.buffer.byteLength>>20)+`m
`,e=e+`Config:
JIT_DISABLED=`+(t.wm.exports.get_jit_config(0)+`
`),e+="MAX_PAGES="+t.wm.exports.get_jit_config(1)+`
`,e+="JIT_USE_LOOP_SAFETY="+!!t.wm.exports.get_jit_config(2)+`
`,e+="MAX_EXTRA_BASIC_BLOCKS="+t.wm.exports.get_jit_config(3)+`
`},print_instruction_counts:function(t){return[Ee.print_instruction_counts_offset(t,!1,!1,!1,!1),Ee.print_instruction_counts_offset(t,!0,!1,!1,!1),Ee.print_instruction_counts_offset(t,!1,!0,!1,!1),Ee.print_instruction_counts_offset(t,!1,!1,!0,!1),Ee.print_instruction_counts_offset(t,!1,!1,!1,!0)].join(`

`)},print_instruction_counts_offset:function(t,e,r,n,a){let p="";var d=[],m=e?"compiled":r?"jit exit":n?"unguarded register":a?"wasm size":"executed";for(let b=0;256>b;b++)for(let E=0;8>E;E++)for(let R of[!1,!0]){var g=t.wm.exports.get_opstats_buffer(e,r,n,a,b,!1,R,E);d.push({opcode:b,count:g,is_mem:R,fixed_g:E}),g=t.wm.exports.get_opstats_buffer(e,r,n,a,b,!0,R,E),d.push({opcode:3840|b,count:g,is_mem:R,fixed_g:E})}t=0,e=new Set([38,46,54,62,100,101,102,103,240,242,243]);for(let{count:b,opcode:E}of d)e.has(E)||(t+=b);if(t===0)return"";r=new Uint32Array(256),e=new Uint32Array(256);for(let{opcode:b,count:E}of d)(b&65280)===3840?e[b&255]+=E:r[b&255]+=E;p=p+`------------------
Total: `+(t+`
`);let y=1e7<t?1e3:1;for(n=Math.max.apply(Math,d.map(({count:b})=>Math.round(b/y))),n=String(n).length,p+=`Instruction counts ${m} (in ${y}):
`,a=0;256>a;a++)p+=a.toString(16).padStart(2,"0")+":"+f.pads(Math.round(r[a]/y),n),p=a%16===15?p+`
`:p+" ";for(p=p+`
Instruction counts ${m} (0f, in ${y}):
`,m=0;256>m;m++)p+=(m&255).toString(16).padStart(2,"0")+":"+f.pads(Math.round(e[m]/y),n),p=m%16===15?p+`
`:p+" ";p+=`
`,d=d.filter(({count:b})=>b).sort(({count:b},{count:E})=>E-b);for(let{opcode:b,is_mem:E,fixed_g:R,count:C}of d.slice(0,200))d=b.toString(16)+"_"+R+(E?"_m":"_r"),p+=d+":"+(C/t*100).toFixed(2)+" ";return p+`
`}};typeof Ft<"u"&&typeof Ft.exports<"u"&&(Ft.exports.print_stats=Ee);function Ae(){this.filedata=new Map}Ae.prototype.read=async function(t,e,r){return(t=this.filedata.get(t))?t.subarray(e,e+r):null},Ae.prototype.cache=async function(t,e){this.filedata.set(t,e)},Ae.prototype.uncache=function(t){this.filedata.delete(t)};function ge(t,e){e.endsWith("/")||(e+="/"),this.storage=t,this.baseurl=e}ge.prototype.load_from_server=function(t){return new Promise(e=>{f.load_file(this.baseurl+t,{done:async r=>{r=new Uint8Array(r),await this.cache(t,r),e(r)}})})},ge.prototype.read=async function(t,e,r){let n=await this.storage.read(t,e,r);return n||(await this.load_from_server(t)).subarray(e,e+r)},ge.prototype.cache=async function(t,e){return await this.storage.cache(t,e)},ge.prototype.uncache=function(t){this.storage.uncache(t)},typeof window<"u"?(window.MemoryFileStorage=Ae,window.ServerFileStorageWrapper=ge):typeof Ft<"u"&&typeof Ft.exports<"u"?(Ft.exports.MemoryFileStorage=Ae,Ft.exports.ServerFileStorageWrapper=ge):typeof importScripts=="function"&&(self.MemoryFileStorage=Ae,self.ServerFileStorageWrapper=ge);var Fe=32768,ee=16384,Ji=4;function N(t,e){this.inodes=[],this.events=[],this.storage=t,this.qidcounter=e||{last_qidnumber:0},this.inodedata={},this.total_size=274877906944,this.used_size=0,this.mounts=[],this.CreateDirectory("",-1)}N.prototype.get_state=function(){let t=[];t[0]=this.inodes,t[1]=this.qidcounter.last_qidnumber,t[2]=[];for(let[e,r]of Object.entries(this.inodedata))!(this.inodes[e].mode&ee)&&t[2].push([e,r]);return t[3]=this.total_size,t[4]=this.used_size,t=t.concat(this.mounts)},N.prototype.set_state=function(t){this.inodes=t[0].map(e=>{let r=new ui(0);return r.set_state(e),r}),this.qidcounter.last_qidnumber=t[1],this.inodedata={};for(let[e,r]of t[2])r.buffer.byteLength!==r.byteLength&&(r=r.slice()),this.inodedata[e]=r;this.total_size=t[3],this.used_size=t[4],this.mounts=t.slice(5)},N.prototype.AddEvent=function(t,e){var r=this.inodes[t];r.status===0||r.status===2?e():this.is_forwarder(r)?this.follow_fs(r).AddEvent(r.foreign_id,e):this.events.push({id:t,OnEvent:e})},N.prototype.HandleEvent=function(t){var e=this.inodes[t];this.is_forwarder(e)&&this.follow_fs(e).HandleEvent(e.foreign_id),e=[];for(var r=0;r<this.events.length;r++)this.events[r].id===t?this.events[r].OnEvent():e.push(this.events[r]);this.events=e},N.prototype.load_from_json=function(t,e){if(t.version!==3)throw"The filesystem JSON format has changed. Please update your fs2json (https://github.com/copy/fs2json) and recreate the filesystem JSON.";var r=t.fsroot;for(this.used_size=t.size,t=0;t<r.length;t++)this.LoadRecursive(r[t],0);e&&e()},N.prototype.LoadRecursive=function(t,e){var r=this.CreateInode();let n=t[0];r.size=t[1],r.mtime=t[2],r.ctime=r.mtime,r.atime=r.mtime,r.mode=t[3],r.uid=t[4],r.gid=t[5];var a=r.mode&61440;a===ee?(this.PushInode(r,e,n),this.LoadDir(this.inodes.length-1,t[6])):a===Fe?(r.status=2,r.sha256sum=t[6],this.PushInode(r,e,n)):a===40960?(r.symlink=t[6],this.PushInode(r,e,n)):a!==49152&&u(a)},N.prototype.LoadDir=function(t,e){for(var r=0;r<e.length;r++)this.LoadRecursive(e[r],t)},N.prototype.should_be_linked=function(t){return!this.is_forwarder(t)||t.foreign_id===0},N.prototype.link_under_dir=function(t,e,r){let n=this.inodes[e],a=this.inodes[t];this.is_forwarder(a),this.IsDirectory(t),this.should_be_linked(n),a.direntries.has(r),a.direntries.set(r,e),n.nlinks++,this.IsDirectory(e)&&(n.direntries.has(".."),n.direntries.has(".")||n.nlinks++,n.direntries.set(".",e),n.direntries.set("..",t),a.nlinks++)},N.prototype.unlink_from_dir=function(t,e){let r=this.Search(t,e),n=this.inodes[r],a=this.inodes[t];this.is_forwarder(a),this.IsDirectory(t),a.direntries.delete(e)&&(n.nlinks--,this.IsDirectory(r)&&(n.direntries.get(".."),n.direntries.delete(".."),a.nlinks--))},N.prototype.PushInode=function(t,e,r){e!==-1?(this.inodes.push(t),t.fid=this.inodes.length-1,this.link_under_dir(e,t.fid,r)):this.inodes.length===0?(this.inodes.push(t),t.direntries.set(".",0),t.direntries.set("..",0),t.nlinks=2):(Q.Debug("Error in Filesystem: Pushed inode with name = "+r+" has no parent"),Q.Abort())};function ui(t){this.direntries=new Map,this.minor=this.major=this.mtime=this.atime=this.ctime=this.fid=this.gid=this.uid=this.size=this.status=0,this.symlink="",this.mode=493,this.qid={type:0,version:0,path:t},this.caps=void 0,this.nlinks=0,this.sha256sum="",this.locks=[],this.foreign_id=this.mount_id=-1}ui.prototype.get_state=function(){let t=[];return t[0]=this.mode,t[1]=(this.mode&61440)===ee?[...this.direntries]:(this.mode&61440)===Fe?this.sha256sum:(this.mode&61440)===40960?this.symlink:(this.mode&61440)===49152?[this.minor,this.major]:null,t[2]=this.locks,t[3]=this.status,t[4]=this.size,t[5]=this.uid,t[6]=this.gid,t[7]=this.fid,t[8]=this.ctime,t[9]=this.atime,t[10]=this.mtime,t[11]=this.qid.version,t[12]=this.qid.path,t[13]=this.nlinks,t},ui.prototype.set_state=function(t){if(this.mode=t[0],(this.mode&61440)===ee){this.direntries=new Map;for(let[e,r]of t[1])this.direntries.set(e,r)}else(this.mode&61440)===Fe?this.sha256sum=t[1]:(this.mode&61440)===40960?this.symlink=t[1]:(this.mode&61440)===49152&&([this.minor,this.major]=t[1]);this.locks=[];for(let e of t[2]){let r=new ye;r.set_state(e),this.locks.push(r)}this.status=t[3],this.size=t[4],this.uid=t[5],this.gid=t[6],this.fid=t[7],this.ctime=t[8],this.atime=t[9],this.mtime=t[10],this.qid.type=(this.mode&61440)>>8,this.qid.version=t[11],this.qid.path=t[12],this.nlinks=t[13]},N.prototype.divert=function(t,e){let r=this.Search(t,e),n=this.inodes[r],a=new ui(-1);this.IsDirectory(r),Object.assign(a,n);let p=this.inodes.length;if(this.inodes.push(a),a.fid=p,this.is_forwarder(n)&&this.mounts[n.mount_id].backtrack.set(n.foreign_id,p),this.should_be_linked(n)&&(this.unlink_from_dir(t,e),this.link_under_dir(t,p,e)),this.IsDirectory(r)&&!this.is_forwarder(n))for(let[d,m]of a.direntries)d!=="."&&d!==".."&&this.IsDirectory(m)&&this.inodes[m].direntries.set("..",p);return this.inodedata[p]=this.inodedata[r],delete this.inodedata[r],n.direntries=new Map,n.nlinks=0,p},N.prototype.copy_inode=function(t,e){Object.assign(e,t,{fid:e.fid,direntries:e.direntries,nlinks:e.nlinks})},N.prototype.CreateInode=function(){let t=Math.round(Date.now()/1e3),e=new ui(++this.qidcounter.last_qidnumber);return e.atime=e.ctime=e.mtime=t,e},N.prototype.CreateDirectory=function(t,e){var r=this.inodes[e];return 0<=e&&this.is_forwarder(r)?(e=r.foreign_id,t=this.follow_fs(r).CreateDirectory(t,e),this.create_forwarder(r.mount_id,t)):(r=this.CreateInode(),r.mode=511|ee,0<=e&&(r.uid=this.inodes[e].uid,r.gid=this.inodes[e].gid,r.mode=this.inodes[e].mode&511|ee),r.qid.type=ee>>8,this.PushInode(r,e,t),this.NotifyListeners(this.inodes.length-1,"newdir"),this.inodes.length-1)},N.prototype.CreateFile=function(t,e){var r=this.inodes[e];return this.is_forwarder(r)?(e=r.foreign_id,t=this.follow_fs(r).CreateFile(t,e),this.create_forwarder(r.mount_id,t)):(r=this.CreateInode(),r.uid=this.inodes[e].uid,r.gid=this.inodes[e].gid,r.qid.type=Fe>>8,r.mode=this.inodes[e].mode&438|Fe,this.PushInode(r,e,t),this.NotifyListeners(this.inodes.length-1,"newfile"),this.inodes.length-1)},N.prototype.CreateNode=function(t,e,r,n){var a=this.inodes[e];return this.is_forwarder(a)?(e=a.foreign_id,t=this.follow_fs(a).CreateNode(t,e,r,n),this.create_forwarder(a.mount_id,t)):(a=this.CreateInode(),a.major=r,a.minor=n,a.uid=this.inodes[e].uid,a.gid=this.inodes[e].gid,a.qid.type=192,a.mode=this.inodes[e].mode&438,this.PushInode(a,e,t),this.inodes.length-1)},N.prototype.CreateSymlink=function(t,e,r){var n=this.inodes[e];return this.is_forwarder(n)?(e=n.foreign_id,t=this.follow_fs(n).CreateSymlink(t,e,r),this.create_forwarder(n.mount_id,t)):(n=this.CreateInode(),n.uid=this.inodes[e].uid,n.gid=this.inodes[e].gid,n.qid.type=160,n.symlink=r,n.mode=40960,this.PushInode(n,e,t),this.inodes.length-1)},N.prototype.CreateTextFile=async function(t,e,r){var n=this.inodes[e];if(this.is_forwarder(n))return e=n.foreign_id,r=await this.follow_fs(n).CreateTextFile(t,e,r),this.create_forwarder(n.mount_id,r);for(n=this.CreateFile(t,e),e=this.inodes[n],t=new Uint8Array(r.length),e.size=r.length,e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return await this.set_data(n,t),n},N.prototype.CreateBinaryFile=async function(t,e,r){var n=this.inodes[e];return this.is_forwarder(n)?(e=n.foreign_id,r=await this.follow_fs(n).CreateBinaryFile(t,e,r),this.create_forwarder(n.mount_id,r)):(n=this.CreateFile(t,e),t=this.inodes[n],e=new Uint8Array(r.length),e.set(r),await this.set_data(n,e),t.size=r.length,n)},N.prototype.OpenInode=function(t,e){var r=this.inodes[t];return this.is_forwarder(r)?this.follow_fs(r).OpenInode(r.foreign_id,e):((r.mode&61440)===ee&&this.FillDirectory(t),!0)},N.prototype.CloseInode=async function(t){var e=this.inodes[t];if(this.is_forwarder(e))return await this.follow_fs(e).CloseInode(e.foreign_id);e.status===2&&this.storage.uncache(e.sha256sum),e.status===Ji&&(e.status=-1,await this.DeleteData(t))},N.prototype.Rename=async function(t,e,r,n){if(t===r&&e===n)return 0;var a=this.Search(t,e);if(a===-1)return-2;var p=this.GetFullPath(t)+"/"+e;if(this.Search(r,n)!==-1){var d=this.Unlink(r,n);if(0>d)return d}var m=this.inodes[a],g=this.inodes[t];if(d=this.inodes[r],this.is_forwarder(g)||this.is_forwarder(d))if(this.is_forwarder(g)&&g.mount_id===d.mount_id){if(t=await this.follow_fs(g).Rename(g.foreign_id,e,d.foreign_id,n),0>t)return t}else{if(this.is_a_root(a)||!this.IsDirectory(a)&&1<this.GetInode(a).nlinks)return-1;g=this.divert(t,e);let y=this.GetInode(a),b=await this.Read(g,0,y.size);if(this.is_forwarder(d)?(r=this.follow_fs(d),n=this.IsDirectory(g)?r.CreateDirectory(n,d.foreign_id):r.CreateFile(n,d.foreign_id),r=r.GetInode(n),this.copy_inode(y,r),this.set_forwarder(a,d.mount_id,n)):(this.delete_forwarder(m),this.copy_inode(y,m),this.link_under_dir(r,a,n)),await this.ChangeSize(a,y.size),b&&b.length&&await this.Write(a,0,b.length,b),this.IsDirectory(a)){for(let E of this.GetChildren(g))if(d=await this.Rename(g,E,a,E),0>d)return d}if(await this.DeleteData(g),t=this.Unlink(t,e),0>t)return t}else this.unlink_from_dir(t,e),this.link_under_dir(r,a,n),m.qid.version++;return this.NotifyListeners(a,"rename",{oldpath:p}),0},N.prototype.Write=async function(t,e,r,n){this.NotifyListeners(t,"write");var a=this.inodes[t];if(this.is_forwarder(a))t=a.foreign_id,await this.follow_fs(a).Write(t,e,r,n);else{var p=await this.get_buffer(t);!p||p.length<e+r?(await this.ChangeSize(t,Math.floor(3*(e+r)/2)),a.size=e+r,p=await this.get_buffer(t)):a.size<e+r&&(a.size=e+r),n&&p.set(n.subarray(0,r),e),await this.set_data(t,p)}},N.prototype.Read=async function(t,e,r){let n=this.inodes[t];return this.is_forwarder(n)?(t=n.foreign_id,await this.follow_fs(n).Read(t,e,r)):await this.get_data(t,e,r)},N.prototype.Search=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){let r=t.foreign_id;return e=this.follow_fs(t).Search(r,e),e===-1?-1:this.get_forwarder(t.mount_id,e)}return e=t.direntries.get(e),e===void 0?-1:e},N.prototype.CountUsedInodes=function(){let t=this.inodes.length;for(let{fs:e,backtrack:r}of this.mounts)t+=e.CountUsedInodes(),t-=r.size;return t},N.prototype.CountFreeInodes=function(){let t=1048576;for(let{fs:e}of this.mounts)t+=e.CountFreeInodes();return t},N.prototype.GetTotalSize=function(){let t=this.used_size;for(let{fs:e}of this.mounts)t+=e.GetTotalSize();return t},N.prototype.GetSpace=function(){let t=this.total_size;for(let{fs:e}of this.mounts)t+=e.GetSpace();return this.total_size},N.prototype.GetDirectoryName=function(t){let e=this.inodes[this.GetParent(t)];if(this.is_forwarder(e))return this.follow_fs(e).GetDirectoryName(this.inodes[t].foreign_id);if(!e)return"";for(let[r,n]of e.direntries)if(n===t)return r;return""},N.prototype.GetFullPath=function(t){this.IsDirectory(t);for(var e="";t!==0;)e="/"+this.GetDirectoryName(t)+e,t=this.GetParent(t);return e.substring(1)},N.prototype.Link=function(t,e,r){if(this.IsDirectory(e))return-1;let n=this.inodes[t],a=this.inodes[e];return this.is_forwarder(n)?this.is_forwarder(a)&&a.mount_id===n.mount_id?this.follow_fs(n).Link(n.foreign_id,a.foreign_id,r):-1:this.is_forwarder(a)?-1:(this.link_under_dir(t,e,r),0)},N.prototype.Unlink=function(t,e){if(e==="."||e==="..")return-1;let r=this.Search(t,e),n=this.inodes[r],a=this.inodes[t];return this.is_forwarder(a)?(this.is_forwarder(n),t=a.foreign_id,this.follow_fs(a).Unlink(t,e)):this.IsDirectory(r)&&!this.IsEmpty(r)?-39:(this.unlink_from_dir(t,e),n.nlinks===0&&(n.status=Ji,this.NotifyListeners(r,"delete")),0)},N.prototype.DeleteData=async function(t){let e=this.inodes[t];this.is_forwarder(e)?await this.follow_fs(e).DeleteData(e.foreign_id):(e.size=0,delete this.inodedata[t])},N.prototype.get_buffer=async function(t){let e=this.inodes[t];return this.inodedata[t]?this.inodedata[t]:e.status===2?await this.storage.read(e.sha256sum,0,e.size):null},N.prototype.get_data=async function(t,e,r){let n=this.inodes[t];return this.inodedata[t]?this.inodedata[t].subarray(e,e+r):n.status===2?await this.storage.read(n.sha256sum,e,r):null},N.prototype.set_data=async function(t,e){this.inodedata[t]=e,this.inodes[t].status===2&&(this.inodes[t].status=0,this.storage.uncache(this.inodes[t].sha256sum))},N.prototype.GetInode=function(t){return isNaN(t),t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).GetInode(t.foreign_id):t},N.prototype.ChangeSize=async function(t,e){var r=this.GetInode(t),n=await this.get_data(t,0,r.size);if(e!==r.size){var a=new Uint8Array(e);r.size=e,n&&a.set(n.subarray(0,Math.min(n.length,r.size)),0),await this.set_data(t,a)}},N.prototype.SearchPath=function(t){t=t.replace("//","/"),t=t.split("/"),0<t.length&&t[t.length-1].length===0&&t.pop(),0<t.length&&t[0].length===0&&t.shift();let e=t.length;var r=-1,n=0;let a=null;for(var p=0;p<e;p++)if(r=n,n=this.Search(r,t[p]),!a&&this.is_forwarder(this.inodes[r])&&(a="/"+t.slice(p).join("/")),n===-1)return p<e-1?{id:-1,parentid:-1,name:t[p],forward_path:a}:{id:-1,parentid:r,name:t[p],forward_path:a};return{id:n,parentid:r,name:t[p],forward_path:a}},N.prototype.GetRecursiveList=function(t,e){if(this.is_forwarder(this.inodes[t])){let r=this.follow_fs(this.inodes[t]),n=this.inodes[t].mount_id,a=e.length;for(r.GetRecursiveList(this.inodes[t].foreign_id,e),t=a;t<e.length;t++)e[t].parentid=this.get_forwarder(n,e[t].parentid)}else for(let[r,n]of this.inodes[t].direntries)r!=="."&&r!==".."&&(e.push({parentid:t,name:r}),this.IsDirectory(n)&&this.GetRecursiveList(n,e))},N.prototype.RecursiveDelete=function(t){var e=[];if(t=this.SearchPath(t),t.id!==-1)for(this.GetRecursiveList(t.id,e),t=e.length-1;0<=t;t--)this.Unlink(e[t].parentid,e[t].name)},N.prototype.DeleteNode=function(t){var e=this.SearchPath(t);e.id!==-1&&((this.inodes[e.id].mode&61440)===Fe?this.Unlink(e.parentid,e.name):(this.inodes[e.id].mode&61440)===ee&&(this.RecursiveDelete(t),this.Unlink(e.parentid,e.name)))},N.prototype.NotifyListeners=function(){},N.prototype.Check=function(){for(var t=1;t<this.inodes.length;t++)if(this.inodes[t].status!==-1){var e=this.GetInode(t);if(0>e.nlinks&&Q.Debug("Error in filesystem: negative nlinks="+e.nlinks+" at id ="+t),this.IsDirectory(t)){e=this.GetInode(t),this.IsDirectory(t)&&0>this.GetParent(t)&&Q.Debug("Error in filesystem: negative parent id "+t);for(let[r,n]of e.direntries){r.length===0&&Q.Debug("Error in filesystem: inode with no name and id "+n);for(let a of r)32>a&&Q.Debug("Error in filesystem: Unallowed char in filename")}}}},N.prototype.FillDirectory=function(t){var e=this.inodes[t];if(this.is_forwarder(e))this.follow_fs(e).FillDirectory(e.foreign_id);else{var r=0;for(let n of e.direntries.keys())r+=24+Js.UTF8Length(n);t=this.inodedata[t]=new Uint8Array(r),e.size=r,r=0;for(let[n,a]of e.direntries)e=this.GetInode(a),r+=H.Marshall(["Q","d","b","s"],[e.qid,r+13+8+1+2+Js.UTF8Length(n),e.mode>>12,n],t,r)}},N.prototype.RoundToDirentry=function(t,e){if(t=this.inodedata[t],e>=t.length)return t.length;let r=0;for(;;){let n=H.Unmarshall(["Q","d"],t,{offset:r})[1];if(n>e)break;r=n}return r},N.prototype.IsDirectory=function(t){return t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).IsDirectory(t.foreign_id):(t.mode&61440)===ee},N.prototype.IsEmpty=function(t){if(t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).IsDirectory(t.foreign_id);for(let e of t.direntries.keys())if(e!=="."&&e!=="..")return!1;return!0},N.prototype.GetChildren=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).GetChildren(t.foreign_id);let e=[];for(let r of t.direntries.keys())r!=="."&&r!==".."&&e.push(r);return e},N.prototype.GetParent=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.should_be_linked(t))return t.direntries.get("..");let e=this.follow_fs(t).GetParent(t.foreign_id);return this.get_forwarder(t.mount_id,e)},N.prototype.PrepareCAPs=function(t){return t=this.GetInode(t),t.caps||(t.caps=new Uint8Array(20),t.caps[0]=0,t.caps[1]=0,t.caps[2]=0,t.caps[3]=2,t.caps[4]=255,t.caps[5]=255,t.caps[6]=255,t.caps[7]=255,t.caps[8]=255,t.caps[9]=255,t.caps[10]=255,t.caps[11]=255,t.caps[12]=63,t.caps[13]=0,t.caps[14]=0,t.caps[15]=0,t.caps[16]=63,t.caps[17]=0,t.caps[18]=0,t.caps[19]=0),t.caps.length};function Vs(t){this.fs=t,this.backtrack=new Map}Vs.prototype.get_state=function(){let t=[];return t[0]=this.fs,t[1]=[...this.backtrack],t},Vs.prototype.set_state=function(t){this.fs=t[0],this.backtrack=new Map(t[1])},N.prototype.set_forwarder=function(t,e,r){let n=this.inodes[t];this.is_forwarder(n)&&this.mounts[n.mount_id].backtrack.delete(n.foreign_id),n.status=5,n.mount_id=e,n.foreign_id=r,this.mounts[e].backtrack.set(r,t)},N.prototype.create_forwarder=function(t,e){let r=this.CreateInode(),n=this.inodes.length;return this.inodes.push(r),r.fid=n,this.set_forwarder(n,t,e),n},N.prototype.is_forwarder=function(t){return t.status===5},N.prototype.is_a_root=function(t){return this.GetInode(t).fid===0},N.prototype.get_forwarder=function(t,e){let r=this.mounts[t].backtrack.get(e);return r===void 0?this.create_forwarder(t,e):r},N.prototype.delete_forwarder=function(t){this.is_forwarder(t),t.status=-1,this.mounts[t.mount_id].backtrack.delete(t.foreign_id)},N.prototype.follow_fs=function(t){let e=this.mounts[t.mount_id];return this.is_forwarder(t),e.fs},N.prototype.Mount=function(t,e){if(t=this.SearchPath(t),t.parentid===-1)return-2;if(t.id!==-1)return-17;if(t.forward_path){var r=this.inodes[t.parentid];return e=this.follow_fs(r).Mount(t.forward_path,e),0>e?e:this.get_forwarder(r.mount_id,e)}return r=this.mounts.length,this.mounts.push(new Vs(e)),e=this.create_forwarder(r,0),this.link_under_dir(t.parentid,e,t.name),e};function ye(){this.type=2,this.start=0,this.length=1/0,this.proc_id=-1,this.client_id=""}ye.prototype.get_state=function(){let t=[];return t[0]=this.type,t[1]=this.start,t[2]=this.length===1/0?0:this.length,t[3]=this.proc_id,t[4]=this.client_id,t},ye.prototype.set_state=function(t){this.type=t[0],this.start=t[1],this.length=t[2]===0?1/0:t[2],this.proc_id=t[3],this.client_id=t[4]},ye.prototype.clone=function(){let t=new ye;return t.set_state(this.get_state()),t},ye.prototype.conflicts_with=function(t){return!(this.proc_id===t.proc_id&&this.client_id===t.client_id||this.type===2||t.type===2||this.type!==1&&t.type!==1||this.start+this.length<=t.start||t.start+t.length<=this.start)},ye.prototype.is_alike=function(t){return t.proc_id===this.proc_id&&t.client_id===this.client_id&&t.type===this.type},ye.prototype.may_merge_after=function(t){return this.is_alike(t)&&t.start+t.length===this.start},N.prototype.DescribeLock=function(t,e,r,n,a){let p=new ye;return p.type=t,p.start=e,p.length=r,p.proc_id=n,p.client_id=a,p},N.prototype.GetLock=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){var r=t.foreign_id;return this.follow_fs(t).GetLock(r,e)}for(r of t.locks)if(e.conflicts_with(r))return r.clone();return null},N.prototype.Lock=function(t,e,r){let n=this.inodes[t];if(this.is_forwarder(n))return t=n.foreign_id,this.follow_fs(n).Lock(t,e,r);if(e=e.clone(),e.type!==2&&this.GetLock(t,e))return 1;for(r=0;r<n.locks.length;r++){if(t=n.locks[r],t.start+t.length<=e.start)continue;if(e.start+e.length<=t.start)break;if(t.proc_id!==e.proc_id||t.client_id!==e.client_id){t.conflicts_with(e);continue}var a=e.start+e.length;let p=e.start-t.start,d=t.start+t.length-a;if(0<p&&0<d&&t.type===e.type)return 0;if(0<p&&(t.length=p),0>=p&&0<d)t.start=a,t.length=d;else if(0<d){for(;r<n.locks.length&&n.locks[r].start<a;)r++;n.locks.splice(r,0,this.DescribeLock(t.type,a,d,t.proc_id,t.client_id))}else 0>=p&&(n.locks.splice(r,1),r--)}if(e.type!==2){for(r=e,t=!1,a=0;a<n.locks.length&&(r.may_merge_after(n.locks[a])&&(n.locks[a].length+=e.length,r=n.locks[a],t=!0),!(e.start<=n.locks[a].start));a++);for(t||(n.locks.splice(a,0,r),a++);a<n.locks.length;a++)if(n.locks[a].is_alike(r)){n.locks[a].may_merge_after(r)&&(r.length+=n.locks[a].length,n.locks.splice(a,1));break}}return 0},N.prototype.read_dir=function(t){if(t=this.SearchPath(t),t.id!==-1)return t=this.GetInode(t.id),Array.from(t.direntries.keys()).filter(e=>e!=="."&&e!=="..")},N.prototype.read_file=function(t){if(t=this.SearchPath(t),t.id===-1)return Promise.resolve(null);let e=this.GetInode(t.id);return this.Read(t.id,0,e.size)};var Q={Debug:function(t){[].slice.apply(arguments).join(" ")},Abort:function(){}},H={Marshall:function(t,e,r,n){for(var a,p=0,d=0;d<t.length;d++)switch(a=e[d],t[d]){case"w":r[n++]=a&255,r[n++]=a>>8&255,r[n++]=a>>16&255,r[n++]=a>>24&255,p+=4;break;case"d":r[n++]=a&255,r[n++]=a>>8&255,r[n++]=a>>16&255,r[n++]=a>>24&255,r[n++]=0,r[n++]=0,r[n++]=0,r[n++]=0,p+=8;break;case"h":r[n++]=a&255,r[n++]=a>>8,p+=2;break;case"b":r[n++]=a,p+=1;break;case"s":var m=n,g=0;r[n++]=0,r[n++]=0,p+=2;for(var y of a)xc(y.charCodeAt(0)).forEach(function(b){r[n++]=b,p+=1,g++});r[m+0]=g&255,r[m+1]=g>>8&255;break;case"Q":H.Marshall(["b","w","d"],[a.type,a.version,a.path],r,n),n+=13,p+=13;break;default:Q.Debug("Marshall: Unknown type="+t[d])}return p},Unmarshall:function(t,e,r){let n=r.offset;for(var a=[],p=0;p<t.length;p++)switch(t[p]){case"w":var d=e[n++];d+=e[n++]<<8,d+=e[n++]<<16,d+=e[n++]<<24>>>0,a.push(d);break;case"d":d=e[n++],d+=e[n++]<<8,d+=e[n++]<<16,d+=e[n++]<<24>>>0,n+=4,a.push(d);break;case"h":d=e[n++],a.push(d+(e[n++]<<8));break;case"b":a.push(e[n++]);break;case"s":d=e[n++],d+=e[n++]<<8;for(var m="",g=new kc,y=0;y<d;y++){var b=g.Put(e[n++]);b!==-1&&(m+=String.fromCharCode(b))}a.push(m);break;case"Q":r.offset=n,d=H.Unmarshall(["b","w","d"],e,r),n=r.offset,a.push({type:d[0],version:d[1],path:d[2]});break;default:Q.Debug("Error in Unmarshall: Unknown type="+t[p])}return r.offset=n,a}},Js={};function kc(){this.stream=new Uint8Array(5),this.ofs=0,this.Put=function(t){switch(this.stream[this.ofs]=t,this.ofs++,this.ofs){case 1:if(128>this.stream[0])return this.ofs=0,this.stream[0];break;case 2:if((this.stream[0]&224)===192&&(this.stream[1]&192)===128)return this.ofs=0,(this.stream[0]&31)<<6|this.stream[1]&63}return-1}}function xc(t){if(128>t)return[t];if(2048>t)return[192|t>>6&31,128|t&63]}Js.UTF8Length=function(t){for(var e=0,r=0;r<t.length;r++){var n=t.charCodeAt(r);e+=128>n?1:2}return e}}).call(An)});var On=Z((Hp,Rn)=>{"use strict";T();Rn.exports=Dn;function Dn(o,i,s){o instanceof RegExp&&(o=Tn(o,s)),i instanceof RegExp&&(i=Tn(i,s));var h=In(o,i,s);return h&&{start:h[0],end:h[1],pre:s.slice(0,h[0]),body:s.slice(h[0]+o.length,h[1]),post:s.slice(h[1]+i.length)}}function Tn(o,i){var s=i.match(o);return s?s[0]:null}Dn.range=In;function In(o,i,s){var h,c,_,l,f,u=s.indexOf(o),w=s.indexOf(i,u+1),v=u;if(u>=0&&w>0){if(o===i)return[u,w];for(h=[],_=s.length;v>=0&&!f;)v==u?(h.push(v),u=s.indexOf(o,v+1)):h.length==1?f=[h.pop(),w]:(c=h.pop(),c<_&&(_=c,l=w),w=s.indexOf(i,v+1)),v=u<w&&u>=0?u:w;h.length&&(f=[_,l])}return f}});var Un=Z((Yp,zn)=>{T();var Pn=On();zn.exports=zc;var Mn="\0SLASH"+Math.random()+"\0",qn="\0OPEN"+Math.random()+"\0",Zs="\0CLOSE"+Math.random()+"\0",Fn="\0COMMA"+Math.random()+"\0",Ln="\0PERIOD"+Math.random()+"\0";function Qs(o){return parseInt(o,10)==o?parseInt(o,10):o.charCodeAt(0)}function Lc(o){return o.split("\\\\").join(Mn).split("\\{").join(qn).split("\\}").join(Zs).split("\\,").join(Fn).split("\\.").join(Ln)}function Nc(o){return o.split(Mn).join("\\").split(qn).join("{").split(Zs).join("}").split(Fn).join(",").split(Ln).join(".")}function Nn(o){if(!o)return[""];var i=[],s=Pn("{","}",o);if(!s)return o.split(",");var h=s.pre,c=s.body,_=s.post,l=h.split(",");l[l.length-1]+="{"+c+"}";var f=Nn(_);return _.length&&(l[l.length-1]+=f.shift(),l.push.apply(l,f)),i.push.apply(i,l),i}function zc(o){return o?(o.substr(0,2)==="{}"&&(o="\\{\\}"+o.substr(2)),li(Lc(o),!0).map(Nc)):[]}function Uc(o){return"{"+o+"}"}function Bc(o){return/^-?0\d/.test(o)}function jc(o,i){return o<=i}function Wc(o,i){return o>=i}function li(o,i){var s=[],h=Pn("{","}",o);if(!h)return[o];var c=h.pre,_=h.post.length?li(h.post,!1):[""];if(/\$$/.test(h.pre))for(var l=0;l<_.length;l++){var f=c+"{"+h.body+"}"+_[l];s.push(f)}else{var u=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(h.body),w=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(h.body),v=u||w,k=h.body.indexOf(",")>=0;if(!v&&!k)return h.post.match(/,.*\}/)?(o=h.pre+"{"+h.body+Zs+h.post,li(o)):[o];var S;if(v)S=h.body.split(/\.\./);else if(S=Nn(h.body),S.length===1&&(S=li(S[0],!1).map(Uc),S.length===1))return _.map(function(K){return h.pre+S[0]+K});var x;if(v){var A=Qs(S[0]),D=Qs(S[1]),O=Math.max(S[0].length,S[1].length),I=S.length==3?Math.abs(Qs(S[2])):1,B=jc,G=D<A;G&&(I*=-1,B=Wc);var Y=S.some(Bc);x=[];for(var q=A;B(q,D);q+=I){var tt;if(w)tt=String.fromCharCode(q),tt==="\\"&&(tt="");else if(tt=String(q),Y){var ot=O-tt.length;if(ot>0){var at=new Array(ot+1).join("0");q<0?tt="-"+at+tt.slice(1):tt=at+tt}}x.push(tt)}}else{x=[];for(var W=0;W<S.length;W++)x.push.apply(x,li(S[W],!1))}for(var W=0;W<x.length;W++)for(var l=0;l<_.length;l++){var f=c+x[W]+_[l];(!i||v||f)&&s.push(f)}}return s}});var At=Z(Wr=>{"use strict";T();Wr.fromCallback=function(o){return Object.defineProperty(function(...i){if(typeof i[i.length-1]=="function")o.apply(this,i);else return new Promise((s,h)=>{i.push((c,_)=>c!=null?h(c):s(_)),o.apply(this,i)})},"name",{value:o.name})};Wr.fromPromise=function(o){return Object.defineProperty(function(...i){let s=i[i.length-1];if(typeof s!="function")return o.apply(this,i);i.pop(),o.apply(this,i).then(h=>s(null,h),s)},"name",{value:o.name})}});var oh=Z((i0,nh)=>{T();var Re=st("constants"),md=process.cwd,xs=null,gd=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return xs||(xs=md.call(process)),xs};try{process.cwd()}catch{}typeof process.chdir=="function"&&(Gr=process.chdir,process.chdir=function(o){xs=null,Gr.call(process,o)},Object.setPrototypeOf&&Object.setPrototypeOf(process.chdir,Gr));var Gr;nh.exports=yd;function yd(o){Re.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&i(o),o.lutimes||s(o),o.chown=_(o.chown),o.fchown=_(o.fchown),o.lchown=_(o.lchown),o.chmod=h(o.chmod),o.fchmod=h(o.fchmod),o.lchmod=h(o.lchmod),o.chownSync=l(o.chownSync),o.fchownSync=l(o.fchownSync),o.lchownSync=l(o.lchownSync),o.chmodSync=c(o.chmodSync),o.fchmodSync=c(o.fchmodSync),o.lchmodSync=c(o.lchmodSync),o.stat=f(o.stat),o.fstat=f(o.fstat),o.lstat=f(o.lstat),o.statSync=u(o.statSync),o.fstatSync=u(o.fstatSync),o.lstatSync=u(o.lstatSync),o.chmod&&!o.lchmod&&(o.lchmod=function(v,k,S){S&&process.nextTick(S)},o.lchmodSync=function(){}),o.chown&&!o.lchown&&(o.lchown=function(v,k,S,x){x&&process.nextTick(x)},o.lchownSync=function(){}),gd==="win32"&&(o.rename=typeof o.rename!="function"?o.rename:function(v){function k(S,x,A){var D=Date.now(),O=0;v(S,x,function I(B){if(B&&(B.code==="EACCES"||B.code==="EPERM"||B.code==="EBUSY")&&Date.now()-D<6e4){setTimeout(function(){o.stat(x,function(G,Y){G&&G.code==="ENOENT"?v(S,x,I):A(B)})},O),O<100&&(O+=10);return}A&&A(B)})}return Object.setPrototypeOf&&Object.setPrototypeOf(k,v),k}(o.rename)),o.read=typeof o.read!="function"?o.read:function(v){function k(S,x,A,D,O,I){var B;if(I&&typeof I=="function"){var G=0;B=function(Y,q,tt){if(Y&&Y.code==="EAGAIN"&&G<10)return G++,v.call(o,S,x,A,D,O,B);I.apply(this,arguments)}}return v.call(o,S,x,A,D,O,B)}return Object.setPrototypeOf&&Object.setPrototypeOf(k,v),k}(o.read),o.readSync=typeof o.readSync!="function"?o.readSync:function(v){return function(k,S,x,A,D){for(var O=0;;)try{return v.call(o,k,S,x,A,D)}catch(I){if(I.code==="EAGAIN"&&O<10){O++;continue}throw I}}}(o.readSync);function i(v){v.lchmod=function(k,S,x){v.open(k,Re.O_WRONLY|Re.O_SYMLINK,S,function(A,D){if(A){x&&x(A);return}v.fchmod(D,S,function(O){v.close(D,function(I){x&&x(O||I)})})})},v.lchmodSync=function(k,S){var x=v.openSync(k,Re.O_WRONLY|Re.O_SYMLINK,S),A=!0,D;try{D=v.fchmodSync(x,S),A=!1}finally{if(A)try{v.closeSync(x)}catch{}else v.closeSync(x)}return D}}function s(v){Re.hasOwnProperty("O_SYMLINK")&&v.futimes?(v.lutimes=function(k,S,x,A){v.open(k,Re.O_SYMLINK,function(D,O){if(D){A&&A(D);return}v.futimes(O,S,x,function(I){v.close(O,function(B){A&&A(I||B)})})})},v.lutimesSync=function(k,S,x){var A=v.openSync(k,Re.O_SYMLINK),D,O=!0;try{D=v.futimesSync(A,S,x),O=!1}finally{if(O)try{v.closeSync(A)}catch{}else v.closeSync(A)}return D}):v.futimes&&(v.lutimes=function(k,S,x,A){A&&process.nextTick(A)},v.lutimesSync=function(){})}function h(v){return v&&function(k,S,x){return v.call(o,k,S,function(A){w(A)&&(A=null),x&&x.apply(this,arguments)})}}function c(v){return v&&function(k,S){try{return v.call(o,k,S)}catch(x){if(!w(x))throw x}}}function _(v){return v&&function(k,S,x,A){return v.call(o,k,S,x,function(D){w(D)&&(D=null),A&&A.apply(this,arguments)})}}function l(v){return v&&function(k,S,x){try{return v.call(o,k,S,x)}catch(A){if(!w(A))throw A}}}function f(v){return v&&function(k,S,x){typeof S=="function"&&(x=S,S=null);function A(D,O){O&&(O.uid<0&&(O.uid+=4294967296),O.gid<0&&(O.gid+=4294967296)),x&&x.apply(this,arguments)}return S?v.call(o,k,S,A):v.call(o,k,A)}}function u(v){return v&&function(k,S){var x=S?v.call(o,k,S):v.call(o,k);return x&&(x.uid<0&&(x.uid+=4294967296),x.gid<0&&(x.gid+=4294967296)),x}}function w(v){if(!v||v.code==="ENOSYS")return!0;var k=!process.getuid||process.getuid()!==0;return!!(k&&(v.code==="EINVAL"||v.code==="EPERM"))}}});var ch=Z((r0,ah)=>{T();var hh=st("stream").Stream;ah.exports=wd;function wd(o){return{ReadStream:i,WriteStream:s};function i(h,c){if(!(this instanceof i))return new i(h,c);hh.call(this);var _=this;this.path=h,this.fd=null,this.readable=!0,this.paused=!1,this.flags="r",this.mode=438,this.bufferSize=64*1024,c=c||{};for(var l=Object.keys(c),f=0,u=l.length;f<u;f++){var w=l[f];this[w]=c[w]}if(this.encoding&&this.setEncoding(this.encoding),this.start!==void 0){if(typeof this.start!="number")throw TypeError("start must be a Number");if(this.end===void 0)this.end=1/0;else if(typeof this.end!="number")throw TypeError("end must be a Number");if(this.start>this.end)throw new Error("start must be <= end");this.pos=this.start}if(this.fd!==null){process.nextTick(function(){_._read()});return}o.open(this.path,this.flags,this.mode,function(v,k){if(v){_.emit("error",v),_.readable=!1;return}_.fd=k,_.emit("open",k),_._read()})}function s(h,c){if(!(this instanceof s))return new s(h,c);hh.call(this),this.path=h,this.fd=null,this.writable=!0,this.flags="w",this.encoding="binary",this.mode=438,this.bytesWritten=0,c=c||{};for(var _=Object.keys(c),l=0,f=_.length;l<f;l++){var u=_[l];this[u]=c[u]}if(this.start!==void 0){if(typeof this.start!="number")throw TypeError("start must be a Number");if(this.start<0)throw new Error("start must be >= zero");this.pos=this.start}this.busy=!1,this._queue=[],this.fd===null&&(this._open=o.open,this._queue.push([this._open,this.path,this.flags,this.mode,void 0]),this.flush())}}});var uh=Z((o0,_h)=>{"use strict";T();_h.exports=bd;var vd=Object.getPrototypeOf||function(o){return o.__proto__};function bd(o){if(o===null||typeof o!="object")return o;if(o instanceof Object)var i={__proto__:vd(o)};else var i=Object.create(null);return Object.getOwnPropertyNames(o).forEach(function(s){Object.defineProperty(i,s,Object.getOwnPropertyDescriptor(o,s))}),i}});var ni=Z((a0,Kr)=>{T();var pt=st("fs"),kd=oh(),xd=ch(),Sd=uh(),Ss=st("util"),Dt,As;typeof Symbol=="function"&&typeof Symbol.for=="function"?(Dt=Symbol.for("graceful-fs.queue"),As=Symbol.for("graceful-fs.previous")):(Dt="___graceful-fs.queue",As="___graceful-fs.previous");function Ed(){}function ph(o,i){Object.defineProperty(o,Dt,{get:function(){return i}})}var ze=Ed;Ss.debuglog?ze=Ss.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(ze=function(){var o=Ss.format.apply(Ss,arguments);o="GFS4: "+o.split(/\n/).join(`
GFS4: `),console.error(o)});pt[Dt]||(dh=global[Dt]||[],ph(pt,dh),pt.close=function(o){function i(s,h){return o.call(pt,s,function(c){c||lh(),typeof h=="function"&&h.apply(this,arguments)})}return Object.defineProperty(i,As,{value:o}),i}(pt.close),pt.closeSync=function(o){function i(s){o.apply(pt,arguments),lh()}return Object.defineProperty(i,As,{value:o}),i}(pt.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",function(){ze(pt[Dt]),st("assert").equal(pt[Dt].length,0)}));var dh;global[Dt]||ph(global,pt[Dt]);Kr.exports=$r(Sd(pt));process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!pt.__patched&&(Kr.exports=$r(pt),pt.__patched=!0);function $r(o){kd(o),o.gracefulify=$r,o.createReadStream=q,o.createWriteStream=tt;var i=o.readFile;o.readFile=s;function s(W,K,J){return typeof K=="function"&&(J=K,K=null),ct(W,K,J);function ct(yt,ft,rt,ht){return i(yt,ft,function(et){et&&(et.code==="EMFILE"||et.code==="ENFILE")?ri([ct,[yt,ft,rt],et,ht||Date.now(),Date.now()]):typeof rt=="function"&&rt.apply(this,arguments)})}}var h=o.writeFile;o.writeFile=c;function c(W,K,J,ct){return typeof J=="function"&&(ct=J,J=null),yt(W,K,J,ct);function yt(ft,rt,ht,et,it){return h(ft,rt,ht,function(nt){nt&&(nt.code==="EMFILE"||nt.code==="ENFILE")?ri([yt,[ft,rt,ht,et],nt,it||Date.now(),Date.now()]):typeof et=="function"&&et.apply(this,arguments)})}}var _=o.appendFile;_&&(o.appendFile=l);function l(W,K,J,ct){return typeof J=="function"&&(ct=J,J=null),yt(W,K,J,ct);function yt(ft,rt,ht,et,it){return _(ft,rt,ht,function(nt){nt&&(nt.code==="EMFILE"||nt.code==="ENFILE")?ri([yt,[ft,rt,ht,et],nt,it||Date.now(),Date.now()]):typeof et=="function"&&et.apply(this,arguments)})}}var f=o.copyFile;f&&(o.copyFile=u);function u(W,K,J,ct){return typeof J=="function"&&(ct=J,J=0),yt(W,K,J,ct);function yt(ft,rt,ht,et,it){return f(ft,rt,ht,function(nt){nt&&(nt.code==="EMFILE"||nt.code==="ENFILE")?ri([yt,[ft,rt,ht,et],nt,it||Date.now(),Date.now()]):typeof et=="function"&&et.apply(this,arguments)})}}var w=o.readdir;o.readdir=k;var v=/^v[0-5]\./;function k(W,K,J){typeof K=="function"&&(J=K,K=null);var ct=v.test(process.version)?function(rt,ht,et,it){return w(rt,yt(rt,ht,et,it))}:function(rt,ht,et,it){return w(rt,ht,yt(rt,ht,et,it))};return ct(W,K,J);function yt(ft,rt,ht,et){return function(it,nt){it&&(it.code==="EMFILE"||it.code==="ENFILE")?ri([ct,[ft,rt,ht],it,et||Date.now(),Date.now()]):(nt&&nt.sort&&nt.sort(),typeof ht=="function"&&ht.call(this,it,nt))}}}if(process.version.substr(0,4)==="v0.8"){var S=xd(o);I=S.ReadStream,G=S.WriteStream}var x=o.ReadStream;x&&(I.prototype=Object.create(x.prototype),I.prototype.open=B);var A=o.WriteStream;A&&(G.prototype=Object.create(A.prototype),G.prototype.open=Y),Object.defineProperty(o,"ReadStream",{get:function(){return I},set:function(W){I=W},enumerable:!0,configurable:!0}),Object.defineProperty(o,"WriteStream",{get:function(){return G},set:function(W){G=W},enumerable:!0,configurable:!0});var D=I;Object.defineProperty(o,"FileReadStream",{get:function(){return D},set:function(W){D=W},enumerable:!0,configurable:!0});var O=G;Object.defineProperty(o,"FileWriteStream",{get:function(){return O},set:function(W){O=W},enumerable:!0,configurable:!0});function I(W,K){return this instanceof I?(x.apply(this,arguments),this):I.apply(Object.create(I.prototype),arguments)}function B(){var W=this;at(W.path,W.flags,W.mode,function(K,J){K?(W.autoClose&&W.destroy(),W.emit("error",K)):(W.fd=J,W.emit("open",J),W.read())})}function G(W,K){return this instanceof G?(A.apply(this,arguments),this):G.apply(Object.create(G.prototype),arguments)}function Y(){var W=this;at(W.path,W.flags,W.mode,function(K,J){K?(W.destroy(),W.emit("error",K)):(W.fd=J,W.emit("open",J))})}function q(W,K){return new o.ReadStream(W,K)}function tt(W,K){return new o.WriteStream(W,K)}var ot=o.open;o.open=at;function at(W,K,J,ct){return typeof J=="function"&&(ct=J,J=null),yt(W,K,J,ct);function yt(ft,rt,ht,et,it){return ot(ft,rt,ht,function(nt,js){nt&&(nt.code==="EMFILE"||nt.code==="ENFILE")?ri([yt,[ft,rt,ht,et],nt,it||Date.now(),Date.now()]):typeof et=="function"&&et.apply(this,arguments)})}}return o}function ri(o){ze("ENQUEUE",o[0].name,o[1]),pt[Dt].push(o),Hr()}var Es;function lh(){for(var o=Date.now(),i=0;i<pt[Dt].length;++i)pt[Dt][i].length>2&&(pt[Dt][i][3]=o,pt[Dt][i][4]=o);Hr()}function Hr(){if(clearTimeout(Es),Es=void 0,pt[Dt].length!==0){var o=pt[Dt].shift(),i=o[0],s=o[1],h=o[2],c=o[3],_=o[4];if(c===void 0)ze("RETRY",i.name,s),i.apply(null,s);else if(Date.now()-c>=6e4){ze("TIMEOUT",i.name,s);var l=s.pop();typeof l=="function"&&l.call(null,h)}else{var f=Date.now()-_,u=Math.max(_-c,1),w=Math.min(u*1.2,100);f>=w?(ze("RETRY",i.name,s),i.apply(null,s.concat([c]))):pt[Dt].push(o)}Es===void 0&&(Es=setTimeout(Hr,0))}}});var Bt=Z(be=>{"use strict";T();var fh=At().fromCallback,Ut=ni(),Ad=["access","appendFile","chmod","chown","close","copyFile","fchmod","fchown","fdatasync","fstat","fsync","ftruncate","futimes","lchmod","lchown","link","lstat","mkdir","mkdtemp","open","opendir","readdir","readFile","readlink","realpath","rename","rm","rmdir","stat","symlink","truncate","unlink","utimes","writeFile"].filter(o=>typeof Ut[o]=="function");Object.assign(be,Ut);Ad.forEach(o=>{be[o]=fh(Ut[o])});be.exists=function(o,i){return typeof i=="function"?Ut.exists(o,i):new Promise(s=>Ut.exists(o,s))};be.read=function(o,i,s,h,c,_){return typeof _=="function"?Ut.read(o,i,s,h,c,_):new Promise((l,f)=>{Ut.read(o,i,s,h,c,(u,w,v)=>{if(u)return f(u);l({bytesRead:w,buffer:v})})})};be.write=function(o,i,...s){return typeof s[s.length-1]=="function"?Ut.write(o,i,...s):new Promise((h,c)=>{Ut.write(o,i,...s,(_,l,f)=>{if(_)return c(_);h({bytesWritten:l,buffer:f})})})};be.readv=function(o,i,...s){return typeof s[s.length-1]=="function"?Ut.readv(o,i,...s):new Promise((h,c)=>{Ut.readv(o,i,...s,(_,l,f)=>{if(_)return c(_);h({bytesRead:l,buffers:f})})})};be.writev=function(o,i,...s){return typeof s[s.length-1]=="function"?Ut.writev(o,i,...s):new Promise((h,c)=>{Ut.writev(o,i,...s,(_,l,f)=>{if(_)return c(_);h({bytesWritten:l,buffers:f})})})};typeof Ut.realpath.native=="function"?be.realpath.native=fh(Ut.realpath.native):process.emitWarning("fs.realpath.native is not a function. Is fs being monkey-patched?","Warning","fs-extra-WARN0003")});var gh=Z((d0,mh)=>{"use strict";T();var Cd=st("path");mh.exports.checkPath=function(i){if(process.platform==="win32"&&/[<>:"|?*]/.test(i.replace(Cd.parse(i).root,""))){let h=new Error(`Path contains invalid characters: ${i}`);throw h.code="EINVAL",h}}});var bh=Z((p0,Yr)=>{"use strict";T();var yh=Bt(),{checkPath:wh}=gh(),vh=o=>{let i={mode:511};return typeof o=="number"?o:{...i,...o}.mode};Yr.exports.makeDir=async(o,i)=>(wh(o),yh.mkdir(o,{mode:vh(i),recursive:!0}));Yr.exports.makeDirSync=(o,i)=>(wh(o),yh.mkdirSync(o,{mode:vh(i),recursive:!0}))});var he=Z((m0,kh)=>{"use strict";T();var Td=At().fromPromise,{makeDir:Dd,makeDirSync:Vr}=bh(),Jr=Td(Dd);kh.exports={mkdirs:Jr,mkdirsSync:Vr,mkdirp:Jr,mkdirpSync:Vr,ensureDir:Jr,ensureDirSync:Vr}});var Oe=Z((y0,Sh)=>{"use strict";T();var Id=At().fromPromise,xh=Bt();function Rd(o){return xh.access(o).then(()=>!0).catch(()=>!1)}Sh.exports={pathExists:Id(Rd),pathExistsSync:xh.existsSync}});var Xr=Z((v0,Eh)=>{"use strict";T();var oi=Bt(),Od=At().fromPromise;async function Pd(o,i,s){let h=await oi.open(o,"r+"),c=null;try{await oi.futimes(h,i,s)}finally{try{await oi.close(h)}catch(_){c=_}}if(c)throw c}function Md(o,i,s){let h=oi.openSync(o,"r+");return oi.futimesSync(h,i,s),oi.closeSync(h)}Eh.exports={utimesMillis:Od(Pd),utimesMillisSync:Md}});var Ue=Z((k0,Dh)=>{"use strict";T();var hi=Bt(),Ct=st("path"),Ah=At().fromPromise;function qd(o,i,s){let h=s.dereference?c=>hi.stat(c,{bigint:!0}):c=>hi.lstat(c,{bigint:!0});return Promise.all([h(o),h(i).catch(c=>{if(c.code==="ENOENT")return null;throw c})]).then(([c,_])=>({srcStat:c,destStat:_}))}function Fd(o,i,s){let h,c=s.dereference?l=>hi.statSync(l,{bigint:!0}):l=>hi.lstatSync(l,{bigint:!0}),_=c(o);try{h=c(i)}catch(l){if(l.code==="ENOENT")return{srcStat:_,destStat:null};throw l}return{srcStat:_,destStat:h}}async function Ld(o,i,s,h){let{srcStat:c,destStat:_}=await qd(o,i,h);if(_){if(qi(c,_)){let l=Ct.basename(o),f=Ct.basename(i);if(s==="move"&&l!==f&&l.toLowerCase()===f.toLowerCase())return{srcStat:c,destStat:_,isChangingCase:!0};throw new Error("Source and destination must not be the same.")}if(c.isDirectory()&&!_.isDirectory())throw new Error(`Cannot overwrite non-directory '${i}' with directory '${o}'.`);if(!c.isDirectory()&&_.isDirectory())throw new Error(`Cannot overwrite directory '${i}' with non-directory '${o}'.`)}if(c.isDirectory()&&Qr(o,i))throw new Error(Cs(o,i,s));return{srcStat:c,destStat:_}}function Nd(o,i,s,h){let{srcStat:c,destStat:_}=Fd(o,i,h);if(_){if(qi(c,_)){let l=Ct.basename(o),f=Ct.basename(i);if(s==="move"&&l!==f&&l.toLowerCase()===f.toLowerCase())return{srcStat:c,destStat:_,isChangingCase:!0};throw new Error("Source and destination must not be the same.")}if(c.isDirectory()&&!_.isDirectory())throw new Error(`Cannot overwrite non-directory '${i}' with directory '${o}'.`);if(!c.isDirectory()&&_.isDirectory())throw new Error(`Cannot overwrite directory '${i}' with non-directory '${o}'.`)}if(c.isDirectory()&&Qr(o,i))throw new Error(Cs(o,i,s));return{srcStat:c,destStat:_}}async function Ch(o,i,s,h){let c=Ct.resolve(Ct.dirname(o)),_=Ct.resolve(Ct.dirname(s));if(_===c||_===Ct.parse(_).root)return;let l;try{l=await hi.stat(_,{bigint:!0})}catch(f){if(f.code==="ENOENT")return;throw f}if(qi(i,l))throw new Error(Cs(o,s,h));return Ch(o,i,_,h)}function Th(o,i,s,h){let c=Ct.resolve(Ct.dirname(o)),_=Ct.resolve(Ct.dirname(s));if(_===c||_===Ct.parse(_).root)return;let l;try{l=hi.statSync(_,{bigint:!0})}catch(f){if(f.code==="ENOENT")return;throw f}if(qi(i,l))throw new Error(Cs(o,s,h));return Th(o,i,_,h)}function qi(o,i){return i.ino&&i.dev&&i.ino===o.ino&&i.dev===o.dev}function Qr(o,i){let s=Ct.resolve(o).split(Ct.sep).filter(c=>c),h=Ct.resolve(i).split(Ct.sep).filter(c=>c);return s.every((c,_)=>h[_]===c)}function Cs(o,i,s){return`Cannot ${s} '${o}' to a subdirectory of itself, '${i}'.`}Dh.exports={checkPaths:Ah(Ld),checkPathsSync:Nd,checkParentPaths:Ah(Ch),checkParentPathsSync:Th,isSrcSubdir:Qr,areIdentical:qi}});var Mh=Z((S0,Ph)=>{"use strict";T();var Mt=Bt(),Fi=st("path"),{mkdirs:zd}=he(),{pathExists:Ud}=Oe(),{utimesMillis:Bd}=Xr(),Li=Ue();async function jd(o,i,s={}){typeof s=="function"&&(s={filter:s}),s.clobber="clobber"in s?!!s.clobber:!0,s.overwrite="overwrite"in s?!!s.overwrite:s.clobber,s.preserveTimestamps&&process.arch==="ia32"&&process.emitWarning(`Using the preserveTimestamps option in 32-bit node is not recommended;

	see https://github.com/jprichardson/node-fs-extra/issues/269`,"Warning","fs-extra-WARN0001");let{srcStat:h,destStat:c}=await Li.checkPaths(o,i,"copy",s);if(await Li.checkParentPaths(o,h,i,"copy"),!await Rh(o,i,s))return;let l=Fi.dirname(i);await Ud(l)||await zd(l),await Oh(c,o,i,s)}async function Rh(o,i,s){return s.filter?s.filter(o,i):!0}async function Oh(o,i,s,h){let _=await(h.dereference?Mt.stat:Mt.lstat)(i);if(_.isDirectory())return Hd(_,o,i,s,h);if(_.isFile()||_.isCharacterDevice()||_.isBlockDevice())return Wd(_,o,i,s,h);if(_.isSymbolicLink())return Kd(o,i,s,h);throw _.isSocket()?new Error(`Cannot copy a socket file: ${i}`):_.isFIFO()?new Error(`Cannot copy a FIFO pipe: ${i}`):new Error(`Unknown file: ${i}`)}async function Wd(o,i,s,h,c){if(!i)return Ih(o,s,h,c);if(c.overwrite)return await Mt.unlink(h),Ih(o,s,h,c);if(c.errorOnExist)throw new Error(`'${h}' already exists`)}async function Ih(o,i,s,h){if(await Mt.copyFile(i,s),h.preserveTimestamps){Gd(o.mode)&&await $d(s,o.mode);let c=await Mt.stat(i);await Bd(s,c.atime,c.mtime)}return Mt.chmod(s,o.mode)}function Gd(o){return(o&128)===0}function $d(o,i){return Mt.chmod(o,i|128)}async function Hd(o,i,s,h,c){i||await Mt.mkdir(h);let _=await Mt.readdir(s);await Promise.all(_.map(async l=>{let f=Fi.join(s,l),u=Fi.join(h,l);if(!await Rh(f,u,c))return;let{destStat:v}=await Li.checkPaths(f,u,"copy",c);return Oh(v,f,u,c)})),i||await Mt.chmod(h,o.mode)}async function Kd(o,i,s,h){let c=await Mt.readlink(i);if(h.dereference&&(c=Fi.resolve(process.cwd(),c)),!o)return Mt.symlink(c,s);let _=null;try{_=await Mt.readlink(s)}catch(l){if(l.code==="EINVAL"||l.code==="UNKNOWN")return Mt.symlink(c,s);throw l}if(h.dereference&&(_=Fi.resolve(process.cwd(),_)),Li.isSrcSubdir(c,_))throw new Error(`Cannot copy '${c}' to a subdirectory of itself, '${_}'.`);if(Li.isSrcSubdir(_,c))throw new Error(`Cannot overwrite '${_}' with '${c}'.`);return await Mt.unlink(s),Mt.symlink(c,s)}Ph.exports=jd});var zh=Z((A0,Nh)=>{"use strict";T();var jt=ni(),Ni=st("path"),Yd=he().mkdirsSync,Vd=Xr().utimesMillisSync,zi=Ue();function Jd(o,i,s){typeof s=="function"&&(s={filter:s}),s=s||{},s.clobber="clobber"in s?!!s.clobber:!0,s.overwrite="overwrite"in s?!!s.overwrite:s.clobber,s.preserveTimestamps&&process.arch==="ia32"&&process.emitWarning(`Using the preserveTimestamps option in 32-bit node is not recommended;

	see https://github.com/jprichardson/node-fs-extra/issues/269`,"Warning","fs-extra-WARN0002");let{srcStat:h,destStat:c}=zi.checkPathsSync(o,i,"copy",s);if(zi.checkParentPathsSync(o,h,i,"copy"),s.filter&&!s.filter(o,i))return;let _=Ni.dirname(i);return jt.existsSync(_)||Yd(_),qh(c,o,i,s)}function qh(o,i,s,h){let _=(h.dereference?jt.statSync:jt.lstatSync)(i);if(_.isDirectory())return sl(_,o,i,s,h);if(_.isFile()||_.isCharacterDevice()||_.isBlockDevice())return Xd(_,o,i,s,h);if(_.isSymbolicLink())return ol(o,i,s,h);throw _.isSocket()?new Error(`Cannot copy a socket file: ${i}`):_.isFIFO()?new Error(`Cannot copy a FIFO pipe: ${i}`):new Error(`Unknown file: ${i}`)}function Xd(o,i,s,h,c){return i?Qd(o,s,h,c):Fh(o,s,h,c)}function Qd(o,i,s,h){if(h.overwrite)return jt.unlinkSync(s),Fh(o,i,s,h);if(h.errorOnExist)throw new Error(`'${s}' already exists`)}function Fh(o,i,s,h){return jt.copyFileSync(i,s),h.preserveTimestamps&&Zd(o.mode,i,s),Zr(s,o.mode)}function Zd(o,i,s){return tl(o)&&el(s,o),il(i,s)}function tl(o){return(o&128)===0}function el(o,i){return Zr(o,i|128)}function Zr(o,i){return jt.chmodSync(o,i)}function il(o,i){let s=jt.statSync(o);return Vd(i,s.atime,s.mtime)}function sl(o,i,s,h,c){return i?Lh(s,h,c):rl(o.mode,s,h,c)}function rl(o,i,s,h){return jt.mkdirSync(s),Lh(i,s,h),Zr(s,o)}function Lh(o,i,s){jt.readdirSync(o).forEach(h=>nl(h,o,i,s))}function nl(o,i,s,h){let c=Ni.join(i,o),_=Ni.join(s,o);if(h.filter&&!h.filter(c,_))return;let{destStat:l}=zi.checkPathsSync(c,_,"copy",h);return qh(l,c,_,h)}function ol(o,i,s,h){let c=jt.readlinkSync(i);if(h.dereference&&(c=Ni.resolve(process.cwd(),c)),o){let _;try{_=jt.readlinkSync(s)}catch(l){if(l.code==="EINVAL"||l.code==="UNKNOWN")return jt.symlinkSync(c,s);throw l}if(h.dereference&&(_=Ni.resolve(process.cwd(),_)),zi.isSrcSubdir(c,_))throw new Error(`Cannot copy '${c}' to a subdirectory of itself, '${_}'.`);if(zi.isSrcSubdir(_,c))throw new Error(`Cannot overwrite '${_}' with '${c}'.`);return hl(c,s)}else return jt.symlinkSync(c,s)}function hl(o,i){return jt.unlinkSync(i),jt.symlinkSync(o,i)}Nh.exports=Jd});var Ts=Z((T0,Uh)=>{"use strict";T();var al=At().fromPromise;Uh.exports={copy:al(Mh()),copySync:zh()}});var Ui=Z((I0,jh)=>{"use strict";T();var Bh=ni(),cl=At().fromCallback;function _l(o,i){Bh.rm(o,{recursive:!0,force:!0},i)}function ul(o){Bh.rmSync(o,{recursive:!0,force:!0})}jh.exports={remove:cl(_l),removeSync:ul}});var Jh=Z((O0,Vh)=>{"use strict";T();var dl=At().fromPromise,$h=Bt(),Hh=st("path"),Kh=he(),Yh=Ui(),Wh=dl(async function(i){let s;try{s=await $h.readdir(i)}catch{return Kh.mkdirs(i)}return Promise.all(s.map(h=>Yh.remove(Hh.join(i,h))))});function Gh(o){let i;try{i=$h.readdirSync(o)}catch{return Kh.mkdirsSync(o)}i.forEach(s=>{s=Hh.join(o,s),Yh.removeSync(s)})}Vh.exports={emptyDirSync:Gh,emptydirSync:Gh,emptyDir:Wh,emptydir:Wh}});var ta=Z((M0,Zh)=>{"use strict";T();var ll=At().fromPromise,Xh=st("path"),ke=Bt(),Qh=he();async function pl(o){let i;try{i=await ke.stat(o)}catch{}if(i&&i.isFile())return;let s=Xh.dirname(o),h=null;try{h=await ke.stat(s)}catch(c){if(c.code==="ENOENT"){await Qh.mkdirs(s),await ke.writeFile(o,"");return}else throw c}h.isDirectory()?await ke.writeFile(o,""):await ke.readdir(s)}function fl(o){let i;try{i=ke.statSync(o)}catch{}if(i&&i.isFile())return;let s=Xh.dirname(o);try{ke.statSync(s).isDirectory()||ke.readdirSync(s)}catch(h){if(h&&h.code==="ENOENT")Qh.mkdirsSync(s);else throw h}ke.writeFileSync(o,"")}Zh.exports={createFile:ll(pl),createFileSync:fl}});var na=Z((F0,ra)=>{"use strict";T();var ml=At().fromPromise,ea=st("path"),Pe=Bt(),ia=he(),{pathExists:gl}=Oe(),{areIdentical:sa}=Ue();async function yl(o,i){let s;try{s=await Pe.lstat(i)}catch{}let h;try{h=await Pe.lstat(o)}catch(l){throw l.message=l.message.replace("lstat","ensureLink"),l}if(s&&sa(h,s))return;let c=ea.dirname(i);await gl(c)||await ia.mkdirs(c),await Pe.link(o,i)}function wl(o,i){let s;try{s=Pe.lstatSync(i)}catch{}try{let _=Pe.lstatSync(o);if(s&&sa(_,s))return}catch(_){throw _.message=_.message.replace("lstat","ensureLink"),_}let h=ea.dirname(i);return Pe.existsSync(h)||ia.mkdirsSync(h),Pe.linkSync(o,i)}ra.exports={createLink:ml(yl),createLinkSync:wl}});var ha=Z((N0,oa)=>{"use strict";T();var Me=st("path"),Bi=Bt(),{pathExists:vl}=Oe(),bl=At().fromPromise;async function kl(o,i){if(Me.isAbsolute(o)){try{await Bi.lstat(o)}catch(_){throw _.message=_.message.replace("lstat","ensureSymlink"),_}return{toCwd:o,toDst:o}}let s=Me.dirname(i),h=Me.join(s,o);if(await vl(h))return{toCwd:h,toDst:o};try{await Bi.lstat(o)}catch(_){throw _.message=_.message.replace("lstat","ensureSymlink"),_}return{toCwd:o,toDst:Me.relative(s,o)}}function xl(o,i){if(Me.isAbsolute(o)){if(!Bi.existsSync(o))throw new Error("absolute srcpath does not exist");return{toCwd:o,toDst:o}}let s=Me.dirname(i),h=Me.join(s,o);if(Bi.existsSync(h))return{toCwd:h,toDst:o};if(!Bi.existsSync(o))throw new Error("relative srcpath does not exist");return{toCwd:o,toDst:Me.relative(s,o)}}oa.exports={symlinkPaths:bl(kl),symlinkPathsSync:xl}});var _a=Z((U0,ca)=>{"use strict";T();var aa=Bt(),Sl=At().fromPromise;async function El(o,i){if(i)return i;let s;try{s=await aa.lstat(o)}catch{return"file"}return s&&s.isDirectory()?"dir":"file"}function Al(o,i){if(i)return i;let s;try{s=aa.lstatSync(o)}catch{return"file"}return s&&s.isDirectory()?"dir":"file"}ca.exports={symlinkType:Sl(El),symlinkTypeSync:Al}});var pa=Z((j0,la)=>{"use strict";T();var Cl=At().fromPromise,ua=st("path"),le=Bt(),{mkdirs:Tl,mkdirsSync:Dl}=he(),{symlinkPaths:Il,symlinkPathsSync:Rl}=ha(),{symlinkType:Ol,symlinkTypeSync:Pl}=_a(),{pathExists:Ml}=Oe(),{areIdentical:da}=Ue();async function ql(o,i,s){let h;try{h=await le.lstat(i)}catch{}if(h&&h.isSymbolicLink()){let[f,u]=await Promise.all([le.stat(o),le.stat(i)]);if(da(f,u))return}let c=await Il(o,i);o=c.toDst;let _=await Ol(c.toCwd,s),l=ua.dirname(i);return await Ml(l)||await Tl(l),le.symlink(o,i,_)}function Fl(o,i,s){let h;try{h=le.lstatSync(i)}catch{}if(h&&h.isSymbolicLink()){let f=le.statSync(o),u=le.statSync(i);if(da(f,u))return}let c=Rl(o,i);o=c.toDst,s=Pl(c.toCwd,s);let _=ua.dirname(i);return le.existsSync(_)||Dl(_),le.symlinkSync(o,i,s)}la.exports={createSymlink:Cl(ql),createSymlinkSync:Fl}});var ka=Z((G0,ba)=>{"use strict";T();var{createFile:fa,createFileSync:ma}=ta(),{createLink:ga,createLinkSync:ya}=na(),{createSymlink:wa,createSymlinkSync:va}=pa();ba.exports={createFile:fa,createFileSync:ma,ensureFile:fa,ensureFileSync:ma,createLink:ga,createLinkSync:ya,ensureLink:ga,ensureLinkSync:ya,createSymlink:wa,createSymlinkSync:va,ensureSymlink:wa,ensureSymlinkSync:va}});var Ds=Z((H0,xa)=>{T();function Ll(o,{EOL:i=`
`,finalEOL:s=!0,replacer:h=null,spaces:c}={}){let _=s?i:"";return JSON.stringify(o,h,c).replace(/\n/g,i)+_}function Nl(o){return Buffer.isBuffer(o)&&(o=o.toString("utf8")),o.replace(/^\uFEFF/,"")}xa.exports={stringify:Ll,stripBom:Nl}});var Ca=Z((Y0,Aa)=>{T();var ai;try{ai=ni()}catch{ai=st("fs")}var Is=At(),{stringify:Sa,stripBom:Ea}=Ds();async function zl(o,i={}){typeof i=="string"&&(i={encoding:i});let s=i.fs||ai,h="throws"in i?i.throws:!0,c=await Is.fromCallback(s.readFile)(o,i);c=Ea(c);let _;try{_=JSON.parse(c,i?i.reviver:null)}catch(l){if(h)throw l.message=`${o}: ${l.message}`,l;return null}return _}var Ul=Is.fromPromise(zl);function Bl(o,i={}){typeof i=="string"&&(i={encoding:i});let s=i.fs||ai,h="throws"in i?i.throws:!0;try{let c=s.readFileSync(o,i);return c=Ea(c),JSON.parse(c,i.reviver)}catch(c){if(h)throw c.message=`${o}: ${c.message}`,c;return null}}async function jl(o,i,s={}){let h=s.fs||ai,c=Sa(i,s);await Is.fromCallback(h.writeFile)(o,c,s)}var Wl=Is.fromPromise(jl);function Gl(o,i,s={}){let h=s.fs||ai,c=Sa(i,s);return h.writeFileSync(o,c,s)}var $l={readFile:Ul,readFileSync:Bl,writeFile:Wl,writeFileSync:Gl};Aa.exports=$l});var Da=Z((J0,Ta)=>{"use strict";T();var Rs=Ca();Ta.exports={readJson:Rs.readFile,readJsonSync:Rs.readFileSync,writeJson:Rs.writeFile,writeJsonSync:Rs.writeFileSync}});var Os=Z((Q0,Oa)=>{"use strict";T();var Hl=At().fromPromise,tn=Bt(),Ia=st("path"),Ra=he(),Kl=Oe().pathExists;async function Yl(o,i,s="utf-8"){let h=Ia.dirname(o);return await Kl(h)||await Ra.mkdirs(h),tn.writeFile(o,i,s)}function Vl(o,...i){let s=Ia.dirname(o);tn.existsSync(s)||Ra.mkdirsSync(s),tn.writeFileSync(o,...i)}Oa.exports={outputFile:Hl(Yl),outputFileSync:Vl}});var Ma=Z((tg,Pa)=>{"use strict";T();var{stringify:Jl}=Ds(),{outputFile:Xl}=Os();async function Ql(o,i,s={}){let h=Jl(i,s);await Xl(o,h,s)}Pa.exports=Ql});var Fa=Z((ig,qa)=>{"use strict";T();var{stringify:Zl}=Ds(),{outputFileSync:tp}=Os();function ep(o,i,s){let h=Zl(i,s);tp(o,h,s)}qa.exports=ep});var Na=Z((rg,La)=>{"use strict";T();var ip=At().fromPromise,Wt=Da();Wt.outputJson=ip(Ma());Wt.outputJsonSync=Fa();Wt.outputJSON=Wt.outputJson;Wt.outputJSONSync=Wt.outputJsonSync;Wt.writeJSON=Wt.writeJson;Wt.writeJSONSync=Wt.writeJsonSync;Wt.readJSON=Wt.readJson;Wt.readJSONSync=Wt.readJsonSync;La.exports=Wt});var Wa=Z((og,ja)=>{"use strict";T();var sp=Bt(),za=st("path"),{copy:rp}=Ts(),{remove:Ba}=Ui(),{mkdirp:np}=he(),{pathExists:op}=Oe(),Ua=Ue();async function hp(o,i,s={}){let h=s.overwrite||s.clobber||!1,{srcStat:c,isChangingCase:_=!1}=await Ua.checkPaths(o,i,"move",s);await Ua.checkParentPaths(o,c,i,"move");let l=za.dirname(i);return za.parse(l).root!==l&&await np(l),ap(o,i,h,_)}async function ap(o,i,s,h){if(!h){if(s)await Ba(i);else if(await op(i))throw new Error("dest already exists.")}try{await sp.rename(o,i)}catch(c){if(c.code!=="EXDEV")throw c;await cp(o,i,s)}}async function cp(o,i,s){return await rp(o,i,{overwrite:s,errorOnExist:!0,preserveTimestamps:!0}),Ba(o)}ja.exports=hp});var Ya=Z((ag,Ka)=>{"use strict";T();var $a=ni(),sn=st("path"),_p=Ts().copySync,Ha=Ui().removeSync,up=he().mkdirpSync,Ga=Ue();function dp(o,i,s){s=s||{};let h=s.overwrite||s.clobber||!1,{srcStat:c,isChangingCase:_=!1}=Ga.checkPathsSync(o,i,"move",s);return Ga.checkParentPathsSync(o,c,i,"move"),lp(i)||up(sn.dirname(i)),pp(o,i,h,_)}function lp(o){let i=sn.dirname(o);return sn.parse(i).root===i}function pp(o,i,s,h){if(h)return en(o,i,s);if(s)return Ha(i),en(o,i,s);if($a.existsSync(i))throw new Error("dest already exists.");return en(o,i,s)}function en(o,i,s){try{$a.renameSync(o,i)}catch(h){if(h.code!=="EXDEV")throw h;return fp(o,i,s)}}function fp(o,i,s){return _p(o,i,{overwrite:s,errorOnExist:!0,preserveTimestamps:!0}),Ha(o)}Ka.exports=dp});var Ja=Z((_g,Va)=>{"use strict";T();var mp=At().fromPromise;Va.exports={move:mp(Wa()),moveSync:Ya()}});var Qa=Z((dg,Xa)=>{"use strict";T();Xa.exports={...Bt(),...Ts(),...Jh(),...ka(),...Na(),...he(),...Ja(),...Os(),...Oe(),...Ui()}});var nn=Z(ji=>{T();(function(o,i){"use strict";typeof ji=="object"?(o.slip=ji,i(ji)):typeof define=="function"&&define.amd?define(["exports"],function(s){return o.slip=s,o.slip,i(s)}):(o.slip={},i(o.slip))})(ji,function(o){"use strict";var i=o;i.END=192,i.ESC=219,i.ESC_END=220,i.ESC_ESC=221,i.byteArray=function(h,c,_){return h instanceof ArrayBuffer?new Uint8Array(h,c,_):h},i.expandByteArray=function(h){var c=new Uint8Array(h.length*2);return c.set(h),c},i.sliceByteArray=function(h,c,_){var l=h.buffer.slice?h.buffer.slice(c,_):h.subarray(c,_);return new Uint8Array(l)},i.encode=function(h,c){c=c||{},c.bufferPadding=c.bufferPadding||4,h=i.byteArray(h,c.offset,c.byteLength);var _=h.length+c.bufferPadding+3&-4,l=new Uint8Array(_),f=1;l[0]=i.END;for(var u=0;u<h.length;u++){f>l.length-3&&(l=i.expandByteArray(l));var w=h[u];w===i.END?(l[f++]=i.ESC,w=i.ESC_END):w===i.ESC&&(l[f++]=i.ESC,w=i.ESC_ESC),l[f++]=w}return l[f]=i.END,i.sliceByteArray(l,0,f+1)},i.Decoder=function(h){h=typeof h!="function"?h||{}:{onMessage:h},this.maxMessageSize=h.maxMessageSize||10485760,this.bufferSize=h.bufferSize||1024,this.msgBuffer=new Uint8Array(this.bufferSize),this.msgBufferIdx=0,this.onMessage=h.onMessage,this.onError=h.onError,this.escape=!1};var s=i.Decoder.prototype;return s.decode=function(h){h=i.byteArray(h);for(var c,_=0;_<h.length;_++){var l=h[_];if(this.escape)l===i.ESC_ESC?l=i.ESC:l===i.ESC_END&&(l=i.END);else{if(l===i.ESC){this.escape=!0;continue}if(l===i.END){c=this.handleEnd();continue}}var f=this.addByte(l);f||this.handleMessageMaxError()}return c},s.handleMessageMaxError=function(){this.onError&&this.onError(this.msgBuffer.subarray(0),"The message is too large; the maximum message size is "+this.maxMessageSize/1024+"KB. Use a larger maxMessageSize if necessary."),this.msgBufferIdx=0,this.escape=!1},s.addByte=function(h){return this.msgBufferIdx>this.msgBuffer.length-1&&(this.msgBuffer=i.expandByteArray(this.msgBuffer)),this.msgBuffer[this.msgBufferIdx++]=h,this.escape=!1,this.msgBuffer.length<this.maxMessageSize},s.handleEnd=function(){if(this.msgBufferIdx!==0){var h=i.sliceByteArray(this.msgBuffer,0,this.msgBufferIdx);return this.onMessage&&this.onMessage(h),this.msgBufferIdx=0,h}},i})});T();var Fp=di(Cn(),1);T();T();T();var Yn=di(Un(),1);T();var pi=o=>{if(typeof o!="string")throw new TypeError("invalid pattern");if(o.length>65536)throw new TypeError("pattern is too long")};T();T();var Gc={"[:alnum:]":["\\p{L}\\p{Nl}\\p{Nd}",!0],"[:alpha:]":["\\p{L}\\p{Nl}",!0],"[:ascii:]":["\\x00-\\x7f",!1],"[:blank:]":["\\p{Zs}\\t",!0],"[:cntrl:]":["\\p{Cc}",!0],"[:digit:]":["\\p{Nd}",!0],"[:graph:]":["\\p{Z}\\p{C}",!0,!0],"[:lower:]":["\\p{Ll}",!0],"[:print:]":["\\p{C}",!0],"[:punct:]":["\\p{P}",!0],"[:space:]":["\\p{Z}\\t\\r\\n\\v\\f",!0],"[:upper:]":["\\p{Lu}",!0],"[:word:]":["\\p{L}\\p{Nl}\\p{Nd}\\p{Pc}",!0],"[:xdigit:]":["A-Fa-f0-9",!1]},fi=o=>o.replace(/[[\]\\-]/g,"\\$&"),$c=o=>o.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),Bn=o=>o.join(""),jn=(o,i)=>{let s=i;if(o.charAt(s)!=="[")throw new Error("not in a brace expression");let h=[],c=[],_=s+1,l=!1,f=!1,u=!1,w=!1,v=s,k="";t:for(;_<o.length;){let D=o.charAt(_);if((D==="!"||D==="^")&&_===s+1){w=!0,_++;continue}if(D==="]"&&l&&!u){v=_+1;break}if(l=!0,D==="\\"&&!u){u=!0,_++;continue}if(D==="["&&!u){for(let[O,[I,B,G]]of Object.entries(Gc))if(o.startsWith(O,_)){if(k)return["$.",!1,o.length-s,!0];_+=O.length,G?c.push(I):h.push(I),f=f||B;continue t}}if(u=!1,k){D>k?h.push(fi(k)+"-"+fi(D)):D===k&&h.push(fi(D)),k="",_++;continue}if(o.startsWith("-]",_+1)){h.push(fi(D+"-")),_+=2;continue}if(o.startsWith("-",_+1)){k=D,_+=2;continue}h.push(fi(D)),_++}if(v<_)return["",!1,0,!1];if(!h.length&&!c.length)return["$.",!1,o.length-s,!0];if(c.length===0&&h.length===1&&/^\\?.$/.test(h[0])&&!w){let D=h[0].length===2?h[0].slice(-1):h[0];return[$c(D),!1,v-s,!1]}let S="["+(w?"^":"")+Bn(h)+"]",x="["+(w?"":"^")+Bn(c)+"]";return[h.length&&c.length?"("+S+"|"+x+")":h.length?S:x,f,v-s,!0]};T();var ie=(o,{windowsPathsNoEscape:i=!1}={})=>i?o.replace(/\[([^\/\\])\]/g,"$1"):o.replace(/((?!\\).|^)\[([^\/\\])\]/g,"$1$2").replace(/\\([^\/])/g,"$1");var Hc=new Set(["!","?","+","*","@"]),Wn=o=>Hc.has(o),Kc="(?!(?:^|/)\\.\\.?(?:$|/))",Zi="(?!\\.)",Yc=new Set(["[","."]),Vc=new Set(["..","."]),Jc=new Set("().*{}+?[]^$\\!"),Xc=o=>o.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),tr="[^/]",Gn=tr+"*?",$n=tr+"+?",$e=class o{type;#t;#e;#n=!1;#s=[];#o;#v;#c;#u=!1;#h;#a;#r=!1;constructor(i,s,h={}){this.type=i,i&&(this.#e=!0),this.#o=s,this.#t=this.#o?this.#o.#t:this,this.#h=this.#t===this?h:this.#t.#h,this.#c=this.#t===this?[]:this.#t.#c,i==="!"&&!this.#t.#u&&this.#c.push(this),this.#v=this.#o?this.#o.#s.length:0}get hasMagic(){if(this.#e!==void 0)return this.#e;for(let i of this.#s)if(typeof i!="string"&&(i.type||i.hasMagic))return this.#e=!0;return this.#e}toString(){return this.#a!==void 0?this.#a:this.type?this.#a=this.type+"("+this.#s.map(i=>String(i)).join("|")+")":this.#a=this.#s.map(i=>String(i)).join("")}#m(){if(this!==this.#t)throw new Error("should only call on root");if(this.#u)return this;this.toString(),this.#u=!0;let i;for(;i=this.#c.pop();){if(i.type!=="!")continue;let s=i,h=s.#o;for(;h;){for(let c=s.#v+1;!h.type&&c<h.#s.length;c++)for(let _ of i.#s){if(typeof _=="string")throw new Error("string part in extglob AST??");_.copyIn(h.#s[c])}s=h,h=s.#o}}return this}push(...i){for(let s of i)if(s!==""){if(typeof s!="string"&&!(s instanceof o&&s.#o===this))throw new Error("invalid part: "+s);this.#s.push(s)}}toJSON(){let i=this.type===null?this.#s.slice().map(s=>typeof s=="string"?s:s.toJSON()):[this.type,...this.#s.map(s=>s.toJSON())];return this.isStart()&&!this.type&&i.unshift([]),this.isEnd()&&(this===this.#t||this.#t.#u&&this.#o?.type==="!")&&i.push({}),i}isStart(){if(this.#t===this)return!0;if(!this.#o?.isStart())return!1;if(this.#v===0)return!0;let i=this.#o;for(let s=0;s<this.#v;s++){let h=i.#s[s];if(!(h instanceof o&&h.type==="!"))return!1}return!0}isEnd(){if(this.#t===this||this.#o?.type==="!")return!0;if(!this.#o?.isEnd())return!1;if(!this.type)return this.#o?.isEnd();let i=this.#o?this.#o.#s.length:0;return this.#v===i-1}copyIn(i){typeof i=="string"?this.push(i):this.push(i.clone(this))}clone(i){let s=new o(this.type,i);for(let h of this.#s)s.copyIn(h);return s}static#g(i,s,h,c){let _=!1,l=!1,f=-1,u=!1;if(s.type===null){let x=h,A="";for(;x<i.length;){let D=i.charAt(x++);if(_||D==="\\"){_=!_,A+=D;continue}if(l){x===f+1?(D==="^"||D==="!")&&(u=!0):D==="]"&&!(x===f+2&&u)&&(l=!1),A+=D;continue}else if(D==="["){l=!0,f=x,u=!1,A+=D;continue}if(!c.noext&&Wn(D)&&i.charAt(x)==="("){s.push(A),A="";let O=new o(D,s);x=o.#g(i,O,x,c),s.push(O);continue}A+=D}return s.push(A),x}let w=h+1,v=new o(null,s),k=[],S="";for(;w<i.length;){let x=i.charAt(w++);if(_||x==="\\"){_=!_,S+=x;continue}if(l){w===f+1?(x==="^"||x==="!")&&(u=!0):x==="]"&&!(w===f+2&&u)&&(l=!1),S+=x;continue}else if(x==="["){l=!0,f=w,u=!1,S+=x;continue}if(Wn(x)&&i.charAt(w)==="("){v.push(S),S="";let A=new o(x,v);v.push(A),w=o.#g(i,A,w,c);continue}if(x==="|"){v.push(S),S="",k.push(v),v=new o(null,s);continue}if(x===")")return S===""&&s.#s.length===0&&(s.#r=!0),v.push(S),S="",s.push(...k,v),w;S+=x}return s.type=null,s.#e=void 0,s.#s=[i.substring(h-1)],w}static fromGlob(i,s={}){let h=new o(null,void 0,s);return o.#g(i,h,0,s),h}toMMPattern(){if(this!==this.#t)return this.#t.toMMPattern();let i=this.toString(),[s,h,c,_]=this.toRegExpSource();if(!(c||this.#e||this.#h.nocase&&!this.#h.nocaseMagicOnly&&i.toUpperCase()!==i.toLowerCase()))return h;let f=(this.#h.nocase?"i":"")+(_?"u":"");return Object.assign(new RegExp(`^${s}$`,f),{_src:s,_glob:i})}get options(){return this.#h}toRegExpSource(i){let s=i??!!this.#h.dot;if(this.#t===this&&this.#m(),!this.type){let u=this.isStart()&&this.isEnd(),w=this.#s.map(x=>{let[A,D,O,I]=typeof x=="string"?o.#d(x,this.#e,u):x.toRegExpSource(i);return this.#e=this.#e||O,this.#n=this.#n||I,A}).join(""),v="";if(this.isStart()&&typeof this.#s[0]=="string"&&!(this.#s.length===1&&Vc.has(this.#s[0]))){let A=Yc,D=s&&A.has(w.charAt(0))||w.startsWith("\\.")&&A.has(w.charAt(2))||w.startsWith("\\.\\.")&&A.has(w.charAt(4)),O=!s&&!i&&A.has(w.charAt(0));v=D?Kc:O?Zi:""}let k="";return this.isEnd()&&this.#t.#u&&this.#o?.type==="!"&&(k="(?:$|\\/)"),[v+w+k,ie(w),this.#e=!!this.#e,this.#n]}let h=this.type==="*"||this.type==="+",c=this.type==="!"?"(?:(?!(?:":"(?:",_=this.#l(s);if(this.isStart()&&this.isEnd()&&!_&&this.type!=="!"){let u=this.toString();return this.#s=[u],this.type=null,this.#e=void 0,[u,ie(this.toString()),!1,!1]}let l=!h||i||s||!Zi?"":this.#l(!0);l===_&&(l=""),l&&(_=`(?:${_})(?:${l})*?`);let f="";if(this.type==="!"&&this.#r)f=(this.isStart()&&!s?Zi:"")+$n;else{let u=this.type==="!"?"))"+(this.isStart()&&!s&&!i?Zi:"")+Gn+")":this.type==="@"?")":this.type==="?"?")?":this.type==="+"&&l?")":this.type==="*"&&l?")?":`)${this.type}`;f=c+_+u}return[f,ie(_),this.#e=!!this.#e,this.#n]}#l(i){return this.#s.map(s=>{if(typeof s=="string")throw new Error("string type in extglob ast??");let[h,c,_,l]=s.toRegExpSource(i);return this.#n=this.#n||l,h}).filter(s=>!(this.isStart()&&this.isEnd())||!!s).join("|")}static#d(i,s,h=!1){let c=!1,_="",l=!1;for(let f=0;f<i.length;f++){let u=i.charAt(f);if(c){c=!1,_+=(Jc.has(u)?"\\":"")+u;continue}if(u==="\\"){f===i.length-1?_+="\\\\":c=!0;continue}if(u==="["){let[w,v,k,S]=jn(i,f);if(k){_+=w,l=l||v,f+=k-1,s=s||S;continue}}if(u==="*"){h&&i==="*"?_+=$n:_+=Gn,s=!0;continue}if(u==="?"){_+=tr,s=!0;continue}_+=Xc(u)}return[_,ie(i),!!s,l]}};T();var He=(o,{windowsPathsNoEscape:i=!1}={})=>i?o.replace(/[?*()[\]]/g,"[$&]"):o.replace(/[?*()[\]\\]/g,"\\$&");var Lt=(o,i,s={})=>(pi(i),!s.nocomment&&i.charAt(0)==="#"?!1:new Kt(i,s).match(o)),Qc=/^\*+([^+@!?\*\[\(]*)$/,Zc=o=>i=>!i.startsWith(".")&&i.endsWith(o),t_=o=>i=>i.endsWith(o),e_=o=>(o=o.toLowerCase(),i=>!i.startsWith(".")&&i.toLowerCase().endsWith(o)),i_=o=>(o=o.toLowerCase(),i=>i.toLowerCase().endsWith(o)),s_=/^\*+\.\*+$/,r_=o=>!o.startsWith(".")&&o.includes("."),n_=o=>o!=="."&&o!==".."&&o.includes("."),o_=/^\.\*+$/,h_=o=>o!=="."&&o!==".."&&o.startsWith("."),a_=/^\*+$/,c_=o=>o.length!==0&&!o.startsWith("."),__=o=>o.length!==0&&o!=="."&&o!=="..",u_=/^\?+([^+@!?\*\[\(]*)?$/,d_=([o,i=""])=>{let s=Vn([o]);return i?(i=i.toLowerCase(),h=>s(h)&&h.toLowerCase().endsWith(i)):s},l_=([o,i=""])=>{let s=Jn([o]);return i?(i=i.toLowerCase(),h=>s(h)&&h.toLowerCase().endsWith(i)):s},p_=([o,i=""])=>{let s=Jn([o]);return i?h=>s(h)&&h.endsWith(i):s},f_=([o,i=""])=>{let s=Vn([o]);return i?h=>s(h)&&h.endsWith(i):s},Vn=([o])=>{let i=o.length;return s=>s.length===i&&!s.startsWith(".")},Jn=([o])=>{let i=o.length;return s=>s.length===i&&s!=="."&&s!==".."},Xn=typeof process=="object"&&process?typeof process.env=="object"&&process.env&&process.env.__MINIMATCH_TESTING_PLATFORM__||process.platform:"posix",Hn={win32:{sep:"\\"},posix:{sep:"/"}},m_=Xn==="win32"?Hn.win32.sep:Hn.posix.sep;Lt.sep=m_;var Tt=Symbol("globstar **");Lt.GLOBSTAR=Tt;var g_="[^/]",y_=g_+"*?",w_="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",v_="(?:(?!(?:\\/|^)\\.).)*?",b_=(o,i={})=>s=>Lt(s,o,i);Lt.filter=b_;var Vt=(o,i={})=>Object.assign({},o,i),k_=o=>{if(!o||typeof o!="object"||!Object.keys(o).length)return Lt;let i=Lt;return Object.assign((h,c,_={})=>i(h,c,Vt(o,_)),{Minimatch:class extends i.Minimatch{constructor(c,_={}){super(c,Vt(o,_))}static defaults(c){return i.defaults(Vt(o,c)).Minimatch}},AST:class extends i.AST{constructor(c,_,l={}){super(c,_,Vt(o,l))}static fromGlob(c,_={}){return i.AST.fromGlob(c,Vt(o,_))}},unescape:(h,c={})=>i.unescape(h,Vt(o,c)),escape:(h,c={})=>i.escape(h,Vt(o,c)),filter:(h,c={})=>i.filter(h,Vt(o,c)),defaults:h=>i.defaults(Vt(o,h)),makeRe:(h,c={})=>i.makeRe(h,Vt(o,c)),braceExpand:(h,c={})=>i.braceExpand(h,Vt(o,c)),match:(h,c,_={})=>i.match(h,c,Vt(o,_)),sep:i.sep,GLOBSTAR:Tt})};Lt.defaults=k_;var Qn=(o,i={})=>(pi(o),i.nobrace||!/\{(?:(?!\{).)*\}/.test(o)?[o]:(0,Yn.default)(o));Lt.braceExpand=Qn;var x_=(o,i={})=>new Kt(o,i).makeRe();Lt.makeRe=x_;var S_=(o,i,s={})=>{let h=new Kt(i,s);return o=o.filter(c=>h.match(c)),h.options.nonull&&!o.length&&o.push(i),o};Lt.match=S_;var Kn=/[?*]|[+@!]\(.*?\)|\[|\]/,E_=o=>o.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),Kt=class{options;set;pattern;windowsPathsNoEscape;nonegate;negate;comment;empty;preserveMultipleSlashes;partial;globSet;globParts;nocase;isWindows;platform;windowsNoMagicRoot;regexp;constructor(i,s={}){pi(i),s=s||{},this.options=s,this.pattern=i,this.platform=s.platform||Xn,this.isWindows=this.platform==="win32",this.windowsPathsNoEscape=!!s.windowsPathsNoEscape||s.allowWindowsEscape===!1,this.windowsPathsNoEscape&&(this.pattern=this.pattern.replace(/\\/g,"/")),this.preserveMultipleSlashes=!!s.preserveMultipleSlashes,this.regexp=null,this.negate=!1,this.nonegate=!!s.nonegate,this.comment=!1,this.empty=!1,this.partial=!!s.partial,this.nocase=!!this.options.nocase,this.windowsNoMagicRoot=s.windowsNoMagicRoot!==void 0?s.windowsNoMagicRoot:!!(this.isWindows&&this.nocase),this.globSet=[],this.globParts=[],this.set=[],this.make()}hasMagic(){if(this.options.magicalBraces&&this.set.length>1)return!0;for(let i of this.set)for(let s of i)if(typeof s!="string")return!0;return!1}debug(...i){}make(){let i=this.pattern,s=this.options;if(!s.nocomment&&i.charAt(0)==="#"){this.comment=!0;return}if(!i){this.empty=!0;return}this.parseNegate(),this.globSet=[...new Set(this.braceExpand())],s.debug&&(this.debug=(..._)=>console.error(..._)),this.debug(this.pattern,this.globSet);let h=this.globSet.map(_=>this.slashSplit(_));this.globParts=this.preprocess(h),this.debug(this.pattern,this.globParts);let c=this.globParts.map((_,l,f)=>{if(this.isWindows&&this.windowsNoMagicRoot){let u=_[0]===""&&_[1]===""&&(_[2]==="?"||!Kn.test(_[2]))&&!Kn.test(_[3]),w=/^[a-z]:/i.test(_[0]);if(u)return[..._.slice(0,4),..._.slice(4).map(v=>this.parse(v))];if(w)return[_[0],..._.slice(1).map(v=>this.parse(v))]}return _.map(u=>this.parse(u))});if(this.debug(this.pattern,c),this.set=c.filter(_=>_.indexOf(!1)===-1),this.isWindows)for(let _=0;_<this.set.length;_++){let l=this.set[_];l[0]===""&&l[1]===""&&this.globParts[_][2]==="?"&&typeof l[3]=="string"&&/^[a-z]:$/i.test(l[3])&&(l[2]="?")}this.debug(this.pattern,this.set)}preprocess(i){if(this.options.noglobstar)for(let h=0;h<i.length;h++)for(let c=0;c<i[h].length;c++)i[h][c]==="**"&&(i[h][c]="*");let{optimizationLevel:s=1}=this.options;return s>=2?(i=this.firstPhasePreProcess(i),i=this.secondPhasePreProcess(i)):s>=1?i=this.levelOneOptimize(i):i=this.adjascentGlobstarOptimize(i),i}adjascentGlobstarOptimize(i){return i.map(s=>{let h=-1;for(;(h=s.indexOf("**",h+1))!==-1;){let c=h;for(;s[c+1]==="**";)c++;c!==h&&s.splice(h,c-h)}return s})}levelOneOptimize(i){return i.map(s=>(s=s.reduce((h,c)=>{let _=h[h.length-1];return c==="**"&&_==="**"?h:c===".."&&_&&_!==".."&&_!=="."&&_!=="**"?(h.pop(),h):(h.push(c),h)},[]),s.length===0?[""]:s))}levelTwoFileOptimize(i){Array.isArray(i)||(i=this.slashSplit(i));let s=!1;do{if(s=!1,!this.preserveMultipleSlashes){for(let c=1;c<i.length-1;c++){let _=i[c];c===1&&_===""&&i[0]===""||(_==="."||_==="")&&(s=!0,i.splice(c,1),c--)}i[0]==="."&&i.length===2&&(i[1]==="."||i[1]==="")&&(s=!0,i.pop())}let h=0;for(;(h=i.indexOf("..",h+1))!==-1;){let c=i[h-1];c&&c!=="."&&c!==".."&&c!=="**"&&(s=!0,i.splice(h-1,2),h-=2)}}while(s);return i.length===0?[""]:i}firstPhasePreProcess(i){let s=!1;do{s=!1;for(let h of i){let c=-1;for(;(c=h.indexOf("**",c+1))!==-1;){let l=c;for(;h[l+1]==="**";)l++;l>c&&h.splice(c+1,l-c);let f=h[c+1],u=h[c+2],w=h[c+3];if(f!==".."||!u||u==="."||u===".."||!w||w==="."||w==="..")continue;s=!0,h.splice(c,1);let v=h.slice(0);v[c]="**",i.push(v),c--}if(!this.preserveMultipleSlashes){for(let l=1;l<h.length-1;l++){let f=h[l];l===1&&f===""&&h[0]===""||(f==="."||f==="")&&(s=!0,h.splice(l,1),l--)}h[0]==="."&&h.length===2&&(h[1]==="."||h[1]==="")&&(s=!0,h.pop())}let _=0;for(;(_=h.indexOf("..",_+1))!==-1;){let l=h[_-1];if(l&&l!=="."&&l!==".."&&l!=="**"){s=!0;let u=_===1&&h[_+1]==="**"?["."]:[];h.splice(_-1,2,...u),h.length===0&&h.push(""),_-=2}}}}while(s);return i}secondPhasePreProcess(i){for(let s=0;s<i.length-1;s++)for(let h=s+1;h<i.length;h++){let c=this.partsMatch(i[s],i[h],!this.preserveMultipleSlashes);if(c){i[s]=[],i[h]=c;break}}return i.filter(s=>s.length)}partsMatch(i,s,h=!1){let c=0,_=0,l=[],f="";for(;c<i.length&&_<s.length;)if(i[c]===s[_])l.push(f==="b"?s[_]:i[c]),c++,_++;else if(h&&i[c]==="**"&&s[_]===i[c+1])l.push(i[c]),c++;else if(h&&s[_]==="**"&&i[c]===s[_+1])l.push(s[_]),_++;else if(i[c]==="*"&&s[_]&&(this.options.dot||!s[_].startsWith("."))&&s[_]!=="**"){if(f==="b")return!1;f="a",l.push(i[c]),c++,_++}else if(s[_]==="*"&&i[c]&&(this.options.dot||!i[c].startsWith("."))&&i[c]!=="**"){if(f==="a")return!1;f="b",l.push(s[_]),c++,_++}else return!1;return i.length===s.length&&l}parseNegate(){if(this.nonegate)return;let i=this.pattern,s=!1,h=0;for(let c=0;c<i.length&&i.charAt(c)==="!";c++)s=!s,h++;h&&(this.pattern=i.slice(h)),this.negate=s}matchOne(i,s,h=!1){let c=this.options;if(this.isWindows){let D=typeof i[0]=="string"&&/^[a-z]:$/i.test(i[0]),O=!D&&i[0]===""&&i[1]===""&&i[2]==="?"&&/^[a-z]:$/i.test(i[3]),I=typeof s[0]=="string"&&/^[a-z]:$/i.test(s[0]),B=!I&&s[0]===""&&s[1]===""&&s[2]==="?"&&typeof s[3]=="string"&&/^[a-z]:$/i.test(s[3]),G=O?3:D?0:void 0,Y=B?3:I?0:void 0;if(typeof G=="number"&&typeof Y=="number"){let[q,tt]=[i[G],s[Y]];q.toLowerCase()===tt.toLowerCase()&&(s[Y]=q,Y>G?s=s.slice(Y):G>Y&&(i=i.slice(G)))}}let{optimizationLevel:_=1}=this.options;_>=2&&(i=this.levelTwoFileOptimize(i)),this.debug("matchOne",this,{file:i,pattern:s}),this.debug("matchOne",i.length,s.length);for(var l=0,f=0,u=i.length,w=s.length;l<u&&f<w;l++,f++){this.debug("matchOne loop");var v=s[f],k=i[l];if(this.debug(s,v,k),v===!1)return!1;if(v===Tt){this.debug("GLOBSTAR",[s,v,k]);var S=l,x=f+1;if(x===w){for(this.debug("** at the end");l<u;l++)if(i[l]==="."||i[l]===".."||!c.dot&&i[l].charAt(0)===".")return!1;return!0}for(;S<u;){var A=i[S];if(this.debug(`
globstar while`,i,S,s,x,A),this.matchOne(i.slice(S),s.slice(x),h))return this.debug("globstar found match!",S,u,A),!0;if(A==="."||A===".."||!c.dot&&A.charAt(0)==="."){this.debug("dot detected!",i,S,s,x);break}this.debug("globstar swallow a segment, and continue"),S++}return!!(h&&(this.debug(`
>>> no match, partial?`,i,S,s,x),S===u))}let D;if(typeof v=="string"?(D=k===v,this.debug("string match",v,k,D)):(D=v.test(k),this.debug("pattern match",v,k,D)),!D)return!1}if(l===u&&f===w)return!0;if(l===u)return h;if(f===w)return l===u-1&&i[l]==="";throw new Error("wtf?")}braceExpand(){return Qn(this.pattern,this.options)}parse(i){pi(i);let s=this.options;if(i==="**")return Tt;if(i==="")return"";let h,c=null;(h=i.match(a_))?c=s.dot?__:c_:(h=i.match(Qc))?c=(s.nocase?s.dot?i_:e_:s.dot?t_:Zc)(h[1]):(h=i.match(u_))?c=(s.nocase?s.dot?l_:d_:s.dot?p_:f_)(h):(h=i.match(s_))?c=s.dot?n_:r_:(h=i.match(o_))&&(c=h_);let _=$e.fromGlob(i,this.options).toMMPattern();return c&&typeof _=="object"&&Reflect.defineProperty(_,"test",{value:c}),_}makeRe(){if(this.regexp||this.regexp===!1)return this.regexp;let i=this.set;if(!i.length)return this.regexp=!1,this.regexp;let s=this.options,h=s.noglobstar?y_:s.dot?w_:v_,c=new Set(s.nocase?["i"]:[]),_=i.map(u=>{let w=u.map(v=>{if(v instanceof RegExp)for(let k of v.flags.split(""))c.add(k);return typeof v=="string"?E_(v):v===Tt?Tt:v._src});return w.forEach((v,k)=>{let S=w[k+1],x=w[k-1];v!==Tt||x===Tt||(x===void 0?S!==void 0&&S!==Tt?w[k+1]="(?:\\/|"+h+"\\/)?"+S:w[k]=h:S===void 0?w[k-1]=x+"(?:\\/|"+h+")?":S!==Tt&&(w[k-1]=x+"(?:\\/|\\/"+h+"\\/)"+S,w[k+1]=Tt))}),w.filter(v=>v!==Tt).join("/")}).join("|"),[l,f]=i.length>1?["(?:",")"]:["",""];_="^"+l+_+f+"$",this.negate&&(_="^(?!"+_+").+$");try{this.regexp=new RegExp(_,[...c].join(""))}catch{this.regexp=!1}return this.regexp}slashSplit(i){return this.preserveMultipleSlashes?i.split("/"):this.isWindows&&/^\/\/[^\/]+/.test(i)?["",...i.split(/\/+/)]:i.split(/\/+/)}match(i,s=this.partial){if(this.debug("match",i,this.pattern),this.comment)return!1;if(this.empty)return i==="";if(i==="/"&&s)return!0;let h=this.options;this.isWindows&&(i=i.split("\\").join("/"));let c=this.slashSplit(i);this.debug(this.pattern,"split",c);let _=this.set;this.debug(this.pattern,"set",_);let l=c[c.length-1];if(!l)for(let f=c.length-2;!l&&f>=0;f--)l=c[f];for(let f=0;f<_.length;f++){let u=_[f],w=c;if(h.matchBase&&u.length===1&&(w=[l]),this.matchOne(w,u,s))return h.flipNegate?!0:!this.negate}return h.flipNegate?!1:this.negate}static defaults(i){return Lt.defaults(i).Minimatch}};Lt.AST=$e;Lt.Minimatch=Kt;Lt.escape=He;Lt.unescape=ie;T();import{fileURLToPath as su}from"node:url";T();T();var Ke=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,to=new Set,er=typeof process=="object"&&process?process:{},eo=(o,i,s,h)=>{typeof er.emitWarning=="function"?er.emitWarning(o,i,s,h):console.error(`[${s}] ${i}: ${o}`)},ts=globalThis.AbortController,Zn=globalThis.AbortSignal;if(typeof ts>"u"){Zn=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(h,c){this._onabort.push(c)}},ts=class{constructor(){i()}signal=new Zn;abort(h){if(!this.signal.aborted){this.signal.reason=h,this.signal.aborted=!0;for(let c of this.signal._onabort)c(h);this.signal.onabort?.(h)}}};let o=er.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",i=()=>{o&&(o=!1,eo("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",i))}}var A_=o=>!to.has(o),kf=Symbol("type"),Te=o=>o&&o===Math.floor(o)&&o>0&&isFinite(o),io=o=>Te(o)?o<=Math.pow(2,8)?Uint8Array:o<=Math.pow(2,16)?Uint16Array:o<=Math.pow(2,32)?Uint32Array:o<=Number.MAX_SAFE_INTEGER?Ye:null:null,Ye=class extends Array{constructor(i){super(i),this.fill(0)}},ir=class o{heap;length;static#t=!1;static create(i){let s=io(i);if(!s)return[];o.#t=!0;let h=new o(i,s);return o.#t=!1,h}constructor(i,s){if(!o.#t)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new s(i),this.length=0}push(i){this.heap[this.length++]=i}pop(){return this.heap[--this.length]}},mi=class o{#t;#e;#n;#s;#o;#v;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#c;#u;#h;#a;#r;#m;#g;#l;#d;#x;#f;#S;#E;#w;#b;#k;#p;static unsafeExposeInternals(i){return{starts:i.#E,ttls:i.#w,sizes:i.#S,keyMap:i.#h,keyList:i.#a,valList:i.#r,next:i.#m,prev:i.#g,get head(){return i.#l},get tail(){return i.#d},free:i.#x,isBackgroundFetch:s=>i.#_(s),backgroundFetch:(s,h,c,_)=>i.#N(s,h,c,_),moveToTail:s=>i.#U(s),indexes:s=>i.#C(s),rindexes:s=>i.#T(s),isStale:s=>i.#y(s)}}get max(){return this.#t}get maxSize(){return this.#e}get calculatedSize(){return this.#u}get size(){return this.#c}get fetchMethod(){return this.#o}get memoMethod(){return this.#v}get dispose(){return this.#n}get disposeAfter(){return this.#s}constructor(i){let{max:s=0,ttl:h,ttlResolution:c=1,ttlAutopurge:_,updateAgeOnGet:l,updateAgeOnHas:f,allowStale:u,dispose:w,disposeAfter:v,noDisposeOnSet:k,noUpdateTTL:S,maxSize:x=0,maxEntrySize:A=0,sizeCalculation:D,fetchMethod:O,memoMethod:I,noDeleteOnFetchRejection:B,noDeleteOnStaleGet:G,allowStaleOnFetchRejection:Y,allowStaleOnFetchAbort:q,ignoreFetchAbort:tt}=i;if(s!==0&&!Te(s))throw new TypeError("max option must be a nonnegative integer");let ot=s?io(s):Array;if(!ot)throw new Error("invalid max value: "+s);if(this.#t=s,this.#e=x,this.maxEntrySize=A||this.#e,this.sizeCalculation=D,this.sizeCalculation){if(!this.#e&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(I!==void 0&&typeof I!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#v=I,O!==void 0&&typeof O!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#o=O,this.#k=!!O,this.#h=new Map,this.#a=new Array(s).fill(void 0),this.#r=new Array(s).fill(void 0),this.#m=new ot(s),this.#g=new ot(s),this.#l=0,this.#d=0,this.#x=ir.create(s),this.#c=0,this.#u=0,typeof w=="function"&&(this.#n=w),typeof v=="function"?(this.#s=v,this.#f=[]):(this.#s=void 0,this.#f=void 0),this.#b=!!this.#n,this.#p=!!this.#s,this.noDisposeOnSet=!!k,this.noUpdateTTL=!!S,this.noDeleteOnFetchRejection=!!B,this.allowStaleOnFetchRejection=!!Y,this.allowStaleOnFetchAbort=!!q,this.ignoreFetchAbort=!!tt,this.maxEntrySize!==0){if(this.#e!==0&&!Te(this.#e))throw new TypeError("maxSize must be a positive integer if specified");if(!Te(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#I()}if(this.allowStale=!!u,this.noDeleteOnStaleGet=!!G,this.updateAgeOnGet=!!l,this.updateAgeOnHas=!!f,this.ttlResolution=Te(c)||c===0?c:1,this.ttlAutopurge=!!_,this.ttl=h||0,this.ttl){if(!Te(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#D()}if(this.#t===0&&this.ttl===0&&this.#e===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#t&&!this.#e){let at="LRU_CACHE_UNBOUNDED";A_(at)&&(to.add(at),eo("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",at,o))}}getRemainingTTL(i){return this.#h.has(i)?1/0:0}#D(){let i=new Ye(this.#t),s=new Ye(this.#t);this.#w=i,this.#E=s,this.#O=(_,l,f=Ke.now())=>{if(s[_]=l!==0?f:0,i[_]=l,l!==0&&this.ttlAutopurge){let u=setTimeout(()=>{this.#y(_)&&this.#R(this.#a[_],"expire")},l+1);u.unref&&u.unref()}},this.#A=_=>{s[_]=i[_]!==0?Ke.now():0},this.#i=(_,l)=>{if(i[l]){let f=i[l],u=s[l];if(!f||!u)return;_.ttl=f,_.start=u,_.now=h||c();let w=_.now-u;_.remainingTTL=f-w}};let h=0,c=()=>{let _=Ke.now();if(this.ttlResolution>0){h=_;let l=setTimeout(()=>h=0,this.ttlResolution);l.unref&&l.unref()}return _};this.getRemainingTTL=_=>{let l=this.#h.get(_);if(l===void 0)return 0;let f=i[l],u=s[l];if(!f||!u)return 1/0;let w=(h||c())-u;return f-w},this.#y=_=>{let l=s[_],f=i[_];return!!f&&!!l&&(h||c())-l>f}}#A=()=>{};#i=()=>{};#O=()=>{};#y=()=>!1;#I(){let i=new Ye(this.#t);this.#u=0,this.#S=i,this.#P=s=>{this.#u-=i[s],i[s]=0},this.#q=(s,h,c,_)=>{if(this.#_(h))return 0;if(!Te(c))if(_){if(typeof _!="function")throw new TypeError("sizeCalculation must be a function");if(c=_(h,s),!Te(c))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return c},this.#M=(s,h,c)=>{if(i[s]=h,this.#e){let _=this.#e-i[s];for(;this.#u>_;)this.#L(!0)}this.#u+=i[s],c&&(c.entrySize=h,c.totalCalculatedSize=this.#u)}}#P=i=>{};#M=(i,s,h)=>{};#q=(i,s,h,c)=>{if(h||c)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#C({allowStale:i=this.allowStale}={}){if(this.#c)for(let s=this.#d;!(!this.#F(s)||((i||!this.#y(s))&&(yield s),s===this.#l));)s=this.#g[s]}*#T({allowStale:i=this.allowStale}={}){if(this.#c)for(let s=this.#l;!(!this.#F(s)||((i||!this.#y(s))&&(yield s),s===this.#d));)s=this.#m[s]}#F(i){return i!==void 0&&this.#h.get(this.#a[i])===i}*entries(){for(let i of this.#C())this.#r[i]!==void 0&&this.#a[i]!==void 0&&!this.#_(this.#r[i])&&(yield[this.#a[i],this.#r[i]])}*rentries(){for(let i of this.#T())this.#r[i]!==void 0&&this.#a[i]!==void 0&&!this.#_(this.#r[i])&&(yield[this.#a[i],this.#r[i]])}*keys(){for(let i of this.#C()){let s=this.#a[i];s!==void 0&&!this.#_(this.#r[i])&&(yield s)}}*rkeys(){for(let i of this.#T()){let s=this.#a[i];s!==void 0&&!this.#_(this.#r[i])&&(yield s)}}*values(){for(let i of this.#C())this.#r[i]!==void 0&&!this.#_(this.#r[i])&&(yield this.#r[i])}*rvalues(){for(let i of this.#T())this.#r[i]!==void 0&&!this.#_(this.#r[i])&&(yield this.#r[i])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(i,s={}){for(let h of this.#C()){let c=this.#r[h],_=this.#_(c)?c.__staleWhileFetching:c;if(_!==void 0&&i(_,this.#a[h],this))return this.get(this.#a[h],s)}}forEach(i,s=this){for(let h of this.#C()){let c=this.#r[h],_=this.#_(c)?c.__staleWhileFetching:c;_!==void 0&&i.call(s,_,this.#a[h],this)}}rforEach(i,s=this){for(let h of this.#T()){let c=this.#r[h],_=this.#_(c)?c.__staleWhileFetching:c;_!==void 0&&i.call(s,_,this.#a[h],this)}}purgeStale(){let i=!1;for(let s of this.#T({allowStale:!0}))this.#y(s)&&(this.#R(this.#a[s],"expire"),i=!0);return i}info(i){let s=this.#h.get(i);if(s===void 0)return;let h=this.#r[s],c=this.#_(h)?h.__staleWhileFetching:h;if(c===void 0)return;let _={value:c};if(this.#w&&this.#E){let l=this.#w[s],f=this.#E[s];if(l&&f){let u=l-(Ke.now()-f);_.ttl=u,_.start=Date.now()}}return this.#S&&(_.size=this.#S[s]),_}dump(){let i=[];for(let s of this.#C({allowStale:!0})){let h=this.#a[s],c=this.#r[s],_=this.#_(c)?c.__staleWhileFetching:c;if(_===void 0||h===void 0)continue;let l={value:_};if(this.#w&&this.#E){l.ttl=this.#w[s];let f=Ke.now()-this.#E[s];l.start=Math.floor(Date.now()-f)}this.#S&&(l.size=this.#S[s]),i.unshift([h,l])}return i}load(i){this.clear();for(let[s,h]of i){if(h.start){let c=Date.now()-h.start;h.start=Ke.now()-c}this.set(s,h.value,h)}}set(i,s,h={}){if(s===void 0)return this.delete(i),this;let{ttl:c=this.ttl,start:_,noDisposeOnSet:l=this.noDisposeOnSet,sizeCalculation:f=this.sizeCalculation,status:u}=h,{noUpdateTTL:w=this.noUpdateTTL}=h,v=this.#q(i,s,h.size||0,f);if(this.maxEntrySize&&v>this.maxEntrySize)return u&&(u.set="miss",u.maxEntrySizeExceeded=!0),this.#R(i,"set"),this;let k=this.#c===0?void 0:this.#h.get(i);if(k===void 0)k=this.#c===0?this.#d:this.#x.length!==0?this.#x.pop():this.#c===this.#t?this.#L(!1):this.#c,this.#a[k]=i,this.#r[k]=s,this.#h.set(i,k),this.#m[this.#d]=k,this.#g[k]=this.#d,this.#d=k,this.#c++,this.#M(k,v,u),u&&(u.set="add"),w=!1;else{this.#U(k);let S=this.#r[k];if(s!==S){if(this.#k&&this.#_(S)){S.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:x}=S;x!==void 0&&!l&&(this.#b&&this.#n?.(x,i,"set"),this.#p&&this.#f?.push([x,i,"set"]))}else l||(this.#b&&this.#n?.(S,i,"set"),this.#p&&this.#f?.push([S,i,"set"]));if(this.#P(k),this.#M(k,v,u),this.#r[k]=s,u){u.set="replace";let x=S&&this.#_(S)?S.__staleWhileFetching:S;x!==void 0&&(u.oldValue=x)}}else u&&(u.set="update")}if(c!==0&&!this.#w&&this.#D(),this.#w&&(w||this.#O(k,c,_),u&&this.#i(u,k)),!l&&this.#p&&this.#f){let S=this.#f,x;for(;x=S?.shift();)this.#s?.(...x)}return this}pop(){try{for(;this.#c;){let i=this.#r[this.#l];if(this.#L(!0),this.#_(i)){if(i.__staleWhileFetching)return i.__staleWhileFetching}else if(i!==void 0)return i}}finally{if(this.#p&&this.#f){let i=this.#f,s;for(;s=i?.shift();)this.#s?.(...s)}}}#L(i){let s=this.#l,h=this.#a[s],c=this.#r[s];return this.#k&&this.#_(c)?c.__abortController.abort(new Error("evicted")):(this.#b||this.#p)&&(this.#b&&this.#n?.(c,h,"evict"),this.#p&&this.#f?.push([c,h,"evict"])),this.#P(s),i&&(this.#a[s]=void 0,this.#r[s]=void 0,this.#x.push(s)),this.#c===1?(this.#l=this.#d=0,this.#x.length=0):this.#l=this.#m[s],this.#h.delete(h),this.#c--,s}has(i,s={}){let{updateAgeOnHas:h=this.updateAgeOnHas,status:c}=s,_=this.#h.get(i);if(_!==void 0){let l=this.#r[_];if(this.#_(l)&&l.__staleWhileFetching===void 0)return!1;if(this.#y(_))c&&(c.has="stale",this.#i(c,_));else return h&&this.#A(_),c&&(c.has="hit",this.#i(c,_)),!0}else c&&(c.has="miss");return!1}peek(i,s={}){let{allowStale:h=this.allowStale}=s,c=this.#h.get(i);if(c===void 0||!h&&this.#y(c))return;let _=this.#r[c];return this.#_(_)?_.__staleWhileFetching:_}#N(i,s,h,c){let _=s===void 0?void 0:this.#r[s];if(this.#_(_))return _;let l=new ts,{signal:f}=h;f?.addEventListener("abort",()=>l.abort(f.reason),{signal:l.signal});let u={signal:l.signal,options:h,context:c},w=(D,O=!1)=>{let{aborted:I}=l.signal,B=h.ignoreFetchAbort&&D!==void 0;if(h.status&&(I&&!O?(h.status.fetchAborted=!0,h.status.fetchError=l.signal.reason,B&&(h.status.fetchAbortIgnored=!0)):h.status.fetchResolved=!0),I&&!B&&!O)return k(l.signal.reason);let G=x;return this.#r[s]===x&&(D===void 0?G.__staleWhileFetching?this.#r[s]=G.__staleWhileFetching:this.#R(i,"fetch"):(h.status&&(h.status.fetchUpdated=!0),this.set(i,D,u.options))),D},v=D=>(h.status&&(h.status.fetchRejected=!0,h.status.fetchError=D),k(D)),k=D=>{let{aborted:O}=l.signal,I=O&&h.allowStaleOnFetchAbort,B=I||h.allowStaleOnFetchRejection,G=B||h.noDeleteOnFetchRejection,Y=x;if(this.#r[s]===x&&(!G||Y.__staleWhileFetching===void 0?this.#R(i,"fetch"):I||(this.#r[s]=Y.__staleWhileFetching)),B)return h.status&&Y.__staleWhileFetching!==void 0&&(h.status.returnedStale=!0),Y.__staleWhileFetching;if(Y.__returned===Y)throw D},S=(D,O)=>{let I=this.#o?.(i,_,u);I&&I instanceof Promise&&I.then(B=>D(B===void 0?void 0:B),O),l.signal.addEventListener("abort",()=>{(!h.ignoreFetchAbort||h.allowStaleOnFetchAbort)&&(D(void 0),h.allowStaleOnFetchAbort&&(D=B=>w(B,!0)))})};h.status&&(h.status.fetchDispatched=!0);let x=new Promise(S).then(w,v),A=Object.assign(x,{__abortController:l,__staleWhileFetching:_,__returned:void 0});return s===void 0?(this.set(i,A,{...u.options,status:void 0}),s=this.#h.get(i)):this.#r[s]=A,A}#_(i){if(!this.#k)return!1;let s=i;return!!s&&s instanceof Promise&&s.hasOwnProperty("__staleWhileFetching")&&s.__abortController instanceof ts}async fetch(i,s={}){let{allowStale:h=this.allowStale,updateAgeOnGet:c=this.updateAgeOnGet,noDeleteOnStaleGet:_=this.noDeleteOnStaleGet,ttl:l=this.ttl,noDisposeOnSet:f=this.noDisposeOnSet,size:u=0,sizeCalculation:w=this.sizeCalculation,noUpdateTTL:v=this.noUpdateTTL,noDeleteOnFetchRejection:k=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:S=this.allowStaleOnFetchRejection,ignoreFetchAbort:x=this.ignoreFetchAbort,allowStaleOnFetchAbort:A=this.allowStaleOnFetchAbort,context:D,forceRefresh:O=!1,status:I,signal:B}=s;if(!this.#k)return I&&(I.fetch="get"),this.get(i,{allowStale:h,updateAgeOnGet:c,noDeleteOnStaleGet:_,status:I});let G={allowStale:h,updateAgeOnGet:c,noDeleteOnStaleGet:_,ttl:l,noDisposeOnSet:f,size:u,sizeCalculation:w,noUpdateTTL:v,noDeleteOnFetchRejection:k,allowStaleOnFetchRejection:S,allowStaleOnFetchAbort:A,ignoreFetchAbort:x,status:I,signal:B},Y=this.#h.get(i);if(Y===void 0){I&&(I.fetch="miss");let q=this.#N(i,Y,G,D);return q.__returned=q}else{let q=this.#r[Y];if(this.#_(q)){let K=h&&q.__staleWhileFetching!==void 0;return I&&(I.fetch="inflight",K&&(I.returnedStale=!0)),K?q.__staleWhileFetching:q.__returned=q}let tt=this.#y(Y);if(!O&&!tt)return I&&(I.fetch="hit"),this.#U(Y),c&&this.#A(Y),I&&this.#i(I,Y),q;let ot=this.#N(i,Y,G,D),W=ot.__staleWhileFetching!==void 0&&h;return I&&(I.fetch=tt?"stale":"refresh",W&&tt&&(I.returnedStale=!0)),W?ot.__staleWhileFetching:ot.__returned=ot}}async forceFetch(i,s={}){let h=await this.fetch(i,s);if(h===void 0)throw new Error("fetch() returned undefined");return h}memo(i,s={}){let h=this.#v;if(!h)throw new Error("no memoMethod provided to constructor");let{context:c,forceRefresh:_,...l}=s,f=this.get(i,l);if(!_&&f!==void 0)return f;let u=h(i,f,{options:l,context:c});return this.set(i,u,l),u}get(i,s={}){let{allowStale:h=this.allowStale,updateAgeOnGet:c=this.updateAgeOnGet,noDeleteOnStaleGet:_=this.noDeleteOnStaleGet,status:l}=s,f=this.#h.get(i);if(f!==void 0){let u=this.#r[f],w=this.#_(u);return l&&this.#i(l,f),this.#y(f)?(l&&(l.get="stale"),w?(l&&h&&u.__staleWhileFetching!==void 0&&(l.returnedStale=!0),h?u.__staleWhileFetching:void 0):(_||this.#R(i,"expire"),l&&h&&(l.returnedStale=!0),h?u:void 0)):(l&&(l.get="hit"),w?u.__staleWhileFetching:(this.#U(f),c&&this.#A(f),u))}else l&&(l.get="miss")}#z(i,s){this.#g[s]=i,this.#m[i]=s}#U(i){i!==this.#d&&(i===this.#l?this.#l=this.#m[i]:this.#z(this.#g[i],this.#m[i]),this.#z(this.#d,i),this.#d=i)}delete(i){return this.#R(i,"delete")}#R(i,s){let h=!1;if(this.#c!==0){let c=this.#h.get(i);if(c!==void 0)if(h=!0,this.#c===1)this.#B(s);else{this.#P(c);let _=this.#r[c];if(this.#_(_)?_.__abortController.abort(new Error("deleted")):(this.#b||this.#p)&&(this.#b&&this.#n?.(_,i,s),this.#p&&this.#f?.push([_,i,s])),this.#h.delete(i),this.#a[c]=void 0,this.#r[c]=void 0,c===this.#d)this.#d=this.#g[c];else if(c===this.#l)this.#l=this.#m[c];else{let l=this.#g[c];this.#m[l]=this.#m[c];let f=this.#m[c];this.#g[f]=this.#g[c]}this.#c--,this.#x.push(c)}}if(this.#p&&this.#f?.length){let c=this.#f,_;for(;_=c?.shift();)this.#s?.(..._)}return h}clear(){return this.#B("delete")}#B(i){for(let s of this.#T({allowStale:!0})){let h=this.#r[s];if(this.#_(h))h.__abortController.abort(new Error("deleted"));else{let c=this.#a[s];this.#b&&this.#n?.(h,c,i),this.#p&&this.#f?.push([h,c,i])}}if(this.#h.clear(),this.#r.fill(void 0),this.#a.fill(void 0),this.#w&&this.#E&&(this.#w.fill(0),this.#E.fill(0)),this.#S&&this.#S.fill(0),this.#l=0,this.#d=0,this.#x.length=0,this.#u=0,this.#c=0,this.#p&&this.#f){let s=this.#f,h;for(;h=s?.shift();)this.#s?.(...h)}}};import{posix as L_,win32 as dr}from"node:path";import{fileURLToPath as N_}from"node:url";import{lstatSync as z_,readdir as U_,readdirSync as B_,readlinkSync as j_,realpathSync as W_}from"fs";import*as G_ from"node:fs";import{lstat as H_,readdir as K_,readlink as Y_,realpath as V_}from"node:fs/promises";T();import{EventEmitter as cr}from"node:events";import ho from"node:stream";import{StringDecoder as C_}from"node:string_decoder";var so=typeof process=="object"&&process?process:{stdout:null,stderr:null},T_=o=>!!o&&typeof o=="object"&&(o instanceof Ie||o instanceof ho||D_(o)||I_(o)),D_=o=>!!o&&typeof o=="object"&&o instanceof cr&&typeof o.pipe=="function"&&o.pipe!==ho.Writable.prototype.pipe,I_=o=>!!o&&typeof o=="object"&&o instanceof cr&&typeof o.write=="function"&&typeof o.end=="function",we=Symbol("EOF"),ve=Symbol("maybeEmitEnd"),De=Symbol("emittedEnd"),es=Symbol("emittingEnd"),gi=Symbol("emittedError"),is=Symbol("closed"),ro=Symbol("read"),ss=Symbol("flush"),no=Symbol("flushChunk"),se=Symbol("encoding"),Ve=Symbol("decoder"),bt=Symbol("flowing"),yi=Symbol("paused"),Je=Symbol("resume"),kt=Symbol("buffer"),Nt=Symbol("pipes"),xt=Symbol("bufferLength"),sr=Symbol("bufferPush"),rs=Symbol("bufferShift"),Ot=Symbol("objectMode"),gt=Symbol("destroyed"),rr=Symbol("error"),nr=Symbol("emitData"),oo=Symbol("emitEnd"),or=Symbol("emitEnd2"),ue=Symbol("async"),hr=Symbol("abort"),ns=Symbol("aborted"),wi=Symbol("signal"),Le=Symbol("dataListeners"),Yt=Symbol("discarded"),vi=o=>Promise.resolve().then(o),R_=o=>o(),O_=o=>o==="end"||o==="finish"||o==="prefinish",P_=o=>o instanceof ArrayBuffer||!!o&&typeof o=="object"&&o.constructor&&o.constructor.name==="ArrayBuffer"&&o.byteLength>=0,M_=o=>!Buffer.isBuffer(o)&&ArrayBuffer.isView(o),os=class{src;dest;opts;ondrain;constructor(i,s,h){this.src=i,this.dest=s,this.opts=h,this.ondrain=()=>i[Je](),this.dest.on("drain",this.ondrain)}unpipe(){this.dest.removeListener("drain",this.ondrain)}proxyErrors(i){}end(){this.unpipe(),this.opts.end&&this.dest.end()}},ar=class extends os{unpipe(){this.src.removeListener("error",this.proxyErrors),super.unpipe()}constructor(i,s,h){super(i,s,h),this.proxyErrors=c=>s.emit("error",c),i.on("error",this.proxyErrors)}},q_=o=>!!o.objectMode,F_=o=>!o.objectMode&&!!o.encoding&&o.encoding!=="buffer",Ie=class extends cr{[bt]=!1;[yi]=!1;[Nt]=[];[kt]=[];[Ot];[se];[ue];[Ve];[we]=!1;[De]=!1;[es]=!1;[is]=!1;[gi]=null;[xt]=0;[gt]=!1;[wi];[ns]=!1;[Le]=0;[Yt]=!1;writable=!0;readable=!0;constructor(...i){let s=i[0]||{};if(super(),s.objectMode&&typeof s.encoding=="string")throw new TypeError("Encoding and objectMode may not be used together");q_(s)?(this[Ot]=!0,this[se]=null):F_(s)?(this[se]=s.encoding,this[Ot]=!1):(this[Ot]=!1,this[se]=null),this[ue]=!!s.async,this[Ve]=this[se]?new C_(this[se]):null,s&&s.debugExposeBuffer===!0&&Object.defineProperty(this,"buffer",{get:()=>this[kt]}),s&&s.debugExposePipes===!0&&Object.defineProperty(this,"pipes",{get:()=>this[Nt]});let{signal:h}=s;h&&(this[wi]=h,h.aborted?this[hr]():h.addEventListener("abort",()=>this[hr]()))}get bufferLength(){return this[xt]}get encoding(){return this[se]}set encoding(i){throw new Error("Encoding must be set at instantiation time")}setEncoding(i){throw new Error("Encoding must be set at instantiation time")}get objectMode(){return this[Ot]}set objectMode(i){throw new Error("objectMode must be set at instantiation time")}get async(){return this[ue]}set async(i){this[ue]=this[ue]||!!i}[hr](){this[ns]=!0,this.emit("abort",this[wi]?.reason),this.destroy(this[wi]?.reason)}get aborted(){return this[ns]}set aborted(i){}write(i,s,h){if(this[ns])return!1;if(this[we])throw new Error("write after end");if(this[gt])return this.emit("error",Object.assign(new Error("Cannot call write after a stream was destroyed"),{code:"ERR_STREAM_DESTROYED"})),!0;typeof s=="function"&&(h=s,s="utf8"),s||(s="utf8");let c=this[ue]?vi:R_;if(!this[Ot]&&!Buffer.isBuffer(i)){if(M_(i))i=Buffer.from(i.buffer,i.byteOffset,i.byteLength);else if(P_(i))i=Buffer.from(i);else if(typeof i!="string")throw new Error("Non-contiguous data written to non-objectMode stream")}return this[Ot]?(this[bt]&&this[xt]!==0&&this[ss](!0),this[bt]?this.emit("data",i):this[sr](i),this[xt]!==0&&this.emit("readable"),h&&c(h),this[bt]):i.length?(typeof i=="string"&&!(s===this[se]&&!this[Ve]?.lastNeed)&&(i=Buffer.from(i,s)),Buffer.isBuffer(i)&&this[se]&&(i=this[Ve].write(i)),this[bt]&&this[xt]!==0&&this[ss](!0),this[bt]?this.emit("data",i):this[sr](i),this[xt]!==0&&this.emit("readable"),h&&c(h),this[bt]):(this[xt]!==0&&this.emit("readable"),h&&c(h),this[bt])}read(i){if(this[gt])return null;if(this[Yt]=!1,this[xt]===0||i===0||i&&i>this[xt])return this[ve](),null;this[Ot]&&(i=null),this[kt].length>1&&!this[Ot]&&(this[kt]=[this[se]?this[kt].join(""):Buffer.concat(this[kt],this[xt])]);let s=this[ro](i||null,this[kt][0]);return this[ve](),s}[ro](i,s){if(this[Ot])this[rs]();else{let h=s;i===h.length||i===null?this[rs]():typeof h=="string"?(this[kt][0]=h.slice(i),s=h.slice(0,i),this[xt]-=i):(this[kt][0]=h.subarray(i),s=h.subarray(0,i),this[xt]-=i)}return this.emit("data",s),!this[kt].length&&!this[we]&&this.emit("drain"),s}end(i,s,h){return typeof i=="function"&&(h=i,i=void 0),typeof s=="function"&&(h=s,s="utf8"),i!==void 0&&this.write(i,s),h&&this.once("end",h),this[we]=!0,this.writable=!1,(this[bt]||!this[yi])&&this[ve](),this}[Je](){this[gt]||(!this[Le]&&!this[Nt].length&&(this[Yt]=!0),this[yi]=!1,this[bt]=!0,this.emit("resume"),this[kt].length?this[ss]():this[we]?this[ve]():this.emit("drain"))}resume(){return this[Je]()}pause(){this[bt]=!1,this[yi]=!0,this[Yt]=!1}get destroyed(){return this[gt]}get flowing(){return this[bt]}get paused(){return this[yi]}[sr](i){this[Ot]?this[xt]+=1:this[xt]+=i.length,this[kt].push(i)}[rs](){return this[Ot]?this[xt]-=1:this[xt]-=this[kt][0].length,this[kt].shift()}[ss](i=!1){do;while(this[no](this[rs]())&&this[kt].length);!i&&!this[kt].length&&!this[we]&&this.emit("drain")}[no](i){return this.emit("data",i),this[bt]}pipe(i,s){if(this[gt])return i;this[Yt]=!1;let h=this[De];return s=s||{},i===so.stdout||i===so.stderr?s.end=!1:s.end=s.end!==!1,s.proxyErrors=!!s.proxyErrors,h?s.end&&i.end():(this[Nt].push(s.proxyErrors?new ar(this,i,s):new os(this,i,s)),this[ue]?vi(()=>this[Je]()):this[Je]()),i}unpipe(i){let s=this[Nt].find(h=>h.dest===i);s&&(this[Nt].length===1?(this[bt]&&this[Le]===0&&(this[bt]=!1),this[Nt]=[]):this[Nt].splice(this[Nt].indexOf(s),1),s.unpipe())}addListener(i,s){return this.on(i,s)}on(i,s){let h=super.on(i,s);if(i==="data")this[Yt]=!1,this[Le]++,!this[Nt].length&&!this[bt]&&this[Je]();else if(i==="readable"&&this[xt]!==0)super.emit("readable");else if(O_(i)&&this[De])super.emit(i),this.removeAllListeners(i);else if(i==="error"&&this[gi]){let c=s;this[ue]?vi(()=>c.call(this,this[gi])):c.call(this,this[gi])}return h}removeListener(i,s){return this.off(i,s)}off(i,s){let h=super.off(i,s);return i==="data"&&(this[Le]=this.listeners("data").length,this[Le]===0&&!this[Yt]&&!this[Nt].length&&(this[bt]=!1)),h}removeAllListeners(i){let s=super.removeAllListeners(i);return(i==="data"||i===void 0)&&(this[Le]=0,!this[Yt]&&!this[Nt].length&&(this[bt]=!1)),s}get emittedEnd(){return this[De]}[ve](){!this[es]&&!this[De]&&!this[gt]&&this[kt].length===0&&this[we]&&(this[es]=!0,this.emit("end"),this.emit("prefinish"),this.emit("finish"),this[is]&&this.emit("close"),this[es]=!1)}emit(i,...s){let h=s[0];if(i!=="error"&&i!=="close"&&i!==gt&&this[gt])return!1;if(i==="data")return!this[Ot]&&!h?!1:this[ue]?(vi(()=>this[nr](h)),!0):this[nr](h);if(i==="end")return this[oo]();if(i==="close"){if(this[is]=!0,!this[De]&&!this[gt])return!1;let _=super.emit("close");return this.removeAllListeners("close"),_}else if(i==="error"){this[gi]=h,super.emit(rr,h);let _=!this[wi]||this.listeners("error").length?super.emit("error",h):!1;return this[ve](),_}else if(i==="resume"){let _=super.emit("resume");return this[ve](),_}else if(i==="finish"||i==="prefinish"){let _=super.emit(i);return this.removeAllListeners(i),_}let c=super.emit(i,...s);return this[ve](),c}[nr](i){for(let h of this[Nt])h.dest.write(i)===!1&&this.pause();let s=this[Yt]?!1:super.emit("data",i);return this[ve](),s}[oo](){return this[De]?!1:(this[De]=!0,this.readable=!1,this[ue]?(vi(()=>this[or]()),!0):this[or]())}[or](){if(this[Ve]){let s=this[Ve].end();if(s){for(let h of this[Nt])h.dest.write(s);this[Yt]||super.emit("data",s)}}for(let s of this[Nt])s.end();let i=super.emit("end");return this.removeAllListeners("end"),i}async collect(){let i=Object.assign([],{dataLength:0});this[Ot]||(i.dataLength=0);let s=this.promise();return this.on("data",h=>{i.push(h),this[Ot]||(i.dataLength+=h.length)}),await s,i}async concat(){if(this[Ot])throw new Error("cannot concat in objectMode");let i=await this.collect();return this[se]?i.join(""):Buffer.concat(i,i.dataLength)}async promise(){return new Promise((i,s)=>{this.on(gt,()=>s(new Error("stream destroyed"))),this.on("error",h=>s(h)),this.on("end",()=>i())})}[Symbol.asyncIterator](){this[Yt]=!1;let i=!1,s=async()=>(this.pause(),i=!0,{value:void 0,done:!0});return{next:()=>{if(i)return s();let c=this.read();if(c!==null)return Promise.resolve({done:!1,value:c});if(this[we])return s();let _,l,f=k=>{this.off("data",u),this.off("end",w),this.off(gt,v),s(),l(k)},u=k=>{this.off("error",f),this.off("end",w),this.off(gt,v),this.pause(),_({value:k,done:!!this[we]})},w=()=>{this.off("error",f),this.off("data",u),this.off(gt,v),s(),_({done:!0,value:void 0})},v=()=>f(new Error("stream destroyed"));return new Promise((k,S)=>{l=S,_=k,this.once(gt,v),this.once("error",f),this.once("end",w),this.once("data",u)})},throw:s,return:s,[Symbol.asyncIterator](){return this}}}[Symbol.iterator](){this[Yt]=!1;let i=!1,s=()=>(this.pause(),this.off(rr,s),this.off(gt,s),this.off("end",s),i=!0,{done:!0,value:void 0}),h=()=>{if(i)return s();let c=this.read();return c===null?s():{done:!1,value:c}};return this.once("end",s),this.once(rr,s),this.once(gt,s),{next:h,throw:s,return:s,[Symbol.iterator](){return this}}}destroy(i){if(this[gt])return i?this.emit("error",i):this.emit(gt),this;this[gt]=!0,this[Yt]=!0,this[kt].length=0,this[xt]=0;let s=this;return typeof s.close=="function"&&!this[is]&&s.close(),i?this.emit("error",i):this.emit(gt),this}static get isStream(){return T_}};var $_=W_.native,ki={lstatSync:z_,readdir:U_,readdirSync:B_,readlinkSync:j_,realpathSync:$_,promises:{lstat:H_,readdir:K_,readlink:Y_,realpath:V_}},lo=o=>!o||o===ki||o===G_?ki:{...ki,...o,promises:{...ki.promises,...o.promises||{}}},po=/^\\\\\?\\([a-z]:)\\?$/i,J_=o=>o.replace(/\//g,"\\").replace(po,"$1\\"),X_=/[\\\/]/,Xt=0,fo=1,mo=2,de=4,go=6,yo=8,Ne=10,wo=12,Jt=15,bi=~Jt,_r=16,ao=32,xi=64,re=128,hs=256,cs=512,co=xi|re|cs,Q_=1023,ur=o=>o.isFile()?yo:o.isDirectory()?de:o.isSymbolicLink()?Ne:o.isCharacterDevice()?mo:o.isBlockDevice()?go:o.isSocket()?wo:o.isFIFO()?fo:Xt,_o=new Map,Si=o=>{let i=_o.get(o);if(i)return i;let s=o.normalize("NFKD");return _o.set(o,s),s},uo=new Map,as=o=>{let i=uo.get(o);if(i)return i;let s=Si(o.toLowerCase());return uo.set(o,s),s},_s=class extends mi{constructor(){super({max:256})}},lr=class extends mi{constructor(i=16*1024){super({maxSize:i,sizeCalculation:s=>s.length+1})}},vo=Symbol("PathScurry setAsCwd"),Pt=class{name;root;roots;parent;nocase;isCWD=!1;#t;#e;get dev(){return this.#e}#n;get mode(){return this.#n}#s;get nlink(){return this.#s}#o;get uid(){return this.#o}#v;get gid(){return this.#v}#c;get rdev(){return this.#c}#u;get blksize(){return this.#u}#h;get ino(){return this.#h}#a;get size(){return this.#a}#r;get blocks(){return this.#r}#m;get atimeMs(){return this.#m}#g;get mtimeMs(){return this.#g}#l;get ctimeMs(){return this.#l}#d;get birthtimeMs(){return this.#d}#x;get atime(){return this.#x}#f;get mtime(){return this.#f}#S;get ctime(){return this.#S}#E;get birthtime(){return this.#E}#w;#b;#k;#p;#D;#A;#i;#O;#y;#I;get parentPath(){return(this.parent||this).fullpath()}get path(){return this.parentPath}constructor(i,s=Xt,h,c,_,l,f){this.name=i,this.#w=_?as(i):Si(i),this.#i=s&Q_,this.nocase=_,this.roots=c,this.root=h||this,this.#O=l,this.#k=f.fullpath,this.#D=f.relative,this.#A=f.relativePosix,this.parent=f.parent,this.parent?this.#t=this.parent.#t:this.#t=lo(f.fs)}depth(){return this.#b!==void 0?this.#b:this.parent?this.#b=this.parent.depth()+1:this.#b=0}childrenCache(){return this.#O}resolve(i){if(!i)return this;let s=this.getRootString(i),c=i.substring(s.length).split(this.splitSep);return s?this.getRoot(s).#P(c):this.#P(c)}#P(i){let s=this;for(let h of i)s=s.child(h);return s}children(){let i=this.#O.get(this);if(i)return i;let s=Object.assign([],{provisional:0});return this.#O.set(this,s),this.#i&=~_r,s}child(i,s){if(i===""||i===".")return this;if(i==="..")return this.parent||this;let h=this.children(),c=this.nocase?as(i):Si(i);for(let u of h)if(u.#w===c)return u;let _=this.parent?this.sep:"",l=this.#k?this.#k+_+i:void 0,f=this.newChild(i,Xt,{...s,parent:this,fullpath:l});return this.canReaddir()||(f.#i|=re),h.push(f),f}relative(){if(this.isCWD)return"";if(this.#D!==void 0)return this.#D;let i=this.name,s=this.parent;if(!s)return this.#D=this.name;let h=s.relative();return h+(!h||!s.parent?"":this.sep)+i}relativePosix(){if(this.sep==="/")return this.relative();if(this.isCWD)return"";if(this.#A!==void 0)return this.#A;let i=this.name,s=this.parent;if(!s)return this.#A=this.fullpathPosix();let h=s.relativePosix();return h+(!h||!s.parent?"":"/")+i}fullpath(){if(this.#k!==void 0)return this.#k;let i=this.name,s=this.parent;if(!s)return this.#k=this.name;let c=s.fullpath()+(s.parent?this.sep:"")+i;return this.#k=c}fullpathPosix(){if(this.#p!==void 0)return this.#p;if(this.sep==="/")return this.#p=this.fullpath();if(!this.parent){let c=this.fullpath().replace(/\\/g,"/");return/^[a-z]:\//i.test(c)?this.#p=`//?/${c}`:this.#p=c}let i=this.parent,s=i.fullpathPosix(),h=s+(!s||!i.parent?"":"/")+this.name;return this.#p=h}isUnknown(){return(this.#i&Jt)===Xt}isType(i){return this[`is${i}`]()}getType(){return this.isUnknown()?"Unknown":this.isDirectory()?"Directory":this.isFile()?"File":this.isSymbolicLink()?"SymbolicLink":this.isFIFO()?"FIFO":this.isCharacterDevice()?"CharacterDevice":this.isBlockDevice()?"BlockDevice":this.isSocket()?"Socket":"Unknown"}isFile(){return(this.#i&Jt)===yo}isDirectory(){return(this.#i&Jt)===de}isCharacterDevice(){return(this.#i&Jt)===mo}isBlockDevice(){return(this.#i&Jt)===go}isFIFO(){return(this.#i&Jt)===fo}isSocket(){return(this.#i&Jt)===wo}isSymbolicLink(){return(this.#i&Ne)===Ne}lstatCached(){return this.#i&ao?this:void 0}readlinkCached(){return this.#y}realpathCached(){return this.#I}readdirCached(){let i=this.children();return i.slice(0,i.provisional)}canReadlink(){if(this.#y)return!0;if(!this.parent)return!1;let i=this.#i&Jt;return!(i!==Xt&&i!==Ne||this.#i&hs||this.#i&re)}calledReaddir(){return!!(this.#i&_r)}isENOENT(){return!!(this.#i&re)}isNamed(i){return this.nocase?this.#w===as(i):this.#w===Si(i)}async readlink(){let i=this.#y;if(i)return i;if(this.canReadlink()&&this.parent)try{let s=await this.#t.promises.readlink(this.fullpath()),h=(await this.parent.realpath())?.resolve(s);if(h)return this.#y=h}catch(s){this.#_(s.code);return}}readlinkSync(){let i=this.#y;if(i)return i;if(this.canReadlink()&&this.parent)try{let s=this.#t.readlinkSync(this.fullpath()),h=this.parent.realpathSync()?.resolve(s);if(h)return this.#y=h}catch(s){this.#_(s.code);return}}#M(i){this.#i|=_r;for(let s=i.provisional;s<i.length;s++){let h=i[s];h&&h.#q()}}#q(){this.#i&re||(this.#i=(this.#i|re)&bi,this.#C())}#C(){let i=this.children();i.provisional=0;for(let s of i)s.#q()}#T(){this.#i|=cs,this.#F()}#F(){if(this.#i&xi)return;let i=this.#i;(i&Jt)===de&&(i&=bi),this.#i=i|xi,this.#C()}#L(i=""){i==="ENOTDIR"||i==="EPERM"?this.#F():i==="ENOENT"?this.#q():this.children().provisional=0}#N(i=""){i==="ENOTDIR"?this.parent.#F():i==="ENOENT"&&this.#q()}#_(i=""){let s=this.#i;s|=hs,i==="ENOENT"&&(s|=re),(i==="EINVAL"||i==="UNKNOWN")&&(s&=bi),this.#i=s,i==="ENOTDIR"&&this.parent&&this.parent.#F()}#z(i,s){return this.#R(i,s)||this.#U(i,s)}#U(i,s){let h=ur(i),c=this.newChild(i.name,h,{parent:this}),_=c.#i&Jt;return _!==de&&_!==Ne&&_!==Xt&&(c.#i|=xi),s.unshift(c),s.provisional++,c}#R(i,s){for(let h=s.provisional;h<s.length;h++){let c=s[h];if((this.nocase?as(i.name):Si(i.name))===c.#w)return this.#B(i,c,h,s)}}#B(i,s,h,c){let _=s.name;return s.#i=s.#i&bi|ur(i),_!==i.name&&(s.name=i.name),h!==c.provisional&&(h===c.length-1?c.pop():c.splice(h,1),c.unshift(s)),c.provisional++,s}async lstat(){if(!(this.#i&re))try{return this.#$(await this.#t.promises.lstat(this.fullpath())),this}catch(i){this.#N(i.code)}}lstatSync(){if(!(this.#i&re))try{return this.#$(this.#t.lstatSync(this.fullpath())),this}catch(i){this.#N(i.code)}}#$(i){let{atime:s,atimeMs:h,birthtime:c,birthtimeMs:_,blksize:l,blocks:f,ctime:u,ctimeMs:w,dev:v,gid:k,ino:S,mode:x,mtime:A,mtimeMs:D,nlink:O,rdev:I,size:B,uid:G}=i;this.#x=s,this.#m=h,this.#E=c,this.#d=_,this.#u=l,this.#r=f,this.#S=u,this.#l=w,this.#e=v,this.#v=k,this.#h=S,this.#n=x,this.#f=A,this.#g=D,this.#s=O,this.#c=I,this.#a=B,this.#o=G;let Y=ur(i);this.#i=this.#i&bi|Y|ao,Y!==Xt&&Y!==de&&Y!==Ne&&(this.#i|=xi)}#W=[];#G=!1;#H(i){this.#G=!1;let s=this.#W.slice();this.#W.length=0,s.forEach(h=>h(null,i))}readdirCB(i,s=!1){if(!this.canReaddir()){s?i(null,[]):queueMicrotask(()=>i(null,[]));return}let h=this.children();if(this.calledReaddir()){let _=h.slice(0,h.provisional);s?i(null,_):queueMicrotask(()=>i(null,_));return}if(this.#W.push(i),this.#G)return;this.#G=!0;let c=this.fullpath();this.#t.readdir(c,{withFileTypes:!0},(_,l)=>{if(_)this.#L(_.code),h.provisional=0;else{for(let f of l)this.#z(f,h);this.#M(h)}this.#H(h.slice(0,h.provisional))})}#j;async readdir(){if(!this.canReaddir())return[];let i=this.children();if(this.calledReaddir())return i.slice(0,i.provisional);let s=this.fullpath();if(this.#j)await this.#j;else{let h=()=>{};this.#j=new Promise(c=>h=c);try{for(let c of await this.#t.promises.readdir(s,{withFileTypes:!0}))this.#z(c,i);this.#M(i)}catch(c){this.#L(c.code),i.provisional=0}this.#j=void 0,h()}return i.slice(0,i.provisional)}readdirSync(){if(!this.canReaddir())return[];let i=this.children();if(this.calledReaddir())return i.slice(0,i.provisional);let s=this.fullpath();try{for(let h of this.#t.readdirSync(s,{withFileTypes:!0}))this.#z(h,i);this.#M(i)}catch(h){this.#L(h.code),i.provisional=0}return i.slice(0,i.provisional)}canReaddir(){if(this.#i&co)return!1;let i=Jt&this.#i;return i===Xt||i===de||i===Ne}shouldWalk(i,s){return(this.#i&de)===de&&!(this.#i&co)&&!i.has(this)&&(!s||s(this))}async realpath(){if(this.#I)return this.#I;if(!((cs|hs|re)&this.#i))try{let i=await this.#t.promises.realpath(this.fullpath());return this.#I=this.resolve(i)}catch{this.#T()}}realpathSync(){if(this.#I)return this.#I;if(!((cs|hs|re)&this.#i))try{let i=this.#t.realpathSync(this.fullpath());return this.#I=this.resolve(i)}catch{this.#T()}}[vo](i){if(i===this)return;i.isCWD=!1,this.isCWD=!0;let s=new Set([]),h=[],c=this;for(;c&&c.parent;)s.add(c),c.#D=h.join(this.sep),c.#A=h.join("/"),c=c.parent,h.push("..");for(c=i;c&&c.parent&&!s.has(c);)c.#D=void 0,c.#A=void 0,c=c.parent}},us=class o extends Pt{sep="\\";splitSep=X_;constructor(i,s=Xt,h,c,_,l,f){super(i,s,h,c,_,l,f)}newChild(i,s=Xt,h={}){return new o(i,s,this.root,this.roots,this.nocase,this.childrenCache(),h)}getRootString(i){return dr.parse(i).root}getRoot(i){if(i=J_(i.toUpperCase()),i===this.root.name)return this.root;for(let[s,h]of Object.entries(this.roots))if(this.sameRoot(i,s))return this.roots[i]=h;return this.roots[i]=new Xe(i,this).root}sameRoot(i,s=this.root.name){return i=i.toUpperCase().replace(/\//g,"\\").replace(po,"$1\\"),i===s}},ds=class o extends Pt{splitSep="/";sep="/";constructor(i,s=Xt,h,c,_,l,f){super(i,s,h,c,_,l,f)}getRootString(i){return i.startsWith("/")?"/":""}getRoot(i){return this.root}newChild(i,s=Xt,h={}){return new o(i,s,this.root,this.roots,this.nocase,this.childrenCache(),h)}},ls=class{root;rootPath;roots;cwd;#t;#e;#n;nocase;#s;constructor(i=process.cwd(),s,h,{nocase:c,childrenCacheSize:_=16*1024,fs:l=ki}={}){this.#s=lo(l),(i instanceof URL||i.startsWith("file://"))&&(i=N_(i));let f=s.resolve(i);this.roots=Object.create(null),this.rootPath=this.parseRootPath(f),this.#t=new _s,this.#e=new _s,this.#n=new lr(_);let u=f.substring(this.rootPath.length).split(h);if(u.length===1&&!u[0]&&u.pop(),c===void 0)throw new TypeError("must provide nocase setting to PathScurryBase ctor");this.nocase=c,this.root=this.newRoot(this.#s),this.roots[this.rootPath]=this.root;let w=this.root,v=u.length-1,k=s.sep,S=this.rootPath,x=!1;for(let A of u){let D=v--;w=w.child(A,{relative:new Array(D).fill("..").join(k),relativePosix:new Array(D).fill("..").join("/"),fullpath:S+=(x?"":k)+A}),x=!0}this.cwd=w}depth(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.depth()}childrenCache(){return this.#n}resolve(...i){let s="";for(let _=i.length-1;_>=0;_--){let l=i[_];if(!(!l||l===".")&&(s=s?`${l}/${s}`:l,this.isAbsolute(l)))break}let h=this.#t.get(s);if(h!==void 0)return h;let c=this.cwd.resolve(s).fullpath();return this.#t.set(s,c),c}resolvePosix(...i){let s="";for(let _=i.length-1;_>=0;_--){let l=i[_];if(!(!l||l===".")&&(s=s?`${l}/${s}`:l,this.isAbsolute(l)))break}let h=this.#e.get(s);if(h!==void 0)return h;let c=this.cwd.resolve(s).fullpathPosix();return this.#e.set(s,c),c}relative(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.relative()}relativePosix(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.relativePosix()}basename(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.name}dirname(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),(i.parent||i).fullpath()}async readdir(i=this.cwd,s={withFileTypes:!0}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd);let{withFileTypes:h}=s;if(i.canReaddir()){let c=await i.readdir();return h?c:c.map(_=>_.name)}else return[]}readdirSync(i=this.cwd,s={withFileTypes:!0}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd);let{withFileTypes:h=!0}=s;return i.canReaddir()?h?i.readdirSync():i.readdirSync().map(c=>c.name):[]}async lstat(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.lstat()}lstatSync(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.lstatSync()}async readlink(i=this.cwd,{withFileTypes:s}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i.withFileTypes,i=this.cwd);let h=await i.readlink();return s?h:h?.fullpath()}readlinkSync(i=this.cwd,{withFileTypes:s}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i.withFileTypes,i=this.cwd);let h=i.readlinkSync();return s?h:h?.fullpath()}async realpath(i=this.cwd,{withFileTypes:s}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i.withFileTypes,i=this.cwd);let h=await i.realpath();return s?h:h?.fullpath()}realpathSync(i=this.cwd,{withFileTypes:s}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i.withFileTypes,i=this.cwd);let h=i.realpathSync();return s?h:h?.fullpath()}async walk(i=this.cwd,s={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd);let{withFileTypes:h=!0,follow:c=!1,filter:_,walkFilter:l}=s,f=[];(!_||_(i))&&f.push(h?i:i.fullpath());let u=new Set,w=(k,S)=>{u.add(k),k.readdirCB((x,A)=>{if(x)return S(x);let D=A.length;if(!D)return S();let O=()=>{--D===0&&S()};for(let I of A)(!_||_(I))&&f.push(h?I:I.fullpath()),c&&I.isSymbolicLink()?I.realpath().then(B=>B?.isUnknown()?B.lstat():B).then(B=>B?.shouldWalk(u,l)?w(B,O):O()):I.shouldWalk(u,l)?w(I,O):O()},!0)},v=i;return new Promise((k,S)=>{w(v,x=>{if(x)return S(x);k(f)})})}walkSync(i=this.cwd,s={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd);let{withFileTypes:h=!0,follow:c=!1,filter:_,walkFilter:l}=s,f=[];(!_||_(i))&&f.push(h?i:i.fullpath());let u=new Set([i]);for(let w of u){let v=w.readdirSync();for(let k of v){(!_||_(k))&&f.push(h?k:k.fullpath());let S=k;if(k.isSymbolicLink()){if(!(c&&(S=k.realpathSync())))continue;S.isUnknown()&&S.lstatSync()}S.shouldWalk(u,l)&&u.add(S)}}return f}[Symbol.asyncIterator](){return this.iterate()}iterate(i=this.cwd,s={}){return typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd),this.stream(i,s)[Symbol.asyncIterator]()}[Symbol.iterator](){return this.iterateSync()}*iterateSync(i=this.cwd,s={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd);let{withFileTypes:h=!0,follow:c=!1,filter:_,walkFilter:l}=s;(!_||_(i))&&(yield h?i:i.fullpath());let f=new Set([i]);for(let u of f){let w=u.readdirSync();for(let v of w){(!_||_(v))&&(yield h?v:v.fullpath());let k=v;if(v.isSymbolicLink()){if(!(c&&(k=v.realpathSync())))continue;k.isUnknown()&&k.lstatSync()}k.shouldWalk(f,l)&&f.add(k)}}}stream(i=this.cwd,s={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd);let{withFileTypes:h=!0,follow:c=!1,filter:_,walkFilter:l}=s,f=new Ie({objectMode:!0});(!_||_(i))&&f.write(h?i:i.fullpath());let u=new Set,w=[i],v=0,k=()=>{let S=!1;for(;!S;){let x=w.shift();if(!x){v===0&&f.end();return}v++,u.add(x);let A=(O,I,B=!1)=>{if(O)return f.emit("error",O);if(c&&!B){let G=[];for(let Y of I)Y.isSymbolicLink()&&G.push(Y.realpath().then(q=>q?.isUnknown()?q.lstat():q));if(G.length){Promise.all(G).then(()=>A(null,I,!0));return}}for(let G of I)G&&(!_||_(G))&&(f.write(h?G:G.fullpath())||(S=!0));v--;for(let G of I){let Y=G.realpathCached()||G;Y.shouldWalk(u,l)&&w.push(Y)}S&&!f.flowing?f.once("drain",k):D||k()},D=!0;x.readdirCB(A,!0),D=!1}};return k(),f}streamSync(i=this.cwd,s={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof Pt||(s=i,i=this.cwd);let{withFileTypes:h=!0,follow:c=!1,filter:_,walkFilter:l}=s,f=new Ie({objectMode:!0}),u=new Set;(!_||_(i))&&f.write(h?i:i.fullpath());let w=[i],v=0,k=()=>{let S=!1;for(;!S;){let x=w.shift();if(!x){v===0&&f.end();return}v++,u.add(x);let A=x.readdirSync();for(let D of A)(!_||_(D))&&(f.write(h?D:D.fullpath())||(S=!0));v--;for(let D of A){let O=D;if(D.isSymbolicLink()){if(!(c&&(O=D.realpathSync())))continue;O.isUnknown()&&O.lstatSync()}O.shouldWalk(u,l)&&w.push(O)}}S&&!f.flowing&&f.once("drain",k)};return k(),f}chdir(i=this.cwd){let s=this.cwd;this.cwd=typeof i=="string"?this.cwd.resolve(i):i,this.cwd[vo](s)}},Xe=class extends ls{sep="\\";constructor(i=process.cwd(),s={}){let{nocase:h=!0}=s;super(i,dr,"\\",{...s,nocase:h}),this.nocase=h;for(let c=this.cwd;c;c=c.parent)c.nocase=this.nocase}parseRootPath(i){return dr.parse(i).root.toUpperCase()}newRoot(i){return new us(this.rootPath,de,void 0,this.roots,this.nocase,this.childrenCache(),{fs:i})}isAbsolute(i){return i.startsWith("/")||i.startsWith("\\")||/^[a-z]:(\/|\\)/i.test(i)}},Qe=class extends ls{sep="/";constructor(i=process.cwd(),s={}){let{nocase:h=!1}=s;super(i,L_,"/",{...s,nocase:h}),this.nocase=h}parseRootPath(i){return"/"}newRoot(i){return new ds(this.rootPath,de,void 0,this.roots,this.nocase,this.childrenCache(),{fs:i})}isAbsolute(i){return i.startsWith("/")}},Ei=class extends Qe{constructor(i=process.cwd(),s={}){let{nocase:h=!0}=s;super(i,{...s,nocase:h})}},Ff=process.platform==="win32"?us:ds,bo=process.platform==="win32"?Xe:process.platform==="darwin"?Ei:Qe;T();var Z_=o=>o.length>=1,tu=o=>o.length>=1,Ze=class o{#t;#e;#n;length;#s;#o;#v;#c;#u;#h;#a=!0;constructor(i,s,h,c){if(!Z_(i))throw new TypeError("empty pattern list");if(!tu(s))throw new TypeError("empty glob list");if(s.length!==i.length)throw new TypeError("mismatched pattern list and glob list lengths");if(this.length=i.length,h<0||h>=this.length)throw new TypeError("index out of range");if(this.#t=i,this.#e=s,this.#n=h,this.#s=c,this.#n===0){if(this.isUNC()){let[_,l,f,u,...w]=this.#t,[v,k,S,x,...A]=this.#e;w[0]===""&&(w.shift(),A.shift());let D=[_,l,f,u,""].join("/"),O=[v,k,S,x,""].join("/");this.#t=[D,...w],this.#e=[O,...A],this.length=this.#t.length}else if(this.isDrive()||this.isAbsolute()){let[_,...l]=this.#t,[f,...u]=this.#e;l[0]===""&&(l.shift(),u.shift());let w=_+"/",v=f+"/";this.#t=[w,...l],this.#e=[v,...u],this.length=this.#t.length}}}pattern(){return this.#t[this.#n]}isString(){return typeof this.#t[this.#n]=="string"}isGlobstar(){return this.#t[this.#n]===Tt}isRegExp(){return this.#t[this.#n]instanceof RegExp}globString(){return this.#v=this.#v||(this.#n===0?this.isAbsolute()?this.#e[0]+this.#e.slice(1).join("/"):this.#e.join("/"):this.#e.slice(this.#n).join("/"))}hasMore(){return this.length>this.#n+1}rest(){return this.#o!==void 0?this.#o:this.hasMore()?(this.#o=new o(this.#t,this.#e,this.#n+1,this.#s),this.#o.#h=this.#h,this.#o.#u=this.#u,this.#o.#c=this.#c,this.#o):this.#o=null}isUNC(){let i=this.#t;return this.#u!==void 0?this.#u:this.#u=this.#s==="win32"&&this.#n===0&&i[0]===""&&i[1]===""&&typeof i[2]=="string"&&!!i[2]&&typeof i[3]=="string"&&!!i[3]}isDrive(){let i=this.#t;return this.#c!==void 0?this.#c:this.#c=this.#s==="win32"&&this.#n===0&&this.length>1&&typeof i[0]=="string"&&/^[a-z]:$/i.test(i[0])}isAbsolute(){let i=this.#t;return this.#h!==void 0?this.#h:this.#h=i[0]===""&&i.length>1||this.isDrive()||this.isUNC()}root(){let i=this.#t[0];return typeof i=="string"&&this.isAbsolute()&&this.#n===0?i:""}checkFollowGlobstar(){return!(this.#n===0||!this.isGlobstar()||!this.#a)}markFollowGlobstar(){return this.#n===0||!this.isGlobstar()||!this.#a?!1:(this.#a=!1,!0)}};T();T();var eu=typeof process=="object"&&process&&typeof process.platform=="string"?process.platform:"linux",ti=class{relative;relativeChildren;absolute;absoluteChildren;platform;mmopts;constructor(i,{nobrace:s,nocase:h,noext:c,noglobstar:_,platform:l=eu}){this.relative=[],this.absolute=[],this.relativeChildren=[],this.absoluteChildren=[],this.platform=l,this.mmopts={dot:!0,nobrace:s,nocase:h,noext:c,noglobstar:_,optimizationLevel:2,platform:l,nocomment:!0,nonegate:!0};for(let f of i)this.add(f)}add(i){let s=new Kt(i,this.mmopts);for(let h=0;h<s.set.length;h++){let c=s.set[h],_=s.globParts[h];if(!c||!_)throw new Error("invalid pattern object");for(;c[0]==="."&&_[0]===".";)c.shift(),_.shift();let l=new Ze(c,_,0,this.platform),f=new Kt(l.globString(),this.mmopts),u=_[_.length-1]==="**",w=l.isAbsolute();w?this.absolute.push(f):this.relative.push(f),u&&(w?this.absoluteChildren.push(f):this.relativeChildren.push(f))}}ignored(i){let s=i.fullpath(),h=`${s}/`,c=i.relative()||".",_=`${c}/`;for(let l of this.relative)if(l.match(c)||l.match(_))return!0;for(let l of this.absolute)if(l.match(s)||l.match(h))return!0;return!1}childrenIgnored(i){let s=i.fullpath()+"/",h=(i.relative()||".")+"/";for(let c of this.relativeChildren)if(c.match(h))return!0;for(let c of this.absoluteChildren)if(c.match(s))return!0;return!1}};T();var pr=class o{store;constructor(i=new Map){this.store=i}copy(){return new o(new Map(this.store))}hasWalked(i,s){return this.store.get(i.fullpath())?.has(s.globString())}storeWalked(i,s){let h=i.fullpath(),c=this.store.get(h);c?c.add(s.globString()):this.store.set(h,new Set([s.globString()]))}},fr=class{store=new Map;add(i,s,h){let c=(s?2:0)|(h?1:0),_=this.store.get(i);this.store.set(i,_===void 0?c:c&_)}entries(){return[...this.store.entries()].map(([i,s])=>[i,!!(s&2),!!(s&1)])}},mr=class{store=new Map;add(i,s){if(!i.canReaddir())return;let h=this.store.get(i);h?h.find(c=>c.globString()===s.globString())||h.push(s):this.store.set(i,[s])}get(i){let s=this.store.get(i);if(!s)throw new Error("attempting to walk unknown path");return s}entries(){return this.keys().map(i=>[i,this.store.get(i)])}keys(){return[...this.store.keys()].filter(i=>i.canReaddir())}},Ai=class o{hasWalkedCache;matches=new fr;subwalks=new mr;patterns;follow;dot;opts;constructor(i,s){this.opts=i,this.follow=!!i.follow,this.dot=!!i.dot,this.hasWalkedCache=s?s.copy():new pr}processPatterns(i,s){this.patterns=s;let h=s.map(c=>[i,c]);for(let[c,_]of h){this.hasWalkedCache.storeWalked(c,_);let l=_.root(),f=_.isAbsolute()&&this.opts.absolute!==!1;if(l){c=c.resolve(l==="/"&&this.opts.root!==void 0?this.opts.root:l);let k=_.rest();if(k)_=k;else{this.matches.add(c,!0,!1);continue}}if(c.isENOENT())continue;let u,w,v=!1;for(;typeof(u=_.pattern())=="string"&&(w=_.rest());)c=c.resolve(u),_=w,v=!0;if(u=_.pattern(),w=_.rest(),v){if(this.hasWalkedCache.hasWalked(c,_))continue;this.hasWalkedCache.storeWalked(c,_)}if(typeof u=="string"){let k=u===".."||u===""||u===".";this.matches.add(c.resolve(u),f,k);continue}else if(u===Tt){(!c.isSymbolicLink()||this.follow||_.checkFollowGlobstar())&&this.subwalks.add(c,_);let k=w?.pattern(),S=w?.rest();if(!w||(k===""||k===".")&&!S)this.matches.add(c,f,k===""||k===".");else if(k===".."){let x=c.parent||c;S?this.hasWalkedCache.hasWalked(x,S)||this.subwalks.add(x,S):this.matches.add(x,f,!0)}}else u instanceof RegExp&&this.subwalks.add(c,_)}return this}subwalkTargets(){return this.subwalks.keys()}child(){return new o(this.opts,this.hasWalkedCache)}filterEntries(i,s){let h=this.subwalks.get(i),c=this.child();for(let _ of s)for(let l of h){let f=l.isAbsolute(),u=l.pattern(),w=l.rest();u===Tt?c.testGlobstar(_,l,w,f):u instanceof RegExp?c.testRegExp(_,u,w,f):c.testString(_,u,w,f)}return c}testGlobstar(i,s,h,c){if((this.dot||!i.name.startsWith("."))&&(s.hasMore()||this.matches.add(i,c,!1),i.canReaddir()&&(this.follow||!i.isSymbolicLink()?this.subwalks.add(i,s):i.isSymbolicLink()&&(h&&s.checkFollowGlobstar()?this.subwalks.add(i,h):s.markFollowGlobstar()&&this.subwalks.add(i,s)))),h){let _=h.pattern();if(typeof _=="string"&&_!==".."&&_!==""&&_!==".")this.testString(i,_,h.rest(),c);else if(_===".."){let l=i.parent||i;this.subwalks.add(l,h)}else _ instanceof RegExp&&this.testRegExp(i,_,h.rest(),c)}}testRegExp(i,s,h,c){s.test(i.name)&&(h?this.subwalks.add(i,h):this.matches.add(i,c,!1))}testString(i,s,h,c){i.isNamed(s)&&(h?this.subwalks.add(i,h):this.matches.add(i,c,!1))}};var iu=(o,i)=>typeof o=="string"?new ti([o],i):Array.isArray(o)?new ti(o,i):o,ps=class{path;patterns;opts;seen=new Set;paused=!1;aborted=!1;#t=[];#e;#n;signal;maxDepth;includeChildMatches;constructor(i,s,h){if(this.patterns=i,this.path=s,this.opts=h,this.#n=!h.posix&&h.platform==="win32"?"\\":"/",this.includeChildMatches=h.includeChildMatches!==!1,(h.ignore||!this.includeChildMatches)&&(this.#e=iu(h.ignore??[],h),!this.includeChildMatches&&typeof this.#e.add!="function")){let c="cannot ignore child matches, ignore lacks add() method.";throw new Error(c)}this.maxDepth=h.maxDepth||1/0,h.signal&&(this.signal=h.signal,this.signal.addEventListener("abort",()=>{this.#t.length=0}))}#s(i){return this.seen.has(i)||!!this.#e?.ignored?.(i)}#o(i){return!!this.#e?.childrenIgnored?.(i)}pause(){this.paused=!0}resume(){if(this.signal?.aborted)return;this.paused=!1;let i;for(;!this.paused&&(i=this.#t.shift());)i()}onResume(i){this.signal?.aborted||(this.paused?this.#t.push(i):i())}async matchCheck(i,s){if(s&&this.opts.nodir)return;let h;if(this.opts.realpath){if(h=i.realpathCached()||await i.realpath(),!h)return;i=h}let _=i.isUnknown()||this.opts.stat?await i.lstat():i;if(this.opts.follow&&this.opts.nodir&&_?.isSymbolicLink()){let l=await _.realpath();l&&(l.isUnknown()||this.opts.stat)&&await l.lstat()}return this.matchCheckTest(_,s)}matchCheckTest(i,s){return i&&(this.maxDepth===1/0||i.depth()<=this.maxDepth)&&(!s||i.canReaddir())&&(!this.opts.nodir||!i.isDirectory())&&(!this.opts.nodir||!this.opts.follow||!i.isSymbolicLink()||!i.realpathCached()?.isDirectory())&&!this.#s(i)?i:void 0}matchCheckSync(i,s){if(s&&this.opts.nodir)return;let h;if(this.opts.realpath){if(h=i.realpathCached()||i.realpathSync(),!h)return;i=h}let _=i.isUnknown()||this.opts.stat?i.lstatSync():i;if(this.opts.follow&&this.opts.nodir&&_?.isSymbolicLink()){let l=_.realpathSync();l&&(l?.isUnknown()||this.opts.stat)&&l.lstatSync()}return this.matchCheckTest(_,s)}matchFinish(i,s){if(this.#s(i))return;if(!this.includeChildMatches&&this.#e?.add){let _=`${i.relativePosix()}/**`;this.#e.add(_)}let h=this.opts.absolute===void 0?s:this.opts.absolute;this.seen.add(i);let c=this.opts.mark&&i.isDirectory()?this.#n:"";if(this.opts.withFileTypes)this.matchEmit(i);else if(h){let _=this.opts.posix?i.fullpathPosix():i.fullpath();this.matchEmit(_+c)}else{let _=this.opts.posix?i.relativePosix():i.relative(),l=this.opts.dotRelative&&!_.startsWith(".."+this.#n)?"."+this.#n:"";this.matchEmit(_?l+_+c:"."+c)}}async match(i,s,h){let c=await this.matchCheck(i,h);c&&this.matchFinish(c,s)}matchSync(i,s,h){let c=this.matchCheckSync(i,h);c&&this.matchFinish(c,s)}walkCB(i,s,h){this.signal?.aborted&&h(),this.walkCB2(i,s,new Ai(this.opts),h)}walkCB2(i,s,h,c){if(this.#o(i))return c();if(this.signal?.aborted&&c(),this.paused){this.onResume(()=>this.walkCB2(i,s,h,c));return}h.processPatterns(i,s);let _=1,l=()=>{--_===0&&c()};for(let[f,u,w]of h.matches.entries())this.#s(f)||(_++,this.match(f,u,w).then(()=>l()));for(let f of h.subwalkTargets()){if(this.maxDepth!==1/0&&f.depth()>=this.maxDepth)continue;_++;let u=f.readdirCached();f.calledReaddir()?this.walkCB3(f,u,h,l):f.readdirCB((w,v)=>this.walkCB3(f,v,h,l),!0)}l()}walkCB3(i,s,h,c){h=h.filterEntries(i,s);let _=1,l=()=>{--_===0&&c()};for(let[f,u,w]of h.matches.entries())this.#s(f)||(_++,this.match(f,u,w).then(()=>l()));for(let[f,u]of h.subwalks.entries())_++,this.walkCB2(f,u,h.child(),l);l()}walkCBSync(i,s,h){this.signal?.aborted&&h(),this.walkCB2Sync(i,s,new Ai(this.opts),h)}walkCB2Sync(i,s,h,c){if(this.#o(i))return c();if(this.signal?.aborted&&c(),this.paused){this.onResume(()=>this.walkCB2Sync(i,s,h,c));return}h.processPatterns(i,s);let _=1,l=()=>{--_===0&&c()};for(let[f,u,w]of h.matches.entries())this.#s(f)||this.matchSync(f,u,w);for(let f of h.subwalkTargets()){if(this.maxDepth!==1/0&&f.depth()>=this.maxDepth)continue;_++;let u=f.readdirSync();this.walkCB3Sync(f,u,h,l)}l()}walkCB3Sync(i,s,h,c){h=h.filterEntries(i,s);let _=1,l=()=>{--_===0&&c()};for(let[f,u,w]of h.matches.entries())this.#s(f)||this.matchSync(f,u,w);for(let[f,u]of h.subwalks.entries())_++,this.walkCB2Sync(f,u,h.child(),l);l()}},Ci=class extends ps{matches=new Set;constructor(i,s,h){super(i,s,h)}matchEmit(i){this.matches.add(i)}async walk(){if(this.signal?.aborted)throw this.signal.reason;return this.path.isUnknown()&&await this.path.lstat(),await new Promise((i,s)=>{this.walkCB(this.path,this.patterns,()=>{this.signal?.aborted?s(this.signal.reason):i(this.matches)})}),this.matches}walkSync(){if(this.signal?.aborted)throw this.signal.reason;return this.path.isUnknown()&&this.path.lstatSync(),this.walkCBSync(this.path,this.patterns,()=>{if(this.signal?.aborted)throw this.signal.reason}),this.matches}},Ti=class extends ps{results;constructor(i,s,h){super(i,s,h),this.results=new Ie({signal:this.signal,objectMode:!0}),this.results.on("drain",()=>this.resume()),this.results.on("resume",()=>this.resume())}matchEmit(i){this.results.write(i),this.results.flowing||this.pause()}stream(){let i=this.path;return i.isUnknown()?i.lstat().then(()=>{this.walkCB(i,this.patterns,()=>this.results.end())}):this.walkCB(i,this.patterns,()=>this.results.end()),this.results}streamSync(){return this.path.isUnknown()&&this.path.lstatSync(),this.walkCBSync(this.path,this.patterns,()=>this.results.end()),this.results}};var ru=typeof process=="object"&&process&&typeof process.platform=="string"?process.platform:"linux",ne=class{absolute;cwd;root;dot;dotRelative;follow;ignore;magicalBraces;mark;matchBase;maxDepth;nobrace;nocase;nodir;noext;noglobstar;pattern;platform;realpath;scurry;stat;signal;windowsPathsNoEscape;withFileTypes;includeChildMatches;opts;patterns;constructor(i,s){if(!s)throw new TypeError("glob options required");if(this.withFileTypes=!!s.withFileTypes,this.signal=s.signal,this.follow=!!s.follow,this.dot=!!s.dot,this.dotRelative=!!s.dotRelative,this.nodir=!!s.nodir,this.mark=!!s.mark,s.cwd?(s.cwd instanceof URL||s.cwd.startsWith("file://"))&&(s.cwd=su(s.cwd)):this.cwd="",this.cwd=s.cwd||"",this.root=s.root,this.magicalBraces=!!s.magicalBraces,this.nobrace=!!s.nobrace,this.noext=!!s.noext,this.realpath=!!s.realpath,this.absolute=s.absolute,this.includeChildMatches=s.includeChildMatches!==!1,this.noglobstar=!!s.noglobstar,this.matchBase=!!s.matchBase,this.maxDepth=typeof s.maxDepth=="number"?s.maxDepth:1/0,this.stat=!!s.stat,this.ignore=s.ignore,this.withFileTypes&&this.absolute!==void 0)throw new Error("cannot set absolute and withFileTypes:true");if(typeof i=="string"&&(i=[i]),this.windowsPathsNoEscape=!!s.windowsPathsNoEscape||s.allowWindowsEscape===!1,this.windowsPathsNoEscape&&(i=i.map(u=>u.replace(/\\/g,"/"))),this.matchBase){if(s.noglobstar)throw new TypeError("base matching requires globstar");i=i.map(u=>u.includes("/")?u:`./**/${u}`)}if(this.pattern=i,this.platform=s.platform||ru,this.opts={...s,platform:this.platform},s.scurry){if(this.scurry=s.scurry,s.nocase!==void 0&&s.nocase!==s.scurry.nocase)throw new Error("nocase option contradicts provided scurry option")}else{let u=s.platform==="win32"?Xe:s.platform==="darwin"?Ei:s.platform?Qe:bo;this.scurry=new u(this.cwd,{nocase:s.nocase,fs:s.fs})}this.nocase=this.scurry.nocase;let h=this.platform==="darwin"||this.platform==="win32",c={...s,dot:this.dot,matchBase:this.matchBase,nobrace:this.nobrace,nocase:this.nocase,nocaseMagicOnly:h,nocomment:!0,noext:this.noext,nonegate:!0,optimizationLevel:2,platform:this.platform,windowsPathsNoEscape:this.windowsPathsNoEscape,debug:!!this.opts.debug},_=this.pattern.map(u=>new Kt(u,c)),[l,f]=_.reduce((u,w)=>(u[0].push(...w.set),u[1].push(...w.globParts),u),[[],[]]);this.patterns=l.map((u,w)=>{let v=f[w];if(!v)throw new Error("invalid pattern object");return new Ze(u,v,0,this.platform)})}async walk(){return[...await new Ci(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).walk()]}walkSync(){return[...new Ci(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).walkSync()]}stream(){return new Ti(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).stream()}streamSync(){return new Ti(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).streamSync()}iterateSync(){return this.streamSync()[Symbol.iterator]()}[Symbol.iterator](){return this.iterateSync()}iterate(){return this.stream()[Symbol.asyncIterator]()}[Symbol.asyncIterator](){return this.iterate()}};T();var gr=(o,i={})=>{Array.isArray(o)||(o=[o]);for(let s of o)if(new Kt(s,i).hasMagic())return!0;return!1};function ms(o,i={}){return new ne(o,i).streamSync()}function xo(o,i={}){return new ne(o,i).stream()}function So(o,i={}){return new ne(o,i).walkSync()}async function ko(o,i={}){return new ne(o,i).walk()}function gs(o,i={}){return new ne(o,i).iterateSync()}function Eo(o,i={}){return new ne(o,i).iterate()}var nu=ms,ou=Object.assign(xo,{sync:ms}),hu=gs,au=Object.assign(Eo,{sync:gs}),cu=Object.assign(So,{stream:ms,iterate:gs}),fs=Object.assign(ko,{glob:ko,globSync:So,sync:cu,globStream:xo,stream:ou,globStreamSync:ms,streamSync:nu,globIterate:Eo,iterate:au,globIterateSync:gs,iterateSync:hu,Glob:ne,hasMagic:gr,escape:He,unescape:ie});fs.glob=fs;import Ao from"path";import{fileURLToPath as _u}from"url";function ys(o){return Ao.dirname(_u(o))}async function Co(...o){let i=[];return await Promise.all(o.map(async s=>{(await fs(s.split(Ao.sep).join("/"))).forEach(c=>{i.includes(c)||i.push(`file://${c}`)})})),i}T();T();var To=(o=0)=>i=>`\x1B[${i+o}m`,Do=(o=0)=>i=>`\x1B[${38+o};5;${i}m`,Io=(o=0)=>(i,s,h)=>`\x1B[${38+o};2;${i};${s};${h}m`,dt={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},Sm=Object.keys(dt.modifier),uu=Object.keys(dt.color),du=Object.keys(dt.bgColor),Em=[...uu,...du];function lu(){let o=new Map;for(let[i,s]of Object.entries(dt)){for(let[h,c]of Object.entries(s))dt[h]={open:`\x1B[${c[0]}m`,close:`\x1B[${c[1]}m`},s[h]=dt[h],o.set(c[0],c[1]);Object.defineProperty(dt,i,{value:s,enumerable:!1})}return Object.defineProperty(dt,"codes",{value:o,enumerable:!1}),dt.color.close="\x1B[39m",dt.bgColor.close="\x1B[49m",dt.color.ansi=To(),dt.color.ansi256=Do(),dt.color.ansi16m=Io(),dt.bgColor.ansi=To(10),dt.bgColor.ansi256=Do(10),dt.bgColor.ansi16m=Io(10),Object.defineProperties(dt,{rgbToAnsi256:{value(i,s,h){return i===s&&s===h?i<8?16:i>248?231:Math.round((i-8)/247*24)+232:16+36*Math.round(i/255*5)+6*Math.round(s/255*5)+Math.round(h/255*5)},enumerable:!1},hexToRgb:{value(i){let s=/[a-f\d]{6}|[a-f\d]{3}/i.exec(i.toString(16));if(!s)return[0,0,0];let[h]=s;h.length===3&&(h=[...h].map(_=>_+_).join(""));let c=Number.parseInt(h,16);return[c>>16&255,c>>8&255,c&255]},enumerable:!1},hexToAnsi256:{value:i=>dt.rgbToAnsi256(...dt.hexToRgb(i)),enumerable:!1},ansi256ToAnsi:{value(i){if(i<8)return 30+i;if(i<16)return 90+(i-8);let s,h,c;if(i>=232)s=((i-232)*10+8)/255,h=s,c=s;else{i-=16;let f=i%36;s=Math.floor(i/36)/5,h=Math.floor(f/6)/5,c=f%6/5}let _=Math.max(s,h,c)*2;if(_===0)return 30;let l=30+(Math.round(c)<<2|Math.round(h)<<1|Math.round(s));return _===2&&(l+=60),l},enumerable:!1},rgbToAnsi:{value:(i,s,h)=>dt.ansi256ToAnsi(dt.rgbToAnsi256(i,s,h)),enumerable:!1},hexToAnsi:{value:i=>dt.ansi256ToAnsi(dt.hexToAnsi256(i)),enumerable:!1}}),dt}var pu=lu(),oe=pu;T();import yr from"node:process";import fu from"node:os";import Ro from"node:tty";function Qt(o,i=globalThis.Deno?globalThis.Deno.args:yr.argv){let s=o.startsWith("-")?"":o.length===1?"-":"--",h=i.indexOf(s+o),c=i.indexOf("--");return h!==-1&&(c===-1||h<c)}var{env:lt}=yr,ws;Qt("no-color")||Qt("no-colors")||Qt("color=false")||Qt("color=never")?ws=0:(Qt("color")||Qt("colors")||Qt("color=true")||Qt("color=always"))&&(ws=1);function mu(){if("FORCE_COLOR"in lt)return lt.FORCE_COLOR==="true"?1:lt.FORCE_COLOR==="false"?0:lt.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(lt.FORCE_COLOR,10),3)}function gu(o){return o===0?!1:{level:o,hasBasic:!0,has256:o>=2,has16m:o>=3}}function yu(o,{streamIsTTY:i,sniffFlags:s=!0}={}){let h=mu();h!==void 0&&(ws=h);let c=s?ws:h;if(c===0)return 0;if(s){if(Qt("color=16m")||Qt("color=full")||Qt("color=truecolor"))return 3;if(Qt("color=256"))return 2}if("TF_BUILD"in lt&&"AGENT_NAME"in lt)return 1;if(o&&!i&&c===void 0)return 0;let _=c||0;if(lt.TERM==="dumb")return _;if(yr.platform==="win32"){let l=fu.release().split(".");return Number(l[0])>=10&&Number(l[2])>=10586?Number(l[2])>=14931?3:2:1}if("CI"in lt)return"GITHUB_ACTIONS"in lt||"GITEA_ACTIONS"in lt?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some(l=>l in lt)||lt.CI_NAME==="codeship"?1:_;if("TEAMCITY_VERSION"in lt)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(lt.TEAMCITY_VERSION)?1:0;if(lt.COLORTERM==="truecolor"||lt.TERM==="xterm-kitty")return 3;if("TERM_PROGRAM"in lt){let l=Number.parseInt((lt.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(lt.TERM_PROGRAM){case"iTerm.app":return l>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(lt.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(lt.TERM)||"COLORTERM"in lt?1:_}function Oo(o,i={}){let s=yu(o,{streamIsTTY:o&&o.isTTY,...i});return gu(s)}var wu={stdout:Oo({isTTY:Ro.isatty(1)}),stderr:Oo({isTTY:Ro.isatty(2)})},Po=wu;T();function Mo(o,i,s){let h=o.indexOf(i);if(h===-1)return o;let c=i.length,_=0,l="";do l+=o.slice(_,h)+i+s,_=h+c,h=o.indexOf(i,_);while(h!==-1);return l+=o.slice(_),l}function qo(o,i,s,h){let c=0,_="";do{let l=o[h-1]==="\r";_+=o.slice(c,l?h-1:h)+i+(l?`\r
`:`
`)+s,c=h+1,h=o.indexOf(`
`,c)}while(h!==-1);return _+=o.slice(c),_}var{stdout:Fo,stderr:Lo}=Po,wr=Symbol("GENERATOR"),ei=Symbol("STYLER"),Di=Symbol("IS_EMPTY"),No=["ansi","ansi","ansi256","ansi16m"],ii=Object.create(null),vu=(o,i={})=>{if(i.level&&!(Number.isInteger(i.level)&&i.level>=0&&i.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let s=Fo?Fo.level:0;o.level=i.level===void 0?s:i.level};var bu=o=>{let i=(...s)=>s.join(" ");return vu(i,o),Object.setPrototypeOf(i,Ii.prototype),i};function Ii(o){return bu(o)}Object.setPrototypeOf(Ii.prototype,Function.prototype);for(let[o,i]of Object.entries(oe))ii[o]={get(){let s=vs(this,br(i.open,i.close,this[ei]),this[Di]);return Object.defineProperty(this,o,{value:s}),s}};ii.visible={get(){let o=vs(this,this[ei],!0);return Object.defineProperty(this,"visible",{value:o}),o}};var vr=(o,i,s,...h)=>o==="rgb"?i==="ansi16m"?oe[s].ansi16m(...h):i==="ansi256"?oe[s].ansi256(oe.rgbToAnsi256(...h)):oe[s].ansi(oe.rgbToAnsi(...h)):o==="hex"?vr("rgb",i,s,...oe.hexToRgb(...h)):oe[s][o](...h),ku=["rgb","hex","ansi256"];for(let o of ku){ii[o]={get(){let{level:s}=this;return function(...h){let c=br(vr(o,No[s],"color",...h),oe.color.close,this[ei]);return vs(this,c,this[Di])}}};let i="bg"+o[0].toUpperCase()+o.slice(1);ii[i]={get(){let{level:s}=this;return function(...h){let c=br(vr(o,No[s],"bgColor",...h),oe.bgColor.close,this[ei]);return vs(this,c,this[Di])}}}}var xu=Object.defineProperties(()=>{},{...ii,level:{enumerable:!0,get(){return this[wr].level},set(o){this[wr].level=o}}}),br=(o,i,s)=>{let h,c;return s===void 0?(h=o,c=i):(h=s.openAll+o,c=i+s.closeAll),{open:o,close:i,openAll:h,closeAll:c,parent:s}},vs=(o,i,s)=>{let h=(...c)=>Su(h,c.length===1?""+c[0]:c.join(" "));return Object.setPrototypeOf(h,xu),h[wr]=o,h[ei]=i,h[Di]=s,h},Su=(o,i)=>{if(o.level<=0||!i)return o[Di]?"":i;let s=o[ei];if(s===void 0)return i;let{openAll:h,closeAll:c}=s;if(i.includes("\x1B"))for(;s!==void 0;)i=Mo(i,s.close,s.open),s=s.parent;let _=i.indexOf(`
`);return _!==-1&&(i=qo(i,c,h,_)),h+i+c};Object.defineProperties(Ii.prototype,ii);var Eu=Ii(),Nm=Ii({level:Lo?Lo.level:0});var St=Eu;T();T();var kr=o=>Array.isArray(o)?o:[o],zo=o=>o.replace(/[\W_]([a-z\d])?/gi,(i,s)=>s?s.toUpperCase():"");function Au(o,i){return i.length!==o.length?!1:o.every((s,h)=>s===i[h])}function Uo(o,i){return i.length>o.length?!1:Au(o.slice(0,i.length),i)}T();function xr(o){if(o===null||typeof o!="object")return!1;let i=Object.getPrototypeOf(o);return i!==null&&i!==Object.prototype&&Object.getPrototypeOf(i)!==null||Symbol.iterator in o?!1:Symbol.toStringTag in o?Object.prototype.toString.call(o)==="[object Module]":!0}function Sr(o,i,s=".",h){if(!xr(i))return Sr(o,{},s,h);let c=Object.assign({},i);for(let _ in o){if(_==="__proto__"||_==="constructor")continue;let l=o[_];l!=null&&(h&&h(c,_,l,s)||(Array.isArray(l)&&Array.isArray(c[_])?c[_]=[...l,...c[_]]:xr(l)&&xr(c[_])?c[_]=Sr(l,c[_],(s?`${s}.`:"")+_.toString(),h):c[_]=l))}return c}function Er(o){return(...i)=>i.reduce((s,h)=>Sr(s,h,"",o),{})}var Cu=Er(),Wm=Er((o,i,s)=>{if(o[i]!==void 0&&typeof s=="function")return o[i]=s(o[i]),!0}),Gm=Er((o,i,s)=>{if(Array.isArray(o[i])&&typeof s=="function")return o[i]=s(o[i]),!0});T();var Tu="known-flag",Du="unknown-flag",Iu="argument",{stringify:Ri}=JSON,Ru=/\B([A-Z])/g,Ou=o=>o.replace(Ru,"-$1").toLowerCase(),{hasOwnProperty:Pu}=Object.prototype,Oi=(o,i)=>Pu.call(o,i),Mu=o=>Array.isArray(o),Bo=o=>typeof o=="function"?[o,!1]:Mu(o)?[o[0],!0]:Bo(o.type),qu=(o,i)=>o===Boolean?i!=="false":i,Fu=(o,i)=>typeof i=="boolean"?i:o===Number&&i===""?Number.NaN:o(i),Lu=/[\s.:=]/,Nu=o=>{let i=`Flag name ${Ri(o)}`;if(o.length===0)throw new Error(`${i} cannot be empty`);if(o.length===1)throw new Error(`${i} must be longer than a character`);let s=o.match(Lu);if(s)throw new Error(`${i} cannot contain ${Ri(s?.[0])}`)},zu=o=>{let i={},s=(h,c)=>{if(Oi(i,h))throw new Error(`Duplicate flags named ${Ri(h)}`);i[h]=c};for(let h in o){if(!Oi(o,h))continue;Nu(h);let c=o[h],_=[[],...Bo(c),c];s(h,_);let l=Ou(h);if(h!==l&&s(l,_),"alias"in c&&typeof c.alias=="string"){let{alias:f}=c,u=`Flag alias ${Ri(f)} for flag ${Ri(h)}`;if(f.length===0)throw new Error(`${u} cannot be empty`);if(f.length>1)throw new Error(`${u} must be a single character`);s(f,_)}}return i},Uu=(o,i)=>{let s={};for(let h in o){if(!Oi(o,h))continue;let[c,,_,l]=i[h];if(c.length===0&&"default"in l){let{default:f}=l;typeof f=="function"&&(f=f()),s[h]=f}else s[h]=_?c:c.pop()}return s},bs="--",Bu=/[.:=]/,ju=/^-{1,2}\w/,Wu=o=>{if(!ju.test(o))return;let i=!o.startsWith(bs),s=o.slice(i?1:2),h,c=s.match(Bu);if(c){let{index:_}=c;h=s.slice(_+1),s=s.slice(0,_)}return[s,h,i]},Gu=(o,{onFlag:i,onArgument:s})=>{let h,c=(_,l)=>{if(typeof h!="function")return!0;h(_,l),h=void 0};for(let _=0;_<o.length;_+=1){let l=o[_];if(l===bs){c();let u=o.slice(_+1);s?.(u,[_],!0);break}let f=Wu(l);if(f){if(c(),!i)continue;let[u,w,v]=f;if(v)for(let k=0;k<u.length;k+=1){c();let S=k===u.length-1;h=i(u[k],S?w:void 0,[_,k+1,S])}else h=i(u,w,[_])}else c(l,[_])&&s?.([l],[_])}c()},$u=(o,i)=>{for(let[s,h,c]of i.reverse()){if(h){let _=o[s],l=_.slice(0,h);if(c||(l+=_.slice(h+1)),l!=="-"){o[s]=l;continue}}o.splice(s,1)}},Ar=(o,i=process.argv.slice(2),{ignore:s}={})=>{let h=[],c=zu(o),_={},l=[];return l[bs]=[],Gu(i,{onFlag(f,u,w){let v=Oi(c,f);if(!s?.(v?Tu:Du,f,u)){if(v){let[k,S]=c[f],x=qu(S,u),A=(D,O)=>{h.push(w),O&&h.push(O),k.push(Fu(S,D||""))};return x===void 0?A:A(x)}Oi(_,f)||(_[f]=[]),_[f].push(u===void 0?!0:u),h.push(w)}},onArgument(f,u,w){s?.(Iu,i[u[0]])||(l.push(...f),w?(l[bs]=f,i.splice(u[0])):h.push(u))}}),$u(i,h),{flags:Uu(o,c),unknownFlags:_,_:l}};var Mi=JSON.stringify,Dr=class extends Error{constructor(i,s){super(s("core.commandExists",Mi(i))),this.commandName=i}},Ir=class extends Error{constructor(i,s){super(s("core.noSuchCommand",Mi(i))),this.commandName=i}},Rr=class extends Error{constructor(i){super(i("core.noCommandGiven"))}},Or=class extends Error{constructor(i,s,h){super(h("core.commandNameConflict",Mi(i),Mi(s))),this.n1=i,this.n2=s}},Pr=class extends Error{constructor(i){super(i("core.scriptNameNotSet"))}},Mr=class extends Error{constructor(i){super(i("core.descriptionNotSet"))}},qr=class extends Error{constructor(i){super(i("core.versionNotSet"))}},Fr=class extends Error{constructor(i,s){super(s("core.badNameFormat",Mi(i))),this.commandName=i}};var Hu={en:{"core.commandExists":'Command "%s" exists.',"core.noSuchCommand":"No such command: %s.","core.noCommandGiven":"No command given.","core.commandNameConflict":"Command name %s conflicts with %s. Maybe caused by alias.","core.scriptNameNotSet":"Name not set.","core.descriptionNotSet":"Description not set.","core.versionNotSet":"Version not set.","core.badNameFormat":"Bad name format: %s.","core.localeMustBeCalledFirst":"locale() or fallbackLocale() must be called at first.","core.cliParseMustBeCalled":"cli.parse() must be called.","core.spreadParameterMustBeLast":"Invalid Parameter: Spread parameter %s must be last.","core.requiredParameterCannotComeAfterOptionalParameter":"Invalid Parameter: Required parameter %s cannot come after optional parameter %s.","core.parameterMustBeWrappedInBrackets":"Invalid Parameter: Parameter %s must be wrapped in <> (required parameter) or [] (optional parameter).","core.parameterIsUsedMoreThanOnce":"Invalid Parameter: Parameter %s is used more than once.","core.missingRequiredParameter":"Missing required parameter %s."},"zh-CN":{"core.commandExists":'\u547D\u4EE4 "%s" \u5DF2\u5B58\u5728\u3002',"core.noSuchCommand":"\u627E\u4E0D\u5230\u547D\u4EE4: %s\u3002","core.noCommandGiven":"\u6CA1\u6709\u8F93\u5165\u547D\u4EE4\u3002","core.commandNameConflict":"\u547D\u4EE4\u540D\u79F0 %s \u548C %s \u51B2\u7A81\u3002 \u53EF\u80FD\u662F\u7531\u4E8E\u522B\u540D\u5BFC\u81F4\u7684\u3002","core.scriptNameNotSet":"\u672A\u8BBE\u7F6E CLI Script \u540D\u79F0\u3002","core.descriptionNotSet":"\u672A\u8BBE\u7F6E CLI \u63CF\u8FF0\u3002","core.versionNotSet":"\u672A\u8BBE\u7F6E CLI \u7248\u672C\u3002","core.badNameFormat":"\u9519\u8BEF\u7684\u547D\u4EE4\u540D\u5B57\u683C\u5F0F: %s\u3002","core.localeMustBeCalledFirst":"locale() \u6216 fallbackLocale() \u5FC5\u987B\u5728\u6700\u5F00\u59CB\u8C03\u7528\u3002","core.cliParseMustBeCalled":"cli.parse() \u5FC5\u987B\u88AB\u8C03\u7528\u3002","core.spreadParameterMustBeLast":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u5C55\u5F00\u53C2\u6570 %s \u5FC5\u987B\u5728\u6700\u540E\u3002","core.requiredParameterCannotComeAfterOptionalParameter":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u5FC5\u586B\u53C2\u6570 %s \u4E0D\u80FD\u5728\u53EF\u9009\u53C2\u6570 %s \u4E4B\u540E\u3002","core.parameterMustBeWrappedInBrackets":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u53C2\u6570 %s \u5FC5\u987B\u88AB <> (\u5FC5\u586B\u53C2\u6570) \u6216 [] (\u53EF\u9009\u53C2\u6570) \u5305\u88F9\u3002","core.parameterIsUsedMoreThanOnce":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u53C2\u6570 %s \u88AB\u4F7F\u7528\u4E86\u591A\u6B21\u3002","core.missingRequiredParameter":"\u7F3A\u5C11\u5FC5\u586B\u53C2\u6570 %s\u3002"}},{stringify:si}=JSON;function Cr(o,i){let s=[],h,c;for(let _ of o){if(c)throw new Error(i("core.spreadParameterMustBeLast",si(c)));let l=_[0],f=_[_.length-1],u;if(l==="<"&&f===">"&&(u=!0,h))throw new Error(i("core.requiredParameterMustBeBeforeOptional",si(_),si(h)));if(l==="["&&f==="]"&&(u=!1,h=_),u===void 0)throw new Error(i("core.parameterMustBeWrappedInBrackets",si(_)));let w=_.slice(1,-1),v=w.slice(-3)==="...";v&&(c=_,w=w.slice(0,-3)),s.push({name:w,required:u,spread:v})}return s}function Tr(o,i,s,h){for(let c=0;c<i.length;c+=1){let{name:_,required:l,spread:f}=i[c],u=zo(_);if(u in o)throw new Error(h("core.parameterIsUsedMoreThanOnce",si(_)));let w=f?s.slice(c):s[c];if(f&&(c=i.length),l&&(!w||f&&w.length===0))throw new Error(h("core.missingRequiredParameter",si(_)));o[u]=w}}function jo(o,i,s,h){if(s.alias){let c=kr(s.alias);for(let _ of c){if(_ in i)throw new Or(i[_].name,s.name,h);o.set(typeof _=="symbol"?_:_.split(" "),{...s,__isAlias:!0})}}}function Ku(o,i){let s=new Map;o[zt]&&(s.set(zt,o[zt]),jo(s,o,o[zt],i));for(let h of Object.values(o))jo(s,o,h,i),s.set(h.name.split(" "),h);return s}function Yu(o,i,s){var h;let c=Ku(o,s);for(let[_,l]of c.entries()){let f=Ar((h=l?.flags)!=null?h:Object.create(null),[...i]),{_:u}=f;if(_!==zt&&Uo(u,_))return[l,_]}return c.has(zt)?[c.get(zt),zt]:[void 0,void 0]}function Vu(o){let i={pre:[],normal:[],post:[]};for(let h of o){let c=typeof h=="object"?h:{fn:h},{enforce:_,fn:l}=c;_==="post"||_==="pre"?i[_].push(l):i.normal.push(l)}let s=[...i.pre,...i.normal,...i.post];return h=>{return c(0);function c(_){let l=s[_];return l(h,c.bind(null,_+1))}}}var Ju=/\s{2,}/,Xu=o=>o===zt?!0:!(o.startsWith(" ")||o.endsWith(" "))&&!Ju.test(o);var Qu="<Root>",Zu=o=>Array.isArray(o)?o.join(" "):typeof o=="string"?o:Qu;var td=o=>o.filter(i=>!i.startsWith("-")),Nr=(o,i,s)=>{if(!i.has(o))throw TypeError("Cannot "+s)},Et=(o,i,s)=>(Nr(o,i,"read from private field"),s?s.call(o):i.get(o));var ed=(o,i,s,h)=>(Nr(o,i,"write to private field"),h?h.call(o,s):i.set(o,s),s),ks=(o,i,s)=>(Nr(o,i,"access private method"),s),id,Wo,Go,$o,Ho,zr,Ko,Yo,Pi,Ur,Lr,Vo,sd,rd,nd,Jo,Xo,Qo,Zo,od,hd,Br,jr,ad,cd,_d,ud,th,eh,ih,sh,dd,ld,pd,fd,zt=Symbol.for("Clerc.Root");id=new WeakMap;Wo=new WeakMap;Go=new WeakMap;$o=new WeakMap;Ho=new WeakMap;zr=new WeakMap;Ko=new WeakMap;Yo=new WeakMap;Pi=new WeakMap;Ur=new WeakMap;Lr=new WeakMap;Vo=new WeakMap;sd=new WeakMap;rd=new WeakMap;nd=new WeakMap;Jo=new WeakSet;Xo=function(){return Et(this,Pi).has(zt)};Qo=new WeakSet;Zo=function(){return Object.prototype.hasOwnProperty.call(this._commands,zt)};od=new WeakSet;hd=function(){this.i18n.add(Hu)};Br=new WeakSet;jr=function(){ed(this,Vo,!0)};ad=new WeakSet;cd=function(o,i,s={}){ks(this,Br,jr).call(this);let{t:h}=this.i18n,_=(k=>!(typeof k=="string"||k===zt))(o),l=_?o.name:o;if(!Xu(l))throw new Fr(l,h);let{handler:f=void 0,...u}=_?o:{name:l,description:i,...s},w=[u.name],v=u.alias?kr(u.alias):[];u.alias&&w.push(...v);for(let k of w)if(Et(this,Pi).has(k))throw new Dr(Zu(k),h);Et(this,zr)[l]=u,Et(this,Pi).add(u.name);for(let k of v)Et(this,Pi).add(k);return _&&f&&this.on(o.name,f),this};_d=new WeakSet;ud=function(){let{t:o}=this.i18n;if(!Et(this,Wo))throw new Pr(o);if(!Et(this,Go))throw new Mr(o);if(!Et(this,$o))throw new qr(o)};th=new WeakSet;eh=function(o){var i;let s=Et(this,Ur),{t:h}=this.i18n,[c,_]=o(),l=!!c,f={...Et(this,Yo),...c?.flags},u=Ar(f,[...s]),w=c?.name===zt||_===zt?0:_?.length?_.length:c?.name.split(" ").length,{_:v,flags:k,unknownFlags:S}=u,x=!l||c.name===zt?v:v.slice(w),A=(i=c?.parameters)!=null?i:[],D=A.indexOf("--"),O=A.slice(D+1)||[],I=Object.create(null);if(D>-1&&O.length>0){A=A.slice(0,D);let Y=v["--"];x=x.slice(0,-Y.length||void 0),Tr(I,Cr(A,h),x,h),Tr(I,Cr(O,h),Y,h)}else Tr(I,Cr(A,h),x,h);let B={...k,...S};return{name:c?.name,called:Array.isArray(_)?_.join(" "):_,resolved:l,hasRootOrAlias:Et(this,Jo,Xo),hasRoot:Et(this,Qo,Zo),raw:{...u,parameters:x,mergedFlags:B},parameters:I,flags:k,unknownFlags:S,cli:this}};ih=new WeakSet;sh=function(o){if(Et(this,Lr).length>0)for(let i of Et(this,Lr))i(o);else throw o};dd=new WeakSet;ld=function(o){try{o()}catch(i){ks(this,ih,sh).call(this,i)}};pd=new WeakSet;fd=function(){ks(this,Br,jr).call(this);let{t:o}=this.i18n,i=Et(this,Ur);if(!i)throw new Error(o("core.cliParseMustBeCalled"));let s=()=>Yu(Et(this,zr),i,o),h=()=>ks(this,th,eh).call(this,s),c={enforce:"post",fn:f=>{let[u]=s(),w=td(i).join(" ");if(!u)throw w?new Ir(w,o):new Rr(o);Et(this,Ko).emit(u.name,f)}},_=[...Et(this,Ho),c];Vu(_)(h())};var rh=(o,i)=>({...o,handler:i});import{existsSync as lc}from"fs";import{readFile as pc,writeFile as fc}from"fs/promises";import ae from"path";T();var rn=di(Qa(),1);import{existsSync as gp}from"fs";import{homedir as yp}from"os";import Ps from"path";var wp=await Co(`${ys(import.meta.url)}/commands/*.{ts,js}`),vp=Ps.join(yp(),".tdb"),qe=Ps.join(vp,"data"),pe=Ps.join(qe,"mysql"),bp=Ps.join(qe,"postgres");if(!gp(qe))throw new Error("Data directory does not exist. Please run the `postinstall` script.");await Promise.all([(0,rn.ensureDir)(pe),(0,rn.ensureDir)(bp)]);var yg=await Promise.all(wp.map(async o=>{let{command:i}=await import(o);return i}));T();import{createServer as kp}from"net";function Za(o){return new Promise((i,s)=>{let h=kp().once("error",c=>{if(c.code!="EADDRINUSE"){s(c);return}i(!0)}).once("listening",function(){h.once("close",function(){i(!1)}).close()}).listen(o,"127.0.0.1")})}T();import{writeFile as Op}from"fs/promises";import Pp from"path";T();var oc=di(nn(),1);import{randomInt as Rp}from"crypto";import*as nc from"fs";import*as Bs from"net";import*as hc from"tls";import*as ac from"util";T();var ec=di(nn(),1);import{randomInt as tc}from"crypto";var on=192,hn=219,xp=220,Sp=221;function Ep(o){let i=[on];for(let s of o)s===on?i.push(hn,xp):s===hn?i.push(hn,Sp):i.push(s);return i.push(on),Buffer.from(i)}function Ms(o){let i=o[0]>>4&15,s=(o[0]&15)*4,h=o.readUInt16BE(2),c=o[9],_=o.slice(12,16).join("."),l=o.slice(16,20).join(".");return{version:i,headerLength:s,totalLength:h,protocol:c,srcIP:_,dstIP:l,payload:o.slice(s,h)}}function qs(o){let i=o.readUInt16BE(0),s=o.readUInt16BE(2),h=o.readUInt32BE(4),c=o.readUInt32BE(8),_=(o[12]>>4&15)*4,l=o[13],f=o.readUInt16BE(14);return{srcPort:i,dstPort:s,seqNumber:h,ackNumber:c,headerLength:_,flags:l,windowSize:f,payload:o.slice(_)}}function Ap(o){let i=0;for(let s=0;s<o.length;s+=2)i+=o.readUInt16BE(s);return i=(i>>16)+(i&65535),i+=i>>16,~i&65535}function Fs(o,i,s){let h=Buffer.alloc(12);o.split(".").forEach((l,f)=>{h[f]=parseInt(l)}),i.split(".").forEach((l,f)=>{h[4+f]=parseInt(l)}),h[8]=0,h[9]=6,h.writeUInt16BE(s.length,10);let c=Buffer.concat([h,s]),_=0;for(let l=0;l<c.length;l+=2)l===c.length-1?_+=c[l]<<8:_+=c.readUInt16BE(l);return _=(_>>16)+(_&65535),_+=_>>16,~_&65535}function Ls(o,i,s,h,c,_,l){let u=20+l.length,w=Buffer.alloc(u);return w.writeUInt16BE(i,0),w.writeUInt16BE(o,2),w.writeUInt32BE(s,4),w.writeUInt32BE(h,8),w[12]=20/4<<4,w[13]=c,w.writeUInt16BE(_,14),w.writeUInt16BE(0,16),w.writeUInt16BE(0,18),l.copy(w,20),w}function Ns(o,i,s,h){let _=20+h.length,l=Buffer.alloc(_);l[0]=69,l[1]=0,l.writeUInt16BE(_,2),l.writeUInt16BE(tc(65536),4),l.writeUInt16BE(16384,6),l[8]=64,l[9]=s,l.writeUInt16BE(0,10),o.split(".").forEach((u,w)=>{l[12+w]=parseInt(u)}),i.split(".").forEach((u,w)=>{l[16+w]=parseInt(u)});let f=Ap(l.slice(0,20));return l.writeUInt16BE(f,10),h.copy(l,20),l}function zs(o,i){cn(o);let s=Ep(o);i.serial_send_bytes(1,s)}async function ic(o,i,s,h,c){let l=tc(4294967295),f=Ls(s,h,l,0,2,64240,Buffer.alloc(0)),u=Fs(o,i,f);f.writeUInt16BE(u,16);let w=Ns(o,i,6,f);zs(w,c);let v=await Tp(c,o,i,s,h,l);return[l+1,v]}function Cp(o){return["FIN","SYN","RST","PSH","ACK","URG","ECE","CWR"].filter((s,h)=>o>>h&1)}function Tp(o,i,s,h,c,_){return new Promise((l,f)=>{let u=new ec.default.Decoder({maxMessageSize:209715200,bufferSize:2048,onMessage:v=>{let k=Ms(Buffer.from(v));if(k.protocol===6){let S=qs(k.payload);if(S.flags===18&&S.ackNumber===_+1){let A=Ls(h,c,_+1,S.seqNumber+1,16,64240,Buffer.alloc(0)),D=Fs(i,s,A);A.writeUInt16BE(D,16);let O=Ns(i,s,6,A);zs(O,o),o.remove_listener("serial1-output-byte",w),l(S.seqNumber+1)}}}}),w=v=>{u.decode(Buffer.from([v]))};o.add_listener("serial1-output-byte",w),setTimeout(()=>{o.remove_listener("serial1-output-byte",w),f(new Error("Timeout waiting for SYN/ACK"))},3e4)})}async function sc(o,i,s,h,c,_,l,f){let w=Ls(s,h,c,_,24,64240,f),v=Fs(o,i,w);w.writeUInt16BE(v,16);let k=Ns(o,i,6,w);zs(k,l)}var Dp=16;function Ip(o,i,s,h,c=64240){return Ls(i,o,s,h,Dp,c,Buffer.alloc(0))}function rc(o,i,s,h,c,_,l){let f=Ip(s,h,c,_,64240),u=Fs(o,i,f);f.writeUInt16BE(u,16);let w=Ns(o,i,6,f);return zs(w,l),_}function an(o,i){return o.padEnd(i)}function Wi(o,i){return o.padStart(i)}function cn(o){if(!process.env.DEBUG)return;let i=Ms(o),{srcIP:s,dstIP:h}=i,c=s==="10.0.0.1"?St.green(s):St.red(s),_=h==="10.0.0.1"?St.green(h):St.red(h),l=qs(i.payload),{srcPort:f,dstPort:u,seqNumber:w,ackNumber:v,flags:k,windowSize:S}=l,x=`${an(c,16)} -> ${an(_,16)}`,A=`TCP ${Wi(f.toString(),5)} -> ${Wi(u.toString(),5)}`,D=`[${an(Cp(k).join(", "),20)}]`,O=`Seq=${Wi(w.toString(),10)}`,I=`Ack=${Wi(v.toString(),10)}`,B=`Win=${Wi(S.toString(),5)}`;console.log(`${x} ${A} ${D} ${O} ${I} ${B}`)}var Us=class{proxyPort;serviceHosts;servicePorts;serviceHostIndex;options;proxyTlsOptions;serviceTlsOptions;proxySockets;users;allowedIPs;server=null;emulator;constructor(i,s,h,c,_){this.emulator=c,this.proxyPort=i,this.serviceHosts=this.parse(s),this.servicePorts=this.parse(h).map(Number),this.serviceHostIndex=-1,this.options=this.parseOptions(_),this.proxyTlsOptions={passphrase:this.options.passphrase,secureProtocol:"TLSv1_2_method"},this.options.tls&&(this.proxyTlsOptions.pfx=nc.readFileSync(this.options.pfx)),this.serviceTlsOptions={rejectUnauthorized:this.options.rejectUnauthorized,secureProtocol:"TLSv1_2_method"},this.proxySockets={},this.options.identUsers.length!==0?(this.users=this.options.identUsers,this.log(`Will only allow these users: ${this.users.join(", ")}`)):this.log("Will allow all users"),this.options.allowedIPs.length!==0&&(this.allowedIPs=this.options.allowedIPs),this.createListener()}parse(i){if(typeof i=="string")return i.split(",");if(typeof i=="number")return this.parse(i.toString());if(Array.isArray(i))return i;throw new Error("cannot parse object: "+i)}parseOptions(i){return Object.assign({quiet:!0,pfx:void 0,passphrase:"abcd",rejectUnauthorized:!0,identUsers:[],allowedIPs:[],tls:!1,hostname:void 0,customTlsOptions:void 0,localAddress:void 0,localPort:void 0,upstream:void 0,downstream:void 0,serviceHostSelected:void 0},i||{})}createListener(){this.options.tls?this.server=hc.createServer(this.options.customTlsOptions||this.proxyTlsOptions,i=>{this.handleClientConnection(i)}):this.server=Bs.createServer(i=>{this.handleClientConnection(i)}),this.server.listen(this.proxyPort,this.options.hostname)}handleClientConnection(i){this.users?this.handleAuth(i):this.handleClient(i)}handleAuth(i){if(this.allowedIPs?.includes(i.remoteAddress)){this.handleClient(i);return}let s=ac.format("%d, %d",i.remotePort,this.proxyPort),h=new Bs.Socket,c;h.on("error",()=>{c=void 0,h.destroy()}),h.on("data",_=>{c=_.toString().trim(),h.destroy()}),h.on("close",()=>{if(!c){this.log("No identd"),i.destroy();return}let _=c.split(":").pop();this.users?.includes(_)?this.handleClient(i):(this.log(`User "${_}" unauthorized`),i.destroy())}),h.connect(113,i.remoteAddress,()=>{h.write(s),h.end()})}async handleClient(i){let s=this.uniqueKey(i);this.proxySockets[s]=i;let h={buffers:[],connected:!1,sequenceNumber:0,ackNumber:0,srcPort:Rp(1024,65535),proxySocket:i};this.createServiceSocket(h),[h.sequenceNumber,h.ackNumber]=await ic("10.0.0.2","10.0.0.1",3306,h.srcPort,this.emulator),i.on("data",async c=>{await this.handleUpstreamData(h,c)}),i.on("close",()=>{delete this.proxySockets[this.uniqueKey(i)],h.serviceSocket!==void 0&&h.serviceSocket.destroy()}),i.on("error",()=>{h.serviceSocket!==void 0&&h.serviceSocket.destroy()})}async handleUpstreamData(i,s){let c=[];if(s.length>768)for(let _=0;_<s.length;_+=768)c.push(s.slice(_,_+768));else c.push(s);for(let _=0;_<c.length;_++){let l=c[_];await sc("10.0.0.2","10.0.0.1",3306,i.srcPort,i.sequenceNumber,i.ackNumber,this.emulator,l),l.length>0&&(i.sequenceNumber+=l.length,Number.isFinite(i.sequenceNumber)||(i.sequenceNumber=0),process.env.DEBUG&&(c.length>1?console.log(St.bold(`Sending ${l.length} bytes (chunk ${_+1}/${c.length})`)):console.log(St.bold(`Sending ${l.length} bytes`))))}}createServiceSocket(i){let s=new oc.default.Decoder({onError:h=>{console.error("error:",h)},onMessage:h=>{cn(Buffer.from(h));let c=Ms(Buffer.from(h));if(c.protocol===6){let _=qs(c.payload);if(_.dstPort!==i.srcPort)return;i.ackNumber=_.seqNumber+_.payload.length,i.proxySocket.write(_.payload),_.payload.length>0&&rc("10.0.0.2","10.0.0.1",i.srcPort,3306,i.sequenceNumber,i.ackNumber,this.emulator),_.flags&16&&(i.sequenceNumber=Math.max(i.sequenceNumber,_.ackNumber))}}});this.emulator.add_listener("serial1-output-byte",h=>{s.decode(Buffer.from([h]))})}parseServiceOptions(i){let s=this.getServiceHostIndex(i.proxySocket);return Object.assign({port:this.servicePorts[s],host:this.serviceHosts[s],localAddress:this.options.localAddress,localPort:this.options.localPort},this.serviceTlsOptions)}getServiceHostIndex(i){this.serviceHostIndex++,this.serviceHostIndex==this.serviceHosts.length&&(this.serviceHostIndex=0);let s=this.serviceHostIndex;return this.options.serviceHostSelected&&(s=this.options.serviceHostSelected(i,s)),s}end(){this.server?.close();for(let i in this.proxySockets)this.proxySockets[i].destroy();this.server?.unref()}log(i){this.options.quiet||console.log(i)}intercept(i,s,h){return i?i(s,h):h}uniqueKey(i){return`${i.remoteAddress}:${i.remotePort}`}};function cc(o,i,s){return new Promise(h=>{let c="",_=l=>{let f=String.fromCharCode(l);f===`
`&&(c=""),c+=f,c.includes(i)&&(c="",o.remove_listener(`serial${s}-output-byte`,_),h())};o.add_listener(`serial${s}-output-byte`,_)})}async function Zt(o){await cc(o,"localhost:~#",0)}async function _c(o){await Zt(o),await qp(o),await Mp(o);let i=await o.save_state();await Op(Pp.join(pe,"/blank.state"),Buffer.from(i))}async function Mp(o){o.serial0_send(`ip link set lo up
`),await Zt(o)}async function uc(o,i){i.serial0_send(`slattach -v -L -s 115200 -p slip /dev/ttyS1   &
`),await Zt(i),i.serial0_send(`sysctl -w net.ipv4.ip_forward=1
`),await Zt(i),i.serial0_send(`ip addr add 10.0.0.1 peer 10.0.0.2 dev sl0
`),await Zt(i),i.serial0_send(`ip link set sl0 up
`),await Zt(i),i.serial0_send(`ip route add default via 10.0.0.1 dev sl0
`),await Zt(i)}async function _n(o,i){return new Us(o,"127.0.0.1",3306,i,{hostname:"127.0.0.1"})}async function qp(o){o.serial0_send(`chown mysql:mysql /run/mysqld
`),await Zt(o),o.serial0_send(`echo '10.0.0.2 mysql' >> /etc/hosts
`),await Zt(o),process.env.DEBUG?o.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
`):o.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql > /dev/ttyS2
`),await Zt(o)}async function dc(o){o.serial0_send(`setsid sh -c 'su mysql -c mysqld -s /bin/ash <> /dev/ttyS2 >&0 2>&1'
`),await Zt(o),await cc(o,"Alpine Linux",2),o.serial0_send(`mysql -uroot mysql -padmin -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.0.0.%' IDENTIFIED BY 'admin' WITH GRANT OPTION"

`),await Zt(o)}var{V86:Lp}=Fp;function mc(o){return`'${o}'`}var Jg=rh({name:"mysql",description:"Launch a MySQL/MariaDB instance",alias:"mariadb",flags:{port:{type:Number,alias:"p",default:3306,description:"Port launch MySQL on"},logs:{type:Boolean,alias:"l",default:!1,description:"Show MySQL logs"},save:{type:String,alias:"s",default:null,description:"Save state with a given name"}},parameters:[]},async o=>{if(o.flags.save==="blank"){console.log("Name 'blank' is reserved.");return}for(;await Za(o.flags.port);)console.log(`Port ${St.bold(o.flags.port)} is already in use. Trying ${St.bold(++o.flags.port)}...`);let i=o.flags.save&&!!lc(ae.join(pe,`${o.flags.save}.state`));o.flags.save?console.log(i?`Resuming instance ${St.bold(mc(o.flags.save))}`:`Creating new instance ${St.bold(mc(o.flags.save))}`):console.log("Starting temporary instance");let s=new Lp({bios:{url:ae.join(qe,"/bios/seabios.bin")},bzimage:{url:ae.join(qe,"/filesystem/efd779b5.bin")},cmdline:["rw","root=host9p rootfstype=9p rootflags=version=9p2000.L,trans=virtio,cache=loose quiet acpi=off console=ttyS0 tsc=reliable mitigations=off random.trust_cpu=on nowatchdog page_poison=on"].join(" "),wasm_path:ae.join(ys(import.meta.url),"..","..","/lib/v86.wasm"),memory_size:512*1024*1024,filesystem:{basefs:ae.join(qe,"/filesystem/filesystem.json"),baseurl:ae.join(qe,"/filesystem/")},network_relay_url:"wss://relay.widgetry.org/",autostart:!0,disable_keyboard:!0,disable_mouse:!0,disable_speaker:!0,acpi:!0,uart1:!0,uart2:!0});if(process.env.DEBUG&&s.add_listener("serial0-output-byte",_=>{let l=String.fromCharCode(_);l<="~"&&process.stdout.write(l)}),o.flags.logs){let _="";s.add_listener("serial2-output-byte",l=>{let f=String.fromCharCode(l);if(f<="~"){if(f===`
`){console.log(`  ${St.dim(_)}`),_="";return}_+=f}})}let h=0;if(process.on("SIGINT",async()=>{for(h&&console.log("State is being saved. Please wait...");h;)await new Promise(_=>setTimeout(_,100));h=2,s.stop(),process.stdin.pause(),process.exit()}),await new Promise(_=>{s.add_listener("emulator-ready",()=>{_()})}),typeof Bun<"u"){let _=setInterval(()=>s.v86.do_tick(),0);process.stdin.on("data",l=>{l.toString()===""&&clearInterval(_)})}if(lc(ae.join(pe,"blank.state"))||(console.log("Initializing blank instance on first run"),await _c(s)),i){console.log(`Restoring state from ${St.bold(o.flags.save)}`);let _=await pc(ae.join(pe,`${o.flags.save}.state`));await s.restore_state(_),_n(o.flags.port,s)}else{console.log("Loading blank instance");let _=await pc(ae.join(pe,"blank.state"));await s.restore_state(_),await dc(s),await uc(o.flags.port,s),_n(o.flags.port,s)}if(console.log(`Instance is ready on port ${St.bold(o.flags.port)}`),o.flags.save){h=1;let _=await s.save_state();await fc(ae.join(pe,`${o.flags.save}.state`),Buffer.from(_)),h=0,console.log(`Persisting state to ${St.bold(o.flags.save)}`),setInterval(async()=>{if(h>=1)return;h=1;let l=await s.save_state();await fc(ae.join(pe,`${o.flags.save}.state`),Buffer.from(l)),h=0},1e3)}else console.log(`${St.bold("Note:")} This instance is temporary and will be lost on exit.`)});export{Jg as command};
