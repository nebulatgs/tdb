var Io=Object.create;var wr=Object.defineProperty;var Do=Object.getOwnPropertyDescriptor;var Oo=Object.getOwnPropertyNames;var Mo=Object.getPrototypeOf,zo=Object.prototype.hasOwnProperty;var Ut=(c=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(c,{get:(i,n)=>(typeof require<"u"?require:i)[n]}):c)(function(c){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+c+'" is not supported')});var Po=(c,i)=>()=>(c&&(i=c(c=0)),i);var pi=(c,i)=>()=>(i||c((i={exports:{}}).exports,i),i.exports);var Lo=(c,i,n,h)=>{if(i&&typeof i=="object"||typeof i=="function")for(let d of Oo(i))!zo.call(c,d)&&d!==n&&wr(c,d,{get:()=>i[d],enumerable:!(h=Do(i,d))||h.enumerable});return c};var fi=(c,i,n)=>(n=c!=null?Io(Mo(c)):{},Lo(i||!c||!c.__esModule?wr(n,"default",{value:c,enumerable:!0}):n,c));import{createRequire as No}from"node:module";import Uo from"node:path";import qo from"node:url";var N=Po(()=>{"use strict";globalThis.require=No(import.meta.url);globalThis.__filename=qo.fileURLToPath(import.meta.url);globalThis.__dirname=Uo.dirname(__filename)});var vr=pi((br,bt)=>{"use strict";N();(function(){"use strict";function c(t,e){function s(P){return P=P.toString(16),"#"+"0".repeat(6-P.length)+P}function r(P,B,ot,st){P.style.width="",P.style.height="",st&&(P.style.transform="");var At=P.getBoundingClientRect();st?P.style.transform=(B===1?"":" scaleX("+B+")")+(ot===1?"":" scaleY("+ot+")"):(B%1===0&&ot%1===0?(o.style.imageRendering="crisp-edges",o.style.imageRendering="pixelated",o.style["-ms-interpolation-mode"]="nearest-neighbor"):(o.style.imageRendering="",o.style["-ms-interpolation-mode"]=""),st=window.devicePixelRatio||1,st%1!==0&&(B/=st,ot/=st)),B!==1&&(P.style.width=At.width*B+"px"),ot!==1&&(P.style.height=At.height*ot+"px")}console.assert(t,"1st argument must be a DOM container");var o=t.getElementsByTagName("canvas")[0],l=o.getContext("2d",{alpha:!1}),_=t.getElementsByTagName("div")[0],f=document.createElement("div"),g,y,b=1,v=1,C=1,x,F=!1,O,I,K,mt=!1,Et=this;t=new Uint16Array([8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var Co=new Uint16Array([32,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),rs=[],gr,oe=0;256>oe;oe++)gr=126<oe?t[oe-127]:32>oe?Co[oe]:oe,rs[oe]=String.fromCharCode(gr);l.imageSmoothingEnabled=!1,f.classList.add("cursor"),f.style.position="absolute",f.style.backgroundColor="#ccc",f.style.width="7px",f.style.display="inline-block",_.style.display="block",o.style.display="none",this.bus=e,e.register("screen-set-mode",function(P){this.set_mode(P)},this),e.register("screen-fill-buffer-end",function(P){this.update_buffer(P)},this),e.register("screen-put-char",function(P){this.put_char(P[0],P[1],P[2],P[3],P[4],P[5])},this),e.register("screen-update-cursor",function(P){this.update_cursor(P[0],P[1])},this),e.register("screen-update-cursor-scanline",function(P){this.update_cursor_scanline(P[0],P[1],P[2])},this),e.register("screen-clear",function(){this.clear_screen()},this),e.register("screen-set-size-text",function(P){this.set_size_text(P[0],P[1])},this),e.register("screen-set-size-graphical",function(P){this.set_size_graphical(P[0],P[1],P[2],P[3])},this),this.init=function(){this.set_size_text(80,25),this.timer()},this.make_screenshot=function(){let P=new Image;if(F)P.src=o.toDataURL("image/png");else{let B=[9,16],ot=document.createElement("canvas");ot.width=I*B[0],ot.height=K*B[1];let st=ot.getContext("2d");st.imageSmoothingEnabled=!1,st.font=window.getComputedStyle(_).font,st.textBaseline="top";for(let At=0;At<I;At++)for(let Ct=0;Ct<K;Ct++){let Ht=4*(Ct*I+At),ui=O[Ht+0],li=O[Ht+3];st.fillStyle=s(O[Ht+2]),st.fillRect(At*B[0],Ct*B[1],B[0],B[1]),st.fillStyle=s(li),st.fillText(rs[ui],At*B[0],Ct*B[1])}f.style.display!=="none"&&g<K&&y<I&&(st.fillStyle=f.style.backgroundColor,st.fillRect(y*B[0],g*B[1]+parseInt(f.style.marginTop,10),parseInt(f.style.width,10),parseInt(f.style.height,10))),P.src=ot.toDataURL("image/png")}return P},this.put_char=function(P,B,ot,st,At,Ct){P<K&&B<I&&(B=4*(P*I+B),O[B+0]=ot,O[B+1]=st,O[B+2]=At,O[B+3]=Ct,x[P]=1)},this.timer=function(){mt||requestAnimationFrame(F?Ro:To)};var To=function(){for(var P=0;P<K;P++)x[P]&&(Et.text_update_row(P),x[P]=0);this.timer()}.bind(this),Ro=function(){this.bus.send("screen-fill-buffer"),this.timer()}.bind(this);this.destroy=function(){mt=!0},this.set_mode=function(P){(F=P)?(_.style.display="none",o.style.display="block"):(_.style.display="block",o.style.display="none")},this.clear_screen=function(){l.fillStyle="#000",l.fillRect(0,0,o.width,o.height)},this.set_size_text=function(P,B){if(P!==I||B!==K){for(x=new Int8Array(B),O=new Int32Array(P*B*4),I=P,K=B;_.childNodes.length>B;)_.removeChild(_.firstChild);for(;_.childNodes.length<B;)_.appendChild(document.createElement("div"));for(P=0;P<B;P++)this.text_update_row(P);r(_,b,v,!0)}},this.set_size_graphical=function(P,B){o.style.display="block",o.width=P,o.height=B,C=640>=P&&2*P<window.innerWidth*window.devicePixelRatio&&2*B<window.innerHeight*window.devicePixelRatio?2:1,r(o,b*C,v*C,!1)},this.set_scale=function(P,B){b=P,v=B,r(_,b,v,!0),r(o,b*C,v*C,!1)},this.set_scale(b,v),this.update_cursor_scanline=function(P,B,ot){ot?(f.style.display="inline",f.style.height=B-P+"px",f.style.marginTop=P+"px"):f.style.display="none"},this.update_cursor=function(P,B){(P!==g||B!==y)&&(P<K&&(x[P]=1),g<K&&(x[g]=1),g=P,y=B)},this.text_update_row=function(P){for(var B=4*P*I,ot,st=_.childNodes[P],At=document.createElement("div"),Ct=0;Ct<I;){var Ht=document.createElement("span"),ui=O[B+1],li=O[B+2],yr=O[B+3];for(ui&&Ht.classList.add("blink"),Ht.style.backgroundColor=s(li),Ht.style.color=s(yr),ot="";Ct<I&&O[B+1]===ui&&O[B+2]===li&&O[B+3]===yr;)if(ot+=rs[O[B+0]],Ct++,B+=4,P===g){if(Ct===y)break;if(Ct===y+1){f.style.backgroundColor=Ht.style.color,At.appendChild(f);break}}Ht.textContent=ot,At.appendChild(Ht)}st.parentNode.replaceChild(At,st)},this.update_buffer=function(P){P.forEach(B=>{l.putImageData(B.image_data,B.screen_x-B.buffer_x,B.screen_y-B.buffer_y,B.buffer_x,B.buffer_y,B.buffer_width,B.buffer_height)})},this.init()}let i=["shared","exclusive","unlock"];function n(t,e,s){this.fs=t,this.bus=s,this.configspace_tagname=[104,111,115,116,57,112],this.configspace_taglen=this.configspace_tagname.length,this.VERSION="9P2000.L",this.msize=this.BLOCKSIZE=8192,this.replybuffer=new Uint8Array(2*this.msize),this.replybuffersize=0,this.fids=[],this.virtio=new ft(e,{name:"virtio-9p",pci_id:48,device_id:4169,subsystem_device_id:9,common:{initial_port:43008,queues:[{size_supported:32,notify_offset:0}],features:[0,32,29,28],on_driver_ok:()=>{}},notification:{initial_port:43264,single_handler:!1,handlers:[r=>{if(r===0){for(;this.virtqueue.has_request();)r=this.virtqueue.pop_request(),this.ReceiveRequest(r);this.virtqueue.notify_me_after(0)}}]},isr_status:{initial_port:42752},device_specific:{initial_port:42496,struct:[{bytes:2,name:"mount tag length",read:()=>this.configspace_taglen,write:()=>{}}].concat(m.range(254).map(r=>({bytes:1,name:"mount tag name "+r,read:()=>this.configspace_tagname[r]||0,write:()=>{}})))}}),this.virtqueue=this.virtio.queues[0]}n.prototype.get_state=function(){var t=[];return t[0]=this.configspace_tagname,t[1]=this.configspace_taglen,t[2]=this.virtio,t[3]=this.VERSION,t[4]=this.BLOCKSIZE,t[5]=this.msize,t[6]=this.replybuffer,t[7]=this.replybuffersize,t[8]=this.fids.map(function(e){return[e.inodeid,e.type,e.uid,e.dbg_name]}),t[9]=this.fs,t},n.prototype.set_state=function(t){this.configspace_tagname=t[0],this.configspace_taglen=t[1],this.virtio.set_state(t[2]),this.virtqueue=this.virtio.queues[0],this.VERSION=t[3],this.BLOCKSIZE=t[4],this.msize=t[5],this.replybuffer=t[6],this.replybuffersize=t[7],this.fids=t[8].map(function(e){return{inodeid:e[0],type:e[1],uid:e[2],dbg_name:e[3]}}),this.fs.set_state(t[9])},n.prototype.Createfid=function(t,e,s,r){return{inodeid:t,type:e,uid:s,dbg_name:r}},n.prototype.update_dbg_name=function(t,e){for(let s of this.fids)s.inodeid===t&&(s.dbg_name=e)},n.prototype.reset=function(){this.fids=[],this.virtio.reset()},n.prototype.BuildReply=function(t,e,s){W.Marshall(["w","b","h"],[s+7,t+1,e],this.replybuffer,0),s+7>=this.replybuffer.length&&V.Debug("Error in 9p: payloadsize exceeds maximum length"),this.replybuffersize=s+7},n.prototype.SendError=function(t,e,s){e=W.Marshall(["w"],[s],this.replybuffer,7),this.BuildReply(6,t,e)},n.prototype.SendReply=function(t){t.set_next_blob(this.replybuffer.subarray(0,this.replybuffersize)),this.virtqueue.push_reply(t),this.virtqueue.flush_replies()},n.prototype.ReceiveRequest=async function(t){var e=new Uint8Array(t.length_readable);t.get_next_blob(e);var s={offset:0},r=W.Unmarshall(["w","b","h"],e,s),o=r[0],l=r[1],_=r[2];switch(l){case 8:o=this.fs.GetTotalSize(),e=this.fs.GetSpace(),r=[16914839],r[1]=this.BLOCKSIZE,r[2]=Math.floor(e/r[1]),r[3]=r[2]-Math.floor(o/r[1]),r[4]=r[2]-Math.floor(o/r[1]),r[5]=this.fs.CountUsedInodes(),r[6]=this.fs.CountFreeInodes(),r[7]=0,r[8]=256,o=W.Marshall("wwddddddw".split(""),r,this.replybuffer,7),this.BuildReply(l,_,o),this.SendReply(t);break;case 112:case 12:r=W.Unmarshall(["w","w"],e,s);var f=r[0];s=r[1],V.Debug("[open] fid="+f+", mode="+s),e=this.fids[f].inodeid;var g=this.fs.GetInode(e);V.Debug("file open "+this.fids[f].dbg_name),o=this.fs.OpenInode(e,s),this.fs.AddEvent(this.fids[f].inodeid,function(){V.Debug("file opened "+this.fids[f].dbg_name+" tag:"+_);var C=[];C[0]=g.qid,C[1]=this.msize-24,W.Marshall(["Q","w"],C,this.replybuffer,7),this.BuildReply(l,_,17),this.SendReply(t)}.bind(this));break;case 70:if(r=W.Unmarshall(["w","w","s"],e,s),e=r[0],f=r[1],o=r[2],V.Debug("[link] dfid="+e+", name="+o),o=this.fs.Link(this.fids[e].inodeid,this.fids[f].inodeid,o),0>o){this.SendError(_,o===-1?"Operation not permitted":"Unknown error: "+-o,-o),this.SendReply(t);break}this.BuildReply(l,_,0),this.SendReply(t);break;case 16:r=W.Unmarshall(["w","s","s","w"],e,s),f=r[0],o=r[1],e=r[2],r=r[3],V.Debug("[symlink] fid="+f+", name="+o+", symgt="+e+", gid="+r),e=this.fs.CreateSymlink(o,this.fids[f].inodeid,e),g=this.fs.GetInode(e),g.uid=this.fids[f].uid,g.gid=r,W.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(l,_,13),this.SendReply(t);break;case 18:r=W.Unmarshall("wswwww".split(""),e,s),f=r[0],o=r[1],s=r[2],e=r[3];var y=r[4];r=r[5],V.Debug("[mknod] fid="+f+", name="+o+", major="+e+", minor="+y),e=this.fs.CreateNode(o,this.fids[f].inodeid,e,y),g=this.fs.GetInode(e),g.mode=s,g.uid=this.fids[f].uid,g.gid=r,W.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(l,_,13),this.SendReply(t);break;case 22:r=W.Unmarshall(["w"],e,s),f=r[0],g=this.fs.GetInode(this.fids[f].inodeid),V.Debug("[readlink] fid="+f+" name="+this.fids[f].dbg_name+" target="+g.symlink),o=W.Marshall(["s"],[g.symlink],this.replybuffer,7),this.BuildReply(l,_,o),this.SendReply(t);break;case 72:r=W.Unmarshall(["w","s","w","w"],e,s),f=r[0],o=r[1],s=r[2],r=r[3],V.Debug("[mkdir] fid="+f+", name="+o+", mode="+s+", gid="+r),e=this.fs.CreateDirectory(o,this.fids[f].inodeid),g=this.fs.GetInode(e),g.mode=s|Nt,g.uid=this.fids[f].uid,g.gid=r,W.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(l,_,13),this.SendReply(t);break;case 14:r=W.Unmarshall(["w","s","w","w","w"],e,s),f=r[0],o=r[1],e=r[2],s=r[3],r=r[4],this.bus.send("9p-create",[o,this.fids[f].inodeid]),V.Debug("[create] fid="+f+", name="+o+", flags="+e+", mode="+s+", gid="+r),e=this.fs.CreateFile(o,this.fids[f].inodeid),this.fids[f].inodeid=e,this.fids[f].type=1,this.fids[f].dbg_name=o,g=this.fs.GetInode(e),g.uid=this.fids[f].uid,g.gid=r,g.mode=s|_e,W.Marshall(["Q","w"],[g.qid,this.msize-24],this.replybuffer,7),this.BuildReply(l,_,17),this.SendReply(t);break;case 52:r=W.Unmarshall("wbwddws".split(""),e,s),f=r[0],e=r[2],o=r[4]===0?1/0:r[4],r=this.fs.DescribeLock(r[1],r[3],o,r[5],r[6]),V.Debug("[lock] fid="+f+", type="+i[r.type]+", start="+r.start+", length="+r.length+", proc_id="+r.proc_id),o=this.fs.Lock(this.fids[f].inodeid,r,e),W.Marshall(["b"],[o],this.replybuffer,7),this.BuildReply(l,_,1),this.SendReply(t);break;case 54:r=W.Unmarshall("wbddws".split(""),e,s),f=r[0],o=r[3]===0?1/0:r[3],r=this.fs.DescribeLock(r[1],r[2],o,r[4],r[5]),V.Debug("[getlock] fid="+f+", type="+i[r.type]+", start="+r.start+", length="+r.length+", proc_id="+r.proc_id),o=this.fs.GetLock(this.fids[f].inodeid,r),o||(o=r,o.type=2),o=W.Marshall(["b","d","d","w","s"],[o.type,o.start,o.length===1/0?0:o.length,o.proc_id,o.client_id],this.replybuffer,7),this.BuildReply(l,_,o),this.SendReply(t);break;case 24:if(r=W.Unmarshall(["w","d"],e,s),f=r[0],g=this.fs.GetInode(this.fids[f].inodeid),V.Debug("[getattr]: fid="+f+" name="+this.fids[f].dbg_name+" request mask="+r[1]),!g||g.status===di){V.Debug("getattr: unlinked"),this.SendError(_,"No such file or directory",2),this.SendReply(t);break}r[0]=r[1],r[1]=g.qid,r[2]=g.mode,r[3]=g.uid,r[4]=g.gid,r[5]=g.nlinks,r[6]=g.major<<8|g.minor,r[7]=g.size,r[8]=this.BLOCKSIZE,r[9]=Math.floor(g.size/512+1),r[10]=g.atime,r[11]=0,r[12]=g.mtime,r[13]=0,r[14]=g.ctime,r[15]=0,r[16]=0,r[17]=0,r[18]=0,r[19]=0,W.Marshall("dQwwwddddddddddddddd".split(""),r,this.replybuffer,7),this.BuildReply(l,_,153),this.SendReply(t);break;case 26:r=W.Unmarshall("wwwwwddddd".split(""),e,s),f=r[0],g=this.fs.GetInode(this.fids[f].inodeid),V.Debug("[setattr]: fid="+f+" request mask="+r[1]+" name="+this.fids[f].dbg_name),r[1]&1&&(g.mode=r[2]),r[1]&2&&(g.uid=r[3]),r[1]&4&&(g.gid=r[4]),r[1]&16&&(g.atime=Math.floor(new Date().getTime()/1e3)),r[1]&32&&(g.mtime=Math.floor(new Date().getTime()/1e3)),r[1]&64&&(g.ctime=Math.floor(new Date().getTime()/1e3)),r[1]&128&&(g.atime=r[6]),r[1]&256&&(g.mtime=r[8]),r[1]&8&&await this.fs.ChangeSize(this.fids[f].inodeid,r[5]),this.BuildReply(l,_,0),this.SendReply(t);break;case 50:r=W.Unmarshall(["w","d"],e,s),f=r[0],this.BuildReply(l,_,0),this.SendReply(t);break;case 40:case 116:if(r=W.Unmarshall(["w","d","w"],e,s),f=r[0],o=r[1],y=r[2],g=this.fs.GetInode(this.fids[f].inodeid),l===40&&V.Debug("[treaddir]: fid="+f+" offset="+o+" count="+y),l===116&&V.Debug("[read]: fid="+f+" ("+this.fids[f].dbg_name+") offset="+o+" count="+y+" fidtype="+this.fids[f].type),!g||g.status===di){V.Debug("read/treaddir: unlinked"),this.SendError(_,"No such file or directory",2),this.SendReply(t);break}if(this.fids[f].type===2)for(g.caps.length<o+y&&(y=g.caps.length-o),r=0;r<y;r++)this.replybuffer[11+r]=g.caps[o+r];else this.fs.OpenInode(this.fids[f].inodeid,void 0),r=this.fids[f].inodeid,y=Math.min(y,this.replybuffer.length-11),g.size<o+y?y=g.size-o:l===40&&(y=this.fs.RoundToDirentry(r,o+y)-o),o>g.size&&(y=0),this.bus.send("9p-read-start",[this.fids[f].dbg_name]),r=await this.fs.Read(r,o,y),this.bus.send("9p-read-end",[this.fids[f].dbg_name,y]),r&&this.replybuffer.set(r,11);W.Marshall(["w"],[y],this.replybuffer,7),this.BuildReply(l,_,4+y),this.SendReply(t);break;case 118:if(r=W.Unmarshall(["w","d","w"],e,s),f=r[0],o=r[1],y=r[2],r=this.fids[f].dbg_name,V.Debug("[write]: fid="+f+" ("+r+") offset="+o+" count="+y+" fidtype="+this.fids[f].type),this.fids[f].type===2){this.SendError(_,"Setxattr not supported",95),this.SendReply(t);break}else await this.fs.Write(this.fids[f].inodeid,o,y,e.subarray(s.offset));this.bus.send("9p-write-end",[r,y]),W.Marshall(["w"],[y],this.replybuffer,7),this.BuildReply(l,_,4),this.SendReply(t);break;case 74:if(r=W.Unmarshall(["w","s","w","s"],e,s),o=r[0],e=r[1],s=r[2],r=r[3],V.Debug("[renameat]: oldname="+e+" newname="+r),o=await this.fs.Rename(this.fids[o].inodeid,e,this.fids[s].inodeid,r),0>o){this.SendError(_,o===-2?"No such file or directory":o===-1?"Operation not permitted":o===-39?"Directory not empty":"Unknown error: "+-o,-o),this.SendReply(t);break}this.BuildReply(l,_,0),this.SendReply(t);break;case 76:if(r=W.Unmarshall(["w","s","w"],e,s),s=r[0],o=r[1],e=r[2],V.Debug("[unlink]: dirfd="+s+" name="+o+" flags="+e),f=this.fs.Search(this.fids[s].inodeid,o),f===-1){this.SendError(_,"No such file or directory",2),this.SendReply(t);break}if(o=this.fs.Unlink(this.fids[s].inodeid,o),0>o){this.SendError(_,o===-39?"Directory not empty":o===-1?"Operation not permitted":"Unknown error: "+-o,-o),this.SendReply(t);break}this.BuildReply(l,_,0),this.SendReply(t);break;case 100:r=W.Unmarshall(["w","s"],e,s),V.Debug("[version]: msize="+r[0]+" version="+r[1]),this.msize!==r[0]&&(this.msize=r[0],this.replybuffer=new Uint8Array(Math.min(16777216,2*this.msize))),o=W.Marshall(["w","s"],[this.msize,this.VERSION],this.replybuffer,7),this.BuildReply(l,_,o),this.SendReply(t);break;case 104:r=W.Unmarshall(["w","w","s","s","w"],e,s),f=r[0],o=r[4],V.Debug("[attach]: fid="+f+" afid="+a(r[1])+" uname="+r[2]+" aname="+r[3]),this.fids[f]=this.Createfid(0,1,o,""),g=this.fs.GetInode(this.fids[f].inodeid),W.Marshall(["Q"],[g.qid],this.replybuffer,7),this.BuildReply(l,_,13),this.SendReply(t),this.bus.send("9p-attach");break;case 108:r=W.Unmarshall(["h"],e,s),V.Debug("[flush] "+_),this.BuildReply(l,_,0),this.SendReply(t);break;case 110:r=W.Unmarshall(["w","w","h"],e,s),f=r[0],y=r[1];var b=r[2];if(V.Debug("[walk]: fid="+r[0]+" nwfid="+r[1]+" nwname="+b),b===0){this.fids[y]=this.Createfid(this.fids[f].inodeid,1,this.fids[f].uid,this.fids[f].dbg_name),W.Marshall(["h"],[0],this.replybuffer,7),this.BuildReply(l,_,2),this.SendReply(t);break}for(o=[],r=0;r<b;r++)o.push("s");s=W.Unmarshall(o,e,s),e=this.fids[f].inodeid,o=9;var v=0;for(V.Debug("walk in dir "+this.fids[f].dbg_name+" to: "+s.toString()),r=0;r<b;r++){if(e=this.fs.Search(e,s[r]),e===-1){V.Debug("Could not find: "+s[r]);break}o+=W.Marshall(["Q"],[this.fs.GetInode(e).qid],this.replybuffer,o),v++,this.fids[y]=this.Createfid(e,1,this.fids[f].uid,s[r])}W.Marshall(["h"],[v],this.replybuffer,7),this.BuildReply(l,_,o-7),this.SendReply(t);break;case 120:r=W.Unmarshall(["w"],e,s),V.Debug("[clunk]: fid="+r[0]),this.fids[r[0]]&&0<=this.fids[r[0]].inodeid&&(await this.fs.CloseInode(this.fids[r[0]].inodeid),this.fids[r[0]].inodeid=-1,this.fids[r[0]].type=-1),this.BuildReply(l,_,0),this.SendReply(t);break;case 32:r=W.Unmarshall(["w","s","d","w"],e,s),f=r[0],o=r[1],s=r[2],e=r[3],V.Debug("[txattrcreate]: fid="+f+" name="+o+" attr_size="+s+" flags="+e),this.fids[f].type=2,this.BuildReply(l,_,0),this.SendReply(t);break;case 30:r=W.Unmarshall(["w","w","s"],e,s),f=r[0],o=r[2],V.Debug("[xattrwalk]: fid="+r[0]+" newfid="+r[1]+" name="+r[2]),this.SendError(_,"Setxattr not supported",95),this.SendReply(t);break;default:V.Debug("Error in Virtio9p: Unknown id "+l+" received"),V.Abort()}};function h(t){this.ports=[],this.cpu=t;for(var e=0;65536>e;e++)this.ports[e]=this.create_empty_entry();var s=t.memory_size[0];for(e=0;e<<17<s;e++)t.memory_map_read8[e]=t.memory_map_write8[e]=void 0,t.memory_map_read32[e]=t.memory_map_write32[e]=void 0;this.mmap_register(s,4294967296-s,function(r){return a(r>>>0,8),255},function(r,o){a(r>>>0,8),a(o,2)},function(r){return a(r>>>0,8),-1},function(r,o){a(r>>>0,8),a(o>>>0,8)})}h.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}},h.prototype.empty_port_read8=function(){return 255},h.prototype.empty_port_read16=function(){return 65535},h.prototype.empty_port_read32=function(){return-1},h.prototype.empty_port_write=function(){},h.prototype.register_read=function(t,e,s,r,o){s&&(this.ports[t].read8=s),r&&(this.ports[t].read16=r),o&&(this.ports[t].read32=o),this.ports[t].device=e},h.prototype.register_write=function(t,e,s,r,o){s&&(this.ports[t].write8=s),r&&(this.ports[t].write16=r),o&&(this.ports[t].write32=o),this.ports[t].device=e},h.prototype.register_read_consecutive=function(t,e,s,r,o,l){function _(){return s.call(this)|r.call(this)<<8}function f(){return o.call(this)|l.call(this)<<8}function g(){return s.call(this)|r.call(this)<<8|o.call(this)<<16|l.call(this)<<24}o&&l?(this.register_read(t,e,s,_,g),this.register_read(t+1,e,r),this.register_read(t+2,e,o,f),this.register_read(t+3,e,l)):(this.register_read(t,e,s,_),this.register_read(t+1,e,r))},h.prototype.register_write_consecutive=function(t,e,s,r,o,l){function _(y){s.call(this,y&255),r.call(this,y>>8&255)}function f(y){o.call(this,y&255),l.call(this,y>>8&255)}function g(y){s.call(this,y&255),r.call(this,y>>8&255),o.call(this,y>>16&255),l.call(this,y>>>24)}o&&l?(this.register_write(t,e,s,_,g),this.register_write(t+1,e,r),this.register_write(t+2,e,o,f),this.register_write(t+3,e,l)):(this.register_write(t,e,s,_),this.register_write(t+1,e,r))},h.prototype.mmap_read32_shim=function(t){var e=this.cpu.memory_map_read8[t>>>17];return e(t)|e(t+1)<<8|e(t+2)<<16|e(t+3)<<24},h.prototype.mmap_write32_shim=function(t,e){var s=this.cpu.memory_map_write8[t>>>17];s(t,e&255),s(t+1,e>>8&255),s(t+2,e>>16&255),s(t+3,e>>>24)},h.prototype.mmap_register=function(t,e,s,r,o,l){for(a(t>>>0,8),a(e,8),o||(o=this.mmap_read32_shim.bind(this)),l||(l=this.mmap_write32_shim.bind(this)),t>>>=17;0<e;t++)this.cpu.memory_map_read8[t]=s,this.cpu.memory_map_write8[t]=r,this.cpu.memory_map_read32[t]=o,this.cpu.memory_map_write32[t]=l,e-=131072},h.prototype.port_write8=function(t,e){var s=this.ports[t];return s.write8===this.empty_port_write&&(a(t,4),a(e,2),this.get_port_description(t)),s.write8.call(s.device,e)},h.prototype.port_write16=function(t,e){var s=this.ports[t];return s.write16===this.empty_port_write&&(a(t,4),a(e,4),this.get_port_description(t)),s.write16.call(s.device,e)},h.prototype.port_write32=function(t,e){var s=this.ports[t];return s.write32===this.empty_port_write&&(a(t,4),a(e>>>0,8),this.get_port_description(t)),s.write32.call(s.device,e)},h.prototype.port_read8=function(t){var e=this.ports[t];return e.read8===this.empty_port_read8&&(a(t,4),this.get_port_description(t)),e=e.read8.call(e.device),a(t),e},h.prototype.port_read16=function(t){var e=this.ports[t];return e.read16===this.empty_port_read16&&(a(t,4),this.get_port_description(t)),e=e.read16.call(e.device),a(t),e},h.prototype.port_read32=function(t){var e=this.ports[t];return e.read32===this.empty_port_read32&&(a(t,4),this.get_port_description(t)),e.read32.call(e.device)};var d={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1e3:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};h.prototype.get_port_description=function(t){return d[t]?"  ("+d[t]+")":""};function u(t,e){this.stopping=this.running=!1,this.idle=!0,this.tick_counter=0,this.worker=null,this.cpu=new $(t,e,()=>{this.idle&&this.next_tick(0)}),this.bus=t,t.register("cpu-init",this.init,this),t.register("cpu-run",this.run,this),t.register("cpu-stop",this.stop,this),t.register("cpu-restart",this.restart,this),this.register_yield()}if(u.prototype.run=function(){this.stopping=!1,this.running||(this.running=!0,this.bus.send("emulator-started")),this.next_tick(0)},u.prototype.do_tick=function(){if(this.stopping||!this.running)this.stopping=this.running=!1,this.bus.send("emulator-stopped");else{this.idle=!1;var t=this.cpu.main_loop();this.next_tick(t)}},u.prototype.next_tick=function(t){let e=++this.tick_counter;this.idle=!0,this.yield(t,e)},u.prototype.yield_callback=function(t){t===this.tick_counter&&this.do_tick()},u.prototype.stop=function(){this.running&&(this.stopping=!0)},u.prototype.destroy=function(){this.unregister_yield()},u.prototype.restart=function(){this.cpu.reset_cpu(),this.cpu.load_bios()},u.prototype.init=function(t){this.cpu.init(t,this.bus),this.bus.send("emulator-ready")},typeof process<"u")u.prototype.yield=function(t,e){typeof Bun>"u"&&(1>t?global.setImmediate(s=>this.yield_callback(s),e):setTimeout(s=>this.yield_callback(s),t,e))},u.prototype.register_yield=function(){},u.prototype.unregister_yield=function(){};else if(typeof Worker<"u"){let t=function(){let e;globalThis.onmessage=function(s){let r=s.data.t;e=e&&clearTimeout(e),1>r?postMessage(s.data.tick):e=setTimeout(()=>postMessage(s.data.tick),r)}};u.prototype.register_yield=function(){let e=URL.createObjectURL(new Blob(["("+t.toString()+")()"],{type:"text/javascript"}));this.worker=new Worker(e),this.worker.onmessage=s=>this.yield_callback(s.data),URL.revokeObjectURL(e)},u.prototype.yield=function(e,s){this.worker.postMessage({t:e,tick:s})},u.prototype.unregister_yield=function(){this.worker&&this.worker.terminate(),this.worker=null}}else u.prototype.yield=function(t){setTimeout(()=>{this.do_tick()},t)},u.prototype.register_yield=function(){},u.prototype.unregister_yield=function(){};if(u.prototype.save_state=function(){return this.cpu.save_state()},u.prototype.restore_state=function(t){return this.cpu.restore_state(t)},typeof performance=="object"&&performance.now)u.microtick=performance.now.bind(performance);else if(typeof Ut=="function"){let{performance:t}=Ut("perf_hooks");u.microtick=t.now.bind(t)}else u.microtick=typeof process=="object"&&process.hrtime?function(){var t=process.hrtime();return 1e3*t[0]+t[1]/1e6}:Date.now;var p=p||{};p.exportSymbol=function(){},p.exportProperty=function(){};var m=m||{};m.pads=function(t,e){return(t||t===0?t+"":"").padEnd(e," ")},m.pad0=function(t,e){return(t||t===0?t+"":"").padStart(e,"0")},m.zeros=function(t){return Array(t).fill(0)},m.range=function(t){return Array.from(Array(t).keys())},m.view=function(t,e,s,r){return new Proxy({},{get:function(o,l){o=new t(e.buffer,s,r);let _=o[l];return typeof _=="function"?_.bind(o):(/^\d+$/.test(l),_)},set:function(o,l,_){return/^\d+$/.test(l),new t(e.buffer,s,r)[l]=_,!0}})};function a(t,e){return t=t?t.toString(16):"","0x"+m.pad0(t.toUpperCase(),e||1)}if(typeof crypto<"u"&&crypto.getRandomValues){let t=new Int32Array(1);m.get_rand_int=function(){return crypto.getRandomValues(t),t[0]}}else if(typeof Ut<"u"){let t=Ut("crypto");m.get_rand_int=function(){return t.randomBytes(4).readInt32LE(0)}}(function(){if(typeof Math.clz32=="function")m.int_log2_byte=function(r){return 31-Math.clz32(r)},m.int_log2=function(r){return 31-Math.clz32(r)};else{for(var t=new Int8Array(256),e=0,s=-2;256>e;e++)e&e-1||s++,t[e]=s;m.int_log2_byte=function(r){return t[r]},m.int_log2=function(r){r>>>=0;var o=r>>>16;if(o){var l=o>>>8;return l?24+t[l]:16+t[o]}return(l=r>>>8)?8+t[l]:t[r]}}})();function w(t){var e=new Uint8Array(t),s,r;this.length=0,this.push=function(o){this.length!==t&&this.length++,e[r]=o,r=r+1&t-1},this.shift=function(){if(this.length){var o=e[s];return s=s+1&t-1,this.length--,o}return-1},this.peek=function(){return this.length?e[s]:-1},this.clear=function(){this.length=r=s=0},this.clear()}function k(t){this.size=t,this.data=new Float32Array(t),this.length=this.end=this.start=0}k.prototype.push=function(t){this.length===this.size?this.start=this.start+1&this.size-1:this.length++,this.data[this.end]=t,this.end=this.end+1&this.size-1},k.prototype.shift=function(){if(this.length){var t=this.data[this.start];return this.start=this.start+1&this.size-1,this.length--,t}},k.prototype.shift_block=function(t){var e=new Float32Array(t);t>this.length&&(t=this.length);var s=this.start+t,r=this.data.subarray(this.start,s);return e.set(r),s>=this.size&&(s-=this.size,e.set(this.data.subarray(0,s),r.length)),this.start=s,this.length-=t,e},k.prototype.peek=function(){if(this.length)return this.data[this.start]},k.prototype.clear=function(){this.length=this.end=this.start=0},m.Bitmap=function(t){typeof t=="number"?this.view=new Uint8Array(t+7>>3):t instanceof ArrayBuffer&&(this.view=new Uint8Array(t))},m.Bitmap.prototype.set=function(t,e){let s=t>>3;t=1<<(t&7),this.view[s]=e?this.view[s]|t:this.view[s]&~t},m.Bitmap.prototype.get=function(t){return this.view[t>>3]>>(t&7)&1},m.Bitmap.prototype.get_buffer=function(){return this.view.buffer},m.load_file=typeof XMLHttpRequest>"u"?E:S;function S(t,e,s){function r(){let g=s||0;setTimeout(()=>{S(t,e,g+1)},1e3*([1,1,2,3,5,8,13,21][g]||34))}var o=new XMLHttpRequest;if(o.open(e.method||"get",t,!0),o.responseType=e.as_json?"json":"arraybuffer",e.headers)for(var l=Object.keys(e.headers),_=0;_<l.length;_++){var f=l[_];o.setRequestHeader(f,e.headers[f])}e.range&&(l=e.range.start,o.setRequestHeader("Range","bytes="+l+"-"+(l+e.range.length-1)),o.setRequestHeader("X-Accept-Encoding","identity"),o.onreadystatechange=function(){o.status===200&&o.abort()}),o.onload=function(){if(o.readyState===4){if(o.status!==200&&o.status!==206)console.error("Loading the image "+t+" failed (status %d)",o.status),500<=o.status&&600>o.status&&r();else if(o.response){if(e.range){let g=o.getResponseHeader("Content-Encoding");g&&g!=="identity"&&console.error("Server sent Content-Encoding in response to ranged request",{filename:t,enc:g})}e.done&&e.done(o.response,o)}}},o.onerror=function(g){console.error("Loading the image "+t+" failed",g),r()},e.progress&&(o.onprogress=function(g){e.progress(g)}),o.send(null)}function E(t,e){let s=Ut("fs");e.range?s.open(t,"r",(r,o)=>{if(r)throw r;r=e.range.length;var l=Buffer.allocUnsafe(r);s.read(o,l,0,r,e.range.start,_=>{if(_)throw _;e.done&&e.done(new Uint8Array(l)),s.close(o,f=>{if(f)throw f})})}):s.readFile(t,{encoding:e.as_json?"utf-8":null},function(r,o){r?console.log("Could not read file:",t,r):(r=o,r=e.as_json?JSON.parse(r):new Uint8Array(r).buffer,e.done(r))})}m.read_sized_string_from_mem=function(t,e,s){return String.fromCharCode(...new Uint8Array(t.buffer,e>>>0,s>>>0))},function(){function t(_){this.buffer=_,this.byteLength=_.byteLength,this.onprogress=this.onload=void 0}function e(_,f,g){this.filename=_,this.byteLength=f,this.block_cache=new Map,this.block_cache_is_write=new Set,this.fixed_chunk_size=g,this.cache_reads=!!g,this.onprogress=this.onload=void 0}function s(_,f,g,y,b){let v=_.match(/\.[^\.]+(\.zst)?$/);this.extension=v?v[0]:"",this.basename=_.substring(0,_.length-this.extension.length),this.is_zstd=this.extension.endsWith(".zst"),this.basename.endsWith("/")||(this.basename+="-"),this.block_cache=new Map,this.block_cache_is_write=new Set,this.byteLength=f,this.fixed_chunk_size=g,this.partfile_alt_format=!!y,this.zstd_decompress=b,this.cache_reads=!!g,this.onprogress=this.onload=void 0}function r(_){this.file=_,this.byteLength=_.size,1073741824<_.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(_.size>>20)+" MB ..."),this.buffer=new ArrayBuffer(_.size),this.onprogress=this.onload=void 0}function o(_){this.file=_,this.byteLength=_.size,this.block_cache=new Map,this.block_cache_is_write=new Set,this.onprogress=this.onload=void 0}m.SyncBuffer=t,m.AsyncXHRBuffer=e,m.AsyncXHRPartfileBuffer=s,m.AsyncFileBuffer=o,m.SyncFileBuffer=r,m.buffer_from_object=function(_,f){if(_.buffer instanceof ArrayBuffer)return new m.SyncBuffer(_.buffer);if(typeof File<"u"&&_.buffer instanceof File)return f=_.async,f===void 0&&(f=268435456<=_.buffer.size),f?new m.AsyncFileBuffer(_.buffer):new m.SyncFileBuffer(_.buffer);if(_.url)return _.use_parts?new m.AsyncXHRPartfileBuffer(_.url,_.size,_.fixed_chunk_size,!1,f):new m.AsyncXHRBuffer(_.url,_.size,_.fixed_chunk_size)},t.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})},t.prototype.get=function(_,f,g){g(new Uint8Array(this.buffer,_,f))},t.prototype.set=function(_,f,g){new Uint8Array(this.buffer,_,f.byteLength).set(f),g()},t.prototype.get_buffer=function(_){_(this.buffer)},t.prototype.get_state=function(){let _=[];return _[0]=this.byteLength,_[1]=new Uint8Array(this.buffer),_},t.prototype.set_state=function(_){this.byteLength=_[0],this.buffer=_[1].slice().buffer},e.prototype.load=function(){this.byteLength!==void 0?this.onload&&this.onload(Object.create(null)):l(this.filename,(_,f)=>{if(_)throw Error("Cannot use: "+this.filename+". "+_);this.byteLength=f,this.onload&&this.onload(Object.create(null))})},e.prototype.get_from_cache=function(_,f){var g=f/256;_/=256;for(var y=0;y<g;y++)if(!this.block_cache.get(_+y))return;if(g===1)return this.block_cache.get(_);for(f=new Uint8Array(f),y=0;y<g;y++)f.set(this.block_cache.get(_+y),256*y);return f},e.prototype.get=function(_,f,g){var y=this.get_from_cache(_,f);if(y)g(y);else{var b=_,v=f;this.fixed_chunk_size&&(b=_-_%this.fixed_chunk_size,v=Math.ceil((_-b+f)/this.fixed_chunk_size)*this.fixed_chunk_size),m.load_file(this.filename,{done:function(C){C=new Uint8Array(C),this.handle_read(b,v,C),g(b===_&&v===f?C:C.subarray(_-b,_-b+f))}.bind(this),range:{start:b,length:v}})}},e.prototype.set=function(_,f,g){_/=256;for(var y=f.length/256,b=0;b<y;b++){var v=this.block_cache.get(_+b);if(v===void 0)v=f.slice(256*b,256*(b+1)),this.block_cache.set(_+b,v);else{let C=f.subarray(256*b,256*(b+1));v.set(C)}this.block_cache_is_write.add(_+b)}g()},e.prototype.handle_read=function(_,f,g){_/=256,f/=256;for(var y=0;y<f;y++){let b=this.block_cache.get(_+y);b?g.set(b,256*y):this.cache_reads&&this.block_cache.set(_+y,g.slice(256*y,256*(y+1)))}},e.prototype.get_buffer=function(_){_()},e.prototype.get_state=function(){let _=[],f=[];for(let[g,y]of this.block_cache)isFinite(g),this.block_cache_is_write.has(g)&&f.push([g,y]);return _[0]=f,_},e.prototype.set_state=function(_){_=_[0],this.block_cache.clear(),this.block_cache_is_write.clear();for(let[f,g]of _)isFinite(f),this.block_cache.set(f,g),this.block_cache_is_write.add(f)},s.prototype.load=function(){this.onload&&this.onload(Object.create(null))},s.prototype.get=function(_,f,g){var y=this.get_from_cache(_,f);if(y)g(y);else if(this.fixed_chunk_size){let v=Math.floor(_/this.fixed_chunk_size),C=_-v*this.fixed_chunk_size,x=Math.ceil((C+f)/this.fixed_chunk_size),F=new Uint8Array(x*this.fixed_chunk_size),O=0;for(let I=0;I<x;I++){var b=(v+I)*this.fixed_chunk_size;y=this.partfile_alt_format?this.basename+(v+I+"").padStart(8,"0")+this.extension:this.basename+b+"-"+(b+this.fixed_chunk_size)+this.extension,(b=this.get_from_cache(b,this.fixed_chunk_size))?(F.set(b,I*this.fixed_chunk_size),O++,O===x&&g(F.subarray(C,C+f))):m.load_file(y,{done:async function(K){K=new Uint8Array(K),this.is_zstd&&(K=await this.zstd_decompress(this.fixed_chunk_size,K),K=new Uint8Array(K)),F.set(K,I*this.fixed_chunk_size),this.handle_read((v+I)*this.fixed_chunk_size,this.fixed_chunk_size|0,K),O++,O===x&&g(F.subarray(C,C+f))}.bind(this)})}}else m.load_file(this.basename+_+"-"+(_+f)+this.extension,{done:function(v){v=new Uint8Array(v),this.handle_read(_,f,v),g(v)}.bind(this)})},s.prototype.get_from_cache=e.prototype.get_from_cache,s.prototype.set=e.prototype.set,s.prototype.handle_read=e.prototype.handle_read,s.prototype.get_state=e.prototype.get_state,s.prototype.set_state=e.prototype.set_state,r.prototype.load=function(){this.load_next(0)},r.prototype.load_next=function(_){var f=new FileReader;if(f.onload=function(y){y=new Uint8Array(y.target.result),new Uint8Array(this.buffer,_).set(y),this.load_next(_+4194304)}.bind(this),this.onprogress&&this.onprogress({loaded:_,total:this.byteLength,lengthComputable:!0}),_<this.byteLength){var g=this.file.slice(_,Math.min(_+4194304,this.byteLength));f.readAsArrayBuffer(g)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})},r.prototype.get=t.prototype.get,r.prototype.set=t.prototype.set,r.prototype.get_buffer=t.prototype.get_buffer,r.prototype.get_state=t.prototype.get_state,r.prototype.set_state=t.prototype.set_state,o.prototype.load=function(){this.onload&&this.onload(Object.create(null))},o.prototype.get=function(_,f,g){var y=this.get_from_cache(_,f);y?g(y):(y=new FileReader,y.onload=function(b){b=new Uint8Array(b.target.result),this.handle_read(_,f,b),g(b)}.bind(this),y.readAsArrayBuffer(this.file.slice(_,_+f)))},o.prototype.get_from_cache=e.prototype.get_from_cache,o.prototype.set=e.prototype.set,o.prototype.handle_read=e.prototype.handle_read,o.prototype.get_state=e.prototype.get_state,o.prototype.set_state=e.prototype.set_state,o.prototype.get_buffer=function(_){_()},o.prototype.get_as_file=function(_){for(var f=[],g=Array.from(this.block_cache.keys()).sort(function(x,F){return x-F}),y=0,b=0;b<g.length;b++){var v=g[b],C=this.block_cache.get(v);v*=256,v!==y&&(f.push(this.file.slice(y,v)),y=v),f.push(C),y+=C.length}return y!==this.file.size&&f.push(this.file.slice(y)),new File(f,_)};var l=typeof XMLHttpRequest>"u"?function(_,f){Ut("fs").stat(_,(g,y)=>{g?f(g):f(null,y.size)})}:function(_,f){m.load_file(_,{done:(g,y)=>{g=y.getResponseHeader("Content-Range")||"",(y=g.match(/\/(\d+)\s*$/))?f(null,+y[1]):f("`Range: bytes=...` header not supported (Got `"+g+"`)")},headers:{Range:"bytes=0-0","X-Accept-Encoding":"identity"}})}}();function A(t,e,s,r,o,l){this.master=new T(this,t,e,r,o,0,l),this.slave=new T(this,t,s,!1,o,1,l),this.current_interface=this.master,this.cpu=t,o===0?(this.ata_port=496,this.irq=14,this.pci_id=240):o===1&&(this.ata_port=368,this.irq=15,this.pci_id=248),this.ata_port_high=this.ata_port|516,this.master_port=46080,this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,this.ata_port&255|1,this.ata_port>>8,0,0,this.ata_port_high&255|1,this.ata_port_high>>8,0,0,0,0,0,0,0,0,0,0,this.master_port&255|1,this.master_port>>8,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,this.irq,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_bars=[{size:8},{size:4},void 0,void 0,{size:16}],this.name="ide"+o,this.device_control=2,t.io.register_read(this.ata_port|7,this,function(){return this.cpu.device_lower_irq(this.irq),this.read_status()}),t.io.register_read(this.ata_port_high|2,this,this.read_status),t.io.register_write(this.ata_port_high|2,this,this.write_control),t.io.register_read(this.ata_port|0,this,function(){return this.current_interface.read_data(1)},function(){return this.current_interface.read_data(2)},function(){return this.current_interface.read_data(4)}),t.io.register_read(this.ata_port|1,this,function(){return a(this.current_interface.error&255),this.current_interface.error&255}),t.io.register_read(this.ata_port|2,this,function(){return a(this.current_interface.bytecount&255),this.current_interface.bytecount&255}),t.io.register_read(this.ata_port|3,this,function(){return a(this.current_interface.sector&255),this.current_interface.sector&255}),t.io.register_read(this.ata_port|4,this,function(){return a(this.current_interface.cylinder_low&255),this.current_interface.cylinder_low&255}),t.io.register_read(this.ata_port|5,this,function(){return a(this.current_interface.cylinder_high&255),this.current_interface.cylinder_high&255}),t.io.register_read(this.ata_port|6,this,function(){return this.current_interface.drive_head&255}),t.io.register_write(this.ata_port|0,this,function(_){this.current_interface.write_data_port8(_)},function(_){this.current_interface.write_data_port16(_)},function(_){this.current_interface.write_data_port32(_)}),t.io.register_write(this.ata_port|1,this,function(_){a(_),this.master.lba_count=(this.master.lba_count<<8|_)&65535,this.slave.lba_count=(this.slave.lba_count<<8|_)&65535}),t.io.register_write(this.ata_port|2,this,function(_){a(_),this.master.bytecount=(this.master.bytecount<<8|_)&65535,this.slave.bytecount=(this.slave.bytecount<<8|_)&65535}),t.io.register_write(this.ata_port|3,this,function(_){a(_),this.master.sector=(this.master.sector<<8|_)&65535,this.slave.sector=(this.slave.sector<<8|_)&65535}),t.io.register_write(this.ata_port|4,this,function(_){a(_),this.master.cylinder_low=(this.master.cylinder_low<<8|_)&65535,this.slave.cylinder_low=(this.slave.cylinder_low<<8|_)&65535}),t.io.register_write(this.ata_port|5,this,function(_){a(_),this.master.cylinder_high=(this.master.cylinder_high<<8|_)&65535,this.slave.cylinder_high=(this.slave.cylinder_high<<8|_)&65535}),t.io.register_write(this.ata_port|6,this,function(_){var f=_&16;a(_,2),this.current_interface=f?this.slave:this.master,this.master.drive_head=_,this.slave.drive_head=_,this.master.is_lba=this.slave.is_lba=_>>6&1,this.master.head=this.slave.head=_&15}),this.dma_command=this.dma_status=this.prdt_addr=0,t.io.register_write(this.ata_port|7,this,function(_){this.cpu.device_lower_irq(this.irq),this.current_interface.ata_command(_)}),t.io.register_read(this.master_port|4,this,void 0,void 0,this.dma_read_addr),t.io.register_write(this.master_port|4,this,void 0,void 0,this.dma_set_addr),t.io.register_read(this.master_port,this,this.dma_read_command8,void 0,this.dma_read_command),t.io.register_write(this.master_port,this,this.dma_write_command8,void 0,this.dma_write_command),t.io.register_read(this.master_port|2,this,this.dma_read_status),t.io.register_write(this.master_port|2,this,this.dma_write_status),t.io.register_read(this.master_port|8,this,function(){return 0}),t.io.register_read(this.master_port|10,this,function(){return 0}),t.devices.pci.register_device(this)}A.prototype.read_status=function(){if(this.current_interface.buffer){var t=this.current_interface.status;return a(t,2),t}return 0},A.prototype.write_control=function(t){a(t,2),t&4&&(this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset()),this.device_control=t},A.prototype.dma_read_addr=function(){return a(this.prdt_addr,8),this.prdt_addr},A.prototype.dma_set_addr=function(t){a(t,8),this.prdt_addr=t},A.prototype.dma_read_status=function(){return a(this.dma_status),this.dma_status},A.prototype.dma_write_status=function(t){a(t),this.dma_status&=~(t&6)},A.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16},A.prototype.dma_read_command8=function(){return a(this.dma_command),this.dma_command},A.prototype.dma_write_command=function(t){a(t),this.dma_write_command8(t&255),this.dma_write_status(t>>16&255)},A.prototype.dma_write_command8=function(t){a(t);let e=this.dma_command;if(this.dma_command=t&9,(e&1)!==(t&1))if(!(t&1))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 37:case 200:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:a(this.current_interface.current_command)}},A.prototype.push_irq=function(){!(this.device_control&2)&&(this.dma_status|=4,this.cpu.device_raise_irq(this.irq))},A.prototype.get_state=function(){var t=[];return t[0]=this.master,t[1]=this.slave,t[2]=this.ata_port,t[3]=this.irq,t[4]=this.pci_id,t[5]=this.ata_port_high,t[6]=this.master_port,t[7]=this.name,t[8]=this.device_control,t[9]=this.prdt_addr,t[10]=this.dma_status,t[11]=this.current_interface===this.master,t[12]=this.dma_command,t},A.prototype.set_state=function(t){this.master.set_state(t[0]),this.slave.set_state(t[1]),this.ata_port=t[2],this.irq=t[3],this.pci_id=t[4],this.ata_port_high=t[5],this.master_port=t[6],this.name=t[7],this.device_control=t[8],this.prdt_addr=t[9],this.dma_status=t[10],this.current_interface=t[11]?this.master:this.slave,this.dma_command=t[12]};function T(t,e,s,r,o,l,_){this.device=t,this.bus=_,this.nr=o,this.cpu=e,this.buffer=s,this.sector_size=r?2048:512,this.is_atapi=r,this.cylinder_count=this.sectors_per_track=this.head_count=this.sector_count=0,this.buffer&&(this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(this.sector_count|0)&&(this.sector_count=Math.ceil(this.sector_count)),r?(this.head_count=1,this.sectors_per_track=0):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(this.cylinder_count|0)&&(this.cylinder_count=Math.floor(this.cylinder_count)),t=e.devices.rtc,t.cmos_write(57,t.cmos_read(57)|1<<4*this.nr),t.cmos_write(18,t.cmos_read(18)&15|240),t.cmos_write(27,this.cylinder_count&255),t.cmos_write(28,this.cylinder_count>>8&255),t.cmos_write(29,this.head_count&255),t.cmos_write(30,255),t.cmos_write(31,255),t.cmos_write(32,200),t.cmos_write(33,this.cylinder_count&255),t.cmos_write(34,this.cylinder_count>>8&255),t.cmos_write(35,this.sectors_per_track&255)),this.stats={sectors_read:0,sectors_written:0,bytes_read:0,bytes_written:0,loading:!1},this.buffer=s,this.drive_head=this.head=this.cylinder_high=this.cylinder_low=this.lba_count=this.sector=this.bytecount=this.is_lba=0,this.status=80,this.sectors_per_drq=128,this.data_pointer=this.error=0,this.data=new Uint8Array(65536),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.data_end=this.data_length=0,this.current_atapi_command=this.current_command=-1,this.last_io_id=this.write_dest=0,this.in_progress_io_ids=new Set,this.cancelled_io_ids=new Set,Object.seal(this)}T.prototype.device_reset=function(){this.is_atapi?(this.status=0,this.sector=this.error=this.bytecount=1,this.cylinder_low=20,this.cylinder_high=235):(this.status=81,this.sector=this.error=this.bytecount=1,this.cylinder_high=this.cylinder_low=0),this.cancel_io_operations()},T.prototype.push_irq=function(){this.device.push_irq()},T.prototype.ata_command=function(t){if(a(t),this.buffer)switch(this.current_command=t,this.error=0,t){case 8:this.data_length=this.data_end=this.data_pointer=0,this.device_reset(),this.push_irq();break;case 16:this.status=80,this.cylinder_low=0,this.push_irq();break;case 248:this.status=80,t=this.sector_count-1,this.sector=t&255,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.drive_head=this.drive_head&240|t>>24&15,this.push_irq();break;case 39:this.status=80,t=this.sector_count-1,this.sector=t&255,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.sector|=t>>24<<8&65280,this.push_irq();break;case 32:case 36:case 41:case 196:this.ata_read_sectors(t);break;case 48:case 52:case 57:case 197:this.ata_write_sectors(t);break;case 144:this.push_irq(),this.error=257,this.status=80;break;case 145:this.status=80,this.push_irq();break;case 160:this.is_atapi&&(this.status=88,this.data_allocate(12),this.data_end=12,this.bytecount=1,this.push_irq());break;case 161:this.is_atapi?(this.create_identify_packet(),this.status=88,this.cylinder_low=20,this.cylinder_high=235):this.status=65,this.push_irq();break;case 198:a(this.bytecount&255),this.sectors_per_drq=this.bytecount&255,this.status=80,this.push_irq();break;case 37:case 200:this.ata_read_sectors_dma(t);break;case 53:case 202:this.ata_write_sectors_dma(t);break;case 64:this.status=80,this.push_irq();break;case 218:this.status=65,this.error=4,this.push_irq();break;case 224:this.status=80,this.push_irq();break;case 225:this.status=80,this.push_irq();break;case 231:this.status=80,this.push_irq();break;case 236:if(this.is_atapi){this.status=65,this.error=4,this.push_irq();break}this.create_identify_packet(),this.status=88,this.push_irq();break;case 234:this.status=80,this.push_irq();break;case 239:a(this.bytecount&255),this.status=80,this.push_irq();break;case 222:this.status=80,this.push_irq();break;case 245:this.status=80,this.push_irq();break;case 249:this.status=65,this.error=4;break;default:a(t),this.status=65,this.error=4}else this.error=4,this.status=65,this.push_irq()},T.prototype.atapi_handle=function(){switch(a(this.data[0]),this.data_pointer=0,this.current_atapi_command=this.data[0],this.current_atapi_command){case 0:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 3:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88,this.data[0]=240,this.data[2]=5,this.data[7]=8;break;case 18:var t=this.data[4];this.status=88,a(this.data[1],2),this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]),this.data_end=this.data_length=Math.min(36,t);break;case 26:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88;break;case 30:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 37:t=this.sector_count-1,this.data_set(new Uint8Array([t>>24&255,t>>16&255,t>>8&255,t&255,0,0,this.sector_size>>8&255,this.sector_size&255])),this.data_end=this.data_length,this.status=88;break;case 40:this.lba_count&1?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:t=this.data[8],this.data_allocate(Math.min(8,t)),this.data_end=this.data_length,this.status=88;break;case 67:t=this.data[8]|this.data[7]<<8;var e=this.data[9]>>6;this.data_allocate(t),this.data_end=this.data_length,a(e,2),a(this.data[6]),e===0?(t=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,t>>24,t>>16&255,t>>8&255,t&255]))):e===1&&this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])),this.status=88;break;case 70:t=this.data[8]|this.data[7]<<8,t=Math.min(t,32),this.data_allocate(t),this.data_end=this.data_length,this.data[0]=t-4>>24&255,this.data[1]=t-4>>16&255,this.data[2]=t-4>>8&255,this.data[3]=t-4&255,this.data[6]=8,this.data[10]=3,this.status=88;break;case 81:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 82:a(this.data[0]),this.status=81,this.data_length=0,this.error=80;break;case 90:t=this.data[8]|this.data[7]<<8,e=this.data[2],a(e),e===42&&this.data_allocate(Math.min(30,t)),this.data_end=this.data_length,this.status=88;break;case 189:this.data_allocate(this.data[9]|this.data[8]<<8),this.data_end=this.data_length,this.data[5]=1,this.status=88;break;case 74:this.status=81,this.data_length=0,this.error=80,a(this.data[0]);break;case 190:a(this.data[0]),this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;default:this.status=81,this.data_length=0,this.error=80,a(this.data[0])}this.bytecount=this.bytecount&-8|2,!(this.status&128)&&this.push_irq(),!(this.status&128)&&this.data_length===0&&(this.bytecount|=1,this.status&=-9)},T.prototype.do_write=function(){this.status=80;var t=this.data.subarray(0,this.data_length);this.ata_advance(this.current_command,this.data_length/512),this.push_irq(),this.buffer.set(this.write_dest,t,function(){}),this.report_write(this.data_length)},T.prototype.atapi_read=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],s=t[7]<<8|t[8];t=t[1];var r=s*this.sector_size,o=e*this.sector_size;""+a(e)+a(s)+a(r)+a(t),this.data_length=0;var l=this.cylinder_high<<8&65280|this.cylinder_low&255;a(this.cylinder_high,2)+""+a(this.cylinder_low,2),this.cylinder_low=this.cylinder_high=0,l===65535&&l--,l>r&&(l=r),o>=this.buffer.byteLength?(""+a(o+r)+a(this.buffer.byteLength),this.status=255,this.push_irq()):r===0?(this.status=80,this.data_pointer=0):(r=Math.min(r,this.buffer.byteLength-o),this.status=208,this.report_read_start(),this.read_buffer(o,r,_=>{this.data_set(_),this.status=88,this.bytecount=this.bytecount&-8|2,this.push_irq(),this.data_end=l&=-4,this.data_end>this.data_length&&(this.data_end=this.data_length),this.cylinder_low=this.data_end&255,this.cylinder_high=this.data_end>>8&255,this.report_read_end(r)}))},T.prototype.atapi_read_dma=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],s=t[7]<<8|t[8];t=t[1];var r=s*this.sector_size,o=e*this.sector_size;""+a(e)+a(s)+a(r)+a(t),o>=this.buffer.byteLength?(""+a(o+r)+a(this.buffer.byteLength),this.status=255,this.push_irq()):(this.status=208,this.report_read_start(),this.read_buffer(o,r,l=>{this.report_read_end(r),this.status=88,this.bytecount=this.bytecount&-8|2,this.data_set(l),this.do_atapi_dma()}))},T.prototype.do_atapi_dma=function(){if(this.device.dma_status&1&&this.status&8){var t=this.device.prdt_addr,e=0,s=this.data;do{var r=this.cpu.read32s(t),o=this.cpu.read16(t+4),l=this.cpu.read8(t+7)&128;if(o||(o=65536),a(r),a(o),a(this.data_length),this.cpu.write_blob(s.subarray(e,Math.min(e+o,this.data_length)),r),e+=o,t+=8,e>=this.data_length&&!l){a(e),a(this.data_length),a(this.current_command);break}}while(!l);this.status=80,this.device.dma_status&=-2,this.bytecount=this.bytecount&-8|3,this.push_irq()}},T.prototype.read_data=function(t){if(this.data_pointer<this.data_end){a(this.data_pointer);var e=t===1?this.data[this.data_pointer]:t===2?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];return this.data_pointer+=t,!(this.data_pointer&(this.data_end&4095?255:4095))&&(a(this.data[this.data_pointer],2),a(this.data_pointer),a(this.data_length)),this.data_pointer>=this.data_end&&this.read_end(),e}return this.data_pointer+=t,0},T.prototype.read_end=function(){if(a(this.current_command),a(this.data_pointer),a(this.data_end),a(this.data_length),this.current_command===160)if(this.data_end===this.data_length)this.status=80,this.bytecount=this.bytecount&-8|3,this.push_irq();else{this.status=88,this.bytecount=this.bytecount&-8|2,this.push_irq();var t=this.cylinder_high<<8&65280|this.cylinder_low&255;this.data_end+t>this.data_length?(this.cylinder_low=this.data_length-this.data_end&255,this.cylinder_high=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=t,a(this.data_end)}else this.error=0,this.data_pointer>=this.data_length?this.status=80:(t=this.current_command===196||this.current_command===41?Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512):1,this.ata_advance(this.current_command,t),this.data_end+=512*t,this.status=88,this.push_irq())},T.prototype.write_data_port=function(t,e){this.data_pointer>=this.data_end?(a(t),a(this.data_end),a(this.data_pointer)):((!(this.data_pointer+e&(this.data_end&4095?255:4095))||20>this.data_end)&&(a(t>>>0),a(this.data_end),a(this.data_pointer)),e===1?this.data[this.data_pointer++]=t:e===2?(this.data16[this.data_pointer>>>1]=t,this.data_pointer+=2):(this.data32[this.data_pointer>>>2]=t,this.data_pointer+=4),this.data_pointer===this.data_end&&this.write_end())},T.prototype.write_data_port8=function(t){this.write_data_port(t,1)},T.prototype.write_data_port16=function(t){this.write_data_port(t,2)},T.prototype.write_data_port32=function(t){this.write_data_port(t,4)},T.prototype.write_end=function(){this.current_command===160?this.atapi_handle():(a(this.data_pointer),a(this.data_length),this.data_pointer>=this.data_length?this.do_write():(a(this.current_command),this.status=88,this.data_end+=512,this.push_irq()))},T.prototype.ata_advance=function(t,e){this.bytecount-=e,t===36||t===41||t===52||t===57||t===37||t===53?(t=e+this.get_lba48(),this.sector=t&255|t>>16&65280,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255):this.is_lba?(t=e+this.get_lba28(),this.sector=t&255,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.head=this.head&-16|t&15):(t=e+this.get_chs(),e=t/(this.head_count*this.sectors_per_track)|0,this.cylinder_low=e&255,this.cylinder_high=e>>8&255,this.head=(t/this.sectors_per_track|0)%this.head_count&15,this.sector=t%this.sectors_per_track+1&255,this.get_chs())},T.prototype.ata_read_sectors=function(t){var e=t===36||t===41,s=this.get_count(e);e=this.get_lba(e);var r=t===32||t===36,o=s*this.sector_size,l=e*this.sector_size;""+a(t)+(this.is_lba?"lba":"chs")+a(e)+a(s)+a(o),l+o>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=192,this.report_read_start(),this.read_buffer(l,o,_=>{this.data_set(_),this.status=88,this.data_end=r?512:Math.min(o,512*this.sectors_per_drq),this.ata_advance(t,r?1:Math.min(s,this.sectors_per_track)),this.push_irq(),this.report_read_end(o)}))},T.prototype.ata_read_sectors_dma=function(t){var e=t===37;t=this.get_count(e),e=this.get_lba(e);var s=t*this.sector_size,r=e*this.sector_size;a(e),a(t),a(s),r+s>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},T.prototype.do_ata_read_sectors_dma=function(){var t=this.current_command===37,e=this.get_count(t);t=this.get_lba(t);var s=e*this.sector_size;t*=this.sector_size,this.report_read_start(),this.read_buffer(t,s,r=>{var o=this.device.prdt_addr,l=0;do{var _=this.cpu.read32s(o),f=this.cpu.read16(o+4),g=this.cpu.read8(o+7)&128;f||(f=65536),a(_),a(f),this.cpu.write_blob(r.subarray(l,l+f),_),l+=f,o+=8}while(!g);this.ata_advance(this.current_command,e),this.status=80,this.device.dma_status&=-2,this.current_command=-1,this.push_irq(),this.report_read_end(s)})},T.prototype.ata_write_sectors=function(t){var e=t===52||t===57,s=this.get_count(e);e=this.get_lba(e),t=t===48||t===52;var r=s*this.sector_size,o=e*this.sector_size;a(e),a(s),a(r),o+r>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.data_allocate_noclear(r),this.data_end=t?512:Math.min(r,512*this.sectors_per_drq),this.write_dest=o)},T.prototype.ata_write_sectors_dma=function(t){var e=t===53;t=this.get_count(e),e=this.get_lba(e);var s=t*this.sector_size,r=e*this.sector_size;a(e),a(t),a(s),r+s>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},T.prototype.do_ata_write_sectors_dma=function(){var t=this.current_command===53,e=this.get_count(t),s=this.get_lba(t);t=e*this.sector_size,s*=this.sector_size;var r=this.device.prdt_addr,o=0;""+a(r,8);let l=new Uint8Array(t);do{var _=this.cpu.read32s(r),f=this.cpu.read16(r+4),g=this.cpu.read8(r+7)&128;f||(f=65536),""+a(_)+a(f),_=this.cpu.mem8.subarray(_,_+f),l.set(_,o),o+=f,r+=8}while(!g);this.buffer.set(s,l,()=>{this.ata_advance(this.current_command,e),this.status=80,this.push_irq(),this.device.dma_status&=-2,this.current_command=-1}),this.report_write(t)},T.prototype.get_chs=function(){return((this.cylinder_low&255|this.cylinder_high<<8&65280)*this.head_count+this.head)*this.sectors_per_track+(this.sector&255)-1},T.prototype.get_lba28=function(){return this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|(this.head&15)<<24},T.prototype.get_lba48=function(){return(this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|this.sector>>8<<24&4278190080)>>>0},T.prototype.get_lba=function(t){return t?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()},T.prototype.get_count=function(t){return t?(t=this.bytecount,t===0&&(t=65536)):(t=this.bytecount&255,t===0&&(t=256)),t},T.prototype.create_identify_packet=function(){if(this.drive_head&16)this.data_allocate(0);else{for(var t=0;512>t;t++)this.data[t]=0;t=Math.min(16383,this.cylinder_count),this.data_set([64,this.is_atapi?133:0,t,t>>8,0,0,this.head_count,this.head_count>>8,this.sectors_per_track/512,this.sectors_per_track/512>>8,0,2,this.sectors_per_track,this.sectors_per_track>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,56,118,32,54,68,72,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,128,0,1,0,0,2,0,0,0,2,0,2,7,0,t,t>>8,this.head_count,this.head_count>>8,this.sectors_per_track,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.current_command===160?0:7,this.current_command===160?0:4,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,126,0,0,0,0,0,0,116,0,64,0,64,0,116,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]),this.data_end=this.data_length=512}},T.prototype.data_allocate=function(t){this.data_allocate_noclear(t);for(var e=0;e<t+3>>2;e++)this.data32[e]=0},T.prototype.data_allocate_noclear=function(t){this.data.length<t&&(this.data=new Uint8Array(t+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)),this.data_length=t,this.data_pointer=0},T.prototype.data_set=function(t){this.data_allocate_noclear(t.length),this.data.set(t)},T.prototype.report_read_start=function(){this.stats.loading=!0,this.bus.send("ide-read-start")},T.prototype.report_read_end=function(t){this.stats.loading=!1;var e=t/this.sector_size|0;this.stats.sectors_read+=e,this.stats.bytes_read+=t,this.bus.send("ide-read-end",[this.nr,t,e])},T.prototype.report_write=function(t){var e=t/this.sector_size|0;this.stats.sectors_written+=e,this.stats.bytes_written+=t,this.bus.send("ide-write-end",[this.nr,t,e])},T.prototype.read_buffer=function(t,e,s){let r=this.last_io_id++;this.in_progress_io_ids.add(r),this.buffer.get(t,e,o=>{this.cancelled_io_ids.delete(r)?this.in_progress_io_ids.has(r):(this.in_progress_io_ids.delete(r),s(o))})},T.prototype.cancel_io_operations=function(){for(let t of this.in_progress_io_ids)this.cancelled_io_ids.add(t);this.in_progress_io_ids.clear()},T.prototype.get_state=function(){var t=[];return t[0]=this.bytecount,t[1]=this.cylinder_count,t[2]=this.cylinder_high,t[3]=this.cylinder_low,t[4]=this.data_pointer,t[5]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=this.drive_head,t[10]=this.error,t[11]=this.head,t[12]=this.head_count,t[13]=this.is_atapi,t[14]=this.is_lba,t[15]=this.lba_count,t[16]=this.data,t[17]=this.data_length,t[18]=this.sector,t[19]=this.sector_count,t[20]=this.sector_size,t[21]=this.sectors_per_drq,t[22]=this.sectors_per_track,t[23]=this.status,t[24]=this.write_dest,t[25]=this.current_command,t[26]=this.data_end,t[27]=this.current_atapi_command,t[28]=this.buffer,t},T.prototype.set_state=function(t){this.bytecount=t[0],this.cylinder_count=t[1],this.cylinder_high=t[2],this.cylinder_low=t[3],this.data_pointer=t[4],this.drive_head=t[9],this.error=t[10],this.head=t[11],this.head_count=t[12],this.is_atapi=t[13],this.is_lba=t[14],this.lba_count=t[15],this.data=t[16],this.data_length=t[17],this.sector=t[18],this.sector_count=t[19],this.sector_size=t[20],this.sectors_per_drq=t[21],this.sectors_per_track=t[22],this.status=t[23],this.write_dest=t[24],this.current_command=t[25],this.data_end=t[26],this.current_atapi_command=t[27],this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.buffer&&this.buffer.set_state(t[28])};function R(t){this.pci_addr=new Uint8Array(4),this.pci_value=new Uint8Array(4),this.pci_response=new Uint8Array(4),this.pci_status=new Uint8Array(4),this.pci_addr32=new Int32Array(this.pci_addr.buffer),this.pci_value32=new Int32Array(this.pci_value.buffer),this.pci_response32=new Int32Array(this.pci_response.buffer),this.pci_status32=new Int32Array(this.pci_status.buffer),this.device_spaces=[],this.devices=[],this.cpu=t;for(var e=0;256>e;e++)this.device_spaces[e]=void 0,this.devices[e]=void 0;this.io=t.io,t.io.register_write(3324,this,function(s){this.pci_write8(this.pci_addr32[0],s)},function(s){this.pci_write16(this.pci_addr32[0],s)},function(s){this.pci_write32(this.pci_addr32[0],s)}),t.io.register_write(3325,this,function(s){this.pci_write8(this.pci_addr32[0]+1|0,s)}),t.io.register_write(3326,this,function(s){this.pci_write8(this.pci_addr32[0]+2|0,s)},function(s){this.pci_write16(this.pci_addr32[0]+2|0,s)}),t.io.register_write(3327,this,function(s){this.pci_write8(this.pci_addr32[0]+3|0,s)}),t.io.register_read_consecutive(3324,this,function(){return this.pci_response[0]},function(){return this.pci_response[1]},function(){return this.pci_response[2]},function(){return this.pci_response[3]}),t.io.register_read_consecutive(3320,this,function(){return this.pci_status[0]},function(){return this.pci_status[1]},function(){return this.pci_status[2]},function(){return this.pci_status[3]}),t.io.register_write_consecutive(3320,this,function(s){this.pci_addr[0]=s&252},function(s){(this.pci_addr[1]&6)===2&&(s&6)===6?t.reboot_internal():this.pci_addr[1]=s},function(s){this.pci_addr[2]=s},function(s){this.pci_addr[3]=s,this.pci_query()}),this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"}),this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82371SB PIIX3 ISA"},this.isa_bridge_space=this.register_device(this.isa_bridge),this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}R.prototype.get_state=function(){for(var t=[],e=0;256>e;e++)t[e]=this.device_spaces[e];return t[256]=this.pci_addr,t[257]=this.pci_value,t[258]=this.pci_response,t[259]=this.pci_status,t},R.prototype.set_state=function(t){for(var e=0;256>e;e++){var s=this.devices[e],r=t[e];if(s&&r){for(var o=0;o<s.pci_bars.length;o++){var l=r[4+o];if(l&1){var _=s.pci_bars[o];this.set_io_bars(_,_.original_bar&65534,l&65534)}}this.device_spaces[e].set(r)}else r&&a(e,2)}this.pci_addr.set(t[256]),this.pci_value.set(t[257]),this.pci_response.set(t[258]),this.pci_status.set(t[259])},R.prototype.pci_query=function(){var t=this.pci_addr[2]<<8|this.pci_addr[1],e=this.pci_addr[0]&252,s=t>>3&31,r="query enabled="+(this.pci_addr[3]>>7)+(" bdf="+a(t,4));r+=" dev="+a(s,2),r+=" addr="+a(e,2),t=this.device_spaces[t],t!==void 0?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=e<t.byteLength?t[e>>2]:0,r+=" "+a(this.pci_addr32[0]>>>0,8)+" -> "+a(this.pci_response32[0]>>>0,8)):(this.pci_response32[0]=-1,this.pci_status32[0]=0)},R.prototype.pci_write8=function(t,e){var s=t>>8&65535;t&=255;var r=new Uint8Array(this.device_spaces[s].buffer);a(t),a(s>>3,2),a(t,4),a(e,2),r[t]=e},R.prototype.pci_write16=function(t,e){var s=t>>8&65535;t&=255;var r=new Uint16Array(this.device_spaces[s].buffer);16<=t&&44>t?a(t):(a(t),a(s>>3,2),a(t,4),a(e,4),r[t>>>1]=e)},R.prototype.pci_write32=function(t,e){var s=t>>8&65535;t&=255;var r=this.device_spaces[s],o=this.devices[s];if(r)if(16<=t&&40>t){if(o=o.pci_bars[t-16>>2],a(e>>>0),a(s>>3,2),o){s=t>>2;var l=r[s]&1;if((e|3|o.size-1)===-1?(e=~(o.size-1)|l,l===0&&(r[s]=e)):l===0&&(r[s]=o.original_bar),l===1){l=r[s]&65534;var _=e&65534;a(l>>>0,8),a(_>>>0,8),this.set_io_bars(o,l,_),r[s]=e|1}}else r[t>>2]=0;a(r[t>>2]>>>0)}else t===48?(a(s>>3,2),a(e>>>0,8),r[t>>2]=o.pci_rom_size?(e|2047)===-1?-o.pci_rom_size|0:o.pci_rom_address|0:0):t===4?(a(s>>3,2),a(t,4),a(e>>>0,8)):(a(s>>3,2),a(t,4),a(e>>>0,8),r[t>>>2]=e)},R.prototype.register_device=function(t){var e=t.pci_id;a(e);var s=new Int32Array(64);s.set(new Int32Array(new Uint8Array(t.pci_space).buffer)),this.device_spaces[e]=s,this.devices[e]=t,e=s.slice(4,10);for(var r=0;r<t.pci_bars.length;r++){var o=t.pci_bars[r];if(o){var l=e[r],_=l&1;if(o.original_bar=l,o.entries=[],_!==0)for(l&=-2,_=0;_<o.size;_++)o.entries[_]=this.io.ports[l+_]}}return s},R.prototype.set_io_bars=function(t,e,s){var r=t.size;a(e),a(s);for(var o=this.io.ports,l=0;l<r;l++){var _=o[e+l];4096<=e+l&&(o[e+l]=this.io.create_empty_entry()),_.read8===this.io.empty_port_read8&&_.read16===this.io.empty_port_read16&&_.read32===this.io.empty_port_read32&&_.write8===this.io.empty_port_write&&_.write16===this.io.empty_port_write&&_.write32===this.io.empty_port_write&&a(e+l,4),_=t.entries[l];var f=o[s+l];4096<=s+l&&(o[s+l]=_),f.read8!==this.io.empty_port_read8&&f.read16!==this.io.empty_port_read16&&f.read32!==this.io.empty_port_read32&&f.write8!==this.io.empty_port_write&&f.write16!==this.io.empty_port_write&&f.write32!==this.io.empty_port_write||a(s+l,4)}},R.prototype.raise_irq=function(t){this.cpu.device_raise_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)-1+((t>>3)-1&255)&3)])},R.prototype.lower_irq=function(t){this.cpu.device_lower_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)+(t>>3&255)-2&3)])};function L(t,e){this.io=t.io,this.cpu=t,this.dma=t.devices.dma,this.bytes_expecting=0,this.receiving_command=new Uint8Array(10),this.receiving_index=0,this.next_command=null,this.response_data=new Uint8Array(10),this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=this.response_length=this.response_index=0,this.last_sector=1,this.dir=this.dor=0,this.fdb_image=this.fda_image=null,e?this.set_fda(e):(this.eject_fda(),this.cpu.devices.rtc.cmos_write(16,64)),this.io.register_read(1008,this,this.port3F0_read),this.io.register_read(1010,this,this.port3F2_read),this.io.register_read(1012,this,this.port3F4_read),this.io.register_read(1013,this,this.port3F5_read),this.io.register_read(1015,this,this.port3F7_read),this.io.register_write(1010,this,this.port3F2_write),this.io.register_write(1012,this,this.port3F4_write),this.io.register_write(1013,this,this.port3F5_write)}L.prototype.eject_fda=function(){this.fda_image=null,this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0,this.dir=128},L.prototype.set_fda=function(t){var e={163840:{type:1,tracks:40,sectors:8,heads:1},184320:{type:1,tracks:40,sectors:9,heads:1},204800:{type:1,tracks:40,sectors:10,heads:1},327680:{type:1,tracks:40,sectors:8,heads:2},368640:{type:1,tracks:40,sectors:9,heads:2},409600:{type:1,tracks:40,sectors:10,heads:2},737280:{type:3,tracks:80,sectors:9,heads:2},1228800:{type:2,tracks:80,sectors:15,heads:2},1474560:{type:4,tracks:80,sectors:18,heads:2},1763328:{type:5,tracks:82,sectors:21,heads:2},2949120:{type:5,tracks:80,sectors:36,heads:2},512:{type:1,tracks:1,sectors:1,heads:1}};let s=t.byteLength,r=e[s];r||(s=1474560<t.byteLength?2949120:1474560,r=e[s],e=new Uint8Array(s),e.set(new Uint8Array(t.buffer)),t=new m.SyncBuffer(e.buffer)),this.sectors_per_track=r.sectors,this.number_of_heads=r.heads,this.number_of_cylinders=r.tracks,this.fda_image=t,this.dir=128,this.cpu.devices.rtc.cmos_write(16,r.type<<4)},L.prototype.get_state=function(){var t=[];return t[0]=this.bytes_expecting,t[1]=this.receiving_command,t[2]=this.receiving_index,t[4]=this.response_data,t[5]=this.response_index,t[6]=this.response_length,t[8]=this.status_reg0,t[9]=this.status_reg1,t[10]=this.status_reg2,t[11]=this.drive,t[12]=this.last_cylinder,t[13]=this.last_head,t[14]=this.last_sector,t[15]=this.dor,t[16]=this.sectors_per_track,t[17]=this.number_of_heads,t[18]=this.number_of_cylinders,t},L.prototype.set_state=function(t){this.bytes_expecting=t[0],this.receiving_command=t[1],this.receiving_index=t[2],this.next_command=t[3],this.response_data=t[4],this.response_index=t[5],this.response_length=t[6],this.status_reg0=t[8],this.status_reg1=t[9],this.status_reg2=t[10],this.drive=t[11],this.last_cylinder=t[12],this.last_head=t[13],this.last_sector=t[14],this.dor=t[15],this.sectors_per_track=t[16],this.number_of_heads=t[17],this.number_of_cylinders=t[18]},L.prototype.port3F0_read=function(){return 0},L.prototype.port3F4_read=function(){var t=128;return this.response_index<this.response_length&&(t|=80),!(this.dor&8)&&(t|=32),t},L.prototype.port3F7_read=function(){return this.dir},L.prototype.port3F5_read=function(){return this.response_index<this.response_length?(this.cpu.device_lower_irq(6),this.response_data[this.response_index++]):255},L.prototype.port3F4_write=function(t){a(t),t&128&&(this.status_reg0=192,this.cpu.device_raise_irq(6))},L.prototype.port3F5_write=function(t){if(""+a(t),0<this.bytes_expecting)this.receiving_command[this.receiving_index++]=t,this.bytes_expecting--,this.bytes_expecting===0&&this.next_command.call(this,this.receiving_command);else{switch(t){case 3:this.next_command=this.fix_drive_data,this.bytes_expecting=2;break;case 19:this.next_command=this.configure,this.bytes_expecting=3;break;case 4:this.next_command=this.check_drive_status,this.bytes_expecting=1;break;case 5:case 69:case 197:this.next_command=function(e){this.do_sector(!0,e)},this.bytes_expecting=8;break;case 6:case 70:case 198:case 230:this.next_command=function(e){this.do_sector(!1,e)},this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate,this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id,this.bytes_expecting=1;break;case 15:this.bytes_expecting=2,this.next_command=this.seek;break;case 14:case 16:this.status_reg0=128,this.response_data[0]=this.status_reg0,this.response_index=0,this.response_length=1,this.bytes_expecting=0;break;default:""+a(t)}this.receiving_index=0}},L.prototype.port3F2_read=function(){return this.dor},L.prototype.port3F2_write=function(t){(t&4)===4&&!(this.dor&4)&&(this.status_reg0=192,this.cpu.device_raise_irq(6)),a(t>>4),a(t),this.dor=t},L.prototype.check_drive_status=function(){this.status_reg1=this.fda_image?0:5,this.response_index=0,this.response_length=1,this.response_data[0]=0},L.prototype.seek=function(t){if(!(t[0]&3)){var e=t[1];t=t[0]>>2&1,e!==this.last_cylinder&&(this.dir=0),this.status_reg1=this.fda_image?0:5,this.status_reg0=32,this.last_cylinder=e,this.last_head=t}this.raise_irq()},L.prototype.calibrate=function(t){this.seek([t[0],0])},L.prototype.check_interrupt_status=function(){this.response_index=0,this.response_length=2,this.response_data[0]=this.status_reg0,this.response_data[1]=this.last_cylinder},L.prototype.do_sector=function(t,e){var s=e[2],r=e[1],o=e[3],l=128<<e[4],_=e[5]-e[3]+1,f=((s+this.number_of_heads*r)*this.sectors_per_track+o-1)*l;a(f),a(_*l),this.fda_image?(this.status_reg1=0,t?this.dma.do_write(this.fda_image,f,_*l,2,this.done.bind(this,e,r,s,o)):this.dma.do_read(this.fda_image,f,_*l,2,this.done.bind(this,e,r,s,o))):this.status_reg1=5},L.prototype.done=function(t,e,s,r,o){o||(r++,r>this.sectors_per_track&&(r=1,s++,s>=this.number_of_heads&&(s=0,e++)),e!==this.last_cylinder&&(this.dir=0),this.status_reg0=32,this.last_cylinder=e,this.last_head=s,this.last_sector=r,this.response_index=0,this.response_length=7,this.response_data[0]=s<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=e,this.response_data[4]=s,this.response_data[5]=r,this.response_data[6]=t[4],this.raise_irq())},L.prototype.fix_drive_data=function(t){t.slice(0,this.bytes_expecting)},L.prototype.configure=function(t){t.slice(0,this.bytes_expecting)},L.prototype.read_sector_id=function(){this.response_index=0,this.response_length=7,this.response_data[0]=0,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=0,this.response_data[4]=0,this.response_data[5]=0,this.response_data[6]=0,this.raise_irq()},L.prototype.raise_irq=function(){this.dor&8&&this.cpu.device_raise_irq(6)},$.prototype.mmap_read8=function(t){return this.memory_map_read8[t>>>17](t)},$.prototype.mmap_write8=function(t,e){this.memory_map_write8[t>>>17](t,e)},$.prototype.mmap_read16=function(t){var e=this.memory_map_read8[t>>>17];return e(t)|e(t+1|0)<<8},$.prototype.mmap_write16=function(t,e){var s=this.memory_map_write8[t>>>17];s(t,e&255),s(t+1|0,e>>8)},$.prototype.mmap_read32=function(t){return this.memory_map_read32[t>>>17](t)},$.prototype.mmap_write32=function(t,e){this.memory_map_write32[t>>>17](t,e)},$.prototype.mmap_write64=function(t,e,s){var r=this.memory_map_write32[t>>>17];r(t,e),r(t+4,s)},$.prototype.mmap_write128=function(t,e,s,r,o){var l=this.memory_map_write32[t>>>17];l(t,e),l(t+4,s),l(t+8,r),l(t+12,o)},$.prototype.write_blob=function(t,e){t.length&&(this.in_mapped_range(e),this.in_mapped_range(e+t.length-1),this.jit_dirty_cache(e,e+t.length),this.mem8.set(t,e))},$.prototype.read_blob=function(t,e){return e&&(this.in_mapped_range(t),this.in_mapped_range(t+e-1)),this.mem8.subarray(t,t+e)};function z(t){this.cpu=t,this.channel_page=new Uint8Array(8),this.channel_pagehi=new Uint8Array(8),this.channel_addr=new Uint16Array(8),this.channel_addr_init=new Uint16Array(8),this.channel_count=new Uint16Array(8),this.channel_count_init=new Uint16Array(8),this.channel_mask=new Uint8Array(8),this.channel_mode=new Uint8Array(8),this.unmask_listeners=[],this.lsb_msb_flipflop=0,t=t.io,t.register_write(0,this,this.port_addr_write.bind(this,0)),t.register_write(2,this,this.port_addr_write.bind(this,1)),t.register_write(4,this,this.port_addr_write.bind(this,2)),t.register_write(6,this,this.port_addr_write.bind(this,3)),t.register_write(1,this,this.port_count_write.bind(this,0)),t.register_write(3,this,this.port_count_write.bind(this,1)),t.register_write(5,this,this.port_count_write.bind(this,2)),t.register_write(7,this,this.port_count_write.bind(this,3)),t.register_read(0,this,this.port_addr_read.bind(this,0)),t.register_read(2,this,this.port_addr_read.bind(this,1)),t.register_read(4,this,this.port_addr_read.bind(this,2)),t.register_read(6,this,this.port_addr_read.bind(this,3)),t.register_read(1,this,this.port_count_read.bind(this,0)),t.register_read(3,this,this.port_count_read.bind(this,1)),t.register_read(5,this,this.port_count_read.bind(this,2)),t.register_read(7,this,this.port_count_read.bind(this,3)),t.register_write(192,this,this.port_addr_write.bind(this,4)),t.register_write(196,this,this.port_addr_write.bind(this,5)),t.register_write(200,this,this.port_addr_write.bind(this,6)),t.register_write(204,this,this.port_addr_write.bind(this,7)),t.register_write(194,this,this.port_count_write.bind(this,4)),t.register_write(198,this,this.port_count_write.bind(this,5)),t.register_write(202,this,this.port_count_write.bind(this,6)),t.register_write(206,this,this.port_count_write.bind(this,7)),t.register_read(192,this,this.port_addr_read.bind(this,4)),t.register_read(196,this,this.port_addr_read.bind(this,5)),t.register_read(200,this,this.port_addr_read.bind(this,6)),t.register_read(204,this,this.port_addr_read.bind(this,7)),t.register_read(194,this,this.port_count_read.bind(this,4)),t.register_read(198,this,this.port_count_read.bind(this,5)),t.register_read(202,this,this.port_count_read.bind(this,6)),t.register_read(206,this,this.port_count_read.bind(this,7)),t.register_write(135,this,this.port_page_write.bind(this,0)),t.register_write(131,this,this.port_page_write.bind(this,1)),t.register_write(129,this,this.port_page_write.bind(this,2)),t.register_write(130,this,this.port_page_write.bind(this,3)),t.register_write(143,this,this.port_page_write.bind(this,4)),t.register_write(139,this,this.port_page_write.bind(this,5)),t.register_write(137,this,this.port_page_write.bind(this,6)),t.register_write(138,this,this.port_page_write.bind(this,7)),t.register_read(135,this,this.port_page_read.bind(this,0)),t.register_read(131,this,this.port_page_read.bind(this,1)),t.register_read(129,this,this.port_page_read.bind(this,2)),t.register_read(130,this,this.port_page_read.bind(this,3)),t.register_read(143,this,this.port_page_read.bind(this,4)),t.register_read(139,this,this.port_page_read.bind(this,5)),t.register_read(137,this,this.port_page_read.bind(this,6)),t.register_read(138,this,this.port_page_read.bind(this,7)),t.register_write(1159,this,this.port_pagehi_write.bind(this,0)),t.register_write(1155,this,this.port_pagehi_write.bind(this,1)),t.register_write(1153,this,this.port_pagehi_write.bind(this,2)),t.register_write(1154,this,this.port_pagehi_write.bind(this,3)),t.register_write(1163,this,this.port_pagehi_write.bind(this,5)),t.register_write(1161,this,this.port_pagehi_write.bind(this,6)),t.register_write(1162,this,this.port_pagehi_write.bind(this,7)),t.register_read(1159,this,this.port_pagehi_read.bind(this,0)),t.register_read(1155,this,this.port_pagehi_read.bind(this,1)),t.register_read(1153,this,this.port_pagehi_read.bind(this,2)),t.register_read(1154,this,this.port_pagehi_read.bind(this,3)),t.register_read(1163,this,this.port_pagehi_read.bind(this,5)),t.register_read(1161,this,this.port_pagehi_read.bind(this,6)),t.register_read(1162,this,this.port_pagehi_read.bind(this,7)),t.register_write(10,this,this.port_singlemask_write.bind(this,0)),t.register_write(212,this,this.port_singlemask_write.bind(this,4)),t.register_write(15,this,this.port_multimask_write.bind(this,0)),t.register_write(222,this,this.port_multimask_write.bind(this,4)),t.register_read(15,this,this.port_multimask_read.bind(this,0)),t.register_read(222,this,this.port_multimask_read.bind(this,4)),t.register_write(11,this,this.port_mode_write.bind(this,0)),t.register_write(214,this,this.port_mode_write.bind(this,4)),t.register_write(12,this,this.portC_write),t.register_write(216,this,this.portC_write)}z.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]},z.prototype.set_state=function(t){this.channel_page=t[0],this.channel_pagehi=t[1],this.channel_addr=t[2],this.channel_addr_init=t[3],this.channel_count=t[4],this.channel_count_init=t[5],this.channel_mask=t[6],this.channel_mode=t[7],this.lsb_msb_flipflop=t[8]},z.prototype.port_count_write=function(t,e){a(e),this.channel_count[t]=this.flipflop_get(this.channel_count[t],e,!1),this.channel_count_init[t]=this.flipflop_get(this.channel_count_init[t],e,!0)},z.prototype.port_count_read=function(t){return a(this.channel_count[t]),this.flipflop_read(this.channel_count[t])},z.prototype.port_addr_write=function(t,e){a(e),this.channel_addr[t]=this.flipflop_get(this.channel_addr[t],e,!1),this.channel_addr_init[t]=this.flipflop_get(this.channel_addr_init[t],e,!0)},z.prototype.port_addr_read=function(t){return a(this.channel_addr[t]),this.flipflop_read(this.channel_addr[t])},z.prototype.port_pagehi_write=function(t,e){a(e),this.channel_pagehi[t]=e},z.prototype.port_pagehi_read=function(t){return this.channel_pagehi[t]},z.prototype.port_page_write=function(t,e){a(e),this.channel_page[t]=e},z.prototype.port_page_read=function(t){return this.channel_page[t]},z.prototype.port_singlemask_write=function(t,e){this.update_mask((e&3)+t,e&4?1:0)},z.prototype.port_multimask_write=function(t,e){a(e);for(var s=0;4>s;s++)this.update_mask(t+s,e&1<<s)},z.prototype.port_multimask_read=function(t){var e=0|this.channel_mask[t+0];return e|=this.channel_mask[t+1]<<1,e|=this.channel_mask[t+2]<<2,e|=this.channel_mask[t+3]<<3,a(e),e},z.prototype.port_mode_write=function(t,e){t=(e&3)+t,a(e),this.channel_mode[t]=e},z.prototype.portC_write=function(){this.lsb_msb_flipflop=0},z.prototype.on_unmask=function(t,e){this.unmask_listeners.push({fn:t,this_value:e})},z.prototype.update_mask=function(t,e){if(this.channel_mask[t]!==e&&(this.channel_mask[t]=e,!e))for(e=0;e<this.unmask_listeners.length;e++)this.unmask_listeners[e].fn.call(this.unmask_listeners[e].this_value,t)},z.prototype.do_read=function(t,e,s,r,o){var l=this.count_get_8bit(r),_=this.address_get_8bit(r);if(""+a(_)+a(l),s<l&&(""+a(s)+a(l),void 0),e+l>t.byteLength)o(!0);else{var f=this.cpu;this.channel_addr[r]+=l,t.get(e,l,function(g){f.write_blob(g,_),o(!1)})}},z.prototype.do_write=function(t,e,s,r,o){var l=this.channel_count[r]+1&65535,_=5<=r?2:1,f=l*_,g=this.address_get_8bit(r),y=!1,b=!1,v=this.channel_mode[r]&16;""+a(g)+a(f),s<f?(l=Math.floor(s/_),f=l*_,y=!0):s>f&&(b=!0),e+f>t.byteLength?o(!0):(this.channel_addr[r]+=l,this.channel_count[r]-=l,!y&&v&&(this.channel_addr[r]=this.channel_addr_init[r],this.channel_count[r]=this.channel_count_init[r]),t.set(e,this.cpu.mem8.subarray(g,g+f),()=>{b&&v?this.do_write(t,e+f,s-f,r,o):o(!1)}))},z.prototype.address_get_8bit=function(t){var e=this.channel_addr[t];return 5<=t&&(e<<=1),e=e&65535|this.channel_page[t]<<16,e|=this.channel_pagehi[t]<<24},z.prototype.count_get_8bit=function(t){var e=this.channel_count[t]+1;return 5<=t&&(e*=2),e},z.prototype.flipflop_get=function(t,e,s){return s||(this.lsb_msb_flipflop^=1),this.lsb_msb_flipflop?t&-256|e:t&-65281|e<<8},z.prototype.flipflop_read=function(t){return(this.lsb_msb_flipflop^=1)?t&255:t>>8&255};function G(t,e){this.cpu=t,this.bus=e,this.counter_start_time=new Float64Array(3),this.counter_start_value=new Uint16Array(3),this.counter_next_low=new Uint8Array(4),this.counter_enabled=new Uint8Array(4),this.counter_mode=new Uint8Array(4),this.counter_read_mode=new Uint8Array(4),this.counter_latch=new Uint8Array(4),this.counter_latch_value=new Uint16Array(3),this.counter_reload=new Uint16Array(3),t.io.register_read(97,this,function(){var s=u.microtick(),r=66.66666666666667*s&1;return s=this.did_rollover(2,s),r<<4|s<<5}),t.io.register_write(97,this,function(s){s&1?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")}),t.io.register_read(64,this,function(){return this.counter_read(0)}),t.io.register_read(65,this,function(){return this.counter_read(1)}),t.io.register_read(66,this,function(){return this.counter_read(2)}),t.io.register_write(64,this,function(s){this.counter_write(0,s)}),t.io.register_write(65,this,function(s){this.counter_write(1,s)}),t.io.register_write(66,this,function(s){this.counter_write(2,s),this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])}),t.io.register_write(67,this,this.port43_write)}G.prototype.get_state=function(){var t=[];return t[0]=this.counter_next_low,t[1]=this.counter_enabled,t[2]=this.counter_mode,t[3]=this.counter_read_mode,t[4]=this.counter_latch,t[5]=this.counter_latch_value,t[6]=this.counter_reload,t[7]=this.counter_start_time,t[8]=this.counter_start_value,t},G.prototype.set_state=function(t){this.counter_next_low=t[0],this.counter_enabled=t[1],this.counter_mode=t[2],this.counter_read_mode=t[3],this.counter_latch=t[4],this.counter_latch_value=t[5],this.counter_reload=t[6],this.counter_start_time=t[7],this.counter_start_value=t[8]},G.prototype.timer=function(t,e){var s=100;return e||(this.counter_enabled[0]&&this.did_rollover(0,t)?(this.counter_start_value[0]=this.get_counter_value(0,t),this.counter_start_time[0]=t,this.cpu.device_lower_irq(0),this.cpu.device_raise_irq(0),this.counter_mode[0]===0&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0),this.counter_enabled[0]&&(s=(this.counter_start_value[0]-Math.floor(1193.1816666*(t-this.counter_start_time[0])))/1193.1816666)),s},G.prototype.get_counter_value=function(t,e){return this.counter_enabled[t]?(e=this.counter_start_value[t]-Math.floor(1193.1816666*(e-this.counter_start_time[t])),t=this.counter_reload[t],e>=t?e%=t:0>e&&(e=e%t+t),e):0},G.prototype.did_rollover=function(t,e){return e-=this.counter_start_time[t],0>e?!0:this.counter_start_value[t]<Math.floor(1193.1816666*e)},G.prototype.counter_read=function(t){var e=this.counter_latch[t];return e?(this.counter_latch[t]--,e===2?this.counter_latch_value[t]&255:this.counter_latch_value[t]>>8):(e=this.counter_next_low[t],this.counter_mode[t]===3&&(this.counter_next_low[t]^=1),t=this.get_counter_value(t,u.microtick()),e?t&255:t>>8)},G.prototype.counter_write=function(t,e){this.counter_reload[t]=this.counter_next_low[t]?this.counter_reload[t]&-256|e:this.counter_reload[t]&255|e<<8,this.counter_read_mode[t]===3&&this.counter_next_low[t]||(this.counter_reload[t]||(this.counter_reload[t]=65535),this.counter_start_value[t]=this.counter_reload[t],this.counter_enabled[t]=!0,this.counter_start_time[t]=u.microtick(),a(this.counter_reload[t])),this.counter_read_mode[t]===3&&(this.counter_next_low[t]^=1)},G.prototype.port43_write=function(t){var e=t>>1&7,s=t>>6&3;t=t>>4&3,s!==3&&(t===0?(this.counter_latch[s]=2,e=this.get_counter_value(s,u.microtick()),this.counter_latch_value[s]=e?e-1:0):(6<=e&&(e&=-5),this.counter_next_low[s]=t===1?0:1,s===0&&this.cpu.device_lower_irq(0),e!==0&&e!==3&&e!==2&&a(e),this.counter_mode[s]=e,this.counter_read_mode[s]=t,s===2&&this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])))},G.prototype.dump=function(){};var Y=Uint32Array.from([655360,655360,720896,753664]),H=Uint32Array.from([131072,65536,32768,32768]);function M(t,e,s){this.cpu=t,this.bus=e,this.vga_memory_size=s,this.cursor_address=0,this.cursor_scanline_start=14,this.cursor_scanline_end=15,this.max_cols=80,this.max_rows=25,this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0,this.layers=[],this.start_address_latched=this.start_address=0,this.crtc=new Uint8Array(25),this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0,this.graphical_mode_is_linear=!0,this.graphical_mode=!1,setTimeout(()=>{e.send("screen-set-mode",this.graphical_mode)},0),this.vga256_palette=new Int32Array(256),this.latch_dword=0,this.svga_version=45253,this.svga_height=this.svga_width=0,this.svga_enabled=!1,this.svga_bpp=32,this.svga_offset_y=this.svga_offset=this.svga_bank_offset=0,this.pci_space=[52,18,17,17,3,1,0,0,0,0,0,3,0,0,0,0,8,14680064,57344,224,0,0,0,0,0,0,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,190,254,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_id=144,this.pci_bars=[{size:s}],this.pci_rom_size=65536,this.pci_rom_address=4272947200,this.name="vga",this.stats={is_graphical:!1,res_x:0,res_y:0,bpp:0},this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0,this.dac_mask=255,this.dac_map=new Uint8Array(16),this.attribute_controller_index=-1,this.palette_source=32,this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=0,this.sequencer_index=-1,this.plane_write_bm=15,this.clocking_mode=this.sequencer_memory_mode=0,this.graphics_index=-1,this.planar_rotate_reg=this.planar_mode=this.plane_read=0,this.planar_bitmap=255,this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0,this.port_3DA_value=this.miscellaneous_output_register=255,s=t.io,s.register_write(960,this,this.port3C0_write),s.register_read(960,this,this.port3C0_read,this.port3C0_read16),s.register_read(961,this,this.port3C1_read),s.register_write(962,this,this.port3C2_write),s.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write),s.register_read(964,this,this.port3C4_read),s.register_read(965,this,this.port3C5_read),s.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write),s.register_read(974,this,this.port3CE_read),s.register_read(975,this,this.port3CF_read),s.register_read(966,this,this.port3C6_read),s.register_write(966,this,this.port3C6_write),s.register_write(967,this,this.port3C7_write),s.register_read(967,this,this.port3C7_read),s.register_write(968,this,this.port3C8_write),s.register_read(968,this,this.port3C8_read),s.register_write(969,this,this.port3C9_write),s.register_read(969,this,this.port3C9_read),s.register_read(972,this,this.port3CC_read),s.register_write(980,this,this.port3D4_write,l=>{this.port3D4_write(l&255),this.port3D5_write(l>>8&255)}),s.register_write(981,this,this.port3D5_write,l=>{a(l,4),this.port3D5_write(l&255)}),s.register_read(980,this,this.port3D4_read),s.register_read(981,this,this.port3D5_read,()=>this.port3D5_read()),s.register_read(970,this,function(){return 0}),s.register_read(986,this,this.port3DA_read),s.register_read(954,this,this.port3DA_read),this.dispi_index=-1,this.dispi_enable_value=0,s.register_write(462,this,void 0,this.port1CE_write),s.register_write(463,this,void 0,this.port1CF_write),s.register_read(463,this,void 0,this.port1CF_read),this.vga_memory_size===void 0||262144>this.vga_memory_size?this.vga_memory_size=262144:268435456<this.vga_memory_size?this.vga_memory_size=268435456:this.vga_memory_size&65535&&(this.vga_memory_size|=65535,this.vga_memory_size++);let r=t.svga_allocate_memory(this.vga_memory_size)>>>0;this.svga_memory=m.view(Uint8Array,t.wasm_memory,r,this.vga_memory_size),this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0,this.image_data=null,e.register("screen-fill-buffer",function(){this.screen_fill_buffer()},this),this.vga_memory=new Uint8Array(262144),this.plane0=new Uint8Array(this.vga_memory.buffer,0,65536),this.plane1=new Uint8Array(this.vga_memory.buffer,65536,65536),this.plane2=new Uint8Array(this.vga_memory.buffer,131072,65536),this.plane3=new Uint8Array(this.vga_memory.buffer,196608,65536),this.pixel_buffer=new Uint8Array(524288);var o=this;s.mmap_register(655360,131072,function(l){return o.vga_memory_read(l)},function(l,_){o.vga_memory_write(l,_)}),t.devices.pci.register_device(this)}M.prototype.get_state=function(){var t=[];return t[0]=this.vga_memory_size,t[1]=this.cursor_address,t[2]=this.cursor_scanline_start,t[3]=this.cursor_scanline_end,t[4]=this.max_cols,t[5]=this.max_rows,t[6]=this.vga_memory,t[7]=this.dac_state,t[8]=this.start_address,t[9]=this.graphical_mode,t[10]=this.vga256_palette,t[11]=this.latch_dword,t[12]=this.color_compare,t[13]=this.color_dont_care,t[14]=this.miscellaneous_graphics_register,t[15]=this.svga_width,t[16]=this.svga_height,t[17]=this.crtc_mode,t[18]=this.svga_enabled,t[19]=this.svga_bpp,t[20]=this.svga_bank_offset,t[21]=this.svga_offset,t[22]=this.index_crtc,t[23]=this.dac_color_index_write,t[24]=this.dac_color_index_read,t[25]=this.dac_map,t[26]=this.sequencer_index,t[27]=this.plane_write_bm,t[28]=this.sequencer_memory_mode,t[29]=this.graphics_index,t[30]=this.plane_read,t[31]=this.planar_mode,t[32]=this.planar_rotate_reg,t[33]=this.planar_bitmap,t[34]=this.max_scan_line,t[35]=this.miscellaneous_output_register,t[36]=this.port_3DA_value,t[37]=this.dispi_index,t[38]=this.dispi_enable_value,t[39]=this.svga_memory,t[40]=this.graphical_mode_is_linear,t[41]=this.attribute_controller_index,t[42]=this.offset_register,t[43]=this.planar_setreset,t[44]=this.planar_setreset_enable,t[45]=this.start_address_latched,t[46]=this.crtc,t[47]=this.horizontal_display_enable_end,t[48]=this.horizontal_blank_start,t[49]=this.vertical_display_enable_end,t[50]=this.vertical_blank_start,t[51]=this.underline_location_register,t[52]=this.preset_row_scan,t[53]=this.offset_register,t[54]=this.palette_source,t[55]=this.attribute_mode,t[56]=this.color_plane_enable,t[57]=this.horizontal_panning,t[58]=this.color_select,t[59]=this.clocking_mode,t[60]=this.line_compare,t[61]=this.pixel_buffer,t[62]=this.dac_mask,t},M.prototype.set_state=function(t){this.vga_memory_size=t[0],this.cursor_address=t[1],this.cursor_scanline_start=t[2],this.cursor_scanline_end=t[3],this.max_cols=t[4],this.max_rows=t[5],t[6]&&this.vga_memory.set(t[6]),this.dac_state=t[7],this.start_address=t[8],this.graphical_mode=t[9],this.vga256_palette=t[10],this.latch_dword=t[11],this.color_compare=t[12],this.color_dont_care=t[13],this.miscellaneous_graphics_register=t[14],this.svga_width=t[15],this.svga_height=t[16],this.crtc_mode=t[17],this.svga_enabled=t[18],this.svga_bpp=t[19],this.svga_bank_offset=t[20],this.svga_offset=t[21],this.index_crtc=t[22],this.dac_color_index_write=t[23],this.dac_color_index_read=t[24],this.dac_map=t[25],this.sequencer_index=t[26],this.plane_write_bm=t[27],this.sequencer_memory_mode=t[28],this.graphics_index=t[29],this.plane_read=t[30],this.planar_mode=t[31],this.planar_rotate_reg=t[32],this.planar_bitmap=t[33],this.max_scan_line=t[34],this.miscellaneous_output_register=t[35],this.port_3DA_value=t[36],this.dispi_index=t[37],this.dispi_enable_value=t[38],this.svga_memory.set(t[39]),this.graphical_mode_is_linear=t[40],this.attribute_controller_index=t[41],this.offset_register=t[42],this.planar_setreset=t[43],this.planar_setreset_enable=t[44],this.start_address_latched=t[45],this.crtc.set(t[46]),this.horizontal_display_enable_end=t[47],this.horizontal_blank_start=t[48],this.vertical_display_enable_end=t[49],this.vertical_blank_start=t[50],this.underline_location_register=t[51],this.preset_row_scan=t[52],this.offset_register=t[53],this.palette_source=t[54],this.attribute_mode=t[55],this.color_plane_enable=t[56],this.horizontal_panning=t[57],this.color_select=t[58],this.clocking_mode=t[59],this.line_compare=t[60],t[61]&&this.pixel_buffer.set(t[61]),this.dac_mask=t[62]===void 0?255:t[62],this.bus.send("screen-set-mode",this.graphical_mode),this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.update_layers()):(this.update_vga_size(),this.update_layers(),this.complete_replot())):(this.set_size_text(this.max_cols,this.max_rows),this.update_cursor_scanline(),this.update_cursor()),this.complete_redraw()},M.prototype.vga_memory_read=function(t){if(this.svga_enabled&&this.graphical_mode_is_linear)return this.cpu.read8((t-655360|this.svga_bank_offset)+3758096384|0);var e=this.miscellaneous_graphics_register>>2&3;return t-=Y[e],0>t||t>=H[e]?(a(t),0):(this.latch_dword=this.plane0[t],this.latch_dword|=this.plane1[t]<<8,this.latch_dword|=this.plane2[t]<<16,this.latch_dword|=this.plane3[t]<<24,this.planar_mode&8?(e=255,this.color_dont_care&1&&(e&=this.plane0[t]^~(this.color_compare&1?255:0)),this.color_dont_care&2&&(e&=this.plane1[t]^~(this.color_compare&2?255:0)),this.color_dont_care&4&&(e&=this.plane2[t]^~(this.color_compare&4?255:0)),this.color_dont_care&8&&(e&=this.plane3[t]^~(this.color_compare&8?255:0)),e):(e=this.plane_read,this.graphical_mode?this.sequencer_memory_mode&8?(e=t&3,t&=-4):this.planar_mode&16&&(e=t&1,t&=-2):e=0,this.vga_memory[e<<16|t]))},M.prototype.vga_memory_write=function(t,e){if(this.svga_enabled&&this.graphical_mode&&this.graphical_mode_is_linear)this.cpu.write8((t-655360|this.svga_bank_offset)+3758096384|0,e);else{var s=this.miscellaneous_graphics_register>>2&3;t-=Y[s],0>t||t>=H[s]?(a(t),a(e)):this.graphical_mode?this.vga_memory_write_graphical(t,e):this.plane_write_bm&3&&this.vga_memory_write_text_mode(t,e)}},M.prototype.vga_memory_write_graphical=function(t,e){var s=this.planar_mode&3,r=this.apply_feed(this.planar_bitmap),o=this.apply_expand(this.planar_setreset),l=this.apply_expand(this.planar_setreset_enable);switch(s){case 0:e=this.apply_rotate(e);var _=this.apply_feed(e);_=this.apply_setreset(_,l),_=this.apply_logical(_,this.latch_dword),_=this.apply_bitmask(_,r);break;case 1:_=this.latch_dword;break;case 2:_=this.apply_expand(e),_=this.apply_logical(_,this.latch_dword),_=this.apply_bitmask(_,r);break;case 3:e=this.apply_rotate(e),r&=this.apply_feed(e),_=this.apply_bitmask(o,r)}switch(e=15,this.sequencer_memory_mode&12){case 0:e=5<<(t&1),t&=-2;break;case 8:case 12:e=1<<(t&3),t&=-4}e&=this.plane_write_bm,e&1&&(this.plane0[t]=_>>0&255),e&2&&(this.plane1[t]=_>>8&255),e&4&&(this.plane2[t]=_>>16&255),e&8&&(this.plane3[t]=_>>24&255),t=this.vga_addr_to_pixel(t),this.partial_replot(t,t+7)},M.prototype.apply_feed=function(t){return t|t<<8|t<<16|t<<24},M.prototype.apply_expand=function(t){return(t&1?255:0)|(t&2?255:0)<<8|(t&4?255:0)<<16|(t&8?255:0)<<24},M.prototype.apply_rotate=function(t){return(t|t<<8)>>>(this.planar_rotate_reg&7)&255},M.prototype.apply_setreset=function(t,e){var s=this.apply_expand(this.planar_setreset);return(t|e&s)&(~e|s)},M.prototype.apply_logical=function(t,e){switch(this.planar_rotate_reg&24){case 8:return t&e;case 16:return t|e;case 24:return t^e}return t},M.prototype.apply_bitmask=function(t,e){return e&t|~e&this.latch_dword},M.prototype.text_mode_redraw=function(){var t=this.start_address<<1;let e=this.scan_line_to_screen_row(this.line_compare),s=Math.max(0,2*(2*this.offset_register-this.max_cols)),r=this.attribute_mode&8,o=r?7:15;for(var l=0;l<this.max_rows;l++){l===e&&(t=0);for(var _=0;_<this.max_cols;_++){var f=this.vga_memory[t],g=this.vga_memory[t|1],y=r&&g&128;this.bus.send("screen-put-char",[l,_,f,y,this.vga256_palette[this.dac_mask&this.dac_map[g>>4&o]],this.vga256_palette[this.dac_mask&this.dac_map[g&15]]]),t+=2}t+=s}},M.prototype.vga_memory_write_text_mode=function(t,e){this.vga_memory[t]=e;var s=Math.max(this.max_cols,2*this.offset_register);let r;if(t>>1>=this.start_address){var o=(t>>1)-this.start_address;r=o/s|0,s=o%s}else o=t>>1,r=(o/s|0)+this.scan_line_to_screen_row(this.line_compare),s=o%s;s>=this.max_cols||r>=this.max_rows||(t&1?(o=e,e=this.vga_memory[t&-2]):o=this.vga_memory[t|1],t=this.attribute_mode&8,this.bus.send("screen-put-char",[r,s,e,t&&o&128,this.vga256_palette[this.dac_mask&this.dac_map[o>>4&(t?7:15)]],this.vga256_palette[this.dac_mask&this.dac_map[o&15]]]))},M.prototype.update_cursor=function(){var t=Math.max(this.max_cols,2*this.offset_register);let e;this.cursor_address>=this.start_address?(e=(this.cursor_address-this.start_address)/t|0,t=(this.cursor_address-this.start_address)%t):(e=(this.cursor_address/t|0)+this.scan_line_to_screen_row(this.line_compare),t=this.cursor_address%t),this.bus.send("screen-update-cursor",[e,t])},M.prototype.complete_redraw=function(){this.graphical_mode?this.svga_enabled?this.cpu.svga_mark_dirty():(this.diff_addr_min=0,this.diff_addr_max=524288):this.text_mode_redraw()},M.prototype.complete_replot=function(){this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=524288,this.complete_redraw())},M.prototype.partial_redraw=function(t,e){t<this.diff_addr_min&&(this.diff_addr_min=t),e>this.diff_addr_max&&(this.diff_addr_max=e)},M.prototype.partial_replot=function(t,e){t<this.diff_plot_min&&(this.diff_plot_min=t),e>this.diff_plot_max&&(this.diff_plot_max=e),this.partial_redraw(t,e)},M.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0},M.prototype.destroy=function(){},M.prototype.vga_bytes_per_line=function(){var t=this.offset_register<<2;return this.underline_location_register&64?t<<=1:this.crtc_mode&64&&(t>>>=1),t},M.prototype.vga_addr_shift_count=function(){var t=128+(~this.underline_location_register&this.crtc_mode&64);return t-=this.underline_location_register&64,t-=this.attribute_mode&64,t>>>6},M.prototype.vga_addr_to_pixel=function(t){var e=this.vga_addr_shift_count();if(~this.crtc_mode&3){var s=t-this.start_address;s&=this.crtc_mode<<13|-24577,s<<=e;var r=s/this.virtual_width|0;switch(s%=this.virtual_width,this.crtc_mode&3){case 2:r=r<<1|t>>13&1;break;case 1:r=r<<1|t>>14&1;break;case 0:r=r<<2|t>>13&3}return r*this.virtual_width+s+(this.start_address<<e)}return t<<e},M.prototype.scan_line_to_screen_row=function(t){return this.max_scan_line&128&&(t>>>=1),t=Math.ceil(t/(1+(this.max_scan_line&31))),this.crtc_mode&1||(t<<=1),this.crtc_mode&2||(t<<=1),t},M.prototype.set_size_text=function(t,e){this.max_cols=t,this.max_rows=e,this.bus.send("screen-set-size-text",[t,e])},M.prototype.set_size_graphical=function(t,e,s,r,o){if(r=Math.max(r,1),o=Math.max(o,1),!this.stats.is_graphical||this.stats.bpp!==s||this.screen_width!==t||this.screen_height!==e||this.virtual_width!==r||this.virtual_height!==o){if(this.screen_width=t,this.screen_height=e,this.virtual_width=r,this.virtual_height=o,this.stats.bpp=s,this.stats.is_graphical=!0,this.stats.res_x=t,this.stats.res_y=e,typeof ImageData<"u"){let l=r*o,_=this.cpu.svga_allocate_dest_buffer(l)>>>0;this.dest_buffet_offset=_,this.image_data=new ImageData(new Uint8ClampedArray(this.cpu.wasm_memory.buffer,_,4*l),r,o),this.cpu.svga_mark_dirty()}this.bus.send("screen-set-size-graphical",[t,e,r,o,s])}},M.prototype.update_vga_size=function(){if(!this.svga_enabled){var t=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),e=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(t&&e)if(this.graphical_mode){t<<=3;var s=this.offset_register<<4;this.attribute_mode&64&&(t>>>=1,s>>>=1),e=this.scan_line_to_screen_row(e);var r=H[0];let o=this.vga_bytes_per_line();this.set_size_graphical(t,e,8,s,o?Math.ceil(r/o):e),this.update_vertical_retrace(),this.update_layers()}else this.max_scan_line&128&&(e>>>=1),s=e/(1+(this.max_scan_line&31))|0,t&&s&&this.set_size_text(t,s)}},M.prototype.update_layers=function(){if(this.graphical_mode||this.text_mode_redraw(),this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width)if(!this.palette_source||this.clocking_mode&32)this.layers=[],this.bus.send("screen-clear");else{var t=this.start_address_latched,e=this.horizontal_panning;this.attribute_mode&64&&(e>>>=1);var s=this.preset_row_scan>>5&3,r=this.vga_addr_to_pixel(t+s);t=r/this.virtual_width|0;var o=r%this.virtual_width+e;r=this.scan_line_to_screen_row(1+this.line_compare),r=Math.min(r,this.screen_height);var l=this.screen_height-r;this.layers=[],o=-o;for(var _=0;o<this.screen_width;o+=this.virtual_width,_++)this.layers.push({image_data:this.image_data,screen_x:o,screen_y:0,buffer_x:0,buffer_y:t+_,buffer_width:this.virtual_width,buffer_height:r});for(t=0,this.attribute_mode&32||(t=this.vga_addr_to_pixel(s)+e),o=-t,_=0;o<this.screen_width;o+=this.virtual_width,_++)this.layers.push({image_data:this.image_data,screen_x:o,screen_y:r,buffer_x:0,buffer_y:_,buffer_width:this.virtual_width,buffer_height:l})}},M.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8,this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())},M.prototype.update_cursor_scanline=function(){var t=this.max_scan_line&31;let e=Math.min(t,this.cursor_scanline_start&31);t=Math.min(t,this.cursor_scanline_end&31),this.bus.send("screen-update-cursor-scanline",[e,t,!(this.cursor_scanline_start&32)&&e<t])},M.prototype.port3C0_write=function(t){if(this.attribute_controller_index===-1)a(t),this.attribute_controller_index=t&31,a(this.attribute_controller_index),this.palette_source!==(t&32)&&(this.palette_source=t&32,this.update_layers());else{if(16>this.attribute_controller_index)a(this.attribute_controller_index),a(t),this.dac_map[this.attribute_controller_index]=t,this.attribute_mode&64||this.complete_redraw();else switch(this.attribute_controller_index){case 16:if(a(t),this.attribute_mode!==t){var e=this.attribute_mode;this.attribute_mode=t;var s=0<(t&1);this.svga_enabled||this.graphical_mode===s||(this.graphical_mode=s,this.bus.send("screen-set-mode",this.graphical_mode)),(e^t)&64&&this.complete_replot(),this.update_vga_size(),this.complete_redraw()}break;case 18:a(t),this.color_plane_enable!==t&&(this.color_plane_enable=t,this.complete_redraw());break;case 19:a(t),this.horizontal_panning!==t&&(this.horizontal_panning=t&15,this.update_layers());break;case 20:a(t),this.color_select!==t&&(this.color_select=t,this.complete_redraw());break;default:a(this.attribute_controller_index),a(t)}this.attribute_controller_index=-1}},M.prototype.port3C0_read=function(){return(this.attribute_controller_index|this.palette_source)&255},M.prototype.port3C0_read16=function(){return this.port3C0_read()|this.port3C1_read()<<8&65280},M.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return a(this.attribute_controller_index),a(this.dac_map[this.attribute_controller_index]),this.dac_map[this.attribute_controller_index]&255;switch(this.attribute_controller_index){case 16:return a(this.attribute_mode),this.attribute_mode;case 18:return a(this.color_plane_enable),this.color_plane_enable;case 19:return a(this.horizontal_panning),this.horizontal_panning;case 20:return a(this.color_select),this.color_select;default:a(this.attribute_controller_index)}return 255},M.prototype.port3C2_write=function(t){a(t),this.miscellaneous_output_register=t},M.prototype.port3C4_write=function(t){this.sequencer_index=t},M.prototype.port3C4_read=function(){return this.sequencer_index},M.prototype.port3C5_write=function(t){switch(this.sequencer_index){case 1:a(t);var e=this.clocking_mode;this.clocking_mode=t,(e^t)&32&&this.update_layers();break;case 2:a(t),this.plane_write_bm=t;break;case 4:a(t),this.sequencer_memory_mode=t;break;default:a(this.sequencer_index),a(t)}},M.prototype.port3C5_read=function(){switch(a(this.sequencer_index),this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0},M.prototype.port3C6_write=function(t){this.dac_mask=t},M.prototype.port3C6_read=function(){return this.dac_mask},M.prototype.port3C7_write=function(t){a(t),this.dac_color_index_read=3*t,this.dac_state&=0},M.prototype.port3C7_read=function(){return this.dac_state},M.prototype.port3C8_write=function(t){this.dac_color_index_write=3*t,this.dac_state|=3},M.prototype.port3C8_read=function(){return this.dac_color_index_write/3&255},M.prototype.port3C9_write=function(t){var e=this.dac_color_index_write/3|0,s=this.dac_color_index_write%3,r=this.vga256_palette[e];if(!(this.dispi_enable_value&32)){t&=63;let o=t&1;t=t<<2|o<<1|o}s===0?r=r&-16711681|t<<16:s===1?r=r&-65281|t<<8:(r=r&-256|t,a(e),a(r)),this.vga256_palette[e]!==r&&(this.vga256_palette[e]=r,this.complete_redraw()),this.dac_color_index_write++},M.prototype.port3C9_read=function(){var t=this.vga256_palette[this.dac_color_index_read/3|0]>>8*(2-this.dac_color_index_read%3)&255;return this.dac_color_index_read++,this.dispi_enable_value&32?t:t>>2},M.prototype.port3CC_read=function(){return this.miscellaneous_output_register},M.prototype.port3CE_write=function(t){this.graphics_index=t},M.prototype.port3CE_read=function(){return this.graphics_index},M.prototype.port3CF_write=function(t){switch(this.graphics_index){case 0:this.planar_setreset=t,a(t);break;case 1:this.planar_setreset_enable=t,a(t);break;case 2:this.color_compare=t,a(t);break;case 3:this.planar_rotate_reg=t,a(t);break;case 4:this.plane_read=t,a(t);break;case 5:var e=this.planar_mode;this.planar_mode=t,a(t),(e^t)&96&&this.complete_replot();break;case 6:a(t),this.miscellaneous_graphics_register!==t&&(this.miscellaneous_graphics_register=t,this.update_vga_size());break;case 7:this.color_dont_care=t,a(t);break;case 8:this.planar_bitmap=t,a(t);break;default:a(this.graphics_index),a(t)}},M.prototype.port3CF_read=function(){switch(a(this.graphics_index),this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0},M.prototype.port3D4_write=function(t){this.index_crtc=t},M.prototype.port3D4_read=function(){return this.index_crtc},M.prototype.port3D5_write=function(t){switch(this.index_crtc){case 1:a(t),this.horizontal_display_enable_end!==t&&(this.horizontal_display_enable_end=t,this.update_vga_size());break;case 2:this.horizontal_blank_start!==t&&(this.horizontal_blank_start=t,this.update_vga_size());break;case 7:a(t);var e=this.vertical_display_enable_end;this.vertical_display_enable_end&=255,this.vertical_display_enable_end=this.vertical_display_enable_end|t<<3&512|t<<7&256,e!==this.vertical_display_enable_end&&this.update_vga_size(),this.line_compare=this.line_compare&767|t<<4&256,e=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&767|t<<5&256,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 8:a(t),this.preset_row_scan=t,this.update_layers();break;case 9:a(t),this.max_scan_line=t,this.line_compare=this.line_compare&511|t<<3&512,e=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&511|t<<4&512,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_cursor_scanline(),this.update_layers();break;case 10:a(t),this.cursor_scanline_start=t,this.update_cursor_scanline();break;case 11:a(t),this.cursor_scanline_end=t,this.update_cursor_scanline();break;case 12:(this.start_address>>8&255)!==t&&(this.start_address=this.start_address&255|t<<8,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),a(t),a(this.start_address,4);break;case 13:(this.start_address&255)!==t&&(this.start_address=this.start_address&65280|t,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),a(t),a(this.start_address,4);break;case 14:a(t),this.cursor_address=this.cursor_address&255|t<<8,this.update_cursor();break;case 15:a(t),this.cursor_address=this.cursor_address&65280|t,this.update_cursor();break;case 18:a(t),(this.vertical_display_enable_end&255)!==t&&(this.vertical_display_enable_end=this.vertical_display_enable_end&768|t,this.update_vga_size());break;case 19:a(t),this.offset_register!==t&&(this.offset_register=t,this.update_vga_size(),~this.crtc_mode&3&&this.complete_replot());break;case 20:a(t),this.underline_location_register!==t&&(e=this.underline_location_register,this.underline_location_register=t,this.update_vga_size(),(e^t)&64&&this.complete_replot());break;case 21:a(t),(this.vertical_blank_start&255)!==t&&(this.vertical_blank_start=this.vertical_blank_start&768|t,this.update_vga_size());break;case 23:a(t),this.crtc_mode!==t&&(e=this.crtc_mode,this.crtc_mode=t,this.update_vga_size(),(e^t)&67&&this.complete_replot());break;case 24:a(t),this.line_compare=this.line_compare&768|t,this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=t),a(this.index_crtc),a(t)}},M.prototype.port3D5_read=function(){switch(a(this.index_crtc),this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;case 12:return this.start_address&255;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return this.cursor_address&255;case 18:return this.vertical_display_enable_end&255;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return this.vertical_blank_start&255;case 23:return this.crtc_mode;case 24:return this.line_compare&255}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0},M.prototype.port3DA_read=function(){var t=this.port_3DA_value;return this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(this.port_3DA_value&1&&(this.port_3DA_value^=8),this.port_3DA_value^=1),this.attribute_controller_index=-1,t},M.prototype.port1CE_write=function(t){this.dispi_index=t},M.prototype.port1CF_write=function(t){switch(a(this.dispi_index),a(t),this.dispi_index){case 0:45248<=t&&45253>=t?this.svga_version=t:a(t);break;case 1:this.svga_width=t,2560<this.svga_width&&(this.svga_width=2560);break;case 2:this.svga_height=t,1600<this.svga_height&&(this.svga_height=1600);break;case 3:this.svga_bpp=t;break;case 4:this.svga_enabled=(t&1)===1,this.dispi_enable_value=t;break;case 5:a(t<<16),this.svga_bank_offset=t<<16;break;case 9:let e=t*this.svga_width;a(e),a(t),this.svga_offset_y!==t&&(this.svga_offset_y=t,this.svga_offset=e,this.complete_redraw());break;default:a(this.dispi_index)}!this.svga_enabled||this.svga_width&&this.svga_height||(this.svga_enabled=!1),this.svga_enabled&&this.dispi_index===4&&(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.bus.send("screen-set-mode",!0),this.graphical_mode_is_linear=this.graphical_mode=!0),this.svga_enabled||(this.svga_bank_offset=0),this.update_layers()},M.prototype.port1CF_read=function(){return a(this.dispi_index),this.svga_register_read(this.dispi_index)},M.prototype.svga_register_read=function(t){switch(t){case 0:return this.svga_version;case 1:return this.dispi_enable_value&2?2560:this.svga_width;case 2:return this.dispi_enable_value&2?1600:this.svga_height;case 3:return this.dispi_enable_value&2?32:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return 0;case 9:return this.svga_offset_y;case 10:return this.vga_memory_size/65536|0;default:a(this.dispi_index)}return 255},M.prototype.vga_replot=function(){for(var t=this.diff_plot_min&-16,e=Math.min(this.diff_plot_max|15,524287),s=this.vga_addr_shift_count(),r=~this.crtc_mode&3,o=this.planar_mode&96,l=this.attribute_mode&64;t<=e;){var _=t>>>s;if(r){var f=t/this.virtual_width|0,g=t-this.virtual_width*f;switch(r){case 1:_=(f&1)<<13,f>>>=1;break;case 2:_=(f&1)<<14,f>>>=1;break;case 3:_=(f&3)<<13,f>>>=2}_|=(f*this.virtual_width+g>>>s)+this.start_address}f=this.plane0[_],g=this.plane1[_];var y=this.plane2[_],b=this.plane3[_];switch(_=new Uint8Array(8),o){case 0:f<<=0,g<<=1,y<<=2,b<<=3;for(var v=7;0<=v;v--)_[7-v]=f>>v&1|g>>v&2|y>>v&4|b>>v&8;break;case 32:_[0]=f>>6&3|y>>4&12,_[1]=f>>4&3|y>>2&12,_[2]=f>>2&3|y>>0&12,_[3]=f>>0&3|y<<2&12,_[4]=g>>6&3|b>>4&12,_[5]=g>>4&3|b>>2&12,_[6]=g>>2&3|b>>0&12,_[7]=g>>0&3|b<<2&12;break;case 64:case 96:_[0]=f>>4&15,_[1]=f>>0&15,_[2]=g>>4&15,_[3]=g>>0&15,_[4]=y>>4&15,_[5]=y>>0&15,_[6]=b>>4&15,_[7]=b>>0&15}if(l)for(f=v=0;4>v;v++,t++,f+=2)this.pixel_buffer[t]=_[f]<<4|_[f+1];else for(v=0;8>v;v++,t++)this.pixel_buffer[t]=_[v]}},M.prototype.vga_redraw=function(){var t=this.diff_addr_min,e=Math.min(this.diff_addr_max,524287);let s=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.virtual_width*this.virtual_height);var r=255,o=0;if(this.attribute_mode&128&&(r&=207,o|=this.color_select<<4&48),this.attribute_mode&64)for(;t<=e;t++){var l=this.pixel_buffer[t]&r|o;l=this.vga256_palette[l],s[t]=l&65280|l<<16|l>>16|4278190080}else for(r&=63,o|=this.color_select<<4&192;t<=e;t++)l=this.dac_map[this.pixel_buffer[t]&this.color_plane_enable]&r|o,l=this.vga256_palette[l],s[t]=l&65280|l<<16|l>>16|4278190080},M.prototype.screen_fill_buffer=function(){if(this.graphical_mode){if(this.image_data.data.byteLength===0){var t=new Uint8ClampedArray(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,4*this.virtual_width*this.virtual_height);this.image_data=new ImageData(t,this.virtual_width,this.virtual_height),this.update_layers()}if(this.svga_enabled){t=0;let r=this.svga_height;if(this.svga_bpp===8){let o=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.screen_width*this.screen_height),l=new Uint8Array(this.cpu.wasm_memory.buffer,this.svga_memory.byteOffset,this.vga_memory_size);for(var e=0;e<o.length;e++){var s=this.vga256_palette[l[e]];o[e]=s&65280|s<<16|s>>16|4278190080}}else this.cpu.svga_fill_pixel_buffer(this.svga_bpp,this.svga_offset),e=this.svga_bpp===15?2:this.svga_bpp/8,t=((this.cpu.svga_dirty_bitmap_min_offset[0]/e|0)-this.svga_offset)/this.svga_width|0,r=(((this.cpu.svga_dirty_bitmap_max_offset[0]/e|0)-this.svga_offset)/this.svga_width|0)+1;t<r&&(t=Math.max(t,0),r=Math.min(r,this.svga_height),this.bus.send("screen-fill-buffer-end",[{image_data:this.image_data,screen_x:0,screen_y:t,buffer_x:0,buffer_y:t,buffer_width:this.svga_width,buffer_height:r-t}]))}else this.vga_replot(),this.vga_redraw(),this.bus.send("screen-fill-buffer-end",this.layers);this.reset_diffs()}this.update_vertical_retrace()};function X(t,e){this.cpu=t,this.bus=e,this.use_mouse=this.enable_mouse_stream=!1,this.have_mouse=!0,this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0,this.have_keyboard=!0,this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1,this.kbd_buffer=new w(1024),this.last_port60_byte=0,this.sample_rate=100,this.mouse_id=this.mouse_detect_state=0,this.mouse_reset_workaround=!1,this.wheel_movement=0,this.resolution=4,this.scaling2=!1,this.last_mouse_packet=-1,this.mouse_buffer=new w(1024),this.next_byte_is_aux=this.next_byte_is_ready=!1,this.bus.register("keyboard-code",function(s){this.kbd_send_code(s)},this),this.bus.register("mouse-click",function(s){this.mouse_send_click(s[0],s[1],s[2])},this),this.bus.register("mouse-delta",function(s){this.mouse_send_delta(s[0],s[1])},this),this.bus.register("mouse-wheel",function(s){this.wheel_movement-=s[0],this.wheel_movement-=2*s[1],this.wheel_movement=Math.min(7,Math.max(-8,this.wheel_movement)),this.send_mouse_packet(0,0)},this),this.command_register=5,this.controller_output_port=0,this.read_controller_output_port=this.read_command_register=this.read_output_register=!1,t.io.register_read(96,this,this.port60_read),t.io.register_read(100,this,this.port64_read),t.io.register_write(96,this,this.port60_write),t.io.register_write(100,this,this.port64_write)}X.prototype.get_state=function(){var t=[];return t[0]=this.enable_mouse_stream,t[1]=this.use_mouse,t[2]=this.have_mouse,t[3]=this.mouse_delta_x,t[4]=this.mouse_delta_y,t[5]=this.mouse_clicks,t[6]=this.have_keyboard,t[7]=this.enable_keyboard_stream,t[8]=this.next_is_mouse_command,t[9]=this.next_read_sample,t[10]=this.next_read_led,t[11]=this.next_handle_scan_code_set,t[12]=this.next_read_rate,t[13]=this.next_read_resolution,t[15]=this.last_port60_byte,t[16]=this.sample_rate,t[17]=this.resolution,t[18]=this.scaling2,t[20]=this.command_register,t[21]=this.read_output_register,t[22]=this.read_command_register,t[23]=this.controller_output_port,t[24]=this.read_controller_output_port,t[25]=this.mouse_id,t[26]=this.mouse_detect_state,t[27]=this.mouse_reset_workaround,t},X.prototype.set_state=function(t){this.enable_mouse_stream=t[0],this.use_mouse=t[1],this.have_mouse=t[2],this.mouse_delta_x=t[3],this.mouse_delta_y=t[4],this.mouse_clicks=t[5],this.have_keyboard=t[6],this.enable_keyboard_stream=t[7],this.next_is_mouse_command=t[8],this.next_read_sample=t[9],this.next_read_led=t[10],this.next_handle_scan_code_set=t[11],this.next_read_rate=t[12],this.next_read_resolution=t[13],this.last_port60_byte=t[15],this.sample_rate=t[16],this.resolution=t[17],this.scaling2=t[18],this.command_register=t[20],this.read_output_register=t[21],this.read_command_register=t[22],this.controller_output_port=t[23],this.read_controller_output_port=t[24],this.mouse_id=t[25]||0,this.mouse_detect_state=t[26]||0,this.mouse_reset_workaround=t[27]||!1,this.next_byte_is_aux=this.next_byte_is_ready=!1,this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.bus.send("mouse-enable",this.use_mouse)},X.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())},X.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0,this.command_register&2&&(this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))},X.prototype.kbd_irq=function(){this.next_byte_is_ready=!0,this.next_byte_is_aux=!1,this.command_register&1&&(this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))},X.prototype.kbd_send_code=function(t){this.enable_keyboard_stream&&(a(t),this.kbd_buffer.push(t),this.raise_irq())},X.prototype.mouse_send_delta=function(t,e){if(this.have_mouse&&this.use_mouse){var s=this.resolution*this.sample_rate/80;this.mouse_delta_x+=t*s,this.mouse_delta_y+=e*s,this.enable_mouse_stream&&(t=this.mouse_delta_x|0,e=this.mouse_delta_y|0,t||e)&&(Date.now(),this.mouse_delta_x-=t,this.mouse_delta_y-=e,this.send_mouse_packet(t,e))}},X.prototype.mouse_send_click=function(t,e,s){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=t|s<<1|e<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))},X.prototype.send_mouse_packet=function(t,e){var s=(0>e)<<5|(0>t)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now(),this.mouse_buffer.push(s),this.mouse_buffer.push(t),this.mouse_buffer.push(e),this.mouse_id===4?(this.mouse_buffer.push(0|this.wheel_movement&15),this.wheel_movement=0):this.mouse_id===3&&(this.mouse_buffer.push(this.wheel_movement&255),this.wheel_movement=0),this.raise_irq()},X.prototype.apply_scaling2=function(t){var e=t>>31;switch(Math.abs(t)){case 0:case 1:case 3:return t;case 2:return e;case 4:return 6*e;case 5:return 9*e;default:return t<<1}},X.prototype.port60_read=function(){return this.next_byte_is_ready=!1,!this.kbd_buffer.length&&!this.mouse_buffer.length?this.last_port60_byte:(this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift()):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift()),a(this.last_port60_byte),(this.kbd_buffer.length||this.mouse_buffer.length)&&this.raise_irq(),this.last_port60_byte)},X.prototype.port64_read=function(){var t=16;return this.next_byte_is_ready&&(t|=1),this.next_byte_is_aux&&(t|=32),a(t),t},X.prototype.port60_write=function(t){if(a(t),this.read_command_register)this.command_register=t,this.read_command_register=!1,a(this.command_register);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(t),this.mouse_irq();else if(this.next_read_sample){switch(this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=t,this.mouse_detect_state){case-1:t===60?(this.mouse_reset_workaround=!0,this.mouse_detect_state=0):(this.mouse_reset_workaround=!1,this.mouse_detect_state=t===200?1:0);break;case 0:t===200&&(this.mouse_detect_state=1);break;case 1:this.mouse_detect_state=t===100?2:t===200?3:0;break;case 2:t===80&&(this.mouse_id=3),this.mouse_detect_state=-1;break;case 3:t===80&&(this.mouse_id=4),this.mouse_detect_state=-1}a(t),a(this.mouse_id),this.sample_rate||(this.sample_rate=100),this.mouse_irq()}else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.resolution=3<t?4:1<<t,this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=!1,this.kbd_buffer.push(250),this.kbd_irq(),t||this.kbd_buffer.push(1);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,a(t),this.have_mouse){switch(this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.mouse_buffer.push(250),t){case 230:this.scaling2=!1;break;case 231:this.scaling2=!0;break;case 232:this.next_read_resolution=!0;break;case 233:this.send_mouse_packet(0,0);break;case 235:this.send_mouse_packet(0,0);break;case 242:a(this.mouse_id),this.mouse_buffer.push(this.mouse_id),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0,this.raise_irq();break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0,this.bus.send("mouse-enable",!0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4;break;case 255:this.mouse_buffer.push(170),this.mouse_buffer.push(0),this.use_mouse=!0,this.bus.send("mouse-enable",!0),this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4,this.mouse_reset_workaround||(this.mouse_id=0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:a(t)}this.mouse_irq()}}else if(this.read_controller_output_port)this.read_controller_output_port=!1,this.controller_output_port=t;else{switch(a(t),this.mouse_buffer.clear(),this.kbd_buffer.clear(),this.kbd_buffer.push(250),t){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171),this.kbd_buffer.push(131);break;case 243:this.next_read_rate=!0;break;case 244:this.enable_keyboard_stream=!0;break;case 245:this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear(),this.kbd_buffer.push(250),this.kbd_buffer.push(170),this.kbd_buffer.push(0);break;default:a(t)}this.kbd_irq()}},X.prototype.port64_write=function(t){switch(a(t),t){case 32:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(this.command_register),this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 209:this.read_controller_output_port=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:this.command_register|=32;break;case 168:this.command_register&=-33;break;case 169:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 170:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(85),this.kbd_irq();break;case 171:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 173:this.command_register|=16;break;case 174:this.command_register&=-17;break;case 254:this.cpu.reboot_internal();break;default:a(t)}};function Q(t){this.cpu=t,this.cmos_index=0,this.cmos_data=new Uint8Array(128),this.last_update=this.rtc_time=Date.now(),this.next_interrupt_alarm=this.next_interrupt=0,this.periodic_interrupt=!1,this.periodic_interrupt_time=.9765625,this.cmos_a=38,this.cmos_b=2,this.nmi_disabled=this.cmos_c=0,t.io.register_write(112,this,function(e){this.cmos_index=e&127,this.nmi_disabled=e>>7}),t.io.register_write(113,this,this.cmos_port_write),t.io.register_read(113,this,this.cmos_port_read)}Q.prototype.get_state=function(){var t=[];return t[0]=this.cmos_index,t[1]=this.cmos_data,t[2]=this.rtc_time,t[3]=this.last_update,t[4]=this.next_interrupt,t[5]=this.next_interrupt_alarm,t[6]=this.periodic_interrupt,t[7]=this.periodic_interrupt_time,t[8]=this.cmos_a,t[9]=this.cmos_b,t[10]=this.cmos_c,t[11]=this.nmi_disabled,t},Q.prototype.set_state=function(t){this.cmos_index=t[0],this.cmos_data=t[1],this.rtc_time=t[2],this.last_update=t[3],this.next_interrupt=t[4],this.next_interrupt_alarm=t[5],this.periodic_interrupt=t[6],this.periodic_interrupt_time=t[7],this.cmos_a=t[8],this.cmos_b=t[9],this.cmos_c=t[10],this.nmi_disabled=t[11]},Q.prototype.timer=function(t){t=Date.now(),this.rtc_time+=t-this.last_update,this.last_update=t,this.periodic_interrupt&&this.next_interrupt<t?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((t-this.next_interrupt)/this.periodic_interrupt_time)):this.next_interrupt_alarm&&this.next_interrupt_alarm<t&&(this.cpu.device_raise_irq(8),this.cmos_c|=160,this.next_interrupt_alarm=0);let e=100;return this.periodic_interrupt&&this.next_interrupt&&(e=Math.min(e,Math.max(0,this.next_interrupt-t))),this.next_interrupt_alarm&&(e=Math.min(e,Math.max(0,this.next_interrupt_alarm-t))),e},Q.prototype.bcd_pack=function(t){for(var e=0,s=0,r;t;)r=t%10,s|=r<<4*e,e++,t=(t-r)/10;return s},Q.prototype.bcd_unpack=function(t){return(t&15)+10*(t>>4&15)},Q.prototype.encode_time=function(t){return this.cmos_b&4?t:this.bcd_pack(t)},Q.prototype.decode_time=function(t){return this.cmos_b&4?t:this.bcd_unpack(t)},Q.prototype.cmos_port_read=function(){var t=this.cmos_index;switch(t){case 0:return a(this.encode_time(new Date(this.rtc_time).getUTCSeconds())),this.encode_time(new Date(this.rtc_time).getUTCSeconds());case 2:return a(this.encode_time(new Date(this.rtc_time).getUTCMinutes())),this.encode_time(new Date(this.rtc_time).getUTCMinutes());case 4:return a(this.encode_time(new Date(this.rtc_time).getUTCHours())),this.encode_time(new Date(this.rtc_time).getUTCHours());case 6:return a(this.encode_time(new Date(this.rtc_time).getUTCDay()+1)),this.encode_time(new Date(this.rtc_time).getUTCDay()+1);case 7:return a(this.encode_time(new Date(this.rtc_time).getUTCDate())),this.encode_time(new Date(this.rtc_time).getUTCDate());case 8:return a(this.encode_time(new Date(this.rtc_time).getUTCMonth()+1)),this.encode_time(new Date(this.rtc_time).getUTCMonth()+1);case 9:return a(this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100)),this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100);case 10:return 999<=u.microtick()%1e3?this.cmos_a|128:this.cmos_a;case 11:return this.cmos_b;case 12:return this.cpu.device_lower_irq(8),t=this.cmos_c,this.cmos_c&=-241,t;case 13:return 0;case 50:case 55:return a(this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0)),this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0);default:return a(t),this.cmos_data[this.cmos_index]}},Q.prototype.cmos_port_write=function(t){switch(this.cmos_index){case 10:this.cmos_a=t&127,this.periodic_interrupt_time=1e3/(32768>>(this.cmos_a&15)-1),a(this.cmos_a,2);break;case 11:if(this.cmos_b=t,this.cmos_b&64&&(this.next_interrupt=Date.now()),this.cmos_b&32){t=new Date;let e=this.decode_time(this.cmos_data[1]),s=this.decode_time(this.cmos_data[3]),r=this.decode_time(this.cmos_data[5]);this.next_interrupt_alarm=+new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),r,s,e))}a(this.cmos_b,2);break;case 1:case 3:case 5:this.cmos_write(this.cmos_index,t);break;default:a(this.cmos_index),a(t)}this.periodic_interrupt=(this.cmos_b&64)===64&&0<(this.cmos_a&15)},Q.prototype.cmos_read=function(t){return this.cmos_data[t]},Q.prototype.cmos_write=function(t,e){a(t),a(e),this.cmos_data[t]=e};function nt(t,e,s){switch(this.bus=s,this.cpu=t,this.ints=4,this.line_control=this.baud_rate=0,this.lsr=96,this.ier=this.fifo_control=0,this.iir=1,this.irq=this.scratch_register=this.modem_status=this.modem_control=0,this.input=[],this.current_line="",e){case 1016:this.com=0,this.irq=4;break;case 760:this.com=1,this.irq=3;break;case 1e3:this.com=2,this.irq=4;break;case 744:this.irq=this.com=3;break;default:""+a(e),this.com=0,this.irq=4}this.bus.register("serial"+this.com+"-input",function(r){this.data_received(r)},this),this.bus.register("serial"+this.com+"-modem-status-input",function(r){this.set_modem_status(r)},this),this.bus.register("serial"+this.com+"-carrier-detect-input",function(r){this.set_modem_status(r?this.modem_status|136:this.modem_status&-137)},this),this.bus.register("serial"+this.com+"-ring-indicator-input",function(r){this.set_modem_status(r?this.modem_status|68:this.modem_status&-69)},this),this.bus.register("serial"+this.com+"-data-set-ready-input",function(r){this.set_modem_status(r?this.modem_status|34:this.modem_status&-35)},this),this.bus.register("serial"+this.com+"-clear-to-send-input",function(r){this.set_modem_status(r?this.modem_status|17:this.modem_status&-18)},this),t=t.io,t.register_write(e,this,function(r){this.write_data(r)},function(r){this.write_data(r&255),this.write_data(r>>8)}),t.register_write(e|1,this,function(r){this.line_control&128?(this.baud_rate=this.baud_rate&255|r<<8,a(this.baud_rate)):(!(this.ier&2)&&r&2&&this.ThrowInterrupt(2),this.ier=r&15,a(r),this.CheckInterrupt())}),t.register_read(e,this,function(){if(this.line_control&128)return this.baud_rate&255;let r=0;return this.input.length!==0&&(r=this.input.shift(),a(r)),this.input.length===0&&(this.lsr&=-2,this.ClearInterrupt(12),this.ClearInterrupt(4)),r}),t.register_read(e|1,this,function(){return this.line_control&128?this.baud_rate>>8:this.ier&15}),t.register_read(e|2,this,function(){var r=this.iir&15;return a(this.iir),this.iir===2&&this.ClearInterrupt(2),this.fifo_control&1&&(r|=192),r}),t.register_write(e|2,this,function(r){a(r),this.fifo_control=r}),t.register_read(e|3,this,function(){return a(this.line_control),this.line_control}),t.register_write(e|3,this,function(r){a(r),this.line_control=r}),t.register_read(e|4,this,function(){return this.modem_control}),t.register_write(e|4,this,function(r){a(r),this.modem_control=r}),t.register_read(e|5,this,function(){return a(this.lsr),this.lsr}),t.register_write(e|5,this,function(){}),t.register_read(e|6,this,function(){return a(this.modem_status),this.modem_status&=240}),t.register_write(e|6,this,function(r){a(r),this.set_modem_status(r)}),t.register_read(e|7,this,function(){return this.scratch_register}),t.register_write(e|7,this,function(r){this.scratch_register=r})}nt.prototype.get_state=function(){var t=[];return t[0]=this.ints,t[1]=this.baud_rate,t[2]=this.line_control,t[3]=this.lsr,t[4]=this.fifo_control,t[5]=this.ier,t[6]=this.iir,t[7]=this.modem_control,t[8]=this.modem_status,t[9]=this.scratch_register,t[10]=this.irq,t},nt.prototype.set_state=function(t){this.ints=t[0],this.baud_rate=t[1],this.line_control=t[2],this.lsr=t[3],this.fifo_control=t[4],this.ier=t[5],this.iir=t[6],this.modem_control=t[7],this.modem_status=t[8],this.scratch_register=t[9],this.irq=t[10]},nt.prototype.CheckInterrupt=function(){this.ints&4096&&this.ier&1?(this.iir=12,this.cpu.device_raise_irq(this.irq)):this.ints&16&&this.ier&1?(this.iir=4,this.cpu.device_raise_irq(this.irq)):this.ints&4&&this.ier&2?(this.iir=2,this.cpu.device_raise_irq(this.irq)):this.ints&1&&this.ier&8?(this.iir=0,this.cpu.device_raise_irq(this.irq)):(this.iir=1,this.cpu.device_lower_irq(this.irq))},nt.prototype.ThrowInterrupt=function(t){this.ints|=1<<t,this.CheckInterrupt()},nt.prototype.ClearInterrupt=function(t){this.ints&=~(1<<t),this.CheckInterrupt()},nt.prototype.data_received=function(t){a(t),this.input.push(t),this.lsr|=1,this.fifo_control&1?this.ThrowInterrupt(12):this.ThrowInterrupt(4)},nt.prototype.write_data=function(t){this.line_control&128?this.baud_rate=this.baud_rate&-256|t:(a(t),this.ThrowInterrupt(2),this.bus.send("serial"+this.com+"-output-byte",t))},nt.prototype.set_modem_status=function(t){a(t);let e=this.modem_status&15,s=(this.modem_status^t)>>4;this.modem_status=t,this.modem_status=this.modem_status|s|e};function lt(t){this.cpu=t;var e=t.io;t.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"}),this.timer_imprecision_offset=this.timer_last_value=0,this.status=1,this.pm1_enable=this.pm1_status=0,this.last_timer=this.get_timer(u.microtick()),this.gpe=new Uint8Array(4),e.register_read(45056,this,void 0,function(){return this.pm1_status}),e.register_write(45056,this,void 0,function(s){a(s,4),this.pm1_status&=~s}),e.register_read(45058,this,void 0,function(){return this.pm1_enable}),e.register_write(45058,this,void 0,function(s){a(s),this.pm1_enable=s}),e.register_read(45060,this,void 0,function(){return this.status}),e.register_write(45060,this,void 0,function(s){a(s),this.status=s}),e.register_read(45064,this,void 0,void 0,function(){return this.get_timer(u.microtick())&16777215}),e.register_read(45024,this,function(){return this.gpe[0]}),e.register_read(45025,this,function(){return this.gpe[1]}),e.register_read(45026,this,function(){return this.gpe[2]}),e.register_read(45027,this,function(){return this.gpe[3]}),e.register_write(45024,this,function(s){a(s),this.gpe[0]=s}),e.register_write(45025,this,function(s){a(s),this.gpe[1]=s}),e.register_write(45026,this,function(s){a(s),this.gpe[2]=s}),e.register_write(45027,this,function(s){a(s),this.gpe[3]=s})}lt.prototype.timer=function(t){t=this.get_timer(t);var e=((t^this.last_timer)&8388608)!==0;return this.pm1_enable&1&&e?(this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9),this.last_timer=t,100},lt.prototype.get_timer=function(t){return t=Math.round(3579.545*t),t===this.timer_last_value?3579.545>this.timer_imprecision_offset&&this.timer_imprecision_offset++:this.timer_last_value+this.timer_imprecision_offset<=t&&(this.timer_imprecision_offset=0,this.timer_last_value=t),this.timer_last_value+this.timer_imprecision_offset},lt.prototype.get_state=function(){var t=[];return t[0]=this.status,t[1]=this.pm1_status,t[2]=this.pm1_enable,t[3]=this.gpe,t},lt.prototype.set_state=function(t){this.status=t[0],this.pm1_status=t[1],this.pm1_enable=t[2],this.gpe=t[3]};function it(t){this.cpu=t,this.timer_divider=this.apic_id=0,this.timer_divider_shift=1,this.timer_current_count=this.timer_initial_count=0,this.next_tick=u.microtick(),this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_timer=65536,this.icr1=this.icr0=this.tpr=0,this.irr=new Int32Array(8),this.isr=new Int32Array(8),this.tmr=new Int32Array(8),this.spurious_vector=254,this.destination_format=-1,this.read_error=this.error=this.local_destination=0,t.io.mmap_register(4276092928,1048576,e=>{a(e>>>0);var s=e&3;return this.read32(e&-4)>>8*s&255},(e,s)=>{a(e),a(s)},e=>this.read32(e),(e,s)=>this.write32(e,s))}it.prototype.read32=function(t){switch(t=t-4276092928|0,t){case 32:return this.apic_id;case 48:return 327700;case 128:return this.tpr;case 208:return this.local_destination;case 224:return this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return t=t-256>>4,a(this.isr[t]>>>0,8),this.isr[t];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return t=t-384>>4,a(this.tmr[t]>>>0,8),this.tmr[t];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return t=t-512>>4,a(this.irr[t]>>>0,8),this.irr[t];case 640:return a(this.read_error>>>0,8),this.read_error;case 768:return this.icr0;case 784:return this.icr1;case 800:return this.lvt_timer;case 832:return this.lvt_perf_counter;case 848:return this.lvt_int0;case 864:return this.lvt_int1;case 880:return this.lvt_error;case 992:return this.timer_divider;case 896:return this.timer_initial_count;case 912:return a(this.timer_current_count>>>0,8),this.timer_current_count;default:return a(t),0}},it.prototype.write32=function(t,e){switch(t=t-4276092928|0,t){case 32:a(e>>>8,8),this.apic_id=e;break;case 48:a(e>>>0,8);break;case 128:this.tpr=e&255,this.check_vector();break;case 176:e=this.highest_isr(),e!==-1&&(this.register_clear_bit(this.isr,e),this.register_get_bit(this.tmr,e)&&this.cpu.devices.ioapic.remote_eoi(e),this.check_vector());break;case 208:a(e>>>0,8),this.local_destination=e&4278190080;break;case 224:a(e>>>0,8),this.destination_format=e|16777215;break;case 240:a(e>>>0,8),this.spurious_vector=e;break;case 640:a(e>>>0,8),this.read_error=this.error,this.error=0;break;case 768:t=e&255;var s=e>>8&7,r=e>>11&1,o=e>>15&1,l=e>>18&3,_=this.icr1>>>24;a(e,8),a(t,2),this.icr0=e&-4097,l===0?this.route(t,s,o,_,r):l===1?this.deliver(t,0,o):l===2&&this.deliver(t,s,o);break;case 784:a(e>>>0,8),this.icr1=e;break;case 800:a(e>>>0,8),this.lvt_timer=e;break;case 832:a(e>>>0,8),this.lvt_perf_counter=e;break;case 848:a(e>>>0,8),this.lvt_int0=e;break;case 864:a(e>>>0,8),this.lvt_int1=e;break;case 880:a(e>>>0,8),this.lvt_error=e;break;case 992:a(e>>>0,8),this.timer_divider=e,e=e&3|(e&8)>>1,this.timer_divider_shift=e===7?0:e+1;break;case 896:a(e>>>0,8),this.timer_initial_count=e>>>0,this.timer_current_count=e>>>0,this.next_tick=u.microtick(),this.timer_active=!0;break;case 912:a(e>>>0,8);break;default:a(t),a(e>>>0,8)}},it.prototype.timer=function(t){if(this.timer_current_count===0)return 100;let e=1e6/(1<<this.timer_divider_shift);return t=(t-this.next_tick)*e>>>0,this.next_tick+=t/e,this.timer_current_count-=t,0>=this.timer_current_count&&(t=this.lvt_timer&393216,t===131072?(this.timer_current_count%=this.timer_initial_count,0>=this.timer_current_count&&(this.timer_current_count+=this.timer_initial_count),!(this.lvt_timer&65536)&&this.deliver(this.lvt_timer&255,0,!1)):t===0&&(this.timer_current_count=0,!(this.lvt_timer&65536)&&this.deliver(this.lvt_timer&255,0,!1))),Math.max(0,this.timer_current_count/e)},it.prototype.route=function(t,e,s){this.deliver(t,e,s)},it.prototype.deliver=function(t,e,s){e!==5&&e!==4&&(this.register_get_bit(this.irr,t)?a(t,2):(this.register_set_bit(this.irr,t),s?this.register_set_bit(this.tmr,t):this.register_clear_bit(this.tmr,t),this.check_vector()))},it.prototype.highest_irr=function(){return this.register_get_highest_bit(this.irr)},it.prototype.highest_isr=function(){return this.register_get_highest_bit(this.isr)},it.prototype.check_vector=function(){var t=this.highest_irr();t!==-1&&(this.highest_isr()>=t||(t&240)<=(this.tpr&240)||this.cpu.handle_irqs())},it.prototype.acknowledge_irq=function(){var t=this.highest_irr();return t===-1||this.highest_isr()>=t||(t&240)<=(this.tpr&240)?-1:(this.register_clear_bit(this.irr,t),this.register_set_bit(this.isr,t),this.check_vector(),t)},it.prototype.get_state=function(){var t=[];return t[0]=this.apic_id,t[1]=this.timer_divider,t[2]=this.timer_divider_shift,t[3]=this.timer_initial_count,t[4]=this.timer_current_count,t[5]=this.next_tick,t[6]=this.lvt_timer,t[7]=this.lvt_perf_counter,t[8]=this.lvt_int0,t[9]=this.lvt_int1,t[10]=this.lvt_error,t[11]=this.tpr,t[12]=this.icr0,t[13]=this.icr1,t[14]=this.irr,t[15]=this.isr,t[16]=this.tmr,t[17]=this.spurious_vector,t[18]=this.destination_format,t[19]=this.local_destination,t[20]=this.error,t[21]=this.read_error,t},it.prototype.set_state=function(t){this.apic_id=t[0],this.timer_divider=t[1],this.timer_divider_shift=t[2],this.timer_initial_count=t[3],this.timer_current_count=t[4],this.next_tick=t[5],this.lvt_timer=t[6],this.lvt_perf_counter=t[7],this.lvt_int0=t[8],this.lvt_int1=t[9],this.lvt_error=t[10],this.tpr=t[11],this.icr0=t[12],this.icr1=t[13],this.irr=t[14],this.isr=t[15],this.tmr=t[16],this.spurious_vector=t[17],this.destination_format=t[18],this.local_destination=t[19],this.error=t[20],this.read_error=t[21]},it.prototype.register_get_bit=function(t,e){return t[e>>5]>>(e&31)&1},it.prototype.register_set_bit=function(t,e){t[e>>5]|=1<<(e&31)},it.prototype.register_clear_bit=function(t,e){t[e>>5]&=~(1<<(e&31))},it.prototype.register_get_highest_bit=function(t){for(var e=7;0<=e;e--){var s=t[e];if(s)return m.int_log2(s>>>0)|e<<5}return-1};function Yt(t){this.cpu=t,this.ioredtbl_config=new Int32Array(24),this.ioredtbl_destination=new Int32Array(24);for(var e=0;e<this.ioredtbl_config.length;e++)this.ioredtbl_config[e]=65536;this.irq_value=this.irr=this.ioapic_id=this.ioregsel=0,t.io.mmap_register(4273995776,131072,s=>(s=s-4273995776|0,16<=s&&20>s?(s-=16,a(this.ioregsel),this.read(this.ioregsel)>>8*s&255):(a(s>>>0),0)),s=>{a(s>>>0)},s=>(s=s-4273995776|0,s===0?this.ioregsel:s===16?this.read(this.ioregsel):(a(s>>>0),0)),(s,r)=>{s=s-4273995776|0,s===0?this.ioregsel=r:s===16?this.write(this.ioregsel,r):(a(s>>>0),a(r>>>0,8))})}Yt.prototype.remote_eoi=function(t){for(var e=0;24>e;e++){var s=this.ioredtbl_config[e];(s&255)===t&&s&16384&&(a(e),this.ioredtbl_config[e]&=-16385,this.check_irq(e))}},Yt.prototype.check_irq=function(t){var e=1<<t;if(this.irr&e){var s=this.ioredtbl_config[t];if(!(s&65536)){var r=s>>8&7,o=this.ioredtbl_destination[t]>>>24;if(!(s&32768))this.irr&=~e;else if(this.ioredtbl_config[t]|=16384,s&16384)return;r!==0&&r!==1||this.cpu.devices.apic.route(s&255,r,(s&32768)===32768,o,s>>11&1),this.ioredtbl_config[t]&=-4097}}},Yt.prototype.set_irq=function(t){if(!(24<=t)){var e=1<<t;!(this.irq_value&e)&&(this.irq_value|=e,(this.ioredtbl_config[t]&98304)!==65536&&(this.irr|=e,this.check_irq(t)))}},Yt.prototype.clear_irq=function(t){if(!(24<=t)){var e=1<<t;(this.irq_value&e)===e&&(this.irq_value&=~e,this.ioredtbl_config[t]&32768&&(this.irr&=~e))}},Yt.prototype.read=function(t){if(t===0)return this.ioapic_id<<24;if(t===1)return 1507345;if(t===2)return this.ioapic_id<<24;if(16<=t&&64>t){var e=t-16>>1;return t=t&1?this.ioredtbl_destination[e]:this.ioredtbl_config[e],a(e),a(t,8),t}return a(t),0},Yt.prototype.write=function(t,e){if(t===0)this.ioapic_id=e>>>24&15;else if(t!==1&&t!==2)if(16<=t&&64>t){var s=t-16>>1;t&1?(this.ioredtbl_destination[s]=e&4278190080,a(e>>>0,8),a(s),a(e>>>24,2)):(this.ioredtbl_config[s]=e&110591|this.ioredtbl_config[s]&-110592,t=e&255,a(e>>>0,8),a(s),a(t,2),this.check_irq(s))}else a(t),a(e>>>0,8)},Yt.prototype.get_state=function(){var t=[];return t[0]=this.ioredtbl_config,t[1]=this.ioredtbl_destination,t[2]=this.ioregsel,t[3]=this.ioapic_id,t[4]=this.irr,t[5]=this.irq_value,t},Yt.prototype.set_state=function(t){this.ioredtbl_config=t[0],this.ioredtbl_destination=t[1],this.ioregsel=t[2],this.ioapic_id=t[3],this.irr=t[4],this.irq_value=t[5]};function le(t){this.message=t}le.prototype=Error();let wo={Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array};function Vi(t,e){if(typeof t!="object"||t===null)return t;if(t instanceof Array)return t.map(o=>Vi(o,e));if(t.constructor===Object&&console.log(t),t.BYTES_PER_ELEMENT){var s=new Uint8Array(t.buffer,t.byteOffset,t.length*t.BYTES_PER_ELEMENT);return{__state_type__:t.constructor.name.replace("bound ",""),buffer_id:e.push(s)-1}}t=t.get_state(),s=[];for(var r=0;r<t.length;r++)s[r]=Vi(t[r],e);return s}function Yi(t,e){if(typeof t!="object"||t===null)return t;if(t instanceof Array){for(let s=0;s<t.length;s++)t[s]=Yi(t[s],e);return t}return new wo[t.__state_type__](e[t.buffer_id])}$.prototype.save_state=function(){for(var t=[],e=Vi(this,t),s=[],r=0,o=0;o<t.length;o++){var l=t[o].byteLength;s[o]={offset:r,length:l},r+=l,r=r+3&-4}o=JSON.stringify({buffer_infos:s,state:e}),o=new TextEncoder().encode(o),e=16+o.length,e=e+3&-4,l=e+r,r=new ArrayBuffer(l);var _=new Int32Array(r,0,4);for(new Uint8Array(r,16,o.length).set(o),e=new Uint8Array(r,e),_[0]=-2039052682,_[1]=6,_[2]=l,_[3]=o.length,o=0;o<t.length;o++)e.set(t[o],s[o].offset);return r},$.prototype.restore_state=function(t){function e(v,C){let x=v.length;if(16>x)throw new le("Invalid length: "+x);if(v=new Int32Array(v.buffer,v.byteOffset,4),v[0]!==-2039052682)throw new le("Invalid header: "+a(v[0]>>>0));if(v[1]!==6)throw new le("Version mismatch: dump="+v[1]+" we=6");if(C&&v[2]!==x)throw new le("Length doesn't match header: real="+x+" header="+v[2]);return v[3]}function s(v){return v=new TextDecoder().decode(v),JSON.parse(v)}if(t=new Uint8Array(t),new Uint32Array(t.buffer,0,1)[0]===4247762216){var r=this.zstd_create_ctx(t.length);new Uint8Array(this.wasm_memory.buffer,this.zstd_get_src_ptr(r),t.length).set(t);var o=this.zstd_read(r,16),l=new Uint8Array(this.wasm_memory.buffer,o,16),_=e(l,!1);this.zstd_read_free(o,16),o=this.zstd_read(r,_),l=new Uint8Array(this.wasm_memory.buffer,o,_),l=s(l),this.zstd_read_free(o,_),o=l.state;var f=l.buffer_infos;l=[],_=16+_;for(var g of f){if(f=(_+3&-4)-_,1048576<g.length){var y=this.zstd_read(r,f);this.zstd_read_free(y,f),y=new Uint8Array(g.length),l.push(y.buffer);for(var b=0;b<g.length;){let v=Math.min(g.length-b,1048576),C=this.zstd_read(r,v);y.set(new Uint8Array(this.wasm_memory.buffer,C,v),b),this.zstd_read_free(C,v),b+=v}}else y=this.zstd_read(r,f+g.length),b=y+f,l.push(this.wasm_memory.buffer.slice(b,b+g.length)),this.zstd_read_free(y,f+g.length);_+=f+g.length}o=Yi(o,l),this.set_state(o),this.zstd_free_ctx(r)}else{if(r=e(t,!0),0>r||r+12>=t.length)throw new le("Invalid info block length: "+r);g=t.subarray(16,16+r),o=s(g),g=o.state,o=o.buffer_infos;let v=16+r;v=v+3&-4,r=o.map(C=>{let x=v+C.offset;return t.buffer.slice(x,x+C.length)}),g=Yi(g,r),this.set_state(g)}};function ir(t,e,s){t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&(t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t[4]=s[4],t[5]=s[5]),t[6]===e[0]&&t[7]===e[1]&&t[8]===e[2]&&t[9]===e[3]&&t[10]===e[4]&&t[11]===e[5]&&(t[6]=s[0],t[7]=s[1],t[8]=s[2],t[9]=s[3],t[10]=s[4],t[11]=s[5]);var r=t[12]<<8|t[13];if(r===2048){if(t=t.subarray(14),t[0]>>4===4&&t[9]===17){t=t.subarray(20),r=t[0]<<8|t[1];var o=t[2]<<8|t[3];if(a(t[6]<<8|t[7],4),r===67||o===67)if(r=t.subarray(8),o=r[236]<<24|r[237]<<16|r[238]<<8|r[239],o!==1669485411)a(o,8);else for(r[28]===e[0]&&r[29]===e[1]&&r[30]===e[2]&&r[31]===e[3]&&r[32]===e[4]&&r[33]===e[5]&&(r[28]=s[0],r[29]=s[1],r[30]=s[2],r[31]=s[3],r[32]=s[4],r[33]=s[5],t[6]=t[7]=0),o=240;o<r.length;){let l=r[o++];if(l===255)break;let _=r[o++];l===61&&r[o+0]===1&&r[o+1]===e[0]&&r[o+2]===e[1]&&r[o+3]===e[2]&&r[o+4]===e[3]&&r[o+5]===e[4]&&r[o+6]===e[5]&&(r[o+1]=s[0],r[o+2]=s[1],r[o+3]=s[2],r[o+4]=s[3],r[o+5]=s[4],r[o+6]=s[5],t[6]=t[7]=0),o+=_}}}else r===2054&&(t=t.subarray(14),De(t.subarray(8,14)),De(t.subarray(18,24)),t[8]===e[0]&&t[9]===e[1]&&t[10]===e[2]&&t[11]===e[3]&&t[12]===e[4]&&t[13]===e[5]&&(t[8]=s[0],t[9]=s[1],t[10]=s[2],t[11]=s[3],t[12]=s[4],t[13]=s[5]))}function De(t){return[t[0].toString(16).padStart(2,"0"),t[1].toString(16).padStart(2,"0"),t[2].toString(16).padStart(2,"0"),t[3].toString(16).padStart(2,"0"),t[4].toString(16).padStart(2,"0"),t[5].toString(16).padStart(2,"0")].join(":")}function St(t,e,s,r){for(this.cpu=t,this.pci=t.devices.pci,this.preserve_mac_from_state_image=s,this.mac_address_translation=r,this.bus=e,this.bus.register("net0-receive",function(o){this.receive(o)},this),this.port=768,this.name="ne2k",this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,this.port&255|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=40,this.pci_bars=[{size:32}],this.imr=this.isr=0,this.cr=1,this.tpsr=this.tcnt=this.rcnt=this.dcfg=0,this.memory=new Uint8Array(32768),this.txcr=this.rxcr=0,this.tsr=1,this.mac=new Uint8Array([0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0]),this.mar=Uint8Array.of(255,255,255,255,255,255,255,255),this.mac_address_in_state=null,e=0;6>e;e++)this.memory[e<<1]=this.memory[e<<1|1]=this.mac[e];this.memory[28]=this.memory[29]=87,this.memory[30]=this.memory[31]=87,""+De(this.mac),this.rsar=0,this.pstart=64,this.pstop=128,this.boundary=this.curpg=76,e=t.io,e.register_read(this.port|0,this,function(){return this.cr}),e.register_write(this.port|0,this,function(o){this.cr=o,a(o,2),a(this.txcr,2),this.cr&1||(o&24&&this.rcnt===0&&this.do_interrupt(64),o&4&&(o=this.tpsr<<8,o=this.memory.subarray(o,o+this.tcnt),this.mac_address_in_state&&(o=new Uint8Array(o),ir(o,this.mac_address_in_state,this.mac)),this.bus.send("net0-send",o),this.bus.send("eth-transmit-end",[o.length]),this.cr&=-5,this.do_interrupt(2),a(o.byteLength)))}),e.register_read(this.port|13,this,function(){return this.get_page()===1?this.mar[5]:0}),e.register_read(this.port|14,this,function(){return this.get_page()===1?this.mar[6]:0},function(){return this.get_page(),0}),e.register_read(this.port|15,this,function(){return this.get_page()===1?this.mar[7]:0}),e.register_read(this.port|31,this,function(){return this.get_page(),this.do_interrupt(128),0}),e.register_write(this.port|31,this,function(o){this.get_page(),a(o,2)}),e.register_read(this.port|1,this,function(){var o=this.get_page();return o===0?this.pstart:o===1?this.mac[0]:o===2?this.pstart:0}),e.register_write(this.port|1,this,function(o){var l=this.get_page();l===0?(a(o,2),this.pstart=o):l===1?(a(o),this.mac[0]=o):a(o)}),e.register_read(this.port|2,this,function(){var o=this.get_page();return o===0?this.pstop:o===1?this.mac[1]:o===2?this.pstop:0}),e.register_write(this.port|2,this,function(o){var l=this.get_page();l===0?(a(o,2),o>this.memory.length>>8&&(o=this.memory.length>>8,a(o)),this.pstop=o):l===1?(a(o),this.mac[1]=o):a(o)}),e.register_read(this.port|7,this,function(){var o=this.get_page();return o===0?(a(this.isr,2),this.isr):o===1?(a(this.curpg,2),this.curpg):0}),e.register_write(this.port|7,this,function(o){var l=this.get_page();l===0?(a(o,2),this.isr&=~o,this.update_irq()):l===1&&(a(o,2),this.curpg=o)}),e.register_write(this.port|13,this,function(o){this.get_page()===0&&(this.txcr=o),a(o,2)}),e.register_write(this.port|14,this,function(o){this.get_page()===0?(a(o,2),this.dcfg=o):a(o,2)}),e.register_read(this.port|10,this,function(){var o=this.get_page();return o===0?80:o===1?this.mar[2]:0}),e.register_write(this.port|10,this,function(o){this.get_page()===0?(a(o,2),this.rcnt=this.rcnt&65280|o&255):a(o,2)}),e.register_read(this.port|11,this,function(){var o=this.get_page();return o===0?67:o===1?this.mar[3]:0}),e.register_write(this.port|11,this,function(o){this.get_page()===0?(a(o,2),this.rcnt=this.rcnt&255|o<<8&65280):a(o,2)}),e.register_read(this.port|8,this,function(){var o=this.get_page();return o===0?this.rsar&255:o===1?this.mar[0]:0}),e.register_write(this.port|8,this,function(o){this.get_page()===0?(a(o,2),this.rsar=this.rsar&65280|o&255):a(o,2)}),e.register_read(this.port|9,this,function(){var o=this.get_page();return o===0?this.rsar>>8&255:o===1?this.mar[1]:0}),e.register_write(this.port|9,this,function(o){this.get_page()===0?(a(o,2),this.rsar=this.rsar&255|o<<8&65280):a(o,2)}),e.register_write(this.port|15,this,function(o){this.get_page()===0?(a(o,2),a(this.isr,2),this.imr=o,this.update_irq()):a(o,2)}),e.register_read(this.port|3,this,function(){var o=this.get_page();return o===0?(a(this.boundary,2),this.boundary):o===1?this.mac[2]:0}),e.register_write(this.port|3,this,function(o){var l=this.get_page();l===0?(a(o,2),this.boundary=o):l===1?(a(o),this.mac[2]=o):a(o)}),e.register_read(this.port|4,this,function(){var o=this.get_page();return o===0?this.tsr:o===1?this.mac[3]:0}),e.register_write(this.port|4,this,function(o){var l=this.get_page();l===0?(a(o,2),this.tpsr=o):l===1?(a(o),this.mac[3]=o):a(o)}),e.register_read(this.port|5,this,function(){var o=this.get_page();return o===0?0:o===1?this.mac[4]:0}),e.register_write(this.port|5,this,function(o){var l=this.get_page();l===0?(a(o,2),this.tcnt=this.tcnt&-256|o):l===1?(a(o),this.mac[4]=o):a(o)}),e.register_read(this.port|6,this,function(){var o=this.get_page();return o===0?0:o===1?this.mac[5]:0}),e.register_write(this.port|6,this,function(o){var l=this.get_page();l===0?(a(o,2),this.tcnt=this.tcnt&255|o<<8):l===1?(a(o),this.mac[5]=o):a(o)}),e.register_read(this.port|12,this,function(){var o=this.get_page();return o===0?9:o===1?this.mar[4]:0}),e.register_write(this.port|12,this,function(o){this.get_page()===0?(a(o,2),this.rxcr=o):a(o)}),e.register_read(this.port|16,this,this.data_port_read8,this.data_port_read16,this.data_port_read32),e.register_write(this.port|16,this,this.data_port_write16,this.data_port_write16,this.data_port_write32),t.devices.pci.register_device(this)}St.prototype.get_state=function(){var t=[];return t[0]=this.isr,t[1]=this.imr,t[2]=this.cr,t[3]=this.dcfg,t[4]=this.rcnt,t[5]=this.tcnt,t[6]=this.tpsr,t[7]=this.rsar,t[8]=this.pstart,t[9]=this.curpg,t[10]=this.boundary,t[11]=this.pstop,t[12]=this.rxcr,t[13]=this.txcr,t[14]=this.tsr,t[15]=this.mac,t[16]=this.memory,t},St.prototype.set_state=function(t){this.isr=t[0],this.imr=t[1],this.cr=t[2],this.dcfg=t[3],this.rcnt=t[4],this.tcnt=t[5],this.tpsr=t[6],this.rsar=t[7],this.pstart=t[8],this.curpg=t[9],this.boundary=t[10],this.pstop=t[11],this.rxcr=t[12],this.txcr=t[13],this.tsr=t[14],this.preserve_mac_from_state_image?(this.mac=t[15],this.memory=t[16]):this.mac_address_translation&&(this.mac_address_in_state=t[15],this.memory=t[16],De(this.mac_address_in_state),De(this.mac))},St.prototype.do_interrupt=function(t){a(t,2),this.isr|=t,this.update_irq()},St.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)},St.prototype.data_port_write=function(t){(16>=this.rsar||16384<=this.rsar&&32768>this.rsar)&&(this.memory[this.rsar]=t),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(64)},St.prototype.data_port_write16=function(t){this.data_port_write(t),this.dcfg&1&&this.data_port_write(t>>8)},St.prototype.data_port_write32=function(t){this.data_port_write(t),this.data_port_write(t>>8),this.data_port_write(t>>16),this.data_port_write(t>>24)},St.prototype.data_port_read=function(){let t=0;return 32768>this.rsar&&(t=this.memory[this.rsar]),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(64),t},St.prototype.data_port_read8=function(){return this.data_port_read16()&255},St.prototype.data_port_read16=function(){return this.dcfg&1?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()},St.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24},St.prototype.receive=function(t){if(!(this.cr&1)&&(this.bus.send("eth-receive-end",[t.length]),this.rxcr&16||this.rxcr&4&&t[0]===255&&t[1]===255&&t[2]===255&&t[3]===255&&t[4]===255&&t[5]===255||!(this.rxcr&8&&(t[0]&1)===1||t[0]!==this.mac[0]||t[1]!==this.mac[1]||t[2]!==this.mac[2]||t[3]!==this.mac[3]||t[4]!==this.mac[4]||t[5]!==this.mac[5]))){this.mac_address_in_state&&(t=new Uint8Array(t),ir(t,this.mac,this.mac_address_in_state));var e=this.curpg<<8,s=Math.max(60,t.length)+4,r=e+4,o=this.curpg+1+(s>>8),l=e+s,_=1+(s>>8),f=this.boundary>this.curpg?this.boundary-this.curpg:this.pstop-this.curpg+this.boundary-this.pstart;f<_&&this.boundary!==0?(a(this.pstart),a(this.pstop),a(this.curpg),a(_),a(this.boundary),a(f)):(l>this.pstop<<8?(l=(this.pstop<<8)-r,this.memory.set(t.subarray(0,l),r),this.memory.set(t.subarray(l),this.pstart<<8),a(l)):(this.memory.set(t,r),60>t.length&&this.memory.fill(0,r+t.length,r+60)),o>=this.pstop&&(o+=this.pstart-this.pstop),this.memory[e]=1,this.memory[e+1]=o,this.memory[e+2]=s,this.memory[e+3]=s>>8,this.curpg=o,a(e),a(s),a(o),this.do_interrupt(1))}},St.prototype.get_page=function(){return this.cr>>6&3};var sr=new Uint8Array(256),rr=[],ni=[],oi=[],nr=new Uint8Array(256),Xi=[];function q(t,e){this.cpu=t,this.bus=e,this.write_buffer=new w(64),this.read_buffer=new w(64),this.mixer_current_address=this.command_size=this.command=this.read_buffer_lastvalue=0,this.mixer_registers=new Uint8Array(256),this.mixer_reset(),this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers=[new k(65536),new k(65536)],this.dma=t.devices.dma,this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_channel_8bit=1,this.dma_channel_16bit=5,this.dma_autoinit=!1,this.dma_buffer=new ArrayBuffer(65536),this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_uint8=new Uint8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new m.SyncBuffer(this.dma_buffer),this.dma_paused=this.dma_waiting_transfer=!1,this.sampling_rate=22050,e.send("dac-tell-sampling-rate",this.sampling_rate),this.bytes_per_sample=1,this.e2_value=170,this.e2_count=0,this.asp_registers=new Uint8Array(256),this.mpu_read_buffer=new w(64),this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0,this.fm_waveform_select_enable=!1,this.irq=5,this.irq_triggered=new Uint8Array(16),t.io.register_read_consecutive(544,this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read),t.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read),t.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read),t.io.register_read(550,this,this.port2x6_read),t.io.register_read(551,this,this.port2x7_read),t.io.register_read(552,this,this.port2x8_read),t.io.register_read(553,this,this.port2x9_read),t.io.register_read(554,this,this.port2xA_read),t.io.register_read(555,this,this.port2xB_read),t.io.register_read(556,this,this.port2xC_read),t.io.register_read(557,this,this.port2xD_read),t.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read),t.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write),t.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write),t.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write),t.io.register_write(550,this,this.port2x6_write),t.io.register_write(551,this,this.port2x7_write),t.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write),t.io.register_write(554,this,this.port2xA_write),t.io.register_write(555,this,this.port2xB_write),t.io.register_write(556,this,this.port2xC_write),t.io.register_write(557,this,this.port2xD_write),t.io.register_write(558,this,this.port2xE_write),t.io.register_write(559,this,this.port2xF_write),t.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read),t.io.register_write_consecutive(816,this,this.port3x0_write,this.port3x1_write),this.dma.on_unmask(this.dma_on_unmask,this),e.register("dac-request-data",function(){this.dac_handle_request()},this),e.register("speaker-has-initialized",function(){this.mixer_reset()},this),e.send("speaker-confirm-initialized"),this.dsp_reset()}q.prototype.dsp_reset=function(){this.write_buffer.clear(),this.read_buffer.clear(),this.command_size=this.command=0,this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers[0].clear(),this.dac_buffers[1].clear(),this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_autoinit=!1,this.dma_buffer_uint8.fill(0),this.dma_paused=this.dma_waiting_transfer=!1,this.e2_value=170,this.e2_count=0,this.sampling_rate=22050,this.bytes_per_sample=1,this.lower_irq(1),this.irq_triggered.fill(0),this.asp_registers.fill(0),this.asp_registers[5]=1,this.asp_registers[9]=248},q.prototype.get_state=function(){var t=[];return t[2]=this.read_buffer_lastvalue,t[3]=this.command,t[4]=this.command_size,t[5]=this.mixer_current_address,t[6]=this.mixer_registers,t[7]=this.dummy_speaker_enabled,t[8]=this.test_register,t[9]=this.dsp_highspeed,t[10]=this.dsp_stereo,t[11]=this.dsp_16bit,t[12]=this.dsp_signed,t[15]=this.dma_sample_count,t[16]=this.dma_bytes_count,t[17]=this.dma_bytes_left,t[18]=this.dma_bytes_block,t[19]=this.dma_irq,t[20]=this.dma_channel,t[21]=this.dma_channel_8bit,t[22]=this.dma_channel_16bit,t[23]=this.dma_autoinit,t[24]=this.dma_buffer_uint8,t[25]=this.dma_waiting_transfer,t[26]=this.dma_paused,t[27]=this.sampling_rate,t[28]=this.bytes_per_sample,t[29]=this.e2_value,t[30]=this.e2_count,t[31]=this.asp_registers,t[33]=this.mpu_read_buffer_last_value,t[34]=this.irq,t[35]=this.irq_triggered,t},q.prototype.set_state=function(t){this.read_buffer_lastvalue=t[2],this.command=t[3],this.command_size=t[4],this.mixer_current_address=t[5],this.mixer_registers=t[6],this.mixer_full_update(),this.dummy_speaker_enabled=t[7],this.test_register=t[8],this.dsp_highspeed=t[9],this.dsp_stereo=t[10],this.dsp_16bit=t[11],this.dsp_signed=t[12],this.dma_sample_count=t[15],this.dma_bytes_count=t[16],this.dma_bytes_left=t[17],this.dma_bytes_block=t[18],this.dma_irq=t[19],this.dma_channel=t[20],this.dma_channel_8bit=t[21],this.dma_channel_16bit=t[22],this.dma_autoinit=t[23],this.dma_buffer_uint8=t[24],this.dma_waiting_transfer=t[25],this.dma_paused=t[26],this.sampling_rate=t[27],this.bytes_per_sample=t[28],this.e2_value=t[29],this.e2_count=t[30],this.asp_registers=t[31],this.mpu_read_buffer_last_value=t[33],this.irq=t[34],this.irq_triggered=t[35],this.dma_buffer=this.dma_buffer_uint8.buffer,this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new m.SyncBuffer(this.dma_buffer),this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")},q.prototype.port2x0_read=function(){return 255},q.prototype.port2x1_read=function(){return 255},q.prototype.port2x2_read=function(){return 255},q.prototype.port2x3_read=function(){return 255},q.prototype.port2x4_read=function(){return this.mixer_current_address},q.prototype.port2x5_read=function(){return this.mixer_read(this.mixer_current_address)},q.prototype.port2x6_read=function(){return 255},q.prototype.port2x7_read=function(){return 255},q.prototype.port2x8_read=function(){return 255},q.prototype.port2x9_read=function(){return 255},q.prototype.port2xA_read=function(){return this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift()),a(this.read_buffer_lastvalue),String.fromCharCode(this.read_buffer_lastvalue),this.read_buffer_lastvalue},q.prototype.port2xB_read=function(){return 255},q.prototype.port2xC_read=function(){return 127},q.prototype.port2xD_read=function(){return 255},q.prototype.port2xE_read=function(){return this.irq_triggered[1]&&this.lower_irq(1),(this.read_buffer.length&&!this.dsp_highspeed)<<7|127},q.prototype.port2xF_read=function(){return this.lower_irq(2),0},q.prototype.port2x0_write=function(t){a(t),this.fm_current_address0=0},q.prototype.port2x1_write=function(t){a(t);var e=Xi[this.fm_current_address0];e||(e=this.fm_default_write),e.call(this,t,0,this.fm_current_address0)},q.prototype.port2x2_write=function(t){a(t),this.fm_current_address1=0},q.prototype.port2x3_write=function(t){a(t);var e=Xi[this.fm_current_address1];e||(e=this.fm_default_write),e.call(this,t,1,this.fm_current_address1)},q.prototype.port2x4_write=function(t){a(t),this.mixer_current_address=t},q.prototype.port2x5_write=function(t){a(t),this.mixer_write(this.mixer_current_address,t)},q.prototype.port2x6_write=function(t){a(t),this.dsp_highspeed?this.dsp_highspeed=!1:t&&this.dsp_reset(),this.read_buffer.clear(),this.read_buffer.push(170)},q.prototype.port2x7_write=function(){},q.prototype.port2x8_write=function(){},q.prototype.port2x9_write=function(){},q.prototype.port2xA_write=function(){},q.prototype.port2xB_write=function(){},q.prototype.port2xC_write=function(t){this.command===0?(a(t),this.command=t,this.write_buffer.clear(),this.command_size=sr[t]):(a(t),this.write_buffer.push(t)),this.write_buffer.length>=this.command_size&&this.command_do()},q.prototype.port2xD_write=function(){},q.prototype.port2xE_write=function(){},q.prototype.port2xF_write=function(){},q.prototype.port3x0_read=function(){return this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift()),a(this.mpu_read_buffer_lastvalue),this.mpu_read_buffer_lastvalue},q.prototype.port3x0_write=function(t){a(t)},q.prototype.port3x1_read=function(){return 0|128*!this.mpu_read_buffer.length},q.prototype.port3x1_write=function(t){a(t),t===255&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))},q.prototype.command_do=function(){var t=rr[this.command];t||(t=this.dsp_default_handler),t.call(this),this.command_size=this.command=0,this.write_buffer.clear()},q.prototype.dsp_default_handler=function(){a(this.command)};function j(t,e,s){s||(s=q.prototype.dsp_default_handler);for(var r=0;r<t.length;r++)sr[t[r]]=e,rr[t[r]]=s}function or(t){for(var e=[],s=0;16>s;s++)e.push(t+s);return e}j([14],2,function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()}),j([15],1,function(){this.read_buffer.clear(),this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])}),j([16],1,function(){var t=this.write_buffer.shift();t=hr(t/127.5+-1,-1,1),this.dac_buffers[0].push(t),this.dac_buffers[1].push(t),this.bus.send("dac-enable")}),j([20,21],2,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}),j([22],2),j([23],2),j([28],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1,this.dma_transfer_start()}),j([31],0),j([32],0,function(){this.read_buffer.clear(),this.read_buffer.push(127)}),j([36],2),j([44],0),j([48],0),j([49],0),j([52],0),j([53],0),j([54],0),j([55],0),j([56],0),j([64],1,function(){this.sampling_rate_change(1e6/(256-this.write_buffer.shift())/this.get_channel_count())}),j([65,66],2,function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())}),j([72],2,function(){this.dma_transfer_size_set()}),j([116],2),j([117],2),j([118],2),j([119],2),j([125],0),j([127],0),j([128],2),j([144],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_signed=!1,this.dsp_highspeed=!0,this.dsp_16bit=!1,this.dma_transfer_start()}),j([145],0),j([152],0),j([153],0),j([160],0),j([168],0),j(or(176),3,function(){if(this.command&8)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=2,this.dma_channel=this.dma_channel_16bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(t&16),this.dsp_stereo=!!(t&32),this.dsp_16bit=!0,this.dma_transfer_size_set(),this.dma_transfer_start()}}),j(or(192),3,function(){if(this.command&8)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(t&16),this.dsp_stereo=!!(t&32),this.dsp_16bit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}}),j([208],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),j([209],0,function(){this.dummy_speaker_enabled=!0}),j([211],0,function(){this.dummy_speaker_enabled=!1}),j([212],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),j([213],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),j([214],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),j([216],0,function(){this.read_buffer.clear(),this.read_buffer.push(255*this.dummy_speaker_enabled)}),j([217,218],0,function(){this.dma_autoinit=!1}),j([224],1,function(){this.read_buffer.clear(),this.read_buffer.push(~this.write_buffer.shift())}),j([225],0,function(){this.read_buffer.clear(),this.read_buffer.push(4),this.read_buffer.push(5)}),j([226],1),j([227],0,function(){this.read_buffer.clear();for(var t=0;44>t;t++)this.read_buffer.push("COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.".charCodeAt(t));this.read_buffer.push(0)}),j([228],1,function(){this.test_register=this.write_buffer.shift()}),j([232],0,function(){this.read_buffer.clear(),this.read_buffer.push(this.test_register)}),j([242,243],0,function(){this.raise_irq()});var hi=new Uint8Array(256);hi[14]=255,hi[15]=7,hi[55]=56,j([249],1,function(){var t=this.write_buffer.shift();this.read_buffer.clear(),this.read_buffer.push(hi[t])}),q.prototype.mixer_read=function(t){var e=ni[t];return e?e=e.call(this):(e=this.mixer_registers[t],a(t),a(e)),e},q.prototype.mixer_write=function(t,e){var s=oi[t];s?s.call(this,e):(a(t),a(e))},q.prototype.mixer_default_read=function(){return a(this.mixer_current_address),this.mixer_registers[this.mixer_current_address]},q.prototype.mixer_default_write=function(t){a(this.mixer_current_address),a(t),this.mixer_registers[this.mixer_current_address]=t},q.prototype.mixer_reset=function(){this.mixer_registers[4]=204,this.mixer_registers[34]=204,this.mixer_registers[38]=204,this.mixer_registers[40]=0,this.mixer_registers[46]=0,this.mixer_registers[10]=0,this.mixer_registers[48]=192,this.mixer_registers[49]=192,this.mixer_registers[50]=192,this.mixer_registers[51]=192,this.mixer_registers[52]=192,this.mixer_registers[53]=192,this.mixer_registers[54]=0,this.mixer_registers[55]=0,this.mixer_registers[56]=0,this.mixer_registers[57]=0,this.mixer_registers[59]=0,this.mixer_registers[60]=31,this.mixer_registers[61]=21,this.mixer_registers[62]=11,this.mixer_registers[63]=0,this.mixer_registers[64]=0,this.mixer_registers[65]=0,this.mixer_registers[66]=0,this.mixer_registers[67]=0,this.mixer_registers[68]=128,this.mixer_registers[69]=128,this.mixer_registers[70]=128,this.mixer_registers[71]=128,this.mixer_full_update()},q.prototype.mixer_full_update=function(){for(var t=1;t<this.mixer_registers.length;t++)nr[t]||this.mixer_write(t,this.mixer_registers[t])};function Lt(t,e){e||(e=q.prototype.mixer_default_read),ni[t]=e}function $t(t,e){e||(e=q.prototype.mixer_default_write),oi[t]=e}function Oe(t,e,s){nr[t]=1,ni[t]=function(){return this.mixer_registers[e]&240|this.mixer_registers[s]>>>4},oi[t]=function(r){this.mixer_registers[t]=r;var o=r<<4&240|this.mixer_registers[s]&15;this.mixer_write(e,r&240|this.mixer_registers[e]&15),this.mixer_write(s,o)}}function ai(t,e,s){ni[t]=q.prototype.mixer_default_read,oi[t]=function(r){this.mixer_registers[t]=r,this.bus.send("mixer-volume",[e,s,(r>>>2)-62])}}Lt(0,function(){return this.mixer_reset(),0}),$t(0),Oe(4,50,51),Oe(34,48,49),Oe(38,52,53),Oe(40,54,55),Oe(46,56,57),ai(48,0,0),ai(49,0,1),ai(50,2,0),ai(51,2,1),Lt(59),$t(59,function(t){this.mixer_registers[59]=t,this.bus.send("mixer-volume",[1,2,6*(t>>>6)-18])}),Lt(65),$t(65,function(t){this.mixer_registers[65]=t,this.bus.send("mixer-gain-left",6*(t>>>6))}),Lt(66),$t(66,function(t){this.mixer_registers[66]=t,this.bus.send("mixer-gain-right",6*(t>>>6))}),Lt(68),$t(68,function(t){this.mixer_registers[68]=t,t>>>=3,this.bus.send("mixer-treble-left",t-(16>t?14:16))}),Lt(69),$t(69,function(t){this.mixer_registers[69]=t,t>>>=3,this.bus.send("mixer-treble-right",t-(16>t?14:16))}),Lt(70),$t(70,function(t){this.mixer_registers[70]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))}),Lt(71),$t(71,function(t){this.mixer_registers[71]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))}),Lt(128,function(){switch(this.irq){case 2:return 1;case 5:return 2;case 7:return 4;case 10:return 8;default:return 0}}),$t(128,function(t){t&1&&(this.irq=2),t&2&&(this.irq=5),t&4&&(this.irq=7),t&8&&(this.irq=10)}),Lt(129,function(){var t=0;switch(this.dma_channel_8bit){case 0:t|=1;break;case 1:t|=2;break;case 3:t|=8}switch(this.dma_channel_16bit){case 5:t|=32;break;case 6:t|=64;break;case 7:t|=128}return t}),$t(129,function(t){t&1&&(this.dma_channel_8bit=0),t&2&&(this.dma_channel_8bit=1),t&8&&(this.dma_channel_8bit=3),t&32&&(this.dma_channel_16bit=5),t&64&&(this.dma_channel_16bit=6),t&128&&(this.dma_channel_16bit=7)}),Lt(130,function(){for(var t=32,e=0;16>e;e++)t|=e*this.irq_triggered[e];return t}),q.prototype.fm_default_write=function(t,e,s){a(s),a(t)};function wt(t,e){e||(e=q.prototype.fm_default_write);for(var s=0;s<t.length;s++)Xi[t[s]]=e}function ie(t,e){for(var s=[];t<=e;t++)s.push(t);return s}var ht=new Uint8Array(32);ht[0]=0,ht[1]=1,ht[2]=2,ht[3]=3,ht[4]=4,ht[5]=5,ht[8]=6,ht[9]=7,ht[10]=8,ht[11]=9,ht[12]=10,ht[13]=11,ht[16]=12,ht[17]=13,ht[18]=14,ht[19]=15,ht[20]=16,ht[21]=17,wt([1],function(t,e){this.fm_waveform_select_enable[e]=t&1,this.fm_update_waveforms()}),wt([2]),wt([3]),wt([4],function(){}),wt([5],function(t,e,s){e===0&&this.fm_default_write(t,e,s)}),wt([8],function(){}),wt(ie(32,53),function(){}),wt(ie(64,85),function(){}),wt(ie(96,117),function(){}),wt(ie(128,149),function(){}),wt(ie(160,168),function(){}),wt(ie(176,184),function(){}),wt([189],function(){}),wt(ie(192,200),function(){}),wt(ie(224,245),function(){}),q.prototype.fm_update_waveforms=function(){},q.prototype.sampling_rate_change=function(t){this.sampling_rate=t,this.bus.send("dac-tell-sampling-rate",t)},q.prototype.get_channel_count=function(){return this.dsp_stereo?2:1},q.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)},q.prototype.dma_transfer_start=function(){this.bytes_per_sample=1,this.dsp_16bit&&(this.bytes_per_sample*=2),this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample,this.dma_bytes_block=1024*this.bytes_per_sample,this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block),this.dma_waiting_transfer=!0,this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)},q.prototype.dma_on_unmask=function(t){t===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))},q.prototype.dma_transfer_next=function(){var t=Math.min(this.dma_bytes_left,this.dma_bytes_block),e=Math.floor(t/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,t,this.dma_channel,s=>{s||(this.dma_to_dac(e),this.dma_bytes_left-=t,this.dma_bytes_left||(this.raise_irq(this.dma_irq),this.dma_autoinit&&(this.dma_bytes_left=this.dma_bytes_count)))})},q.prototype.dma_to_dac=function(t){for(var e=this.dsp_16bit?32767.5:127.5,s=this.dsp_signed?0:-1,r=this.dsp_stereo?1:2,o=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8,l=0,_=0;_<t;_++)for(var f=hr(o[_]/e+s,-1,1),g=0;g<r;g++)this.dac_buffers[l].push(f),l^=1;this.dac_send()},q.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()},q.prototype.dac_send=function(){if(this.dac_buffers[0].length){var t=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),e=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[t,e],[t.buffer,e.buffer])}},q.prototype.raise_irq=function(t){this.irq_triggered[t]=1,this.cpu.device_raise_irq(this.irq)},q.prototype.lower_irq=function(t){this.irq_triggered[t]=0,this.cpu.device_lower_irq(this.irq)};function hr(t,e,s){return(t<e)*e+(t>s)*s+(e<=t&&t<=s)*t}function ft(t,e){this.cpu=t,this.pci=t.devices.pci,this.device_id=e.device_id,this.pci_space=[244,26,e.device_id&255,e.device_id>>8,7,5,16,0,1,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,e.subsystem_device_id&255,e.subsystem_device_id>>8,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0],this.pci_space=this.pci_space.concat(m.zeros(256-this.pci_space.length)),this.pci_id=e.pci_id,this.pci_bars=[],this.name=e.name,this.driver_feature_select=this.device_feature_select=0,this.device_feature=new Uint32Array(4),this.driver_feature=new Uint32Array(4);for(var s of e.common.features)this.device_feature[s>>>5]|=1<<(s&31),this.driver_feature[s>>>5]|=1<<(s&31);e.common.features.includes(32),this.features_ok=!0,this.device_status=0,this.config_has_changed=!1,this.config_generation=0,this.queues=[];for(let r of e.common.queues)this.queues.push(new J(t,this,r));this.queue_select=0,this.queue_selected=this.queues[0],this.isr_status=0,s=[],s.push(this.create_common_capability(e.common)),s.push(this.create_notification_capability(e.notification)),s.push(this.create_isr_capability(e.isr_status)),e.device_specific&&s.push(this.create_device_specific_capability(e.device_specific)),this.init_capabilities(s),t.devices.pci.register_device(this),this.reset()}ft.prototype.create_common_capability=function(t){return{type:1,bar:0,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:4,name:"device_feature_select",read:()=>this.device_feature_select,write:e=>{this.device_feature_select=e}},{bytes:4,name:"device_feature",read:()=>this.device_feature[this.device_feature_select]||0,write:()=>{}},{bytes:4,name:"driver_feature_select",read:()=>this.driver_feature_select,write:e=>{this.driver_feature_select=e}},{bytes:4,name:"driver_feature",read:()=>this.driver_feature[this.driver_feature_select]||0,write:e=>{let s=this.device_feature[this.driver_feature_select];this.driver_feature_select<this.driver_feature.length&&(this.driver_feature[this.driver_feature_select]=e&s),this.features_ok=this.features_ok&&!(e&~s)}},{bytes:2,name:"msix_config",read:()=>65535,write:()=>{}},{bytes:2,name:"num_queues",read:()=>this.queues.length,write:()=>{}},{bytes:1,name:"device_status",read:()=>this.device_status,write:e=>{e===0&&this.reset(),e&~this.device_status&4&&this.device_status&64&&this.notify_config_changes(),this.features_ok||(e&=-9),this.device_status=e,e&~this.device_status&4&&t.on_driver_ok()}},{bytes:1,name:"config_generation",read:()=>this.config_generation,write:()=>{}},{bytes:2,name:"queue_select",read:()=>this.queue_select,write:e=>{this.queue_select=e,this.queue_selected=this.queue_select<this.queues.length?this.queues[this.queue_select]:null}},{bytes:2,name:"queue_size",read:()=>this.queue_selected?this.queue_selected.size:0,write:e=>{this.queue_selected&&(e&e-1&&(e=1<<m.int_log2(e-1)+1),e>this.queue_selected.size_supported&&(e=this.queue_selected.size_supported),this.queue_selected.set_size(e))}},{bytes:2,name:"queue_msix_vector",read:()=>65535,write:()=>{}},{bytes:2,name:"queue_enable",read:()=>this.queue_selected?this.queue_selected.enabled|0:0,write:e=>{this.queue_selected&&e===1&&this.queue_selected.is_configured()&&this.queue_selected.enable()}},{bytes:2,name:"queue_notify_off",read:()=>this.queue_selected?this.queue_selected.notify_offset:0,write:()=>{}},{bytes:4,name:"queue_desc (low dword)",read:()=>this.queue_selected?this.queue_selected.desc_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.desc_addr=e)}},{bytes:4,name:"queue_desc (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_avail (low dword)",read:()=>this.queue_selected?this.queue_selected.avail_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.avail_addr=e)}},{bytes:4,name:"queue_avail (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_used (low dword)",read:()=>this.queue_selected?this.queue_selected.used_addr:0,write:e=>{this.queue_selected&&(this.queue_selected.used_addr=e)}},{bytes:4,name:"queue_used (high dword)",read:()=>0,write:()=>{}}]}},ft.prototype.create_notification_capability=function(t){let e=[],s;s=t.single_handler?0:2;for(let[r,o]of t.handlers.entries())e.push({bytes:2,name:"notify"+r,read:()=>65535,write:o||(()=>{})});return{type:2,bar:1,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array([s&255,s>>8&255,s>>16&255,s>>24]),struct:e}},ft.prototype.create_isr_capability=function(t){return{type:3,bar:2,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:1,name:"isr_status",read:()=>{let e=this.isr_status;return this.lower_irq(),e},write:()=>{}}]}},ft.prototype.create_device_specific_capability=function(t){return{type:4,bar:3,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:t.struct}},ft.prototype.init_capabilities=function(t){let e=this.pci_space[52]=64;var s=e;for(let o of t){t=16+o.extra.length,s=e,e=s+t;var r=o.struct.reduce((l,_)=>l+_.bytes,0);r+=o.offset,r=16>r?16:1<<m.int_log2(r-1)+1,this.pci_bars[o.bar]={size:r},this.pci_space[s]=9,this.pci_space[s+1]=e,this.pci_space[s+2]=t,this.pci_space[s+3]=o.type,this.pci_space[s+4]=o.bar,this.pci_space[s+5]=0,this.pci_space[s+6]=0,this.pci_space[s+7]=0,this.pci_space[s+8]=o.offset&255,this.pci_space[s+9]=o.offset>>>8&255,this.pci_space[s+10]=o.offset>>>16&255,this.pci_space[s+11]=o.offset>>>24,this.pci_space[s+12]=r&255,this.pci_space[s+13]=r>>>8&255,this.pci_space[s+14]=r>>>16&255,this.pci_space[s+15]=r>>>24;for(let[l,_]of o.extra.entries())this.pci_space[s+16+l]=_;s=16+4*o.bar,this.pci_space[s]=o.port&254|!o.use_mmio,this.pci_space[s+1]=o.port>>>8&255,this.pci_space[s+2]=o.port>>>16&255,this.pci_space[s+3]=o.port>>>24&255,s=o.port+o.offset;for(let l of o.struct){let _=l.read;if(t=l.write,!o.use_mmio){r=function(g){return _(g&-2)>>((g&1)<<3)&255};let f=function(g){return _(g&-4)>>((g&3)<<3)&255};switch(l.bytes){case 4:this.cpu.io.register_read(s,this,f,void 0,_),this.cpu.io.register_write(s,this,void 0,void 0,t);break;case 2:this.cpu.io.register_read(s,this,r,_),this.cpu.io.register_write(s,this,void 0,t);break;case 1:this.cpu.io.register_read(s,this,_),this.cpu.io.register_write(s,this,t)}}s+=l.bytes}}this.pci_space[e]=9,this.pci_space[e+1]=0,this.pci_space[e+2]=20,this.pci_space[e+3]=5,this.pci_space[e+4]=0,this.pci_space[e+5]=0,this.pci_space[e+6]=0,this.pci_space[e+7]=0,this.pci_space[e+8]=0,this.pci_space[e+9]=0,this.pci_space[e+10]=0,this.pci_space[e+11]=0,this.pci_space[e+12]=0,this.pci_space[e+13]=0,this.pci_space[e+14]=0,this.pci_space[e+15]=0,this.pci_space[e+16]=0,this.pci_space[e+17]=0,this.pci_space[e+18]=0,this.pci_space[e+19]=0},ft.prototype.get_state=function(){let t=[];return t[0]=this.device_feature_select,t[1]=this.driver_feature_select,t[2]=this.device_feature,t[3]=this.driver_feature,t[4]=this.features_ok,t[5]=this.device_status,t[6]=this.config_has_changed,t[7]=this.config_generation,t[8]=this.isr_status,t[9]=this.queue_select,t=t.concat(this.queues)},ft.prototype.set_state=function(t){this.device_feature_select=t[0],this.driver_feature_select=t[1],this.device_feature=t[2],this.driver_feature=t[3],this.features_ok=t[4],this.device_status=t[5],this.config_has_changed=t[6],this.config_generation=t[7],this.isr_status=t[8],this.queue_select=t[9];let e=0;for(let s of t.slice(10))this.queues[e].set_state(s),e++;this.queue_selected=this.queues[this.queue_select]||null},ft.prototype.reset=function(){this.driver_feature_select=this.device_feature_select=0,this.driver_feature.set(this.device_feature),this.features_ok=!0,this.queue_select=this.device_status=0,this.queue_selected=this.queues[0];for(let t of this.queues)t.reset();this.config_has_changed=!1,this.config_generation=0,this.lower_irq()},ft.prototype.notify_config_changes=function(){this.config_has_changed=!0,this.device_status&4&&this.raise_irq(2)},ft.prototype.update_config_generation=function(){this.config_has_changed&&(this.config_generation++,this.config_generation&=255,this.config_has_changed=!1)},ft.prototype.is_feature_negotiated=function(t){return 0<(this.driver_feature[t>>>5]&1<<(t&31))},ft.prototype.needs_reset=function(){this.device_status|=64,this.device_status&4&&this.notify_config_changes()},ft.prototype.raise_irq=function(t){a(t),this.isr_status|=t,this.pci.raise_irq(this.pci_id)},ft.prototype.lower_irq=function(){this.isr_status=0,this.pci.lower_irq(this.pci_id)};function J(t,e,s){this.cpu=t,this.virtio=e,this.size_supported=this.size=s.size_supported,this.mask=this.size-1,this.enabled=!1,this.notify_offset=s.notify_offset,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.reset()}J.prototype.get_state=function(){let t=[];return t[0]=this.size,t[1]=this.size_supported,t[2]=this.enabled,t[3]=this.notify_offset,t[4]=this.desc_addr,t[5]=this.avail_addr,t[6]=this.avail_last_idx,t[7]=this.used_addr,t[8]=this.num_staged_replies,t},J.prototype.set_state=function(t){this.size=t[0],this.size_supported=t[1],this.enabled=t[2],this.notify_offset=t[3],this.desc_addr=t[4],this.avail_addr=t[5],this.avail_last_idx=t[6],this.used_addr=t[7],this.num_staged_replies=t[8],this.mask=this.size-1},J.prototype.reset=function(){this.enabled=!1,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.set_size(this.size_supported)},J.prototype.is_configured=function(){return this.desc_addr&&this.avail_addr&&this.used_addr},J.prototype.enable=function(){this.is_configured(),this.enabled=!0},J.prototype.set_size=function(t){this.size=t,this.mask=t-1},J.prototype.count_requests=function(){return this.avail_get_idx()-this.avail_last_idx&this.mask},J.prototype.has_request=function(){return(this.avail_get_idx()&this.mask)!==this.avail_last_idx},J.prototype.pop_request=function(){this.has_request();var t=this.avail_get_entry(this.avail_last_idx);return t=new Qi(this,t),this.avail_last_idx=this.avail_last_idx+1&this.mask,t},J.prototype.push_reply=function(t){let e=this.used_get_idx()+this.num_staged_replies&this.mask;this.used_set_entry(e,t.head_idx,t.length_written),this.num_staged_replies++},J.prototype.flush_replies=function(){if(this.num_staged_replies!==0){var t=this.used_get_idx()+this.num_staged_replies&65535;this.used_set_idx(t),this.num_staged_replies=0,this.virtio.is_feature_negotiated(29)?(this.avail_get_used_event(),this.virtio.raise_irq(1)):~this.avail_get_flags()&1&&this.virtio.raise_irq(1)}},J.prototype.notify_me_after=function(t){t=this.avail_get_idx()+t&65535,this.used_set_avail_event(t)},J.prototype.get_descriptor=function(t,e){return{addr_low:this.cpu.read32s(t+16*e),addr_high:this.cpu.read32s(t+16*e+4),len:this.cpu.read32s(t+16*e+8),flags:this.cpu.read16(t+16*e+12),next:this.cpu.read16(t+16*e+14)}},J.prototype.avail_get_flags=function(){return this.cpu.read16(this.avail_addr)},J.prototype.avail_get_idx=function(){return this.cpu.read16(this.avail_addr+2)},J.prototype.avail_get_entry=function(t){return this.cpu.read16(this.avail_addr+4+2*t)},J.prototype.avail_get_used_event=function(){return this.cpu.read16(this.avail_addr+4+2*this.size)},J.prototype.used_get_flags=function(){return this.cpu.read16(this.used_addr)},J.prototype.used_set_flags=function(t){this.cpu.write16(this.used_addr,t)},J.prototype.used_get_idx=function(){return this.cpu.read16(this.used_addr+2)},J.prototype.used_set_idx=function(t){this.cpu.write16(this.used_addr+2,t)},J.prototype.used_set_entry=function(t,e,s){this.cpu.write32(this.used_addr+4+8*t,e),this.cpu.write32(this.used_addr+8+8*t,s)},J.prototype.used_set_avail_event=function(t){this.cpu.write16(this.used_addr+4+8*this.size,t)};function Qi(t,e){this.cpu=t.cpu,this.virtio=t.virtio,this.head_idx=e,this.read_buffers=[],this.length_readable=this.read_buffer_offset=this.read_buffer_idx=0,this.write_buffers=[],this.length_writable=this.length_written=this.write_buffer_offset=this.write_buffer_idx=0;let s=t.desc_addr,r=0,o=t.size,l=!1,_=this.virtio.is_feature_negotiated(28);do{let f=t.get_descriptor(s,e);if(a(f.addr_high,8),a(f.addr_low,8),a(f.len,8),a(f.flags,4),a(f.next,4),_&&f.flags&4)s=f.addr_low,r=e=0,o=f.len/16;else{if(f.flags&2)l=!0,this.write_buffers.push(f),this.length_writable+=f.len;else{if(l)break;this.read_buffers.push(f),this.length_readable+=f.len}if(r++,r>o)break;if(f.flags&1)e=f.next;else break}}while(!0)}Qi.prototype.get_next_blob=function(t){let e=0,s=t.length;for(;s&&this.read_buffer_idx!==this.read_buffers.length;){var r=this.read_buffers[this.read_buffer_idx];let o=r.addr_low+this.read_buffer_offset;r=r.len-this.read_buffer_offset,r>s?(r=s,this.read_buffer_offset+=s):(this.read_buffer_idx++,this.read_buffer_offset=0),t.set(this.cpu.read_blob(o,r),e),e+=r,s-=r}return e},Qi.prototype.set_next_blob=function(t){let e=0,s=t.length;for(;s&&this.write_buffer_idx!==this.write_buffers.length;){var r=this.write_buffers[this.write_buffer_idx];let o=r.addr_low+this.write_buffer_offset;r=r.len-this.write_buffer_offset,r>s?(r=s,this.write_buffer_offset+=s):(this.write_buffer_idx++,this.write_buffer_offset=0),this.cpu.write_blob(t.subarray(e,e+r),o),e+=r,s-=r}return this.length_written+=e,e};function Xt(t,e){this.bus=e,this.rows=25,this.cols=80,this.ports=4,e=[{size_supported:16,notify_offset:0},{size_supported:16,notify_offset:1},{size_supported:16,notify_offset:2},{size_supported:16,notify_offset:3}];for(let s=1;s<this.ports;++s)e.push({size_supported:16,notify_offset:0}),e.push({size_supported:8,notify_offset:1});this.virtio=new ft(t,{name:"virtio-console",pci_id:56,device_id:4163,subsystem_device_id:3,common:{initial_port:47104,queues:e,features:[0,1,32],on_driver_ok:()=>{}},notification:{initial_port:47360,single_handler:!1,handlers:[s=>{for(s=this.virtio.queues[s];s.count_requests()>s.size-2;)s.pop_request()},s=>{let r=this.virtio.queues[s],o=3<s?s-3>>1:0;for(;r.has_request();){let l=r.pop_request(),_=new Uint8Array(l.length_readable);l.get_next_blob(_),this.bus.send("virtio-console"+o+"-output-bytes",_),this.Ack(s,l)}},s=>{if(s===2)for(s=this.virtio.queues[s];s.count_requests()>s.size-2;)s.pop_request()},s=>{if(s===3)for(var r=this.virtio.queues[s];r.has_request();){var o=r.pop_request(),l=new Uint8Array(o.length_readable);o.get_next_blob(l);var _=W.Unmarshall(["w","h","h"],l,{offset:0});switch(l=_[0],_=_[1],this.Ack(s,o),_){case 0:for(o=0;o<this.ports;++o)this.SendEvent(o,1,0);break;case 3:this.Ack(s,o),this.SendEvent(l,4,1),this.SendName(l,"virtio-"+l),this.SendEvent(l,6,1);break;case 6:this.Ack(s,o),l===0&&this.SendWindowSize(l);break;default:return}}}]},isr_status:{initial_port:46848},device_specific:{initial_port:46592,struct:[{bytes:2,name:"cols",read:()=>this.cols,write:()=>{}},{bytes:2,name:"rows",read:()=>this.rows,write:()=>{}},{bytes:4,name:"max_nr_ports",read:()=>this.ports,write:()=>{}},{bytes:4,name:"emerg_wr",read:()=>0,write:()=>{}}]}});for(let s=0;s<this.ports;++s){let r=s===0?0:2*s+2;this.bus.register("virtio-console"+s+"-input-bytes",function(o){var l=this.virtio.queues[r];l.has_request()&&(l=l.pop_request(),this.Send(r,l,new Uint8Array(o)))},this),this.bus.register("virtio-console"+s+"-resize",function(o){this.cols=o[0],this.rows=o[1],this.virtio.queues[2].is_configured()&&this.virtio.queues[2].has_request()&&this.SendWindowSize(s)},this)}}Xt.prototype.SendWindowSize=function(t){let e=this.virtio.queues[2].pop_request(),s=new Uint8Array(12);W.Marshall(["w","h","h","h","h"],[t,5,0,this.rows,this.cols],s,0),this.Send(2,e,s)},Xt.prototype.SendName=function(t,e){let s=this.virtio.queues[2].pop_request();e=new TextEncoder().encode(e);let r=new Uint8Array(8+e.length+1);for(W.Marshall(["w","h","h"],[t,7,1],r,0),t=0;t<e.length;++t)r[t+8]=e[t];r[8+e.length]=0,this.Send(2,s,r)},Xt.prototype.get_state=function(){let t=[];return t[0]=this.virtio,t[1]=this.rows,t[2]=this.cols,t[3]=this.ports,t},Xt.prototype.set_state=function(t){this.virtio.set_state(t[0]),this.rows=t[1],this.cols=t[2],this.ports=t[3]},Xt.prototype.reset=function(){this.virtio.reset()},Xt.prototype.SendEvent=function(t,e,s){let r=this.virtio.queues[2].pop_request(),o=new Uint8Array(8);W.Marshall(["w","h","h"],[t,e,s],o,0),this.Send(2,r,o)},Xt.prototype.Send=function(t,e,s){e.set_next_blob(s),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()},Xt.prototype.Ack=function(t,e){e.set_next_blob(new Uint8Array(0)),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()};var ar={};function pe(){this.listeners={},this.pair=void 0}pe.prototype.register=function(t,e,s){var r=this.listeners[t];r===void 0&&(r=this.listeners[t]=[]),r.push({fn:e,this_value:s})},pe.prototype.unregister=function(t,e){var s=this.listeners[t];s!==void 0&&(this.listeners[t]=s.filter(function(r){return r.fn!==e}))},pe.prototype.send=function(t,e){if(this.pair&&(t=this.pair.listeners[t],t!==void 0))for(var s=0;s<t.length;s++){var r=t[s];r.fn.call(r.this_value,e)}},pe.prototype.send_async=function(t,e){setTimeout(this.send.bind(this,t,e),0)},ar.create=function(){var t=new pe,e=new pe;return t.pair=e,e.pair=t,[t,e]};function Uc(){}function qc(){}function $(t,e,s){this.stop_idling=s,this.wm=e,this.wasm_patch(),this.create_jit_imports(),this.wasm_memory=e=this.wm.exports.memory,this.memory_size=m.view(Uint32Array,e,812,1),this.mem8=new Uint8Array(0),this.mem32s=new Int32Array(this.mem8.buffer),this.segment_is_null=m.view(Uint8Array,e,724,8),this.segment_offsets=m.view(Int32Array,e,736,8),this.segment_limits=m.view(Uint32Array,e,768,8),this.segment_access_bytes=m.view(Uint8Array,e,512,8),this.protected_mode=m.view(Int32Array,e,800,1),this.idtr_size=m.view(Int32Array,e,564,1),this.idtr_offset=m.view(Int32Array,e,568,1),this.gdtr_size=m.view(Int32Array,e,572,1),this.gdtr_offset=m.view(Int32Array,e,576,1),this.tss_size_32=m.view(Int32Array,e,1128,1),this.page_fault=m.view(Uint32Array,e,540,8),this.cr=m.view(Int32Array,e,580,8),this.cpl=m.view(Uint8Array,e,612,1),this.is_32=m.view(Int32Array,e,804,1),this.stack_size_32=m.view(Int32Array,e,808,1),this.in_hlt=m.view(Uint8Array,e,616,1),this.last_virt_eip=m.view(Int32Array,e,620,1),this.eip_phys=m.view(Int32Array,e,624,1),this.sysenter_cs=m.view(Int32Array,e,636,1),this.sysenter_esp=m.view(Int32Array,e,640,1),this.sysenter_eip=m.view(Int32Array,e,644,1),this.prefixes=m.view(Int32Array,e,648,1),this.flags=m.view(Int32Array,e,120,1),this.flags_changed=m.view(Int32Array,e,100,1),this.last_op_size=m.view(Int32Array,e,96,1),this.last_op1=m.view(Int32Array,e,104,1),this.last_result=m.view(Int32Array,e,112,1),this.current_tsc=m.view(Uint32Array,e,960,2),this.devices={},this.instruction_pointer=m.view(Int32Array,e,556,1),this.previous_ip=m.view(Int32Array,e,560,1),this.apic_enabled=m.view(Uint8Array,e,548,1),this.acpi_enabled=m.view(Uint8Array,e,552,1),this.memory_map_read8=[],this.memory_map_write8=[],this.memory_map_read32=[],this.memory_map_write32=[],this.bios={main:null,vga:null},this.instruction_counter=m.view(Uint32Array,e,664,1),this.reg32=m.view(Int32Array,e,64,8),this.fpu_st=m.view(Int32Array,e,1152,32),this.fpu_stack_empty=m.view(Uint8Array,e,816,1),this.fpu_stack_empty[0]=255,this.fpu_stack_ptr=m.view(Uint8Array,e,1032,1),this.fpu_stack_ptr[0]=0,this.fpu_control_word=m.view(Uint16Array,e,1036,1),this.fpu_control_word[0]=895,this.fpu_status_word=m.view(Uint16Array,e,1040,1),this.fpu_status_word[0]=0,this.fpu_ip=m.view(Int32Array,e,1048,1),this.fpu_ip[0]=0,this.fpu_ip_selector=m.view(Int32Array,e,1052,1),this.fpu_ip_selector[0]=0,this.fpu_opcode=m.view(Int32Array,e,1044,1),this.fpu_opcode[0]=0,this.fpu_dp=m.view(Int32Array,e,1056,1),this.fpu_dp[0]=0,this.fpu_dp_selector=m.view(Int32Array,e,1060,1),this.fpu_dp_selector[0]=0,this.reg_xmm32s=m.view(Int32Array,e,832,32),this.mxcsr=m.view(Int32Array,e,824,1),this.sreg=m.view(Uint16Array,e,668,8),this.dreg=m.view(Int32Array,e,684,8),this.reg_pdpte=m.view(Int32Array,e,968,8),this.svga_dirty_bitmap_min_offset=m.view(Uint32Array,e,716,1),this.svga_dirty_bitmap_max_offset=m.view(Uint32Array,e,720,1),this.fw_value=[],this.fw_pointer=0,this.option_roms=[],this.io=void 0,this.bus=t,this.set_tsc(0,0),this.debug_init()}$.prototype.clear_opstats=function(){new Uint8Array(this.wasm_memory.buffer,32768,131072).fill(0),this.wm.exports.profiler_init()},$.prototype.create_jit_imports=function(){let t=Object.create(null);t.m=this.wm.exports.memory;for(let e of Object.keys(this.wm.exports))e.startsWith("_")||e.startsWith("zstd")||e.endsWith("_js")||(t[e]=this.wm.exports[e]);this.jit_imports=t},$.prototype.wasm_patch=function(){let t=s=>this.wm.exports[s],e=s=>{let r=t(s);return console.assert(r,"Missing import: "+s),r};this.reset_cpu=e("reset_cpu"),this.getiopl=e("getiopl"),this.get_eflags=e("get_eflags"),this.handle_irqs=e("handle_irqs"),this.main_loop=e("main_loop"),this.set_jit_config=e("set_jit_config"),this.read8=e("read8"),this.read16=e("read16"),this.read32s=e("read32s"),this.write8=e("write8"),this.write16=e("write16"),this.write32=e("write32"),this.in_mapped_range=e("in_mapped_range"),this.fpu_load_tag_word=e("fpu_load_tag_word"),this.fpu_load_status_word=e("fpu_load_status_word"),this.fpu_get_sti_f64=e("fpu_get_sti_f64"),this.translate_address_system_read=e("translate_address_system_read_js"),this.get_seg_cs=e("get_seg_cs"),this.get_real_eip=e("get_real_eip"),this.clear_tlb=e("clear_tlb"),this.full_clear_tlb=e("full_clear_tlb"),this.update_state_flags=e("update_state_flags"),this.set_tsc=e("set_tsc"),this.store_current_tsc=e("store_current_tsc"),this.set_cpuid_level=e("set_cpuid_level"),this.pic_set_irq=e("pic_set_irq"),this.pic_clear_irq=e("pic_clear_irq"),this.jit_clear_cache=e("jit_clear_cache_js"),this.jit_dirty_cache=e("jit_dirty_cache"),this.codegen_finalize_finished=e("codegen_finalize_finished"),this.allocate_memory=e("allocate_memory"),this.zero_memory=e("zero_memory"),this.svga_allocate_memory=e("svga_allocate_memory"),this.svga_allocate_dest_buffer=e("svga_allocate_dest_buffer"),this.svga_fill_pixel_buffer=e("svga_fill_pixel_buffer"),this.svga_mark_dirty=e("svga_mark_dirty"),this.get_pic_addr_master=e("get_pic_addr_master"),this.get_pic_addr_slave=e("get_pic_addr_slave"),this.zstd_create_ctx=e("zstd_create_ctx"),this.zstd_get_src_ptr=e("zstd_get_src_ptr"),this.zstd_free_ctx=e("zstd_free_ctx"),this.zstd_read=e("zstd_read"),this.zstd_read_free=e("zstd_read_free"),this.port20_read=e("port20_read"),this.port21_read=e("port21_read"),this.portA0_read=e("portA0_read"),this.portA1_read=e("portA1_read"),this.port20_write=e("port20_write"),this.port21_write=e("port21_write"),this.portA0_write=e("portA0_write"),this.portA1_write=e("portA1_write"),this.port4D0_read=e("port4D0_read"),this.port4D1_read=e("port4D1_read"),this.port4D0_write=e("port4D0_write"),this.port4D1_write=e("port4D1_write")},$.prototype.jit_force_generate=function(t){this.jit_force_generate_unsafe&&this.jit_force_generate_unsafe(t)},$.prototype.jit_clear_func=function(t){this.wm.wasm_table.set(t+1024,null)},$.prototype.jit_clear_all_funcs=function(){let t=this.wm.wasm_table;for(let e=0;900>e;e++)t.set(1024+e,null)},$.prototype.get_state=function(){var t=[];t[0]=this.memory_size[0],t[1]=new Uint8Array([...this.segment_is_null,...this.segment_access_bytes]),t[2]=this.segment_offsets,t[3]=this.segment_limits,t[4]=this.protected_mode[0],t[5]=this.idtr_offset[0],t[6]=this.idtr_size[0],t[7]=this.gdtr_offset[0],t[8]=this.gdtr_size[0],t[9]=this.page_fault[0],t[10]=this.cr,t[11]=this.cpl[0],t[13]=this.is_32[0],t[16]=this.stack_size_32[0],t[17]=this.in_hlt[0],t[18]=this.last_virt_eip[0],t[19]=this.eip_phys[0],t[22]=this.sysenter_cs[0],t[23]=this.sysenter_eip[0],t[24]=this.sysenter_esp[0],t[25]=this.prefixes[0],t[26]=this.flags[0],t[27]=this.flags_changed[0],t[28]=this.last_op1[0],t[30]=this.last_op_size[0],t[37]=this.instruction_pointer[0],t[38]=this.previous_ip[0],t[39]=this.reg32,t[40]=this.sreg,t[41]=this.dreg,t[42]=this.reg_pdpte,this.store_current_tsc(),t[43]=this.current_tsc,t[45]=this.devices.virtio_9p,t[46]=this.devices.apic,t[47]=this.devices.rtc,t[48]=this.devices.pci,t[49]=this.devices.dma,t[50]=this.devices.acpi,t[52]=this.devices.vga,t[53]=this.devices.ps2,t[54]=this.devices.uart0,t[55]=this.devices.fdc,t[56]=this.devices.cdrom,t[57]=this.devices.hda,t[58]=this.devices.pit,t[59]=this.devices.net,t[60]=this.get_state_pic(),t[61]=this.devices.sb16,t[62]=this.fw_value,t[63]=this.devices.ioapic,t[64]=this.tss_size_32[0],t[66]=this.reg_xmm32s,t[67]=this.fpu_st,t[68]=this.fpu_stack_empty[0],t[69]=this.fpu_stack_ptr[0],t[70]=this.fpu_control_word[0],t[71]=this.fpu_ip[0],t[72]=this.fpu_ip_selector[0],t[73]=this.fpu_dp[0],t[74]=this.fpu_dp_selector[0],t[75]=this.fpu_opcode[0];let{packed_memory:e,bitmap:s}=this.pack_memory();return t[77]=e,t[78]=new Uint8Array(s.get_buffer()),t[79]=this.devices.uart1,t[80]=this.devices.uart2,t[81]=this.devices.uart3,t[82]=this.devices.virtio_console,t},$.prototype.get_state_pic=function(){let t=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13),s=[],r=[];return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=r,s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=null,r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],s},$.prototype.set_state=function(t){this.memory_size[0]=t[0],this.mem8.length!==this.memory_size[0]&&console.warn("Note: Memory size mismatch. we="+this.mem8.length+" state="+this.memory_size[0]),t[1].length===8?(this.segment_is_null.set(t[1]),this.segment_access_bytes.fill(242),this.segment_access_bytes[1]=250):t[1].length===16&&(this.segment_is_null.set(t[1].subarray(0,8)),this.segment_access_bytes.set(t[1].subarray(8,16))),this.segment_offsets.set(t[2]),this.segment_limits.set(t[3]),this.protected_mode[0]=t[4],this.idtr_offset[0]=t[5],this.idtr_size[0]=t[6],this.gdtr_offset[0]=t[7],this.gdtr_size[0]=t[8],this.page_fault[0]=t[9],this.cr.set(t[10]),this.cpl[0]=t[11],this.is_32[0]=t[13],this.stack_size_32[0]=t[16],this.in_hlt[0]=t[17],this.last_virt_eip[0]=t[18],this.eip_phys[0]=t[19],this.sysenter_cs[0]=t[22],this.sysenter_eip[0]=t[23],this.sysenter_esp[0]=t[24],this.prefixes[0]=t[25],this.flags[0]=t[26],this.flags_changed[0]=t[27],this.last_op1[0]=t[28],this.last_op_size[0]=t[30],this.instruction_pointer[0]=t[37],this.previous_ip[0]=t[38],this.reg32.set(t[39]),this.sreg.set(t[40]),this.dreg.set(t[41]),t[42]&&this.reg_pdpte.set(t[42]),this.set_tsc(t[43][0],t[43][1]),this.devices.virtio_9p&&this.devices.virtio_9p.set_state(t[45]),this.devices.apic&&this.devices.apic.set_state(t[46]),this.devices.rtc&&this.devices.rtc.set_state(t[47]),this.devices.pci&&this.devices.pci.set_state(t[48]),this.devices.dma&&this.devices.dma.set_state(t[49]),this.devices.acpi&&this.devices.acpi.set_state(t[50]),this.devices.vga&&this.devices.vga.set_state(t[52]),this.devices.ps2&&this.devices.ps2.set_state(t[53]),this.devices.uart0&&this.devices.uart0.set_state(t[54]),this.devices.fdc&&this.devices.fdc.set_state(t[55]),this.devices.cdrom&&this.devices.cdrom.set_state(t[56]),this.devices.hda&&this.devices.hda.set_state(t[57]),this.devices.pit&&this.devices.pit.set_state(t[58]),this.devices.net&&this.devices.net.set_state(t[59]),this.set_state_pic(t[60]),this.devices.sb16&&this.devices.sb16.set_state(t[61]),this.devices.uart1&&this.devices.uart1.set_state(t[79]),this.devices.uart2&&this.devices.uart2.set_state(t[80]),this.devices.uart3&&this.devices.uart3.set_state(t[81]),this.devices.virtio_console&&this.devices.virtio_console.set_state(t[82]),this.fw_value=t[62],this.devices.ioapic&&this.devices.ioapic.set_state(t[63]),this.tss_size_32[0]=t[64],this.reg_xmm32s.set(t[66]),this.fpu_st.set(t[67]),this.fpu_stack_empty[0]=t[68],this.fpu_stack_ptr[0]=t[69],this.fpu_control_word[0]=t[70],this.fpu_ip[0]=t[71],this.fpu_ip_selector[0]=t[72],this.fpu_dp[0]=t[73],this.fpu_dp_selector[0]=t[74],this.fpu_opcode[0]=t[75];let e=new m.Bitmap(t[78].buffer);this.unpack_memory(e,t[77]),this.update_state_flags(),this.full_clear_tlb(),this.jit_clear_cache()},$.prototype.set_state_pic=function(t){let e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),s=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13);e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4];let r=t[5];e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=r[3],s[4]=r[4],s[6]=r[6],s[7]=r[7],s[8]=r[8],s[9]=r[9],s[10]=r[10],s[11]=r[11],s[12]=r[12]},$.prototype.pack_memory=function(){for(var t=this.mem8.length>>12,e=[],s=0;s<t;s++){var r=s<<12;r=this.mem32s.subarray(r>>2,r+4096>>2);let o=!0;for(let l=0;l<r.length;l++)if(r[l]!==0){o=!1;break}o||e.push(s)}t=new m.Bitmap(t),s=new Uint8Array(e.length<<12);for(let[o,l]of e.entries())t.set(l,1),e=l<<12,e=this.mem8.subarray(e,e+4096),s.set(e,o<<12);return{bitmap:t,packed_memory:s}},$.prototype.unpack_memory=function(t,e){this.zero_memory(this.memory_size[0]);let s=this.memory_size[0]>>12,r=0;for(let l=0;l<s;l++)if(t.get(l)){var o=r<<12;o=e.subarray(o,o+4096),this.mem8.set(o,l<<12),r++}},$.prototype.reboot_internal=function(){this.reset_cpu(),this.fw_value=[],this.devices.virtio_9p&&this.devices.virtio_9p.reset(),this.devices.virtio_console&&this.devices.virtio_console.reset(),this.load_bios()},$.prototype.reset_memory=function(){this.mem8.fill(0)},$.prototype.create_memory=function(t){1048576>t?t=1048576:0>(t|0)&&(t=Math.pow(2,31)-131072),t=(t-1|131071)+1|0,console.assert(this.memory_size[0]===0,"Expected uninitialised memory"),this.memory_size[0]=t;let e=this.allocate_memory(t);this.mem8=m.view(Uint8Array,this.wasm_memory,e,t),this.mem32s=m.view(Uint32Array,this.wasm_memory,e,t>>2)},p.exportProperty($.prototype,"create_memory",$.prototype.create_memory),$.prototype.init=function(t,e){this.create_memory(typeof t.memory_size=="number"?t.memory_size:67108864),t.disable_jit&&this.set_jit_config(0,1),t.cpuid_level&&this.set_cpuid_level(t.cpuid_level),this.acpi_enabled[0]=+t.acpi,this.reset_cpu();var s=new h(this);if(this.io=s,this.bios.main=t.bios,this.bios.vga=t.vga_bios,this.load_bios(),t.bzimage){let o=bo(this.mem8,t.bzimage,t.initrd,t.cmdline||"");o&&this.option_roms.push(o)}s.register_read(179,this,function(){return 0});var r=0;s.register_read(146,this,function(){return r}),s.register_write(146,this,function(o){r=o}),s.register_read(1297,this,function(){return this.fw_pointer<this.fw_value.length?this.fw_value[this.fw_pointer++]:0}),s.register_write(1296,this,void 0,function(o){function l(g){return new Uint8Array(Int32Array.of(g).buffer)}function _(g){return g>>8|g<<8&65280}function f(g){return g<<24|g<<8&16711680|g>>8&65280|g>>>24}if(""+a(o),this.fw_pointer=0,o===0)this.fw_value=l(1431127377);else if(o===1)this.fw_value=l(0);else if(o===3)this.fw_value=l(this.memory_size[0]);else if(o===5)this.fw_value=l(1);else if(o===15)this.fw_value=l(1);else if(o===13)this.fw_value=new Uint8Array(16);else if(o===25){o=new Int32Array(4+64*this.option_roms.length);let g=new Uint8Array(o.buffer);o[0]=f(this.option_roms.length);for(let y=0;y<this.option_roms.length;y++){let{name:b,data:v}=this.option_roms[y],C=4+64*y;o[C+0>>2]=f(v.length),o[C+4>>2]=_(49152+y);for(let x=0;x<b.length;x++)g[C+8+x]=b.charCodeAt(x)}this.fw_value=g}else 32768<=o&&49152>o?this.fw_value=l(0):49152<=o&&o-49152<this.option_roms.length?this.fw_value=this.option_roms[o-49152].data:(""+a(o),this.fw_value=l(0))}),s.register_read(32,this,this.port20_read),s.register_read(33,this,this.port21_read),s.register_read(160,this,this.portA0_read),s.register_read(161,this,this.portA1_read),s.register_write(32,this,this.port20_write),s.register_write(33,this,this.port21_write),s.register_write(160,this,this.portA0_write),s.register_write(161,this,this.portA1_write),s.register_read(1232,this,this.port4D0_read),s.register_read(1233,this,this.port4D1_read),s.register_write(1232,this,this.port4D0_write),s.register_write(1233,this,this.port4D1_write),this.devices={},t.load_devices&&(this.devices.pci=new R(this),this.acpi_enabled[0]&&(this.devices.ioapic=new Yt(this),this.devices.apic=new it(this),this.devices.acpi=new lt(this)),this.devices.rtc=new Q(this),this.fill_cmos(this.devices.rtc,t),this.devices.dma=new z(this),this.devices.vga=new M(this,e,t.vga_memory_size||8388608),this.devices.ps2=new X(this,e),this.devices.uart0=new nt(this,1016,e),t.uart1&&(this.devices.uart1=new nt(this,760,e)),t.uart2&&(this.devices.uart2=new nt(this,1e3,e)),t.uart3&&(this.devices.uart3=new nt(this,744,e)),this.devices.fdc=new L(this,t.fda,t.fdb),s=0,t.hda&&(this.devices.hda=new A(this,t.hda,t.hdb,!1,s++,e)),t.cdrom&&(this.devices.cdrom=new A(this,t.cdrom,void 0,!0,s++,e)),this.devices.pit=new G(this,e),t.enable_ne2k&&(this.devices.net=new St(this,e,t.preserve_mac_from_state_image,t.mac_address_translation)),t.fs9p&&(this.devices.virtio_9p=new n(t.fs9p,this,e)),t.virtio_console&&(this.devices.virtio_console=new Xt(this,e)),this.devices.sb16=new q(this,e)),t.multiboot&&(t=this.load_multiboot_option_rom(t.multiboot,t.initrd,t.cmdline))&&(this.bios.main?this.option_roms.push(t):this.reg32[0]=this.io.port_read32(244))},$.prototype.load_multiboot=function(t){this.load_multiboot_option_rom(t,void 0,"")&&(this.reg32[0]=this.io.port_read32(244))},$.prototype.load_multiboot_option_rom=function(t,e,s){if(8192>t.byteLength){var r=new Int32Array(2048);new Uint8Array(r.buffer).set(new Uint8Array(t))}else r=new Int32Array(t,0,2048);for(var o=0;8192>o;o+=4){if(r[o>>2]===464367618){var l=r[o+4>>2];if(464367618+l+r[o+8>>2]|0)continue}else continue;""+a(l>>>0,8);var _=this;this.io.register_read(244,this,function(){return 0},function(){return 0},function(){var b=31860,v=0;if(s){v|=4,_.write32(31760,b),s+="\0";var C=new TextEncoder().encode(s);_.write_blob(C,b),b+=C.length}if(l&2){v|=64,C=0,_.write32(31788,0),_.write32(31792,b);var x=0,F=!1;for(let I=0;4294967296>I;I+=131072)F&&_.memory_map_read8[I>>>17]!==void 0?(_.write32(b,20),_.write32(b+4,x),_.write32(b+8,0),_.write32(b+12,I-x),_.write32(b+16,0),_.write32(b+20,1),b+=24,C+=24,F=!1):F||_.memory_map_read8[I>>>17]!==void 0||(x=I,F=!0);_.write32(31788,C)}if(_.write32(31744,v),C=v=0,l&65536){F=r[o+12>>2],v=r[o+16>>2];var O=r[o+20>>2];C=r[o+24>>2],x=r[o+28>>2],a(F,8),a(v,8),a(O,8),a(C,8),a(x,8),F=new Uint8Array(t,o-(F-v),O===0?void 0:O-v),_.write_blob(F,v),v=x|0,C=Math.max(O,C)}else if(r[0]===1179403647){x=new DataView(t);let[I,K]=ur(x,cr);console.assert(K===52),console.assert(I.magic===1179403647,"Bad magic"),console.assert(I.class===1,"Unimplemented: 64 bit elf"),console.assert(I.data===1,"Unimplemented: big endian"),console.assert(I.version0===1,"Bad version0"),console.assert(I.type===2,"Unimplemented type"),console.assert(I.version1===1,"Bad version1"),console.assert(I.ehsize===52,"Bad header size"),console.assert(I.phentsize===32,"Bad program header size"),console.assert(I.shentsize===40,"Bad section header size"),[v]=lr(new DataView(x.buffer,x.byteOffset+I.phoff,I.phentsize*I.phnum),_r,I.phnum),lr(new DataView(x.buffer,x.byteOffset+I.shoff,I.shentsize*I.shnum),dr,I.shnum),x=I,F=v,v=x.entry;for(O of F)O.type!==0&&(O.type===1?O.paddr+O.memsz<_.memory_size[0]?(O.filesz&&(F=new Uint8Array(t,O.offset,O.filesz),_.write_blob(F,O.paddr)),C=Math.max(C,O.paddr+O.memsz),v===x.entry&&O.vaddr<=v&&O.vaddr+O.memsz>v&&(v=v-O.vaddr+O.paddr)):a(O.paddr):O.type===2||O.type===3||O.type===4||O.type===6||O.type===7||O.type===1685382480||O.type===1685382481||O.type===1685382482||O.type===1685382483||a(O.type))}for(e&&(_.write32(31764,1),_.write32(31768,b),O=C,O&4095&&(O=(O&-4096)+4096),C=O+e.byteLength,_.write32(b,O),_.write32(b+4,C),_.write32(b+8,0),_.write32(b+12,0),_.write_blob(new Uint8Array(e),O)),_.reg32[3]=31744,_.cr[0]=1,_.protected_mode[0]=1,_.flags[0]=2,_.is_32[0]=1,_.stack_size_32[0]=1,b=0;6>b;b++)_.segment_is_null[b]=0,_.segment_offsets[b]=0,_.segment_limits[b]=4294967295,_.sreg[b]=45058;return _.instruction_pointer[0]=_.get_seg_cs()+v|0,_.update_state_flags(),_.debug.dump_state(),_.debug.dump_regs(),732803074}),this.io.register_write_consecutive(244,this,function(b){throw console.log("Test exited with code "+a(b,2)),"HALT"},function(){},function(){},function(){});for(let b=0;15>=b;b++){let v=function(C){a(b),a(C,2),C?this.device_raise_irq(b):this.device_lower_irq(b)};this.io.register_write(8192+b,this,v,v,v)}let g=new Uint8Array(512);new Uint16Array(g.buffer)[0]=43605,g[2]=1;var f=3;g[f++]=102,g[f++]=229,g[f++]=244;let y=g[f]=0;for(let b=0;b<g.length;b++)y+=g[b];return g[f]=-y,{name:"genroms/multiboot.bin",data:g}}},$.prototype.fill_cmos=function(t,e){var s=e.boot_order||291;t.cmos_write(56,1|s>>4&240),t.cmos_write(61,s&255),t.cmos_write(21,128),t.cmos_write(22,2),s=0,1048576<=this.memory_size[0]&&(s=this.memory_size[0]-1048576>>10,s=Math.min(s,65535)),t.cmos_write(23,s&255),t.cmos_write(24,s>>8&255),t.cmos_write(48,s&255),t.cmos_write(49,s>>8&255),s=0,16777216<=this.memory_size[0]&&(s=this.memory_size[0]-16777216>>16,s=Math.min(s,65535)),t.cmos_write(52,s&255),t.cmos_write(53,s>>8&255),t.cmos_write(91,0),t.cmos_write(92,0),t.cmos_write(93,0),t.cmos_write(20,47),t.cmos_write(95,0),e.fastboot&&t.cmos_write(63,1)},$.prototype.load_bios=function(){var t=this.bios.main,e=this.bios.vga;if(t){var s=new Uint8Array(t);if(this.write_blob(s,1048576-t.byteLength),e){var r=new Uint8Array(e);this.write_blob(r,786432),this.io.mmap_register(4272947200,1048576,function(o){return o=o-4272947200|0,o<r.length?r[o]:0},function(){})}this.io.mmap_register(4293918720,1048576,function(o){return this.mem8[o&1048575]}.bind(this),function(o,l){this.mem8[o&1048575]=l}.bind(this))}},$.prototype.codegen_finalize=function(t,e,s,r,o){let l=new Uint8Array(this.wasm_memory.buffer,r>>>0,o>>>0);WebAssembly.instantiate(l,{e:this.jit_imports}).then(_=>{this.wm.wasm_table.set(t+1024,_.instance.exports.f),this.codegen_finalize_finished(t,e,s),this.test_hook_did_finalize_wasm&&this.test_hook_did_finalize_wasm(l)})},$.prototype.log_uncompiled_code=function(){},$.prototype.dump_function_code=function(){},$.prototype.run_hardware_timers=function(t,e){let s=this.devices.pit.timer(e,!1),r=this.devices.rtc.timer(e,!1),o=100,l=100;return t&&(o=this.devices.acpi.timer(e),l=this.devices.apic.timer(e)),Math.min(s,r,o,l)},$.prototype.device_raise_irq=function(t){this.pic_set_irq(t),this.devices.ioapic&&this.devices.ioapic.set_irq(t)},$.prototype.device_lower_irq=function(t){this.pic_clear_irq(t),this.devices.ioapic&&this.devices.ioapic.clear_irq(t)},typeof window<"u"?window.CPU=$:typeof bt<"u"&&typeof bt.exports<"u"?bt.exports.CPU=$:typeof importScripts=="function"&&(self.CPU=$),$.prototype.debug_init=function(){var t=this,e={};this.debug=e,e.init=function(){},e.get_regs_short=function(){},e.dump_regs=function(){},e.get_state=function(){},e.dump_state=function(){},e.dump_stack=function(){},e.dump_page_structures=function(){if(t.cr[4]&32)for(var l=0;4>l;l++)t.read32s(t.cr[3]+8*l)},e.dump_gdt_ldt=function(){},e.dump_idt=function(){},e.get_memory_dump=function(){},e.memory_hex_dump=function(){},e.used_memory_dump=function(){},e.debug_interrupt=function(){};let s,r;e.dump_code=function(l,_,f){if(!r){if(s===void 0&&(s=typeof Ut=="function"?Ut("./capstone-x86.min.js"):window.cs,s===void 0))return;r=[new s.Capstone(s.ARCH_X86,s.MODE_16),new s.Capstone(s.ARCH_X86,s.MODE_32)]}try{r[l].disasm(_,f).forEach(function(g){a(g.address>>>0)+""+m.pads(g.bytes.map(y=>a(y,2).slice(-2)).join(" "),20)+g.mnemonic+g.op_str})}catch{""+Array.from(_).map(y=>a(y,2)).join(" ")}};let o;e.dump_wasm=function(l){if(!(o===void 0&&(o=typeof Ut=="function"?Ut("./libwabt.js"):new window.WabtModule,o===void 0))){l=l.slice();try{var _=o.readWasm(l,{readDebugNames:!1});_.generateNames(),_.applyNames(),_.toText({foldExprs:!0,inlineExport:!0})}catch(y){var f=new Blob([l]),g=document.createElement("a");g.download="failed.wasm",g.href=window.URL.createObjectURL(f),g.dataset.downloadurl=["application/octet-stream",g.download,g.href].join(":"),g.click(),window.URL.revokeObjectURL(g.src),console.log(y.toString())}finally{_&&_.destroy()}}}};let fe=DataView.prototype,Me={size:1,get:fe.getUint8,set:fe.setUint8},se={size:2,get:fe.getUint16,set:fe.setUint16},Z={size:4,get:fe.getUint32,set:fe.setUint32},cr=Ji([{magic:Z},{class:Me},{data:Me},{version0:Me},{osabi:Me},{abiversion:Me},{pad0:function(t){return{size:t,get:()=>-1}}(7)},{type:se},{machine:se},{version1:Z},{entry:Z},{phoff:Z},{shoff:Z},{flags:Z},{ehsize:se},{phentsize:se},{phnum:se},{shentsize:se},{shnum:se},{shstrndx:se}]);console.assert(cr.reduce((t,e)=>t+e.size,0)===52);let _r=Ji([{type:Z},{offset:Z},{vaddr:Z},{paddr:Z},{filesz:Z},{memsz:Z},{flags:Z},{align:Z}]);console.assert(_r.reduce((t,e)=>t+e.size,0)===32);let dr=Ji([{name:Z},{type:Z},{flags:Z},{addr:Z},{offset:Z},{size:Z},{link:Z},{info:Z},{addralign:Z},{entsize:Z}]);console.assert(dr.reduce((t,e)=>t+e.size,0)===40);function Ji(t){return t.map(function(e){var s=Object.keys(e);return console.assert(s.length===1),s=s[0],e=e[s],console.assert(0<e.size),{name:s,type:e,size:e.size,get:e.get,set:e.set}})}function ur(t,e){let s={},r=0;for(let o of e)e=o.get.call(t,r,!0),console.assert(s[o.name]===void 0),s[o.name]=e,r+=o.size;return[s,r]}function lr(t,e,s){let r=[],o=0;for(var l=0;l<s;l++){let[_,f]=ur(new DataView(t.buffer,t.byteOffset+o,void 0),e);r.push(_),o+=f}return[r,o]}function bo(t,e,s,r){var o=new Uint8Array(e);let l=new Uint16Array(e);var _=new Uint32Array(e),f=o[497]||4,g=l[255];if(g!==43605)a(g);else if(g=l[257]|l[258]<<16,g!==1400005704)a(g);else{g=l[259];var y=o[529],b=l[283],v=_[139],C=_[140],x=o[565],F=518<=g?_[142]:255,O=_[146],I=_[147],K=_[150],mt=_[151],Et=_[152];for(a(g),a(y),a(b),a(_[133]),a(v),a(C),a(x),a(F),a(O),a(I),a(mt),a(K),a(Et),o[528]=255,o[529]=y&-97|128,l[274]=56832,l[253]=65535,a(56832),r+="\0",a(581632),_[138]=581632,o=0;o<r.length;o++)t[581632+o]=r.charCodeAt(o);for(f=512*(f+1),a(f),r=new Uint8Array(e,0,f),e=new Uint8Array(e,f),o=f=0,s&&(f=67108864,o=s.byteLength,t.set(new Uint8Array(s),f)),_[134]=f,_[135]=o,t.set(r,524288),t.set(e,1048576),t=new Uint8Array(512),new Uint16Array(t.buffer)[0]=43605,t[2]=1,s=3,t[s++]=250,t[s++]=184,t[s++]=32768,t[s++]=128,t[s++]=142,t[s++]=192,t[s++]=142,t[s++]=216,t[s++]=142,t[s++]=224,t[s++]=142,t[s++]=232,t[s++]=142,t[s++]=208,t[s++]=188,t[s++]=57344,t[s++]=224,t[s++]=234,t[s++]=0,t[s++]=0,t[s++]=32800,t[s++]=128,_=t[s]=0,e=0;e<t.length;e++)_+=t[e];return t[s]=-_,{name:"genroms/kernel.bin",data:t}}}function vo(t){function e(x){return!x.altKey&&f[56]&&l(56,!1),o(x,!1)}function s(x){return!x.altKey&&f[56]&&l(56,!1),o(x,!0)}function r(){for(var x=Object.keys(f),F,O=0;O<x.length;O++)F=+x[O],f[F]&&l(F,!1);f={}}function o(x,F){var O;if((O=g.bus)&&(O=x.shiftKey&&x.ctrlKey&&(x.keyCode===73||x.keyCode===74||x.keyCode===75)||!g.emu_enabled?!1:x.target?x.target.classList.contains("phone_keyboard")||x.target.nodeName!=="INPUT"&&x.target.nodeName!=="TEXTAREA":!0),O){t:{if(x.code!==void 0&&(O=C[x.code],O!==void 0))break t;O=y[x.keyCode]}if(O)return l(O,F,x.repeat),x.preventDefault&&x.preventDefault(),!1;console.log("Missing char in map: keyCode="+(x.keyCode||-1).toString(16)+" code="+x.code)}}function l(x,F,O){if(F)f[x]&&!O&&l(x,!1);else if(!f[x])return;(f[x]=F)||(x|=128),255<x?(_(x>>8),_(x&255)):_(x)}function _(x){g.bus.send("keyboard-code",x)}var f={},g=this;this.emu_enabled=!0;var y=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),b={8:8,10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},v={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192},C={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,IntlRo:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57415,ArrowUp:57416,PageUp:57417,ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=t,this.destroy=function(){typeof window<"u"&&(window.removeEventListener("keyup",e,!1),window.removeEventListener("keydown",s,!1),window.removeEventListener("blur",r,!1))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("keyup",e,!1),window.addEventListener("keydown",s,!1),window.addEventListener("blur",r,!1))},this.init(),this.simulate_press=function(x){x={keyCode:x},o(x,!0),o(x,!1)},this.simulate_char=function(x){var F=x.charCodeAt(0);F in b?this.simulate_press(b[F]):F in v?(_(42),this.simulate_press(v[F]),_(170)):console.log("ascii -> keyCode not found: ",F,x)}}function xo(t,e){function s(I){if(!O.enabled||!O.emu_enabled)return!1;var K=e||document.body,mt;if(!(mt=document.pointerLockElement))t:{for(I=I.target;I.parentNode;){if(I===K){mt=!0;break t}I=I.parentNode}mt=!1}return mt}function r(I){s(I)&&(I=I.changedTouches)&&I.length&&(I=I[I.length-1],x=I.clientX,F=I.clientY)}function o(){(b||C||v)&&(O.bus.send("mouse-click",[!1,!1,!1]),b=C=v=!1)}function l(I){if(O.bus&&s(I)&&O.is_running){var K=0,mt=0,Et=I.changedTouches;Et?Et.length&&(Et=Et[Et.length-1],K=Et.clientX-x,mt=Et.clientY-F,x=Et.clientX,F=Et.clientY,I.preventDefault()):typeof I.movementX=="number"?(K=I.movementX,mt=I.movementY):typeof I.webkitMovementX=="number"?(K=I.webkitMovementX,mt=I.webkitMovementY):typeof I.mozMovementX=="number"?(K=I.mozMovementX,mt=I.mozMovementY):(K=I.clientX-x,mt=I.clientY-F,x=I.clientX,F=I.clientY),O.bus.send("mouse-delta",[.15*K,-(.15*mt)]),e&&O.bus.send("mouse-absolute",[I.pageX-e.offsetLeft,I.pageY-e.offsetTop,e.offsetWidth,e.offsetHeight])}}function _(I){s(I)&&g(I,!0)}function f(I){s(I)&&g(I,!1)}function g(I,K){O.bus&&(I.which===1?b=K:I.which===2?C=K:I.which===3&&(v=K),O.bus.send("mouse-click",[b,C,v]),I.preventDefault())}function y(I){if(s(I)){var K=I.wheelDelta||-I.detail;0>K?K=-1:0<K&&(K=1),O.bus.send("mouse-wheel",[K,0]),I.preventDefault()}}var b=!1,v=!1,C=!1,x=0,F=0,O=this;this.enabled=!1,this.emu_enabled=!0,this.bus=t,this.bus.register("mouse-enable",function(I){this.enabled=I},this),this.is_running=!1,this.bus.register("emulator-stopped",function(){this.is_running=!1},this),this.bus.register("emulator-started",function(){this.is_running=!0},this),this.destroy=function(){typeof window<"u"&&(window.removeEventListener("touchstart",r,!1),window.removeEventListener("touchend",o,!1),window.removeEventListener("touchmove",l,!1),window.removeEventListener("mousemove",l,!1),window.removeEventListener("mousedown",_,!1),window.removeEventListener("mouseup",f,!1),window.removeEventListener("wheel",y,{passive:!1}))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("touchstart",r,!1),window.addEventListener("touchend",o,!1),window.addEventListener("touchmove",l,!1),window.addEventListener("mousemove",l,!1),window.addEventListener("mousedown",_,!1),window.addEventListener("mouseup",f,!1),window.addEventListener("wheel",y,{passive:!1}))},this.init()}function pr(t){if(typeof window<"u")if(window.AudioContext||window.webkitAudioContext){var e=window.AudioWorklet?Zi:ts;this.bus=t,this.audio_context=window.AudioContext?new AudioContext:new webkitAudioContext,this.mixer=new me(t,this.audio_context),this.pcspeaker=new fr(t,this.audio_context,this.mixer),this.dac=new e(t,this.audio_context,this.mixer),this.pcspeaker.start(),t.register("emulator-stopped",function(){this.audio_context.suspend()},this),t.register("emulator-started",function(){this.audio_context.resume()},this),t.register("speaker-confirm-initialized",function(){t.send("speaker-has-initialized")},this),t.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}pr.prototype.destroy=function(){this.audio_context&&this.audio_context.close(),this.audio_context=null,this.dac&&this.dac.node_processor&&this.dac.node_processor.port.close(),this.dac=null};function me(t,e){function s(r){return function(o){r.gain.setValueAtTime(o,this.audio_context.currentTime)}}this.audio_context=e,this.sources=new Map,this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1,this.node_treble_left=this.audio_context.createBiquadFilter(),this.node_treble_right=this.audio_context.createBiquadFilter(),this.node_treble_left.type="highshelf",this.node_treble_right.type="highshelf",this.node_treble_left.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_treble_right.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_bass_left=this.audio_context.createBiquadFilter(),this.node_bass_right=this.audio_context.createBiquadFilter(),this.node_bass_left.type="lowshelf",this.node_bass_right.type="lowshelf",this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_gain_left=this.audio_context.createGain(),this.node_gain_right=this.audio_context.createGain(),this.node_merger=this.audio_context.createChannelMerger(2),this.input_left=this.node_treble_left,this.input_right=this.node_treble_right,this.node_treble_left.connect(this.node_bass_left),this.node_bass_left.connect(this.node_gain_left),this.node_gain_left.connect(this.node_merger,0,0),this.node_treble_right.connect(this.node_bass_right),this.node_bass_right.connect(this.node_gain_right),this.node_gain_right.connect(this.node_merger,0,1),this.node_merger.connect(this.audio_context.destination),t.register("mixer-connect",function(r){this.connect_source(r[0],r[1])},this),t.register("mixer-disconnect",function(r){this.disconnect_source(r[0],r[1])},this),t.register("mixer-volume",function(r){var o=r[0],l=r[1];r=Math.pow(10,r[2]/20),o=o===0?this:this.sources.get(o),o===void 0||o.set_volume(r,l)},this),t.register("mixer-gain-left",function(r){this.gain_left=Math.pow(10,r/20),this.update()},this),t.register("mixer-gain-right",function(r){this.gain_right=Math.pow(10,r/20),this.update()},this),t.register("mixer-treble-left",s(this.node_treble_left),this),t.register("mixer-treble-right",s(this.node_treble_right),this),t.register("mixer-bass-left",s(this.node_bass_left),this),t.register("mixer-bass-right",s(this.node_bass_right),this)}me.prototype.add_source=function(t,e){return t=new ge(this.audio_context,t,this.input_left,this.input_right),this.sources.has(e),this.sources.set(e,t),t},me.prototype.connect_source=function(t,e){t=this.sources.get(t),t===void 0||t.connect(e)},me.prototype.disconnect_source=function(t,e){t=this.sources.get(t),t===void 0||t.disconnect(e)},me.prototype.set_volume=function(t,e){switch(e===void 0&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()},me.prototype.update=function(){var t=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)};function ge(t,e,s,r){this.audio_context=t,this.connected_right=this.connected_left=!0,this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1,this.node_splitter=t.createChannelSplitter(2),this.node_gain_left=t.createGain(),this.node_gain_right=t.createGain(),e.connect(this.node_splitter),this.node_splitter.connect(this.node_gain_left,0),this.node_gain_left.connect(s),this.node_splitter.connect(this.node_gain_right,1),this.node_gain_right.connect(r)}ge.prototype.update=function(){var t=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)},ge.prototype.connect=function(t){var e=!t||t===2;(e||t===0)&&(this.connected_left=!0),(e||t===1)&&(this.connected_right=!0),this.update()},ge.prototype.disconnect=function(t){var e=!t||t===2;(e||t===0)&&(this.connected_left=!1),(e||t===1)&&(this.connected_right=!1),this.update()},ge.prototype.set_volume=function(t,e){switch(e===void 0&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()},ge.prototype.set_gain_hidden=function(t){this.gain_hidden=t};function fr(t,e,s){this.node_oscillator=e.createOscillator(),this.node_oscillator.type="square",this.node_oscillator.frequency.setValueAtTime(440,e.currentTime),this.mixer_connection=s.add_source(this.node_oscillator,1),this.mixer_connection.disconnect(),t.register("pcspeaker-enable",function(){s.connect_source(1)},this),t.register("pcspeaker-disable",function(){s.disconnect_source(1)},this),t.register("pcspeaker-update",function(r){var o=r[1],l=0;r[0]===3&&(l=Math.min(1.1931816665999999e6/o,this.node_oscillator.frequency.maxValue),l=Math.max(l,0)),this.node_oscillator.frequency.setValueAtTime(l,e.currentTime)},this)}fr.prototype.start=function(){this.node_oscillator.start()};function Zi(t,e,s){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=48e3,e=function(){function _(y){return y===0?1:(y*=Math.PI,Math.sin(y)/y)}function f(){var y=Reflect.construct(AudioWorkletProcessor,[],f);return y.kernel_size=3,y.queue_data=Array(1024),y.queue_start=0,y.queue_end=0,y.queue_length=0,y.queue_size=y.queue_data.length,y.queued_samples=0,y.source_buffer_previous=g,y.source_buffer_current=g,y.source_samples_per_destination=1,y.source_block_start=0,y.source_time=0,y.source_offset=0,y.port.onmessage=b=>{switch(b.data.type){case"queue":y.queue_push(b.data.value);break;case"sampling-rate":y.source_samples_per_destination=b.data.value/sampleRate}},y}var g=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(f.prototype,AudioWorkletProcessor.prototype),Reflect.setPrototypeOf(f,AudioWorkletProcessor),f.prototype.process=f.prototype.process=function(y,b){for(y=0;y<b[0][0].length;y++){for(var v=0,C=0,x=this.source_offset+this.kernel_size,F=this.source_offset-this.kernel_size+1;F<=x;F++){var O=this.source_block_start+F;v+=this.get_sample(O,0)*this.kernel(this.source_time-F),C+=this.get_sample(O,1)*this.kernel(this.source_time-F)}(isNaN(v)||isNaN(C))&&(v=C=0,this.dbg_log("ERROR: NaN values! Ignoring for now.")),b[0][0][y]=v,b[0][1][y]=C,this.source_time+=this.source_samples_per_destination,this.source_offset=Math.floor(this.source_time)}return b=this.source_offset,b+=this.kernel_size+2,this.source_time-=this.source_offset,this.source_block_start+=this.source_offset,this.source_offset=0,this.ensure_enough_data(b),!0},f.prototype.kernel=function(y){return _(y)*_(y/this.kernel_size)},f.prototype.get_sample=function(y,b){return 0>y?(y+=this.source_buffer_previous[0].length,this.source_buffer_previous[b][y]):this.source_buffer_current[b][y]},f.prototype.ensure_enough_data=function(y){var b=this.source_buffer_current[0].length;b-this.source_block_start<y&&(this.prepare_next_buffer(),this.source_block_start-=b)},f.prototype.prepare_next_buffer=function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback"),this.source_buffer_previous=this.source_buffer_current,this.source_buffer_current=this.queue_shift();var y=this.source_buffer_current[0].length;if(256>y){for(var b=this.queue_start,v=0;256>y&&v<this.queue_length;)y+=this.queue_data[b][0].length,b=b+1&this.queue_size-1,v++;y=Math.max(y,256),y=[new Float32Array(y),new Float32Array(y)],y[0].set(this.source_buffer_current[0]),y[1].set(this.source_buffer_current[1]),b=this.source_buffer_current[0].length;for(var C=0;C<v;C++){var x=this.queue_shift();y[0].set(x[0],b),y[1].set(x[1],b),b+=x[0].length}this.source_buffer_current=y}this.pump()},f.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})},f.prototype.queue_push=function(y){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=y,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,this.queued_samples+=y[0].length,this.pump())},f.prototype.queue_shift=function(){if(!this.queue_length)return g;var y=this.queue_data[this.queue_start];return this.queue_data[this.queue_start]=null,this.queue_start=this.queue_start+1&this.queue_size-1,this.queue_length--,this.queued_samples-=y[0].length,y},f.prototype.dbg_log=function(){},registerProcessor("dac-processor",f)}.toString();var r=e.indexOf("{")+1,o=e.lastIndexOf("}");e=e.substring(r,o),e=new Blob([e],{type:"application/javascript"});var l=URL.createObjectURL(e);this.node_processor=null,this.node_output=this.audio_context.createGain(),this.audio_context.audioWorklet.addModule(l).then(()=>{URL.revokeObjectURL(l),this.node_processor=new AudioWorkletNode(this.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2],parameterData:{},processorOptions:{}}),this.node_processor.port.postMessage({type:"sampling-rate",value:this.sampling_rate}),this.node_processor.port.onmessage=_=>{switch(_.data.type){case"pump":this.pump()}},this.node_processor.connect(this.node_output)}),this.mixer_connection=s.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(_){this.queue(_)},this),t.register("dac-enable",function(){this.enabled=!0},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(_){this.sampling_rate=_,this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:_})},this)}Zi.prototype.queue=function(t){this.node_processor&&this.node_processor.port.postMessage({type:"queue",value:t},[t[0].buffer,t[1].buffer])},Zi.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")};function ts(t,e,s){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=22050,this.buffered_time=0,this.rate_ratio=1,this.node_lowpass=this.audio_context.createBiquadFilter(),this.node_lowpass.type="lowpass",this.node_output=this.node_lowpass,this.mixer_connection=s.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(r){this.queue(r)},this),t.register("dac-enable",function(){this.enabled=!0,this.pump()},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(r){this.sampling_rate=r,this.rate_ratio=Math.ceil(8e3/r),this.node_lowpass.frequency.setValueAtTime(r/2,this.audio_context.currentTime)},this)}ts.prototype.queue=function(t){var e=t[0].length,s=e/this.sampling_rate;if(1<this.rate_ratio)for(var r=this.audio_context.createBuffer(2,e*this.rate_ratio,this.sampling_rate*this.rate_ratio),o=r.getChannelData(0),l=r.getChannelData(1),_=0,f=0;f<e;f++)for(var g=0;g<this.rate_ratio;g++,_++)o[_]=t[0][f],l[_]=t[1][f];else r=this.audio_context.createBuffer(2,e,this.sampling_rate),r.copyToChannel?(r.copyToChannel(t[0],0),r.copyToChannel(t[1],1)):(r.getChannelData(0).set(t[0]),r.getChannelData(1).set(t[1]));if(t=this.audio_context.createBufferSource(),t.buffer=r,t.connect(this.node_lowpass),t.addEventListener("ended",this.pump.bind(this)),r=this.audio_context.currentTime,this.buffered_time<r)for(this.buffered_time=r,r=.2-s,e=0;e<=r;)e+=s,this.buffered_time+=s,setTimeout(()=>this.pump(),1e3*e);t.start(this.buffered_time),this.buffered_time+=s,setTimeout(()=>this.pump(),0)},ts.prototype.pump=function(){this.enabled&&(.2<this.buffered_time-this.audio_context.currentTime||this.bus.send("dac-request-data"))};function ko(t,e){function s(f){_.bus&&_.enabled&&(_.send_char(f.which),f.preventDefault())}function r(f){var g=f.which;g===8?(_.send_char(127),f.preventDefault()):g===9&&(_.send_char(9),f.preventDefault())}function o(f){if(_.enabled){for(var g=f.clipboardData.getData("text/plain"),y=0;y<g.length;y++)_.send_char(g.charCodeAt(y));f.preventDefault()}}function l(f){f.target!==t&&t.blur()}var _=this;this.enabled=!0,this.bus=e,this.text="",this.text_new_line=!1,this.last_update=0,this.bus.register("serial0-output-byte",function(f){f=String.fromCharCode(f),this.show_char(f)},this),this.destroy=function(){t.removeEventListener("keypress",s,!1),t.removeEventListener("keydown",r,!1),t.removeEventListener("paste",o,!1),window.removeEventListener("mousedown",l,!1)},this.init=function(){this.destroy(),t.style.display="block",t.addEventListener("keypress",s,!1),t.addEventListener("keydown",r,!1),t.addEventListener("paste",o,!1),window.addEventListener("mousedown",l,!1)},this.init(),this.show_char=function(f){f==="\b"?(this.text=this.text.slice(0,-1),this.update()):f!=="\r"&&(this.text+=f,f===`
`&&(this.text_new_line=!0),this.update())},this.update=function(){var f=Date.now(),g=f-this.last_update;16>g?this.update_timer===void 0&&(this.update_timer=setTimeout(()=>{this.update_timer=void 0,this.last_update=Date.now(),this.render()},16-g)):(this.update_timer!==void 0&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=f,this.render())},this.render=function(){t.value=this.text,this.text_new_line&&(this.text_new_line=!1,t.scrollTop=1e9)},this.send_char=function(f){_.bus&&_.bus.send("serial0-input",f)}}function es(t,e){if(this.element=t,window.Terminal){var s=this.term=new window.Terminal({logLevel:"off"});s.write("This is the serial console. Whatever you type or paste here will be sent to COM1");var r=s.onData(function(o){for(let l=0;l<o.length;l++)e.send("serial0-input",o.charCodeAt(l))});e.register("serial0-output-byte",function(o){s.write(Uint8Array.of(o))},this),this.destroy=function(){r.dispose(),s.dispose()}}}es.prototype.show=function(){this.term&&this.term.open(this.element)};function Qt(t,e){this.bus=e,this.socket=void 0,this.send_queue=[],this.url=t,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.bus.register("net0-send",function(s){this.send(s)},this)}Qt.prototype.handle_message=function(t){this.bus&&this.bus.send("net0-receive",new Uint8Array(t.data))},Qt.prototype.handle_close=function(){this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval)},Qt.prototype.handle_open=function(){for(var t=0;t<this.send_queue.length;t++)this.send(this.send_queue[t]);this.send_queue=[]},Qt.prototype.handle_error=function(){},Qt.prototype.destroy=function(){this.socket&&this.socket.close()},Qt.prototype.connect=function(){if(typeof WebSocket<"u"){if(this.socket){var t=this.socket.readyState;if(t===0||t===1)return}if(t=Date.now(),!(this.last_connect_attempt+this.reconnect_interval>t)){this.last_connect_attempt=Date.now();try{this.socket=new WebSocket(this.url)}catch(e){console.error(e);return}this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this)}}},Qt.prototype.send=function(t){this.socket&&this.socket.readyState===1?this.socket.send(t):(this.send_queue.push(t),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())},Qt.prototype.change_proxy=function(t){this.url=t,this.socket&&(this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.close(),this.socket=void 0)};function D(t){this.cpu_is_running=!1,this.cpu_exception_hook=function(){};var e=ar.create();this.bus=e[0],this.emulator_bus=e[1];var s,r;let o=new WebAssembly.Table({element:"anyfunc",initial:1924});e={cpu_exception_hook:_=>this.cpu_exception_hook(_),run_hardware_timers:function(_,f){return s.run_hardware_timers(_,f)},cpu_event_halt:()=>{this.emulator_bus.send("cpu-event-halt")},abort:function(){},microtick:u.microtick,get_rand_int:function(){return m.get_rand_int()},apic_acknowledge_irq:function(){return s.devices.apic.acknowledge_irq()},stop_idling:function(){return s.stop_idling()},io_port_read8:function(_){return s.io.port_read8(_)},io_port_read16:function(_){return s.io.port_read16(_)},io_port_read32:function(_){return s.io.port_read32(_)},io_port_write8:function(_,f){s.io.port_write8(_,f)},io_port_write16:function(_,f){s.io.port_write16(_,f)},io_port_write32:function(_,f){s.io.port_write32(_,f)},mmap_read8:function(_){return s.mmap_read8(_)},mmap_read16:function(_){return s.mmap_read16(_)},mmap_read32:function(_){return s.mmap_read32(_)},mmap_write8:function(_,f){s.mmap_write8(_,f)},mmap_write16:function(_,f){s.mmap_write16(_,f)},mmap_write32:function(_,f){s.mmap_write32(_,f)},mmap_write64:function(_,f,g){s.mmap_write64(_,f,g)},mmap_write128:function(_,f,g,y,b){s.mmap_write128(_,f,g,y,b)},log_from_wasm:function(_,f){m.read_sized_string_from_mem(r,_,f)},console_log_from_wasm:function(_,f){_=m.read_sized_string_from_mem(r,_,f),console.error(_)},dbg_trace_from_wasm:function(){},codegen_finalize:(_,f,g,y,b)=>{s.codegen_finalize(_,f,g,y,b)},jit_clear_func:_=>s.jit_clear_func(_),jit_clear_all_funcs:()=>s.jit_clear_all_funcs(),__indirect_function_table:o};let l=t.wasm_fn;l||(l=_=>new Promise(f=>{let g="v86.wasm",y="v86-fallback.wasm";if(t.wasm_path){g=t.wasm_path;let b=g.lastIndexOf("/");y=(b===-1?"":g.substr(0,b))+"/"+y}else typeof window>"u"&&typeof __dirname=="string"?(g=__dirname+"/"+g,y=__dirname+"/"+y):(g="build/"+g,y="build/"+y);m.load_file(g,{done:async b=>{try{let{instance:v}=await WebAssembly.instantiate(b,_);this.wasm_source=b,f(v.exports)}catch{m.load_file(y,{done:async C=>{let{instance:x}=await WebAssembly.instantiate(C,_);this.wasm_source=C,f(x.exports)}})}},progress:b=>{this.emulator_bus.send("download-progress",{file_index:0,file_count:1,file_name:g,lengthComputable:b.lengthComputable,total:b.total,loaded:b.loaded})}})})),l({env:e}).then(_=>{r=_.memory,_.rust_init(),_=this.v86=new u(this.emulator_bus,{exports:_,wasm_table:o}),s=_.cpu,this.continue_init(_,t)}),this.zstd_worker=null,this.zstd_worker_request_id=0}D.prototype.continue_init=async function(t,e){function s(C,x){switch(C){case"hda":o.hda=this.disk_images.hda=x;break;case"hdb":o.hdb=this.disk_images.hdb=x;break;case"cdrom":o.cdrom=this.disk_images.cdrom=x;break;case"fda":o.fda=this.disk_images.fda=x;break;case"fdb":o.fdb=this.disk_images.fdb=x;break;case"multiboot":o.multiboot=this.disk_images.multiboot=x.buffer;break;case"bzimage":o.bzimage=this.disk_images.bzimage=x.buffer;break;case"initrd":o.initrd=this.disk_images.initrd=x.buffer;break;case"bios":o.bios=x.buffer;break;case"vga_bios":o.vga_bios=x.buffer;break;case"initial_state":o.initial_state=x.buffer;break;case"fs9p_json":o.fs9p_json=x}}async function r(){if(o.fs9p&&o.fs9p_json&&!o.initial_state&&(o.fs9p.load_from_json(o.fs9p_json),e.bzimage_initrd_from_filesystem)){let{bzimage_path:C,initrd_path:x}=this.get_bzimage_initrd_from_filesystem(o.fs9p),[F,O]=await Promise.all([o.fs9p.read_file(x),o.fs9p.read_file(C)]);s.call(this,"initrd",new m.SyncBuffer(F.buffer)),s.call(this,"bzimage",new m.SyncBuffer(O.buffer))}this.serial_adapter&&this.serial_adapter.show&&this.serial_adapter.show(),this.bus.send("cpu-init",o),o.initial_state&&(t.restore_state(o.initial_state),o.initial_state=void 0),e.autostart&&this.bus.send("cpu-run"),this.emulator_bus.send("emulator-loaded")}this.bus.register("emulator-stopped",function(){this.cpu_is_running=!1},this),this.bus.register("emulator-started",function(){this.cpu_is_running=!0},this);var o={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0};var l=e.boot_order?e.boot_order:e.fda?801:e.hda?786:291;o.acpi=e.acpi,o.disable_jit=e.disable_jit,o.load_devices=!0,o.memory_size=e.memory_size||67108864,o.vga_memory_size=e.vga_memory_size||8388608,o.boot_order=l,o.fastboot=e.fastboot||!1,o.fda=void 0,o.fdb=void 0,o.uart1=e.uart1,o.uart2=e.uart2,o.uart3=e.uart3,o.cmdline=e.cmdline,o.preserve_mac_from_state_image=e.preserve_mac_from_state_image,o.mac_address_translation=e.mac_address_translation,o.cpuid_level=e.cpuid_level,o.virtio_console=e.virtio_console,e.network_adapter?this.network_adapter=e.network_adapter(this.bus):e.network_relay_url&&(this.network_adapter=new Qt(e.network_relay_url,this.bus)),o.enable_ne2k=!0,e.disable_keyboard||(this.keyboard_adapter=new vo(this.bus)),e.disable_mouse||(this.mouse_adapter=new xo(this.bus,e.screen_container)),e.screen_container?this.screen_adapter=new c(e.screen_container,this.bus):e.screen_dummy&&(this.screen_adapter=new So(this.bus)),e.serial_container&&(this.serial_adapter=new ko(e.serial_container,this.bus)),e.serial_container_xtermjs&&(this.serial_adapter=new es(e.serial_container_xtermjs,this.bus)),e.disable_speaker||(this.speaker_adapter=new pr(this.bus));var _=[];if(l=(C,x)=>{x&&(x.get&&x.set&&x.load?_.push({name:C,loadable:x}):((C==="bios"||C==="vga_bios"||C==="initial_state"||C==="multiboot"||C==="bzimage"||C==="initrd")&&(x.async=!1),x.url&&!x.async?_.push({name:C,url:x.url,size:x.size}):_.push({name:C,loadable:m.buffer_from_object(x,this.zstd_decompress_worker.bind(this))})))},e.state&&console.warn("Warning: Unknown option 'state'. Did you mean 'initial_state'?"),l("bios",e.bios),l("vga_bios",e.vga_bios),l("cdrom",e.cdrom),l("hda",e.hda),l("hdb",e.hdb),l("fda",e.fda),l("fdb",e.fdb),l("initial_state",e.initial_state),l("multiboot",e.multiboot),l("bzimage",e.bzimage),l("initrd",e.initrd),e.filesystem){l=e.filesystem.basefs;var f=e.filesystem.baseurl;let C=new ne;if(f&&(C=new Jt(C,f)),o.fs9p=this.fs9p=new U(C),l){if(typeof l=="object"){var g=l.size;l=l.url}_.push({name:"fs9p_json",url:l,size:g,as_json:!0})}}var y=this,b=_.length,v=function(C){if(C===b)setTimeout(r.bind(this),0);else{var x=_[C];x.loadable?(x.loadable.onload=function(){s.call(this,x.name,x.loadable),v(C+1)}.bind(this),x.loadable.load()):m.load_file(x.url,{done:function(F){x.url.endsWith(".zst")&&x.name!=="initial_state"&&(F=this.zstd_decompress(x.size,new Uint8Array(F))),s.call(this,x.name,x.as_json?F:new m.SyncBuffer(F)),v(C+1)}.bind(this),progress:function(F){F.target.status===200?y.emulator_bus.send("download-progress",{file_index:C,file_count:b,file_name:x.url,lengthComputable:F.lengthComputable,total:F.total||x.size,loaded:F.loaded}):y.emulator_bus.send("download-error",{file_index:C,file_count:b,file_name:x.url,request:F.target})},as_json:x.as_json})}}.bind(this);v(0)},D.prototype.zstd_decompress=function(t,e){let s=this.v86.cpu;this.zstd_context=s.zstd_create_ctx(e.length),new Uint8Array(s.wasm_memory.buffer).set(e,s.zstd_get_src_ptr(this.zstd_context)),e=s.zstd_read(this.zstd_context,t);let r=s.wasm_memory.buffer.slice(e,e+t);return s.zstd_read_free(e,t),s.zstd_free_ctx(this.zstd_context),this.zstd_context=null,r},D.prototype.zstd_decompress_worker=async function(t,e){if(!this.zstd_worker){let s=URL.createObjectURL(new Blob(["("+function(){let r;globalThis.onmessage=function(o){if(r){var{src:l,decompressed_size:_,id:f}=o.data;o=r.exports;var g=o.zstd_create_ctx(l.length);new Uint8Array(o.memory.buffer).set(l,o.zstd_get_src_ptr(g));var y=o.zstd_read(g,_),b=o.memory.buffer.slice(y,y+_);o.zstd_read_free(y,_),o.zstd_free_ctx(g),postMessage({result:b,id:f},[b])}else g=Object.fromEntries("cpu_exception_hook run_hardware_timers cpu_event_halt microtick get_rand_int apic_acknowledge_irq stop_idling io_port_read8 io_port_read16 io_port_read32 io_port_write8 io_port_write16 io_port_write32 mmap_read8 mmap_read16 mmap_read32 mmap_write8 mmap_write16 mmap_write32 mmap_write64 mmap_write128 codegen_finalize jit_clear_func jit_clear_all_funcs".split(" ").map(v=>[v,()=>console.error("zstd worker unexpectedly called "+v)])),g.__indirect_function_table=new WebAssembly.Table({element:"anyfunc",initial:1024}),g.abort=()=>{throw Error("zstd worker aborted")},g.log_from_wasm=g.console_log_from_wasm=(v,C)=>{console.log(String.fromCharCode(...new Uint8Array(r.exports.memory.buffer,v,C)))},g.dbg_trace_from_wasm=()=>console.trace(),r=new WebAssembly.Instance(new WebAssembly.Module(o.data),{env:g})}}.toString()+")()"],{type:"text/javascript"}));this.zstd_worker=new Worker(s),URL.revokeObjectURL(s),this.zstd_worker.postMessage(this.wasm_source,[this.wasm_source])}return new Promise(s=>{let r=this.zstd_worker_request_id++,o=async l=>{l.data.id===r&&(this.zstd_worker.removeEventListener("message",o),s(l.data.result))};this.zstd_worker.addEventListener("message",o),this.zstd_worker.postMessage({src:e,decompressed_size:t,id:r},[e.buffer])})},D.prototype.get_bzimage_initrd_from_filesystem=function(t){let e=(t.read_dir("/")||[]).map(o=>"/"+o);t=(t.read_dir("/boot/")||[]).map(o=>"/boot/"+o);let s,r;for(let o of[].concat(e,t)){let l=/old/i.test(o)||/fallback/i.test(o),_=/vmlinuz/i.test(o)||/bzimage/i.test(o),f=/initrd/i.test(o)||/initramfs/i.test(o);!_||r&&l||(r=o),!f||s&&l||(s=o)}return s&&r||(console.log("Failed to find bzimage or initrd in filesystem. Files:"),console.log(e.join(" ")),console.log(t.join(" "))),{initrd_path:s,bzimage_path:r}},D.prototype.run=async function(){this.bus.send("cpu-run")},p.exportProperty(D.prototype,"run",D.prototype.run),D.prototype.stop=async function(){this.cpu_is_running&&await new Promise(t=>{let e=()=>{this.remove_listener("emulator-stopped",e),t()};this.add_listener("emulator-stopped",e),this.bus.send("cpu-stop")})},p.exportProperty(D.prototype,"stop",D.prototype.stop),D.prototype.destroy=async function(){await this.stop(),this.v86.destroy(),this.keyboard_adapter&&this.keyboard_adapter.destroy(),this.network_adapter&&this.network_adapter.destroy(),this.mouse_adapter&&this.mouse_adapter.destroy(),this.screen_adapter&&this.screen_adapter.destroy(),this.serial_adapter&&this.serial_adapter.destroy(),this.speaker_adapter&&this.speaker_adapter.destroy()},p.exportProperty(D.prototype,"destroy",D.prototype.destroy),D.prototype.restart=function(){this.bus.send("cpu-restart")},p.exportProperty(D.prototype,"restart",D.prototype.restart),D.prototype.add_listener=function(t,e){this.bus.register(t,e,this)},p.exportProperty(D.prototype,"add_listener",D.prototype.add_listener),D.prototype.remove_listener=function(t,e){this.bus.unregister(t,e)},p.exportProperty(D.prototype,"remove_listener",D.prototype.remove_listener),D.prototype.restore_state=async function(t){this.v86.restore_state(t)},p.exportProperty(D.prototype,"restore_state",D.prototype.restore_state),D.prototype.save_state=async function(){return this.v86.save_state()},p.exportProperty(D.prototype,"save_state",D.prototype.save_state),D.prototype.get_instruction_counter=function(){return this.v86?this.v86.cpu.instruction_counter[0]>>>0:0},p.exportProperty(D.prototype,"get_instruction_counter",D.prototype.get_instruction_counter),D.prototype.is_running=function(){return this.cpu_is_running},p.exportProperty(D.prototype,"is_running",D.prototype.is_running),D.prototype.set_fda=async function(t){if(t.url&&!t.async)m.load_file(t.url,{done:e=>{this.v86.cpu.devices.fdc.set_fda(new m.SyncBuffer(e))}});else{let e=m.buffer_from_object(t,this.zstd_decompress_worker.bind(this));e.onload=()=>{this.v86.cpu.devices.fdc.set_fda(e)},await e.load()}},p.exportProperty(D.prototype,"set_fda",D.prototype.set_fda),D.prototype.eject_fda=function(){this.v86.cpu.devices.fdc.eject_fda()},p.exportProperty(D.prototype,"eject_fda",D.prototype.eject_fda),D.prototype.keyboard_send_scancodes=function(t){for(var e=0;e<t.length;e++)this.bus.send("keyboard-code",t[e])},p.exportProperty(D.prototype,"keyboard_send_scancodes",D.prototype.keyboard_send_scancodes),D.prototype.keyboard_send_keys=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_press(t[e])},p.exportProperty(D.prototype,"keyboard_send_keys",D.prototype.keyboard_send_keys),D.prototype.keyboard_send_text=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_char(t[e])},p.exportProperty(D.prototype,"keyboard_send_text",D.prototype.keyboard_send_text),D.prototype.screen_make_screenshot=function(){return this.screen_adapter?this.screen_adapter.make_screenshot():null},p.exportProperty(D.prototype,"screen_make_screenshot",D.prototype.screen_make_screenshot),D.prototype.screen_set_scale=function(t,e){this.screen_adapter&&this.screen_adapter.set_scale(t,e)},p.exportProperty(D.prototype,"screen_set_scale",D.prototype.screen_set_scale),D.prototype.screen_go_fullscreen=function(){if(this.screen_adapter){var t=document.getElementById("screen_container");if(t){var e=t.requestFullScreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullScreen;e&&(e.call(t),(t=document.getElementsByClassName("phone_keyboard")[0])&&t.focus());try{navigator.keyboard.lock()}catch{}this.lock_mouse()}}},p.exportProperty(D.prototype,"screen_go_fullscreen",D.prototype.screen_go_fullscreen),D.prototype.lock_mouse=function(){var t=document.body,e=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;e&&e.call(t)},p.exportProperty(D.prototype,"lock_mouse",D.prototype.lock_mouse),D.prototype.mouse_set_status=function(t){this.mouse_adapter&&(this.mouse_adapter.emu_enabled=t)},D.prototype.keyboard_set_status=function(t){this.keyboard_adapter&&(this.keyboard_adapter.emu_enabled=t)},p.exportProperty(D.prototype,"keyboard_set_status",D.prototype.keyboard_set_status),D.prototype.serial0_send=function(t){for(var e=0;e<t.length;e++)this.bus.send("serial0-input",t.charCodeAt(e))},p.exportProperty(D.prototype,"serial0_send",D.prototype.serial0_send),D.prototype.serial_send_bytes=function(t,e){for(var s=0;s<e.length;s++)this.bus.send("serial"+t+"-input",e[s])},p.exportProperty(D.prototype,"serial_send_bytes",D.prototype.serial_send_bytes),D.prototype.serial_set_modem_status=function(t,e){this.bus.send("serial"+t+"-modem-status-input",e)},D.prototype.serial_set_carrier_detect=function(t,e){this.bus.send("serial"+t+"-carrier-detect-input",e)},D.prototype.serial_set_ring_indicator=function(t,e){this.bus.send("serial"+t+"-ring-indicator-input",e)},D.prototype.serial_set_data_set_ready=function(t,e){this.bus.send("serial"+t+"-data-set-ready-input",e)},D.prototype.serial_set_clear_to_send=function(t,e){this.bus.send("serial"+t+"-clear-to-send-input",e)},D.prototype.mount_fs=async function(t,e,s,r){let o=new ne;e&&(o=new Jt(o,e));let l=new U(o,this.fs9p.qidcounter),_=()=>{let f=this.fs9p.Mount(t,l);r&&(f===-2?r(new ci):f===-17?r(new mr):0>f?r(Error("Failed to mount. Error number: "+-f)):r(null))};e?l.load_from_json(s,()=>_()):_()},p.exportProperty(D.prototype,"mount_fs",D.prototype.mount_fs),D.prototype.create_file=async function(t,e){var s=this.fs9p;if(s){var r=t.split("/");if(r=r[r.length-1],t=s.SearchPath(t).parentid,r!==""&&t!==-1)await s.CreateBinaryFile(r,t,e);else return Promise.reject(new ci)}},p.exportProperty(D.prototype,"create_file",D.prototype.create_file),D.prototype.read_file=async function(t){var e=this.fs9p;if(e)return(t=await e.read_file(t))?t:Promise.reject(new ci)},p.exportProperty(D.prototype,"read_file",D.prototype.read_file),D.prototype.automatically=function(t){let e=s=>{let r=s[0];if(r){var o=s.slice(1);if(r.sleep)setTimeout(()=>e(o),1e3*r.sleep);else if(r.vga_text){let l=this.screen_adapter.get_text_screen();for(let _ of l)if(_.includes(r.vga_text)){e(o);return}setTimeout(()=>e(s),1e3)}else r.keyboard_send?(r.keyboard_send instanceof Array?this.keyboard_send_scancodes(r.keyboard_send):this.keyboard_send_text(r.keyboard_send),e(o)):r.call&&(r.call(),e(o))}};e(t)},D.prototype.read_memory=function(t,e){return this.v86.cpu.read_blob(t,e)},D.prototype.write_memory=function(t,e){this.v86.cpu.write_blob(t,e)},D.prototype.set_serial_container_xtermjs=function(t){this.serial_adapter&&this.serial_adapter.destroy&&this.serial_adapter.destroy(),this.serial_adapter=new es(t,this.bus),this.serial_adapter.show()};function mr(t){this.message=t||"File already exists"}mr.prototype=Error.prototype;function ci(t){this.message=t||"File not found"}ci.prototype=Error.prototype,typeof window<"u"?(window.V86Starter=D,window.V86=D):typeof bt<"u"&&typeof bt.exports<"u"?(bt.exports.V86Starter=D,bt.exports.V86=D):typeof importScripts=="function"&&(self.V86Starter=D,self.V86=D);var _i={Connector:function(t){this.listeners={},this.pair=t,t.addEventListener("message",function(e){e=e.data;for(var s=this.listeners[e[0]],r=0;r<s.length;r++){var o=s[r];o.fn.call(o.this_value,e[1])}}.bind(this),!1)}};_i.Connector.prototype.register=function(t,e,s){var r=this.listeners[t];r===void 0&&(r=this.listeners[t]=[]),r.push({fn:e,this_value:s})},_i.Connector.prototype.send=function(t,e,s){this.pair&&this.pair.postMessage([t,e],s)},_i.init=function(t){return new _i.Connector(t)};function So(t){var e,s,r,o,l;this.bus=t,t.register("screen-set-mode",function(_){this.set_mode(_)},this),t.register("screen-fill-buffer-end",function(_){this.update_buffer(_[0],_[1])},this),t.register("screen-put-char",function(_){this.put_char(_[0],_[1],_[2],_[3],_[4],_[5])},this),t.register("screen-text-scroll",function(_){console.log("scroll",_)},this),t.register("screen-update-cursor",function(_){this.update_cursor(_[0],_[1])},this),t.register("screen-update-cursor-scanline",function(_){this.update_cursor_scanline(_[0],_[1],_[2])},this),t.register("screen-set-size-text",function(_){this.set_size_text(_[0],_[1])},this),t.register("screen-set-size-graphical",function(_){this.set_size_graphical(_[0],_[1])},this),this.put_char=function(_,f,g,y,b,v){_<l&&f<o&&(_=4*(_*o+f),r[_+0]=g,r[_+1]=y,r[_+2]=b,r[_+3]=v)},this.destroy=function(){},this.set_mode=function(){},this.clear_screen=function(){},this.set_size_text=function(_,f){(_!==o||f!==l)&&(r=new Int32Array(_*f*4),o=_,l=f)},this.set_size_graphical=function(){},this.set_scale=function(){},this.update_cursor_scanline=function(){},this.update_cursor=function(_,f){(_!==e||f!==s)&&(e=_,s=f)},this.update_buffer=function(){},this.get_text_screen=function(){for(var _=[],f=0;f<l;f++)_.push(this.get_text_row(f));return _},this.get_text_row=function(_){var f="";_=4*_*o;for(var g=0;g<o;g++)f+=String.fromCharCode(r[_+0+4*g]);return f}}let re={stats_to_string:function(t){return re.print_misc_stats(t)+re.print_instruction_counts(t)},print_misc_stats:function(t){let e="";var s="COMPILE COMPILE_SKIPPED_NO_NEW_ENTRY_POINTS COMPILE_WRONG_ADDRESS_SPACE COMPILE_CUT_OFF_AT_END_OF_PAGE COMPILE_WITH_LOOP_SAFETY COMPILE_PAGE COMPILE_PAGE/COMPILE COMPILE_BASIC_BLOCK COMPILE_DUPLICATED_BASIC_BLOCK COMPILE_WASM_BLOCK COMPILE_WASM_LOOP COMPILE_DISPATCHER COMPILE_ENTRY_POINT COMPILE_WASM_TOTAL_BYTES COMPILE_WASM_TOTAL_BYTES/COMPILE_PAGE RUN_INTERPRETED RUN_INTERPRETED_NEW_PAGE RUN_INTERPRETED_PAGE_HAS_CODE RUN_INTERPRETED_PAGE_HAS_ENTRY_AFTER_PAGE_WALK RUN_INTERPRETED_NEAR_END_OF_PAGE RUN_INTERPRETED_DIFFERENT_STATE RUN_INTERPRETED_DIFFERENT_STATE_CPL3 RUN_INTERPRETED_DIFFERENT_STATE_FLAT RUN_INTERPRETED_DIFFERENT_STATE_IS32 RUN_INTERPRETED_DIFFERENT_STATE_SS32 RUN_INTERPRETED_MISSED_COMPILED_ENTRY_RUN_INTERPRETED RUN_INTERPRETED_STEPS RUN_FROM_CACHE RUN_FROM_CACHE_STEPS RUN_FROM_CACHE_STEPS/RUN_FROM_CACHE RUN_FROM_CACHE_STEPS/RUN_INTERPRETED_STEPS DIRECT_EXIT INDIRECT_JUMP INDIRECT_JUMP_NO_ENTRY NORMAL_PAGE_CHANGE NORMAL_FALLTHRU NORMAL_FALLTHRU_WITH_TARGET_BLOCK NORMAL_BRANCH NORMAL_BRANCH_WITH_TARGET_BLOCK CONDITIONAL_JUMP CONDITIONAL_JUMP_PAGE_CHANGE CONDITIONAL_JUMP_EXIT CONDITIONAL_JUMP_FALLTHRU CONDITIONAL_JUMP_FALLTHRU_WITH_TARGET_BLOCK CONDITIONAL_JUMP_BRANCH CONDITIONAL_JUMP_BRANCH_WITH_TARGET_BLOCK DISPATCHER_SMALL DISPATCHER_LARGE LOOP LOOP_SAFETY CONDITION_OPTIMISED CONDITION_UNOPTIMISED CONDITION_UNOPTIMISED_PF CONDITION_UNOPTIMISED_UNHANDLED_L CONDITION_UNOPTIMISED_UNHANDLED_LE FAILED_PAGE_CHANGE SAFE_READ_FAST SAFE_READ_SLOW_PAGE_CROSSED SAFE_READ_SLOW_NOT_VALID SAFE_READ_SLOW_NOT_USER SAFE_READ_SLOW_IN_MAPPED_RANGE SAFE_WRITE_FAST SAFE_WRITE_SLOW_PAGE_CROSSED SAFE_WRITE_SLOW_NOT_VALID SAFE_WRITE_SLOW_NOT_USER SAFE_WRITE_SLOW_IN_MAPPED_RANGE SAFE_WRITE_SLOW_READ_ONLY SAFE_WRITE_SLOW_HAS_CODE SAFE_READ_WRITE_FAST SAFE_READ_WRITE_SLOW_PAGE_CROSSED SAFE_READ_WRITE_SLOW_NOT_VALID SAFE_READ_WRITE_SLOW_NOT_USER SAFE_READ_WRITE_SLOW_IN_MAPPED_RANGE SAFE_READ_WRITE_SLOW_READ_ONLY SAFE_READ_WRITE_SLOW_HAS_CODE PAGE_FAULT TLB_MISS MAIN_LOOP MAIN_LOOP_IDLE DO_MANY_CYCLES CYCLE_INTERNAL INVALIDATE_ALL_MODULES_NO_FREE_WASM_INDICES INVALIDATE_MODULE_WRITTEN_WHILE_COMPILED INVALIDATE_MODULE_UNUSED_AFTER_OVERWRITE INVALIDATE_MODULE_DIRTY_PAGE INVALIDATE_PAGE_HAD_CODE INVALIDATE_PAGE_HAD_ENTRY_POINTS DIRTY_PAGE_DID_NOT_HAVE_CODE RUN_FROM_CACHE_EXIT_SAME_PAGE RUN_FROM_CACHE_EXIT_NEAR_END_OF_PAGE RUN_FROM_CACHE_EXIT_DIFFERENT_PAGE CLEAR_TLB FULL_CLEAR_TLB TLB_FULL TLB_GLOBAL_FULL MODRM_SIMPLE_REG MODRM_SIMPLE_REG_WITH_OFFSET MODRM_SIMPLE_CONST_OFFSET MODRM_COMPLEX SEG_OFFSET_OPTIMISED SEG_OFFSET_NOT_OPTIMISED SEG_OFFSET_NOT_OPTIMISED_ES SEG_OFFSET_NOT_OPTIMISED_FS SEG_OFFSET_NOT_OPTIMISED_GS SEG_OFFSET_NOT_OPTIMISED_NOT_FLAT".split(" "),r=0;let o={};for(let _=0;_<s.length;_++){let f=s[_];var l=void 0;if(f.includes("/")){r++;let[g,y]=f.split("/");l=o[g]/o[y]}else l=o[f]=t.wm.exports.profiler_stat_get(_-r),l=1e8<=l?Math.round(l/1e6)+"m":1e5<=l?Math.round(l/1e3)+"k":l;e+=f+"="+l+`
`}return e+=`
`,s=t.wm.exports.get_valid_tlb_entries_count(),r=t.wm.exports.get_valid_global_tlb_entries_count(),e=e+("TLB_ENTRIES="+s+" ("+r+" global, "+(s-r)+` non-global)
WASM_TABLE_FREE=`)+(t.wm.exports.jit_get_wasm_table_index_free_list_count()+`
`),e+="JIT_CACHE_SIZE="+t.wm.exports.jit_get_cache_size()+`
`,e+="FLAT_SEGMENTS="+t.wm.exports.has_flat_segmentation()+`
`,e+="wasm memory size: "+(t.wasm_memory.buffer.byteLength>>20)+`m
`,e=e+`Config:
JIT_DISABLED=`+(t.wm.exports.get_jit_config(0)+`
`),e+="MAX_PAGES="+t.wm.exports.get_jit_config(1)+`
`,e+="JIT_USE_LOOP_SAFETY="+!!t.wm.exports.get_jit_config(2)+`
`,e+="MAX_EXTRA_BASIC_BLOCKS="+t.wm.exports.get_jit_config(3)+`
`},print_instruction_counts:function(t){return[re.print_instruction_counts_offset(t,!1,!1,!1,!1),re.print_instruction_counts_offset(t,!0,!1,!1,!1),re.print_instruction_counts_offset(t,!1,!0,!1,!1),re.print_instruction_counts_offset(t,!1,!1,!0,!1),re.print_instruction_counts_offset(t,!1,!1,!1,!0)].join(`

`)},print_instruction_counts_offset:function(t,e,s,r,o){let l="";var _=[],f=e?"compiled":s?"jit exit":r?"unguarded register":o?"wasm size":"executed";for(let b=0;256>b;b++)for(let v=0;8>v;v++)for(let C of[!1,!0]){var g=t.wm.exports.get_opstats_buffer(e,s,r,o,b,!1,C,v);_.push({opcode:b,count:g,is_mem:C,fixed_g:v}),g=t.wm.exports.get_opstats_buffer(e,s,r,o,b,!0,C,v),_.push({opcode:3840|b,count:g,is_mem:C,fixed_g:v})}t=0,e=new Set([38,46,54,62,100,101,102,103,240,242,243]);for(let{count:b,opcode:v}of _)e.has(v)||(t+=b);if(t===0)return"";s=new Uint32Array(256),e=new Uint32Array(256);for(let{opcode:b,count:v}of _)(b&65280)===3840?e[b&255]+=v:s[b&255]+=v;l=l+`------------------
Total: `+(t+`
`);let y=1e7<t?1e3:1;for(r=Math.max.apply(Math,_.map(({count:b})=>Math.round(b/y))),r=String(r).length,l+=`Instruction counts ${f} (in ${y}):
`,o=0;256>o;o++)l+=o.toString(16).padStart(2,"0")+":"+m.pads(Math.round(s[o]/y),r),l=o%16===15?l+`
`:l+" ";for(l=l+`
Instruction counts ${f} (0f, in ${y}):
`,f=0;256>f;f++)l+=(f&255).toString(16).padStart(2,"0")+":"+m.pads(Math.round(e[f]/y),r),l=f%16===15?l+`
`:l+" ";l+=`
`,_=_.filter(({count:b})=>b).sort(({count:b},{count:v})=>v-b);for(let{opcode:b,is_mem:v,fixed_g:C,count:x}of _.slice(0,200))_=b.toString(16)+"_"+C+(v?"_m":"_r"),l+=_+":"+(x/t*100).toFixed(2)+" ";return l+`
`}};typeof bt<"u"&&typeof bt.exports<"u"&&(bt.exports.print_stats=re);function ne(){this.filedata=new Map}ne.prototype.read=async function(t,e,s){return(t=this.filedata.get(t))?t.subarray(e,e+s):null},ne.prototype.cache=async function(t,e){this.filedata.set(t,e)},ne.prototype.uncache=function(t){this.filedata.delete(t)};function Jt(t,e){e.endsWith("/")||(e+="/"),this.storage=t,this.baseurl=e}Jt.prototype.load_from_server=function(t){return new Promise(e=>{m.load_file(this.baseurl+t,{done:async s=>{s=new Uint8Array(s),await this.cache(t,s),e(s)}})})},Jt.prototype.read=async function(t,e,s){let r=await this.storage.read(t,e,s);return r||(await this.load_from_server(t)).subarray(e,e+s)},Jt.prototype.cache=async function(t,e){return await this.storage.cache(t,e)},Jt.prototype.uncache=function(t){this.storage.uncache(t)},typeof window<"u"?(window.MemoryFileStorage=ne,window.ServerFileStorageWrapper=Jt):typeof bt<"u"&&typeof bt.exports<"u"?(bt.exports.MemoryFileStorage=ne,bt.exports.ServerFileStorageWrapper=Jt):typeof importScripts=="function"&&(self.MemoryFileStorage=ne,self.ServerFileStorageWrapper=Jt);var _e=32768,Nt=16384,di=4;function U(t,e){this.inodes=[],this.events=[],this.storage=t,this.qidcounter=e||{last_qidnumber:0},this.inodedata={},this.total_size=274877906944,this.used_size=0,this.mounts=[],this.CreateDirectory("",-1)}U.prototype.get_state=function(){let t=[];t[0]=this.inodes,t[1]=this.qidcounter.last_qidnumber,t[2]=[];for(let[e,s]of Object.entries(this.inodedata))!(this.inodes[e].mode&Nt)&&t[2].push([e,s]);return t[3]=this.total_size,t[4]=this.used_size,t=t.concat(this.mounts)},U.prototype.set_state=function(t){this.inodes=t[0].map(e=>{let s=new ze(0);return s.set_state(e),s}),this.qidcounter.last_qidnumber=t[1],this.inodedata={};for(let[e,s]of t[2])s.buffer.byteLength!==s.byteLength&&(s=s.slice()),this.inodedata[e]=s;this.total_size=t[3],this.used_size=t[4],this.mounts=t.slice(5)},U.prototype.AddEvent=function(t,e){var s=this.inodes[t];s.status===0||s.status===2?e():this.is_forwarder(s)?this.follow_fs(s).AddEvent(s.foreign_id,e):this.events.push({id:t,OnEvent:e})},U.prototype.HandleEvent=function(t){var e=this.inodes[t];this.is_forwarder(e)&&this.follow_fs(e).HandleEvent(e.foreign_id),e=[];for(var s=0;s<this.events.length;s++)this.events[s].id===t?this.events[s].OnEvent():e.push(this.events[s]);this.events=e},U.prototype.load_from_json=function(t,e){if(t.version!==3)throw"The filesystem JSON format has changed. Please update your fs2json (https://github.com/copy/fs2json) and recreate the filesystem JSON.";var s=t.fsroot;for(this.used_size=t.size,t=0;t<s.length;t++)this.LoadRecursive(s[t],0);e&&e()},U.prototype.LoadRecursive=function(t,e){var s=this.CreateInode();let r=t[0];s.size=t[1],s.mtime=t[2],s.ctime=s.mtime,s.atime=s.mtime,s.mode=t[3],s.uid=t[4],s.gid=t[5];var o=s.mode&61440;o===Nt?(this.PushInode(s,e,r),this.LoadDir(this.inodes.length-1,t[6])):o===_e?(s.status=2,s.sha256sum=t[6],this.PushInode(s,e,r)):o===40960?(s.symlink=t[6],this.PushInode(s,e,r)):o!==49152&&a(o)},U.prototype.LoadDir=function(t,e){for(var s=0;s<e.length;s++)this.LoadRecursive(e[s],t)},U.prototype.should_be_linked=function(t){return!this.is_forwarder(t)||t.foreign_id===0},U.prototype.link_under_dir=function(t,e,s){let r=this.inodes[e],o=this.inodes[t];this.is_forwarder(o),this.IsDirectory(t),this.should_be_linked(r),o.direntries.has(s),o.direntries.set(s,e),r.nlinks++,this.IsDirectory(e)&&(r.direntries.has(".."),r.direntries.has(".")||r.nlinks++,r.direntries.set(".",e),r.direntries.set("..",t),o.nlinks++)},U.prototype.unlink_from_dir=function(t,e){let s=this.Search(t,e),r=this.inodes[s],o=this.inodes[t];this.is_forwarder(o),this.IsDirectory(t),o.direntries.delete(e)&&(r.nlinks--,this.IsDirectory(s)&&(r.direntries.get(".."),r.direntries.delete(".."),o.nlinks--))},U.prototype.PushInode=function(t,e,s){e!==-1?(this.inodes.push(t),t.fid=this.inodes.length-1,this.link_under_dir(e,t.fid,s)):this.inodes.length===0?(this.inodes.push(t),t.direntries.set(".",0),t.direntries.set("..",0),t.nlinks=2):(V.Debug("Error in Filesystem: Pushed inode with name = "+s+" has no parent"),V.Abort())};function ze(t){this.direntries=new Map,this.minor=this.major=this.mtime=this.atime=this.ctime=this.fid=this.gid=this.uid=this.size=this.status=0,this.symlink="",this.mode=493,this.qid={type:0,version:0,path:t},this.caps=void 0,this.nlinks=0,this.sha256sum="",this.locks=[],this.foreign_id=this.mount_id=-1}ze.prototype.get_state=function(){let t=[];return t[0]=this.mode,t[1]=(this.mode&61440)===Nt?[...this.direntries]:(this.mode&61440)===_e?this.sha256sum:(this.mode&61440)===40960?this.symlink:(this.mode&61440)===49152?[this.minor,this.major]:null,t[2]=this.locks,t[3]=this.status,t[4]=this.size,t[5]=this.uid,t[6]=this.gid,t[7]=this.fid,t[8]=this.ctime,t[9]=this.atime,t[10]=this.mtime,t[11]=this.qid.version,t[12]=this.qid.path,t[13]=this.nlinks,t},ze.prototype.set_state=function(t){if(this.mode=t[0],(this.mode&61440)===Nt){this.direntries=new Map;for(let[e,s]of t[1])this.direntries.set(e,s)}else(this.mode&61440)===_e?this.sha256sum=t[1]:(this.mode&61440)===40960?this.symlink=t[1]:(this.mode&61440)===49152&&([this.minor,this.major]=t[1]);this.locks=[];for(let e of t[2]){let s=new Zt;s.set_state(e),this.locks.push(s)}this.status=t[3],this.size=t[4],this.uid=t[5],this.gid=t[6],this.fid=t[7],this.ctime=t[8],this.atime=t[9],this.mtime=t[10],this.qid.type=(this.mode&61440)>>8,this.qid.version=t[11],this.qid.path=t[12],this.nlinks=t[13]},U.prototype.divert=function(t,e){let s=this.Search(t,e),r=this.inodes[s],o=new ze(-1);this.IsDirectory(s),Object.assign(o,r);let l=this.inodes.length;if(this.inodes.push(o),o.fid=l,this.is_forwarder(r)&&this.mounts[r.mount_id].backtrack.set(r.foreign_id,l),this.should_be_linked(r)&&(this.unlink_from_dir(t,e),this.link_under_dir(t,l,e)),this.IsDirectory(s)&&!this.is_forwarder(r))for(let[_,f]of o.direntries)_!=="."&&_!==".."&&this.IsDirectory(f)&&this.inodes[f].direntries.set("..",l);return this.inodedata[l]=this.inodedata[s],delete this.inodedata[s],r.direntries=new Map,r.nlinks=0,l},U.prototype.copy_inode=function(t,e){Object.assign(e,t,{fid:e.fid,direntries:e.direntries,nlinks:e.nlinks})},U.prototype.CreateInode=function(){let t=Math.round(Date.now()/1e3),e=new ze(++this.qidcounter.last_qidnumber);return e.atime=e.ctime=e.mtime=t,e},U.prototype.CreateDirectory=function(t,e){var s=this.inodes[e];return 0<=e&&this.is_forwarder(s)?(e=s.foreign_id,t=this.follow_fs(s).CreateDirectory(t,e),this.create_forwarder(s.mount_id,t)):(s=this.CreateInode(),s.mode=511|Nt,0<=e&&(s.uid=this.inodes[e].uid,s.gid=this.inodes[e].gid,s.mode=this.inodes[e].mode&511|Nt),s.qid.type=Nt>>8,this.PushInode(s,e,t),this.NotifyListeners(this.inodes.length-1,"newdir"),this.inodes.length-1)},U.prototype.CreateFile=function(t,e){var s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,t=this.follow_fs(s).CreateFile(t,e),this.create_forwarder(s.mount_id,t)):(s=this.CreateInode(),s.uid=this.inodes[e].uid,s.gid=this.inodes[e].gid,s.qid.type=_e>>8,s.mode=this.inodes[e].mode&438|_e,this.PushInode(s,e,t),this.NotifyListeners(this.inodes.length-1,"newfile"),this.inodes.length-1)},U.prototype.CreateNode=function(t,e,s,r){var o=this.inodes[e];return this.is_forwarder(o)?(e=o.foreign_id,t=this.follow_fs(o).CreateNode(t,e,s,r),this.create_forwarder(o.mount_id,t)):(o=this.CreateInode(),o.major=s,o.minor=r,o.uid=this.inodes[e].uid,o.gid=this.inodes[e].gid,o.qid.type=192,o.mode=this.inodes[e].mode&438,this.PushInode(o,e,t),this.inodes.length-1)},U.prototype.CreateSymlink=function(t,e,s){var r=this.inodes[e];return this.is_forwarder(r)?(e=r.foreign_id,t=this.follow_fs(r).CreateSymlink(t,e,s),this.create_forwarder(r.mount_id,t)):(r=this.CreateInode(),r.uid=this.inodes[e].uid,r.gid=this.inodes[e].gid,r.qid.type=160,r.symlink=s,r.mode=40960,this.PushInode(r,e,t),this.inodes.length-1)},U.prototype.CreateTextFile=async function(t,e,s){var r=this.inodes[e];if(this.is_forwarder(r))return e=r.foreign_id,s=await this.follow_fs(r).CreateTextFile(t,e,s),this.create_forwarder(r.mount_id,s);for(r=this.CreateFile(t,e),e=this.inodes[r],t=new Uint8Array(s.length),e.size=s.length,e=0;e<s.length;e++)t[e]=s.charCodeAt(e);return await this.set_data(r,t),r},U.prototype.CreateBinaryFile=async function(t,e,s){var r=this.inodes[e];return this.is_forwarder(r)?(e=r.foreign_id,s=await this.follow_fs(r).CreateBinaryFile(t,e,s),this.create_forwarder(r.mount_id,s)):(r=this.CreateFile(t,e),t=this.inodes[r],e=new Uint8Array(s.length),e.set(s),await this.set_data(r,e),t.size=s.length,r)},U.prototype.OpenInode=function(t,e){var s=this.inodes[t];return this.is_forwarder(s)?this.follow_fs(s).OpenInode(s.foreign_id,e):((s.mode&61440)===Nt&&this.FillDirectory(t),!0)},U.prototype.CloseInode=async function(t){var e=this.inodes[t];if(this.is_forwarder(e))return await this.follow_fs(e).CloseInode(e.foreign_id);e.status===2&&this.storage.uncache(e.sha256sum),e.status===di&&(e.status=-1,await this.DeleteData(t))},U.prototype.Rename=async function(t,e,s,r){if(t===s&&e===r)return 0;var o=this.Search(t,e);if(o===-1)return-2;var l=this.GetFullPath(t)+"/"+e;if(this.Search(s,r)!==-1){var _=this.Unlink(s,r);if(0>_)return _}var f=this.inodes[o],g=this.inodes[t];if(_=this.inodes[s],this.is_forwarder(g)||this.is_forwarder(_))if(this.is_forwarder(g)&&g.mount_id===_.mount_id){if(t=await this.follow_fs(g).Rename(g.foreign_id,e,_.foreign_id,r),0>t)return t}else{if(this.is_a_root(o)||!this.IsDirectory(o)&&1<this.GetInode(o).nlinks)return-1;g=this.divert(t,e);let y=this.GetInode(o),b=await this.Read(g,0,y.size);if(this.is_forwarder(_)?(s=this.follow_fs(_),r=this.IsDirectory(g)?s.CreateDirectory(r,_.foreign_id):s.CreateFile(r,_.foreign_id),s=s.GetInode(r),this.copy_inode(y,s),this.set_forwarder(o,_.mount_id,r)):(this.delete_forwarder(f),this.copy_inode(y,f),this.link_under_dir(s,o,r)),await this.ChangeSize(o,y.size),b&&b.length&&await this.Write(o,0,b.length,b),this.IsDirectory(o)){for(let v of this.GetChildren(g))if(_=await this.Rename(g,v,o,v),0>_)return _}if(await this.DeleteData(g),t=this.Unlink(t,e),0>t)return t}else this.unlink_from_dir(t,e),this.link_under_dir(s,o,r),f.qid.version++;return this.NotifyListeners(o,"rename",{oldpath:l}),0},U.prototype.Write=async function(t,e,s,r){this.NotifyListeners(t,"write");var o=this.inodes[t];if(this.is_forwarder(o))t=o.foreign_id,await this.follow_fs(o).Write(t,e,s,r);else{var l=await this.get_buffer(t);!l||l.length<e+s?(await this.ChangeSize(t,Math.floor(3*(e+s)/2)),o.size=e+s,l=await this.get_buffer(t)):o.size<e+s&&(o.size=e+s),r&&l.set(r.subarray(0,s),e),await this.set_data(t,l)}},U.prototype.Read=async function(t,e,s){let r=this.inodes[t];return this.is_forwarder(r)?(t=r.foreign_id,await this.follow_fs(r).Read(t,e,s)):await this.get_data(t,e,s)},U.prototype.Search=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){let s=t.foreign_id;return e=this.follow_fs(t).Search(s,e),e===-1?-1:this.get_forwarder(t.mount_id,e)}return e=t.direntries.get(e),e===void 0?-1:e},U.prototype.CountUsedInodes=function(){let t=this.inodes.length;for(let{fs:e,backtrack:s}of this.mounts)t+=e.CountUsedInodes(),t-=s.size;return t},U.prototype.CountFreeInodes=function(){let t=1048576;for(let{fs:e}of this.mounts)t+=e.CountFreeInodes();return t},U.prototype.GetTotalSize=function(){let t=this.used_size;for(let{fs:e}of this.mounts)t+=e.GetTotalSize();return t},U.prototype.GetSpace=function(){let t=this.total_size;for(let{fs:e}of this.mounts)t+=e.GetSpace();return this.total_size},U.prototype.GetDirectoryName=function(t){let e=this.inodes[this.GetParent(t)];if(this.is_forwarder(e))return this.follow_fs(e).GetDirectoryName(this.inodes[t].foreign_id);if(!e)return"";for(let[s,r]of e.direntries)if(r===t)return s;return""},U.prototype.GetFullPath=function(t){this.IsDirectory(t);for(var e="";t!==0;)e="/"+this.GetDirectoryName(t)+e,t=this.GetParent(t);return e.substring(1)},U.prototype.Link=function(t,e,s){if(this.IsDirectory(e))return-1;let r=this.inodes[t],o=this.inodes[e];return this.is_forwarder(r)?this.is_forwarder(o)&&o.mount_id===r.mount_id?this.follow_fs(r).Link(r.foreign_id,o.foreign_id,s):-1:this.is_forwarder(o)?-1:(this.link_under_dir(t,e,s),0)},U.prototype.Unlink=function(t,e){if(e==="."||e==="..")return-1;let s=this.Search(t,e),r=this.inodes[s],o=this.inodes[t];return this.is_forwarder(o)?(this.is_forwarder(r),t=o.foreign_id,this.follow_fs(o).Unlink(t,e)):this.IsDirectory(s)&&!this.IsEmpty(s)?-39:(this.unlink_from_dir(t,e),r.nlinks===0&&(r.status=di,this.NotifyListeners(s,"delete")),0)},U.prototype.DeleteData=async function(t){let e=this.inodes[t];this.is_forwarder(e)?await this.follow_fs(e).DeleteData(e.foreign_id):(e.size=0,delete this.inodedata[t])},U.prototype.get_buffer=async function(t){let e=this.inodes[t];return this.inodedata[t]?this.inodedata[t]:e.status===2?await this.storage.read(e.sha256sum,0,e.size):null},U.prototype.get_data=async function(t,e,s){let r=this.inodes[t];return this.inodedata[t]?this.inodedata[t].subarray(e,e+s):r.status===2?await this.storage.read(r.sha256sum,e,s):null},U.prototype.set_data=async function(t,e){this.inodedata[t]=e,this.inodes[t].status===2&&(this.inodes[t].status=0,this.storage.uncache(this.inodes[t].sha256sum))},U.prototype.GetInode=function(t){return isNaN(t),t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).GetInode(t.foreign_id):t},U.prototype.ChangeSize=async function(t,e){var s=this.GetInode(t),r=await this.get_data(t,0,s.size);if(e!==s.size){var o=new Uint8Array(e);s.size=e,r&&o.set(r.subarray(0,Math.min(r.length,s.size)),0),await this.set_data(t,o)}},U.prototype.SearchPath=function(t){t=t.replace("//","/"),t=t.split("/"),0<t.length&&t[t.length-1].length===0&&t.pop(),0<t.length&&t[0].length===0&&t.shift();let e=t.length;var s=-1,r=0;let o=null;for(var l=0;l<e;l++)if(s=r,r=this.Search(s,t[l]),!o&&this.is_forwarder(this.inodes[s])&&(o="/"+t.slice(l).join("/")),r===-1)return l<e-1?{id:-1,parentid:-1,name:t[l],forward_path:o}:{id:-1,parentid:s,name:t[l],forward_path:o};return{id:r,parentid:s,name:t[l],forward_path:o}},U.prototype.GetRecursiveList=function(t,e){if(this.is_forwarder(this.inodes[t])){let s=this.follow_fs(this.inodes[t]),r=this.inodes[t].mount_id,o=e.length;for(s.GetRecursiveList(this.inodes[t].foreign_id,e),t=o;t<e.length;t++)e[t].parentid=this.get_forwarder(r,e[t].parentid)}else for(let[s,r]of this.inodes[t].direntries)s!=="."&&s!==".."&&(e.push({parentid:t,name:s}),this.IsDirectory(r)&&this.GetRecursiveList(r,e))},U.prototype.RecursiveDelete=function(t){var e=[];if(t=this.SearchPath(t),t.id!==-1)for(this.GetRecursiveList(t.id,e),t=e.length-1;0<=t;t--)this.Unlink(e[t].parentid,e[t].name)},U.prototype.DeleteNode=function(t){var e=this.SearchPath(t);e.id!==-1&&((this.inodes[e.id].mode&61440)===_e?this.Unlink(e.parentid,e.name):(this.inodes[e.id].mode&61440)===Nt&&(this.RecursiveDelete(t),this.Unlink(e.parentid,e.name)))},U.prototype.NotifyListeners=function(){},U.prototype.Check=function(){for(var t=1;t<this.inodes.length;t++)if(this.inodes[t].status!==-1){var e=this.GetInode(t);if(0>e.nlinks&&V.Debug("Error in filesystem: negative nlinks="+e.nlinks+" at id ="+t),this.IsDirectory(t)){e=this.GetInode(t),this.IsDirectory(t)&&0>this.GetParent(t)&&V.Debug("Error in filesystem: negative parent id "+t);for(let[s,r]of e.direntries){s.length===0&&V.Debug("Error in filesystem: inode with no name and id "+r);for(let o of s)32>o&&V.Debug("Error in filesystem: Unallowed char in filename")}}}},U.prototype.FillDirectory=function(t){var e=this.inodes[t];if(this.is_forwarder(e))this.follow_fs(e).FillDirectory(e.foreign_id);else{var s=0;for(let r of e.direntries.keys())s+=24+ss.UTF8Length(r);t=this.inodedata[t]=new Uint8Array(s),e.size=s,s=0;for(let[r,o]of e.direntries)e=this.GetInode(o),s+=W.Marshall(["Q","d","b","s"],[e.qid,s+13+8+1+2+ss.UTF8Length(r),e.mode>>12,r],t,s)}},U.prototype.RoundToDirentry=function(t,e){if(t=this.inodedata[t],e>=t.length)return t.length;let s=0;for(;;){let r=W.Unmarshall(["Q","d"],t,{offset:s})[1];if(r>e)break;s=r}return s},U.prototype.IsDirectory=function(t){return t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).IsDirectory(t.foreign_id):(t.mode&61440)===Nt},U.prototype.IsEmpty=function(t){if(t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).IsDirectory(t.foreign_id);for(let e of t.direntries.keys())if(e!=="."&&e!=="..")return!1;return!0},U.prototype.GetChildren=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).GetChildren(t.foreign_id);let e=[];for(let s of t.direntries.keys())s!=="."&&s!==".."&&e.push(s);return e},U.prototype.GetParent=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.should_be_linked(t))return t.direntries.get("..");let e=this.follow_fs(t).GetParent(t.foreign_id);return this.get_forwarder(t.mount_id,e)},U.prototype.PrepareCAPs=function(t){return t=this.GetInode(t),t.caps||(t.caps=new Uint8Array(20),t.caps[0]=0,t.caps[1]=0,t.caps[2]=0,t.caps[3]=2,t.caps[4]=255,t.caps[5]=255,t.caps[6]=255,t.caps[7]=255,t.caps[8]=255,t.caps[9]=255,t.caps[10]=255,t.caps[11]=255,t.caps[12]=63,t.caps[13]=0,t.caps[14]=0,t.caps[15]=0,t.caps[16]=63,t.caps[17]=0,t.caps[18]=0,t.caps[19]=0),t.caps.length};function is(t){this.fs=t,this.backtrack=new Map}is.prototype.get_state=function(){let t=[];return t[0]=this.fs,t[1]=[...this.backtrack],t},is.prototype.set_state=function(t){this.fs=t[0],this.backtrack=new Map(t[1])},U.prototype.set_forwarder=function(t,e,s){let r=this.inodes[t];this.is_forwarder(r)&&this.mounts[r.mount_id].backtrack.delete(r.foreign_id),r.status=5,r.mount_id=e,r.foreign_id=s,this.mounts[e].backtrack.set(s,t)},U.prototype.create_forwarder=function(t,e){let s=this.CreateInode(),r=this.inodes.length;return this.inodes.push(s),s.fid=r,this.set_forwarder(r,t,e),r},U.prototype.is_forwarder=function(t){return t.status===5},U.prototype.is_a_root=function(t){return this.GetInode(t).fid===0},U.prototype.get_forwarder=function(t,e){let s=this.mounts[t].backtrack.get(e);return s===void 0?this.create_forwarder(t,e):s},U.prototype.delete_forwarder=function(t){this.is_forwarder(t),t.status=-1,this.mounts[t.mount_id].backtrack.delete(t.foreign_id)},U.prototype.follow_fs=function(t){let e=this.mounts[t.mount_id];return this.is_forwarder(t),e.fs},U.prototype.Mount=function(t,e){if(t=this.SearchPath(t),t.parentid===-1)return-2;if(t.id!==-1)return-17;if(t.forward_path){var s=this.inodes[t.parentid];return e=this.follow_fs(s).Mount(t.forward_path,e),0>e?e:this.get_forwarder(s.mount_id,e)}return s=this.mounts.length,this.mounts.push(new is(e)),e=this.create_forwarder(s,0),this.link_under_dir(t.parentid,e,t.name),e};function Zt(){this.type=2,this.start=0,this.length=1/0,this.proc_id=-1,this.client_id=""}Zt.prototype.get_state=function(){let t=[];return t[0]=this.type,t[1]=this.start,t[2]=this.length===1/0?0:this.length,t[3]=this.proc_id,t[4]=this.client_id,t},Zt.prototype.set_state=function(t){this.type=t[0],this.start=t[1],this.length=t[2]===0?1/0:t[2],this.proc_id=t[3],this.client_id=t[4]},Zt.prototype.clone=function(){let t=new Zt;return t.set_state(this.get_state()),t},Zt.prototype.conflicts_with=function(t){return!(this.proc_id===t.proc_id&&this.client_id===t.client_id||this.type===2||t.type===2||this.type!==1&&t.type!==1||this.start+this.length<=t.start||t.start+t.length<=this.start)},Zt.prototype.is_alike=function(t){return t.proc_id===this.proc_id&&t.client_id===this.client_id&&t.type===this.type},Zt.prototype.may_merge_after=function(t){return this.is_alike(t)&&t.start+t.length===this.start},U.prototype.DescribeLock=function(t,e,s,r,o){let l=new Zt;return l.type=t,l.start=e,l.length=s,l.proc_id=r,l.client_id=o,l},U.prototype.GetLock=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){var s=t.foreign_id;return this.follow_fs(t).GetLock(s,e)}for(s of t.locks)if(e.conflicts_with(s))return s.clone();return null},U.prototype.Lock=function(t,e,s){let r=this.inodes[t];if(this.is_forwarder(r))return t=r.foreign_id,this.follow_fs(r).Lock(t,e,s);if(e=e.clone(),e.type!==2&&this.GetLock(t,e))return 1;for(s=0;s<r.locks.length;s++){if(t=r.locks[s],t.start+t.length<=e.start)continue;if(e.start+e.length<=t.start)break;if(t.proc_id!==e.proc_id||t.client_id!==e.client_id){t.conflicts_with(e);continue}var o=e.start+e.length;let l=e.start-t.start,_=t.start+t.length-o;if(0<l&&0<_&&t.type===e.type)return 0;if(0<l&&(t.length=l),0>=l&&0<_)t.start=o,t.length=_;else if(0<_){for(;s<r.locks.length&&r.locks[s].start<o;)s++;r.locks.splice(s,0,this.DescribeLock(t.type,o,_,t.proc_id,t.client_id))}else 0>=l&&(r.locks.splice(s,1),s--)}if(e.type!==2){for(s=e,t=!1,o=0;o<r.locks.length&&(s.may_merge_after(r.locks[o])&&(r.locks[o].length+=e.length,s=r.locks[o],t=!0),!(e.start<=r.locks[o].start));o++);for(t||(r.locks.splice(o,0,s),o++);o<r.locks.length;o++)if(r.locks[o].is_alike(s)){r.locks[o].may_merge_after(s)&&(s.length+=r.locks[o].length,r.locks.splice(o,1));break}}return 0},U.prototype.read_dir=function(t){if(t=this.SearchPath(t),t.id!==-1)return t=this.GetInode(t.id),Array.from(t.direntries.keys()).filter(e=>e!=="."&&e!=="..")},U.prototype.read_file=function(t){if(t=this.SearchPath(t),t.id===-1)return Promise.resolve(null);let e=this.GetInode(t.id);return this.Read(t.id,0,e.size)};var V={Debug:function(t){[].slice.apply(arguments).join(" ")},Abort:function(){}},W={Marshall:function(t,e,s,r){for(var o,l=0,_=0;_<t.length;_++)switch(o=e[_],t[_]){case"w":s[r++]=o&255,s[r++]=o>>8&255,s[r++]=o>>16&255,s[r++]=o>>24&255,l+=4;break;case"d":s[r++]=o&255,s[r++]=o>>8&255,s[r++]=o>>16&255,s[r++]=o>>24&255,s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0,l+=8;break;case"h":s[r++]=o&255,s[r++]=o>>8,l+=2;break;case"b":s[r++]=o,l+=1;break;case"s":var f=r,g=0;s[r++]=0,s[r++]=0,l+=2;for(var y of o)Eo(y.charCodeAt(0)).forEach(function(b){s[r++]=b,l+=1,g++});s[f+0]=g&255,s[f+1]=g>>8&255;break;case"Q":W.Marshall(["b","w","d"],[o.type,o.version,o.path],s,r),r+=13,l+=13;break;default:V.Debug("Marshall: Unknown type="+t[_])}return l},Unmarshall:function(t,e,s){let r=s.offset;for(var o=[],l=0;l<t.length;l++)switch(t[l]){case"w":var _=e[r++];_+=e[r++]<<8,_+=e[r++]<<16,_+=e[r++]<<24>>>0,o.push(_);break;case"d":_=e[r++],_+=e[r++]<<8,_+=e[r++]<<16,_+=e[r++]<<24>>>0,r+=4,o.push(_);break;case"h":_=e[r++],o.push(_+(e[r++]<<8));break;case"b":o.push(e[r++]);break;case"s":_=e[r++],_+=e[r++]<<8;for(var f="",g=new Ao,y=0;y<_;y++){var b=g.Put(e[r++]);b!==-1&&(f+=String.fromCharCode(b))}o.push(f);break;case"Q":s.offset=r,_=W.Unmarshall(["b","w","d"],e,s),r=s.offset,o.push({type:_[0],version:_[1],path:_[2]});break;default:V.Debug("Error in Unmarshall: Unknown type="+t[l])}return s.offset=r,o}},ss={};function Ao(){this.stream=new Uint8Array(5),this.ofs=0,this.Put=function(t){switch(this.stream[this.ofs]=t,this.ofs++,this.ofs){case 1:if(128>this.stream[0])return this.ofs=0,this.stream[0];break;case 2:if((this.stream[0]&224)===192&&(this.stream[1]&192)===128)return this.ofs=0,(this.stream[0]&31)<<6|this.stream[1]&63}return-1}}function Eo(t){if(128>t)return[t];if(2048>t)return[192|t>>6&31,128|t&63]}ss.UTF8Length=function(t){for(var e=0,s=0;s<t.length;s++){var r=t.charCodeAt(s);e+=128>r?1:2}return e}}).call(br)});var Er=pi((Hc,Ar)=>{"use strict";N();Ar.exports=kr;function kr(c,i,n){c instanceof RegExp&&(c=xr(c,n)),i instanceof RegExp&&(i=xr(i,n));var h=Sr(c,i,n);return h&&{start:h[0],end:h[1],pre:n.slice(0,h[0]),body:n.slice(h[0]+c.length,h[1]),post:n.slice(h[1]+i.length)}}function xr(c,i){var n=i.match(c);return n?n[0]:null}kr.range=Sr;function Sr(c,i,n){var h,d,u,p,m,a=n.indexOf(c),w=n.indexOf(i,a+1),k=a;if(a>=0&&w>0){if(c===i)return[a,w];for(h=[],u=n.length;k>=0&&!m;)k==a?(h.push(k),a=n.indexOf(c,k+1)):h.length==1?m=[h.pop(),w]:(d=h.pop(),d<u&&(u=d,p=w),w=n.indexOf(i,k+1)),k=a<w&&a>=0?a:w;h.length&&(m=[u,p])}return m}});var zr=pi((Vc,Mr)=>{N();var Cr=Er();Mr.exports=jo;var Tr="\0SLASH"+Math.random()+"\0",Rr="\0OPEN"+Math.random()+"\0",os="\0CLOSE"+Math.random()+"\0",Ir="\0COMMA"+Math.random()+"\0",Dr="\0PERIOD"+Math.random()+"\0";function ns(c){return parseInt(c,10)==c?parseInt(c,10):c.charCodeAt(0)}function Fo(c){return c.split("\\\\").join(Tr).split("\\{").join(Rr).split("\\}").join(os).split("\\,").join(Ir).split("\\.").join(Dr)}function Bo(c){return c.split(Tr).join("\\").split(Rr).join("{").split(os).join("}").split(Ir).join(",").split(Dr).join(".")}function Or(c){if(!c)return[""];var i=[],n=Cr("{","}",c);if(!n)return c.split(",");var h=n.pre,d=n.body,u=n.post,p=h.split(",");p[p.length-1]+="{"+d+"}";var m=Or(u);return u.length&&(p[p.length-1]+=m.shift(),p.push.apply(p,m)),i.push.apply(i,p),i}function jo(c){return c?(c.substr(0,2)==="{}"&&(c="\\{\\}"+c.substr(2)),Pe(Fo(c),!0).map(Bo)):[]}function Wo(c){return"{"+c+"}"}function Go(c){return/^-?0\d/.test(c)}function $o(c,i){return c<=i}function Ho(c,i){return c>=i}function Pe(c,i){var n=[],h=Cr("{","}",c);if(!h)return[c];var d=h.pre,u=h.post.length?Pe(h.post,!1):[""];if(/\$$/.test(h.pre))for(var p=0;p<u.length;p++){var m=d+"{"+h.body+"}"+u[p];n.push(m)}else{var a=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(h.body),w=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(h.body),k=a||w,S=h.body.indexOf(",")>=0;if(!k&&!S)return h.post.match(/,.*\}/)?(c=h.pre+"{"+h.body+os+h.post,Pe(c)):[c];var E;if(k)E=h.body.split(/\.\./);else if(E=Or(h.body),E.length===1&&(E=Pe(E[0],!1).map(Wo),E.length===1))return u.map(function(it){return h.pre+E[0]+it});var A;if(k){var T=ns(E[0]),R=ns(E[1]),L=Math.max(E[0].length,E[1].length),z=E.length==3?Math.abs(ns(E[2])):1,G=$o,Y=R<T;Y&&(z*=-1,G=Ho);var H=E.some(Go);A=[];for(var M=T;G(M,R);M+=z){var X;if(w)X=String.fromCharCode(M),X==="\\"&&(X="");else if(X=String(M),H){var Q=L-X.length;if(Q>0){var nt=new Array(Q+1).join("0");M<0?X="-"+nt+X.slice(1):X=nt+X}}A.push(X)}}else{A=[];for(var lt=0;lt<E.length;lt++)A.push.apply(A,Pe(E[lt],!1))}for(var lt=0;lt<A.length;lt++)for(var p=0;p<u.length;p++){var m=d+A[lt]+u[p];(!i||k||m)&&n.push(m)}}return n}});var Xs=pi(si=>{N();(function(c,i){"use strict";typeof si=="object"?(c.slip=si,i(si)):typeof define=="function"&&define.amd?define(["exports"],function(n){return c.slip=n,c.slip,i(n)}):(c.slip={},i(c.slip))})(si,function(c){"use strict";var i=c;i.END=192,i.ESC=219,i.ESC_END=220,i.ESC_ESC=221,i.byteArray=function(h,d,u){return h instanceof ArrayBuffer?new Uint8Array(h,d,u):h},i.expandByteArray=function(h){var d=new Uint8Array(h.length*2);return d.set(h),d},i.sliceByteArray=function(h,d,u){var p=h.buffer.slice?h.buffer.slice(d,u):h.subarray(d,u);return new Uint8Array(p)},i.encode=function(h,d){d=d||{},d.bufferPadding=d.bufferPadding||4,h=i.byteArray(h,d.offset,d.byteLength);var u=h.length+d.bufferPadding+3&-4,p=new Uint8Array(u),m=1;p[0]=i.END;for(var a=0;a<h.length;a++){m>p.length-3&&(p=i.expandByteArray(p));var w=h[a];w===i.END?(p[m++]=i.ESC,w=i.ESC_END):w===i.ESC&&(p[m++]=i.ESC,w=i.ESC_ESC),p[m++]=w}return p[m]=i.END,i.sliceByteArray(p,0,m+1)},i.Decoder=function(h){h=typeof h!="function"?h||{}:{onMessage:h},this.maxMessageSize=h.maxMessageSize||10485760,this.bufferSize=h.bufferSize||1024,this.msgBuffer=new Uint8Array(this.bufferSize),this.msgBufferIdx=0,this.onMessage=h.onMessage,this.onError=h.onError,this.escape=!1};var n=i.Decoder.prototype;return n.decode=function(h){h=i.byteArray(h);for(var d,u=0;u<h.length;u++){var p=h[u];if(this.escape)p===i.ESC_ESC?p=i.ESC:p===i.ESC_END&&(p=i.END);else{if(p===i.ESC){this.escape=!0;continue}if(p===i.END){d=this.handleEnd();continue}}var m=this.addByte(p);m||this.handleMessageMaxError()}return d},n.handleMessageMaxError=function(){this.onError&&this.onError(this.msgBuffer.subarray(0),"The message is too large; the maximum message size is "+this.maxMessageSize/1024+"KB. Use a larger maxMessageSize if necessary."),this.msgBufferIdx=0,this.escape=!1},n.addByte=function(h){return this.msgBufferIdx>this.msgBuffer.length-1&&(this.msgBuffer=i.expandByteArray(this.msgBuffer)),this.msgBuffer[this.msgBufferIdx++]=h,this.escape=!1,this.msgBuffer.length<this.maxMessageSize},n.handleEnd=function(){if(this.msgBufferIdx!==0){var h=i.sliceByteArray(this.msgBuffer,0,this.msgBufferIdx);return this.onMessage&&this.onMessage(h),this.msgBufferIdx=0,h}},i})});N();var Lc=fi(vr(),1);N();N();N();var jr=fi(zr(),1);N();var Le=c=>{if(typeof c!="string")throw new TypeError("invalid pattern");if(c.length>65536)throw new TypeError("pattern is too long")};N();N();var Ko={"[:alnum:]":["\\p{L}\\p{Nl}\\p{Nd}",!0],"[:alpha:]":["\\p{L}\\p{Nl}",!0],"[:ascii:]":["\\x00-\\x7f",!1],"[:blank:]":["\\p{Zs}\\t",!0],"[:cntrl:]":["\\p{Cc}",!0],"[:digit:]":["\\p{Nd}",!0],"[:graph:]":["\\p{Z}\\p{C}",!0,!0],"[:lower:]":["\\p{Ll}",!0],"[:print:]":["\\p{C}",!0],"[:punct:]":["\\p{P}",!0],"[:space:]":["\\p{Z}\\t\\r\\n\\v\\f",!0],"[:upper:]":["\\p{Lu}",!0],"[:word:]":["\\p{L}\\p{Nl}\\p{Nd}\\p{Pc}",!0],"[:xdigit:]":["A-Fa-f0-9",!1]},Ne=c=>c.replace(/[[\]\\-]/g,"\\$&"),Vo=c=>c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),Pr=c=>c.join(""),Lr=(c,i)=>{let n=i;if(c.charAt(n)!=="[")throw new Error("not in a brace expression");let h=[],d=[],u=n+1,p=!1,m=!1,a=!1,w=!1,k=n,S="";t:for(;u<c.length;){let R=c.charAt(u);if((R==="!"||R==="^")&&u===n+1){w=!0,u++;continue}if(R==="]"&&p&&!a){k=u+1;break}if(p=!0,R==="\\"&&!a){a=!0,u++;continue}if(R==="["&&!a){for(let[L,[z,G,Y]]of Object.entries(Ko))if(c.startsWith(L,u)){if(S)return["$.",!1,c.length-n,!0];u+=L.length,Y?d.push(z):h.push(z),m=m||G;continue t}}if(a=!1,S){R>S?h.push(Ne(S)+"-"+Ne(R)):R===S&&h.push(Ne(R)),S="",u++;continue}if(c.startsWith("-]",u+1)){h.push(Ne(R+"-")),u+=2;continue}if(c.startsWith("-",u+1)){S=R,u+=2;continue}h.push(Ne(R)),u++}if(k<u)return["",!1,0,!1];if(!h.length&&!d.length)return["$.",!1,c.length-n,!0];if(d.length===0&&h.length===1&&/^\\?.$/.test(h[0])&&!w){let R=h[0].length===2?h[0].slice(-1):h[0];return[Vo(R),!1,k-n,!1]}let E="["+(w?"^":"")+Pr(h)+"]",A="["+(w?"":"^")+Pr(d)+"]";return[h.length&&d.length?"("+E+"|"+A+")":h.length?E:A,m,k-n,!0]};N();var qt=(c,{windowsPathsNoEscape:i=!1}={})=>i?c.replace(/\[([^\/\\])\]/g,"$1"):c.replace(/((?!\\).|^)\[([^\/\\])\]/g,"$1$2").replace(/\\([^\/])/g,"$1");var Yo=new Set(["!","?","+","*","@"]),Nr=c=>Yo.has(c),Xo="(?!(?:^|/)\\.\\.?(?:$|/))",mi="(?!\\.)",Qo=new Set(["[","."]),Jo=new Set(["..","."]),Zo=new Set("().*{}+?[]^$\\!"),th=c=>c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),hs="[^/]",Ur=hs+"*?",qr=hs+"+?",ye=class c{type;#t;#e;#n=!1;#s=[];#o;#b;#c;#d=!1;#h;#a;#r=!1;constructor(i,n,h={}){this.type=i,i&&(this.#e=!0),this.#o=n,this.#t=this.#o?this.#o.#t:this,this.#h=this.#t===this?h:this.#t.#h,this.#c=this.#t===this?[]:this.#t.#c,i==="!"&&!this.#t.#d&&this.#c.push(this),this.#b=this.#o?this.#o.#s.length:0}get hasMagic(){if(this.#e!==void 0)return this.#e;for(let i of this.#s)if(typeof i!="string"&&(i.type||i.hasMagic))return this.#e=!0;return this.#e}toString(){return this.#a!==void 0?this.#a:this.type?this.#a=this.type+"("+this.#s.map(i=>String(i)).join("|")+")":this.#a=this.#s.map(i=>String(i)).join("")}#m(){if(this!==this.#t)throw new Error("should only call on root");if(this.#d)return this;this.toString(),this.#d=!0;let i;for(;i=this.#c.pop();){if(i.type!=="!")continue;let n=i,h=n.#o;for(;h;){for(let d=n.#b+1;!h.type&&d<h.#s.length;d++)for(let u of i.#s){if(typeof u=="string")throw new Error("string part in extglob AST??");u.copyIn(h.#s[d])}n=h,h=n.#o}}return this}push(...i){for(let n of i)if(n!==""){if(typeof n!="string"&&!(n instanceof c&&n.#o===this))throw new Error("invalid part: "+n);this.#s.push(n)}}toJSON(){let i=this.type===null?this.#s.slice().map(n=>typeof n=="string"?n:n.toJSON()):[this.type,...this.#s.map(n=>n.toJSON())];return this.isStart()&&!this.type&&i.unshift([]),this.isEnd()&&(this===this.#t||this.#t.#d&&this.#o?.type==="!")&&i.push({}),i}isStart(){if(this.#t===this)return!0;if(!this.#o?.isStart())return!1;if(this.#b===0)return!0;let i=this.#o;for(let n=0;n<this.#b;n++){let h=i.#s[n];if(!(h instanceof c&&h.type==="!"))return!1}return!0}isEnd(){if(this.#t===this||this.#o?.type==="!")return!0;if(!this.#o?.isEnd())return!1;if(!this.type)return this.#o?.isEnd();let i=this.#o?this.#o.#s.length:0;return this.#b===i-1}copyIn(i){typeof i=="string"?this.push(i):this.push(i.clone(this))}clone(i){let n=new c(this.type,i);for(let h of this.#s)n.copyIn(h);return n}static#g(i,n,h,d){let u=!1,p=!1,m=-1,a=!1;if(n.type===null){let A=h,T="";for(;A<i.length;){let R=i.charAt(A++);if(u||R==="\\"){u=!u,T+=R;continue}if(p){A===m+1?(R==="^"||R==="!")&&(a=!0):R==="]"&&!(A===m+2&&a)&&(p=!1),T+=R;continue}else if(R==="["){p=!0,m=A,a=!1,T+=R;continue}if(!d.noext&&Nr(R)&&i.charAt(A)==="("){n.push(T),T="";let L=new c(R,n);A=c.#g(i,L,A,d),n.push(L);continue}T+=R}return n.push(T),A}let w=h+1,k=new c(null,n),S=[],E="";for(;w<i.length;){let A=i.charAt(w++);if(u||A==="\\"){u=!u,E+=A;continue}if(p){w===m+1?(A==="^"||A==="!")&&(a=!0):A==="]"&&!(w===m+2&&a)&&(p=!1),E+=A;continue}else if(A==="["){p=!0,m=w,a=!1,E+=A;continue}if(Nr(A)&&i.charAt(w)==="("){k.push(E),E="";let T=new c(A,k);k.push(T),w=c.#g(i,T,w,d);continue}if(A==="|"){k.push(E),E="",S.push(k),k=new c(null,n);continue}if(A===")")return E===""&&n.#s.length===0&&(n.#r=!0),k.push(E),E="",n.push(...S,k),w;E+=A}return n.type=null,n.#e=void 0,n.#s=[i.substring(h-1)],w}static fromGlob(i,n={}){let h=new c(null,void 0,n);return c.#g(i,h,0,n),h}toMMPattern(){if(this!==this.#t)return this.#t.toMMPattern();let i=this.toString(),[n,h,d,u]=this.toRegExpSource();if(!(d||this.#e||this.#h.nocase&&!this.#h.nocaseMagicOnly&&i.toUpperCase()!==i.toLowerCase()))return h;let m=(this.#h.nocase?"i":"")+(u?"u":"");return Object.assign(new RegExp(`^${n}$`,m),{_src:n,_glob:i})}get options(){return this.#h}toRegExpSource(i){let n=i??!!this.#h.dot;if(this.#t===this&&this.#m(),!this.type){let a=this.isStart()&&this.isEnd(),w=this.#s.map(A=>{let[T,R,L,z]=typeof A=="string"?c.#u(A,this.#e,a):A.toRegExpSource(i);return this.#e=this.#e||L,this.#n=this.#n||z,T}).join(""),k="";if(this.isStart()&&typeof this.#s[0]=="string"&&!(this.#s.length===1&&Jo.has(this.#s[0]))){let T=Qo,R=n&&T.has(w.charAt(0))||w.startsWith("\\.")&&T.has(w.charAt(2))||w.startsWith("\\.\\.")&&T.has(w.charAt(4)),L=!n&&!i&&T.has(w.charAt(0));k=R?Xo:L?mi:""}let S="";return this.isEnd()&&this.#t.#d&&this.#o?.type==="!"&&(S="(?:$|\\/)"),[k+w+S,qt(w),this.#e=!!this.#e,this.#n]}let h=this.type==="*"||this.type==="+",d=this.type==="!"?"(?:(?!(?:":"(?:",u=this.#l(n);if(this.isStart()&&this.isEnd()&&!u&&this.type!=="!"){let a=this.toString();return this.#s=[a],this.type=null,this.#e=void 0,[a,qt(this.toString()),!1,!1]}let p=!h||i||n||!mi?"":this.#l(!0);p===u&&(p=""),p&&(u=`(?:${u})(?:${p})*?`);let m="";if(this.type==="!"&&this.#r)m=(this.isStart()&&!n?mi:"")+qr;else{let a=this.type==="!"?"))"+(this.isStart()&&!n&&!i?mi:"")+Ur+")":this.type==="@"?")":this.type==="?"?")?":this.type==="+"&&p?")":this.type==="*"&&p?")?":`)${this.type}`;m=d+u+a}return[m,qt(u),this.#e=!!this.#e,this.#n]}#l(i){return this.#s.map(n=>{if(typeof n=="string")throw new Error("string type in extglob ast??");let[h,d,u,p]=n.toRegExpSource(i);return this.#n=this.#n||p,h}).filter(n=>!(this.isStart()&&this.isEnd())||!!n).join("|")}static#u(i,n,h=!1){let d=!1,u="",p=!1;for(let m=0;m<i.length;m++){let a=i.charAt(m);if(d){d=!1,u+=(Zo.has(a)?"\\":"")+a;continue}if(a==="\\"){m===i.length-1?u+="\\\\":d=!0;continue}if(a==="["){let[w,k,S,E]=Lr(i,m);if(S){u+=w,p=p||k,m+=S-1,n=n||E;continue}}if(a==="*"){h&&i==="*"?u+=qr:u+=Ur,n=!0;continue}if(a==="?"){u+=hs,n=!0;continue}u+=th(a)}return[u,qt(i),!!n,p]}};N();var we=(c,{windowsPathsNoEscape:i=!1}={})=>i?c.replace(/[?*()[\]]/g,"[$&]"):c.replace(/[?*()[\]\\]/g,"\\$&");var vt=(c,i,n={})=>(Le(i),!n.nocomment&&i.charAt(0)==="#"?!1:new Tt(i,n).match(c)),eh=/^\*+([^+@!?\*\[\(]*)$/,ih=c=>i=>!i.startsWith(".")&&i.endsWith(c),sh=c=>i=>i.endsWith(c),rh=c=>(c=c.toLowerCase(),i=>!i.startsWith(".")&&i.toLowerCase().endsWith(c)),nh=c=>(c=c.toLowerCase(),i=>i.toLowerCase().endsWith(c)),oh=/^\*+\.\*+$/,hh=c=>!c.startsWith(".")&&c.includes("."),ah=c=>c!=="."&&c!==".."&&c.includes("."),ch=/^\.\*+$/,_h=c=>c!=="."&&c!==".."&&c.startsWith("."),dh=/^\*+$/,uh=c=>c.length!==0&&!c.startsWith("."),lh=c=>c.length!==0&&c!=="."&&c!=="..",ph=/^\?+([^+@!?\*\[\(]*)?$/,fh=([c,i=""])=>{let n=Wr([c]);return i?(i=i.toLowerCase(),h=>n(h)&&h.toLowerCase().endsWith(i)):n},mh=([c,i=""])=>{let n=Gr([c]);return i?(i=i.toLowerCase(),h=>n(h)&&h.toLowerCase().endsWith(i)):n},gh=([c,i=""])=>{let n=Gr([c]);return i?h=>n(h)&&h.endsWith(i):n},yh=([c,i=""])=>{let n=Wr([c]);return i?h=>n(h)&&h.endsWith(i):n},Wr=([c])=>{let i=c.length;return n=>n.length===i&&!n.startsWith(".")},Gr=([c])=>{let i=c.length;return n=>n.length===i&&n!=="."&&n!==".."},$r=typeof process=="object"&&process?typeof process.env=="object"&&process.env&&process.env.__MINIMATCH_TESTING_PLATFORM__||process.platform:"posix",Fr={win32:{sep:"\\"},posix:{sep:"/"}},wh=$r==="win32"?Fr.win32.sep:Fr.posix.sep;vt.sep=wh;var pt=Symbol("globstar **");vt.GLOBSTAR=pt;var bh="[^/]",vh=bh+"*?",xh="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",kh="(?:(?!(?:\\/|^)\\.).)*?",Sh=(c,i={})=>n=>vt(n,c,i);vt.filter=Sh;var Dt=(c,i={})=>Object.assign({},c,i),Ah=c=>{if(!c||typeof c!="object"||!Object.keys(c).length)return vt;let i=vt;return Object.assign((h,d,u={})=>i(h,d,Dt(c,u)),{Minimatch:class extends i.Minimatch{constructor(d,u={}){super(d,Dt(c,u))}static defaults(d){return i.defaults(Dt(c,d)).Minimatch}},AST:class extends i.AST{constructor(d,u,p={}){super(d,u,Dt(c,p))}static fromGlob(d,u={}){return i.AST.fromGlob(d,Dt(c,u))}},unescape:(h,d={})=>i.unescape(h,Dt(c,d)),escape:(h,d={})=>i.escape(h,Dt(c,d)),filter:(h,d={})=>i.filter(h,Dt(c,d)),defaults:h=>i.defaults(Dt(c,h)),makeRe:(h,d={})=>i.makeRe(h,Dt(c,d)),braceExpand:(h,d={})=>i.braceExpand(h,Dt(c,d)),match:(h,d,u={})=>i.match(h,d,Dt(c,u)),sep:i.sep,GLOBSTAR:pt})};vt.defaults=Ah;var Hr=(c,i={})=>(Le(c),i.nobrace||!/\{(?:(?!\{).)*\}/.test(c)?[c]:(0,jr.default)(c));vt.braceExpand=Hr;var Eh=(c,i={})=>new Tt(c,i).makeRe();vt.makeRe=Eh;var Ch=(c,i,n={})=>{let h=new Tt(i,n);return c=c.filter(d=>h.match(d)),h.options.nonull&&!c.length&&c.push(i),c};vt.match=Ch;var Br=/[?*]|[+@!]\(.*?\)|\[|\]/,Th=c=>c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),Tt=class{options;set;pattern;windowsPathsNoEscape;nonegate;negate;comment;empty;preserveMultipleSlashes;partial;globSet;globParts;nocase;isWindows;platform;windowsNoMagicRoot;regexp;constructor(i,n={}){Le(i),n=n||{},this.options=n,this.pattern=i,this.platform=n.platform||$r,this.isWindows=this.platform==="win32",this.windowsPathsNoEscape=!!n.windowsPathsNoEscape||n.allowWindowsEscape===!1,this.windowsPathsNoEscape&&(this.pattern=this.pattern.replace(/\\/g,"/")),this.preserveMultipleSlashes=!!n.preserveMultipleSlashes,this.regexp=null,this.negate=!1,this.nonegate=!!n.nonegate,this.comment=!1,this.empty=!1,this.partial=!!n.partial,this.nocase=!!this.options.nocase,this.windowsNoMagicRoot=n.windowsNoMagicRoot!==void 0?n.windowsNoMagicRoot:!!(this.isWindows&&this.nocase),this.globSet=[],this.globParts=[],this.set=[],this.make()}hasMagic(){if(this.options.magicalBraces&&this.set.length>1)return!0;for(let i of this.set)for(let n of i)if(typeof n!="string")return!0;return!1}debug(...i){}make(){let i=this.pattern,n=this.options;if(!n.nocomment&&i.charAt(0)==="#"){this.comment=!0;return}if(!i){this.empty=!0;return}this.parseNegate(),this.globSet=[...new Set(this.braceExpand())],n.debug&&(this.debug=(...u)=>console.error(...u)),this.debug(this.pattern,this.globSet);let h=this.globSet.map(u=>this.slashSplit(u));this.globParts=this.preprocess(h),this.debug(this.pattern,this.globParts);let d=this.globParts.map((u,p,m)=>{if(this.isWindows&&this.windowsNoMagicRoot){let a=u[0]===""&&u[1]===""&&(u[2]==="?"||!Br.test(u[2]))&&!Br.test(u[3]),w=/^[a-z]:/i.test(u[0]);if(a)return[...u.slice(0,4),...u.slice(4).map(k=>this.parse(k))];if(w)return[u[0],...u.slice(1).map(k=>this.parse(k))]}return u.map(a=>this.parse(a))});if(this.debug(this.pattern,d),this.set=d.filter(u=>u.indexOf(!1)===-1),this.isWindows)for(let u=0;u<this.set.length;u++){let p=this.set[u];p[0]===""&&p[1]===""&&this.globParts[u][2]==="?"&&typeof p[3]=="string"&&/^[a-z]:$/i.test(p[3])&&(p[2]="?")}this.debug(this.pattern,this.set)}preprocess(i){if(this.options.noglobstar)for(let h=0;h<i.length;h++)for(let d=0;d<i[h].length;d++)i[h][d]==="**"&&(i[h][d]="*");let{optimizationLevel:n=1}=this.options;return n>=2?(i=this.firstPhasePreProcess(i),i=this.secondPhasePreProcess(i)):n>=1?i=this.levelOneOptimize(i):i=this.adjascentGlobstarOptimize(i),i}adjascentGlobstarOptimize(i){return i.map(n=>{let h=-1;for(;(h=n.indexOf("**",h+1))!==-1;){let d=h;for(;n[d+1]==="**";)d++;d!==h&&n.splice(h,d-h)}return n})}levelOneOptimize(i){return i.map(n=>(n=n.reduce((h,d)=>{let u=h[h.length-1];return d==="**"&&u==="**"?h:d===".."&&u&&u!==".."&&u!=="."&&u!=="**"?(h.pop(),h):(h.push(d),h)},[]),n.length===0?[""]:n))}levelTwoFileOptimize(i){Array.isArray(i)||(i=this.slashSplit(i));let n=!1;do{if(n=!1,!this.preserveMultipleSlashes){for(let d=1;d<i.length-1;d++){let u=i[d];d===1&&u===""&&i[0]===""||(u==="."||u==="")&&(n=!0,i.splice(d,1),d--)}i[0]==="."&&i.length===2&&(i[1]==="."||i[1]==="")&&(n=!0,i.pop())}let h=0;for(;(h=i.indexOf("..",h+1))!==-1;){let d=i[h-1];d&&d!=="."&&d!==".."&&d!=="**"&&(n=!0,i.splice(h-1,2),h-=2)}}while(n);return i.length===0?[""]:i}firstPhasePreProcess(i){let n=!1;do{n=!1;for(let h of i){let d=-1;for(;(d=h.indexOf("**",d+1))!==-1;){let p=d;for(;h[p+1]==="**";)p++;p>d&&h.splice(d+1,p-d);let m=h[d+1],a=h[d+2],w=h[d+3];if(m!==".."||!a||a==="."||a===".."||!w||w==="."||w==="..")continue;n=!0,h.splice(d,1);let k=h.slice(0);k[d]="**",i.push(k),d--}if(!this.preserveMultipleSlashes){for(let p=1;p<h.length-1;p++){let m=h[p];p===1&&m===""&&h[0]===""||(m==="."||m==="")&&(n=!0,h.splice(p,1),p--)}h[0]==="."&&h.length===2&&(h[1]==="."||h[1]==="")&&(n=!0,h.pop())}let u=0;for(;(u=h.indexOf("..",u+1))!==-1;){let p=h[u-1];if(p&&p!=="."&&p!==".."&&p!=="**"){n=!0;let a=u===1&&h[u+1]==="**"?["."]:[];h.splice(u-1,2,...a),h.length===0&&h.push(""),u-=2}}}}while(n);return i}secondPhasePreProcess(i){for(let n=0;n<i.length-1;n++)for(let h=n+1;h<i.length;h++){let d=this.partsMatch(i[n],i[h],!this.preserveMultipleSlashes);if(d){i[n]=[],i[h]=d;break}}return i.filter(n=>n.length)}partsMatch(i,n,h=!1){let d=0,u=0,p=[],m="";for(;d<i.length&&u<n.length;)if(i[d]===n[u])p.push(m==="b"?n[u]:i[d]),d++,u++;else if(h&&i[d]==="**"&&n[u]===i[d+1])p.push(i[d]),d++;else if(h&&n[u]==="**"&&i[d]===n[u+1])p.push(n[u]),u++;else if(i[d]==="*"&&n[u]&&(this.options.dot||!n[u].startsWith("."))&&n[u]!=="**"){if(m==="b")return!1;m="a",p.push(i[d]),d++,u++}else if(n[u]==="*"&&i[d]&&(this.options.dot||!i[d].startsWith("."))&&i[d]!=="**"){if(m==="a")return!1;m="b",p.push(n[u]),d++,u++}else return!1;return i.length===n.length&&p}parseNegate(){if(this.nonegate)return;let i=this.pattern,n=!1,h=0;for(let d=0;d<i.length&&i.charAt(d)==="!";d++)n=!n,h++;h&&(this.pattern=i.slice(h)),this.negate=n}matchOne(i,n,h=!1){let d=this.options;if(this.isWindows){let R=typeof i[0]=="string"&&/^[a-z]:$/i.test(i[0]),L=!R&&i[0]===""&&i[1]===""&&i[2]==="?"&&/^[a-z]:$/i.test(i[3]),z=typeof n[0]=="string"&&/^[a-z]:$/i.test(n[0]),G=!z&&n[0]===""&&n[1]===""&&n[2]==="?"&&typeof n[3]=="string"&&/^[a-z]:$/i.test(n[3]),Y=L?3:R?0:void 0,H=G?3:z?0:void 0;if(typeof Y=="number"&&typeof H=="number"){let[M,X]=[i[Y],n[H]];M.toLowerCase()===X.toLowerCase()&&(n[H]=M,H>Y?n=n.slice(H):Y>H&&(i=i.slice(Y)))}}let{optimizationLevel:u=1}=this.options;u>=2&&(i=this.levelTwoFileOptimize(i)),this.debug("matchOne",this,{file:i,pattern:n}),this.debug("matchOne",i.length,n.length);for(var p=0,m=0,a=i.length,w=n.length;p<a&&m<w;p++,m++){this.debug("matchOne loop");var k=n[m],S=i[p];if(this.debug(n,k,S),k===!1)return!1;if(k===pt){this.debug("GLOBSTAR",[n,k,S]);var E=p,A=m+1;if(A===w){for(this.debug("** at the end");p<a;p++)if(i[p]==="."||i[p]===".."||!d.dot&&i[p].charAt(0)===".")return!1;return!0}for(;E<a;){var T=i[E];if(this.debug(`
globstar while`,i,E,n,A,T),this.matchOne(i.slice(E),n.slice(A),h))return this.debug("globstar found match!",E,a,T),!0;if(T==="."||T===".."||!d.dot&&T.charAt(0)==="."){this.debug("dot detected!",i,E,n,A);break}this.debug("globstar swallow a segment, and continue"),E++}return!!(h&&(this.debug(`
>>> no match, partial?`,i,E,n,A),E===a))}let R;if(typeof k=="string"?(R=S===k,this.debug("string match",k,S,R)):(R=k.test(S),this.debug("pattern match",k,S,R)),!R)return!1}if(p===a&&m===w)return!0;if(p===a)return h;if(m===w)return p===a-1&&i[p]==="";throw new Error("wtf?")}braceExpand(){return Hr(this.pattern,this.options)}parse(i){Le(i);let n=this.options;if(i==="**")return pt;if(i==="")return"";let h,d=null;(h=i.match(dh))?d=n.dot?lh:uh:(h=i.match(eh))?d=(n.nocase?n.dot?nh:rh:n.dot?sh:ih)(h[1]):(h=i.match(ph))?d=(n.nocase?n.dot?mh:fh:n.dot?gh:yh)(h):(h=i.match(oh))?d=n.dot?ah:hh:(h=i.match(ch))&&(d=_h);let u=ye.fromGlob(i,this.options).toMMPattern();return d&&typeof u=="object"&&Reflect.defineProperty(u,"test",{value:d}),u}makeRe(){if(this.regexp||this.regexp===!1)return this.regexp;let i=this.set;if(!i.length)return this.regexp=!1,this.regexp;let n=this.options,h=n.noglobstar?vh:n.dot?xh:kh,d=new Set(n.nocase?["i"]:[]),u=i.map(a=>{let w=a.map(k=>{if(k instanceof RegExp)for(let S of k.flags.split(""))d.add(S);return typeof k=="string"?Th(k):k===pt?pt:k._src});return w.forEach((k,S)=>{let E=w[S+1],A=w[S-1];k!==pt||A===pt||(A===void 0?E!==void 0&&E!==pt?w[S+1]="(?:\\/|"+h+"\\/)?"+E:w[S]=h:E===void 0?w[S-1]=A+"(?:\\/|"+h+")?":E!==pt&&(w[S-1]=A+"(?:\\/|\\/"+h+"\\/)"+E,w[S+1]=pt))}),w.filter(k=>k!==pt).join("/")}).join("|"),[p,m]=i.length>1?["(?:",")"]:["",""];u="^"+p+u+m+"$",this.negate&&(u="^(?!"+u+").+$");try{this.regexp=new RegExp(u,[...d].join(""))}catch{this.regexp=!1}return this.regexp}slashSplit(i){return this.preserveMultipleSlashes?i.split("/"):this.isWindows&&/^\/\/[^\/]+/.test(i)?["",...i.split(/\/+/)]:i.split(/\/+/)}match(i,n=this.partial){if(this.debug("match",i,this.pattern),this.comment)return!1;if(this.empty)return i==="";if(i==="/"&&n)return!0;let h=this.options;this.isWindows&&(i=i.split("\\").join("/"));let d=this.slashSplit(i);this.debug(this.pattern,"split",d);let u=this.set;this.debug(this.pattern,"set",u);let p=d[d.length-1];if(!p)for(let m=d.length-2;!p&&m>=0;m--)p=d[m];for(let m=0;m<u.length;m++){let a=u[m],w=d;if(h.matchBase&&a.length===1&&(w=[p]),this.matchOne(w,a,n))return h.flipNegate?!0:!this.negate}return h.flipNegate?!1:this.negate}static defaults(i){return vt.defaults(i).Minimatch}};vt.AST=ye;vt.Minimatch=Tt;vt.escape=we;vt.unescape=qt;N();import{fileURLToPath as oa}from"node:url";N();N();var be=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,Vr=new Set,as=typeof process=="object"&&process?process:{},Yr=(c,i,n,h)=>{typeof as.emitWarning=="function"?as.emitWarning(c,i,n,h):console.error(`[${n}] ${i}: ${c}`)},gi=globalThis.AbortController,Kr=globalThis.AbortSignal;if(typeof gi>"u"){Kr=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(h,d){this._onabort.push(d)}},gi=class{constructor(){i()}signal=new Kr;abort(h){if(!this.signal.aborted){this.signal.reason=h,this.signal.aborted=!0;for(let d of this.signal._onabort)d(h);this.signal.onabort?.(h)}}};let c=as.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",i=()=>{c&&(c=!1,Yr("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",i))}}var Rh=c=>!Vr.has(c),v_=Symbol("type"),he=c=>c&&c===Math.floor(c)&&c>0&&isFinite(c),Xr=c=>he(c)?c<=Math.pow(2,8)?Uint8Array:c<=Math.pow(2,16)?Uint16Array:c<=Math.pow(2,32)?Uint32Array:c<=Number.MAX_SAFE_INTEGER?ve:null:null,ve=class extends Array{constructor(i){super(i),this.fill(0)}},cs=class c{heap;length;static#t=!1;static create(i){let n=Xr(i);if(!n)return[];c.#t=!0;let h=new c(i,n);return c.#t=!1,h}constructor(i,n){if(!c.#t)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new n(i),this.length=0}push(i){this.heap[this.length++]=i}pop(){return this.heap[--this.length]}},Ue=class c{#t;#e;#n;#s;#o;#b;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#c;#d;#h;#a;#r;#m;#g;#l;#u;#k;#f;#S;#A;#w;#v;#x;#p;static unsafeExposeInternals(i){return{starts:i.#A,ttls:i.#w,sizes:i.#S,keyMap:i.#h,keyList:i.#a,valList:i.#r,next:i.#m,prev:i.#g,get head(){return i.#l},get tail(){return i.#u},free:i.#k,isBackgroundFetch:n=>i.#_(n),backgroundFetch:(n,h,d,u)=>i.#U(n,h,d,u),moveToTail:n=>i.#F(n),indexes:n=>i.#C(n),rindexes:n=>i.#T(n),isStale:n=>i.#y(n)}}get max(){return this.#t}get maxSize(){return this.#e}get calculatedSize(){return this.#d}get size(){return this.#c}get fetchMethod(){return this.#o}get memoMethod(){return this.#b}get dispose(){return this.#n}get disposeAfter(){return this.#s}constructor(i){let{max:n=0,ttl:h,ttlResolution:d=1,ttlAutopurge:u,updateAgeOnGet:p,updateAgeOnHas:m,allowStale:a,dispose:w,disposeAfter:k,noDisposeOnSet:S,noUpdateTTL:E,maxSize:A=0,maxEntrySize:T=0,sizeCalculation:R,fetchMethod:L,memoMethod:z,noDeleteOnFetchRejection:G,noDeleteOnStaleGet:Y,allowStaleOnFetchRejection:H,allowStaleOnFetchAbort:M,ignoreFetchAbort:X}=i;if(n!==0&&!he(n))throw new TypeError("max option must be a nonnegative integer");let Q=n?Xr(n):Array;if(!Q)throw new Error("invalid max value: "+n);if(this.#t=n,this.#e=A,this.maxEntrySize=T||this.#e,this.sizeCalculation=R,this.sizeCalculation){if(!this.#e&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(z!==void 0&&typeof z!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#b=z,L!==void 0&&typeof L!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#o=L,this.#x=!!L,this.#h=new Map,this.#a=new Array(n).fill(void 0),this.#r=new Array(n).fill(void 0),this.#m=new Q(n),this.#g=new Q(n),this.#l=0,this.#u=0,this.#k=cs.create(n),this.#c=0,this.#d=0,typeof w=="function"&&(this.#n=w),typeof k=="function"?(this.#s=k,this.#f=[]):(this.#s=void 0,this.#f=void 0),this.#v=!!this.#n,this.#p=!!this.#s,this.noDisposeOnSet=!!S,this.noUpdateTTL=!!E,this.noDeleteOnFetchRejection=!!G,this.allowStaleOnFetchRejection=!!H,this.allowStaleOnFetchAbort=!!M,this.ignoreFetchAbort=!!X,this.maxEntrySize!==0){if(this.#e!==0&&!he(this.#e))throw new TypeError("maxSize must be a positive integer if specified");if(!he(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#I()}if(this.allowStale=!!a,this.noDeleteOnStaleGet=!!Y,this.updateAgeOnGet=!!p,this.updateAgeOnHas=!!m,this.ttlResolution=he(d)||d===0?d:1,this.ttlAutopurge=!!u,this.ttl=h||0,this.ttl){if(!he(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#R()}if(this.#t===0&&this.ttl===0&&this.#e===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#t&&!this.#e){let nt="LRU_CACHE_UNBOUNDED";Rh(nt)&&(Vr.add(nt),Yr("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",nt,c))}}getRemainingTTL(i){return this.#h.has(i)?1/0:0}#R(){let i=new ve(this.#t),n=new ve(this.#t);this.#w=i,this.#A=n,this.#O=(u,p,m=be.now())=>{if(n[u]=p!==0?m:0,i[u]=p,p!==0&&this.ttlAutopurge){let a=setTimeout(()=>{this.#y(u)&&this.#D(this.#a[u],"expire")},p+1);a.unref&&a.unref()}},this.#E=u=>{n[u]=i[u]!==0?be.now():0},this.#i=(u,p)=>{if(i[p]){let m=i[p],a=n[p];if(!m||!a)return;u.ttl=m,u.start=a,u.now=h||d();let w=u.now-a;u.remainingTTL=m-w}};let h=0,d=()=>{let u=be.now();if(this.ttlResolution>0){h=u;let p=setTimeout(()=>h=0,this.ttlResolution);p.unref&&p.unref()}return u};this.getRemainingTTL=u=>{let p=this.#h.get(u);if(p===void 0)return 0;let m=i[p],a=n[p];if(!m||!a)return 1/0;let w=(h||d())-a;return m-w},this.#y=u=>{let p=n[u],m=i[u];return!!m&&!!p&&(h||d())-p>m}}#E=()=>{};#i=()=>{};#O=()=>{};#y=()=>!1;#I(){let i=new ve(this.#t);this.#d=0,this.#S=i,this.#M=n=>{this.#d-=i[n],i[n]=0},this.#P=(n,h,d,u)=>{if(this.#_(h))return 0;if(!he(d))if(u){if(typeof u!="function")throw new TypeError("sizeCalculation must be a function");if(d=u(h,n),!he(d))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return d},this.#z=(n,h,d)=>{if(i[n]=h,this.#e){let u=this.#e-i[n];for(;this.#d>u;)this.#N(!0)}this.#d+=i[n],d&&(d.entrySize=h,d.totalCalculatedSize=this.#d)}}#M=i=>{};#z=(i,n,h)=>{};#P=(i,n,h,d)=>{if(h||d)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#C({allowStale:i=this.allowStale}={}){if(this.#c)for(let n=this.#u;!(!this.#L(n)||((i||!this.#y(n))&&(yield n),n===this.#l));)n=this.#g[n]}*#T({allowStale:i=this.allowStale}={}){if(this.#c)for(let n=this.#l;!(!this.#L(n)||((i||!this.#y(n))&&(yield n),n===this.#u));)n=this.#m[n]}#L(i){return i!==void 0&&this.#h.get(this.#a[i])===i}*entries(){for(let i of this.#C())this.#r[i]!==void 0&&this.#a[i]!==void 0&&!this.#_(this.#r[i])&&(yield[this.#a[i],this.#r[i]])}*rentries(){for(let i of this.#T())this.#r[i]!==void 0&&this.#a[i]!==void 0&&!this.#_(this.#r[i])&&(yield[this.#a[i],this.#r[i]])}*keys(){for(let i of this.#C()){let n=this.#a[i];n!==void 0&&!this.#_(this.#r[i])&&(yield n)}}*rkeys(){for(let i of this.#T()){let n=this.#a[i];n!==void 0&&!this.#_(this.#r[i])&&(yield n)}}*values(){for(let i of this.#C())this.#r[i]!==void 0&&!this.#_(this.#r[i])&&(yield this.#r[i])}*rvalues(){for(let i of this.#T())this.#r[i]!==void 0&&!this.#_(this.#r[i])&&(yield this.#r[i])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(i,n={}){for(let h of this.#C()){let d=this.#r[h],u=this.#_(d)?d.__staleWhileFetching:d;if(u!==void 0&&i(u,this.#a[h],this))return this.get(this.#a[h],n)}}forEach(i,n=this){for(let h of this.#C()){let d=this.#r[h],u=this.#_(d)?d.__staleWhileFetching:d;u!==void 0&&i.call(n,u,this.#a[h],this)}}rforEach(i,n=this){for(let h of this.#T()){let d=this.#r[h],u=this.#_(d)?d.__staleWhileFetching:d;u!==void 0&&i.call(n,u,this.#a[h],this)}}purgeStale(){let i=!1;for(let n of this.#T({allowStale:!0}))this.#y(n)&&(this.#D(this.#a[n],"expire"),i=!0);return i}info(i){let n=this.#h.get(i);if(n===void 0)return;let h=this.#r[n],d=this.#_(h)?h.__staleWhileFetching:h;if(d===void 0)return;let u={value:d};if(this.#w&&this.#A){let p=this.#w[n],m=this.#A[n];if(p&&m){let a=p-(be.now()-m);u.ttl=a,u.start=Date.now()}}return this.#S&&(u.size=this.#S[n]),u}dump(){let i=[];for(let n of this.#C({allowStale:!0})){let h=this.#a[n],d=this.#r[n],u=this.#_(d)?d.__staleWhileFetching:d;if(u===void 0||h===void 0)continue;let p={value:u};if(this.#w&&this.#A){p.ttl=this.#w[n];let m=be.now()-this.#A[n];p.start=Math.floor(Date.now()-m)}this.#S&&(p.size=this.#S[n]),i.unshift([h,p])}return i}load(i){this.clear();for(let[n,h]of i){if(h.start){let d=Date.now()-h.start;h.start=be.now()-d}this.set(n,h.value,h)}}set(i,n,h={}){if(n===void 0)return this.delete(i),this;let{ttl:d=this.ttl,start:u,noDisposeOnSet:p=this.noDisposeOnSet,sizeCalculation:m=this.sizeCalculation,status:a}=h,{noUpdateTTL:w=this.noUpdateTTL}=h,k=this.#P(i,n,h.size||0,m);if(this.maxEntrySize&&k>this.maxEntrySize)return a&&(a.set="miss",a.maxEntrySizeExceeded=!0),this.#D(i,"set"),this;let S=this.#c===0?void 0:this.#h.get(i);if(S===void 0)S=this.#c===0?this.#u:this.#k.length!==0?this.#k.pop():this.#c===this.#t?this.#N(!1):this.#c,this.#a[S]=i,this.#r[S]=n,this.#h.set(i,S),this.#m[this.#u]=S,this.#g[S]=this.#u,this.#u=S,this.#c++,this.#z(S,k,a),a&&(a.set="add"),w=!1;else{this.#F(S);let E=this.#r[S];if(n!==E){if(this.#x&&this.#_(E)){E.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:A}=E;A!==void 0&&!p&&(this.#v&&this.#n?.(A,i,"set"),this.#p&&this.#f?.push([A,i,"set"]))}else p||(this.#v&&this.#n?.(E,i,"set"),this.#p&&this.#f?.push([E,i,"set"]));if(this.#M(S),this.#z(S,k,a),this.#r[S]=n,a){a.set="replace";let A=E&&this.#_(E)?E.__staleWhileFetching:E;A!==void 0&&(a.oldValue=A)}}else a&&(a.set="update")}if(d!==0&&!this.#w&&this.#R(),this.#w&&(w||this.#O(S,d,u),a&&this.#i(a,S)),!p&&this.#p&&this.#f){let E=this.#f,A;for(;A=E?.shift();)this.#s?.(...A)}return this}pop(){try{for(;this.#c;){let i=this.#r[this.#l];if(this.#N(!0),this.#_(i)){if(i.__staleWhileFetching)return i.__staleWhileFetching}else if(i!==void 0)return i}}finally{if(this.#p&&this.#f){let i=this.#f,n;for(;n=i?.shift();)this.#s?.(...n)}}}#N(i){let n=this.#l,h=this.#a[n],d=this.#r[n];return this.#x&&this.#_(d)?d.__abortController.abort(new Error("evicted")):(this.#v||this.#p)&&(this.#v&&this.#n?.(d,h,"evict"),this.#p&&this.#f?.push([d,h,"evict"])),this.#M(n),i&&(this.#a[n]=void 0,this.#r[n]=void 0,this.#k.push(n)),this.#c===1?(this.#l=this.#u=0,this.#k.length=0):this.#l=this.#m[n],this.#h.delete(h),this.#c--,n}has(i,n={}){let{updateAgeOnHas:h=this.updateAgeOnHas,status:d}=n,u=this.#h.get(i);if(u!==void 0){let p=this.#r[u];if(this.#_(p)&&p.__staleWhileFetching===void 0)return!1;if(this.#y(u))d&&(d.has="stale",this.#i(d,u));else return h&&this.#E(u),d&&(d.has="hit",this.#i(d,u)),!0}else d&&(d.has="miss");return!1}peek(i,n={}){let{allowStale:h=this.allowStale}=n,d=this.#h.get(i);if(d===void 0||!h&&this.#y(d))return;let u=this.#r[d];return this.#_(u)?u.__staleWhileFetching:u}#U(i,n,h,d){let u=n===void 0?void 0:this.#r[n];if(this.#_(u))return u;let p=new gi,{signal:m}=h;m?.addEventListener("abort",()=>p.abort(m.reason),{signal:p.signal});let a={signal:p.signal,options:h,context:d},w=(R,L=!1)=>{let{aborted:z}=p.signal,G=h.ignoreFetchAbort&&R!==void 0;if(h.status&&(z&&!L?(h.status.fetchAborted=!0,h.status.fetchError=p.signal.reason,G&&(h.status.fetchAbortIgnored=!0)):h.status.fetchResolved=!0),z&&!G&&!L)return S(p.signal.reason);let Y=A;return this.#r[n]===A&&(R===void 0?Y.__staleWhileFetching?this.#r[n]=Y.__staleWhileFetching:this.#D(i,"fetch"):(h.status&&(h.status.fetchUpdated=!0),this.set(i,R,a.options))),R},k=R=>(h.status&&(h.status.fetchRejected=!0,h.status.fetchError=R),S(R)),S=R=>{let{aborted:L}=p.signal,z=L&&h.allowStaleOnFetchAbort,G=z||h.allowStaleOnFetchRejection,Y=G||h.noDeleteOnFetchRejection,H=A;if(this.#r[n]===A&&(!Y||H.__staleWhileFetching===void 0?this.#D(i,"fetch"):z||(this.#r[n]=H.__staleWhileFetching)),G)return h.status&&H.__staleWhileFetching!==void 0&&(h.status.returnedStale=!0),H.__staleWhileFetching;if(H.__returned===H)throw R},E=(R,L)=>{let z=this.#o?.(i,u,a);z&&z instanceof Promise&&z.then(G=>R(G===void 0?void 0:G),L),p.signal.addEventListener("abort",()=>{(!h.ignoreFetchAbort||h.allowStaleOnFetchAbort)&&(R(void 0),h.allowStaleOnFetchAbort&&(R=G=>w(G,!0)))})};h.status&&(h.status.fetchDispatched=!0);let A=new Promise(E).then(w,k),T=Object.assign(A,{__abortController:p,__staleWhileFetching:u,__returned:void 0});return n===void 0?(this.set(i,T,{...a.options,status:void 0}),n=this.#h.get(i)):this.#r[n]=T,T}#_(i){if(!this.#x)return!1;let n=i;return!!n&&n instanceof Promise&&n.hasOwnProperty("__staleWhileFetching")&&n.__abortController instanceof gi}async fetch(i,n={}){let{allowStale:h=this.allowStale,updateAgeOnGet:d=this.updateAgeOnGet,noDeleteOnStaleGet:u=this.noDeleteOnStaleGet,ttl:p=this.ttl,noDisposeOnSet:m=this.noDisposeOnSet,size:a=0,sizeCalculation:w=this.sizeCalculation,noUpdateTTL:k=this.noUpdateTTL,noDeleteOnFetchRejection:S=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:E=this.allowStaleOnFetchRejection,ignoreFetchAbort:A=this.ignoreFetchAbort,allowStaleOnFetchAbort:T=this.allowStaleOnFetchAbort,context:R,forceRefresh:L=!1,status:z,signal:G}=n;if(!this.#x)return z&&(z.fetch="get"),this.get(i,{allowStale:h,updateAgeOnGet:d,noDeleteOnStaleGet:u,status:z});let Y={allowStale:h,updateAgeOnGet:d,noDeleteOnStaleGet:u,ttl:p,noDisposeOnSet:m,size:a,sizeCalculation:w,noUpdateTTL:k,noDeleteOnFetchRejection:S,allowStaleOnFetchRejection:E,allowStaleOnFetchAbort:T,ignoreFetchAbort:A,status:z,signal:G},H=this.#h.get(i);if(H===void 0){z&&(z.fetch="miss");let M=this.#U(i,H,Y,R);return M.__returned=M}else{let M=this.#r[H];if(this.#_(M)){let it=h&&M.__staleWhileFetching!==void 0;return z&&(z.fetch="inflight",it&&(z.returnedStale=!0)),it?M.__staleWhileFetching:M.__returned=M}let X=this.#y(H);if(!L&&!X)return z&&(z.fetch="hit"),this.#F(H),d&&this.#E(H),z&&this.#i(z,H),M;let Q=this.#U(i,H,Y,R),lt=Q.__staleWhileFetching!==void 0&&h;return z&&(z.fetch=X?"stale":"refresh",lt&&X&&(z.returnedStale=!0)),lt?Q.__staleWhileFetching:Q.__returned=Q}}async forceFetch(i,n={}){let h=await this.fetch(i,n);if(h===void 0)throw new Error("fetch() returned undefined");return h}memo(i,n={}){let h=this.#b;if(!h)throw new Error("no memoMethod provided to constructor");let{context:d,forceRefresh:u,...p}=n,m=this.get(i,p);if(!u&&m!==void 0)return m;let a=h(i,m,{options:p,context:d});return this.set(i,a,p),a}get(i,n={}){let{allowStale:h=this.allowStale,updateAgeOnGet:d=this.updateAgeOnGet,noDeleteOnStaleGet:u=this.noDeleteOnStaleGet,status:p}=n,m=this.#h.get(i);if(m!==void 0){let a=this.#r[m],w=this.#_(a);return p&&this.#i(p,m),this.#y(m)?(p&&(p.get="stale"),w?(p&&h&&a.__staleWhileFetching!==void 0&&(p.returnedStale=!0),h?a.__staleWhileFetching:void 0):(u||this.#D(i,"expire"),p&&h&&(p.returnedStale=!0),h?a:void 0)):(p&&(p.get="hit"),w?a.__staleWhileFetching:(this.#F(m),d&&this.#E(m),a))}else p&&(p.get="miss")}#q(i,n){this.#g[n]=i,this.#m[i]=n}#F(i){i!==this.#u&&(i===this.#l?this.#l=this.#m[i]:this.#q(this.#g[i],this.#m[i]),this.#q(this.#u,i),this.#u=i)}delete(i){return this.#D(i,"delete")}#D(i,n){let h=!1;if(this.#c!==0){let d=this.#h.get(i);if(d!==void 0)if(h=!0,this.#c===1)this.#B(n);else{this.#M(d);let u=this.#r[d];if(this.#_(u)?u.__abortController.abort(new Error("deleted")):(this.#v||this.#p)&&(this.#v&&this.#n?.(u,i,n),this.#p&&this.#f?.push([u,i,n])),this.#h.delete(i),this.#a[d]=void 0,this.#r[d]=void 0,d===this.#u)this.#u=this.#g[d];else if(d===this.#l)this.#l=this.#m[d];else{let p=this.#g[d];this.#m[p]=this.#m[d];let m=this.#m[d];this.#g[m]=this.#g[d]}this.#c--,this.#k.push(d)}}if(this.#p&&this.#f?.length){let d=this.#f,u;for(;u=d?.shift();)this.#s?.(...u)}return h}clear(){return this.#B("delete")}#B(i){for(let n of this.#T({allowStale:!0})){let h=this.#r[n];if(this.#_(h))h.__abortController.abort(new Error("deleted"));else{let d=this.#a[n];this.#v&&this.#n?.(h,d,i),this.#p&&this.#f?.push([h,d,i])}}if(this.#h.clear(),this.#r.fill(void 0),this.#a.fill(void 0),this.#w&&this.#A&&(this.#w.fill(0),this.#A.fill(0)),this.#S&&this.#S.fill(0),this.#l=0,this.#u=0,this.#k.length=0,this.#d=0,this.#c=0,this.#p&&this.#f){let n=this.#f,h;for(;h=n?.shift();)this.#s?.(...h)}}};import{posix as Fh,win32 as ws}from"node:path";import{fileURLToPath as Bh}from"node:url";import{lstatSync as jh,readdir as Wh,readdirSync as Gh,readlinkSync as $h,realpathSync as Hh}from"fs";import*as Kh from"node:fs";import{lstat as Yh,readdir as Xh,readlink as Qh,realpath as Jh}from"node:fs/promises";N();import{EventEmitter as ms}from"node:events";import en from"node:stream";import{StringDecoder as Ih}from"node:string_decoder";var Qr=typeof process=="object"&&process?process:{stdout:null,stderr:null},Dh=c=>!!c&&typeof c=="object"&&(c instanceof ce||c instanceof en||Oh(c)||Mh(c)),Oh=c=>!!c&&typeof c=="object"&&c instanceof ms&&typeof c.pipe=="function"&&c.pipe!==en.Writable.prototype.pipe,Mh=c=>!!c&&typeof c=="object"&&c instanceof ms&&typeof c.write=="function"&&typeof c.end=="function",te=Symbol("EOF"),ee=Symbol("maybeEmitEnd"),ae=Symbol("emittedEnd"),yi=Symbol("emittingEnd"),qe=Symbol("emittedError"),wi=Symbol("closed"),Jr=Symbol("read"),bi=Symbol("flush"),Zr=Symbol("flushChunk"),Ft=Symbol("encoding"),xe=Symbol("decoder"),at=Symbol("flowing"),Fe=Symbol("paused"),ke=Symbol("resume"),ct=Symbol("buffer"),xt=Symbol("pipes"),_t=Symbol("bufferLength"),_s=Symbol("bufferPush"),vi=Symbol("bufferShift"),gt=Symbol("objectMode"),rt=Symbol("destroyed"),ds=Symbol("error"),us=Symbol("emitData"),tn=Symbol("emitEnd"),ls=Symbol("emitEnd2"),Kt=Symbol("async"),ps=Symbol("abort"),xi=Symbol("aborted"),Be=Symbol("signal"),de=Symbol("dataListeners"),Rt=Symbol("discarded"),je=c=>Promise.resolve().then(c),zh=c=>c(),Ph=c=>c==="end"||c==="finish"||c==="prefinish",Lh=c=>c instanceof ArrayBuffer||!!c&&typeof c=="object"&&c.constructor&&c.constructor.name==="ArrayBuffer"&&c.byteLength>=0,Nh=c=>!Buffer.isBuffer(c)&&ArrayBuffer.isView(c),ki=class{src;dest;opts;ondrain;constructor(i,n,h){this.src=i,this.dest=n,this.opts=h,this.ondrain=()=>i[ke](),this.dest.on("drain",this.ondrain)}unpipe(){this.dest.removeListener("drain",this.ondrain)}proxyErrors(i){}end(){this.unpipe(),this.opts.end&&this.dest.end()}},fs=class extends ki{unpipe(){this.src.removeListener("error",this.proxyErrors),super.unpipe()}constructor(i,n,h){super(i,n,h),this.proxyErrors=d=>n.emit("error",d),i.on("error",this.proxyErrors)}},Uh=c=>!!c.objectMode,qh=c=>!c.objectMode&&!!c.encoding&&c.encoding!=="buffer",ce=class extends ms{[at]=!1;[Fe]=!1;[xt]=[];[ct]=[];[gt];[Ft];[Kt];[xe];[te]=!1;[ae]=!1;[yi]=!1;[wi]=!1;[qe]=null;[_t]=0;[rt]=!1;[Be];[xi]=!1;[de]=0;[Rt]=!1;writable=!0;readable=!0;constructor(...i){let n=i[0]||{};if(super(),n.objectMode&&typeof n.encoding=="string")throw new TypeError("Encoding and objectMode may not be used together");Uh(n)?(this[gt]=!0,this[Ft]=null):qh(n)?(this[Ft]=n.encoding,this[gt]=!1):(this[gt]=!1,this[Ft]=null),this[Kt]=!!n.async,this[xe]=this[Ft]?new Ih(this[Ft]):null,n&&n.debugExposeBuffer===!0&&Object.defineProperty(this,"buffer",{get:()=>this[ct]}),n&&n.debugExposePipes===!0&&Object.defineProperty(this,"pipes",{get:()=>this[xt]});let{signal:h}=n;h&&(this[Be]=h,h.aborted?this[ps]():h.addEventListener("abort",()=>this[ps]()))}get bufferLength(){return this[_t]}get encoding(){return this[Ft]}set encoding(i){throw new Error("Encoding must be set at instantiation time")}setEncoding(i){throw new Error("Encoding must be set at instantiation time")}get objectMode(){return this[gt]}set objectMode(i){throw new Error("objectMode must be set at instantiation time")}get async(){return this[Kt]}set async(i){this[Kt]=this[Kt]||!!i}[ps](){this[xi]=!0,this.emit("abort",this[Be]?.reason),this.destroy(this[Be]?.reason)}get aborted(){return this[xi]}set aborted(i){}write(i,n,h){if(this[xi])return!1;if(this[te])throw new Error("write after end");if(this[rt])return this.emit("error",Object.assign(new Error("Cannot call write after a stream was destroyed"),{code:"ERR_STREAM_DESTROYED"})),!0;typeof n=="function"&&(h=n,n="utf8"),n||(n="utf8");let d=this[Kt]?je:zh;if(!this[gt]&&!Buffer.isBuffer(i)){if(Nh(i))i=Buffer.from(i.buffer,i.byteOffset,i.byteLength);else if(Lh(i))i=Buffer.from(i);else if(typeof i!="string")throw new Error("Non-contiguous data written to non-objectMode stream")}return this[gt]?(this[at]&&this[_t]!==0&&this[bi](!0),this[at]?this.emit("data",i):this[_s](i),this[_t]!==0&&this.emit("readable"),h&&d(h),this[at]):i.length?(typeof i=="string"&&!(n===this[Ft]&&!this[xe]?.lastNeed)&&(i=Buffer.from(i,n)),Buffer.isBuffer(i)&&this[Ft]&&(i=this[xe].write(i)),this[at]&&this[_t]!==0&&this[bi](!0),this[at]?this.emit("data",i):this[_s](i),this[_t]!==0&&this.emit("readable"),h&&d(h),this[at]):(this[_t]!==0&&this.emit("readable"),h&&d(h),this[at])}read(i){if(this[rt])return null;if(this[Rt]=!1,this[_t]===0||i===0||i&&i>this[_t])return this[ee](),null;this[gt]&&(i=null),this[ct].length>1&&!this[gt]&&(this[ct]=[this[Ft]?this[ct].join(""):Buffer.concat(this[ct],this[_t])]);let n=this[Jr](i||null,this[ct][0]);return this[ee](),n}[Jr](i,n){if(this[gt])this[vi]();else{let h=n;i===h.length||i===null?this[vi]():typeof h=="string"?(this[ct][0]=h.slice(i),n=h.slice(0,i),this[_t]-=i):(this[ct][0]=h.subarray(i),n=h.subarray(0,i),this[_t]-=i)}return this.emit("data",n),!this[ct].length&&!this[te]&&this.emit("drain"),n}end(i,n,h){return typeof i=="function"&&(h=i,i=void 0),typeof n=="function"&&(h=n,n="utf8"),i!==void 0&&this.write(i,n),h&&this.once("end",h),this[te]=!0,this.writable=!1,(this[at]||!this[Fe])&&this[ee](),this}[ke](){this[rt]||(!this[de]&&!this[xt].length&&(this[Rt]=!0),this[Fe]=!1,this[at]=!0,this.emit("resume"),this[ct].length?this[bi]():this[te]?this[ee]():this.emit("drain"))}resume(){return this[ke]()}pause(){this[at]=!1,this[Fe]=!0,this[Rt]=!1}get destroyed(){return this[rt]}get flowing(){return this[at]}get paused(){return this[Fe]}[_s](i){this[gt]?this[_t]+=1:this[_t]+=i.length,this[ct].push(i)}[vi](){return this[gt]?this[_t]-=1:this[_t]-=this[ct][0].length,this[ct].shift()}[bi](i=!1){do;while(this[Zr](this[vi]())&&this[ct].length);!i&&!this[ct].length&&!this[te]&&this.emit("drain")}[Zr](i){return this.emit("data",i),this[at]}pipe(i,n){if(this[rt])return i;this[Rt]=!1;let h=this[ae];return n=n||{},i===Qr.stdout||i===Qr.stderr?n.end=!1:n.end=n.end!==!1,n.proxyErrors=!!n.proxyErrors,h?n.end&&i.end():(this[xt].push(n.proxyErrors?new fs(this,i,n):new ki(this,i,n)),this[Kt]?je(()=>this[ke]()):this[ke]()),i}unpipe(i){let n=this[xt].find(h=>h.dest===i);n&&(this[xt].length===1?(this[at]&&this[de]===0&&(this[at]=!1),this[xt]=[]):this[xt].splice(this[xt].indexOf(n),1),n.unpipe())}addListener(i,n){return this.on(i,n)}on(i,n){let h=super.on(i,n);if(i==="data")this[Rt]=!1,this[de]++,!this[xt].length&&!this[at]&&this[ke]();else if(i==="readable"&&this[_t]!==0)super.emit("readable");else if(Ph(i)&&this[ae])super.emit(i),this.removeAllListeners(i);else if(i==="error"&&this[qe]){let d=n;this[Kt]?je(()=>d.call(this,this[qe])):d.call(this,this[qe])}return h}removeListener(i,n){return this.off(i,n)}off(i,n){let h=super.off(i,n);return i==="data"&&(this[de]=this.listeners("data").length,this[de]===0&&!this[Rt]&&!this[xt].length&&(this[at]=!1)),h}removeAllListeners(i){let n=super.removeAllListeners(i);return(i==="data"||i===void 0)&&(this[de]=0,!this[Rt]&&!this[xt].length&&(this[at]=!1)),n}get emittedEnd(){return this[ae]}[ee](){!this[yi]&&!this[ae]&&!this[rt]&&this[ct].length===0&&this[te]&&(this[yi]=!0,this.emit("end"),this.emit("prefinish"),this.emit("finish"),this[wi]&&this.emit("close"),this[yi]=!1)}emit(i,...n){let h=n[0];if(i!=="error"&&i!=="close"&&i!==rt&&this[rt])return!1;if(i==="data")return!this[gt]&&!h?!1:this[Kt]?(je(()=>this[us](h)),!0):this[us](h);if(i==="end")return this[tn]();if(i==="close"){if(this[wi]=!0,!this[ae]&&!this[rt])return!1;let u=super.emit("close");return this.removeAllListeners("close"),u}else if(i==="error"){this[qe]=h,super.emit(ds,h);let u=!this[Be]||this.listeners("error").length?super.emit("error",h):!1;return this[ee](),u}else if(i==="resume"){let u=super.emit("resume");return this[ee](),u}else if(i==="finish"||i==="prefinish"){let u=super.emit(i);return this.removeAllListeners(i),u}let d=super.emit(i,...n);return this[ee](),d}[us](i){for(let h of this[xt])h.dest.write(i)===!1&&this.pause();let n=this[Rt]?!1:super.emit("data",i);return this[ee](),n}[tn](){return this[ae]?!1:(this[ae]=!0,this.readable=!1,this[Kt]?(je(()=>this[ls]()),!0):this[ls]())}[ls](){if(this[xe]){let n=this[xe].end();if(n){for(let h of this[xt])h.dest.write(n);this[Rt]||super.emit("data",n)}}for(let n of this[xt])n.end();let i=super.emit("end");return this.removeAllListeners("end"),i}async collect(){let i=Object.assign([],{dataLength:0});this[gt]||(i.dataLength=0);let n=this.promise();return this.on("data",h=>{i.push(h),this[gt]||(i.dataLength+=h.length)}),await n,i}async concat(){if(this[gt])throw new Error("cannot concat in objectMode");let i=await this.collect();return this[Ft]?i.join(""):Buffer.concat(i,i.dataLength)}async promise(){return new Promise((i,n)=>{this.on(rt,()=>n(new Error("stream destroyed"))),this.on("error",h=>n(h)),this.on("end",()=>i())})}[Symbol.asyncIterator](){this[Rt]=!1;let i=!1,n=async()=>(this.pause(),i=!0,{value:void 0,done:!0});return{next:()=>{if(i)return n();let d=this.read();if(d!==null)return Promise.resolve({done:!1,value:d});if(this[te])return n();let u,p,m=S=>{this.off("data",a),this.off("end",w),this.off(rt,k),n(),p(S)},a=S=>{this.off("error",m),this.off("end",w),this.off(rt,k),this.pause(),u({value:S,done:!!this[te]})},w=()=>{this.off("error",m),this.off("data",a),this.off(rt,k),n(),u({done:!0,value:void 0})},k=()=>m(new Error("stream destroyed"));return new Promise((S,E)=>{p=E,u=S,this.once(rt,k),this.once("error",m),this.once("end",w),this.once("data",a)})},throw:n,return:n,[Symbol.asyncIterator](){return this}}}[Symbol.iterator](){this[Rt]=!1;let i=!1,n=()=>(this.pause(),this.off(ds,n),this.off(rt,n),this.off("end",n),i=!0,{done:!0,value:void 0}),h=()=>{if(i)return n();let d=this.read();return d===null?n():{done:!1,value:d}};return this.once("end",n),this.once(ds,n),this.once(rt,n),{next:h,throw:n,return:n,[Symbol.iterator](){return this}}}destroy(i){if(this[rt])return i?this.emit("error",i):this.emit(rt),this;this[rt]=!0,this[Rt]=!0,this[ct].length=0,this[_t]=0;let n=this;return typeof n.close=="function"&&!this[wi]&&n.close(),i?this.emit("error",i):this.emit(rt),this}static get isStream(){return Dh}};var Vh=Hh.native,Ge={lstatSync:jh,readdir:Wh,readdirSync:Gh,readlinkSync:$h,realpathSync:Vh,promises:{lstat:Yh,readdir:Xh,readlink:Qh,realpath:Jh}},hn=c=>!c||c===Ge||c===Kh?Ge:{...Ge,...c,promises:{...Ge.promises,...c.promises||{}}},an=/^\\\\\?\\([a-z]:)\\?$/i,Zh=c=>c.replace(/\//g,"\\").replace(an,"$1\\"),ta=/[\\\/]/,Mt=0,cn=1,_n=2,Vt=4,dn=6,un=8,ue=10,ln=12,Ot=15,We=~Ot,gs=16,sn=32,$e=64,Bt=128,Si=256,Ei=512,rn=$e|Bt|Ei,ea=1023,ys=c=>c.isFile()?un:c.isDirectory()?Vt:c.isSymbolicLink()?ue:c.isCharacterDevice()?_n:c.isBlockDevice()?dn:c.isSocket()?ln:c.isFIFO()?cn:Mt,nn=new Map,He=c=>{let i=nn.get(c);if(i)return i;let n=c.normalize("NFKD");return nn.set(c,n),n},on=new Map,Ai=c=>{let i=on.get(c);if(i)return i;let n=He(c.toLowerCase());return on.set(c,n),n},Ci=class extends Ue{constructor(){super({max:256})}},bs=class extends Ue{constructor(i=16*1024){super({maxSize:i,sizeCalculation:n=>n.length+1})}},pn=Symbol("PathScurry setAsCwd"),yt=class{name;root;roots;parent;nocase;isCWD=!1;#t;#e;get dev(){return this.#e}#n;get mode(){return this.#n}#s;get nlink(){return this.#s}#o;get uid(){return this.#o}#b;get gid(){return this.#b}#c;get rdev(){return this.#c}#d;get blksize(){return this.#d}#h;get ino(){return this.#h}#a;get size(){return this.#a}#r;get blocks(){return this.#r}#m;get atimeMs(){return this.#m}#g;get mtimeMs(){return this.#g}#l;get ctimeMs(){return this.#l}#u;get birthtimeMs(){return this.#u}#k;get atime(){return this.#k}#f;get mtime(){return this.#f}#S;get ctime(){return this.#S}#A;get birthtime(){return this.#A}#w;#v;#x;#p;#R;#E;#i;#O;#y;#I;get parentPath(){return(this.parent||this).fullpath()}get path(){return this.parentPath}constructor(i,n=Mt,h,d,u,p,m){this.name=i,this.#w=u?Ai(i):He(i),this.#i=n&ea,this.nocase=u,this.roots=d,this.root=h||this,this.#O=p,this.#x=m.fullpath,this.#R=m.relative,this.#E=m.relativePosix,this.parent=m.parent,this.parent?this.#t=this.parent.#t:this.#t=hn(m.fs)}depth(){return this.#v!==void 0?this.#v:this.parent?this.#v=this.parent.depth()+1:this.#v=0}childrenCache(){return this.#O}resolve(i){if(!i)return this;let n=this.getRootString(i),d=i.substring(n.length).split(this.splitSep);return n?this.getRoot(n).#M(d):this.#M(d)}#M(i){let n=this;for(let h of i)n=n.child(h);return n}children(){let i=this.#O.get(this);if(i)return i;let n=Object.assign([],{provisional:0});return this.#O.set(this,n),this.#i&=~gs,n}child(i,n){if(i===""||i===".")return this;if(i==="..")return this.parent||this;let h=this.children(),d=this.nocase?Ai(i):He(i);for(let a of h)if(a.#w===d)return a;let u=this.parent?this.sep:"",p=this.#x?this.#x+u+i:void 0,m=this.newChild(i,Mt,{...n,parent:this,fullpath:p});return this.canReaddir()||(m.#i|=Bt),h.push(m),m}relative(){if(this.isCWD)return"";if(this.#R!==void 0)return this.#R;let i=this.name,n=this.parent;if(!n)return this.#R=this.name;let h=n.relative();return h+(!h||!n.parent?"":this.sep)+i}relativePosix(){if(this.sep==="/")return this.relative();if(this.isCWD)return"";if(this.#E!==void 0)return this.#E;let i=this.name,n=this.parent;if(!n)return this.#E=this.fullpathPosix();let h=n.relativePosix();return h+(!h||!n.parent?"":"/")+i}fullpath(){if(this.#x!==void 0)return this.#x;let i=this.name,n=this.parent;if(!n)return this.#x=this.name;let d=n.fullpath()+(n.parent?this.sep:"")+i;return this.#x=d}fullpathPosix(){if(this.#p!==void 0)return this.#p;if(this.sep==="/")return this.#p=this.fullpath();if(!this.parent){let d=this.fullpath().replace(/\\/g,"/");return/^[a-z]:\//i.test(d)?this.#p=`//?/${d}`:this.#p=d}let i=this.parent,n=i.fullpathPosix(),h=n+(!n||!i.parent?"":"/")+this.name;return this.#p=h}isUnknown(){return(this.#i&Ot)===Mt}isType(i){return this[`is${i}`]()}getType(){return this.isUnknown()?"Unknown":this.isDirectory()?"Directory":this.isFile()?"File":this.isSymbolicLink()?"SymbolicLink":this.isFIFO()?"FIFO":this.isCharacterDevice()?"CharacterDevice":this.isBlockDevice()?"BlockDevice":this.isSocket()?"Socket":"Unknown"}isFile(){return(this.#i&Ot)===un}isDirectory(){return(this.#i&Ot)===Vt}isCharacterDevice(){return(this.#i&Ot)===_n}isBlockDevice(){return(this.#i&Ot)===dn}isFIFO(){return(this.#i&Ot)===cn}isSocket(){return(this.#i&Ot)===ln}isSymbolicLink(){return(this.#i&ue)===ue}lstatCached(){return this.#i&sn?this:void 0}readlinkCached(){return this.#y}realpathCached(){return this.#I}readdirCached(){let i=this.children();return i.slice(0,i.provisional)}canReadlink(){if(this.#y)return!0;if(!this.parent)return!1;let i=this.#i&Ot;return!(i!==Mt&&i!==ue||this.#i&Si||this.#i&Bt)}calledReaddir(){return!!(this.#i&gs)}isENOENT(){return!!(this.#i&Bt)}isNamed(i){return this.nocase?this.#w===Ai(i):this.#w===He(i)}async readlink(){let i=this.#y;if(i)return i;if(this.canReadlink()&&this.parent)try{let n=await this.#t.promises.readlink(this.fullpath()),h=(await this.parent.realpath())?.resolve(n);if(h)return this.#y=h}catch(n){this.#_(n.code);return}}readlinkSync(){let i=this.#y;if(i)return i;if(this.canReadlink()&&this.parent)try{let n=this.#t.readlinkSync(this.fullpath()),h=this.parent.realpathSync()?.resolve(n);if(h)return this.#y=h}catch(n){this.#_(n.code);return}}#z(i){this.#i|=gs;for(let n=i.provisional;n<i.length;n++){let h=i[n];h&&h.#P()}}#P(){this.#i&Bt||(this.#i=(this.#i|Bt)&We,this.#C())}#C(){let i=this.children();i.provisional=0;for(let n of i)n.#P()}#T(){this.#i|=Ei,this.#L()}#L(){if(this.#i&$e)return;let i=this.#i;(i&Ot)===Vt&&(i&=We),this.#i=i|$e,this.#C()}#N(i=""){i==="ENOTDIR"||i==="EPERM"?this.#L():i==="ENOENT"?this.#P():this.children().provisional=0}#U(i=""){i==="ENOTDIR"?this.parent.#L():i==="ENOENT"&&this.#P()}#_(i=""){let n=this.#i;n|=Si,i==="ENOENT"&&(n|=Bt),(i==="EINVAL"||i==="UNKNOWN")&&(n&=We),this.#i=n,i==="ENOTDIR"&&this.parent&&this.parent.#L()}#q(i,n){return this.#D(i,n)||this.#F(i,n)}#F(i,n){let h=ys(i),d=this.newChild(i.name,h,{parent:this}),u=d.#i&Ot;return u!==Vt&&u!==ue&&u!==Mt&&(d.#i|=$e),n.unshift(d),n.provisional++,d}#D(i,n){for(let h=n.provisional;h<n.length;h++){let d=n[h];if((this.nocase?Ai(i.name):He(i.name))===d.#w)return this.#B(i,d,h,n)}}#B(i,n,h,d){let u=n.name;return n.#i=n.#i&We|ys(i),u!==i.name&&(n.name=i.name),h!==d.provisional&&(h===d.length-1?d.pop():d.splice(h,1),d.unshift(n)),d.provisional++,n}async lstat(){if(!(this.#i&Bt))try{return this.#$(await this.#t.promises.lstat(this.fullpath())),this}catch(i){this.#U(i.code)}}lstatSync(){if(!(this.#i&Bt))try{return this.#$(this.#t.lstatSync(this.fullpath())),this}catch(i){this.#U(i.code)}}#$(i){let{atime:n,atimeMs:h,birthtime:d,birthtimeMs:u,blksize:p,blocks:m,ctime:a,ctimeMs:w,dev:k,gid:S,ino:E,mode:A,mtime:T,mtimeMs:R,nlink:L,rdev:z,size:G,uid:Y}=i;this.#k=n,this.#m=h,this.#A=d,this.#u=u,this.#d=p,this.#r=m,this.#S=a,this.#l=w,this.#e=k,this.#b=S,this.#h=E,this.#n=A,this.#f=T,this.#g=R,this.#s=L,this.#c=z,this.#a=G,this.#o=Y;let H=ys(i);this.#i=this.#i&We|H|sn,H!==Mt&&H!==Vt&&H!==ue&&(this.#i|=$e)}#W=[];#G=!1;#H(i){this.#G=!1;let n=this.#W.slice();this.#W.length=0,n.forEach(h=>h(null,i))}readdirCB(i,n=!1){if(!this.canReaddir()){n?i(null,[]):queueMicrotask(()=>i(null,[]));return}let h=this.children();if(this.calledReaddir()){let u=h.slice(0,h.provisional);n?i(null,u):queueMicrotask(()=>i(null,u));return}if(this.#W.push(i),this.#G)return;this.#G=!0;let d=this.fullpath();this.#t.readdir(d,{withFileTypes:!0},(u,p)=>{if(u)this.#N(u.code),h.provisional=0;else{for(let m of p)this.#q(m,h);this.#z(h)}this.#H(h.slice(0,h.provisional))})}#j;async readdir(){if(!this.canReaddir())return[];let i=this.children();if(this.calledReaddir())return i.slice(0,i.provisional);let n=this.fullpath();if(this.#j)await this.#j;else{let h=()=>{};this.#j=new Promise(d=>h=d);try{for(let d of await this.#t.promises.readdir(n,{withFileTypes:!0}))this.#q(d,i);this.#z(i)}catch(d){this.#N(d.code),i.provisional=0}this.#j=void 0,h()}return i.slice(0,i.provisional)}readdirSync(){if(!this.canReaddir())return[];let i=this.children();if(this.calledReaddir())return i.slice(0,i.provisional);let n=this.fullpath();try{for(let h of this.#t.readdirSync(n,{withFileTypes:!0}))this.#q(h,i);this.#z(i)}catch(h){this.#N(h.code),i.provisional=0}return i.slice(0,i.provisional)}canReaddir(){if(this.#i&rn)return!1;let i=Ot&this.#i;return i===Mt||i===Vt||i===ue}shouldWalk(i,n){return(this.#i&Vt)===Vt&&!(this.#i&rn)&&!i.has(this)&&(!n||n(this))}async realpath(){if(this.#I)return this.#I;if(!((Ei|Si|Bt)&this.#i))try{let i=await this.#t.promises.realpath(this.fullpath());return this.#I=this.resolve(i)}catch{this.#T()}}realpathSync(){if(this.#I)return this.#I;if(!((Ei|Si|Bt)&this.#i))try{let i=this.#t.realpathSync(this.fullpath());return this.#I=this.resolve(i)}catch{this.#T()}}[pn](i){if(i===this)return;i.isCWD=!1,this.isCWD=!0;let n=new Set([]),h=[],d=this;for(;d&&d.parent;)n.add(d),d.#R=h.join(this.sep),d.#E=h.join("/"),d=d.parent,h.push("..");for(d=i;d&&d.parent&&!n.has(d);)d.#R=void 0,d.#E=void 0,d=d.parent}},Ti=class c extends yt{sep="\\";splitSep=ta;constructor(i,n=Mt,h,d,u,p,m){super(i,n,h,d,u,p,m)}newChild(i,n=Mt,h={}){return new c(i,n,this.root,this.roots,this.nocase,this.childrenCache(),h)}getRootString(i){return ws.parse(i).root}getRoot(i){if(i=Zh(i.toUpperCase()),i===this.root.name)return this.root;for(let[n,h]of Object.entries(this.roots))if(this.sameRoot(i,n))return this.roots[i]=h;return this.roots[i]=new Se(i,this).root}sameRoot(i,n=this.root.name){return i=i.toUpperCase().replace(/\//g,"\\").replace(an,"$1\\"),i===n}},Ri=class c extends yt{splitSep="/";sep="/";constructor(i,n=Mt,h,d,u,p,m){super(i,n,h,d,u,p,m)}getRootString(i){return i.startsWith("/")?"/":""}getRoot(i){return this.root}newChild(i,n=Mt,h={}){return new c(i,n,this.root,this.roots,this.nocase,this.childrenCache(),h)}},Ii=class{root;rootPath;roots;cwd;#t;#e;#n;nocase;#s;constructor(i=process.cwd(),n,h,{nocase:d,childrenCacheSize:u=16*1024,fs:p=Ge}={}){this.#s=hn(p),(i instanceof URL||i.startsWith("file://"))&&(i=Bh(i));let m=n.resolve(i);this.roots=Object.create(null),this.rootPath=this.parseRootPath(m),this.#t=new Ci,this.#e=new Ci,this.#n=new bs(u);let a=m.substring(this.rootPath.length).split(h);if(a.length===1&&!a[0]&&a.pop(),d===void 0)throw new TypeError("must provide nocase setting to PathScurryBase ctor");this.nocase=d,this.root=this.newRoot(this.#s),this.roots[this.rootPath]=this.root;let w=this.root,k=a.length-1,S=n.sep,E=this.rootPath,A=!1;for(let T of a){let R=k--;w=w.child(T,{relative:new Array(R).fill("..").join(S),relativePosix:new Array(R).fill("..").join("/"),fullpath:E+=(A?"":S)+T}),A=!0}this.cwd=w}depth(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.depth()}childrenCache(){return this.#n}resolve(...i){let n="";for(let u=i.length-1;u>=0;u--){let p=i[u];if(!(!p||p===".")&&(n=n?`${p}/${n}`:p,this.isAbsolute(p)))break}let h=this.#t.get(n);if(h!==void 0)return h;let d=this.cwd.resolve(n).fullpath();return this.#t.set(n,d),d}resolvePosix(...i){let n="";for(let u=i.length-1;u>=0;u--){let p=i[u];if(!(!p||p===".")&&(n=n?`${p}/${n}`:p,this.isAbsolute(p)))break}let h=this.#e.get(n);if(h!==void 0)return h;let d=this.cwd.resolve(n).fullpathPosix();return this.#e.set(n,d),d}relative(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.relative()}relativePosix(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.relativePosix()}basename(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.name}dirname(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),(i.parent||i).fullpath()}async readdir(i=this.cwd,n={withFileTypes:!0}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd);let{withFileTypes:h}=n;if(i.canReaddir()){let d=await i.readdir();return h?d:d.map(u=>u.name)}else return[]}readdirSync(i=this.cwd,n={withFileTypes:!0}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd);let{withFileTypes:h=!0}=n;return i.canReaddir()?h?i.readdirSync():i.readdirSync().map(d=>d.name):[]}async lstat(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.lstat()}lstatSync(i=this.cwd){return typeof i=="string"&&(i=this.cwd.resolve(i)),i.lstatSync()}async readlink(i=this.cwd,{withFileTypes:n}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i.withFileTypes,i=this.cwd);let h=await i.readlink();return n?h:h?.fullpath()}readlinkSync(i=this.cwd,{withFileTypes:n}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i.withFileTypes,i=this.cwd);let h=i.readlinkSync();return n?h:h?.fullpath()}async realpath(i=this.cwd,{withFileTypes:n}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i.withFileTypes,i=this.cwd);let h=await i.realpath();return n?h:h?.fullpath()}realpathSync(i=this.cwd,{withFileTypes:n}={withFileTypes:!1}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i.withFileTypes,i=this.cwd);let h=i.realpathSync();return n?h:h?.fullpath()}async walk(i=this.cwd,n={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd);let{withFileTypes:h=!0,follow:d=!1,filter:u,walkFilter:p}=n,m=[];(!u||u(i))&&m.push(h?i:i.fullpath());let a=new Set,w=(S,E)=>{a.add(S),S.readdirCB((A,T)=>{if(A)return E(A);let R=T.length;if(!R)return E();let L=()=>{--R===0&&E()};for(let z of T)(!u||u(z))&&m.push(h?z:z.fullpath()),d&&z.isSymbolicLink()?z.realpath().then(G=>G?.isUnknown()?G.lstat():G).then(G=>G?.shouldWalk(a,p)?w(G,L):L()):z.shouldWalk(a,p)?w(z,L):L()},!0)},k=i;return new Promise((S,E)=>{w(k,A=>{if(A)return E(A);S(m)})})}walkSync(i=this.cwd,n={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd);let{withFileTypes:h=!0,follow:d=!1,filter:u,walkFilter:p}=n,m=[];(!u||u(i))&&m.push(h?i:i.fullpath());let a=new Set([i]);for(let w of a){let k=w.readdirSync();for(let S of k){(!u||u(S))&&m.push(h?S:S.fullpath());let E=S;if(S.isSymbolicLink()){if(!(d&&(E=S.realpathSync())))continue;E.isUnknown()&&E.lstatSync()}E.shouldWalk(a,p)&&a.add(E)}}return m}[Symbol.asyncIterator](){return this.iterate()}iterate(i=this.cwd,n={}){return typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd),this.stream(i,n)[Symbol.asyncIterator]()}[Symbol.iterator](){return this.iterateSync()}*iterateSync(i=this.cwd,n={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd);let{withFileTypes:h=!0,follow:d=!1,filter:u,walkFilter:p}=n;(!u||u(i))&&(yield h?i:i.fullpath());let m=new Set([i]);for(let a of m){let w=a.readdirSync();for(let k of w){(!u||u(k))&&(yield h?k:k.fullpath());let S=k;if(k.isSymbolicLink()){if(!(d&&(S=k.realpathSync())))continue;S.isUnknown()&&S.lstatSync()}S.shouldWalk(m,p)&&m.add(S)}}}stream(i=this.cwd,n={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd);let{withFileTypes:h=!0,follow:d=!1,filter:u,walkFilter:p}=n,m=new ce({objectMode:!0});(!u||u(i))&&m.write(h?i:i.fullpath());let a=new Set,w=[i],k=0,S=()=>{let E=!1;for(;!E;){let A=w.shift();if(!A){k===0&&m.end();return}k++,a.add(A);let T=(L,z,G=!1)=>{if(L)return m.emit("error",L);if(d&&!G){let Y=[];for(let H of z)H.isSymbolicLink()&&Y.push(H.realpath().then(M=>M?.isUnknown()?M.lstat():M));if(Y.length){Promise.all(Y).then(()=>T(null,z,!0));return}}for(let Y of z)Y&&(!u||u(Y))&&(m.write(h?Y:Y.fullpath())||(E=!0));k--;for(let Y of z){let H=Y.realpathCached()||Y;H.shouldWalk(a,p)&&w.push(H)}E&&!m.flowing?m.once("drain",S):R||S()},R=!0;A.readdirCB(T,!0),R=!1}};return S(),m}streamSync(i=this.cwd,n={}){typeof i=="string"?i=this.cwd.resolve(i):i instanceof yt||(n=i,i=this.cwd);let{withFileTypes:h=!0,follow:d=!1,filter:u,walkFilter:p}=n,m=new ce({objectMode:!0}),a=new Set;(!u||u(i))&&m.write(h?i:i.fullpath());let w=[i],k=0,S=()=>{let E=!1;for(;!E;){let A=w.shift();if(!A){k===0&&m.end();return}k++,a.add(A);let T=A.readdirSync();for(let R of T)(!u||u(R))&&(m.write(h?R:R.fullpath())||(E=!0));k--;for(let R of T){let L=R;if(R.isSymbolicLink()){if(!(d&&(L=R.realpathSync())))continue;L.isUnknown()&&L.lstatSync()}L.shouldWalk(a,p)&&w.push(L)}}E&&!m.flowing&&m.once("drain",S)};return S(),m}chdir(i=this.cwd){let n=this.cwd;this.cwd=typeof i=="string"?this.cwd.resolve(i):i,this.cwd[pn](n)}},Se=class extends Ii{sep="\\";constructor(i=process.cwd(),n={}){let{nocase:h=!0}=n;super(i,ws,"\\",{...n,nocase:h}),this.nocase=h;for(let d=this.cwd;d;d=d.parent)d.nocase=this.nocase}parseRootPath(i){return ws.parse(i).root.toUpperCase()}newRoot(i){return new Ti(this.rootPath,Vt,void 0,this.roots,this.nocase,this.childrenCache(),{fs:i})}isAbsolute(i){return i.startsWith("/")||i.startsWith("\\")||/^[a-z]:(\/|\\)/i.test(i)}},Ae=class extends Ii{sep="/";constructor(i=process.cwd(),n={}){let{nocase:h=!1}=n;super(i,Fh,"/",{...n,nocase:h}),this.nocase=h}parseRootPath(i){return"/"}newRoot(i){return new Ri(this.rootPath,Vt,void 0,this.roots,this.nocase,this.childrenCache(),{fs:i})}isAbsolute(i){return i.startsWith("/")}},Ke=class extends Ae{constructor(i=process.cwd(),n={}){let{nocase:h=!0}=n;super(i,{...n,nocase:h})}},P_=process.platform==="win32"?Ti:Ri,fn=process.platform==="win32"?Se:process.platform==="darwin"?Ke:Ae;N();var ia=c=>c.length>=1,sa=c=>c.length>=1,Ee=class c{#t;#e;#n;length;#s;#o;#b;#c;#d;#h;#a=!0;constructor(i,n,h,d){if(!ia(i))throw new TypeError("empty pattern list");if(!sa(n))throw new TypeError("empty glob list");if(n.length!==i.length)throw new TypeError("mismatched pattern list and glob list lengths");if(this.length=i.length,h<0||h>=this.length)throw new TypeError("index out of range");if(this.#t=i,this.#e=n,this.#n=h,this.#s=d,this.#n===0){if(this.isUNC()){let[u,p,m,a,...w]=this.#t,[k,S,E,A,...T]=this.#e;w[0]===""&&(w.shift(),T.shift());let R=[u,p,m,a,""].join("/"),L=[k,S,E,A,""].join("/");this.#t=[R,...w],this.#e=[L,...T],this.length=this.#t.length}else if(this.isDrive()||this.isAbsolute()){let[u,...p]=this.#t,[m,...a]=this.#e;p[0]===""&&(p.shift(),a.shift());let w=u+"/",k=m+"/";this.#t=[w,...p],this.#e=[k,...a],this.length=this.#t.length}}}pattern(){return this.#t[this.#n]}isString(){return typeof this.#t[this.#n]=="string"}isGlobstar(){return this.#t[this.#n]===pt}isRegExp(){return this.#t[this.#n]instanceof RegExp}globString(){return this.#b=this.#b||(this.#n===0?this.isAbsolute()?this.#e[0]+this.#e.slice(1).join("/"):this.#e.join("/"):this.#e.slice(this.#n).join("/"))}hasMore(){return this.length>this.#n+1}rest(){return this.#o!==void 0?this.#o:this.hasMore()?(this.#o=new c(this.#t,this.#e,this.#n+1,this.#s),this.#o.#h=this.#h,this.#o.#d=this.#d,this.#o.#c=this.#c,this.#o):this.#o=null}isUNC(){let i=this.#t;return this.#d!==void 0?this.#d:this.#d=this.#s==="win32"&&this.#n===0&&i[0]===""&&i[1]===""&&typeof i[2]=="string"&&!!i[2]&&typeof i[3]=="string"&&!!i[3]}isDrive(){let i=this.#t;return this.#c!==void 0?this.#c:this.#c=this.#s==="win32"&&this.#n===0&&this.length>1&&typeof i[0]=="string"&&/^[a-z]:$/i.test(i[0])}isAbsolute(){let i=this.#t;return this.#h!==void 0?this.#h:this.#h=i[0]===""&&i.length>1||this.isDrive()||this.isUNC()}root(){let i=this.#t[0];return typeof i=="string"&&this.isAbsolute()&&this.#n===0?i:""}checkFollowGlobstar(){return!(this.#n===0||!this.isGlobstar()||!this.#a)}markFollowGlobstar(){return this.#n===0||!this.isGlobstar()||!this.#a?!1:(this.#a=!1,!0)}};N();N();var ra=typeof process=="object"&&process&&typeof process.platform=="string"?process.platform:"linux",Ce=class{relative;relativeChildren;absolute;absoluteChildren;platform;mmopts;constructor(i,{nobrace:n,nocase:h,noext:d,noglobstar:u,platform:p=ra}){this.relative=[],this.absolute=[],this.relativeChildren=[],this.absoluteChildren=[],this.platform=p,this.mmopts={dot:!0,nobrace:n,nocase:h,noext:d,noglobstar:u,optimizationLevel:2,platform:p,nocomment:!0,nonegate:!0};for(let m of i)this.add(m)}add(i){let n=new Tt(i,this.mmopts);for(let h=0;h<n.set.length;h++){let d=n.set[h],u=n.globParts[h];if(!d||!u)throw new Error("invalid pattern object");for(;d[0]==="."&&u[0]===".";)d.shift(),u.shift();let p=new Ee(d,u,0,this.platform),m=new Tt(p.globString(),this.mmopts),a=u[u.length-1]==="**",w=p.isAbsolute();w?this.absolute.push(m):this.relative.push(m),a&&(w?this.absoluteChildren.push(m):this.relativeChildren.push(m))}}ignored(i){let n=i.fullpath(),h=`${n}/`,d=i.relative()||".",u=`${d}/`;for(let p of this.relative)if(p.match(d)||p.match(u))return!0;for(let p of this.absolute)if(p.match(n)||p.match(h))return!0;return!1}childrenIgnored(i){let n=i.fullpath()+"/",h=(i.relative()||".")+"/";for(let d of this.relativeChildren)if(d.match(h))return!0;for(let d of this.absoluteChildren)if(d.match(n))return!0;return!1}};N();var vs=class c{store;constructor(i=new Map){this.store=i}copy(){return new c(new Map(this.store))}hasWalked(i,n){return this.store.get(i.fullpath())?.has(n.globString())}storeWalked(i,n){let h=i.fullpath(),d=this.store.get(h);d?d.add(n.globString()):this.store.set(h,new Set([n.globString()]))}},xs=class{store=new Map;add(i,n,h){let d=(n?2:0)|(h?1:0),u=this.store.get(i);this.store.set(i,u===void 0?d:d&u)}entries(){return[...this.store.entries()].map(([i,n])=>[i,!!(n&2),!!(n&1)])}},ks=class{store=new Map;add(i,n){if(!i.canReaddir())return;let h=this.store.get(i);h?h.find(d=>d.globString()===n.globString())||h.push(n):this.store.set(i,[n])}get(i){let n=this.store.get(i);if(!n)throw new Error("attempting to walk unknown path");return n}entries(){return this.keys().map(i=>[i,this.store.get(i)])}keys(){return[...this.store.keys()].filter(i=>i.canReaddir())}},Ve=class c{hasWalkedCache;matches=new xs;subwalks=new ks;patterns;follow;dot;opts;constructor(i,n){this.opts=i,this.follow=!!i.follow,this.dot=!!i.dot,this.hasWalkedCache=n?n.copy():new vs}processPatterns(i,n){this.patterns=n;let h=n.map(d=>[i,d]);for(let[d,u]of h){this.hasWalkedCache.storeWalked(d,u);let p=u.root(),m=u.isAbsolute()&&this.opts.absolute!==!1;if(p){d=d.resolve(p==="/"&&this.opts.root!==void 0?this.opts.root:p);let S=u.rest();if(S)u=S;else{this.matches.add(d,!0,!1);continue}}if(d.isENOENT())continue;let a,w,k=!1;for(;typeof(a=u.pattern())=="string"&&(w=u.rest());)d=d.resolve(a),u=w,k=!0;if(a=u.pattern(),w=u.rest(),k){if(this.hasWalkedCache.hasWalked(d,u))continue;this.hasWalkedCache.storeWalked(d,u)}if(typeof a=="string"){let S=a===".."||a===""||a===".";this.matches.add(d.resolve(a),m,S);continue}else if(a===pt){(!d.isSymbolicLink()||this.follow||u.checkFollowGlobstar())&&this.subwalks.add(d,u);let S=w?.pattern(),E=w?.rest();if(!w||(S===""||S===".")&&!E)this.matches.add(d,m,S===""||S===".");else if(S===".."){let A=d.parent||d;E?this.hasWalkedCache.hasWalked(A,E)||this.subwalks.add(A,E):this.matches.add(A,m,!0)}}else a instanceof RegExp&&this.subwalks.add(d,u)}return this}subwalkTargets(){return this.subwalks.keys()}child(){return new c(this.opts,this.hasWalkedCache)}filterEntries(i,n){let h=this.subwalks.get(i),d=this.child();for(let u of n)for(let p of h){let m=p.isAbsolute(),a=p.pattern(),w=p.rest();a===pt?d.testGlobstar(u,p,w,m):a instanceof RegExp?d.testRegExp(u,a,w,m):d.testString(u,a,w,m)}return d}testGlobstar(i,n,h,d){if((this.dot||!i.name.startsWith("."))&&(n.hasMore()||this.matches.add(i,d,!1),i.canReaddir()&&(this.follow||!i.isSymbolicLink()?this.subwalks.add(i,n):i.isSymbolicLink()&&(h&&n.checkFollowGlobstar()?this.subwalks.add(i,h):n.markFollowGlobstar()&&this.subwalks.add(i,n)))),h){let u=h.pattern();if(typeof u=="string"&&u!==".."&&u!==""&&u!==".")this.testString(i,u,h.rest(),d);else if(u===".."){let p=i.parent||i;this.subwalks.add(p,h)}else u instanceof RegExp&&this.testRegExp(i,u,h.rest(),d)}}testRegExp(i,n,h,d){n.test(i.name)&&(h?this.subwalks.add(i,h):this.matches.add(i,d,!1))}testString(i,n,h,d){i.isNamed(n)&&(h?this.subwalks.add(i,h):this.matches.add(i,d,!1))}};var na=(c,i)=>typeof c=="string"?new Ce([c],i):Array.isArray(c)?new Ce(c,i):c,Di=class{path;patterns;opts;seen=new Set;paused=!1;aborted=!1;#t=[];#e;#n;signal;maxDepth;includeChildMatches;constructor(i,n,h){if(this.patterns=i,this.path=n,this.opts=h,this.#n=!h.posix&&h.platform==="win32"?"\\":"/",this.includeChildMatches=h.includeChildMatches!==!1,(h.ignore||!this.includeChildMatches)&&(this.#e=na(h.ignore??[],h),!this.includeChildMatches&&typeof this.#e.add!="function")){let d="cannot ignore child matches, ignore lacks add() method.";throw new Error(d)}this.maxDepth=h.maxDepth||1/0,h.signal&&(this.signal=h.signal,this.signal.addEventListener("abort",()=>{this.#t.length=0}))}#s(i){return this.seen.has(i)||!!this.#e?.ignored?.(i)}#o(i){return!!this.#e?.childrenIgnored?.(i)}pause(){this.paused=!0}resume(){if(this.signal?.aborted)return;this.paused=!1;let i;for(;!this.paused&&(i=this.#t.shift());)i()}onResume(i){this.signal?.aborted||(this.paused?this.#t.push(i):i())}async matchCheck(i,n){if(n&&this.opts.nodir)return;let h;if(this.opts.realpath){if(h=i.realpathCached()||await i.realpath(),!h)return;i=h}let u=i.isUnknown()||this.opts.stat?await i.lstat():i;if(this.opts.follow&&this.opts.nodir&&u?.isSymbolicLink()){let p=await u.realpath();p&&(p.isUnknown()||this.opts.stat)&&await p.lstat()}return this.matchCheckTest(u,n)}matchCheckTest(i,n){return i&&(this.maxDepth===1/0||i.depth()<=this.maxDepth)&&(!n||i.canReaddir())&&(!this.opts.nodir||!i.isDirectory())&&(!this.opts.nodir||!this.opts.follow||!i.isSymbolicLink()||!i.realpathCached()?.isDirectory())&&!this.#s(i)?i:void 0}matchCheckSync(i,n){if(n&&this.opts.nodir)return;let h;if(this.opts.realpath){if(h=i.realpathCached()||i.realpathSync(),!h)return;i=h}let u=i.isUnknown()||this.opts.stat?i.lstatSync():i;if(this.opts.follow&&this.opts.nodir&&u?.isSymbolicLink()){let p=u.realpathSync();p&&(p?.isUnknown()||this.opts.stat)&&p.lstatSync()}return this.matchCheckTest(u,n)}matchFinish(i,n){if(this.#s(i))return;if(!this.includeChildMatches&&this.#e?.add){let u=`${i.relativePosix()}/**`;this.#e.add(u)}let h=this.opts.absolute===void 0?n:this.opts.absolute;this.seen.add(i);let d=this.opts.mark&&i.isDirectory()?this.#n:"";if(this.opts.withFileTypes)this.matchEmit(i);else if(h){let u=this.opts.posix?i.fullpathPosix():i.fullpath();this.matchEmit(u+d)}else{let u=this.opts.posix?i.relativePosix():i.relative(),p=this.opts.dotRelative&&!u.startsWith(".."+this.#n)?"."+this.#n:"";this.matchEmit(u?p+u+d:"."+d)}}async match(i,n,h){let d=await this.matchCheck(i,h);d&&this.matchFinish(d,n)}matchSync(i,n,h){let d=this.matchCheckSync(i,h);d&&this.matchFinish(d,n)}walkCB(i,n,h){this.signal?.aborted&&h(),this.walkCB2(i,n,new Ve(this.opts),h)}walkCB2(i,n,h,d){if(this.#o(i))return d();if(this.signal?.aborted&&d(),this.paused){this.onResume(()=>this.walkCB2(i,n,h,d));return}h.processPatterns(i,n);let u=1,p=()=>{--u===0&&d()};for(let[m,a,w]of h.matches.entries())this.#s(m)||(u++,this.match(m,a,w).then(()=>p()));for(let m of h.subwalkTargets()){if(this.maxDepth!==1/0&&m.depth()>=this.maxDepth)continue;u++;let a=m.readdirCached();m.calledReaddir()?this.walkCB3(m,a,h,p):m.readdirCB((w,k)=>this.walkCB3(m,k,h,p),!0)}p()}walkCB3(i,n,h,d){h=h.filterEntries(i,n);let u=1,p=()=>{--u===0&&d()};for(let[m,a,w]of h.matches.entries())this.#s(m)||(u++,this.match(m,a,w).then(()=>p()));for(let[m,a]of h.subwalks.entries())u++,this.walkCB2(m,a,h.child(),p);p()}walkCBSync(i,n,h){this.signal?.aborted&&h(),this.walkCB2Sync(i,n,new Ve(this.opts),h)}walkCB2Sync(i,n,h,d){if(this.#o(i))return d();if(this.signal?.aborted&&d(),this.paused){this.onResume(()=>this.walkCB2Sync(i,n,h,d));return}h.processPatterns(i,n);let u=1,p=()=>{--u===0&&d()};for(let[m,a,w]of h.matches.entries())this.#s(m)||this.matchSync(m,a,w);for(let m of h.subwalkTargets()){if(this.maxDepth!==1/0&&m.depth()>=this.maxDepth)continue;u++;let a=m.readdirSync();this.walkCB3Sync(m,a,h,p)}p()}walkCB3Sync(i,n,h,d){h=h.filterEntries(i,n);let u=1,p=()=>{--u===0&&d()};for(let[m,a,w]of h.matches.entries())this.#s(m)||this.matchSync(m,a,w);for(let[m,a]of h.subwalks.entries())u++,this.walkCB2Sync(m,a,h.child(),p);p()}},Ye=class extends Di{matches=new Set;constructor(i,n,h){super(i,n,h)}matchEmit(i){this.matches.add(i)}async walk(){if(this.signal?.aborted)throw this.signal.reason;return this.path.isUnknown()&&await this.path.lstat(),await new Promise((i,n)=>{this.walkCB(this.path,this.patterns,()=>{this.signal?.aborted?n(this.signal.reason):i(this.matches)})}),this.matches}walkSync(){if(this.signal?.aborted)throw this.signal.reason;return this.path.isUnknown()&&this.path.lstatSync(),this.walkCBSync(this.path,this.patterns,()=>{if(this.signal?.aborted)throw this.signal.reason}),this.matches}},Xe=class extends Di{results;constructor(i,n,h){super(i,n,h),this.results=new ce({signal:this.signal,objectMode:!0}),this.results.on("drain",()=>this.resume()),this.results.on("resume",()=>this.resume())}matchEmit(i){this.results.write(i),this.results.flowing||this.pause()}stream(){let i=this.path;return i.isUnknown()?i.lstat().then(()=>{this.walkCB(i,this.patterns,()=>this.results.end())}):this.walkCB(i,this.patterns,()=>this.results.end()),this.results}streamSync(){return this.path.isUnknown()&&this.path.lstatSync(),this.walkCBSync(this.path,this.patterns,()=>this.results.end()),this.results}};var ha=typeof process=="object"&&process&&typeof process.platform=="string"?process.platform:"linux",jt=class{absolute;cwd;root;dot;dotRelative;follow;ignore;magicalBraces;mark;matchBase;maxDepth;nobrace;nocase;nodir;noext;noglobstar;pattern;platform;realpath;scurry;stat;signal;windowsPathsNoEscape;withFileTypes;includeChildMatches;opts;patterns;constructor(i,n){if(!n)throw new TypeError("glob options required");if(this.withFileTypes=!!n.withFileTypes,this.signal=n.signal,this.follow=!!n.follow,this.dot=!!n.dot,this.dotRelative=!!n.dotRelative,this.nodir=!!n.nodir,this.mark=!!n.mark,n.cwd?(n.cwd instanceof URL||n.cwd.startsWith("file://"))&&(n.cwd=oa(n.cwd)):this.cwd="",this.cwd=n.cwd||"",this.root=n.root,this.magicalBraces=!!n.magicalBraces,this.nobrace=!!n.nobrace,this.noext=!!n.noext,this.realpath=!!n.realpath,this.absolute=n.absolute,this.includeChildMatches=n.includeChildMatches!==!1,this.noglobstar=!!n.noglobstar,this.matchBase=!!n.matchBase,this.maxDepth=typeof n.maxDepth=="number"?n.maxDepth:1/0,this.stat=!!n.stat,this.ignore=n.ignore,this.withFileTypes&&this.absolute!==void 0)throw new Error("cannot set absolute and withFileTypes:true");if(typeof i=="string"&&(i=[i]),this.windowsPathsNoEscape=!!n.windowsPathsNoEscape||n.allowWindowsEscape===!1,this.windowsPathsNoEscape&&(i=i.map(a=>a.replace(/\\/g,"/"))),this.matchBase){if(n.noglobstar)throw new TypeError("base matching requires globstar");i=i.map(a=>a.includes("/")?a:`./**/${a}`)}if(this.pattern=i,this.platform=n.platform||ha,this.opts={...n,platform:this.platform},n.scurry){if(this.scurry=n.scurry,n.nocase!==void 0&&n.nocase!==n.scurry.nocase)throw new Error("nocase option contradicts provided scurry option")}else{let a=n.platform==="win32"?Se:n.platform==="darwin"?Ke:n.platform?Ae:fn;this.scurry=new a(this.cwd,{nocase:n.nocase,fs:n.fs})}this.nocase=this.scurry.nocase;let h=this.platform==="darwin"||this.platform==="win32",d={...n,dot:this.dot,matchBase:this.matchBase,nobrace:this.nobrace,nocase:this.nocase,nocaseMagicOnly:h,nocomment:!0,noext:this.noext,nonegate:!0,optimizationLevel:2,platform:this.platform,windowsPathsNoEscape:this.windowsPathsNoEscape,debug:!!this.opts.debug},u=this.pattern.map(a=>new Tt(a,d)),[p,m]=u.reduce((a,w)=>(a[0].push(...w.set),a[1].push(...w.globParts),a),[[],[]]);this.patterns=p.map((a,w)=>{let k=m[w];if(!k)throw new Error("invalid pattern object");return new Ee(a,k,0,this.platform)})}async walk(){return[...await new Ye(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).walk()]}walkSync(){return[...new Ye(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).walkSync()]}stream(){return new Xe(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).stream()}streamSync(){return new Xe(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).streamSync()}iterateSync(){return this.streamSync()[Symbol.iterator]()}[Symbol.iterator](){return this.iterateSync()}iterate(){return this.stream()[Symbol.asyncIterator]()}[Symbol.asyncIterator](){return this.iterate()}};N();var Ss=(c,i={})=>{Array.isArray(c)||(c=[c]);for(let n of c)if(new Tt(n,i).hasMagic())return!0;return!1};function Mi(c,i={}){return new jt(c,i).streamSync()}function gn(c,i={}){return new jt(c,i).stream()}function yn(c,i={}){return new jt(c,i).walkSync()}async function mn(c,i={}){return new jt(c,i).walk()}function zi(c,i={}){return new jt(c,i).iterateSync()}function wn(c,i={}){return new jt(c,i).iterate()}var aa=Mi,ca=Object.assign(gn,{sync:Mi}),_a=zi,da=Object.assign(wn,{sync:zi}),ua=Object.assign(yn,{stream:Mi,iterate:zi}),Oi=Object.assign(mn,{glob:mn,globSync:yn,sync:ua,globStream:gn,stream:ca,globStreamSync:Mi,streamSync:aa,globIterate:wn,iterate:da,globIterateSync:zi,iterateSync:_a,Glob:jt,hasMagic:Ss,escape:we,unescape:qt});Oi.glob=Oi;import bn from"path";import{fileURLToPath as la}from"url";function Pi(c){return bn.dirname(la(c))}async function vn(...c){let i=[];return await Promise.all(c.map(async n=>{(await Oi(n.split(bn.sep).join("/"))).forEach(d=>{i.includes(d)||i.push(`file://${d}`)})})),i}N();N();var xn=(c=0)=>i=>`\x1B[${i+c}m`,kn=(c=0)=>i=>`\x1B[${38+c};5;${i}m`,Sn=(c=0)=>(i,n,h)=>`\x1B[${38+c};2;${i};${n};${h}m`,tt={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},kd=Object.keys(tt.modifier),pa=Object.keys(tt.color),fa=Object.keys(tt.bgColor),Sd=[...pa,...fa];function ma(){let c=new Map;for(let[i,n]of Object.entries(tt)){for(let[h,d]of Object.entries(n))tt[h]={open:`\x1B[${d[0]}m`,close:`\x1B[${d[1]}m`},n[h]=tt[h],c.set(d[0],d[1]);Object.defineProperty(tt,i,{value:n,enumerable:!1})}return Object.defineProperty(tt,"codes",{value:c,enumerable:!1}),tt.color.close="\x1B[39m",tt.bgColor.close="\x1B[49m",tt.color.ansi=xn(),tt.color.ansi256=kn(),tt.color.ansi16m=Sn(),tt.bgColor.ansi=xn(10),tt.bgColor.ansi256=kn(10),tt.bgColor.ansi16m=Sn(10),Object.defineProperties(tt,{rgbToAnsi256:{value(i,n,h){return i===n&&n===h?i<8?16:i>248?231:Math.round((i-8)/247*24)+232:16+36*Math.round(i/255*5)+6*Math.round(n/255*5)+Math.round(h/255*5)},enumerable:!1},hexToRgb:{value(i){let n=/[a-f\d]{6}|[a-f\d]{3}/i.exec(i.toString(16));if(!n)return[0,0,0];let[h]=n;h.length===3&&(h=[...h].map(u=>u+u).join(""));let d=Number.parseInt(h,16);return[d>>16&255,d>>8&255,d&255]},enumerable:!1},hexToAnsi256:{value:i=>tt.rgbToAnsi256(...tt.hexToRgb(i)),enumerable:!1},ansi256ToAnsi:{value(i){if(i<8)return 30+i;if(i<16)return 90+(i-8);let n,h,d;if(i>=232)n=((i-232)*10+8)/255,h=n,d=n;else{i-=16;let m=i%36;n=Math.floor(i/36)/5,h=Math.floor(m/6)/5,d=m%6/5}let u=Math.max(n,h,d)*2;if(u===0)return 30;let p=30+(Math.round(d)<<2|Math.round(h)<<1|Math.round(n));return u===2&&(p+=60),p},enumerable:!1},rgbToAnsi:{value:(i,n,h)=>tt.ansi256ToAnsi(tt.rgbToAnsi256(i,n,h)),enumerable:!1},hexToAnsi:{value:i=>tt.ansi256ToAnsi(tt.hexToAnsi256(i)),enumerable:!1}}),tt}var ga=ma(),Wt=ga;N();import As from"node:process";import ya from"node:os";import An from"node:tty";function zt(c,i=globalThis.Deno?globalThis.Deno.args:As.argv){let n=c.startsWith("-")?"":c.length===1?"-":"--",h=i.indexOf(n+c),d=i.indexOf("--");return h!==-1&&(d===-1||h<d)}var{env:et}=As,Li;zt("no-color")||zt("no-colors")||zt("color=false")||zt("color=never")?Li=0:(zt("color")||zt("colors")||zt("color=true")||zt("color=always"))&&(Li=1);function wa(){if("FORCE_COLOR"in et)return et.FORCE_COLOR==="true"?1:et.FORCE_COLOR==="false"?0:et.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(et.FORCE_COLOR,10),3)}function ba(c){return c===0?!1:{level:c,hasBasic:!0,has256:c>=2,has16m:c>=3}}function va(c,{streamIsTTY:i,sniffFlags:n=!0}={}){let h=wa();h!==void 0&&(Li=h);let d=n?Li:h;if(d===0)return 0;if(n){if(zt("color=16m")||zt("color=full")||zt("color=truecolor"))return 3;if(zt("color=256"))return 2}if("TF_BUILD"in et&&"AGENT_NAME"in et)return 1;if(c&&!i&&d===void 0)return 0;let u=d||0;if(et.TERM==="dumb")return u;if(As.platform==="win32"){let p=ya.release().split(".");return Number(p[0])>=10&&Number(p[2])>=10586?Number(p[2])>=14931?3:2:1}if("CI"in et)return"GITHUB_ACTIONS"in et||"GITEA_ACTIONS"in et?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some(p=>p in et)||et.CI_NAME==="codeship"?1:u;if("TEAMCITY_VERSION"in et)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(et.TEAMCITY_VERSION)?1:0;if(et.COLORTERM==="truecolor"||et.TERM==="xterm-kitty")return 3;if("TERM_PROGRAM"in et){let p=Number.parseInt((et.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(et.TERM_PROGRAM){case"iTerm.app":return p>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(et.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(et.TERM)||"COLORTERM"in et?1:u}function En(c,i={}){let n=va(c,{streamIsTTY:c&&c.isTTY,...i});return ba(n)}var xa={stdout:En({isTTY:An.isatty(1)}),stderr:En({isTTY:An.isatty(2)})},Cn=xa;N();function Tn(c,i,n){let h=c.indexOf(i);if(h===-1)return c;let d=i.length,u=0,p="";do p+=c.slice(u,h)+i+n,u=h+d,h=c.indexOf(i,u);while(h!==-1);return p+=c.slice(u),p}function Rn(c,i,n,h){let d=0,u="";do{let p=c[h-1]==="\r";u+=c.slice(d,p?h-1:h)+i+(p?`\r
`:`
`)+n,d=h+1,h=c.indexOf(`
`,d)}while(h!==-1);return u+=c.slice(d),u}var{stdout:In,stderr:Dn}=Cn,Es=Symbol("GENERATOR"),Te=Symbol("STYLER"),Qe=Symbol("IS_EMPTY"),On=["ansi","ansi","ansi256","ansi16m"],Re=Object.create(null),ka=(c,i={})=>{if(i.level&&!(Number.isInteger(i.level)&&i.level>=0&&i.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let n=In?In.level:0;c.level=i.level===void 0?n:i.level};var Sa=c=>{let i=(...n)=>n.join(" ");return ka(i,c),Object.setPrototypeOf(i,Je.prototype),i};function Je(c){return Sa(c)}Object.setPrototypeOf(Je.prototype,Function.prototype);for(let[c,i]of Object.entries(Wt))Re[c]={get(){let n=Ni(this,Ts(i.open,i.close,this[Te]),this[Qe]);return Object.defineProperty(this,c,{value:n}),n}};Re.visible={get(){let c=Ni(this,this[Te],!0);return Object.defineProperty(this,"visible",{value:c}),c}};var Cs=(c,i,n,...h)=>c==="rgb"?i==="ansi16m"?Wt[n].ansi16m(...h):i==="ansi256"?Wt[n].ansi256(Wt.rgbToAnsi256(...h)):Wt[n].ansi(Wt.rgbToAnsi(...h)):c==="hex"?Cs("rgb",i,n,...Wt.hexToRgb(...h)):Wt[n][c](...h),Aa=["rgb","hex","ansi256"];for(let c of Aa){Re[c]={get(){let{level:n}=this;return function(...h){let d=Ts(Cs(c,On[n],"color",...h),Wt.color.close,this[Te]);return Ni(this,d,this[Qe])}}};let i="bg"+c[0].toUpperCase()+c.slice(1);Re[i]={get(){let{level:n}=this;return function(...h){let d=Ts(Cs(c,On[n],"bgColor",...h),Wt.bgColor.close,this[Te]);return Ni(this,d,this[Qe])}}}}var Ea=Object.defineProperties(()=>{},{...Re,level:{enumerable:!0,get(){return this[Es].level},set(c){this[Es].level=c}}}),Ts=(c,i,n)=>{let h,d;return n===void 0?(h=c,d=i):(h=n.openAll+c,d=i+n.closeAll),{open:c,close:i,openAll:h,closeAll:d,parent:n}},Ni=(c,i,n)=>{let h=(...d)=>Ca(h,d.length===1?""+d[0]:d.join(" "));return Object.setPrototypeOf(h,Ea),h[Es]=c,h[Te]=i,h[Qe]=n,h},Ca=(c,i)=>{if(c.level<=0||!i)return c[Qe]?"":i;let n=c[Te];if(n===void 0)return i;let{openAll:h,closeAll:d}=n;if(i.includes("\x1B"))for(;n!==void 0;)i=Tn(i,n.close,n.open),n=n.parent;let u=i.indexOf(`
`);return u!==-1&&(i=Rn(i,d,h,u)),h+i+d};Object.defineProperties(Je.prototype,Re);var Ta=Je(),Nd=Je({level:Dn?Dn.level:0});var dt=Ta;N();N();var Rs=c=>Array.isArray(c)?c:[c],Mn=c=>c.replace(/[\W_]([a-z\d])?/gi,(i,n)=>n?n.toUpperCase():"");function Ra(c,i){return i.length!==c.length?!1:c.every((n,h)=>n===i[h])}function zn(c,i){return i.length>c.length?!1:Ra(c.slice(0,i.length),i)}N();function Is(c){if(c===null||typeof c!="object")return!1;let i=Object.getPrototypeOf(c);return i!==null&&i!==Object.prototype&&Object.getPrototypeOf(i)!==null||Symbol.iterator in c?!1:Symbol.toStringTag in c?Object.prototype.toString.call(c)==="[object Module]":!0}function Ds(c,i,n=".",h){if(!Is(i))return Ds(c,{},n,h);let d=Object.assign({},i);for(let u in c){if(u==="__proto__"||u==="constructor")continue;let p=c[u];p!=null&&(h&&h(d,u,p,n)||(Array.isArray(p)&&Array.isArray(d[u])?d[u]=[...p,...d[u]]:Is(p)&&Is(d[u])?d[u]=Ds(p,d[u],(n?`${n}.`:"")+u.toString(),h):d[u]=p))}return d}function Os(c){return(...i)=>i.reduce((n,h)=>Ds(n,h,"",c),{})}var Ia=Os(),jd=Os((c,i,n)=>{if(c[i]!==void 0&&typeof n=="function")return c[i]=n(c[i]),!0}),Wd=Os((c,i,n)=>{if(Array.isArray(c[i])&&typeof n=="function")return c[i]=n(c[i]),!0});N();var Da="known-flag",Oa="unknown-flag",Ma="argument",{stringify:Ze}=JSON,za=/\B([A-Z])/g,Pa=c=>c.replace(za,"-$1").toLowerCase(),{hasOwnProperty:La}=Object.prototype,ti=(c,i)=>La.call(c,i),Na=c=>Array.isArray(c),Pn=c=>typeof c=="function"?[c,!1]:Na(c)?[c[0],!0]:Pn(c.type),Ua=(c,i)=>c===Boolean?i!=="false":i,qa=(c,i)=>typeof i=="boolean"?i:c===Number&&i===""?Number.NaN:c(i),Fa=/[\s.:=]/,Ba=c=>{let i=`Flag name ${Ze(c)}`;if(c.length===0)throw new Error(`${i} cannot be empty`);if(c.length===1)throw new Error(`${i} must be longer than a character`);let n=c.match(Fa);if(n)throw new Error(`${i} cannot contain ${Ze(n?.[0])}`)},ja=c=>{let i={},n=(h,d)=>{if(ti(i,h))throw new Error(`Duplicate flags named ${Ze(h)}`);i[h]=d};for(let h in c){if(!ti(c,h))continue;Ba(h);let d=c[h],u=[[],...Pn(d),d];n(h,u);let p=Pa(h);if(h!==p&&n(p,u),"alias"in d&&typeof d.alias=="string"){let{alias:m}=d,a=`Flag alias ${Ze(m)} for flag ${Ze(h)}`;if(m.length===0)throw new Error(`${a} cannot be empty`);if(m.length>1)throw new Error(`${a} must be a single character`);n(m,u)}}return i},Wa=(c,i)=>{let n={};for(let h in c){if(!ti(c,h))continue;let[d,,u,p]=i[h];if(d.length===0&&"default"in p){let{default:m}=p;typeof m=="function"&&(m=m()),n[h]=m}else n[h]=u?d:d.pop()}return n},Ui="--",Ga=/[.:=]/,$a=/^-{1,2}\w/,Ha=c=>{if(!$a.test(c))return;let i=!c.startsWith(Ui),n=c.slice(i?1:2),h,d=n.match(Ga);if(d){let{index:u}=d;h=n.slice(u+1),n=n.slice(0,u)}return[n,h,i]},Ka=(c,{onFlag:i,onArgument:n})=>{let h,d=(u,p)=>{if(typeof h!="function")return!0;h(u,p),h=void 0};for(let u=0;u<c.length;u+=1){let p=c[u];if(p===Ui){d();let a=c.slice(u+1);n?.(a,[u],!0);break}let m=Ha(p);if(m){if(d(),!i)continue;let[a,w,k]=m;if(k)for(let S=0;S<a.length;S+=1){d();let E=S===a.length-1;h=i(a[S],E?w:void 0,[u,S+1,E])}else h=i(a,w,[u])}else d(p,[u])&&n?.([p],[u])}d()},Va=(c,i)=>{for(let[n,h,d]of i.reverse()){if(h){let u=c[n],p=u.slice(0,h);if(d||(p+=u.slice(h+1)),p!=="-"){c[n]=p;continue}}c.splice(n,1)}},Ms=(c,i=process.argv.slice(2),{ignore:n}={})=>{let h=[],d=ja(c),u={},p=[];return p[Ui]=[],Ka(i,{onFlag(m,a,w){let k=ti(d,m);if(!n?.(k?Da:Oa,m,a)){if(k){let[S,E]=d[m],A=Ua(E,a),T=(R,L)=>{h.push(w),L&&h.push(L),S.push(qa(E,R||""))};return A===void 0?T:T(A)}ti(u,m)||(u[m]=[]),u[m].push(a===void 0?!0:a),h.push(w)}},onArgument(m,a,w){n?.(Ma,i[a[0]])||(p.push(...m),w?(p[Ui]=m,i.splice(a[0])):h.push(a))}}),Va(i,h),{flags:Wa(c,d),unknownFlags:u,_:p}};var ii=JSON.stringify,Ls=class extends Error{constructor(i,n){super(n("core.commandExists",ii(i))),this.commandName=i}},Ns=class extends Error{constructor(i,n){super(n("core.noSuchCommand",ii(i))),this.commandName=i}},Us=class extends Error{constructor(i){super(i("core.noCommandGiven"))}},qs=class extends Error{constructor(i,n,h){super(h("core.commandNameConflict",ii(i),ii(n))),this.n1=i,this.n2=n}},Fs=class extends Error{constructor(i){super(i("core.scriptNameNotSet"))}},Bs=class extends Error{constructor(i){super(i("core.descriptionNotSet"))}},js=class extends Error{constructor(i){super(i("core.versionNotSet"))}},Ws=class extends Error{constructor(i,n){super(n("core.badNameFormat",ii(i))),this.commandName=i}};var Ya={en:{"core.commandExists":'Command "%s" exists.',"core.noSuchCommand":"No such command: %s.","core.noCommandGiven":"No command given.","core.commandNameConflict":"Command name %s conflicts with %s. Maybe caused by alias.","core.scriptNameNotSet":"Name not set.","core.descriptionNotSet":"Description not set.","core.versionNotSet":"Version not set.","core.badNameFormat":"Bad name format: %s.","core.localeMustBeCalledFirst":"locale() or fallbackLocale() must be called at first.","core.cliParseMustBeCalled":"cli.parse() must be called.","core.spreadParameterMustBeLast":"Invalid Parameter: Spread parameter %s must be last.","core.requiredParameterCannotComeAfterOptionalParameter":"Invalid Parameter: Required parameter %s cannot come after optional parameter %s.","core.parameterMustBeWrappedInBrackets":"Invalid Parameter: Parameter %s must be wrapped in <> (required parameter) or [] (optional parameter).","core.parameterIsUsedMoreThanOnce":"Invalid Parameter: Parameter %s is used more than once.","core.missingRequiredParameter":"Missing required parameter %s."},"zh-CN":{"core.commandExists":'\u547D\u4EE4 "%s" \u5DF2\u5B58\u5728\u3002',"core.noSuchCommand":"\u627E\u4E0D\u5230\u547D\u4EE4: %s\u3002","core.noCommandGiven":"\u6CA1\u6709\u8F93\u5165\u547D\u4EE4\u3002","core.commandNameConflict":"\u547D\u4EE4\u540D\u79F0 %s \u548C %s \u51B2\u7A81\u3002 \u53EF\u80FD\u662F\u7531\u4E8E\u522B\u540D\u5BFC\u81F4\u7684\u3002","core.scriptNameNotSet":"\u672A\u8BBE\u7F6E CLI Script \u540D\u79F0\u3002","core.descriptionNotSet":"\u672A\u8BBE\u7F6E CLI \u63CF\u8FF0\u3002","core.versionNotSet":"\u672A\u8BBE\u7F6E CLI \u7248\u672C\u3002","core.badNameFormat":"\u9519\u8BEF\u7684\u547D\u4EE4\u540D\u5B57\u683C\u5F0F: %s\u3002","core.localeMustBeCalledFirst":"locale() \u6216 fallbackLocale() \u5FC5\u987B\u5728\u6700\u5F00\u59CB\u8C03\u7528\u3002","core.cliParseMustBeCalled":"cli.parse() \u5FC5\u987B\u88AB\u8C03\u7528\u3002","core.spreadParameterMustBeLast":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u5C55\u5F00\u53C2\u6570 %s \u5FC5\u987B\u5728\u6700\u540E\u3002","core.requiredParameterCannotComeAfterOptionalParameter":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u5FC5\u586B\u53C2\u6570 %s \u4E0D\u80FD\u5728\u53EF\u9009\u53C2\u6570 %s \u4E4B\u540E\u3002","core.parameterMustBeWrappedInBrackets":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u53C2\u6570 %s \u5FC5\u987B\u88AB <> (\u5FC5\u586B\u53C2\u6570) \u6216 [] (\u53EF\u9009\u53C2\u6570) \u5305\u88F9\u3002","core.parameterIsUsedMoreThanOnce":"\u4E0D\u5408\u6CD5\u7684\u53C2\u6570: \u53C2\u6570 %s \u88AB\u4F7F\u7528\u4E86\u591A\u6B21\u3002","core.missingRequiredParameter":"\u7F3A\u5C11\u5FC5\u586B\u53C2\u6570 %s\u3002"}},{stringify:Ie}=JSON;function zs(c,i){let n=[],h,d;for(let u of c){if(d)throw new Error(i("core.spreadParameterMustBeLast",Ie(d)));let p=u[0],m=u[u.length-1],a;if(p==="<"&&m===">"&&(a=!0,h))throw new Error(i("core.requiredParameterMustBeBeforeOptional",Ie(u),Ie(h)));if(p==="["&&m==="]"&&(a=!1,h=u),a===void 0)throw new Error(i("core.parameterMustBeWrappedInBrackets",Ie(u)));let w=u.slice(1,-1),k=w.slice(-3)==="...";k&&(d=u,w=w.slice(0,-3)),n.push({name:w,required:a,spread:k})}return n}function Ps(c,i,n,h){for(let d=0;d<i.length;d+=1){let{name:u,required:p,spread:m}=i[d],a=Mn(u);if(a in c)throw new Error(h("core.parameterIsUsedMoreThanOnce",Ie(u)));let w=m?n.slice(d):n[d];if(m&&(d=i.length),p&&(!w||m&&w.length===0))throw new Error(h("core.missingRequiredParameter",Ie(u)));c[a]=w}}function Ln(c,i,n,h){if(n.alias){let d=Rs(n.alias);for(let u of d){if(u in i)throw new qs(i[u].name,n.name,h);c.set(typeof u=="symbol"?u:u.split(" "),{...n,__isAlias:!0})}}}function Xa(c,i){let n=new Map;c[kt]&&(n.set(kt,c[kt]),Ln(n,c,c[kt],i));for(let h of Object.values(c))Ln(n,c,h,i),n.set(h.name.split(" "),h);return n}function Qa(c,i,n){var h;let d=Xa(c,n);for(let[u,p]of d.entries()){let m=Ms((h=p?.flags)!=null?h:Object.create(null),[...i]),{_:a}=m;if(u!==kt&&zn(a,u))return[p,u]}return d.has(kt)?[d.get(kt),kt]:[void 0,void 0]}function Ja(c){let i={pre:[],normal:[],post:[]};for(let h of c){let d=typeof h=="object"?h:{fn:h},{enforce:u,fn:p}=d;u==="post"||u==="pre"?i[u].push(p):i.normal.push(p)}let n=[...i.pre,...i.normal,...i.post];return h=>{return d(0);function d(u){let p=n[u];return p(h,d.bind(null,u+1))}}}var Za=/\s{2,}/,tc=c=>c===kt?!0:!(c.startsWith(" ")||c.endsWith(" "))&&!Za.test(c);var ec="<Root>",ic=c=>Array.isArray(c)?c.join(" "):typeof c=="string"?c:ec;var sc=c=>c.filter(i=>!i.startsWith("-")),$s=(c,i,n)=>{if(!i.has(c))throw TypeError("Cannot "+n)},ut=(c,i,n)=>($s(c,i,"read from private field"),n?n.call(c):i.get(c));var rc=(c,i,n,h)=>($s(c,i,"write to private field"),h?h.call(c,n):i.set(c,n),n),qi=(c,i,n)=>($s(c,i,"access private method"),n),nc,Nn,Un,qn,Fn,Hs,Bn,jn,ei,Ks,Gs,Wn,oc,hc,ac,Gn,$n,Hn,Kn,cc,_c,Vs,Ys,dc,uc,lc,pc,Vn,Yn,Xn,Qn,fc,mc,gc,yc,kt=Symbol.for("Clerc.Root");nc=new WeakMap;Nn=new WeakMap;Un=new WeakMap;qn=new WeakMap;Fn=new WeakMap;Hs=new WeakMap;Bn=new WeakMap;jn=new WeakMap;ei=new WeakMap;Ks=new WeakMap;Gs=new WeakMap;Wn=new WeakMap;oc=new WeakMap;hc=new WeakMap;ac=new WeakMap;Gn=new WeakSet;$n=function(){return ut(this,ei).has(kt)};Hn=new WeakSet;Kn=function(){return Object.prototype.hasOwnProperty.call(this._commands,kt)};cc=new WeakSet;_c=function(){this.i18n.add(Ya)};Vs=new WeakSet;Ys=function(){rc(this,Wn,!0)};dc=new WeakSet;uc=function(c,i,n={}){qi(this,Vs,Ys).call(this);let{t:h}=this.i18n,u=(S=>!(typeof S=="string"||S===kt))(c),p=u?c.name:c;if(!tc(p))throw new Ws(p,h);let{handler:m=void 0,...a}=u?c:{name:p,description:i,...n},w=[a.name],k=a.alias?Rs(a.alias):[];a.alias&&w.push(...k);for(let S of w)if(ut(this,ei).has(S))throw new Ls(ic(S),h);ut(this,Hs)[p]=a,ut(this,ei).add(a.name);for(let S of k)ut(this,ei).add(S);return u&&m&&this.on(c.name,m),this};lc=new WeakSet;pc=function(){let{t:c}=this.i18n;if(!ut(this,Nn))throw new Fs(c);if(!ut(this,Un))throw new Bs(c);if(!ut(this,qn))throw new js(c)};Vn=new WeakSet;Yn=function(c){var i;let n=ut(this,Ks),{t:h}=this.i18n,[d,u]=c(),p=!!d,m={...ut(this,jn),...d?.flags},a=Ms(m,[...n]),w=d?.name===kt||u===kt?0:u?.length?u.length:d?.name.split(" ").length,{_:k,flags:S,unknownFlags:E}=a,A=!p||d.name===kt?k:k.slice(w),T=(i=d?.parameters)!=null?i:[],R=T.indexOf("--"),L=T.slice(R+1)||[],z=Object.create(null);if(R>-1&&L.length>0){T=T.slice(0,R);let H=k["--"];A=A.slice(0,-H.length||void 0),Ps(z,zs(T,h),A,h),Ps(z,zs(L,h),H,h)}else Ps(z,zs(T,h),A,h);let G={...S,...E};return{name:d?.name,called:Array.isArray(u)?u.join(" "):u,resolved:p,hasRootOrAlias:ut(this,Gn,$n),hasRoot:ut(this,Hn,Kn),raw:{...a,parameters:A,mergedFlags:G},parameters:z,flags:S,unknownFlags:E,cli:this}};Xn=new WeakSet;Qn=function(c){if(ut(this,Gs).length>0)for(let i of ut(this,Gs))i(c);else throw c};fc=new WeakSet;mc=function(c){try{c()}catch(i){qi(this,Xn,Qn).call(this,i)}};gc=new WeakSet;yc=function(){qi(this,Vs,Ys).call(this);let{t:c}=this.i18n,i=ut(this,Ks);if(!i)throw new Error(c("core.cliParseMustBeCalled"));let n=()=>Qa(ut(this,Hs),i,c),h=()=>qi(this,Vn,Yn).call(this,n),d={enforce:"post",fn:m=>{let[a]=n(),w=sc(i).join(" ");if(!a)throw w?new Ns(w,c):new Us(c);ut(this,Bn).emit(a.name,m)}},u=[...ut(this,Fn),d];Ja(u)(h())};var Jn=(c,i)=>({...c,handler:i});import{existsSync as fo}from"fs";import{readFile as mo,writeFile as go}from"fs/promises";import Gt from"path";N();import{homedir as wc}from"os";import Zn from"path";var bc=await vn(`${Pi(import.meta.url)}/commands/*.{ts,js}`),vc=Zn.join(wc(),".tdb"),It=Zn.join(vc,"data"),iu=await Promise.all(bc.map(async c=>{let{command:i}=await import(c);return i}));N();import{createServer as xc}from"net";function to(c){return new Promise((i,n)=>{let h=xc().once("error",d=>{if(d.code!="EADDRINUSE"){n(d);return}i(!0)}).once("listening",function(){h.once("close",function(){i(!1)}).close()}).listen(c,"127.0.0.1")})}N();import{writeFile as Oc}from"fs/promises";import Mc from"path";N();var ho=fi(Xs(),1);import{randomInt as Dc}from"crypto";import*as oo from"fs";import*as Ki from"net";import*as ao from"tls";import*as co from"util";N();var io=fi(Xs(),1);import{randomInt as eo}from"crypto";var Qs=192,Js=219,kc=220,Sc=221;function Ac(c){let i=[Qs];for(let n of c)n===Qs?i.push(Js,kc):n===Js?i.push(Js,Sc):i.push(n);return i.push(Qs),Buffer.from(i)}function Fi(c){let i=c[0]>>4&15,n=(c[0]&15)*4,h=c.readUInt16BE(2),d=c[9],u=c.slice(12,16).join("."),p=c.slice(16,20).join(".");return{version:i,headerLength:n,totalLength:h,protocol:d,srcIP:u,dstIP:p,payload:c.slice(n,h)}}function Bi(c){let i=c.readUInt16BE(0),n=c.readUInt16BE(2),h=c.readUInt32BE(4),d=c.readUInt32BE(8),u=(c[12]>>4&15)*4,p=c[13],m=c.readUInt16BE(14);return{srcPort:i,dstPort:n,seqNumber:h,ackNumber:d,headerLength:u,flags:p,windowSize:m,payload:c.slice(u)}}function Ec(c){let i=0;for(let n=0;n<c.length;n+=2)i+=c.readUInt16BE(n);return i=(i>>16)+(i&65535),i+=i>>16,~i&65535}function ji(c,i,n){let h=Buffer.alloc(12);c.split(".").forEach((p,m)=>{h[m]=parseInt(p)}),i.split(".").forEach((p,m)=>{h[4+m]=parseInt(p)}),h[8]=0,h[9]=6,h.writeUInt16BE(n.length,10);let d=Buffer.concat([h,n]),u=0;for(let p=0;p<d.length;p+=2)p===d.length-1?u+=d[p]<<8:u+=d.readUInt16BE(p);return u=(u>>16)+(u&65535),u+=u>>16,~u&65535}function Wi(c,i,n,h,d,u,p){let a=20+p.length,w=Buffer.alloc(a);return w.writeUInt16BE(i,0),w.writeUInt16BE(c,2),w.writeUInt32BE(n,4),w.writeUInt32BE(h,8),w[12]=20/4<<4,w[13]=d,w.writeUInt16BE(u,14),w.writeUInt16BE(0,16),w.writeUInt16BE(0,18),p.copy(w,20),w}function Gi(c,i,n,h){let u=20+h.length,p=Buffer.alloc(u);p[0]=69,p[1]=0,p.writeUInt16BE(u,2),p.writeUInt16BE(eo(65536),4),p.writeUInt16BE(16384,6),p[8]=64,p[9]=n,p.writeUInt16BE(0,10),c.split(".").forEach((a,w)=>{p[12+w]=parseInt(a)}),i.split(".").forEach((a,w)=>{p[16+w]=parseInt(a)});let m=Ec(p.slice(0,20));return p.writeUInt16BE(m,10),h.copy(p,20),p}function $i(c,i){tr(c);let n=Ac(c);i.serial_send_bytes(1,n)}async function so(c,i,n,h,d){let p=eo(4294967295),m=Wi(n,h,p,0,2,64240,Buffer.alloc(0)),a=ji(c,i,m);m.writeUInt16BE(a,16);let w=Gi(c,i,6,m);$i(w,d);let k=await Tc(d,c,i,n,h,p);return[p+1,k]}function Cc(c){return["FIN","SYN","RST","PSH","ACK","URG","ECE","CWR"].filter((n,h)=>c>>h&1)}function Tc(c,i,n,h,d,u){return new Promise((p,m)=>{let a=new io.default.Decoder({maxMessageSize:209715200,bufferSize:2048,onMessage:k=>{let S=Fi(Buffer.from(k));if(S.protocol===6){let E=Bi(S.payload);if(E.flags===18&&E.ackNumber===u+1){let T=Wi(h,d,u+1,E.seqNumber+1,16,64240,Buffer.alloc(0)),R=ji(i,n,T);T.writeUInt16BE(R,16);let L=Gi(i,n,6,T);$i(L,c),c.remove_listener("serial1-output-byte",w),p(E.seqNumber+1)}}}}),w=k=>{a.decode(Buffer.from([k]))};c.add_listener("serial1-output-byte",w),setTimeout(()=>{c.remove_listener("serial1-output-byte",w),m(new Error("Timeout waiting for SYN/ACK"))},3e4)})}async function ro(c,i,n,h,d,u,p,m){let w=Wi(n,h,d,u,24,64240,m),k=ji(c,i,w);w.writeUInt16BE(k,16);let S=Gi(c,i,6,w);$i(S,p)}var Rc=16;function Ic(c,i,n,h,d=64240){return Wi(i,c,n,h,Rc,d,Buffer.alloc(0))}function no(c,i,n,h,d,u,p){let m=Ic(n,h,d,u,64240),a=ji(c,i,m);m.writeUInt16BE(a,16);let w=Gi(c,i,6,m);return $i(w,p),u}function Zs(c,i){return c.padEnd(i)}function ri(c,i){return c.padStart(i)}function tr(c){if(!process.env.DEBUG)return;let i=Fi(c),{srcIP:n,dstIP:h}=i,d=n==="10.0.0.1"?dt.green(n):dt.red(n),u=h==="10.0.0.1"?dt.green(h):dt.red(h),p=Bi(i.payload),{srcPort:m,dstPort:a,seqNumber:w,ackNumber:k,flags:S,windowSize:E}=p,A=`${Zs(d,16)} -> ${Zs(u,16)}`,T=`TCP ${ri(m.toString(),5)} -> ${ri(a.toString(),5)}`,R=`[${Zs(Cc(S).join(", "),20)}]`,L=`Seq=${ri(w.toString(),10)}`,z=`Ack=${ri(k.toString(),10)}`,G=`Win=${ri(E.toString(),5)}`;console.log(`${A} ${T} ${R} ${L} ${z} ${G}`)}var Hi=class{proxyPort;serviceHosts;servicePorts;serviceHostIndex;options;proxyTlsOptions;serviceTlsOptions;proxySockets;users;allowedIPs;server=null;emulator;constructor(i,n,h,d,u){this.emulator=d,this.proxyPort=i,this.serviceHosts=this.parse(n),this.servicePorts=this.parse(h).map(Number),this.serviceHostIndex=-1,this.options=this.parseOptions(u),this.proxyTlsOptions={passphrase:this.options.passphrase,secureProtocol:"TLSv1_2_method"},this.options.tls&&(this.proxyTlsOptions.pfx=oo.readFileSync(this.options.pfx)),this.serviceTlsOptions={rejectUnauthorized:this.options.rejectUnauthorized,secureProtocol:"TLSv1_2_method"},this.proxySockets={},this.options.identUsers.length!==0?(this.users=this.options.identUsers,this.log(`Will only allow these users: ${this.users.join(", ")}`)):this.log("Will allow all users"),this.options.allowedIPs.length!==0&&(this.allowedIPs=this.options.allowedIPs),this.createListener()}parse(i){if(typeof i=="string")return i.split(",");if(typeof i=="number")return this.parse(i.toString());if(Array.isArray(i))return i;throw new Error("cannot parse object: "+i)}parseOptions(i){return Object.assign({quiet:!0,pfx:void 0,passphrase:"abcd",rejectUnauthorized:!0,identUsers:[],allowedIPs:[],tls:!1,hostname:void 0,customTlsOptions:void 0,localAddress:void 0,localPort:void 0,upstream:void 0,downstream:void 0,serviceHostSelected:void 0},i||{})}createListener(){this.options.tls?this.server=ao.createServer(this.options.customTlsOptions||this.proxyTlsOptions,i=>{this.handleClientConnection(i)}):this.server=Ki.createServer(i=>{this.handleClientConnection(i)}),this.server.listen(this.proxyPort,this.options.hostname)}handleClientConnection(i){this.users?this.handleAuth(i):this.handleClient(i)}handleAuth(i){if(this.allowedIPs?.includes(i.remoteAddress)){this.handleClient(i);return}let n=co.format("%d, %d",i.remotePort,this.proxyPort),h=new Ki.Socket,d;h.on("error",()=>{d=void 0,h.destroy()}),h.on("data",u=>{d=u.toString().trim(),h.destroy()}),h.on("close",()=>{if(!d){this.log("No identd"),i.destroy();return}let u=d.split(":").pop();this.users?.includes(u)?this.handleClient(i):(this.log(`User "${u}" unauthorized`),i.destroy())}),h.connect(113,i.remoteAddress,()=>{h.write(n),h.end()})}async handleClient(i){let n=this.uniqueKey(i);this.proxySockets[n]=i;let h={buffers:[],connected:!1,sequenceNumber:0,ackNumber:0,srcPort:Dc(1024,65535),proxySocket:i};this.createServiceSocket(h),[h.sequenceNumber,h.ackNumber]=await so("10.0.0.2","10.0.0.1",3306,h.srcPort,this.emulator),i.on("data",async d=>{await this.handleUpstreamData(h,d)}),i.on("close",()=>{delete this.proxySockets[this.uniqueKey(i)],h.serviceSocket!==void 0&&h.serviceSocket.destroy()}),i.on("error",()=>{h.serviceSocket!==void 0&&h.serviceSocket.destroy()})}async handleUpstreamData(i,n){let d=[];if(n.length>768)for(let u=0;u<n.length;u+=768)d.push(n.slice(u,u+768));else d.push(n);for(let u=0;u<d.length;u++){let p=d[u];await ro("10.0.0.2","10.0.0.1",3306,i.srcPort,i.sequenceNumber,i.ackNumber,this.emulator,p),p.length>0&&(i.sequenceNumber+=p.length,Number.isFinite(i.sequenceNumber)||(i.sequenceNumber=0),process.env.DEBUG&&(d.length>1?console.log(dt.bold(`Sending ${p.length} bytes (chunk ${u+1}/${d.length})`)):console.log(dt.bold(`Sending ${p.length} bytes`))))}}createServiceSocket(i){let n=new ho.default.Decoder({onError:h=>{console.error("error:",h)},onMessage:h=>{tr(Buffer.from(h));let d=Fi(Buffer.from(h));if(d.protocol===6){let u=Bi(d.payload);if(u.dstPort!==i.srcPort)return;i.ackNumber=u.seqNumber+u.payload.length,i.proxySocket.write(u.payload),u.payload.length>0&&no("10.0.0.2","10.0.0.1",i.srcPort,3306,i.sequenceNumber,i.ackNumber,this.emulator),u.flags&16&&(i.sequenceNumber=Math.max(i.sequenceNumber,u.ackNumber))}}});this.emulator.add_listener("serial1-output-byte",h=>{n.decode(Buffer.from([h]))})}parseServiceOptions(i){let n=this.getServiceHostIndex(i.proxySocket);return Object.assign({port:this.servicePorts[n],host:this.serviceHosts[n],localAddress:this.options.localAddress,localPort:this.options.localPort},this.serviceTlsOptions)}getServiceHostIndex(i){this.serviceHostIndex++,this.serviceHostIndex==this.serviceHosts.length&&(this.serviceHostIndex=0);let n=this.serviceHostIndex;return this.options.serviceHostSelected&&(n=this.options.serviceHostSelected(i,n)),n}end(){this.server?.close();for(let i in this.proxySockets)this.proxySockets[i].destroy();this.server?.unref()}log(i){this.options.quiet||console.log(i)}intercept(i,n,h){return i?i(n,h):h}uniqueKey(i){return`${i.remoteAddress}:${i.remotePort}`}};function _o(c,i,n){return new Promise(h=>{let d="",u=p=>{let m=String.fromCharCode(p);m===`
`&&(d=""),d+=m,d.includes(i)&&(d="",c.remove_listener(`serial${n}-output-byte`,u),h())};c.add_listener(`serial${n}-output-byte`,u)})}async function Pt(c){await _o(c,"localhost:~#",0)}async function uo(c){await Pt(c),await Pc(c),await zc(c);let i=await c.save_state();await Oc(Mc.join(It,"/blank.state"),Buffer.from(i))}async function zc(c){c.serial0_send(`ip link set lo up
`),await Pt(c)}async function lo(c,i){i.serial0_send(`slattach -v -L -s 115200 -p slip /dev/ttyS1   &
`),await Pt(i),i.serial0_send(`sysctl -w net.ipv4.ip_forward=1
`),await Pt(i),i.serial0_send(`ip addr add 10.0.0.1 peer 10.0.0.2 dev sl0
`),await Pt(i),i.serial0_send(`ip link set sl0 up
`),await Pt(i),i.serial0_send(`ip route add default via 10.0.0.1 dev sl0
`),await Pt(i)}async function er(c,i){return new Hi(c,"127.0.0.1",3306,i,{hostname:"127.0.0.1"})}async function Pc(c){c.serial0_send(`chown mysql:mysql /run/mysqld
`),await Pt(c),c.serial0_send(`echo '10.0.0.2 mysql' >> /etc/hosts
`),await Pt(c),process.env.DEBUG?c.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
`):c.serial0_send(`mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql > /dev/ttyS2
`),await Pt(c)}async function po(c){c.serial0_send(`setsid sh -c 'su mysql -c mysqld -s /bin/ash <> /dev/ttyS2 >&0 2>&1'
`),await Pt(c),await _o(c,"Alpine Linux",2),c.serial0_send(`mysql -uroot mysql -padmin -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.0.0.%' IDENTIFIED BY 'admin' WITH GRANT OPTION"

`),await Pt(c)}var{V86:Nc}=Lc;function yo(c){return`'${c}'`}var zu=Jn({name:"mysql",description:"test",flags:{port:{type:Number,alias:"p",default:3306,description:"Port launch MySQL on"},logs:{type:Boolean,alias:"l",default:!1,description:"Show MySQL logs"},save:{type:String,alias:"s",default:null,description:"Save state with a given name"}},parameters:[]},async c=>{if(c.flags.save==="blank"){console.log("Name 'blank' is reserved.");return}for(;await to(c.flags.port);)console.log(`Port ${dt.bold(c.flags.port)} is already in use. Trying ${dt.bold(++c.flags.port)}...`);let i=c.flags.save&&!!fo(Gt.join(It,`${c.flags.save}.state`));c.flags.save?console.log(i?`Resuming instance ${dt.bold(yo(c.flags.save))}`:`Creating new instance ${dt.bold(yo(c.flags.save))}`):console.log("Starting temporary instance");let n=new Nc({bios:{url:Gt.join(It,"/bios/seabios.bin")},bzimage:{url:Gt.join(It,"/filesystem/efd779b5.bin")},cmdline:["rw","root=host9p rootfstype=9p rootflags=version=9p2000.L,trans=virtio,cache=loose quiet acpi=off console=ttyS0 tsc=reliable mitigations=off random.trust_cpu=on nowatchdog page_poison=on"].join(" "),wasm_path:Gt.join(Pi(import.meta.url),"..","..","/lib/v86.wasm"),memory_size:512*1024*1024,filesystem:{basefs:Gt.join(It,"/filesystem/filesystem.json"),baseurl:Gt.join(It,"/filesystem/")},network_relay_url:"wss://relay.widgetry.org/",autostart:!0,disable_keyboard:!0,disable_mouse:!0,disable_speaker:!0,acpi:!0,uart1:!0,uart2:!0});if(process.env.DEBUG&&n.add_listener("serial0-output-byte",u=>{let p=String.fromCharCode(u);p<="~"&&process.stdout.write(p)}),c.flags.logs){let u="";n.add_listener("serial2-output-byte",p=>{let m=String.fromCharCode(p);if(m<="~"){if(m===`
`){console.log(`  ${dt.dim(u)}`),u="";return}u+=m}})}let h=0;if(process.on("SIGINT",async()=>{for(console.log("Gracefully exiting..."),h&&console.log("State is being saved. Please wait...");h;)await new Promise(u=>setTimeout(u,100));h=2,n.stop(),process.stdin.pause(),process.exit()}),await new Promise(u=>{n.add_listener("emulator-ready",()=>{u()})}),typeof Bun<"u"){let u=setInterval(()=>n.v86.do_tick(),0);process.stdin.on("data",p=>{p.toString()===""&&clearInterval(u)})}if(fo(Gt.join(It,"blank.state"))||(console.log("Initializing blank instance on first run"),await uo(n)),i){console.log(`Restoring state from ${dt.bold(c.flags.save)}`);let u=await mo(Gt.join(It,`${c.flags.save}.state`));await n.restore_state(u),er(c.flags.port,n)}else{console.log("Loading blank instance");let u=await mo(Gt.join(It,"blank.state"));await n.restore_state(u),await po(n),await lo(c.flags.port,n),er(c.flags.port,n)}if(console.log(`Instance is ready on port ${dt.bold(c.flags.port)}`),c.flags.save){let u=await n.save_state();await go(Gt.join(It,`${c.flags.save}.state`),Buffer.from(u)),console.log(`Persisting state to ${dt.bold(c.flags.save)}`),setInterval(async()=>{if(h>=1)return;h=1;let p=await n.save_state();await go(Gt.join(It,`${c.flags.save}.state`),Buffer.from(p)),h=0},1e3)}else console.log(`${dt.bold("Note:")} This instance is temporary and will be lost on exit.`)});export{zu as command};
